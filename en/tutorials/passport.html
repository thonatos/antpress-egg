<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Passport</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/en/intro/">Guide</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/en/tutorials/index.html">Tutorials</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">Plugins</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">Release</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>切换语言</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>Guide</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/index.html">What is Egg?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/quickstart.html">Quick Start</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/progressive.html">Progressive</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/migration.html">Migration to 2.x</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>Basis Function</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/structure.html">Directory Structure</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/objects.html">Built-in Objects</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/env.html">Environment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/config.html">Configuration</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/middleware.html">Middleware</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/plugin.html">Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/schedule.html">Schedule</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/extend.html">Extend</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/app-start.html">Custom Init</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>Core</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/development.html">Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/unittest.html">Unit Testing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/deployment.html">Deployment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/logger.html">Logger</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/view.html">View</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/error-handling.html">Error Handling</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/security.html">Security</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/i18n.html">i18n</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>Tutorials</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/passport.html">Passport</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/assets.html">Assets</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>Advanced</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/plugin.html">Plugin Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/framework.html">Framework</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/view-plugin.html">View Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/style-guide.html">Style Guide</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>Community</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/plugins/">Plugin List</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/contributing.html">Contributing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/resource.html">Resource</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/faq.html">FAQ</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><h2 id="title-passport">Title: Passport</h2><p><strong><code>Login authentication</code></strong> is a common business scenario, including &quot;account password login&quot; and &quot;third-party unified login&quot;.</p><p>Among them, we often use the latter, such as Google, GitHub, QQ unified login, which are based on <a href="https://oauth.net/2/">OAuth</a> specification.</p><p><a href="http://www.passportjs.org/">Passport</a> is a highly scalable authentication middleware that supports the <code>Strategy</code> of <code>Github</code> ,<code>Twitter</code>,<code>Facebook</code>, and other well-known service vendors. It also supports login authorization verification via account passwords.</p><p>Egg provides an <a href="https://github.com/eggjs/egg-passport">egg-passport</a> plugin which encapsulates general logic such as callback processing after initialization and the success of authentication so that the developers can use Passport with just a few API calls.</p><p>The execution sequence of <a href="http://www.passportjs.org/">Passport</a> is as follows:</p><ul><li>User accesses page</li><li>Check Session</li><li>Intercept and jump to authentication login page</li><li>Strategy Authentication</li><li>Check and store user information</li><li>Serialize user information to Session</li><li>Jump to the specified page</li></ul><h2 id="using-egg-passport">Using egg-passport</h2><p>Below, we will use GitHub login as an example to demonstrate how to use it.</p><h3 id="installation">Installation</h3><pre><code class="language-bash">$ npm i --save egg-passport
$ npm i --save egg-passport-github</code></pre><p>For more plugins, see <a href="https://github.com/topics/egg-passport">GitHub Topic - egg-passport</a> .</p><h3 id="configuration">Configuration</h3><p><strong>Enabling the plugin:</strong></p><pre><code class="language-js">// config/plugin.js
module.exports.passport = {
  enable: true,
  package: &#x27;egg-passport&#x27;
};

module.exports.passportGithub = {
  enable: true,
  package: &#x27;egg-passport-github&#x27;
};</code></pre><p><strong>Configuration:</strong></p><p>Note: The <a href="https://github.com/eggjs/egg-passport">egg-passport</a> standardizes the configuration fields, which are unified as <code>key</code> and <code>secret</code>.</p><pre><code class="language-js">// config/default.js
config.passportGithub = {
  key: &#x27;your_clientID&#x27;,
  secret: &#x27;your_clientSecret&#x27;
};</code></pre><p><strong>note:</strong></p><ul><li>Create a <a href="https://github.com/settings/applications/new">GitHub OAuth Apps</a> to get the <code>clientID</code> and <code>clientSecret</code> information.</li><li>Specify a <code>callbackURL</code>, such as <code>http://127.0.0.1:7001/passport/github/callback</code>
  - You need to update to the corresponding domain name when deploying online
  - The path is configured via <code>options.callbackURL</code>, which defaults to <code>/passport/${strategy}/callback</code></li></ul><h3 id="mounting-routes">Mounting Routes</h3><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  const { router, controller } = app;

  // Mount the authentication route
  app.passport.mount(&#x27;github&#x27;);

  // The mount above is syntactic sugar, which is equivalent to
  // const github = app.passport.authenticate(&#x27;github&#x27;, {});
  // router.get(&#x27;/passport/github&#x27;, github);
  // router.get(&#x27;/passport/github/callback&#x27;, github);
}</code></pre><h3 id="user-information-processing">User Information Processing</h3><p>Then we also need:</p><ul><li>When signing in for the first time, you generally need to put user information into the repository and record the Session.</li><li>In the second login, the user information obtained from OAuth or Session, and the database is read to get the complete user information.</li></ul><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  app.passport.verify(async (ctx, user) =&gt; {
    // Check user
    assert(user.provider, &#x27;user.provider should exists&#x27;);
    assert(user.id, &#x27;user.id should exists&#x27;);

    // Find user information from the database
    //
    // Authorization Table
    // column   | desc
    // ---      | --
    // provider | provider name, like github, twitter, facebook, weibo and so on
    // uid      | provider unique id
    // user_id  | current application user id
    const auth = await ctx.model.Authorization.findOne({
      uid: user.id,
      provider: user.provider,
    });
    const existsUser = await ctx.model.User.findOne({ id: auth.user_id });
    if (existsUser) {
      return existsUser;
    }
    // Call service to register a new user
    const newUser = await ctx.service.user.register(user);
    return newUser;
  });

  // Serialize and store the user information into session. Generally, only a few fields need to be streamlined/saved.
  app.passport.serializeUser(async (ctx, user) =&gt; {
  // process user
  // ...
  // return user;
  });

  // Deserialize the user information from the session, check the database to get the complete information
  app.passport.deserializeUser(async (ctx, user) =&gt; {
  // process user
  // ...
  // return user;
  });
};</code></pre><p>At this point, we have completed all the configurations. For a complete example, see: <a href="https://github.com/eggjs/examples/tree/master/passport">eggjs/examples/passport</a></p><h3 id="api">API</h3><p><a href="https://github.com/eggjs/egg-passport">egg-passport</a> provides the following extensions:</p><ul><li><code>ctx.user</code> - Get current logged in user information</li><li><code>ctx.isAuthenticated()</code> - Check if the request is authorized</li><li><code>ctx.login(user, [options])</code> - Start a login session for the user</li><li><code>ctx.logout()</code> - Exit and clear user information from session</li><li><code>ctx.session.returnTo=</code> - Set redirect address after authentication page success</li></ul><p>The API also be provided for:</p><ul><li><code>app.passport.verify(async (ctx, user) =&gt; {})</code> - Check user</li><li><code>app.passport.serializeUser(async (ctx, user) =&gt; {})</code> - Serialize user information into session</li><li><code>app.passport.deserializeUser(async (ctx, user) =&gt; {})</code> - Deserialize user information from the session</li><li><code>app.passport.authenticate(strategy, options)</code> - Generate the specified authentication middleware
  - <code>options.successRedirect</code> - specifies the redirect address after successful authentication
  - <code>options.loginURL</code> - jump login address, defaults to <code>/passport/${strategy}</code>
  - <code>options.callbackURL</code> - callback address after authorization, defaults to <code>/passport/${strategy}/callback</code></li><li><code>app.passport.mount(strategy, options)</code> - Syntactic sugar for developers to configure routing</li></ul><h2 id="using-passport-ecosystem">Using Passport Ecosystem</h2><p><a href="http://www.passportjs.org/">Passport</a> has many middleware and it is impossible to have the second encapsulation.
Next, let&#x27;s look at how to use Passport middleware directly in the framework.
We will use <a href="https://github.com/jaredhanson/passport-local">passport-local</a> for &quot;account password login&quot; as an example:</p><h3 id="installation">Installation</h3><pre><code class="language-bash">$ npm i --save passport-local</code></pre><h3 id="configuration">Configuration</h3><pre><code class="language-js">// app.js
const LocalStrategy = require(&#x27;passport-local&#x27;).Strategy;

module.exports = app =&gt; {
  // Mount strategy
  app.passport.use(new LocalStrategy({
    passReqToCallback: true,
  }, (req, username, password, done) =&gt; {
    // format user
    const user = {
      provider: &#x27;local&#x27;,
      username,
      password,
    };
    debug(&#x27;%s %s get user: %j&#x27;, req.method, req.url, user);
    app.passport.doVerify(req, user, done);
  }));

  // Process user information
  app.passport.verify(async (ctx, user) =&gt; {});
  app.passport.serializeUser(async (ctx, user) =&gt; {});
  app.passport.deserializeUser(async (ctx, user) =&gt; {});
};</code></pre><h3 id="mounting-routes">Mounting Routes</h3><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  const { router, controller } = app;
  router.get(&#x27;/&#x27;, controller.home.index);

  // Callback page after successful authentication
  router.get(&#x27;/authCallback&#x27;, controller.home.authCallback);

  // Render login page, user inputs account password
  router.get(&#x27;/login&#x27;, controller.home.login);
  // Login verification
  router.post(&#x27;/login&#x27;, app.passport.authenticate(&#x27;local&#x27;, { successRedirect: &#x27;/authCallback&#x27; }));
};</code></pre><h2 id="how-to-develop-an-egg-passport-plugin">How to develop an egg-passport plugin</h2><p>In the previous section, we learned how to use a Passport middleware in the framework. We can further encapsulate it as a plugin and give back to the community.</p><p><strong>initialization:</strong></p><pre><code class="language-bash">$ egg-init --type=plugin egg-passport-local</code></pre><p><strong>Configure dependencies in <code>package.json</code>:</strong></p><pre><code class="language-json">{
  &quot;name&quot;: &quot;egg-passport-local&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;passportLocal&quot;,
    &quot;dependencies&quot;: [&quot;passport&quot;]
  },
  &quot;dependencies&quot;: {
    &quot;passport-local&quot;: &quot;^1.0.0&quot;
  }
}</code></pre><p><strong>Configuration:</strong></p><pre><code class="language-js">// {plugin_root}/config/config.default.js
// https://github.com/jaredhanson/passport-local
exports.passportLocal = {
};</code></pre><p>Note: <a href="https://github.com/eggjs/egg-passport">egg-passport</a> standardizes the configuration fields, which are unified as <code>key</code> and <code>secret</code>, so if the corresponding Passport middleware attribute names are inconsistent, the developer should do the conversion.</p><p><strong>Register the passport middleware:</strong></p><pre><code class="language-js">// {plugin_root}/app.js
const LocalStrategy = require(&#x27;passport-local&#x27;).Strategy;

module.exports = app =&gt; {
  const config = app.config.passportLocal;
  config.passReqToCallback = true;

  app.passport.use(new LocalStrategy(config, (req, username, password, done) =&gt; {
    // Cleans up the data returned by the Passport plugin and returns the User object
    const user = {
      provider: &#x27;local&#x27;,
      username,
      password,
    };
    // This does not process application-level logic and passes it to app.passport.verify for unified processing.
    app.passport.doVerify(req, user, done);
  }));
};</code></pre></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#title-passport">Title: Passport</a></li><li><a href="#using-egg-passport">Using egg-passport</a><ul><li><a href="#installation">Installation</a></li><li><a href="#configuration">Configuration</a></li><li><a href="#mounting-routes">Mounting Routes</a></li><li><a href="#user-information-processing">User Information Processing</a></li><li><a href="#api">API</a></li></ul></li><li><a href="#using-passport-ecosystem">Using Passport Ecosystem</a><ul><li><a href="#installation">Installation</a></li><li><a href="#configuration">Configuration</a></li><li><a href="#mounting-routes">Mounting Routes</a></li></ul></li><li><a href="#how-to-develop-an-egg-passport-plugin">How to develop an egg-passport plugin</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"en","props":{"toc":"-%20%5BTitle%3A%20Passport%5D(%23title-passport)%0A-%20%5BUsing%20egg-passport%5D(%23using-egg-passport)%0A%20%20*%20%5BInstallation%5D(%23installation)%0A%20%20*%20%5BConfiguration%5D(%23configuration)%0A%20%20*%20%5BMounting%20Routes%5D(%23mounting-routes)%0A%20%20*%20%5BUser%20Information%20Processing%5D(%23user-information-processing)%0A%20%20*%20%5BAPI%5D(%23api)%0A-%20%5BUsing%20Passport%20Ecosystem%5D(%23using-passport-ecosystem)%0A%20%20*%20%5BInstallation%5D(%23installation)%0A%20%20*%20%5BConfiguration%5D(%23configuration)%0A%20%20*%20%5BMounting%20Routes%5D(%23mounting-routes)%0A-%20%5BHow%20to%20develop%20an%20egg-passport%20plugin%5D(%23how-to-develop-an-egg-passport-plugin)","meta":{"info":{"title":"Passport"}},"content":"%0A%0A%0A%23%23%20Title%3A%20Passport%0A%0A**%60Login%20authentication%60**%20is%20a%20common%20business%20scenario%2C%20including%20%22account%20password%20login%22%20and%20%22third-party%20unified%20login%22.%0A%0AAmong%20them%2C%20we%20often%20use%20the%20latter%2C%20such%20as%20Google%2C%20GitHub%2C%20QQ%20unified%20login%2C%20which%20are%20based%20on%20%5BOAuth%5D(https%3A%2F%2Foauth.net%2F2%2F)%20specification.%0A%0A%5BPassport%5D(http%3A%2F%2Fwww.passportjs.org%2F)%20is%20a%20highly%20scalable%20authentication%20middleware%20that%20supports%20the%20%60Strategy%60%20of%20%60Github%60%20%2C%60Twitter%60%2C%60Facebook%60%2C%20and%20other%20well-known%20service%20vendors.%20It%20also%20supports%20login%20authorization%20verification%20via%20account%20passwords.%0A%0AEgg%20provides%20an%20%5Begg-passport%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-passport)%20plugin%20which%20encapsulates%20general%20logic%20such%20as%20callback%20processing%20after%20initialization%20and%20the%20success%20of%20authentication%20so%20that%20the%20developers%20can%20use%20Passport%20with%20just%20a%20few%20API%20calls.%0A%0AThe%20execution%20sequence%20of%20%5BPassport%5D(http%3A%2F%2Fwww.passportjs.org%2F)%20is%20as%20follows%3A%0A%0A*%20User%20accesses%20page%0A*%20Check%20Session%0A*%20Intercept%20and%20jump%20to%20authentication%20login%20page%0A*%20Strategy%20Authentication%0A*%20Check%20and%20store%20user%20information%0A*%20Serialize%20user%20information%20to%20Session%0A*%20Jump%20to%20the%20specified%20page%0A%0A%23%23%20Using%20egg-passport%0A%0ABelow%2C%20we%20will%20use%20GitHub%20login%20as%20an%20example%20to%20demonstrate%20how%20to%20use%20it.%0A%0A%23%23%23%20Installation%0A%0A%60%60%60bash%0A%24%20npm%20i%20--save%20egg-passport%0A%24%20npm%20i%20--save%20egg-passport-github%0A%60%60%60%0A%0AFor%20more%20plugins%2C%20see%20%5BGitHub%20Topic%20-%20egg-passport%5D(https%3A%2F%2Fgithub.com%2Ftopics%2Fegg-passport)%20.%0A%0A%23%23%23%20Configuration%0A%0A**Enabling%20the%20plugin%3A**%0A%0A%60%60%60js%0A%2F%2F%20config%2Fplugin.js%0Amodule.exports.passport%20%3D%20%7B%0A%20%20enable%3A%20true%2C%0A%20%20package%3A%20'egg-passport'%0A%7D%3B%0A%0Amodule.exports.passportGithub%20%3D%20%7B%0A%20%20enable%3A%20true%2C%0A%20%20package%3A%20'egg-passport-github'%0A%7D%3B%0A%60%60%60%0A%0A**Configuration%3A**%0A%0ANote%3A%20The%20%5Begg-passport%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-passport)%20standardizes%20the%20configuration%20fields%2C%20which%20are%20unified%20as%20%60key%60%20and%20%60secret%60.%0A%0A%60%60%60js%0A%2F%2F%20config%2Fdefault.js%0Aconfig.passportGithub%20%3D%20%7B%0A%20%20key%3A%20'your_clientID'%2C%0A%20%20secret%3A%20'your_clientSecret'%0A%7D%3B%0A%60%60%60%0A%0A**note%3A**%0A%0A*%20Create%20a%20%5BGitHub%20OAuth%20Apps%5D(https%3A%2F%2Fgithub.com%2Fsettings%2Fapplications%2Fnew)%20to%20get%20the%20%60clientID%60%20and%20%60clientSecret%60%20information.%0A*%20Specify%20a%20%60callbackURL%60%2C%20such%20as%20%60http%3A%2F%2F127.0.0.1%3A7001%2Fpassport%2Fgithub%2Fcallback%60%0A%20%20%C2%A0%C2%A0-%20You%20need%20to%20update%20to%20the%20corresponding%20domain%20name%20when%20deploying%20online%0A%20%20%C2%A0%C2%A0-%20The%20path%20is%20configured%20via%20%60options.callbackURL%60%2C%20which%20defaults%20to%20%60%2Fpassport%2F%24%7Bstrategy%7D%2Fcallback%60%0A%0A%23%23%23%20Mounting%20Routes%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%C2%A0%C2%A0const%20%7B%20router%2C%20controller%20%7D%20%3D%20app%3B%0A%0A%C2%A0%C2%A0%2F%2F%20Mount%20the%20authentication%20route%0A%C2%A0%C2%A0app.passport.mount('github')%3B%0A%0A%C2%A0%C2%A0%2F%2F%20The%20mount%20above%20is%20syntactic%20sugar%2C%20which%20is%20equivalent%20to%0A%C2%A0%C2%A0%2F%2F%20const%20github%20%3D%20app.passport.authenticate('github'%2C%20%7B%7D)%3B%0A%C2%A0%C2%A0%2F%2F%20router.get('%2Fpassport%2Fgithub'%2C%20github)%3B%0A%C2%A0%C2%A0%2F%2F%20router.get('%2Fpassport%2Fgithub%2Fcallback'%2C%20github)%3B%0A%7D%0A%60%60%60%0A%0A%23%23%23%20User%20Information%20Processing%0A%0AThen%20we%20also%20need%3A%0A%0A*%20When%20signing%20in%20for%20the%20first%20time%2C%20you%20generally%20need%20to%20put%20user%20information%20into%20the%20repository%20and%20record%20the%20Session.%0A*%20In%20the%20second%20login%2C%20the%20user%20information%20obtained%20from%20OAuth%20or%20Session%2C%20and%20the%20database%20is%20read%20to%20get%20the%20complete%20user%20information.%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%C2%A0%C2%A0app.passport.verify(async%20(ctx%2C%20user)%20%3D%3E%20%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20Check%20user%0A%C2%A0%C2%A0%C2%A0%C2%A0assert(user.provider%2C%20'user.provider%20should%20exists')%3B%0A%C2%A0%C2%A0%C2%A0%C2%A0assert(user.id%2C%20'user.id%20should%20exists')%3B%0A%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20Find%20user%20information%20from%20the%20database%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20Authorization%20Table%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20column%20%20%20%7C%20desc%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20---%20%20%20%20%20%20%7C%20--%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20provider%20%7C%20provider%20name%2C%20like%20github%2C%20twitter%2C%20facebook%2C%20weibo%20and%20so%20on%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20uid%20%20%20%20%20%20%7C%20provider%20unique%20id%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20user_id%20%20%7C%20current%20application%20user%20id%0A%C2%A0%C2%A0%C2%A0%C2%A0const%20auth%20%3D%20await%20ctx.model.Authorization.findOne(%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0uid%3A%20user.id%2C%0A%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0provider%3A%20user.provider%2C%0A%C2%A0%C2%A0%C2%A0%C2%A0%7D)%3B%0A%C2%A0%C2%A0%C2%A0%C2%A0const%20existsUser%20%3D%20await%20ctx.model.User.findOne(%7B%20id%3A%20auth.user_id%20%7D)%3B%0A%C2%A0%C2%A0%C2%A0%C2%A0if%20(existsUser)%20%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0return%20existsUser%3B%0A%C2%A0%C2%A0%C2%A0%C2%A0%7D%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20Call%20service%20to%20register%20a%20new%20user%0A%C2%A0%C2%A0%C2%A0%C2%A0const%20newUser%20%3D%20await%20ctx.service.user.register(user)%3B%0A%C2%A0%C2%A0%C2%A0%C2%A0return%20newUser%3B%0A%C2%A0%C2%A0%7D)%3B%0A%0A%C2%A0%C2%A0%2F%2F%20Serialize%20and%20store%20the%20user%20information%20into%20session.%20Generally%2C%20only%20a%20few%20fields%20need%20to%20be%20streamlined%2Fsaved.%0A%C2%A0%C2%A0app.passport.serializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%0A%C2%A0%C2%A0%2F%2F%20process%20user%0A%C2%A0%C2%A0%2F%2F%20...%0A%C2%A0%C2%A0%2F%2F%20return%20user%3B%0A%C2%A0%C2%A0%7D)%3B%0A%0A%C2%A0%C2%A0%2F%2F%20Deserialize%20the%20user%20information%20from%20the%20session%2C%20check%20the%20database%20to%20get%20the%20complete%20information%0A%C2%A0%C2%A0app.passport.deserializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%0A%C2%A0%C2%A0%2F%2F%20process%20user%0A%C2%A0%C2%A0%2F%2F%20...%0A%C2%A0%C2%A0%2F%2F%20return%20user%3B%0A%C2%A0%C2%A0%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0AAt%20this%20point%2C%20we%20have%20completed%20all%20the%20configurations.%20For%20a%20complete%20example%2C%20see%3A%20%5Beggjs%2Fexamples%2Fpassport%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fexamples%2Ftree%2Fmaster%2Fpassport)%0A%0A%23%23%23%20API%0A%0A%5Begg-passport%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-passport)%20provides%20the%20following%20extensions%3A%0A%0A*%20%60ctx.user%60%20-%20Get%20current%20logged%20in%20user%20information%0A*%20%60ctx.isAuthenticated()%60%20-%20Check%20if%20the%20request%20is%20authorized%0A*%20%60ctx.login(user%2C%20%5Boptions%5D)%60%20-%20Start%20a%20login%20session%20for%20the%20user%0A*%20%60ctx.logout()%60%20-%20Exit%20and%20clear%20user%20information%20from%20session%0A*%20%60ctx.session.returnTo%3D%60%20-%20Set%20redirect%20address%20after%20authentication%20page%20success%0A%0AThe%20API%20also%20be%20provided%20for%3A%0A%0A*%20%60app.passport.verify(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%60%20-%20Check%20user%0A*%20%60app.passport.serializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%60%20-%20Serialize%20user%20information%20into%20session%0A*%20%60app.passport.deserializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%60%20-%20Deserialize%20user%20information%20from%20the%20session%0A*%20%60app.passport.authenticate(strategy%2C%20options)%60%20-%20Generate%20the%20specified%20authentication%20middleware%0A%20%20%C2%A0%C2%A0-%20%60options.successRedirect%60%20-%20specifies%20the%20redirect%20address%20after%20successful%20authentication%0A%20%20%C2%A0%C2%A0-%20%60options.loginURL%60%20-%20jump%20login%20address%2C%20defaults%20to%20%60%2Fpassport%2F%24%7Bstrategy%7D%60%0A%20%20%C2%A0%C2%A0-%20%60options.callbackURL%60%20-%20callback%20address%20after%20authorization%2C%20defaults%20to%20%60%2Fpassport%2F%24%7Bstrategy%7D%2Fcallback%60%0A*%20%60app.passport.mount(strategy%2C%20options)%60%20-%20Syntactic%20sugar%20for%20developers%20to%20configure%20routing%0A%0A%23%23%20Using%20Passport%20Ecosystem%0A%0A%5BPassport%5D(http%3A%2F%2Fwww.passportjs.org%2F)%20has%20many%20middleware%20and%20it%20is%20impossible%20to%20have%20the%20second%20encapsulation.%0ANext%2C%20let's%20look%20at%20how%20to%20use%20Passport%20middleware%20directly%20in%20the%20framework.%0AWe%20will%20use%20%5Bpassport-local%5D(https%3A%2F%2Fgithub.com%2Fjaredhanson%2Fpassport-local)%20for%20%22account%20password%20login%22%20as%20an%20example%3A%0A%0A%23%23%23%20Installation%0A%0A%60%60%60bash%0A%24%20npm%20i%20--save%20passport-local%0A%60%60%60%0A%0A%23%23%23%20Configuration%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Aconst%20LocalStrategy%20%3D%20require('passport-local').Strategy%3B%0A%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%C2%A0%C2%A0%2F%2F%20Mount%20strategy%0A%C2%A0%C2%A0app.passport.use(new%20LocalStrategy(%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0passReqToCallback%3A%20true%2C%0A%C2%A0%C2%A0%7D%2C%20(req%2C%20username%2C%20password%2C%20done)%20%3D%3E%20%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20format%20user%0A%C2%A0%C2%A0%C2%A0%C2%A0const%20user%20%3D%20%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0provider%3A%20'local'%2C%0A%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0username%2C%0A%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0password%2C%0A%C2%A0%C2%A0%C2%A0%C2%A0%7D%3B%0A%C2%A0%C2%A0%C2%A0%C2%A0debug('%25s%20%25s%20get%20user%3A%20%25j'%2C%20req.method%2C%20req.url%2C%20user)%3B%0A%C2%A0%C2%A0%C2%A0%C2%A0app.passport.doVerify(req%2C%20user%2C%20done)%3B%0A%C2%A0%C2%A0%7D))%3B%0A%0A%C2%A0%C2%A0%2F%2F%20Process%20user%20information%0A%C2%A0%C2%A0app.passport.verify(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%3B%0A%C2%A0%C2%A0app.passport.serializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%3B%0A%C2%A0%C2%A0app.passport.deserializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20Mounting%20Routes%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%C2%A0%C2%A0const%20%7B%20router%2C%20controller%20%7D%20%3D%20app%3B%0A%C2%A0%C2%A0router.get('%2F'%2C%20controller.home.index)%3B%0A%0A%C2%A0%C2%A0%2F%2F%20Callback%20page%20after%20successful%20authentication%0A%C2%A0%C2%A0router.get('%2FauthCallback'%2C%20controller.home.authCallback)%3B%0A%0A%C2%A0%C2%A0%2F%2F%20Render%20login%20page%2C%20user%20inputs%20account%20password%0A%C2%A0%C2%A0router.get('%2Flogin'%2C%20controller.home.login)%3B%0A%C2%A0%C2%A0%2F%2F%20Login%20verification%0A%C2%A0%C2%A0router.post('%2Flogin'%2C%20app.passport.authenticate('local'%2C%20%7B%20successRedirect%3A%20'%2FauthCallback'%20%7D))%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20How%20to%20develop%20an%20egg-passport%20plugin%0A%0AIn%20the%20previous%20section%2C%20we%20learned%20how%20to%20use%20a%20Passport%20middleware%20in%20the%20framework.%20We%20can%20further%20encapsulate%20it%20as%20a%20plugin%20and%20give%20back%20to%20the%20community.%0A%0A**initialization%3A**%0A%0A%60%60%60bash%0A%24%20egg-init%20--type%3Dplugin%20egg-passport-local%0A%60%60%60%0A%0A**Configure%20dependencies%20in%20%60package.json%60%3A**%0A%0A%60%60%60json%0A%7B%0A%20%20%22name%22%3A%20%22egg-passport-local%22%2C%0A%20%20%22version%22%3A%20%221.0.0%22%2C%0A%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%22name%22%3A%20%22passportLocal%22%2C%0A%20%20%20%20%22dependencies%22%3A%20%5B%22passport%22%5D%0A%20%20%7D%2C%0A%20%20%22dependencies%22%3A%20%7B%0A%20%20%20%20%22passport-local%22%3A%20%22%5E1.0.0%22%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A**Configuration%3A**%0A%0A%60%60%60js%0A%2F%2F%20%7Bplugin_root%7D%2Fconfig%2Fconfig.default.js%0A%2F%2F%20https%3A%2F%2Fgithub.com%2Fjaredhanson%2Fpassport-local%0Aexports.passportLocal%20%3D%20%7B%0A%7D%3B%0A%60%60%60%0A%0ANote%3A%20%5Begg-passport%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-passport)%20standardizes%20the%20configuration%20fields%2C%20which%20are%20unified%20as%20%60key%60%20and%20%60secret%60%2C%20so%20if%20the%20corresponding%20Passport%20middleware%20attribute%20names%20are%20inconsistent%2C%20the%20developer%20should%20do%20the%20conversion.%0A%0A**Register%20the%20passport%20middleware%3A**%0A%0A%60%60%60js%0A%2F%2F%20%7Bplugin_root%7D%2Fapp.js%0Aconst%20LocalStrategy%20%3D%20require('passport-local').Strategy%3B%0A%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%C2%A0%C2%A0const%20config%20%3D%20app.config.passportLocal%3B%0A%C2%A0%C2%A0config.passReqToCallback%20%3D%20true%3B%0A%0A%C2%A0%C2%A0app.passport.use(new%20LocalStrategy(config%2C%20(req%2C%20username%2C%20password%2C%20done)%20%3D%3E%20%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20Cleans%20up%20the%20data%20returned%20by%20the%20Passport%20plugin%20and%20returns%20the%20User%20object%0A%C2%A0%C2%A0%C2%A0%C2%A0const%20user%20%3D%20%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0provider%3A%20'local'%2C%0A%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0username%2C%0A%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0password%2C%0A%C2%A0%C2%A0%C2%A0%C2%A0%7D%3B%0A%C2%A0%C2%A0%C2%A0%C2%A0%2F%2F%20This%20does%20not%20process%20application-level%20logic%20and%20passes%20it%20to%20app.passport.verify%20for%20unified%20processing.%0A%C2%A0%C2%A0%C2%A0%C2%A0app.passport.doVerify(req%2C%20user%2C%20done)%3B%0A%C2%A0%C2%A0%7D))%3B%0A%7D%3B%0A%60%60%60%0A%0A%5Bpassport%5D%3A%20http%3A%2F%2Fwww.passportjs.org%2F%0A%5Begg-passport%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-passport%0A%5Bpassport-local%5D%3A%20https%3A%2F%2Fgithub.com%2Fjaredhanson%2Fpassport-local%0A%5Beggjs%2Fexamples%2Fpassport%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fexamples%2Ftree%2Fmaster%2Fpassport%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>