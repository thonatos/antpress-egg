<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Build RESTful API</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/en/intro/">Guide</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/en/tutorials/index.html">Tutorials</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">Plugins</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">Release</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>切换语言</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>Guide</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/index.html">What is Egg?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/quickstart.html">Quick Start</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/progressive.html">Progressive</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/migration.html">Migration to 2.x</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>Basis Function</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/structure.html">Directory Structure</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/objects.html">Built-in Objects</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/env.html">Environment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/config.html">Configuration</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/middleware.html">Middleware</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/plugin.html">Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/schedule.html">Schedule</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/extend.html">Extend</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/app-start.html">Custom Init</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>Core</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/development.html">Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/unittest.html">Unit Testing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/deployment.html">Deployment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/logger.html">Logger</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/view.html">View</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/error-handling.html">Error Handling</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/security.html">Security</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/i18n.html">i18n</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>Tutorials</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/passport.html">Passport</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/assets.html">Assets</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>Advanced</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/plugin.html">Plugin Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/framework.html">Framework</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/view-plugin.html">View Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/style-guide.html">Style Guide</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>Community</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/plugins/">Plugin List</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/contributing.html">Contributing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/resource.html">Resource</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/faq.html">FAQ</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>Web frameworks are widely used for providing interfaces to the client through Web services. Let&#x27;s use an example <a href="https://cnodejs.org/">CNode Club</a> to show how to build <a href="https://en.wikipedia.org/wiki/REST">RESTful</a> API using Egg.</p><p>CNode currently use v1 interface is not fully consistent with the RESTful semantic. In the article, we will encapsulate a more RESTful semantic V2 API based on CNode V1 interface.</p><h2 id="response-formatting">Response Formatting</h2><p>Designing a RESTful-style API, we will identify the status of response by the response status code, keeping the response body simply and only the interface data is returned.
A example of <code>topics</code> is shown below:</p><h3 id="get-topics-list">Get topics list</h3><ul><li><code>GET /api/v2/topics</code></li><li>status code: 200</li><li>response body:</li></ul><pre><code class="language-json">[
  {
    &quot;id&quot;: &quot;57ea257b3670ca3f44c5beb6&quot;,
    &quot;author_id&quot;: &quot;541bf9b9ad60405c1f151a03&quot;,
    &quot;tab&quot;: &quot;share&quot;,
    &quot;content&quot;: &quot;content&quot;,
    &quot;last_reply_at&quot;: &quot;2017-01-11T13:32:25.089Z&quot;,
    &quot;good&quot;: false,
    &quot;top&quot;: true,
    &quot;reply_count&quot;: 155,
    &quot;visit_count&quot;: 28176,
    &quot;create_at&quot;: &quot;2016-09-27T07:53:31.872Z&quot;,
  },
  {
    &quot;id&quot;: &quot;57ea257b3670ca3f44c5beb6&quot;,
    &quot;author_id&quot;: &quot;541bf9b9ad60405c1f151a03&quot;,
    &quot;tab&quot;: &quot;share&quot;,
    &quot;content&quot;: &quot;content&quot;,
    &quot;title&quot;: &quot;Finished Rewriting of Let&#x27;s Learning Node.js Together&quot;,
    &quot;last_reply_at&quot;: &quot;2017-01-11T10:20:56.496Z&quot;,
    &quot;good&quot;: false,
    &quot;top&quot;: true,
    &quot;reply_count&quot;: 193,
    &quot;visit_count&quot;: 47633,
  },
]</code></pre><h3 id="retrieve-one-topic">Retrieve one topic</h3><ul><li><code>GET /api/v2/topics/57ea257b3670ca3f44c5beb6</code></li><li>status code: 200</li><li>response body:</li></ul><pre><code class="language-json">{
  &quot;id&quot;: &quot;57ea257b3670ca3f44c5beb6&quot;,
  &quot;author_id&quot;: &quot;541bf9b9ad60405c1f151a03&quot;,
  &quot;tab&quot;: &quot;share&quot;,
  &quot;content&quot;: &quot;content&quot;,
  &quot;title&quot;: &quot;Finished Rewriting of Let&#x27;s Learning Node.js Together&quot;,
  &quot;last_reply_at&quot;: &quot;2017-01-11T10:20:56.496Z&quot;,
  &quot;good&quot;: false,
  &quot;top&quot;: true,
  &quot;reply_count&quot;: 193,
  &quot;visit_count&quot;: 47633,
}</code></pre><h3 id="create-topics">Create topics</h3><ul><li><code>POST /api/v2/topics</code></li><li>status code: 201</li><li>response body:</li></ul><pre><code class="language-json">{
  &quot;topic_id&quot;: &quot;57ea257b3670ca3f44c5beb6&quot;
}</code></pre><h3 id="update-topics">Update topics</h3><ul><li><code>PUT /api/v2/topics/57ea257b3670ca3f44c5beb6</code></li><li>status code: 204</li><li>response body: null</li></ul><h3 id="error-handling">Error handling</h3><p>When an error is occurring, 4xx status code is returned if occurred by client-side request parameters and 5xx status code is returned if occurred by server-side logic processing. All error objects are used as the description for status exceptions.</p><p>For example, passing invalided parameters from the client may return a response with status code 422, the response body as shown below:</p><pre><code class="language-json">{
  &quot;error&quot;: &quot;Validation Failed&quot;,
  &quot;detail&quot;: [ { &quot;message&quot;: &quot;required&quot;, &quot;field&quot;: &quot;title&quot;, &quot;code&quot;: &quot;missing_field&quot; } ]
}</code></pre><h2 id="getting-started">Getting Started</h2><p>After interface convention, we begin to create a RESTful API.</p><h3 id="application-initialization">Application initialization</h3><p>Initializes the application using <a href="https://github.com/eggjs/egg-init">egg-init</a> in the <a href="../intro/quickstart.md">quickstart</a></p><pre><code class="language-bash">$ egg-init cnode-api --type=simple
$ cd cnode-api
$ npm i</code></pre><h3 id="enable-validate-plugin">Enable validate plugin</h3><p><a href="https://github.com/eggjs/egg-validate">egg-validate</a> is used to present the validate plugin.</p><pre><code class="language-js">// config/plugin.js
exports.validate = {
  enable: true,
  package: &#x27;egg-validate&#x27;,
};</code></pre><h3 id="router-registry">Router registry</h3><p>First of all, we follower previous design to register <a href="../basics/router.md">router</a>. The framework provides a simply way to create a RESTful-style router and mapping the resources to the corresponding controllers.</p><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  app.router.resources(&#x27;topics&#x27;, &#x27;/api/v2/topics&#x27;, app.controller.topics);
};</code></pre><p>Mapping the &#x27;topics&#x27; resource&#x27;s CRUD interfaces to the <code>app/controller/topics.js</code> using <code>app.resources</code></p><h3 id="developing-controller">Developing controller</h3><p>In <a href="../basics/controller.md">controller</a>, we only need to implement the interface convention of <code>app.resources</code> <a href="../basics/router.md#RESTful-style-URL-definition">RESTful style URL definition</a>. For example, creating a &#x27;topics&#x27; interface:</p><pre><code class="language-js">// app/controller/topics.js
const Controller = require(&#x27;egg&#x27;).Controller;

// defining the rule of request parameters
const createRule = {
  accesstoken: &#x27;string&#x27;,
  title: &#x27;string&#x27;,
  tab: { type: &#x27;enum&#x27;, values: [ &#x27;ask&#x27;, &#x27;share&#x27;, &#x27;job&#x27; ], required: false },
  content: &#x27;string&#x27;,
};

class TopicController extends Controller {
  async create() {
    const ctx = this.ctx;
    // validate the `ctx.request.body` with the expected format
    // status = 422 exception will be thrown if not passing the parameter validation
    ctx.validate(createRule, ctx.request.body);
    // call service to create a topic
    const id = await ctx.service.topics.create(ctx.request.body);
    // configure the response body and status code
    ctx.body = {
      topic_id: id,
    };
    ctx.status = 201;
  }
}
module.exports = TopicController;</code></pre><p>As shown above, a Controller mainly implements the following logic:</p><ol><li>call the validate function to validate the request parameters</li><li>create a topic by calling service encapsulates business logic using the validated parameters</li><li>configure the status code and context according to the interface convention</li></ol><h3 id="developing-service">Developing service</h3><p>We will more focus on writing effective business logic in <a href="../basics/service.md">service</a>.</p><pre><code class="language-js">// app/service/topics.js
const Service = require(&#x27;egg&#x27;).Service;

class TopicService extends Service {
  constructor(ctx) {
    super(ctx);
    this.root = &#x27;https://cnodejs.org/api/v1&#x27;;
  }

  async create(params) {
      // call CNode V1 API
    const result = await this.ctx.curl(`${this.root}/topics`, {
      method: &#x27;post&#x27;,
      data: params,
      dataType: &#x27;json&#x27;,
      contentType: &#x27;json&#x27;,
    });
    // check whether the call was successful, throws an exception if it fails
    this.checkSuccess(result);
    // return the id of topis
    return result.data.topic_id;
  }

  // Encapsulated a uniform check function, can be reused in query, create, update and such on in service
  checkSuccess(result) {
    if (result.status !== 200) {
      const errorMsg = result.data &amp;&amp; result.data.error_msg ? result.data.error_msg : &#x27;unknown error&#x27;;
      this.ctx.throw(result.status, errorMsg);
    }
    if (!result.data.success) {
      // remote response error
      this.ctx.throw(500, &#x27;remote response error&#x27;, { data: result.data });
    }
  }
}

module.exports = TopicService;</code></pre><p>After developing the Service of topic creation, an interface have been completed from top to bottom.</p><h3 id="unified-error-handling">Unified error handling</h3><p>Normal business logic has been completed, but exceptions have not yet been processed. Controller and Service may throw an exception as the previous coding, so it is recommended that throwing an exception to interrupt if passing invalided parameters from the client or calling the back-end service with exception.</p><ul><li>use Controller <code>this.ctx.validate()</code> to validate the parameters, throw exception if it fails.</li><li>call Service <code>this.ctx.curl()</code> to access CNode API, may throw server exception due to network problems.</li><li>an exception also will be thrown after Service is getting the response of calling failure from CNode API.</li></ul><p>Default error handling is provided but might be inconsistent as the interface convention previously. We need to implement a unified error-handling middleware to handle the errors.</p><p>Create a file <code>error_handler.js</code> under <code>app/middleware</code> directory to create a new <a href="../basics/middleware.md">middleware</a></p><pre><code class="language-js">// app/middleware/error_handler.js
module.exports = () =&gt; {
  return async function errorHandler(ctx, next) {
    try {
      await next();
    } catch (err) {
      // All exceptions will trigger an error event on the app and the error log will be recorded
      ctx.app.emit(&#x27;error&#x27;, err, ctx);

      const status = err.status || 500;
      // error 500 not returning to client when in the production environment because it may contain sensitive information
      const error = status === 500 &amp;&amp; ctx.app.config.env === &#x27;prod&#x27;
        ? &#x27;Internal Server Error&#x27;
        : err.message;

      // Reading from the properties of error object and set it to the response
      ctx.body = { error };
      if (status === 422) {
        ctx.body.detail = err.errors;
      }
      ctx.status = status;
    }
  };
};</code></pre><p>We can catch all exceptions and follow the expected format to encapsulate the response through the middleware. It can be loaded into application using configuration file (<code>config/config.default.js</code>)</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  // load the errorHandler middleware
  middleware: [ &#x27;errorHandler&#x27; ],
  // only takes effect on URL prefix with &#x27;/api&#x27;
  errorHandler: {
    match: &#x27;/api&#x27;,
  },
};</code></pre><h2 id="testing">Testing</h2><p>Completing the coding just the first step, furthermore we need to add <a href="../core/unittest.md">Unit Test</a> to the code.</p><h3 id="controller-testing">Controller Testing</h3><p>Let&#x27;s start writing the unit test for the Controller. We can simulate the implementation of the Service layer in an appropriate way because the most important part is to test the logic as for Controller. And mocking up the Service layer according the convention of interface, so we can develop layered testing because the Service layer itself can also covered by Service unit test.</p><pre><code class="language-js">const { app, mock, assert } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;test/app/controller/topics.test.js&#x27;, () =&gt; {
  // test the response of passing the error parameters
  it(&#x27;should POST /api/v2/topics/ 422&#x27;, () =&gt; {
    app.mockCsrf();
    return app.httpRequest()
      .post(&#x27;/api/v2/topics&#x27;)
      .send({
        accesstoken: &#x27;123&#x27;,
      })
      .expect(422)
      .expect({
        error: &#x27;Validation Failed&#x27;,
        detail: [
          { message: &#x27;required&#x27;, field: &#x27;title&#x27;, code: &#x27;missing_field&#x27; },
          { message: &#x27;required&#x27;, field: &#x27;content&#x27;, code: &#x27;missing_field&#x27; },
        ],
      });
  });

  // mock up the service layer and test the response of normal request
  it(&#x27;should POST /api/v2/topics/ 201&#x27;, () =&gt; {
    app.mockCsrf();
    app.mockService(&#x27;topics&#x27;, &#x27;create&#x27;, 123);
    return app.httpRequest()
      .post(&#x27;/api/v2/topics&#x27;)
      .send({
        accesstoken: &#x27;123&#x27;,
        title: &#x27;title&#x27;,
        content: &#x27;hello&#x27;,
      })
      .expect(201)
      .expect({
        topic_id: 123,
      });
  });
});</code></pre><p>As the Controller testing above, we create an application using <a href="https://github.com/eggjs/egg-mock">egg-mock</a> and simulate the client to send request through <a href="https://github.com/visionmedia/supertest">SuperTest</a>. In the testing, we also simulate the response from Service layer to test the processing logic of Controller layer</p><h3 id="service-testing">Service Testing</h3><p>Unit Test of Service layer may focus on the coding logic. <a href="https://github.com/eggjs/egg-mock">egg-mock</a> provides a quick method to test the Service by calling the test method in the Service, and SuperTest to simulate the client request is no longer needed.</p><pre><code class="language-js">const { app, mock, assert } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;test/app/service/topics.test.js&#x27;, () =&gt; {
  let ctx;

  beforeEach(() =&gt; {
    // create a global context object so that can call the service function on a ctx object
    ctx = app.mockContext();
  })

  describe(&#x27;create()&#x27;, () =&gt; {
    it(&#x27;should create failed by accesstoken error&#x27;, async () =&gt; {
      try {
        // calling service method on ctx directly
        await ctx.service.topics.create({
          accesstoken: &#x27;hello&#x27;,
          title: &#x27;title&#x27;,
          content: &#x27;content&#x27;,
        });
      } catch (err) {
        assert(err.status === 401);
        assert(err.message === &#x27;error accessToken&#x27;);
      }
      throw &#x27;should not run here&#x27;;
    });

    it(&#x27;should create success&#x27;, async () =&gt; {
      // not affect the normal operation of CNode by simulating the interface calling of CNode based on interface convention
      // app.mockHttpclient method can easily simulate the appliation&#x27;s HTTP request
      app.mockHttpclient(`${ctx.service.topics.root}/topics`, &#x27;POST&#x27;, {
        data: {
          success: true,
          topic_id: &#x27;5433d5e4e737cbe96dcef312&#x27;,
        },
      });

      const id = await ctx.service.topics.create({
        accesstoken: &#x27;hello&#x27;,
        title: &#x27;title&#x27;,
        content: &#x27;content&#x27;,
      });
      assert(id === &#x27;5433d5e4e737cbe96dcef312&#x27;);
    });
  });
});</code></pre><p>In the testing of Service layer above,  we create a Context object using the <code>app.createContext()</code> which provided by egg-mock and call the Service method on Context object to test directly. It can use <code>app.mockHttpclient()</code> to simulate the response of calling HTTP request, which allows us to focus on the logic testing of Service layer without the impact of environment.</p><hr/><p>See the full example at <a href="https://github.com/eggjs/examples/tree/master/cnode-api">eggjs/examples/cnode-api</a>.</p></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#response-formatting">Response Formatting</a><ul><li><a href="#get-topics-list">Get topics list</a></li><li><a href="#retrieve-one-topic">Retrieve one topic</a></li><li><a href="#create-topics">Create topics</a></li><li><a href="#update-topics">Update topics</a></li><li><a href="#error-handling">Error handling</a></li></ul></li><li><a href="#getting-started">Getting Started</a><ul><li><a href="#application-initialization">Application initialization</a></li><li><a href="#enable-validate-plugin">Enable validate plugin</a></li><li><a href="#router-registry">Router registry</a></li><li><a href="#developing-controller">Developing controller</a></li><li><a href="#developing-service">Developing service</a></li><li><a href="#unified-error-handling">Unified error handling</a></li></ul></li><li><a href="#testing">Testing</a><ul><li><a href="#controller-testing">Controller Testing</a></li><li><a href="#service-testing">Service Testing</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"en","props":{"toc":"-%20%5BResponse%20Formatting%5D(%23response-formatting)%0A%20%20*%20%5BGet%20topics%20list%5D(%23get-topics-list)%0A%20%20*%20%5BRetrieve%20one%20topic%5D(%23retrieve-one-topic)%0A%20%20*%20%5BCreate%20topics%5D(%23create-topics)%0A%20%20*%20%5BUpdate%20topics%5D(%23update-topics)%0A%20%20*%20%5BError%20handling%5D(%23error-handling)%0A-%20%5BGetting%20Started%5D(%23getting-started)%0A%20%20*%20%5BApplication%20initialization%5D(%23application-initialization)%0A%20%20*%20%5BEnable%20validate%20plugin%5D(%23enable-validate-plugin)%0A%20%20*%20%5BRouter%20registry%5D(%23router-registry)%0A%20%20*%20%5BDeveloping%20controller%5D(%23developing-controller)%0A%20%20*%20%5BDeveloping%20service%5D(%23developing-service)%0A%20%20*%20%5BUnified%20error%20handling%5D(%23unified-error-handling)%0A-%20%5BTesting%5D(%23testing)%0A%20%20*%20%5BController%20Testing%5D(%23controller-testing)%0A%20%20*%20%5BService%20Testing%5D(%23service-testing)","meta":{"info":{"title":"Build RESTful API"}},"content":"%0A%0AWeb%20frameworks%20are%20widely%20used%20for%20providing%20interfaces%20to%20the%20client%20through%20Web%20services.%20Let's%20use%20an%20example%20%5BCNode%20Club%5D(https%3A%2F%2Fcnodejs.org%2F)%20to%20show%20how%20to%20build%20%5BRESTful%5D(https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FREST)%20API%20using%20Egg.%0A%0ACNode%20currently%20use%20v1%20interface%20is%20not%20fully%20consistent%20with%20the%20RESTful%20semantic.%20In%20the%20article%2C%20we%20will%20encapsulate%20a%20more%20RESTful%20semantic%20V2%20API%20based%20on%20CNode%20V1%20interface.%0A%0A%23%23%20Response%20Formatting%0A%0ADesigning%20a%20RESTful-style%20API%2C%20we%20will%20identify%20the%20status%20of%20response%20by%20the%20response%20status%20code%2C%20keeping%20the%20response%20body%20simply%20and%20only%20the%20interface%20data%20is%20returned.%0AA%20example%20of%20%60topics%60%20is%20shown%20below%3A%0A%0A%23%23%23%20Get%20topics%20list%0A%0A-%20%60GET%20%2Fapi%2Fv2%2Ftopics%60%0A-%20status%20code%3A%20200%0A-%20response%20body%3A%0A%0A%60%60%60json%0A%5B%0A%20%20%7B%0A%20%20%20%20%22id%22%3A%20%2257ea257b3670ca3f44c5beb6%22%2C%0A%20%20%20%20%22author_id%22%3A%20%22541bf9b9ad60405c1f151a03%22%2C%0A%20%20%20%20%22tab%22%3A%20%22share%22%2C%0A%20%20%20%20%22content%22%3A%20%22content%22%2C%0A%20%20%20%20%22last_reply_at%22%3A%20%222017-01-11T13%3A32%3A25.089Z%22%2C%0A%20%20%20%20%22good%22%3A%20false%2C%0A%20%20%20%20%22top%22%3A%20true%2C%0A%20%20%20%20%22reply_count%22%3A%20155%2C%0A%20%20%20%20%22visit_count%22%3A%2028176%2C%0A%20%20%20%20%22create_at%22%3A%20%222016-09-27T07%3A53%3A31.872Z%22%2C%0A%20%20%7D%2C%0A%20%20%7B%0A%20%20%20%20%22id%22%3A%20%2257ea257b3670ca3f44c5beb6%22%2C%0A%20%20%20%20%22author_id%22%3A%20%22541bf9b9ad60405c1f151a03%22%2C%0A%20%20%20%20%22tab%22%3A%20%22share%22%2C%0A%20%20%20%20%22content%22%3A%20%22content%22%2C%0A%20%20%20%20%22title%22%3A%20%22Finished%20Rewriting%20of%20Let's%20Learning%20Node.js%20Together%22%2C%0A%20%20%20%20%22last_reply_at%22%3A%20%222017-01-11T10%3A20%3A56.496Z%22%2C%0A%20%20%20%20%22good%22%3A%20false%2C%0A%20%20%20%20%22top%22%3A%20true%2C%0A%20%20%20%20%22reply_count%22%3A%20193%2C%0A%20%20%20%20%22visit_count%22%3A%2047633%2C%0A%20%20%7D%2C%0A%5D%0A%60%60%60%0A%0A%23%23%23%20Retrieve%20one%20topic%0A%0A-%20%60GET%20%2Fapi%2Fv2%2Ftopics%2F57ea257b3670ca3f44c5beb6%60%0A-%20status%20code%3A%20200%0A-%20response%20body%3A%0A%0A%60%60%60json%0A%7B%0A%20%20%22id%22%3A%20%2257ea257b3670ca3f44c5beb6%22%2C%0A%20%20%22author_id%22%3A%20%22541bf9b9ad60405c1f151a03%22%2C%0A%20%20%22tab%22%3A%20%22share%22%2C%0A%20%20%22content%22%3A%20%22content%22%2C%0A%20%20%22title%22%3A%20%22Finished%20Rewriting%20of%20Let's%20Learning%20Node.js%20Together%22%2C%0A%20%20%22last_reply_at%22%3A%20%222017-01-11T10%3A20%3A56.496Z%22%2C%0A%20%20%22good%22%3A%20false%2C%0A%20%20%22top%22%3A%20true%2C%0A%20%20%22reply_count%22%3A%20193%2C%0A%20%20%22visit_count%22%3A%2047633%2C%0A%7D%0A%60%60%60%0A%0A%23%23%23%20Create%20topics%0A%0A-%20%60POST%20%2Fapi%2Fv2%2Ftopics%60%0A-%20status%20code%3A%20201%0A-%20response%20body%3A%0A%0A%60%60%60json%0A%7B%0A%20%20%22topic_id%22%3A%20%2257ea257b3670ca3f44c5beb6%22%0A%7D%0A%60%60%60%0A%0A%23%23%23%20Update%20topics%0A%0A-%20%60PUT%20%2Fapi%2Fv2%2Ftopics%2F57ea257b3670ca3f44c5beb6%60%0A-%20status%20code%3A%20204%0A-%20response%20body%3A%20null%0A%0A%23%23%23%20Error%20handling%0A%0AWhen%20an%20error%20is%20occurring%2C%204xx%20status%20code%20is%20returned%20if%20occurred%20by%20client-side%20request%20parameters%20and%205xx%20status%20code%20is%20returned%20if%20occurred%20by%20server-side%20logic%20processing.%20All%20error%20objects%20are%20used%20as%20the%20description%20for%20status%20exceptions.%0A%0AFor%20example%2C%20passing%20invalided%20parameters%20from%20the%20client%20may%20return%20a%20response%20with%20status%20code%20422%2C%20the%20response%20body%20as%20shown%20below%3A%0A%60%60%60json%0A%7B%0A%20%20%22error%22%3A%20%22Validation%20Failed%22%2C%0A%20%20%22detail%22%3A%20%5B%20%7B%20%22message%22%3A%20%22required%22%2C%20%22field%22%3A%20%22title%22%2C%20%22code%22%3A%20%22missing_field%22%20%7D%20%5D%0A%7D%0A%60%60%60%0A%0A%23%23%20Getting%20Started%0A%0AAfter%20interface%20convention%2C%20we%20begin%20to%20create%20a%20RESTful%20API.%0A%0A%23%23%23%20Application%20initialization%0A%0AInitializes%20the%20application%20using%20%5Begg-init%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-init)%20in%20the%20%5Bquickstart%5D(..%2Fintro%2Fquickstart.md)%0A%0A%60%60%60bash%0A%24%20egg-init%20cnode-api%20--type%3Dsimple%0A%24%20cd%20cnode-api%0A%24%20npm%20i%0A%60%60%60%0A%0A%23%23%23%20Enable%20validate%20plugin%0A%0A%5Begg-validate%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-validate)%20is%20used%20to%20present%20the%20validate%20plugin.%0A%0A%60%60%60js%0A%2F%2F%20config%2Fplugin.js%0Aexports.validate%20%3D%20%7B%0A%20%20enable%3A%20true%2C%0A%20%20package%3A%20'egg-validate'%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20Router%20registry%0A%0AFirst%20of%20all%2C%20we%20follower%20previous%20design%20to%20register%20%5Brouter%5D(..%2Fbasics%2Frouter.md).%20The%20framework%20provides%20a%20simply%20way%20to%20create%20a%20RESTful-style%20router%20and%20mapping%20the%20resources%20to%20the%20corresponding%20controllers.%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.router.resources('topics'%2C%20'%2Fapi%2Fv2%2Ftopics'%2C%20app.controller.topics)%3B%0A%7D%3B%0A%60%60%60%0A%0AMapping%20the%20'topics'%20resource's%20CRUD%20interfaces%20to%20the%20%60app%2Fcontroller%2Ftopics.js%60%20using%20%60app.resources%60%0A%0A%23%23%23%20Developing%20controller%0A%0AIn%20%5Bcontroller%5D(..%2Fbasics%2Fcontroller.md)%2C%20we%20only%20need%20to%20implement%20the%20interface%20convention%20of%20%60app.resources%60%20%5BRESTful%20style%20URL%20definition%5D(..%2Fbasics%2Frouter.md%23RESTful-style-URL-definition).%20For%20example%2C%20creating%20a%20'topics'%20interface%3A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Ftopics.js%0Aconst%20Controller%20%3D%20require('egg').Controller%3B%0A%0A%2F%2F%20defining%20the%20rule%20of%20request%20parameters%0Aconst%20createRule%20%3D%20%7B%0A%20%20accesstoken%3A%20'string'%2C%0A%20%20title%3A%20'string'%2C%0A%20%20tab%3A%20%7B%20type%3A%20'enum'%2C%20values%3A%20%5B%20'ask'%2C%20'share'%2C%20'job'%20%5D%2C%20required%3A%20false%20%7D%2C%0A%20%20content%3A%20'string'%2C%0A%7D%3B%0A%0Aclass%20TopicController%20extends%20Controller%20%7B%0A%20%20async%20create()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20%2F%2F%20validate%20the%20%60ctx.request.body%60%20with%20the%20expected%20format%0A%20%20%20%20%2F%2F%20status%20%3D%20422%20exception%20will%20be%20thrown%20if%20not%20passing%20the%20parameter%20validation%0A%20%20%20%20ctx.validate(createRule%2C%20ctx.request.body)%3B%0A%20%20%20%20%2F%2F%20call%20service%20to%20create%20a%20topic%0A%20%20%20%20const%20id%20%3D%20await%20ctx.service.topics.create(ctx.request.body)%3B%0A%20%20%20%20%2F%2F%20configure%20the%20response%20body%20and%20status%20code%0A%20%20%20%20ctx.body%20%3D%20%7B%0A%20%20%20%20%20%20topic_id%3A%20id%2C%0A%20%20%20%20%7D%3B%0A%20%20%20%20ctx.status%20%3D%20201%3B%0A%20%20%7D%0A%7D%0Amodule.exports%20%3D%20TopicController%3B%0A%60%60%60%0A%0AAs%20shown%20above%2C%20a%20Controller%20mainly%20implements%20the%20following%20logic%3A%0A%0A1.%20call%20the%20validate%20function%20to%20validate%20the%20request%20parameters%0A2.%20create%20a%20topic%20by%20calling%20service%20encapsulates%20business%20logic%20using%20the%20validated%20parameters%0A3.%20configure%20the%20status%20code%20and%20context%20according%20to%20the%20interface%20convention%0A%0A%23%23%23%20Developing%20service%0A%0AWe%20will%20more%20focus%20on%20writing%20effective%20business%20logic%20in%20%5Bservice%5D(..%2Fbasics%2Fservice.md).%0A%0A%60%60%60js%0A%2F%2F%20app%2Fservice%2Ftopics.js%0Aconst%20Service%20%3D%20require('egg').Service%3B%0A%0Aclass%20TopicService%20extends%20Service%20%7B%0A%20%20constructor(ctx)%20%7B%0A%20%20%20%20super(ctx)%3B%0A%20%20%20%20this.root%20%3D%20'https%3A%2F%2Fcnodejs.org%2Fapi%2Fv1'%3B%0A%20%20%7D%0A%0A%20%20async%20create(params)%20%7B%0A%20%20%20%20%20%20%2F%2F%20call%20CNode%20V1%20API%0A%20%20%20%20const%20result%20%3D%20await%20this.ctx.curl(%60%24%7Bthis.root%7D%2Ftopics%60%2C%20%7B%0A%20%20%20%20%20%20method%3A%20'post'%2C%0A%20%20%20%20%20%20data%3A%20params%2C%0A%20%20%20%20%20%20dataType%3A%20'json'%2C%0A%20%20%20%20%20%20contentType%3A%20'json'%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%2F%2F%20check%20whether%20the%20call%20was%20successful%2C%20throws%20an%20exception%20if%20it%20fails%0A%20%20%20%20this.checkSuccess(result)%3B%0A%20%20%20%20%2F%2F%20return%20the%20id%20of%20topis%0A%20%20%20%20return%20result.data.topic_id%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20Encapsulated%20a%20uniform%20check%20function%2C%20can%20be%20reused%20in%20query%2C%20create%2C%20update%20and%20such%20on%20in%20service%0A%20%20checkSuccess(result)%20%7B%0A%20%20%20%20if%20(result.status%20!%3D%3D%20200)%20%7B%0A%20%20%20%20%20%20const%20errorMsg%20%3D%20result.data%20%26%26%20result.data.error_msg%20%3F%20result.data.error_msg%20%3A%20'unknown%20error'%3B%0A%20%20%20%20%20%20this.ctx.throw(result.status%2C%20errorMsg)%3B%0A%20%20%20%20%7D%0A%20%20%20%20if%20(!result.data.success)%20%7B%0A%20%20%20%20%20%20%2F%2F%20remote%20response%20error%0A%20%20%20%20%20%20this.ctx.throw(500%2C%20'remote%20response%20error'%2C%20%7B%20data%3A%20result.data%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A%0Amodule.exports%20%3D%20TopicService%3B%0A%60%60%60%0A%0AAfter%20developing%20the%20Service%20of%20topic%20creation%2C%20an%20interface%20have%20been%20completed%20from%20top%20to%20bottom.%0A%0A%23%23%23%20Unified%20error%20handling%0A%0ANormal%20business%20logic%20has%20been%20completed%2C%20but%20exceptions%20have%20not%20yet%20been%20processed.%20Controller%20and%20Service%20may%20throw%20an%20exception%20as%20the%20previous%20coding%2C%20so%20it%20is%20recommended%20that%20throwing%20an%20exception%20to%20interrupt%20if%20passing%20invalided%20parameters%20from%20the%20client%20or%20calling%20the%20back-end%20service%20with%20exception.%0A%0A-%20use%20Controller%20%60this.ctx.validate()%60%20to%20validate%20the%20parameters%2C%20throw%20exception%20if%20it%20fails.%0A-%20call%20Service%20%60this.ctx.curl()%60%20to%20access%20CNode%20API%2C%20may%20throw%20server%20exception%20due%20to%20network%20problems.%0A-%20an%20exception%20also%20will%20be%20thrown%20after%20Service%20is%20getting%20the%20response%20of%20calling%20failure%20from%20CNode%20API.%0A%0ADefault%20error%20handling%20is%20provided%20but%20might%20be%20inconsistent%20as%20the%20interface%20convention%20previously.%20We%20need%20to%20implement%20a%20unified%20error-handling%20middleware%20to%20handle%20the%20errors.%0A%0ACreate%20a%20file%20%60error_handler.js%60%20under%20%60app%2Fmiddleware%60%20directory%20to%20create%20a%20new%20%5Bmiddleware%5D(..%2Fbasics%2Fmiddleware.md)%0A%0A%60%60%60js%0A%2F%2F%20app%2Fmiddleware%2Ferror_handler.js%0Amodule.exports%20%3D%20()%20%3D%3E%20%7B%0A%20%20return%20async%20function%20errorHandler(ctx%2C%20next)%20%7B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20await%20next()%3B%0A%20%20%20%20%7D%20catch%20(err)%20%7B%0A%20%20%20%20%20%20%2F%2F%20All%20exceptions%20will%20trigger%20an%20error%20event%20on%20the%20app%20and%20the%20error%20log%20will%20be%20recorded%0A%20%20%20%20%20%20ctx.app.emit('error'%2C%20err%2C%20ctx)%3B%0A%0A%20%20%20%20%20%20const%20status%20%3D%20err.status%20%7C%7C%20500%3B%0A%20%20%20%20%20%20%2F%2F%20error%20500%20not%20returning%20to%20client%20when%20in%20the%20production%20environment%20because%20it%20may%20contain%20sensitive%20information%0A%20%20%20%20%20%20const%20error%20%3D%20status%20%3D%3D%3D%20500%20%26%26%20ctx.app.config.env%20%3D%3D%3D%20'prod'%0A%20%20%20%20%20%20%20%20%3F%20'Internal%20Server%20Error'%0A%20%20%20%20%20%20%20%20%3A%20err.message%3B%0A%0A%20%20%20%20%20%20%2F%2F%20Reading%20from%20the%20properties%20of%20error%20object%20and%20set%20it%20to%20the%20response%0A%20%20%20%20%20%20ctx.body%20%3D%20%7B%20error%20%7D%3B%0A%20%20%20%20%20%20if%20(status%20%3D%3D%3D%20422)%20%7B%0A%20%20%20%20%20%20%20%20ctx.body.detail%20%3D%20err.errors%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20ctx.status%20%3D%20status%3B%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0AWe%20can%20catch%20all%20exceptions%20and%20follow%20the%20expected%20format%20to%20encapsulate%20the%20response%20through%20the%20middleware.%20It%20can%20be%20loaded%20into%20application%20using%20configuration%20file%20(%60config%2Fconfig.default.js%60)%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20%2F%2F%20load%20the%20errorHandler%20middleware%0A%20%20middleware%3A%20%5B%20'errorHandler'%20%5D%2C%0A%20%20%2F%2F%20only%20takes%20effect%20on%20URL%20prefix%20with%20'%2Fapi'%0A%20%20errorHandler%3A%20%7B%0A%20%20%20%20match%3A%20'%2Fapi'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20Testing%0A%0ACompleting%20the%20coding%20just%20the%20first%20step%2C%20furthermore%20we%20need%20to%20add%20%5BUnit%20Test%5D(..%2Fcore%2Funittest.md)%20to%20the%20code.%0A%0A%23%23%23%20Controller%20Testing%0A%0ALet's%20start%20writing%20the%20unit%20test%20for%20the%20Controller.%20We%20can%20simulate%20the%20implementation%20of%20the%20Service%20layer%20in%20an%20appropriate%20way%20because%20the%20most%20important%20part%20is%20to%20test%20the%20logic%20as%20for%20Controller.%20And%20mocking%20up%20the%20Service%20layer%20according%20the%20convention%20of%20interface%2C%20so%20we%20can%20develop%20layered%20testing%20because%20the%20Service%20layer%20itself%20can%20also%20covered%20by%20Service%20unit%20test.%0A%0A%60%60%60js%0Aconst%20%7B%20app%2C%20mock%2C%20assert%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('test%2Fapp%2Fcontroller%2Ftopics.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20%2F%2F%20test%20the%20response%20of%20passing%20the%20error%20parameters%0A%20%20it('should%20POST%20%2Fapi%2Fv2%2Ftopics%2F%20422'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20app.mockCsrf()%3B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.post('%2Fapi%2Fv2%2Ftopics')%0A%20%20%20%20%20%20.send(%7B%0A%20%20%20%20%20%20%20%20accesstoken%3A%20'123'%2C%0A%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20.expect(422)%0A%20%20%20%20%20%20.expect(%7B%0A%20%20%20%20%20%20%20%20error%3A%20'Validation%20Failed'%2C%0A%20%20%20%20%20%20%20%20detail%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%7B%20message%3A%20'required'%2C%20field%3A%20'title'%2C%20code%3A%20'missing_field'%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%7B%20message%3A%20'required'%2C%20field%3A%20'content'%2C%20code%3A%20'missing_field'%20%7D%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%0A%20%20%2F%2F%20mock%20up%20the%20service%20layer%20and%20test%20the%20response%20of%20normal%20request%0A%20%20it('should%20POST%20%2Fapi%2Fv2%2Ftopics%2F%20201'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20app.mockCsrf()%3B%0A%20%20%20%20app.mockService('topics'%2C%20'create'%2C%20123)%3B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.post('%2Fapi%2Fv2%2Ftopics')%0A%20%20%20%20%20%20.send(%7B%0A%20%20%20%20%20%20%20%20accesstoken%3A%20'123'%2C%0A%20%20%20%20%20%20%20%20title%3A%20'title'%2C%0A%20%20%20%20%20%20%20%20content%3A%20'hello'%2C%0A%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20.expect(201)%0A%20%20%20%20%20%20.expect(%7B%0A%20%20%20%20%20%20%20%20topic_id%3A%20123%2C%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0AAs%20the%20Controller%20testing%20above%2C%20we%20create%20an%20application%20using%20%5Begg-mock%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock)%20and%20simulate%20the%20client%20to%20send%20request%20through%20%5BSuperTest%5D(https%3A%2F%2Fgithub.com%2Fvisionmedia%2Fsupertest).%20In%20the%20testing%2C%20we%20also%20simulate%20the%20response%20from%20Service%20layer%20to%20test%20the%20processing%20logic%20of%20Controller%20layer%0A%0A%23%23%23%20Service%20Testing%0A%0AUnit%20Test%20of%20Service%20layer%20may%20focus%20on%20the%20coding%20logic.%20%5Begg-mock%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock)%20provides%20a%20quick%20method%20to%20test%20the%20Service%20by%20calling%20the%20test%20method%20in%20the%20Service%2C%20and%20SuperTest%20to%20simulate%20the%20client%20request%20is%20no%20longer%20needed.%0A%0A%60%60%60js%0Aconst%20%7B%20app%2C%20mock%2C%20assert%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('test%2Fapp%2Fservice%2Ftopics.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20ctx%3B%0A%0A%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20create%20a%20global%20context%20object%20so%20that%20can%20call%20the%20service%20function%20on%20a%20ctx%20object%0A%20%20%20%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%7D)%0A%0A%20%20describe('create()'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20create%20failed%20by%20accesstoken%20error'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20calling%20service%20method%20on%20ctx%20directly%0A%20%20%20%20%20%20%20%20await%20ctx.service.topics.create(%7B%0A%20%20%20%20%20%20%20%20%20%20accesstoken%3A%20'hello'%2C%0A%20%20%20%20%20%20%20%20%20%20title%3A%20'title'%2C%0A%20%20%20%20%20%20%20%20%20%20content%3A%20'content'%2C%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%7D%20catch%20(err)%20%7B%0A%20%20%20%20%20%20%20%20assert(err.status%20%3D%3D%3D%20401)%3B%0A%20%20%20%20%20%20%20%20assert(err.message%20%3D%3D%3D%20'error%20accessToken')%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20throw%20'should%20not%20run%20here'%3B%0A%20%20%20%20%7D)%3B%0A%0A%20%20%20%20it('should%20create%20success'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20not%20affect%20the%20normal%20operation%20of%20CNode%20by%20simulating%20the%20interface%20calling%20of%20CNode%20based%20on%20interface%20convention%0A%20%20%20%20%20%20%2F%2F%20app.mockHttpclient%20method%20can%20easily%20simulate%20the%20appliation's%20HTTP%20request%0A%20%20%20%20%20%20app.mockHttpclient(%60%24%7Bctx.service.topics.root%7D%2Ftopics%60%2C%20'POST'%2C%20%7B%0A%20%20%20%20%20%20%20%20data%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20success%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20topic_id%3A%20'5433d5e4e737cbe96dcef312'%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%7D)%3B%0A%0A%20%20%20%20%20%20const%20id%20%3D%20await%20ctx.service.topics.create(%7B%0A%20%20%20%20%20%20%20%20accesstoken%3A%20'hello'%2C%0A%20%20%20%20%20%20%20%20title%3A%20'title'%2C%0A%20%20%20%20%20%20%20%20content%3A%20'content'%2C%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20assert(id%20%3D%3D%3D%20'5433d5e4e737cbe96dcef312')%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0AIn%20the%20testing%20of%20Service%20layer%20above%2C%20%20we%20create%20a%20Context%20object%20using%20the%20%60app.createContext()%60%20which%20provided%20by%20egg-mock%20and%20call%20the%20Service%20method%20on%20Context%20object%20to%20test%20directly.%20It%20can%20use%20%60app.mockHttpclient()%60%20to%20simulate%20the%20response%20of%20calling%20HTTP%20request%2C%20which%20allows%20us%20to%20focus%20on%20the%20logic%20testing%20of%20Service%20layer%20without%20the%20impact%20of%20environment.%0A%0A------%0A%0ASee%20the%20full%20example%20at%20%5Beggjs%2Fexamples%2Fcnode-api%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fexamples%2Ftree%2Fmaster%2Fcnode-api).%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>