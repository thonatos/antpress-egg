<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Socket.IO</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/en/intro/">Guide</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/en/tutorials/index.html">Tutorials</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">Plugins</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">Release</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>切换语言</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>Guide</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/index.html">What is Egg?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/quickstart.html">Quick Start</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/progressive.html">Progressive</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/migration.html">Migration to 2.x</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>Basis Function</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/structure.html">Directory Structure</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/objects.html">Built-in Objects</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/env.html">Environment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/config.html">Configuration</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/middleware.html">Middleware</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/plugin.html">Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/schedule.html">Schedule</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/extend.html">Extend</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/app-start.html">Custom Init</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>Core</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/development.html">Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/unittest.html">Unit Testing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/deployment.html">Deployment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/logger.html">Logger</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/view.html">View</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/error-handling.html">Error Handling</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/security.html">Security</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/i18n.html">i18n</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>Tutorials</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/passport.html">Passport</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/assets.html">Assets</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>Advanced</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/plugin.html">Plugin Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/framework.html">Framework</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/view-plugin.html">View Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/style-guide.html">Style Guide</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>Community</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/plugins/">Plugin List</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/contributing.html">Contributing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/resource.html">Resource</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/faq.html">FAQ</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><h2 id="title-socketio">title: Socket.IO</h2><p><strong>Socket.IO</strong> is a real-time application framework based on Node.js, which has a wide range of applications including instant messaging, notification and message push, real-time analysis and other scenarios.</p><p>WebSocket originated from the growing demand for real-time communication in web development, compared with http-based polling, which greatly saves network bandwidth and reduces server performance consumption. <a href="https://socket.io">Socket.IO</a> supports both websockets and polling. The data transmission method is compatible with the browser and does not support the communication requirements under the WebSocket scenario.</p><p>The framework provides the <a href="https://github.com/eggjs/egg-socket.io">egg-socket.io</a> plugin with the following development rules added:</p><ul><li>namespace: define the namespace by means of configuration
 - middleware: establish / disconnect every socket connection, preprocess every message / data transfer
 - controller: response socket.io event
 - router: unify the processing configuration of socket.io event and frame routing</li></ul><h2 id="install-egg-socketio">install egg-socket.io</h2><h3 id="installation">Installation</h3><pre><code class="language-bash">$ npm i egg-socket.io --save</code></pre><p><strong>Enable the plugin:</strong></p><pre><code class="language-js">// {app_root} /config/plugin.js
exports.io = {
  enable: true,
  package: &#x27;egg-socket.io&#x27;
};</code></pre><h3 id="configuration">Configuration</h3><pre><code class="language-js">// {app_root} / config / config. $ {env} .js
exports.io = {
  init: {}, // passed to engine.io
  namespace: {
    &#x27;/&#x27;: {
      connectionMiddleware: [],
      packetMiddleware: []
    },
    &#x27;/ example&#x27;: {
      connectionMiddleware: [],
      packetMiddleware: []
    }
  }
};</code></pre><blockquote><p>Namespaces are <code>/</code> and <code>/ example</code>, not<code>example</code></p></blockquote><p><strong>uws:</strong></p><p>If you want to use <a href="https://github.com/uWebSockets/uWebSockets">uws</a> instead of the default <code>ws</code> you can do the following configuration</p><pre><code class="language-js">// {app_root} / config / config. $ {env} .js
exports.io = {
  init: { wsEngine: &#x27;uws&#x27; } // default: ws
};</code></pre><blockquote><p>As µWS engine has been deprecated, maybe you should consider the default engine.</p></blockquote><p><strong>redis:</strong></p><p><a href="https://github.com/eggjs/egg-socket.io">egg-socket.io</a> has built-in redis support via <code>socket.io-redis</code>. In cluster mode, the use of redis can make it relatively simple to achieve information sharing of clients/rooms and so on</p><pre><code class="language-js">// {app_root} / config / config. $ {env} .js
exports.io = {
  redis: {
    host: {redis server host}
    port: {redis server prot},
    auth_pass: {redis server password},
    db: 0,
  },
};</code></pre><blockquote><p>When <code>redis</code> is turned on, the program tries to connect to the redis server at startup
Here <code>redis</code> is only used to store connection instance information, see <a href="https://socket.io/docs/server-api/#server-adapter-value"># server.adapter</a></p></blockquote><p><strong>note:</strong>
If the project also uses the <code>egg-redis</code>, please configure it separately. Do not share it.</p><h3 id="deployment">Deployment</h3><p>If the framework is started in cluster mode, the socket.io protocol implementation needs sticky feature support, otherwise it will not work in multi-process mode.</p><p>Due to the design of socket.io, a multi-process server must be in the sticky working mode. As a result, you need the need to pass parameter <code>--sticky</code> when starting the cluster.</p><p>Modify the <code>npm scripts</code> script in<code>package.json</code>:</p><pre><code class="language-js">{
  &quot;scripts&quot;: {
    &quot;dev&quot;: &quot;egg-bin dev --sticky&quot;,
    &quot;start&quot;: &quot;egg-scripts start --sticky&quot;
  }
}</code></pre><p><strong>Nginx configuration</strong></p><pre><code>location / {
  proxy_set_header Upgrade $ http_upgrade;
  proxy_set_header Connection &quot;upgrade&quot;;
  proxy_set_header X-Forwarded-For $ proxy_add_x_forwarded_for;
  proxy_set_header Host $ host;
  proxy_pass http://127.0.0.1:7001;
}</code></pre><h2 id="using-egg-socketio">Using egg-socket.io</h2><p>The directory structure of project which has enabled the <a href="https://github.com/eggjs/egg-socket.io">egg-socket.io</a> is as follows:</p><pre><code>chat
├── app
│ ├── extend
│ │ └── helper.js
│ ├── io
│ │ ├── controller
│ │ │ └── default.js
│ │ └── middleware
│ │ ├── connection.js
│ │ └── packet.js
│ └── router.js
├── config
└── package.json</code></pre><blockquote><p>Note: The corresponding files are in the app / io directory</p></blockquote><h3 id="middleware">Middleware</h3><p>Middleware has the following two scenarios:</p><ul><li>Connection</li><li>Packet</li></ul><p>It is configured in each namespace, respectively, according to the scenarios given above.</p><p><strong>note:</strong></p><p>If we enable the framework middleware, you will find the following directory in the project:</p><ul><li><code>app / middleware</code>: framework middleware</li><li><code>app / io / middleware</code>: plugin middleware</li></ul><p>the difference:</p><ul><li>Framework middleware is based on http model design to handle http requests.</li><li>Plugin middleware based socket model design, processing socket.io request.</li></ul><p>Although the framework tries to unify the style through plugins, it is important to note that their usage scenarios are different. For details, please see: <a href="https://github.com/eggjs/egg/issues/1416"># 1416</a></p><h4 id="connection">Connection</h4><p>Fires when each client connects or quits. Therefore, we usually perform authorization authentication at this step, and deal with the failed clients.</p><pre><code class="language-js">// {app_root} /app/io/middleware/connection.js
module.exports = app =&gt; {
  return async (ctx, next) =&gt; {
    ctx.socket.emit(&#x27;res&#x27;, &#x27;connected!&#x27;);
    await next(); // execute when disconnect.
    console.log(&#x27;disconnection!&#x27;);
  };
};</code></pre><p>Kick out the user example:</p><pre><code class="language-js">const tick = (id, msg) =&gt; {
  logger.debug(&#x27;# tick&#x27;, id, msg);
  socket.emit(id, msg);
  app.io.of(&#x27;/&#x27;).adapter.remoteDisconnect(id, true, err =&gt; {
    logger.error(err);
  });
};</code></pre><p>At the same time, the current connection can also be simple to deal with:</p><pre><code class="language-js">// {app_root} /app/io/middleware/connection.js
module.exports = app =&gt; {
  return async (ctx, next) =&gt; {
    if (true) {
      ctx.socket.disconnect();
      return;
    }
    await next();
    console.log(&#x27;disconnection!&#x27;);
  };
};</code></pre><h4 id="packet">Packet</h4><p>Acts on each data packet (each message). In the production environment, it is usually used to preprocess messages, or it is used to decrypt encrypted messages.</p><pre><code class="language-js">// {app_root} /app/io/middleware/packet.js
module.exports = app =&gt; {
  return async (ctx, next) =&gt; {
    ctx.socket.emit(&#x27;res&#x27;, &#x27;packet received!&#x27;);
    console.log(&#x27;packet:&#x27;, this.packet);
    await next();
  };
};</code></pre><h3 id="controller">Controller</h3><p>A controller deals with the events sent by the client. Since it inherits the <code>egg.controller</code>, it has the following member objects:</p><ul><li>ctx</li><li>app</li><li>service</li><li>config</li><li>logger</li></ul><blockquote><p>For details, refer to the <a href="">Controller</a> (../ basics / controller.md) documentation</p></blockquote><pre><code class="language-js">// {app_root} /app/io/controller/default.js
&#x27;use strict&#x27;;

const Controller = require(&#x27;egg&#x27;).Controller;

class DefaultController extends Controller {
  async ping() {
    const { ctx, app } = this;
    const message = ctx.args[0];
    await ctx.socket.emit(&#x27;res&#x27;, `Hi! I&#x27;ve got your message: $ {message}`);
  }
}

module.exports = DefaultController;

// or async functions

exports.ping = async function() {
  const message = this.args[0];
  await this.socket.emit(&#x27;res&#x27;, `Hi! I&#x27;ve got your message: $ {message}`);
};</code></pre><h3 id="router">Router</h3><p>Routing is responsible for passing various events received by the socket to the corresponding controllers.</p><pre><code class="language-js">// {app_root} /app/router.js

module.exports = app =&gt; {
  const { router, controller, io } = app; // default
  router.get(&#x27;/&#x27;, controller.home.index); // socket.io
  io.of(&#x27;/&#x27;).route(&#x27;server&#x27;, io.controller.home.server);
};</code></pre><p><strong>note:</strong></p><p>Nsp has the following system events:</p><ul><li><code>disconnecting</code> doing the disconnect</li><li><code>disconnect</code> connection has disconnected.</li><li><code>error</code> Error occurred</li></ul><h3 id="namespaceroom">Namespace/Room</h3><h4 id="namespace-nsp">Namespace (nsp)</h4><p>The namespace is usually meant to be assigned to different access points or paths. If the client does not specify a nsp, it is assigned to &quot;/&quot; by default.</p><p>In socket.io we use the <code>of</code> to divide the namespace; given that nsp is usually pre-defined and relatively fixed, the framework encapsulates it and uses configuration to partition different namespaces.</p><pre><code class="language-js">// socket.io
var nsp = io.of(&#x27;/my-namespace&#x27;);
nsp.on(&#x27;connection&#x27;, function(socket) {
  console.log(&#x27;someone connected&#x27;);
});
nsp.emit(&#x27;hi&#x27;, &#x27;everyone!&#x27;);

// egg
exports.io = {
  namespace: {
    &#x27;/&#x27;: {
      connectionMiddleware: [],
      packetMiddleware: []
    }
  }
};</code></pre><h4 id="room">Room</h4><p>Room exists in nsp and is added or left by the join/leave method; the method used in the framework is the same;</p><pre><code class="language-js">Const room = &#x27;default_room&#x27;;

Module.exports = app =&gt; {
   return async (ctx, next) =&gt; {
     ctx.socket.join(room);
     ctx.app.io.of(&#x27;/&#x27;).to(room).emit(&#x27;online&#x27;, { msg: &#x27;welcome&#x27;, id: ctx.socket.id });
     await next();
     console.log(&#x27;disconnection!&#x27;);
   };
};</code></pre><p><strong>Note:</strong> Each socket connection will have a random and unpredictable unique id <code>Socket#id</code> and will automatically be added to the room named after this <code>id</code></p><h2 id="examples">Examples</h2><p>Here we use <a href="https://github.com/eggjs/egg-socket.io">egg-socket.io</a> to do a small example which supports p2p chat</p><h3 id="client">client</h3><p>The UI-related content is not rewritten. It can be called via window.socket</p><pre><code class="language-js">// browser
const log = console.log;

window.onload = function() {
  // init
  const socket = io(&#x27;/&#x27;, {
    // Actual use can pass parameters here
    query: {
      room: &#x27;demo&#x27;,
      userId: `client_${Math.random()}`,
    },

    transports: [&#x27;websocket&#x27;]
  });

  socket.on(&#x27;connect&#x27;, () =&gt; {
    const id = socket.id;

    log(&#x27;#connect,&#x27;, id, socket); // receive online user information

    // listen for its own id to implement p2p communication
    socket.on(id, msg =&gt; {
      log(&#x27;#receive,&#x27;, msg);
    });
  });

  socket.on(&#x27;online&#x27;, msg =&gt; {
    log(&#x27;#online,&#x27;, msg);
  });

  // system events
  socket.on(&#x27;disconnect&#x27;, msg =&gt; {
    log(&#x27;#disconnect&#x27;, msg);
  });

  socket.on(&#x27;disconnecting&#x27;, () =&gt; {
    log(&#x27;#disconnecting&#x27;);
  });

  socket.on(&#x27;error&#x27;, () =&gt; {
    log(&#x27;#error&#x27;);
  });

  window.socket = socket;
};</code></pre><h4 id="wechat-applets">WeChat Applets</h4><p>The API provided by the WeChat applet is WebSocket, and socket.io is the upper encapsulation of Websocket. Therefore, we cannot directly use the API connection of the applet. You can use something like <a href="">wxapp-socket-io</a> (<a href="https://github.com/wxsocketio">https://github.com/wxsocketio</a> /wxapp-socket-io) to adapt to the library.</p><p>The sample code is as follows:</p><pre><code class="language-js">// Small program-side sample code
import io from &#x27;vendor/wxapp-socket-io.js&#x27;;

const socket = io(&#x27;ws://127.0.0.1:7001&#x27;);
socket.on(&#x27;connect&#x27;, function() {
  socket.emit(&#x27;chat&#x27;, &#x27;hello world!&#x27;);
});
socket.on(&#x27;res&#x27;, msg =&gt; {
  console.log(&#x27;res from server: %s!&#x27;, msg);
});</code></pre><h3 id="server">server</h3><p>The following is part of the demo code and explains the role of each method</p><h4 id="config">config</h4><pre><code class="language-js">// {app_root}/config/config.${env}.js
exports.io = {
  namespace: {
    &#x27;/&#x27;: {
      connectionMiddleware: [&#x27;auth&#x27;],
      packetMiddleware: [] // processing for message is not implemented temporarily
    }
  }, // Data sharing through redis in cluster mode

  redis: {
    host: &#x27;127.0.0.1&#x27;,
    port: 6379
  }
};</code></pre><h4 id="helper">helper</h4><p>Framework extensions for encapsulating data formats</p><pre><code class="language-js">// {app_root}/app/extend/helper.js

module.exports = {
  parseMsg(action, payload = {}, metadata = {}) {
    const meta = Object.assign(
      {},
      {
        timestamp: Date.now()
      },
      metadata
    );

    return {
      data: {
        action,
        payload
      },
      meta
    };
  }
};</code></pre><p>Format：</p><pre><code class="language-js">{
  data: {
    action: &#x27;exchange&#x27;,  // &#x27;deny&#x27; || &#x27;exchange&#x27; || &#x27;broadcast&#x27;
    payload: {},
  },
  meta:{
    timestamp: 1512116201597,
    client: &#x27;/webrtc#nNx88r1c5WuHf9XuAAAB&#x27;,
    target: &#x27;/webrtc#nNx88r1c5WuHf9XuAAAB&#x27;
  },
}</code></pre><h4 id="middleware">middleware</h4><p><a href="https://github.com/eggjs/egg-socket.io">egg-socket.io</a> middleware handles socket connection handling</p><pre><code class="language-js">// {app_root}/app/io/middleware/auth.js

const PREFIX = &#x27;room&#x27;;

module.exports = () =&gt; {
  return async (ctx, next) =&gt; {
    const { app, socket, logger, helper } = ctx;
    const id = socket.id;
    const nsp = app.io.of(&#x27;/&#x27;);
    const query = socket.handshake.query; // User Info

    const { room, userId } = query;
    const rooms = [room];

    logger.debug(&#x27;#user_info&#x27;, id, room, userId);

    const tick = (id, msg) =&gt; {
      logger.debug(&#x27;#tick&#x27;, id, msg); // Send message before kicking user

      socket.emit(id, helper.parseMsg(&#x27;deny&#x27;, msg)); // Call the adapter method to kick out the user and the client triggers the disconnect event

      nsp.adapter.remoteDisconnect(id, true, err =&gt; {
        logger.error(err);
      });
    }; // Check if the room exists, kick it out if it doesn&#x27;t exist // Note: here app.redis has nothing to do with the plugin, it can be replaced by other storage

    const hasRoom = await app.redis.get(`${PREFIX}:${room}`);

    logger.debug(&#x27;#has_exist&#x27;, hasRoom);

    if (!hasRoom) {
      tick(id, {
        type: &#x27;deleted&#x27;,
        message: &#x27;deleted, room has been deleted.&#x27;
      });
      return;
    } // When the user joins

    nsp.adapter.clients(rooms, (err, clients) =&gt; {
      // Append current socket information to clients
      clients[id] = query; // Join room

      socket.join(room);

      logger.debug(&#x27;#online_join&#x27;, _clients); // Update online user list

      nsp.to(room).emit(&#x27;online&#x27;, {
        clients,
        action: &#x27;join&#x27;,
        target: &#x27;participator&#x27;,
        message: `User(${id}) joined.`
      });
    });

    await next(); // When the user leaves

    nsp.adapter.clients(rooms, (err, clients) =&gt; {
      logger.debug(&#x27;#leave&#x27;, room);

      const _clients = {};
      clients.forEach(client =&gt; {
        const _id = client.split(&#x27;#&#x27;)[1];
        const _client = app.io.sockets.sockets[_id];
        const _query = _client.handshake.query;
        _clients[client] = _query;
      });

      logger.debug(&#x27;#online_leave&#x27;, _clients); // Update online user list

      nsp.to(room).emit(&#x27;online&#x27;, {
        clients: _clients,
        action: &#x27;leave&#x27;,
        target: &#x27;participator&#x27;,
        message: `User(${id}) leaved.`
      });
    });
  };
};</code></pre><h4 id="controller">controller</h4><p>Data exchange of P2P communication is through exchange</p><pre><code class="language-js">// {app_root}/app/io/controller/nsp.js
const Controller = require(&#x27;egg&#x27;).Controller;

class NspController extends controller {
  async exchange() {
    const { ctx, app } = this;
    const nsp = app.io.of(&#x27;/&#x27;);
    const message = ctx.args[0] || {};
    const socket = ctx.socket;
    const client = socket.id;

    try {
      const { target, payload } = message;
      if (!target) return;
      const msg = ctx.helper.parseMsg(&#x27;exchange&#x27;, payload, { client, target });
      nsp.emit(target, msg);
    } catch (error) {
      app.logger.error(error);
    }
  }
}

module.exports = NspController;</code></pre><h4 id="router">router</h4><pre><code class="language-js">// {app_root}/app/router.js
module.exports = app =&gt; {
  const { router, controller, io } = app;
  router.get(&#x27;/&#x27;, controller.home.index); // socket.io

  io.of(&#x27;/&#x27;).route(&#x27;exchange&#x27;, io.controller.nsp.exchange);
};</code></pre><p>Open two tab pages and call up the console:</p><pre><code class="language-js">socket.emit(&#x27;exchange&#x27;, {
  target: &#x27;/webrtc#Dkn3UXSu8_jHvKBmAAHW&#x27;,
  payload: {
    msg: &#x27;test&#x27;
  }
});</code></pre><p><img src="https://raw.githubusercontent.com/eggjs/egg/master/docs/assets/socketio-console.png"/></p><h2 id="reference-links">Reference Links</h2><ul><li><a href="https://socket.io">socket.io</a></li><li><a href="https://github.com/eggjs/egg-socket.io">egg-socket.io</a></li><li><a href="https://github.com/eggjs/egg-socket.io/tree/master/example">egg-socket.io example</a></li></ul></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#title-socketio">title: Socket.IO</a></li><li><a href="#install-egg-socketio">install egg-socket.io</a><ul><li><a href="#installation">Installation</a></li><li><a href="#configuration">Configuration</a></li><li><a href="#deployment">Deployment</a></li></ul></li><li><a href="#using-egg-socketio">Using egg-socket.io</a><ul><li><a href="#middleware">Middleware</a><ul><li><a href="#connection">Connection</a></li><li><a href="#packet">Packet</a></li></ul></li><li><a href="#controller">Controller</a></li><li><a href="#router">Router</a></li><li><a href="#namespaceroom">Namespace/Room</a><ul><li><a href="#namespace-nsp">Namespace (nsp)</a></li><li><a href="#room">Room</a></li></ul></li></ul></li><li><a href="#examples">Examples</a><ul><li><a href="#client">client</a><ul><li><a href="#wechat-applets">WeChat Applets</a></li></ul></li><li><a href="#server">server</a><ul><li><a href="#config">config</a></li><li><a href="#helper">helper</a></li><li><a href="#middleware">middleware</a></li><li><a href="#controller">controller</a></li><li><a href="#router">router</a></li></ul></li></ul></li><li><a href="#reference-links">Reference Links</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"en","props":{"toc":"-%20%5Btitle%3A%20Socket.IO%5D(%23title-socketio)%0A-%20%5Binstall%20egg-socket.io%5D(%23install-egg-socketio)%0A%20%20*%20%5BInstallation%5D(%23installation)%0A%20%20*%20%5BConfiguration%5D(%23configuration)%0A%20%20*%20%5BDeployment%5D(%23deployment)%0A-%20%5BUsing%20egg-socket.io%5D(%23using-egg-socketio)%0A%20%20*%20%5BMiddleware%5D(%23middleware)%0A%20%20%20%20%2B%20%5BConnection%5D(%23connection)%0A%20%20%20%20%2B%20%5BPacket%5D(%23packet)%0A%20%20*%20%5BController%5D(%23controller)%0A%20%20*%20%5BRouter%5D(%23router)%0A%20%20*%20%5BNamespace%2FRoom%5D(%23namespaceroom)%0A%20%20%20%20%2B%20%5BNamespace%20(nsp)%5D(%23namespace-nsp)%0A%20%20%20%20%2B%20%5BRoom%5D(%23room)%0A-%20%5BExamples%5D(%23examples)%0A%20%20*%20%5Bclient%5D(%23client)%0A%20%20%20%20%2B%20%5BWeChat%20Applets%5D(%23wechat-applets)%0A%20%20*%20%5Bserver%5D(%23server)%0A%20%20%20%20%2B%20%5Bconfig%5D(%23config)%0A%20%20%20%20%2B%20%5Bhelper%5D(%23helper)%0A%20%20%20%20%2B%20%5Bmiddleware%5D(%23middleware)%0A%20%20%20%20%2B%20%5Bcontroller%5D(%23controller)%0A%20%20%20%20%2B%20%5Brouter%5D(%23router)%0A-%20%5BReference%20Links%5D(%23reference-links)","meta":{"info":{"title":"Socket.IO"}},"content":"%0A%0A%0A%23%23%20title%3A%20Socket.IO%0A%0A**Socket.IO**%20is%20a%20real-time%20application%20framework%20based%20on%20Node.js%2C%20which%20has%20a%20wide%20range%20of%20applications%20including%20instant%20messaging%2C%20notification%20and%20message%20push%2C%20real-time%20analysis%20and%20other%20scenarios.%0A%0AWebSocket%20originated%20from%20the%20growing%20demand%20for%20real-time%20communication%20in%20web%20development%2C%20compared%20with%20http-based%20polling%2C%20which%20greatly%20saves%20network%20bandwidth%20and%20reduces%20server%20performance%20consumption.%20%5BSocket.IO%5D%20supports%20both%20websockets%20and%20polling.%20The%20data%20transmission%20method%20is%20compatible%20with%20the%20browser%20and%20does%20not%20support%20the%20communication%20requirements%20under%20the%20WebSocket%20scenario.%0A%0AThe%20framework%20provides%20the%20%5Begg-socket.io%5D%20plugin%20with%20the%20following%20development%20rules%20added%3A%0A%0A*%20namespace%3A%20define%20the%20namespace%20by%20means%20of%20configuration%0A%20%20%C2%A0-%20middleware%3A%20establish%20%2F%20disconnect%20every%20socket%20connection%2C%20preprocess%20every%20message%20%2F%20data%20transfer%0A%20%20%C2%A0-%20controller%3A%20response%20socket.io%20event%0A%20%20%C2%A0-%20router%3A%20unify%20the%20processing%20configuration%20of%20socket.io%20event%20and%20frame%20routing%0A%0A%23%23%20install%20egg-socket.io%0A%0A%23%23%23%20Installation%0A%0A%60%60%60bash%0A%24%20npm%20i%20egg-socket.io%20--save%0A%60%60%60%0A%0A**Enable%20the%20plugin%3A**%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%20%2Fconfig%2Fplugin.js%0Aexports.io%20%3D%20%7B%0A%20%20enable%3A%20true%2C%0A%20%20package%3A%20'egg-socket.io'%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20Configuration%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%20%2F%20config%20%2F%20config.%20%24%20%7Benv%7D%20.js%0Aexports.io%20%3D%20%7B%0A%20%20init%3A%20%7B%7D%2C%20%2F%2F%20passed%20to%20engine.io%0A%20%20namespace%3A%20%7B%0A%20%20%20%20'%2F'%3A%20%7B%0A%20%20%20%20%20%20connectionMiddleware%3A%20%5B%5D%2C%0A%20%20%20%20%20%20packetMiddleware%3A%20%5B%5D%0A%20%20%20%20%7D%2C%0A%20%20%20%20'%2F%20example'%3A%20%7B%0A%20%20%20%20%20%20connectionMiddleware%3A%20%5B%5D%2C%0A%20%20%20%20%20%20packetMiddleware%3A%20%5B%5D%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%3E%20Namespaces%20are%20%60%2F%60%20and%20%60%2F%20example%60%2C%20not%60example%60%0A%0A**uws%3A**%0A%0AIf%20you%20want%20to%20use%20%5Buws%5D%20instead%20of%20the%20default%20%60ws%60%20you%20can%20do%20the%20following%20configuration%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%20%2F%20config%20%2F%20config.%20%24%20%7Benv%7D%20.js%0Aexports.io%20%3D%20%7B%0A%20%20init%3A%20%7B%20wsEngine%3A%20'uws'%20%7D%20%2F%2F%20default%3A%20ws%0A%7D%3B%0A%60%60%60%0A%0A%3E%20As%20%C2%B5WS%20engine%20has%20been%20deprecated%2C%20maybe%20you%20should%20consider%20the%20default%20engine.%0A%0A**redis%3A**%0A%0A%5Begg-socket.io%5D%20has%20built-in%20redis%20support%20via%20%60socket.io-redis%60.%20In%20cluster%20mode%2C%20the%20use%20of%20redis%20can%20make%20it%20relatively%20simple%20to%20achieve%20information%20sharing%20of%20clients%2Frooms%20and%20so%20on%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%20%2F%20config%20%2F%20config.%20%24%20%7Benv%7D%20.js%0Aexports.io%20%3D%20%7B%0A%C2%A0%C2%A0redis%3A%20%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0host%3A%20%7Bredis%20server%20host%7D%0A%C2%A0%C2%A0%C2%A0%C2%A0port%3A%20%7Bredis%20server%20prot%7D%2C%0A%C2%A0%C2%A0%C2%A0%C2%A0auth_pass%3A%20%7Bredis%20server%20password%7D%2C%0A%C2%A0%C2%A0%C2%A0%C2%A0db%3A%200%2C%0A%C2%A0%C2%A0%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%3E%20When%20%60redis%60%20is%20turned%20on%2C%20the%20program%20tries%20to%20connect%20to%20the%20redis%20server%20at%20startup%0A%3E%20Here%20%60redis%60%20is%20only%20used%20to%20store%20connection%20instance%20information%2C%20see%20%5B%23%20server.adapter%5D(https%3A%2F%2Fsocket.io%2Fdocs%2Fserver-api%2F%23server-adapter-value)%0A%0A**note%3A**%0AIf%20the%20project%20also%20uses%20the%20%60egg-redis%60%2C%20please%20configure%20it%20separately.%20Do%20not%20share%20it.%0A%0A%23%23%23%20Deployment%0A%0AIf%20the%20framework%20is%20started%20in%20cluster%20mode%2C%20the%20socket.io%20protocol%20implementation%20needs%20sticky%20feature%20support%2C%20otherwise%20it%20will%20not%20work%20in%20multi-process%20mode.%0A%0ADue%20to%20the%20design%20of%20socket.io%2C%20a%20multi-process%20server%20must%20be%20in%20the%20sticky%20working%20mode.%20As%20a%20result%2C%20you%20need%20the%20need%20to%20pass%20parameter%20%60--sticky%60%20when%20starting%20the%20cluster.%0A%0AModify%20the%20%60npm%20scripts%60%20script%20in%60package.json%60%3A%0A%0A%60%60%60js%0A%7B%0A%C2%A0%C2%A0%22scripts%22%3A%20%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0%22dev%22%3A%20%22egg-bin%20dev%20--sticky%22%2C%0A%C2%A0%C2%A0%C2%A0%C2%A0%22start%22%3A%20%22egg-scripts%20start%20--sticky%22%0A%C2%A0%C2%A0%7D%0A%7D%0A%60%60%60%0A%0A**Nginx%20configuration**%0A%0A%60%60%60%0Alocation%20%2F%20%7B%0A%C2%A0%C2%A0proxy_set_header%20Upgrade%20%24%20http_upgrade%3B%0A%C2%A0%C2%A0proxy_set_header%20Connection%20%22upgrade%22%3B%0A%C2%A0%C2%A0proxy_set_header%20X-Forwarded-For%20%24%20proxy_add_x_forwarded_for%3B%0A%C2%A0%C2%A0proxy_set_header%20Host%20%24%20host%3B%0A%C2%A0%C2%A0proxy_pass%20http%3A%2F%2F127.0.0.1%3A7001%3B%0A%7D%0A%60%60%60%0A%0A%23%23%20Using%20egg-socket.io%0A%0AThe%20directory%20structure%20of%20project%20which%20has%20enabled%20the%20%5Begg-socket.io%5D%20is%20as%20follows%3A%0A%0A%60%60%60%0Achat%0A%E2%94%9C%E2%94%80%E2%94%80%20app%0A%E2%94%82%20%E2%94%9C%E2%94%80%E2%94%80%20extend%0A%E2%94%82%20%E2%94%82%20%E2%94%94%E2%94%80%E2%94%80%20helper.js%0A%E2%94%82%20%E2%94%9C%E2%94%80%E2%94%80%20io%0A%E2%94%82%20%E2%94%82%20%E2%94%9C%E2%94%80%E2%94%80%20controller%0A%E2%94%82%20%E2%94%82%20%E2%94%82%20%E2%94%94%E2%94%80%E2%94%80%20default.js%0A%E2%94%82%20%E2%94%82%20%E2%94%94%E2%94%80%E2%94%80%20middleware%0A%E2%94%82%20%E2%94%82%20%E2%94%9C%E2%94%80%E2%94%80%20connection.js%0A%E2%94%82%20%E2%94%82%20%E2%94%94%E2%94%80%E2%94%80%20packet.js%0A%E2%94%82%20%E2%94%94%E2%94%80%E2%94%80%20router.js%0A%E2%94%9C%E2%94%80%E2%94%80%20config%0A%E2%94%94%E2%94%80%E2%94%80%20package.json%0A%60%60%60%0A%0A%3E%20Note%3A%20The%20corresponding%20files%20are%20in%20the%20app%20%2F%20io%20directory%0A%0A%23%23%23%20Middleware%0A%0AMiddleware%20has%20the%20following%20two%20scenarios%3A%0A%0A*%20Connection%0A*%20Packet%0A%0AIt%20is%20configured%20in%20each%20namespace%2C%20respectively%2C%20according%20to%20the%20scenarios%20given%20above.%0A%0A**note%3A**%0A%0AIf%20we%20enable%20the%20framework%20middleware%2C%20you%20will%20find%20the%20following%20directory%20in%20the%20project%3A%0A%0A*%20%60app%20%2F%20middleware%60%3A%20framework%20middleware%0A*%20%60app%20%2F%20io%20%2F%20middleware%60%3A%20plugin%20middleware%0A%0Athe%20difference%3A%0A%0A*%20Framework%20middleware%20is%20based%20on%20http%20model%20design%20to%20handle%20http%20requests.%0A*%20Plugin%20middleware%20based%20socket%20model%20design%2C%20processing%20socket.io%20request.%0A%0AAlthough%20the%20framework%20tries%20to%20unify%20the%20style%20through%20plugins%2C%20it%20is%20important%20to%20note%20that%20their%20usage%20scenarios%20are%20different.%20For%20details%2C%20please%20see%3A%20%5B%23%201416%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg%2Fissues%2F1416)%0A%0A%23%23%23%23%20Connection%0A%0AFires%20when%20each%20client%20connects%20or%20quits.%20Therefore%2C%20we%20usually%20perform%20authorization%20authentication%20at%20this%20step%2C%20and%20deal%20with%20the%20failed%20clients.%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%20%2Fapp%2Fio%2Fmiddleware%2Fconnection.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20return%20async%20(ctx%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20ctx.socket.emit('res'%2C%20'connected!')%3B%0A%20%20%20%20await%20next()%3B%20%2F%2F%20execute%20when%20disconnect.%0A%20%20%20%20console.log('disconnection!')%3B%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0AKick%20out%20the%20user%20example%3A%0A%0A%60%60%60js%0Aconst%20tick%20%3D%20(id%2C%20msg)%20%3D%3E%20%7B%0A%20%20logger.debug('%23%20tick'%2C%20id%2C%20msg)%3B%0A%20%20socket.emit(id%2C%20msg)%3B%0A%20%20app.io.of('%2F').adapter.remoteDisconnect(id%2C%20true%2C%20err%20%3D%3E%20%7B%0A%20%20%20%20logger.error(err)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0AAt%20the%20same%20time%2C%20the%20current%20connection%20can%20also%20be%20simple%20to%20deal%20with%3A%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%20%2Fapp%2Fio%2Fmiddleware%2Fconnection.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20return%20async%20(ctx%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20if%20(true)%20%7B%0A%20%20%20%20%20%20ctx.socket.disconnect()%3B%0A%20%20%20%20%20%20return%3B%0A%20%20%20%20%7D%0A%20%20%20%20await%20next()%3B%0A%20%20%20%20console.log('disconnection!')%3B%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%23%20Packet%0A%0AActs%20on%20each%20data%20packet%20(each%20message).%20In%20the%20production%20environment%2C%20it%20is%20usually%20used%20to%20preprocess%20messages%2C%20or%20it%20is%20used%20to%20decrypt%20encrypted%20messages.%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%20%2Fapp%2Fio%2Fmiddleware%2Fpacket.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20return%20async%20(ctx%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20ctx.socket.emit('res'%2C%20'packet%20received!')%3B%0A%20%20%20%20console.log('packet%3A'%2C%20this.packet)%3B%0A%20%20%20%20await%20next()%3B%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20Controller%0A%0AA%20controller%20deals%20with%20the%20events%20sent%20by%20the%20client.%20Since%20it%20inherits%20the%20%60egg.controller%60%2C%20it%20has%20the%20following%20member%20objects%3A%0A%0A*%20ctx%0A*%20app%0A*%20service%0A*%20config%0A*%20logger%0A%0A%3E%20For%20details%2C%20refer%20to%20the%20%5BController%5D%20(..%2F%20basics%20%2F%20controller.md)%20documentation%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%20%2Fapp%2Fio%2Fcontroller%2Fdefault.js%0A'use%20strict'%3B%0A%0Aconst%20Controller%20%3D%20require('egg').Controller%3B%0A%0Aclass%20DefaultController%20extends%20Controller%20%7B%0A%20%20async%20ping()%20%7B%0A%20%20%20%20const%20%7B%20ctx%2C%20app%20%7D%20%3D%20this%3B%0A%20%20%20%20const%20message%20%3D%20ctx.args%5B0%5D%3B%0A%20%20%20%20await%20ctx.socket.emit('res'%2C%20%60Hi!%20I've%20got%20your%20message%3A%20%24%20%7Bmessage%7D%60)%3B%0A%20%20%7D%0A%7D%0A%0Amodule.exports%20%3D%20DefaultController%3B%0A%0A%2F%2F%20or%20async%20functions%0A%0Aexports.ping%20%3D%20async%20function()%20%7B%0A%20%20const%20message%20%3D%20this.args%5B0%5D%3B%0A%20%20await%20this.socket.emit('res'%2C%20%60Hi!%20I've%20got%20your%20message%3A%20%24%20%7Bmessage%7D%60)%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20Router%0A%0ARouting%20is%20responsible%20for%20passing%20various%20events%20received%20by%20the%20socket%20to%20the%20corresponding%20controllers.%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%20%2Fapp%2Frouter.js%0A%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20%7B%20router%2C%20controller%2C%20io%20%7D%20%3D%20app%3B%20%2F%2F%20default%0A%20%20router.get('%2F'%2C%20controller.home.index)%3B%20%2F%2F%20socket.io%0A%20%20io.of('%2F').route('server'%2C%20io.controller.home.server)%3B%0A%7D%3B%0A%60%60%60%0A%0A**note%3A**%0A%0ANsp%20has%20the%20following%20system%20events%3A%0A%0A*%20%60disconnecting%60%20doing%20the%20disconnect%0A*%20%60disconnect%60%20connection%20has%20disconnected.%0A*%20%60error%60%20Error%20occurred%0A%0A%23%23%23%20Namespace%2FRoom%0A%0A%23%23%23%23%20Namespace%20(nsp)%0A%0AThe%20namespace%20is%20usually%20meant%20to%20be%20assigned%20to%20different%20access%20points%20or%20paths.%20If%20the%20client%20does%20not%20specify%20a%20nsp%2C%20it%20is%20assigned%20to%20%22%2F%22%20by%20default.%0A%0AIn%20socket.io%20we%20use%20the%20%60of%60%20to%20divide%20the%20namespace%3B%20given%20that%20nsp%20is%20usually%20pre-defined%20and%20relatively%20fixed%2C%20the%20framework%20encapsulates%20it%20and%20uses%20configuration%20to%20partition%20different%20namespaces.%0A%0A%60%60%60js%0A%2F%2F%20socket.io%0Avar%20nsp%20%3D%20io.of('%2Fmy-namespace')%3B%0Ansp.on('connection'%2C%20function(socket)%20%7B%0A%20%20console.log('someone%20connected')%3B%0A%7D)%3B%0Ansp.emit('hi'%2C%20'everyone!')%3B%0A%0A%2F%2F%20egg%0Aexports.io%20%3D%20%7B%0A%20%20namespace%3A%20%7B%0A%20%20%20%20'%2F'%3A%20%7B%0A%20%20%20%20%20%20connectionMiddleware%3A%20%5B%5D%2C%0A%20%20%20%20%20%20packetMiddleware%3A%20%5B%5D%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%23%20Room%0A%0ARoom%20exists%20in%20nsp%20and%20is%20added%20or%20left%20by%20the%20join%2Fleave%20method%3B%20the%20method%20used%20in%20the%20framework%20is%20the%20same%3B%0A%0A%60%60%60js%0AConst%20room%20%3D%20'default_room'%3B%0A%0AModule.exports%20%3D%20app%20%3D%3E%20%7B%0A%C2%A0%C2%A0%20return%20async%20(ctx%2C%20next)%20%3D%3E%20%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0%20ctx.socket.join(room)%3B%0A%C2%A0%C2%A0%C2%A0%C2%A0%20ctx.app.io.of('%2F').to(room).emit('online'%2C%20%7B%20msg%3A%20'welcome'%2C%20id%3A%20ctx.socket.id%20%7D)%3B%0A%C2%A0%C2%A0%C2%A0%C2%A0%20await%20next()%3B%0A%C2%A0%C2%A0%C2%A0%C2%A0%20console.log('disconnection!')%3B%0A%C2%A0%C2%A0%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A**Note%3A**%20Each%20socket%20connection%20will%20have%20a%20random%20and%20unpredictable%20unique%20id%20%60Socket%23id%60%20and%20will%20automatically%20be%20added%20to%20the%20room%20named%20after%20this%20%60id%60%0A%0A%23%23%20Examples%0A%0AHere%20we%20use%20%5Begg-socket.io%5D%20to%20do%20a%20small%20example%20which%20supports%20p2p%20chat%0A%0A%23%23%23%20client%0A%0AThe%20UI-related%20content%20is%20not%20rewritten.%20It%20can%20be%20called%20via%20window.socket%0A%0A%60%60%60js%0A%2F%2F%20browser%0Aconst%20log%20%3D%20console.log%3B%0A%0Awindow.onload%20%3D%20function()%20%7B%0A%20%20%2F%2F%20init%0A%20%20const%20socket%20%3D%20io('%2F'%2C%20%7B%0A%20%20%20%20%2F%2F%20Actual%20use%20can%20pass%20parameters%20here%0A%20%20%20%20query%3A%20%7B%0A%20%20%20%20%20%20room%3A%20'demo'%2C%0A%20%20%20%20%20%20userId%3A%20%60client_%24%7BMath.random()%7D%60%2C%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20transports%3A%20%5B'websocket'%5D%0A%20%20%7D)%3B%0A%0A%20%20socket.on('connect'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20id%20%3D%20socket.id%3B%0A%0A%20%20%20%20log('%23connect%2C'%2C%20id%2C%20socket)%3B%20%2F%2F%20receive%20online%20user%20information%0A%0A%20%20%20%20%2F%2F%20listen%20for%20its%20own%20id%20to%20implement%20p2p%20communication%0A%20%20%20%20socket.on(id%2C%20msg%20%3D%3E%20%7B%0A%20%20%20%20%20%20log('%23receive%2C'%2C%20msg)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%0A%20%20socket.on('online'%2C%20msg%20%3D%3E%20%7B%0A%20%20%20%20log('%23online%2C'%2C%20msg)%3B%0A%20%20%7D)%3B%0A%0A%20%20%2F%2F%20system%20events%0A%20%20socket.on('disconnect'%2C%20msg%20%3D%3E%20%7B%0A%20%20%20%20log('%23disconnect'%2C%20msg)%3B%0A%20%20%7D)%3B%0A%0A%20%20socket.on('disconnecting'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20log('%23disconnecting')%3B%0A%20%20%7D)%3B%0A%0A%20%20socket.on('error'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20log('%23error')%3B%0A%20%20%7D)%3B%0A%0A%20%20window.socket%20%3D%20socket%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%23%20WeChat%20Applets%0A%0AThe%20API%20provided%20by%20the%20WeChat%20applet%20is%20WebSocket%2C%20and%20socket.io%20is%20the%20upper%20encapsulation%20of%20Websocket.%20Therefore%2C%20we%20cannot%20directly%20use%20the%20API%20connection%20of%20the%20applet.%20You%20can%20use%20something%20like%20%5Bwxapp-socket-io%5D%20(https%3A%2F%2Fgithub.com%2Fwxsocketio%20%2Fwxapp-socket-io)%20to%20adapt%20to%20the%20library.%0A%0AThe%20sample%20code%20is%20as%20follows%3A%0A%0A%60%60%60js%0A%2F%2F%20Small%20program-side%20sample%20code%0Aimport%20io%20from%20'vendor%2Fwxapp-socket-io.js'%3B%0A%0Aconst%20socket%20%3D%20io('ws%3A%2F%2F127.0.0.1%3A7001')%3B%0Asocket.on('connect'%2C%20function()%20%7B%0A%20%20socket.emit('chat'%2C%20'hello%20world!')%3B%0A%7D)%3B%0Asocket.on('res'%2C%20msg%20%3D%3E%20%7B%0A%20%20console.log('res%20from%20server%3A%20%25s!'%2C%20msg)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20server%0A%0AThe%20following%20is%20part%20of%20the%20demo%20code%20and%20explains%20the%20role%20of%20each%20method%0A%0A%23%23%23%23%20config%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%2Fconfig%2Fconfig.%24%7Benv%7D.js%0Aexports.io%20%3D%20%7B%0A%20%20namespace%3A%20%7B%0A%20%20%20%20'%2F'%3A%20%7B%0A%20%20%20%20%20%20connectionMiddleware%3A%20%5B'auth'%5D%2C%0A%20%20%20%20%20%20packetMiddleware%3A%20%5B%5D%20%2F%2F%20processing%20for%20message%20is%20not%20implemented%20temporarily%0A%20%20%20%20%7D%0A%20%20%7D%2C%20%2F%2F%20Data%20sharing%20through%20redis%20in%20cluster%20mode%0A%0A%20%20redis%3A%20%7B%0A%20%20%20%20host%3A%20'127.0.0.1'%2C%0A%20%20%20%20port%3A%206379%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%23%20helper%0A%0AFramework%20extensions%20for%20encapsulating%20data%20formats%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%2Fapp%2Fextend%2Fhelper.js%0A%0Amodule.exports%20%3D%20%7B%0A%20%20parseMsg(action%2C%20payload%20%3D%20%7B%7D%2C%20metadata%20%3D%20%7B%7D)%20%7B%0A%20%20%20%20const%20meta%20%3D%20Object.assign(%0A%20%20%20%20%20%20%7B%7D%2C%0A%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20timestamp%3A%20Date.now()%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20metadata%0A%20%20%20%20)%3B%0A%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20data%3A%20%7B%0A%20%20%20%20%20%20%20%20action%2C%0A%20%20%20%20%20%20%20%20payload%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20meta%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0AFormat%EF%BC%9A%0A%0A%60%60%60js%0A%7B%0A%20%20data%3A%20%7B%0A%20%20%20%20action%3A%20'exchange'%2C%20%20%2F%2F%20'deny'%20%7C%7C%20'exchange'%20%7C%7C%20'broadcast'%0A%20%20%20%20payload%3A%20%7B%7D%2C%0A%20%20%7D%2C%0A%20%20meta%3A%7B%0A%20%20%20%20timestamp%3A%201512116201597%2C%0A%20%20%20%20client%3A%20'%2Fwebrtc%23nNx88r1c5WuHf9XuAAAB'%2C%0A%20%20%20%20target%3A%20'%2Fwebrtc%23nNx88r1c5WuHf9XuAAAB'%0A%20%20%7D%2C%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20middleware%0A%0A%5Begg-socket.io%5D%20middleware%20handles%20socket%20connection%20handling%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%2Fapp%2Fio%2Fmiddleware%2Fauth.js%0A%0Aconst%20PREFIX%20%3D%20'room'%3B%0A%0Amodule.exports%20%3D%20()%20%3D%3E%20%7B%0A%20%20return%20async%20(ctx%2C%20next)%20%3D%3E%20%7B%0A%20%20%20%20const%20%7B%20app%2C%20socket%2C%20logger%2C%20helper%20%7D%20%3D%20ctx%3B%0A%20%20%20%20const%20id%20%3D%20socket.id%3B%0A%20%20%20%20const%20nsp%20%3D%20app.io.of('%2F')%3B%0A%20%20%20%20const%20query%20%3D%20socket.handshake.query%3B%20%2F%2F%20User%20Info%0A%0A%20%20%20%20const%20%7B%20room%2C%20userId%20%7D%20%3D%20query%3B%0A%20%20%20%20const%20rooms%20%3D%20%5Broom%5D%3B%0A%0A%20%20%20%20logger.debug('%23user_info'%2C%20id%2C%20room%2C%20userId)%3B%0A%0A%20%20%20%20const%20tick%20%3D%20(id%2C%20msg)%20%3D%3E%20%7B%0A%20%20%20%20%20%20logger.debug('%23tick'%2C%20id%2C%20msg)%3B%20%2F%2F%20Send%20message%20before%20kicking%20user%0A%0A%20%20%20%20%20%20socket.emit(id%2C%20helper.parseMsg('deny'%2C%20msg))%3B%20%2F%2F%20Call%20the%20adapter%20method%20to%20kick%20out%20the%20user%20and%20the%20client%20triggers%20the%20disconnect%20event%0A%0A%20%20%20%20%20%20nsp.adapter.remoteDisconnect(id%2C%20true%2C%20err%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20logger.error(err)%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%3B%20%2F%2F%20Check%20if%20the%20room%20exists%2C%20kick%20it%20out%20if%20it%20doesn't%20exist%20%2F%2F%20Note%3A%20here%20app.redis%20has%20nothing%20to%20do%20with%20the%20plugin%2C%20it%20can%20be%20replaced%20by%20other%20storage%0A%0A%20%20%20%20const%20hasRoom%20%3D%20await%20app.redis.get(%60%24%7BPREFIX%7D%3A%24%7Broom%7D%60)%3B%0A%0A%20%20%20%20logger.debug('%23has_exist'%2C%20hasRoom)%3B%0A%0A%20%20%20%20if%20(!hasRoom)%20%7B%0A%20%20%20%20%20%20tick(id%2C%20%7B%0A%20%20%20%20%20%20%20%20type%3A%20'deleted'%2C%0A%20%20%20%20%20%20%20%20message%3A%20'deleted%2C%20room%20has%20been%20deleted.'%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20return%3B%0A%20%20%20%20%7D%20%2F%2F%20When%20the%20user%20joins%0A%0A%20%20%20%20nsp.adapter.clients(rooms%2C%20(err%2C%20clients)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Append%20current%20socket%20information%20to%20clients%0A%20%20%20%20%20%20clients%5Bid%5D%20%3D%20query%3B%20%2F%2F%20Join%20room%0A%0A%20%20%20%20%20%20socket.join(room)%3B%0A%0A%20%20%20%20%20%20logger.debug('%23online_join'%2C%20_clients)%3B%20%2F%2F%20Update%20online%20user%20list%0A%0A%20%20%20%20%20%20nsp.to(room).emit('online'%2C%20%7B%0A%20%20%20%20%20%20%20%20clients%2C%0A%20%20%20%20%20%20%20%20action%3A%20'join'%2C%0A%20%20%20%20%20%20%20%20target%3A%20'participator'%2C%0A%20%20%20%20%20%20%20%20message%3A%20%60User(%24%7Bid%7D)%20joined.%60%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%0A%20%20%20%20await%20next()%3B%20%2F%2F%20When%20the%20user%20leaves%0A%0A%20%20%20%20nsp.adapter.clients(rooms%2C%20(err%2C%20clients)%20%3D%3E%20%7B%0A%20%20%20%20%20%20logger.debug('%23leave'%2C%20room)%3B%0A%0A%20%20%20%20%20%20const%20_clients%20%3D%20%7B%7D%3B%0A%20%20%20%20%20%20clients.forEach(client%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20const%20_id%20%3D%20client.split('%23')%5B1%5D%3B%0A%20%20%20%20%20%20%20%20const%20_client%20%3D%20app.io.sockets.sockets%5B_id%5D%3B%0A%20%20%20%20%20%20%20%20const%20_query%20%3D%20_client.handshake.query%3B%0A%20%20%20%20%20%20%20%20_clients%5Bclient%5D%20%3D%20_query%3B%0A%20%20%20%20%20%20%7D)%3B%0A%0A%20%20%20%20%20%20logger.debug('%23online_leave'%2C%20_clients)%3B%20%2F%2F%20Update%20online%20user%20list%0A%0A%20%20%20%20%20%20nsp.to(room).emit('online'%2C%20%7B%0A%20%20%20%20%20%20%20%20clients%3A%20_clients%2C%0A%20%20%20%20%20%20%20%20action%3A%20'leave'%2C%0A%20%20%20%20%20%20%20%20target%3A%20'participator'%2C%0A%20%20%20%20%20%20%20%20message%3A%20%60User(%24%7Bid%7D)%20leaved.%60%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%23%20controller%0A%0AData%20exchange%20of%20P2P%20communication%20is%20through%20exchange%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%2Fapp%2Fio%2Fcontroller%2Fnsp.js%0Aconst%20Controller%20%3D%20require('egg').Controller%3B%0A%0Aclass%20NspController%20extends%20controller%20%7B%0A%20%20async%20exchange()%20%7B%0A%20%20%20%20const%20%7B%20ctx%2C%20app%20%7D%20%3D%20this%3B%0A%20%20%20%20const%20nsp%20%3D%20app.io.of('%2F')%3B%0A%20%20%20%20const%20message%20%3D%20ctx.args%5B0%5D%20%7C%7C%20%7B%7D%3B%0A%20%20%20%20const%20socket%20%3D%20ctx.socket%3B%0A%20%20%20%20const%20client%20%3D%20socket.id%3B%0A%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20const%20%7B%20target%2C%20payload%20%7D%20%3D%20message%3B%0A%20%20%20%20%20%20if%20(!target)%20return%3B%0A%20%20%20%20%20%20const%20msg%20%3D%20ctx.helper.parseMsg('exchange'%2C%20payload%2C%20%7B%20client%2C%20target%20%7D)%3B%0A%20%20%20%20%20%20nsp.emit(target%2C%20msg)%3B%0A%20%20%20%20%7D%20catch%20(error)%20%7B%0A%20%20%20%20%20%20app.logger.error(error)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A%0Amodule.exports%20%3D%20NspController%3B%0A%60%60%60%0A%0A%23%23%23%23%20router%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%2Fapp%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20%7B%20router%2C%20controller%2C%20io%20%7D%20%3D%20app%3B%0A%20%20router.get('%2F'%2C%20controller.home.index)%3B%20%2F%2F%20socket.io%0A%0A%20%20io.of('%2F').route('exchange'%2C%20io.controller.nsp.exchange)%3B%0A%7D%3B%0A%60%60%60%0A%0AOpen%20two%20tab%20pages%20and%20call%20up%20the%20console%3A%0A%0A%60%60%60js%0Asocket.emit('exchange'%2C%20%7B%0A%20%20target%3A%20'%2Fwebrtc%23Dkn3UXSu8_jHvKBmAAHW'%2C%0A%20%20payload%3A%20%7B%0A%20%20%20%20msg%3A%20'test'%0A%20%20%7D%0A%7D)%3B%0A%60%60%60%0A%0A!%5B%5D(https%3A%2F%2Fraw.githubusercontent.com%2Feggjs%2Fegg%2Fmaster%2Fdocs%2Fassets%2Fsocketio-console.png)%0A%0A%23%23%20Reference%20Links%0A%0A*%20%5Bsocket.io%5D%0A*%20%5Begg-socket.io%5D%0A*%20%5Begg-socket.io%20example%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-socket.io%2Ftree%2Fmaster%2Fexample)%0A%0A%5Bsocket.io%5D%3A%20https%3A%2F%2Fsocket.io%0A%5Begg-socket.io%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-socket.io%0A%5Buws%5D%3A%20https%3A%2F%2Fgithub.com%2FuWebSockets%2FuWebSockets%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>