<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>MySQL</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/en/intro/">Guide</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/en/tutorials/index.html">Tutorials</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">Plugins</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">Release</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>切换语言</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>Guide</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/index.html">What is Egg?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/quickstart.html">Quick Start</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/progressive.html">Progressive</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/migration.html">Migration to 2.x</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>Basis Function</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/structure.html">Directory Structure</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/objects.html">Built-in Objects</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/env.html">Environment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/config.html">Configuration</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/middleware.html">Middleware</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/plugin.html">Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/schedule.html">Schedule</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/extend.html">Extend</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/app-start.html">Custom Init</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>Core</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/development.html">Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/unittest.html">Unit Testing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/deployment.html">Deployment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/logger.html">Logger</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/view.html">View</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/error-handling.html">Error Handling</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/security.html">Security</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/i18n.html">i18n</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>Tutorials</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/passport.html">Passport</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/assets.html">Assets</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>Advanced</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/plugin.html">Plugin Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/framework.html">Framework</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/view-plugin.html">View Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/style-guide.html">Style Guide</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>Community</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/plugins/">Plugin List</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/contributing.html">Contributing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/resource.html">Resource</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/faq.html">FAQ</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>MySQL is one of the most common and best RDBMS in terms of web applications. It is used in many large-scale websites such as Google and Facebook.</p><h2 id="egg-mysql">egg-mysql</h2><p>egg-mysql is provided to access both the MySQL databases and MySQL-based online database service.</p><h3 id="installation-and-configuration">Installation and Configuration</h3><p>Install <a href="https://github.com/eggjs/egg-mysql">egg-mysql</a></p><pre><code class="language-bash">$ npm i --save egg-mysql</code></pre><p>Enable Plugin:</p><pre><code class="language-js">// config/plugin.js
exports.mysql = {
  enable: true,
  package: &#x27;egg-mysql&#x27;,
};</code></pre><p>Configure database information in <code>config/config.${env}.js</code></p><h4 id="single-data-source">Single Data Source</h4><p>Configuration to accesss single MySQL instance as shown below:</p><pre><code class="language-js">// config/config.${env}.js
exports.mysql = {
  // database configuration
  client: {
    host: &#x27;mysql.com&#x27;,
    port: &#x27;3306&#x27;,
    user: &#x27;test_user&#x27;,
    password: &#x27;test_password&#x27;,
    database: &#x27;test&#x27;,
  },
  // load into app, default true
  app: true,
  // load into agent, default false
  agent: false,
};</code></pre><p>Use:</p><pre><code class="language-js">await app.mysql.query(sql, values); // single instance can be accessed through app.mysql</code></pre><h4 id="multiple-data-sources">Multiple Data Sources</h4><p>Configuration to accesss multiple MySQL instances as below:</p><pre><code class="language-js">exports.mysql = {
  clients: {
    // clientId, obtain the client instances using the app.mysql.get(&#x27;clientId&#x27;)
    db1: {
      host: &#x27;mysql.com&#x27;,
      port: &#x27;3306&#x27;,
      user: &#x27;test_user&#x27;,
      password: &#x27;test_password&#x27;,
      database: &#x27;test&#x27;,
    },
    db2: {
      host: &#x27;mysql2.com&#x27;,
      port: &#x27;3307&#x27;,
      user: &#x27;test_user&#x27;,
      password: &#x27;test_password&#x27;,
      database: &#x27;test&#x27;,
    },
    // ...
  },
  //default configuration of all databases
  default: {

  },

  // load into app, default true
  app: true,
  // load into agent, default false
  agent: false,
};</code></pre><p>Use:</p><pre><code class="language-js">const client1 = app.mysql.get(&#x27;db1&#x27;);
await client1.query(sql, values);

const client2 = app.mysql.get(&#x27;db2&#x27;);
await client2.query(sql, values);</code></pre><h4 id="dynamic-creation">Dynamic Creation</h4><p>Pre-declaration of configuration might not needed in the configuration file. Obtaining the actual parameters dynamically from the configuration center then initialize an instance instead.</p><pre><code class="language-js">// {app_root}/app.js
module.exports = app =&gt; {
  app.beforeStart(async () =&gt; {
    // obtain the MySQL configuration from the configuration center
    // { host: &#x27;mysql.com&#x27;, port: &#x27;3306&#x27;, user: &#x27;test_user&#x27;, password: &#x27;test_password&#x27;, database: &#x27;test&#x27; }
    const mysqlConfig = await app.configCenter.fetch(&#x27;mysql&#x27;);
    app.database = app.mysql.createInstance(mysqlConfig);
  });
};</code></pre><h2 id="service-layer">Service layer</h2><p>Connecting to MySQL is a data processing layer in the Web layer. So it is strongly recommended that keeping the code in the Service layer.</p><p>An example of connecting to MySQL as follows.</p><p>Details of Service layer, refer to <a href="../basics/service.md">service</a></p><pre><code class="language-js">// app/service/user.js
class UserService extends Service {
  async find(uid) {
   // assume we have the user id then trying to get the user details from database
    const user = await this.app.mysql.get(&#x27;users&#x27;, { id: 11 });
    return { user };
  }
}</code></pre><p>After that, obtaining the data from service layer using the controller</p><pre><code class="language-js">// app/controller/user.js
class UserController extends Controller {
  async info() {
    const ctx = this.ctx;
    const userId = ctx.params.id;
    const user = await ctx.service.user.find(userId);
    ctx.body = user;
  }
}</code></pre><h2 id="writing-crud">Writing CRUD</h2><p>Following statments default under <code>app/service</code> if not specifed</p><h3 id="create">Create</h3><p>INSERT method to perform the INSERT INTO query</p><pre><code class="language-js">// INSERT
const result = await this.app.mysql.insert(&#x27;posts&#x27;, { title: &#x27;Hello World&#x27; }); //insert a record title &#x27;Hello World&#x27; to &#x27;posts&#x27; table

=&gt; INSERT INTO `posts`(`title`) VALUES(&#x27;Hello World&#x27;);

console.log(result);
=&gt;
{
  fieldCount: 0,
  affectedRows: 1,
  insertId: 3710,
  serverStatus: 2,
  warningCount: 2,
  message: &#x27;&#x27;,
  protocol41: true,
  changedRows: 0
}

// check if insertion is success or failure
const insertSuccess = result.affectedRows === 1;</code></pre><h3 id="read">Read</h3><p>Use <code>get</code> or <code>select</code> to select one or multiple records. <code>select</code> method support query criteria and result customization</p><ul><li>get one record</li></ul><pre><code class="language-js">const post = await this.app.mysql.get(&#x27;posts&#x27;, { id: 12 });

=&gt; SELECT * FROM `posts` WHERE `id` = 12 LIMIT 0, 1;</code></pre><ul><li>query all from the table</li></ul><pre><code class="language-js">const results = await this.app.mysql.select(&#x27;posts&#x27;);

=&gt; SELECT * FROM `posts`;</code></pre><ul><li>query criteria and result customization</li></ul><pre><code class="language-js">const results = await this.app.mysql.select(&#x27;posts&#x27;, { // search posts table
  where: { status: &#x27;draft&#x27;, author: [&#x27;author1&#x27;, &#x27;author2&#x27;] }, // WHERE criteria
  columns: [&#x27;author&#x27;, &#x27;title&#x27;], // get the value of certain columns
  orders: [[&#x27;created_at&#x27;,&#x27;desc&#x27;], [&#x27;id&#x27;,&#x27;desc&#x27;]], // sort order
  limit: 10, // limit the return rows
  offset: 0, // data offset
});

=&gt; SELECT `author`, `title` FROM `posts`
  WHERE `status` = &#x27;draft&#x27; AND `author` IN(&#x27;author1&#x27;,&#x27;author2&#x27;)
  ORDER BY `created_at` DESC, `id` DESC LIMIT 0, 10;</code></pre><h3 id="update">Update</h3><p>UPDATE operation to update the records of databases</p><pre><code class="language-js">// modify data and search by primary key ID, and refresh
const row = {
  id: 123,
  name: &#x27;fengmk2&#x27;,
  otherField: &#x27;other field value&#x27;,    // any other fields u want to update
  modifiedAt: this.app.mysql.literals.now, // `now()` on db server
};
const result = await this.app.mysql.update(&#x27;posts&#x27;, row); // update records in &#x27;posts&#x27;

=&gt; UPDATE `posts` SET `name` = &#x27;fengmk2&#x27;, `modifiedAt` = NOW() WHERE id = 123 ;

// check if update is success or failure
const updateSuccess = result.affectedRows === 1;

// if primary key is your custom id,such as custom_id,you should config it in `where`
const row = {
  name: &#x27;fengmk2&#x27;,
  otherField: &#x27;other field value&#x27;,    // any other fields u want to update
  modifiedAt: this.app.mysql.literals.now, // `now()` on db server
};

const options = {
  where: {
    custom_id: 456
  }
};
const result = await this.app.mysql.update(&#x27;posts&#x27;, row, options); // update records in &#x27;posts&#x27;

=&gt; UPDATE `posts` SET `name` = &#x27;fengmk2&#x27;, `modifiedAt` = NOW() WHERE custom_id = 456 ;

// check if update is success or failure
const updateSuccess = result.affectedRows === 1;</code></pre><h3 id="delete">Delete</h3><p>DELETE operation to delete the records of databases</p><pre><code class="language-js">const result = await this.app.mysql.delete(&#x27;posts&#x27;, {
  author: &#x27;fengmk2&#x27;,
});

=&gt; DELETE FROM `posts` WHERE `author` = &#x27;fengmk2&#x27;;</code></pre><h2 id="implementation-of-sql-statement">Implementation of SQL statement</h2><p>Plugin supports splicing and execute SQL statment directly. It can use <code>query</code> to execute a valid SQL statement</p><p><strong>Note!! Strongly do not recommend developers splicing SQL statement, it is easier to cause SQL injection!!</strong></p><p>Use the <code>mysql.escape</code> method if you have to splice SQL statement</p><p>Refer to <a href="http://stackoverflow.com/questions/15778572/preventing-sql-injection-in-node-js">preventing-sql-injection-in-node-js</a></p><pre><code class="language-js">const postId = 1;
const results = await this.app.mysql.query(&#x27;update posts set hits = (hits + ?) where id = ?&#x27;, [1, postId]);

=&gt; update posts set hits = (hits + 1) where id = 1;</code></pre><h2 id="transaction">Transaction</h2><p>Transaction is mainly used to deal with large data of high complexity. For example, in a personnel management system, deleting a person which need to delete the basic information of the staff, but also need to delete the related information of staff, such as mailboxes, articles and so on. It is easier to use transaction to run a set of operations.
A transaction is a set of continuous database operations which performed as a single unit of work. Each individual operation within the group is successful and the transaction succeeds. If one part of the transaction fails, then the entire transaction fails.
In gerenal, transaction must be atomic, consistent, isolated and durable.</p><ul><li>Atomicity requires that each transaction be &quot;all or nothing&quot;: if one part of the transaction fails, then the entire transaction fails, and the database state is left unchanged.</li><li>The consistency property ensures that any transaction will bring the database from one valid state to another.</li><li>The isolation property ensures that the concurrent execution of transactions results in a system state that would be obtained if transactions were executed sequentially</li><li>The durability property ensures that once a transaction has been committed, it will remain so.</li></ul><p>Therefore, for a transaction, must be accompanied by beginTransaction, commit or rollback, respectively, beginning of the transaction, success and failure to roll back.</p><p>egg-mysql proviodes two types of transactions</p><h3 id="manual-control">Manual Control</h3><ul><li>adventage: <code>beginTransaction</code>, <code>commit</code> or <code>rollback</code> can be completely under control by developer</li><li>disadventage: more handwritten code, Forgot catching error or cleanup will lead to serious bug.</li></ul><pre><code class="language-js">const conn = await app.mysql.beginTransaction(); // initialize the transaction

try {
  await conn.insert(table, row1);  // first step
  await conn.update(table, row2);  // second step
  await conn.commit(); // commit the transaction
} catch (err) {
  // error, rollback
  await conn.rollback(); // rollback after catching the exception!!
  throw err;
}</code></pre><h3 id="automatic-control-transaction-with-scope">Automatic control: Transaction with scope</h3><ul><li>API：<code>beginTransactionScope(scope, ctx)</code><ul><li><code>scope</code>: A generatorFunction which will execute all sqls of this transaction.</li><li><code>ctx</code>: The context object of current request, it will ensures that even in the case of a nested transaction, there is only one active transaction in a request at the same time.</li></ul></li><li>adventage: easy to use, as if there is no transaction in your code.</li><li>disadvantage: all transation will be successful or failed, cannot control precisely</li></ul><pre><code class="language-js">const result = await app.mysql.beginTransactionScope(async conn =&gt; {
  // don&#x27;t commit or rollback by yourself
  await conn.insert(table, row1);
  await conn.update(table, row2);
  return { success: true };
}, ctx); // ctx is the context of current request, accessed by `this.ctx`  within in service file.
// if error throw on scope, will auto rollback</code></pre><h2 id="literal">Literal</h2><p> Use <code>Literal</code> if need to call literals or functions in MySQL</p><h3 id="inner-literal">Inner Literal</h3><ul><li><code>NOW()</code>：The database system time, obtained by <code>app.mysql.literals.now</code></li></ul><pre><code class="language-js">await this.app.mysql.insert(table, {
  create_time: this.app.mysql.literals.now,
});

=&gt; INSERT INTO `$table`(`create_time`) VALUES(NOW())</code></pre><h3 id="custom-literal">Custom literal</h3><p>The following demo showe how to call <code>CONCAT(s1, ...sn)</code> funtion in mysql to do string splicing.</p><pre><code class="language-js">const Literal = this.app.mysql.literals.Literal;
const first = &#x27;James&#x27;;
const last = &#x27;Bond&#x27;;
await this.app.mysql.insert(table, {
  id: 123,
  fullname: new Literal(`CONCAT(&quot;${first}&quot;, &quot;${last}&quot;`),
});

=&gt; INSERT INTO `$table`(`id`, `fullname`) VALUES(123, CONCAT(&quot;James&quot;, &quot;Bond&quot;))</code></pre></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#egg-mysql">egg-mysql</a><ul><li><a href="#installation-and-configuration">Installation and Configuration</a><ul><li><a href="#single-data-source">Single Data Source</a></li><li><a href="#multiple-data-sources">Multiple Data Sources</a></li><li><a href="#dynamic-creation">Dynamic Creation</a></li></ul></li></ul></li><li><a href="#service-layer">Service layer</a></li><li><a href="#writing-crud">Writing CRUD</a><ul><li><a href="#create">Create</a></li><li><a href="#read">Read</a></li><li><a href="#update">Update</a></li><li><a href="#delete">Delete</a></li></ul></li><li><a href="#implementation-of-sql-statement">Implementation of SQL statement</a></li><li><a href="#transaction">Transaction</a><ul><li><a href="#manual-control">Manual Control</a></li><li><a href="#automatic-control-transaction-with-scope">Automatic control: Transaction with scope</a></li></ul></li><li><a href="#literal">Literal</a><ul><li><a href="#inner-literal">Inner Literal</a></li><li><a href="#custom-literal">Custom literal</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"en","props":{"toc":"-%20%5Begg-mysql%5D(%23egg-mysql)%0A%20%20*%20%5BInstallation%20and%20Configuration%5D(%23installation-and-configuration)%0A%20%20%20%20%2B%20%5BSingle%20Data%20Source%5D(%23single-data-source)%0A%20%20%20%20%2B%20%5BMultiple%20Data%20Sources%5D(%23multiple-data-sources)%0A%20%20%20%20%2B%20%5BDynamic%20Creation%5D(%23dynamic-creation)%0A-%20%5BService%20layer%5D(%23service-layer)%0A-%20%5BWriting%20CRUD%5D(%23writing-crud)%0A%20%20*%20%5BCreate%5D(%23create)%0A%20%20*%20%5BRead%5D(%23read)%0A%20%20*%20%5BUpdate%5D(%23update)%0A%20%20*%20%5BDelete%5D(%23delete)%0A-%20%5BImplementation%20of%20SQL%20statement%5D(%23implementation-of-sql-statement)%0A-%20%5BTransaction%5D(%23transaction)%0A%20%20*%20%5BManual%20Control%5D(%23manual-control)%0A%20%20*%20%5BAutomatic%20control%3A%20Transaction%20with%20scope%5D(%23automatic-control-transaction-with-scope)%0A-%20%5BLiteral%5D(%23literal)%0A%20%20*%20%5BInner%20Literal%5D(%23inner-literal)%0A%20%20*%20%5BCustom%20literal%5D(%23custom-literal)","meta":{"info":{"title":"MySQL"}},"content":"%0A%0A%0AMySQL%20is%20one%20of%20the%20most%20common%20and%20best%20RDBMS%20in%20terms%20of%20web%20applications.%20It%20is%20used%20in%20many%20large-scale%20websites%20such%20as%20Google%20and%20Facebook.%0A%0A%23%23%20egg-mysql%0A%0Aegg-mysql%20is%20provided%20to%20access%20both%20the%20MySQL%20databases%20and%20MySQL-based%20online%20database%20service.%0A%0A%23%23%23%20Installation%20and%20Configuration%0A%0AInstall%20%5Begg-mysql%5D%0A%0A%60%60%60bash%0A%24%20npm%20i%20--save%20egg-mysql%0A%60%60%60%0A%0AEnable%20Plugin%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fplugin.js%0Aexports.mysql%20%3D%20%7B%0A%20%20enable%3A%20true%2C%0A%20%20package%3A%20'egg-mysql'%2C%0A%7D%3B%0A%60%60%60%0AConfigure%20database%20information%20in%20%60config%2Fconfig.%24%7Benv%7D.js%60%0A%0A%23%23%23%23%20Single%20Data%20Source%0A%0AConfiguration%20to%20accesss%20single%20MySQL%20instance%20as%20shown%20below%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Aexports.mysql%20%3D%20%7B%0A%20%20%2F%2F%20database%20configuration%0A%20%20client%3A%20%7B%0A%20%20%20%20host%3A%20'mysql.com'%2C%0A%20%20%20%20port%3A%20'3306'%2C%0A%20%20%20%20user%3A%20'test_user'%2C%0A%20%20%20%20password%3A%20'test_password'%2C%0A%20%20%20%20database%3A%20'test'%2C%0A%20%20%7D%2C%0A%20%20%2F%2F%20load%20into%20app%2C%20default%20true%0A%20%20app%3A%20true%2C%0A%20%20%2F%2F%20load%20into%20agent%2C%20default%20false%0A%20%20agent%3A%20false%2C%0A%7D%3B%0A%60%60%60%0A%0AUse%3A%0A%0A%60%60%60js%0Aawait%20app.mysql.query(sql%2C%20values)%3B%20%2F%2F%20single%20instance%20can%20be%20accessed%20through%20app.mysql%0A%60%60%60%0A%0A%23%23%23%23%20Multiple%20Data%20Sources%0A%0AConfiguration%20to%20accesss%20multiple%20MySQL%20instances%20as%20below%3A%0A%0A%60%60%60js%0Aexports.mysql%20%3D%20%7B%0A%20%20clients%3A%20%7B%0A%20%20%20%20%2F%2F%20clientId%2C%20obtain%20the%20client%20instances%20using%20the%20app.mysql.get('clientId')%0A%20%20%20%20db1%3A%20%7B%0A%20%20%20%20%20%20host%3A%20'mysql.com'%2C%0A%20%20%20%20%20%20port%3A%20'3306'%2C%0A%20%20%20%20%20%20user%3A%20'test_user'%2C%0A%20%20%20%20%20%20password%3A%20'test_password'%2C%0A%20%20%20%20%20%20database%3A%20'test'%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20db2%3A%20%7B%0A%20%20%20%20%20%20host%3A%20'mysql2.com'%2C%0A%20%20%20%20%20%20port%3A%20'3307'%2C%0A%20%20%20%20%20%20user%3A%20'test_user'%2C%0A%20%20%20%20%20%20password%3A%20'test_password'%2C%0A%20%20%20%20%20%20database%3A%20'test'%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20%2F%2F%20...%0A%20%20%7D%2C%0A%20%20%2F%2Fdefault%20configuration%20of%20all%20databases%0A%20%20default%3A%20%7B%0A%0A%20%20%7D%2C%0A%0A%20%20%2F%2F%20load%20into%20app%2C%20default%20true%0A%20%20app%3A%20true%2C%0A%20%20%2F%2F%20load%20into%20agent%2C%20default%20false%0A%20%20agent%3A%20false%2C%0A%7D%3B%0A%60%60%60%0A%0AUse%3A%0A%0A%60%60%60js%0Aconst%20client1%20%3D%20app.mysql.get('db1')%3B%0Aawait%20client1.query(sql%2C%20values)%3B%0A%0Aconst%20client2%20%3D%20app.mysql.get('db2')%3B%0Aawait%20client2.query(sql%2C%20values)%3B%0A%60%60%60%0A%0A%23%23%23%23%20Dynamic%20Creation%0A%0APre-declaration%20of%20configuration%20might%20not%20needed%20in%20the%20configuration%20file.%20Obtaining%20the%20actual%20parameters%20dynamically%20from%20the%20configuration%20center%20then%20initialize%20an%20instance%20instead.%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%2Fapp.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20obtain%20the%20MySQL%20configuration%20from%20the%20configuration%20center%0A%20%20%20%20%2F%2F%20%7B%20host%3A%20'mysql.com'%2C%20port%3A%20'3306'%2C%20user%3A%20'test_user'%2C%20password%3A%20'test_password'%2C%20database%3A%20'test'%20%7D%0A%20%20%20%20const%20mysqlConfig%20%3D%20await%20app.configCenter.fetch('mysql')%3B%0A%20%20%20%20app.database%20%3D%20app.mysql.createInstance(mysqlConfig)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20Service%20layer%0A%0AConnecting%20to%20MySQL%20is%20a%20data%20processing%20layer%20in%20the%20Web%20layer.%20So%20it%20is%20strongly%20recommended%20that%20keeping%20the%20code%20in%20the%20Service%20layer.%0A%0AAn%20example%20of%20connecting%20to%20MySQL%20as%20follows.%0A%0ADetails%20of%20Service%20layer%2C%20refer%20to%20%5Bservice%5D(..%2Fbasics%2Fservice.md)%0A%0A%60%60%60js%0A%2F%2F%20app%2Fservice%2Fuser.js%0Aclass%20UserService%20extends%20Service%20%7B%0A%20%20async%20find(uid)%20%7B%0A%20%20%20%2F%2F%20assume%20we%20have%20the%20user%20id%20then%20trying%20to%20get%20the%20user%20details%20from%20database%0A%20%20%20%20const%20user%20%3D%20await%20this.app.mysql.get('users'%2C%20%7B%20id%3A%2011%20%7D)%3B%0A%20%20%20%20return%20%7B%20user%20%7D%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0AAfter%20that%2C%20obtaining%20the%20data%20from%20service%20layer%20using%20the%20controller%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fuser.js%0Aclass%20UserController%20extends%20Controller%20%7B%0A%20%20async%20info()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20const%20userId%20%3D%20ctx.params.id%3B%0A%20%20%20%20const%20user%20%3D%20await%20ctx.service.user.find(userId)%3B%0A%20%20%20%20ctx.body%20%3D%20user%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%20Writing%20CRUD%0A%0AFollowing%20statments%20default%20under%20%60app%2Fservice%60%20if%20not%20specifed%0A%0A%23%23%23%20Create%0A%0AINSERT%20method%20to%20perform%20the%20INSERT%20INTO%20query%0A%0A%60%60%60js%0A%2F%2F%20INSERT%0Aconst%20result%20%3D%20await%20this.app.mysql.insert('posts'%2C%20%7B%20title%3A%20'Hello%20World'%20%7D)%3B%20%2F%2Finsert%20a%20record%20title%20'Hello%20World'%20to%20'posts'%20table%0A%0A%3D%3E%20INSERT%20INTO%20%60posts%60(%60title%60)%20VALUES('Hello%20World')%3B%0A%0Aconsole.log(result)%3B%0A%3D%3E%0A%7B%0A%20%20fieldCount%3A%200%2C%0A%20%20affectedRows%3A%201%2C%0A%20%20insertId%3A%203710%2C%0A%20%20serverStatus%3A%202%2C%0A%20%20warningCount%3A%202%2C%0A%20%20message%3A%20''%2C%0A%20%20protocol41%3A%20true%2C%0A%20%20changedRows%3A%200%0A%7D%0A%0A%2F%2F%20check%20if%20insertion%20is%20success%20or%20failure%0Aconst%20insertSuccess%20%3D%20result.affectedRows%20%3D%3D%3D%201%3B%0A%60%60%60%0A%0A%23%23%23%20Read%0A%0AUse%20%60get%60%20or%20%60select%60%20to%20select%20one%20or%20multiple%20records.%20%60select%60%20method%20support%20query%20criteria%20and%20result%20customization%0A%0A-%20get%20one%20record%0A%0A%60%60%60js%0Aconst%20post%20%3D%20await%20this.app.mysql.get('posts'%2C%20%7B%20id%3A%2012%20%7D)%3B%0A%0A%3D%3E%20SELECT%20*%20FROM%20%60posts%60%20WHERE%20%60id%60%20%3D%2012%20LIMIT%200%2C%201%3B%0A%60%60%60%0A%0A-%20query%20all%20from%20the%20table%0A%0A%60%60%60js%0Aconst%20results%20%3D%20await%20this.app.mysql.select('posts')%3B%0A%0A%3D%3E%20SELECT%20*%20FROM%20%60posts%60%3B%0A%60%60%60%0A%0A-%20query%20criteria%20and%20result%20customization%0A%0A%60%60%60js%0Aconst%20results%20%3D%20await%20this.app.mysql.select('posts'%2C%20%7B%20%2F%2F%20search%20posts%20table%0A%20%20where%3A%20%7B%20status%3A%20'draft'%2C%20author%3A%20%5B'author1'%2C%20'author2'%5D%20%7D%2C%20%2F%2F%20WHERE%20criteria%0A%20%20columns%3A%20%5B'author'%2C%20'title'%5D%2C%20%2F%2F%20get%20the%20value%20of%20certain%20columns%0A%20%20orders%3A%20%5B%5B'created_at'%2C'desc'%5D%2C%20%5B'id'%2C'desc'%5D%5D%2C%20%2F%2F%20sort%20order%0A%20%20limit%3A%2010%2C%20%2F%2F%20limit%20the%20return%20rows%0A%20%20offset%3A%200%2C%20%2F%2F%20data%20offset%0A%7D)%3B%0A%0A%3D%3E%20SELECT%20%60author%60%2C%20%60title%60%20FROM%20%60posts%60%0A%20%20WHERE%20%60status%60%20%3D%20'draft'%20AND%20%60author%60%20IN('author1'%2C'author2')%0A%20%20ORDER%20BY%20%60created_at%60%20DESC%2C%20%60id%60%20DESC%20LIMIT%200%2C%2010%3B%0A%60%60%60%0A%0A%0A%23%23%23%20Update%0A%0AUPDATE%20operation%20to%20update%20the%20records%20of%20databases%0A%0A%60%60%60js%0A%2F%2F%20modify%20data%20and%20search%20by%20primary%20key%20ID%2C%20and%20refresh%0Aconst%20row%20%3D%20%7B%0A%20%20id%3A%20123%2C%0A%20%20name%3A%20'fengmk2'%2C%0A%20%20otherField%3A%20'other%20field%20value'%2C%20%20%20%20%2F%2F%20any%20other%20fields%20u%20want%20to%20update%0A%20%20modifiedAt%3A%20this.app.mysql.literals.now%2C%20%2F%2F%20%60now()%60%20on%20db%20server%0A%7D%3B%0Aconst%20result%20%3D%20await%20this.app.mysql.update('posts'%2C%20row)%3B%20%2F%2F%20update%20records%20in%20'posts'%0A%0A%3D%3E%20UPDATE%20%60posts%60%20SET%20%60name%60%20%3D%20'fengmk2'%2C%20%60modifiedAt%60%20%3D%20NOW()%20WHERE%20id%20%3D%20123%20%3B%0A%0A%2F%2F%20check%20if%20update%20is%20success%20or%20failure%0Aconst%20updateSuccess%20%3D%20result.affectedRows%20%3D%3D%3D%201%3B%0A%0A%2F%2F%20if%20primary%20key%20is%20your%20custom%20id%2Csuch%20as%20custom_id%2Cyou%20should%20config%20it%20in%20%60where%60%0Aconst%20row%20%3D%20%7B%0A%20%20name%3A%20'fengmk2'%2C%0A%20%20otherField%3A%20'other%20field%20value'%2C%20%20%20%20%2F%2F%20any%20other%20fields%20u%20want%20to%20update%0A%20%20modifiedAt%3A%20this.app.mysql.literals.now%2C%20%2F%2F%20%60now()%60%20on%20db%20server%0A%7D%3B%0A%0Aconst%20options%20%3D%20%7B%0A%20%20where%3A%20%7B%0A%20%20%20%20custom_id%3A%20456%0A%20%20%7D%0A%7D%3B%0Aconst%20result%20%3D%20await%20this.app.mysql.update('posts'%2C%20row%2C%20options)%3B%20%2F%2F%20update%20records%20in%20'posts'%0A%0A%3D%3E%20UPDATE%20%60posts%60%20SET%20%60name%60%20%3D%20'fengmk2'%2C%20%60modifiedAt%60%20%3D%20NOW()%20WHERE%20custom_id%20%3D%20456%20%3B%0A%0A%2F%2F%20check%20if%20update%20is%20success%20or%20failure%0Aconst%20updateSuccess%20%3D%20result.affectedRows%20%3D%3D%3D%201%3B%0A%60%60%60%0A%0A%23%23%23%20Delete%0A%0ADELETE%20operation%20to%20delete%20the%20records%20of%20databases%0A%0A%60%60%60js%0Aconst%20result%20%3D%20await%20this.app.mysql.delete('posts'%2C%20%7B%0A%20%20author%3A%20'fengmk2'%2C%0A%7D)%3B%0A%0A%3D%3E%20DELETE%20FROM%20%60posts%60%20WHERE%20%60author%60%20%3D%20'fengmk2'%3B%0A%60%60%60%0A%0A%23%23%20Implementation%20of%20SQL%20statement%0A%0APlugin%20supports%20splicing%20and%20execute%20SQL%20statment%20directly.%20It%20can%20use%20%60query%60%20to%20execute%20a%20valid%20SQL%20statement%0A%0A**Note!!%20Strongly%20do%20not%20recommend%20developers%20splicing%20SQL%20statement%2C%20it%20is%20easier%20to%20cause%20SQL%20injection!!**%0A%0AUse%20the%20%60mysql.escape%60%20method%20if%20you%20have%20to%20splice%20SQL%20statement%0A%0ARefer%20to%20%5Bpreventing-sql-injection-in-node-js%5D(http%3A%2F%2Fstackoverflow.com%2Fquestions%2F15778572%2Fpreventing-sql-injection-in-node-js)%0A%0A%60%60%60js%0Aconst%20postId%20%3D%201%3B%0Aconst%20results%20%3D%20await%20this.app.mysql.query('update%20posts%20set%20hits%20%3D%20(hits%20%2B%20%3F)%20where%20id%20%3D%20%3F'%2C%20%5B1%2C%20postId%5D)%3B%0A%0A%3D%3E%20update%20posts%20set%20hits%20%3D%20(hits%20%2B%201)%20where%20id%20%3D%201%3B%0A%60%60%60%0A%0A%23%23%20Transaction%0A%0ATransaction%20is%20mainly%20used%20to%20deal%20with%20large%20data%20of%20high%20complexity.%20For%20example%2C%20in%20a%20personnel%20management%20system%2C%20deleting%20a%20person%20which%20need%20to%20delete%20the%20basic%20information%20of%20the%20staff%2C%20but%20also%20need%20to%20delete%20the%20related%20information%20of%20staff%2C%20such%20as%20mailboxes%2C%20articles%20and%20so%20on.%20It%20is%20easier%20to%20use%20transaction%20to%20run%20a%20set%20of%20operations.%0AA%20transaction%20is%20a%20set%20of%20continuous%20database%20operations%20which%20performed%20as%20a%20single%20unit%20of%20work.%20Each%20individual%20operation%20within%20the%20group%20is%20successful%20and%20the%20transaction%20succeeds.%20If%20one%20part%20of%20the%20transaction%20fails%2C%20then%20the%20entire%20transaction%20fails.%0AIn%20gerenal%2C%20transaction%20must%20be%20atomic%2C%20consistent%2C%20isolated%20and%20durable.%0A-%20Atomicity%20requires%20that%20each%20transaction%20be%20%22all%20or%20nothing%22%3A%20if%20one%20part%20of%20the%20transaction%20fails%2C%20then%20the%20entire%20transaction%20fails%2C%20and%20the%20database%20state%20is%20left%20unchanged.%0A-%20The%20consistency%20property%20ensures%20that%20any%20transaction%20will%20bring%20the%20database%20from%20one%20valid%20state%20to%20another.%0A-%20The%20isolation%20property%20ensures%20that%20the%20concurrent%20execution%20of%20transactions%20results%20in%20a%20system%20state%20that%20would%20be%20obtained%20if%20transactions%20were%20executed%20sequentially%0A-%20The%20durability%20property%20ensures%20that%20once%20a%20transaction%20has%20been%20committed%2C%20it%20will%20remain%20so.%0A%0ATherefore%2C%20for%20a%20transaction%2C%20must%20be%20accompanied%20by%20beginTransaction%2C%20commit%20or%20rollback%2C%20respectively%2C%20beginning%20of%20the%20transaction%2C%20success%20and%20failure%20to%20roll%20back.%0A%0Aegg-mysql%20proviodes%20two%20types%20of%20transactions%0A%0A%23%23%23%20Manual%20Control%0A%0A-%20adventage%3A%20%60beginTransaction%60%2C%20%60commit%60%20or%20%60rollback%60%20can%20be%20completely%20under%20control%20by%20developer%0A-%20disadventage%3A%20more%20handwritten%20code%2C%20Forgot%20catching%20error%20or%20cleanup%20will%20lead%20to%20serious%20bug.%0A%0A%60%60%60js%0Aconst%20conn%20%3D%20await%20app.mysql.beginTransaction()%3B%20%2F%2F%20initialize%20the%20transaction%0A%0Atry%20%7B%0A%20%20await%20conn.insert(table%2C%20row1)%3B%20%20%2F%2F%20first%20step%0A%20%20await%20conn.update(table%2C%20row2)%3B%20%20%2F%2F%20second%20step%0A%20%20await%20conn.commit()%3B%20%2F%2F%20commit%20the%20transaction%0A%7D%20catch%20(err)%20%7B%0A%20%20%2F%2F%20error%2C%20rollback%0A%20%20await%20conn.rollback()%3B%20%2F%2F%20rollback%20after%20catching%20the%20exception!!%0A%20%20throw%20err%3B%0A%7D%0A%60%60%60%0A%0A%23%23%23%20Automatic%20control%3A%20Transaction%20with%20scope%0A%0A-%20API%EF%BC%9A%60beginTransactionScope(scope%2C%20ctx)%60%0A%20%20-%20%60scope%60%3A%20A%20generatorFunction%20which%20will%20execute%20all%20sqls%20of%20this%20transaction.%0A%20%20-%20%60ctx%60%3A%20The%20context%20object%20of%20current%20request%2C%20it%20will%20ensures%20that%20even%20in%20the%20case%20of%20a%20nested%20transaction%2C%20there%20is%20only%20one%20active%20transaction%20in%20a%20request%20at%20the%20same%20time.%0A-%20adventage%3A%20easy%20to%20use%2C%20as%20if%20there%20is%20no%20transaction%20in%20your%20code.%0A-%20disadvantage%3A%20all%20transation%20will%20be%20successful%20or%20failed%2C%20cannot%20control%20precisely%0A%60%60%60js%0Aconst%20result%20%3D%20await%20app.mysql.beginTransactionScope(async%20conn%20%3D%3E%20%7B%0A%20%20%2F%2F%20don't%20commit%20or%20rollback%20by%20yourself%0A%20%20await%20conn.insert(table%2C%20row1)%3B%0A%20%20await%20conn.update(table%2C%20row2)%3B%0A%20%20return%20%7B%20success%3A%20true%20%7D%3B%0A%7D%2C%20ctx)%3B%20%2F%2F%20ctx%20is%20the%20context%20of%20current%20request%2C%20accessed%20by%20%60this.ctx%60%20%20within%20in%20service%20file.%0A%2F%2F%20if%20error%20throw%20on%20scope%2C%20will%20auto%20rollback%0A%60%60%60%0A%0A%23%23%20Literal%0A%0A%20Use%20%60Literal%60%20if%20need%20to%20call%20literals%20or%20functions%20in%20MySQL%0A%0A%23%23%23%20Inner%20Literal%0A%0A-%20%60NOW()%60%EF%BC%9AThe%20database%20system%20time%2C%20obtained%20by%20%60app.mysql.literals.now%60%0A%0A%60%60%60js%0Aawait%20this.app.mysql.insert(table%2C%20%7B%0A%20%20create_time%3A%20this.app.mysql.literals.now%2C%0A%7D)%3B%0A%0A%3D%3E%20INSERT%20INTO%20%60%24table%60(%60create_time%60)%20VALUES(NOW())%0A%60%60%60%0A%0A%23%23%23%20Custom%20literal%0A%0AThe%20following%20demo%20showe%20how%20to%20call%20%60CONCAT(s1%2C%20...sn)%60%20funtion%20in%20mysql%20to%20do%20string%20splicing.%0A%0A%60%60%60js%0Aconst%20Literal%20%3D%20this.app.mysql.literals.Literal%3B%0Aconst%20first%20%3D%20'James'%3B%0Aconst%20last%20%3D%20'Bond'%3B%0Aawait%20this.app.mysql.insert(table%2C%20%7B%0A%20%20id%3A%20123%2C%0A%20%20fullname%3A%20new%20Literal(%60CONCAT(%22%24%7Bfirst%7D%22%2C%20%22%24%7Blast%7D%22%60)%2C%0A%7D)%3B%0A%0A%3D%3E%20INSERT%20INTO%20%60%24table%60(%60id%60%2C%20%60fullname%60)%20VALUES(123%2C%20CONCAT(%22James%22%2C%20%22Bond%22))%0A%60%60%60%0A%0A%5Begg-mysql%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mysql%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>