<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Egg.js</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/en/intro/">Guide</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/en/tutorials/index.html">Tutorials</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">Plugins</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">Release</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>切换语言</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>Guide</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/index.html">What is Egg?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/quickstart.html">Quick Start</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/progressive.html">Progressive</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/migration.html">Migration to 2.x</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>Basis Function</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/structure.html">Directory Structure</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/objects.html">Built-in Objects</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/env.html">Environment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/config.html">Configuration</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/middleware.html">Middleware</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/plugin.html">Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/schedule.html">Schedule</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/extend.html">Extend</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/app-start.html">Custom Init</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>Core</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/development.html">Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/unittest.html">Unit Testing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/deployment.html">Deployment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/logger.html">Logger</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/view.html">View</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/error-handling.html">Error Handling</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/security.html">Security</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/i18n.html">i18n</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>Tutorials</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/passport.html">Passport</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/assets.html">Assets</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>Advanced</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/plugin.html">Plugin Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/framework.html">Framework</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/view-plugin.html">View Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/style-guide.html">Style Guide</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>Community</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/plugins/">Plugin List</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/contributing.html">Contributing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/resource.html">Resource</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/faq.html">FAQ</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><h2 id="title-view-plugin-development">Title: View Plugin Development</h2><p>In most cases, we need to read the data, render the template and then present it to the user. The framework does not force the use of a template engine, allowing developers to select the <a href="../core/view.md">template</a> themselves. For details, see <a href="../core/view.md">Template Rendering</a>.</p><p>This article describes the framework&#x27;s specification constraints on the View plugin, and we can use this to encapsulate the corresponding template engine plugin. The following takes <a href="https://github.com/eggjs/egg-view-ejs">egg-view-ejs</a> as an example</p><h2 id="plugin-directory-structure">Plugin directory structure</h2><pre><code class="language-bash">egg-view-ejs
├── config
│ ├── config.default.js
│ └── config.local.js
├── lib
│ └── view.js
├── app.js
├── test
├── History.md
├── README.md
└── package.json</code></pre><h2 id="plugin-naming-convention">Plugin naming convention</h2><ul><li>Follow the <a href="./plugin.md">plugin development specification</a></li><li>According to the convention, the names of plugins start with <code>egg-view-</code></li><li><code>package.json</code> is configured as follows. Plugins are named after the template engine, such as ejs</li></ul><pre><code class="language-json">{
  &quot;name&quot;: &quot;egg-view-ejs&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;ejs&quot;
  },
  &quot;keywords&quot;: [&quot;egg&quot;, &quot;egg-plugin&quot;, &quot;egg-view&quot;, &quot;ejs&quot;]
}</code></pre><ul><li>The configuration item is also named after the template engine</li></ul><pre><code class="language-js">// config/config.default.js
module.exports = {
  ejs: {}
};</code></pre><h2 id="view-base-class">View base class</h2><p>The next step is to provide a View base class that will be instantiated on each request.</p><p>The base class of the View needs to provide <code>render</code> and <code>renderString</code> methods and supports generator and async functions (it can also be a function that returns a Promise). The <code>render</code> method is used to render files, and the <code>renderString</code> method is used to render template strings.</p><p>The following is a simplified code that can be directly <a href="https://github.com/eggjs/egg-view-ejs/blob/master/lib/view.js">view source</a></p><pre><code class="language-js">const ejs = require(&#x27;ejs&#x27;);

Mmdule.exports = class EjsView {
  render(filename, locals) {
    return new Promise((resolve, reject) =&gt; {
      // Asynchronous API call
      ejs.renderFile(filename, locals, (err, result) =&gt; {
        if (err) {
          reject(err);
        } else {
          resolve(result);
        }
      });
    });
  }

  renderString(tpl, locals) {
    try {
      // Synchronous API call
      return Promise.resolve(ejs.render(tpl, locals));
    } catch (err) {
      return Promise.reject(err);
    }
  }
};</code></pre><h3 id="parameters">Parameters</h3><p>The three parameters of the <code>render</code> method are</p><ul><li>filename: is the path to the complete file. The framework determines if the file exists when it looks for the file. It does not need to be processed here.</li><li>locals: The data needed for rendering. The data comes from <code>app.locals</code>, <code>ctx.locals</code> and calls <code>render</code> methods. The framework also has built in <code>ctx</code>, <code>request</code>, <code>ctx.helper</code> objects.</li><li>viewOptions: The incoming configuration of the user, which can override the default configuration of the template engine. This can be considered based on the characteristics of the template engine. For example, the cache is enabled by default but a page does not need to be cached.</li></ul><p>The three parameters of the <code>renderString</code> method</p><ul><li>tpl: template string, not file path</li><li>locals: same with <code>render</code></li><li>viewOptions: same with <code>render</code></li></ul><h2 id="plugin-configuration">Plugin configuration</h2><p>According to the naming conventions mentioned above, the configuration name is generally the name of the template engine, such as ejs</p><p>The configuration of the plugin mainly comes from the configuration of the template engine, and the configuration items can be defined according to the specific conditions, such as the <a href="https://github.com/mde/ejs#options">configuration of ejs</a></p><pre><code class="language-js">// config/config.default.js
module.exports = {
  ejs: {
    cache: true
  }
};</code></pre><h3 id="helper">Helper</h3><p>The framework provides <code>ctx.helper</code> for developer use, but in some cases we want to override the helper method and only take effect when the template is rendered.</p><p>In template rendering, we often need to output a user-supplied html fragment, in which case, we often use the <code>helper.shtml</code> provided by the <code>egg-security</code> plugin.</p><pre><code class="language-html">&lt;div&gt;{{ helper.shtml(data.content) | safe }}&lt;/div&gt;</code></pre><p>However, as shown in the above code, we need to use <code>| safe</code> to tell the template engine that the html is safe and it doesn&#x27;t need to run <code>escape</code> again.</p><p>This is more cumbersome to use and easy to forget, so we can package it:</p><p>First provide a helper subclass:</p><pre><code class="language-js">// {plugin_root}/lib/helper.js
module.exports = app =&gt; {
  return class ViewHelper extends app.Helper {
    // safe is injected by [egg-view-nunjucks] and will not be escaped during rendering.
    // Otherwise, the template call shtml will be escaped
    shtml(str) {
      return this.safe(super.shtml(str));
    }
  };
};</code></pre><p>Use a custom helper when rendering</p><pre><code class="language-js">// {plugin_root}/lib/view.js
const ViewHelper = require(&#x27;./helper&#x27;);

module.exports = class MyCustomView {
  render(filename, locals) {
    locals.helper = new ViewHelper(this.ctx); // call Nunjucks render
  }
};</code></pre><p>You can <a href="https://github.com/eggjs/egg-view-nunjucks/blob/2ee5ee992cfd95bc0bb5b822fbd72a6778edb118/lib/view.js#L11">view</a> the specific code here</p><h3 id="security-related">Security Related</h3><p>Templates and security are related and <a href="https://github.com/eggjs/egg-security">egg-security</a> also provides some methods for the template. The template engine can be used according to requirements.</p><p>First declare a dependency on <a href="https://github.com/eggjs/egg-security">egg-security</a></p><pre><code class="language-json">{
  &quot;name&quot;: &quot;egg-view-nunjucks&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;nunjucks&quot;,
    &quot;dep&quot;: [&quot;security&quot;]
  }
}</code></pre><p>The framework provides <a href="../core/security.md#appinjectcsrfstr">app.injectCsrf</a> and <a href="../core/security.md#appinjectnonncestr">app.injectNonce</a>, for more information on <a href="../core/security.md">security section</a>.</p><h3 id="unit-tests">Unit tests</h3><p>As a high-quality plugin, perfect unit testing is indispensable, and we also provide a lot of auxiliary tools to make it painless for plugin developers to write tests, see <a href="../core/unittest.md">unit testing</a> and <a href="./plugin.md">plugin</a> docs.</p></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#title-view-plugin-development">Title: View Plugin Development</a></li><li><a href="#plugin-directory-structure">Plugin directory structure</a></li><li><a href="#plugin-naming-convention">Plugin naming convention</a></li><li><a href="#view-base-class">View base class</a><ul><li><a href="#parameters">Parameters</a></li></ul></li><li><a href="#plugin-configuration">Plugin configuration</a><ul><li><a href="#helper">Helper</a></li><li><a href="#security-related">Security Related</a></li><li><a href="#unit-tests">Unit tests</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"en","props":{"toc":"-%20%5BTitle%3A%20View%20Plugin%20Development%5D(%23title-view-plugin-development)%0A-%20%5BPlugin%20directory%20structure%5D(%23plugin-directory-structure)%0A-%20%5BPlugin%20naming%20convention%5D(%23plugin-naming-convention)%0A-%20%5BView%20base%20class%5D(%23view-base-class)%0A%20%20*%20%5BParameters%5D(%23parameters)%0A-%20%5BPlugin%20configuration%5D(%23plugin-configuration)%0A%20%20*%20%5BHelper%5D(%23helper)%0A%20%20*%20%5BSecurity%20Related%5D(%23security-related)%0A%20%20*%20%5BUnit%20tests%5D(%23unit-tests)","meta":{"info":{"title":"Egg.js","subtitle":"Born to build better enterprise frameworks and apps","description":"Born to build better enterprise frameworks and apps"}},"content":"%23%23%20Title%3A%20View%20Plugin%20Development%0A%0AIn%20most%20cases%2C%20we%20need%20to%20read%20the%20data%2C%20render%20the%20template%20and%20then%20present%20it%20to%20the%20user.%20The%20framework%20does%20not%20force%20the%20use%20of%20a%20template%20engine%2C%20allowing%20developers%20to%20select%20the%20%5Btemplate%5D(..%2Fcore%2Fview.md)%20themselves.%20For%20details%2C%20see%20%5BTemplate%20Rendering%5D(..%2Fcore%2Fview.md).%0A%0AThis%20article%20describes%20the%20framework's%20specification%20constraints%20on%20the%20View%20plugin%2C%20and%20we%20can%20use%20this%20to%20encapsulate%20the%20corresponding%20template%20engine%20plugin.%20The%20following%20takes%20%5Begg-view-ejs%5D%20as%20an%20example%0A%0A%23%23%20Plugin%20directory%20structure%0A%0A%60%60%60bash%0Aegg-view-ejs%0A%E2%94%9C%E2%94%80%E2%94%80%20config%0A%E2%94%82%20%E2%94%9C%E2%94%80%E2%94%80%20config.default.js%0A%E2%94%82%20%E2%94%94%E2%94%80%E2%94%80%20config.local.js%0A%E2%94%9C%E2%94%80%E2%94%80%20lib%0A%E2%94%82%20%E2%94%94%E2%94%80%E2%94%80%20view.js%0A%E2%94%9C%E2%94%80%E2%94%80%20app.js%0A%E2%94%9C%E2%94%80%E2%94%80%20test%0A%E2%94%9C%E2%94%80%E2%94%80%20History.md%0A%E2%94%9C%E2%94%80%E2%94%80%20README.md%0A%E2%94%94%E2%94%80%E2%94%80%20package.json%0A%60%60%60%0A%0A%23%23%20Plugin%20naming%20convention%0A%0A*%20Follow%20the%20%5Bplugin%20development%20specification%5D(.%2Fplugin.md)%0A*%20According%20to%20the%20convention%2C%20the%20names%20of%20plugins%20start%20with%20%60egg-view-%60%0A*%20%60package.json%60%20is%20configured%20as%20follows.%20Plugins%20are%20named%20after%20the%20template%20engine%2C%20such%20as%20ejs%0A%0A%60%60%60json%0A%7B%0A%20%20%22name%22%3A%20%22egg-view-ejs%22%2C%0A%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%22name%22%3A%20%22ejs%22%0A%20%20%7D%2C%0A%20%20%22keywords%22%3A%20%5B%22egg%22%2C%20%22egg-plugin%22%2C%20%22egg-view%22%2C%20%22ejs%22%5D%0A%7D%0A%60%60%60%0A%0A*%20The%20configuration%20item%20is%20also%20named%20after%20the%20template%20engine%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20ejs%3A%20%7B%7D%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20View%20base%20class%0A%0AThe%20next%20step%20is%20to%20provide%20a%20View%20base%20class%20that%20will%20be%20instantiated%20on%20each%20request.%0A%0AThe%20base%20class%20of%20the%20View%20needs%20to%20provide%20%60render%60%20and%20%60renderString%60%20methods%20and%20supports%20generator%20and%20async%20functions%20(it%20can%20also%20be%20a%20function%20that%20returns%20a%20Promise).%20The%20%60render%60%20method%20is%20used%20to%20render%20files%2C%20and%20the%20%60renderString%60%20method%20is%20used%20to%20render%20template%20strings.%0A%0AThe%20following%20is%20a%20simplified%20code%20that%20can%20be%20directly%20%5Bview%20source%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-view-ejs%2Fblob%2Fmaster%2Flib%2Fview.js)%0A%0A%60%60%60js%0Aconst%20ejs%20%3D%20require('ejs')%3B%0A%0AMmdule.exports%20%3D%20class%20EjsView%20%7B%0A%20%20render(filename%2C%20locals)%20%7B%0A%20%20%20%20return%20new%20Promise((resolve%2C%20reject)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Asynchronous%20API%20call%0A%20%20%20%20%20%20ejs.renderFile(filename%2C%20locals%2C%20(err%2C%20result)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20if%20(err)%20%7B%0A%20%20%20%20%20%20%20%20%20%20reject(err)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20resolve(result)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%0A%20%20renderString(tpl%2C%20locals)%20%7B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%2F%2F%20Synchronous%20API%20call%0A%20%20%20%20%20%20return%20Promise.resolve(ejs.render(tpl%2C%20locals))%3B%0A%20%20%20%20%7D%20catch%20(err)%20%7B%0A%20%20%20%20%20%20return%20Promise.reject(err)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20Parameters%0A%0AThe%20three%20parameters%20of%20the%20%60render%60%20method%20are%0A%0A*%20filename%3A%20is%20the%20path%20to%20the%20complete%20file.%20The%20framework%20determines%20if%20the%20file%20exists%20when%20it%20looks%20for%20the%20file.%20It%20does%20not%20need%20to%20be%20processed%20here.%0A*%20locals%3A%20The%20data%20needed%20for%20rendering.%20The%20data%20comes%20from%20%60app.locals%60%2C%20%60ctx.locals%60%20and%20calls%20%60render%60%20methods.%20The%20framework%20also%20has%20built%20in%20%60ctx%60%2C%20%60request%60%2C%20%60ctx.helper%60%20objects.%0A*%20viewOptions%3A%20The%20incoming%20configuration%20of%20the%20user%2C%20which%20can%20override%20the%20default%20configuration%20of%20the%20template%20engine.%20This%20can%20be%20considered%20based%20on%20the%20characteristics%20of%20the%20template%20engine.%20For%20example%2C%20the%20cache%20is%20enabled%20by%20default%20but%20a%20page%20does%20not%20need%20to%20be%20cached.%0A%0AThe%20three%20parameters%20of%20the%20%60renderString%60%20method%0A%0A*%20tpl%3A%20template%20string%2C%20not%20file%20path%0A*%20locals%3A%20same%20with%20%60render%60%0A*%20viewOptions%3A%20same%20with%20%60render%60%0A%0A%23%23%20Plugin%20configuration%0A%0AAccording%20to%20the%20naming%20conventions%20mentioned%20above%2C%20the%20configuration%20name%20is%20generally%20the%20name%20of%20the%20template%20engine%2C%20such%20as%20ejs%0A%0AThe%20configuration%20of%20the%20plugin%20mainly%20comes%20from%20the%20configuration%20of%20the%20template%20engine%2C%20and%20the%20configuration%20items%20can%20be%20defined%20according%20to%20the%20specific%20conditions%2C%20such%20as%20the%20%5Bconfiguration%20of%20ejs%5D(https%3A%2F%2Fgithub.com%2Fmde%2Fejs%23options)%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20ejs%3A%20%7B%0A%20%20%20%20cache%3A%20true%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20Helper%0A%0AThe%20framework%20provides%20%60ctx.helper%60%20for%20developer%20use%2C%20but%20in%20some%20cases%20we%20want%20to%20override%20the%20helper%20method%20and%20only%20take%20effect%20when%20the%20template%20is%20rendered.%0A%0AIn%20template%20rendering%2C%20we%20often%20need%20to%20output%20a%20user-supplied%20html%20fragment%2C%20in%20which%20case%2C%20we%20often%20use%20the%20%60helper.shtml%60%20provided%20by%20the%20%60egg-security%60%20plugin.%0A%0A%60%60%60html%0A%3Cdiv%3E%7B%7B%20helper.shtml(data.content)%20%7C%20safe%20%7D%7D%3C%2Fdiv%3E%0A%60%60%60%0A%0AHowever%2C%20as%20shown%20in%20the%20above%20code%2C%20we%20need%20to%20use%20%60%7C%20safe%60%20to%20tell%20the%20template%20engine%20that%20the%20html%20is%20safe%20and%20it%20doesn't%20need%20to%20run%20%60escape%60%20again.%0A%0AThis%20is%20more%20cumbersome%20to%20use%20and%20easy%20to%20forget%2C%20so%20we%20can%20package%20it%3A%0A%0AFirst%20provide%20a%20helper%20subclass%3A%0A%0A%60%60%60js%0A%2F%2F%20%7Bplugin_root%7D%2Flib%2Fhelper.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20return%20class%20ViewHelper%20extends%20app.Helper%20%7B%0A%20%20%20%20%2F%2F%20safe%20is%20injected%20by%20%5Begg-view-nunjucks%5D%20and%20will%20not%20be%20escaped%20during%20rendering.%0A%20%20%20%20%2F%2F%20Otherwise%2C%20the%20template%20call%20shtml%20will%20be%20escaped%0A%20%20%20%20shtml(str)%20%7B%0A%20%20%20%20%20%20return%20this.safe(super.shtml(str))%3B%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0AUse%20a%20custom%20helper%20when%20rendering%0A%0A%60%60%60js%0A%2F%2F%20%7Bplugin_root%7D%2Flib%2Fview.js%0Aconst%20ViewHelper%20%3D%20require('.%2Fhelper')%3B%0A%0Amodule.exports%20%3D%20class%20MyCustomView%20%7B%0A%20%20render(filename%2C%20locals)%20%7B%0A%20%20%20%20locals.helper%20%3D%20new%20ViewHelper(this.ctx)%3B%20%2F%2F%20call%20Nunjucks%20render%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0AYou%20can%20%5Bview%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-view-nunjucks%2Fblob%2F2ee5ee992cfd95bc0bb5b822fbd72a6778edb118%2Flib%2Fview.js%23L11)%20the%20specific%20code%20here%0A%0A%23%23%23%20Security%20Related%0A%0ATemplates%20and%20security%20are%20related%20and%20%5Begg-security%5D%20also%20provides%20some%20methods%20for%20the%20template.%20The%20template%20engine%20can%20be%20used%20according%20to%20requirements.%0A%0AFirst%20declare%20a%20dependency%20on%20%5Begg-security%5D%0A%0A%60%60%60json%0A%7B%0A%20%20%22name%22%3A%20%22egg-view-nunjucks%22%2C%0A%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%22name%22%3A%20%22nunjucks%22%2C%0A%20%20%20%20%22dep%22%3A%20%5B%22security%22%5D%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0AThe%20framework%20provides%20%5Bapp.injectCsrf%5D(..%2Fcore%2Fsecurity.md%23appinjectcsrfstr)%20and%20%5Bapp.injectNonce%5D(..%2Fcore%2Fsecurity.md%23appinjectnonncestr)%2C%20for%20more%20information%20on%20%5Bsecurity%20section%5D(..%2Fcore%2Fsecurity.md).%0A%0A%23%23%23%20Unit%20tests%0A%0AAs%20a%20high-quality%20plugin%2C%20perfect%20unit%20testing%20is%20indispensable%2C%20and%20we%20also%20provide%20a%20lot%20of%20auxiliary%20tools%20to%20make%20it%20painless%20for%20plugin%20developers%20to%20write%20tests%2C%20see%20%5Bunit%20testing%5D(..%2Fcore%2Funittest.md)%20and%20%5Bplugin%5D(.%2Fplugin.md)%20docs.%0A%0A%5Begg-security%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-security%0A%5Begg-view-nunjucks%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-view-nunjucks%0A%5Begg-view-ejs%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-view-ejs%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>