<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Plugin Development</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/en/intro/">Guide</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/en/tutorials/index.html">Tutorials</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">Plugins</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">Release</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>切换语言</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>Guide</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/index.html">What is Egg?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/quickstart.html">Quick Start</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/progressive.html">Progressive</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/migration.html">Migration to 2.x</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>Basis Function</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/structure.html">Directory Structure</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/objects.html">Built-in Objects</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/env.html">Environment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/config.html">Configuration</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/middleware.html">Middleware</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/plugin.html">Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/schedule.html">Schedule</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/extend.html">Extend</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/app-start.html">Custom Init</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>Core</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/development.html">Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/unittest.html">Unit Testing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/deployment.html">Deployment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/logger.html">Logger</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/view.html">View</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/error-handling.html">Error Handling</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/security.html">Security</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/i18n.html">i18n</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>Tutorials</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/passport.html">Passport</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/assets.html">Assets</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>Advanced</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/plugin.html">Plugin Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/framework.html">Framework</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/view-plugin.html">View Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/style-guide.html">Style Guide</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>Community</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/plugins/">Plugin List</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/contributing.html">Contributing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/resource.html">Resource</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/faq.html">FAQ</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>Plugins is the most important feature in Egg framework. It keeps Egg simple, stable and efficient, and also it can make the best reuse of business logic, to build an entire ecosystem. Someone should be confused:</p><ul><li>Since Koa already has the mechanism of middleware, what&#x27;s the point of the Egg&#x27;s plugins</li><li>What is the differences between middleware, plugin and application, what is the relationship</li><li>How can I use the plugin</li><li>How do I build a plugin</li><li>...</li></ul><p>As we&#x27;ve already explained some these points in Chapter <a href="../basics/plugin.md">using plugins</a> before. Now we are going through how to build a plugin.</p><h2 id="plugin-development">Plugin Development</h2><h3 id="quick-start-with-scaffold">Quick Start with Scaffold</h3><p>You can choose <a href="https://github.com/eggjs/egg-boilerplate-plugin">plugin</a> scaffold in <a href="https://github.com/eggjs/egg-init">egg-init</a> for quick start.</p><pre><code class="language-bash">$ egg-init --type=plugin egg-hello
$ cd egg-hello
$ npm i
$ npm test</code></pre><h2 id="directory-of-plugin">Directory of Plugin</h2><p>Plugin is actually a &#x27;mini application&#x27;, directory of plugin is as below</p><pre><code class="language-js">. egg-hello
├── package.json
├── app.js (optional)
├── agent.js (optional)
├── app
│   ├── extend (optional)
│   |   ├── helper.js (optional)
│   |   ├── request.js (optional)
│   |   ├── response.js (optional)
│   |   ├── context.js (optional)
│   |   ├── application.js (optional)
│   |   └── agent.js (optional)
│   ├── service (optional)
│   └── middleware (optional)
│       └── mw.js
├── config
|   ├── config.default.js
│   ├── config.prod.js
|   ├── config.test.js (optional)
|   ├── config.local.js (optional)
|   └── config.unittest.js (optional)
└── test
    └── middleware
        └── mw.test.js</code></pre><p>It is almost the same as the application directory, what&#x27;s the difference?</p><ol><li><p>Plugin have no independant router or controller. This is because:</p><ul><li>Usually routers are strongly bound to application, it is not fit here.</li><li>An application might have plenty of dependant plugins, routers of plugin are very possible conflict with others. It would be a disaster.</li><li>If you really need a general router, you should implement it as middleware of the plugin.</li></ul></li><li><p>The specific information of plugin should be declared in the  <code>package.json</code> of <code>eggPlugin</code>：</p><ul><li><code>{String} name</code> - plugin name(required), it must be unique, it will be used in the config of the dependencies of plugin.</li><li><code>{Array} dependencies</code> - strong dependant plugins list of current plugin(if one of these plugins here is not found, application&#x27;s startup will be failed)</li><li><code>{Array} optionalDependencies</code> - optional dependencies list of this plugin.(if these plugins are not activated, only warnings would be occurred, and will not affect the startup of the application).</li><li><p><code>{Array} env</code> - this option is available only when specify the environment. The list of env please refer to <a href="../basics/env.md">env</a>. This is optional, most time you can leave it.</p><pre><code class="language-json">{
  &quot;name&quot;: &quot;egg-rpc&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;rpc&quot;,
    &quot;dependencies&quot;: [ &quot;registry&quot; ],
    &quot;optionalDependencies&quot;: [ &quot;vip&quot; ],
    &quot;env&quot;: [ &quot;local&quot;, &quot;test&quot;, &quot;unittest&quot;, &quot;prod&quot; ]
  }
}</code></pre></li></ul></li><li><p>No <code>plugin.js</code>：</p><ul><li><code>eggPlugin.dependencies</code> is for declaring dependencies only, not for importing, nor activating.</li><li>If you want to manage multiple plugins, you should do it in<a href="./framework.md">upper framework</a></li></ul></li></ol><h2 id="dependencies-management-of-plugins">Dependencies Management of Plugins</h2><p>The dependencies are managed by plugin himself, this is different from middleware. Before loading plugins, application will read <code>eggPlugin &gt; dependencies</code> and <code>eggPlugin &gt; optionalDependencies</code> from <code>package.json</code>, and then sort out the loading orders according to their relationships, for example, the loading order of the following plugins is <code>c =&gt; b =&gt; a</code></p><pre><code class="language-json">// plugin a
{
  &quot;name&quot;: &quot;egg-plugin-a&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;a&quot;,
    &quot;dependencies&quot;: [ &quot;b&quot; ]
  }
}

// plugin b
{
  &quot;name&quot;: &quot;egg-plugin-b&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;b&quot;,
    &quot;optionalDependencies&quot;: [ &quot;c&quot; ]
  }
}

// plugin c
{
  &quot;name&quot;: &quot;egg-plugin-c&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;c&quot;
  }
}</code></pre><p><strong> Attention: The values in <code>dependencies</code> and <code>optionalDependencies</code> are the <code>eggPlugin.name</code> of plugins, not <code>package.name</code>. </strong></p><p>The <code>dependencies</code> and <code>optionalDependencies</code> is studied from <code>npm</code>, most time we are using <code>dependencies</code>, it is recommended. There are about two situations to apply the <code>optionalDependencies</code>:</p><ul><li>Only be dependant in specific environment: for example, a authentication plugin, only depends on the mock plugin in development environment.</li><li>Weakly depending, for example: A depends on B, but without B, A can take other choice</li></ul><p>Pay attention: if you are using <code>optionalDependencies</code>, framework won&#x27;t verify the activation of these dependencies, they are only for sorting loading orders. In such situation, the plugin will go through other ways such as <code>interface detection</code> to decide processing logic.</p><h2 id="what-can-plugin-do">What can plugin do</h2><p>We&#x27;ve discussed what plugin is. Now what can it do?</p><h3 id="built-in-objects-api-extension">Built-in Objects API Extension</h3><p>Extend the built-in objects of the framework, just like the application</p><ul><li><code>app/extend/request.js</code> - extends Koa#Request object</li><li><code>app/extend/response.js</code> - extends Koa#Response object</li><li><code>app/extend/context.js</code> - extends Koa#Context object</li><li><code>app/extend/helper.js</code> - extends Helper object</li><li><code>app/extend/application.js</code> - extends Application object</li><li><code>app/extend/agent.js</code> - extends Agent object</li></ul><h3 id="insert-custom-middlewares">Insert Custom Middlewares</h3><ol><li><p>First, define and implement middleware under directory <code>app/middleware</code></p><pre><code class="language-js">&#x27;use strict&#x27;;

const staticCache = require(&#x27;koa-static-cache&#x27;);
const assert = require(&#x27;assert&#x27;);
const mkdirp = require(&#x27;mkdirp&#x27;);

module.exports = (options, app) =&gt; {
  assert.strictEqual(typeof options.dir, &#x27;string&#x27;, &#x27;Must set `app.config.static.dir` when static plugin enable&#x27;);

  // ensure directory exists
  mkdirp.sync(options.dir);

  app.loggers.coreLogger.info(&#x27;[egg-static] starting static serve %s -&gt; %s&#x27;, options.prefix, options.dir);

  return staticCache(options);
};</code></pre></li><li><p>Insert middleware to the appropriate position in <code>app.js</code>(e.g. insert static middleware before bodyParser )</p><pre><code class="language-js">const assert = require(&#x27;assert&#x27;);

module.exports = app =&gt; {
  // insert static middleware before bodyParser
  const index = app.config.coreMiddleware.indexOf(&#x27;bodyParser&#x27;);
  assert(index &gt;= 0, &#x27;bodyParser highly needed&#x27;);

  app.config.coreMiddleware.splice(index, 0, &#x27;static&#x27;);
};</code></pre></li></ol><h3 id="initialization-on-application-starting">Initialization on Application Starting</h3><ul><li><p>If you want to read some local config before startup</p><pre><code class="language-js">// ${plugin_root}/app.js
const fs = require(&#x27;fs&#x27;);
const path = require(&#x27;path&#x27;);

module.exports = app =&gt; {
  app.customData = fs.readFileSync(path.join(app.config.baseDir, &#x27;data.bin&#x27;));

  app.coreLogger.info(&#x27;read data ok&#x27;);
};</code></pre></li><li><p>If you want to do some async starting business, you can do it with <code>app.beforeStart</code> API</p><pre><code class="language-js">// ${plugin_root}/app.js
const MyClient = require(&#x27;my-client&#x27;);

module.exports = app =&gt; {
  app.myClient = new MyClient();
  app.myClient.on(&#x27;error&#x27;, err =&gt; {
    app.coreLogger.error(err);
  });
  app.beforeStart(async () =&gt; {
    await app.myClient.ready();
    app.coreLogger.info(&#x27;my client is ready&#x27;);
  });
};</code></pre></li><li><p>You can add starting business of agent with <code>agent.beforeStart</code> API</p><pre><code class="language-js">// ${plugin_root}/agent.js
const MyClient = require(&#x27;my-client&#x27;);

module.exports = agent =&gt; {
  agent.myClient = new MyClient();
  agent.myClient.on(&#x27;error&#x27;, err =&gt; {
    agent.coreLogger.error(err);
  });
  agent.beforeStart(async () =&gt; {
    await agent.myClient.ready();
    agent.coreLogger.info(&#x27;my client is ready&#x27;);
  });
};</code></pre></li></ul><h3 id="setup-schedule-task">Setup Schedule Task</h3><ol><li><p>Setup dependencies of schedule plugin in <code>package.json</code></p><pre><code class="language-json">{
  &quot;name&quot;: &quot;your-plugin&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;your-plugin&quot;,
    &quot;dependencies&quot;: [ &quot;schedule&quot; ]
  }
}</code></pre></li><li><p>Create a new file in <code>${plugin_root}/app/schedule/</code> directory to edit your schedule task</p><pre><code class="language-js">exports.schedule = {
  type: &#x27;worker&#x27;,
  cron: &#x27;0 0 3 * * *&#x27;,
  // interval: &#x27;1h&#x27;,
  // immediate: true,
};

exports.task = async ctx =&gt; {
  // your logic code
};</code></pre></li></ol><h3 id="best-practice-of-global-instance-plugin">Best Practice of Global Instance Plugin</h3><p>Some plugins are made to introduce existing service into framework, like <a href="https://github.com/eggjs/egg-mysql">egg-mysql</a>,<a href="https://github.com/eggjs/egg-oss">egg-oss</a>.They all need to create corresponding instance in application. We notice that there are some common problems when developing this kind of plugins:</p><ul><li>Use different instances of the same service in one application(e.g:connect to two different MySQL Databases)</li><li>Dynamically initialize connection after getting config from other service(gets MySQL server address from configuration center and then creates connection)</li></ul><p>If each plugin makes their own implementation, all sorts of configs  and  initializations will be chaotic. So the framework supplies the  <code>app.addSingleton(name, creator)</code> API to unify the creation of this kind of services. Note that while using the <code>app.addSingleton(name, creator)</code> method, the configuration file must have the <code>client</code> or <code>clients</code> key configuration as the <code>config</code> to the <code>creator</code> function.</p><h4 id="writing-plugin">Writing Plugin</h4><p>We simplify the <a href="https://github.com/eggjs/egg-mysql">egg-mysql</a> plugin and to see how to write such a plugin:</p><pre><code class="language-js">// egg-mysql/app.js
module.exports = app =&gt; {
  // The first parameter mysql defines the field  mounted to app, we can access MySQL singleton instance via `app.mysql`
  // The second parameter createMysql accepts two parameters (config, app), and then returns a MySQL instance
  app.addSingleton(&#x27;mysql&#x27;, createMysql);
}

/**
 * @param  {Object} config   The config which already processed by the framework. If the application configured multiple MySQL instances, each config would be passed in and call multiple createMysql
 * @param  {Application} app  the current application
 * @return {Object}          return the created MySQL instance
 */
function createMysql(config, app) {
  assert(config.host &amp;&amp; config.port &amp;&amp; config.user &amp;&amp; config.database);
  // create instance
  const client = new Mysql(config);

  // check before start the application
  app.beforeStart(async () =&gt; {
    const rows = await client.query(&#x27;select now() as currentTime;&#x27;);
    app.coreLogger.info(`[egg-mysql] init instance success, rds currentTime: ${rows[0].currentTime}`);
  });

  return client;
}</code></pre><p>The initialization function also support <code>Async function</code>, convenient for some special plugins that need to be asynchronous to get some configuration files.</p><pre><code class="language-js">async function createMysql(config, app) {
  // get mysql configurations asynchronous
  const mysqlConfig = await app.configManager.getMysqlConfig(config.mysql);
  assert(mysqlConfig.host &amp;&amp; mysqlConfig.port &amp;&amp; mysqlConfig.user &amp;&amp; mysqlConfig.database);
  // create instance
  const client = new Mysql(mysqlConfig);

  // check before start the application
  const rows = await client.query(&#x27;select now() as currentTime;&#x27;);
  app.coreLogger.info(`[egg-mysql] init instance success, rds currentTime: ${rows[0].currentTime}`);

  return client;
}</code></pre><p>As you can see, all we need to do for this plugin is passing in the field that need to be mounted and the corresponding initialization function. Framework will be in charge of managing all the configs and the ways to access the instances.</p><h4 id="application-layer-usage-case">Application Layer Usage Case</h4><h5 id="single-instance">Single Instance</h5><ol><li><p>Declare MySQL config in config file</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  mysql: {
    client: {
      host: &#x27;mysql.com&#x27;,
      port: &#x27;3306&#x27;,
      user: &#x27;test_user&#x27;,
      password: &#x27;test_password&#x27;,
      database: &#x27;test&#x27;,
    },
  },
};</code></pre></li><li><p>Access database through <code>app.mysql</code> directly</p><pre><code class="language-js">// app/controller/post.js
class PostController extends Controller {
  async list() {
    const posts = await this.app.mysql.query(sql, values);
  },
}</code></pre></li></ol><h5 id="multiple-instances">Multiple Instances</h5><ol><li><p>Of course we need to configure MySQL in the config file, but different from single instance, we need to add  <code>clients</code> in the config to declare the configuration of different instances. meanwhile, the <code>default</code> field can be used to configure the shared configuration in multiple instances(e.g. host and port). Note that in this case,should use <code>get</code> function to specify the corresponding instance(eg: use <code>app.mysql.get(&#x27;db1&#x27;).query()</code> instead of using <code>app.mysql.query()</code> directly to get a <code>undefined</code>).</p><pre><code class="language-js">// config/config.default.js
exports.mysql = {
  clients: {
    // clientId, access the client instance by app.mysql.get(&#x27;clientId&#x27;)
    db1: {
      user: &#x27;user1&#x27;,
      password: &#x27;upassword1&#x27;,
      database: &#x27;db1&#x27;,
    },
    db2: {
      user: &#x27;user2&#x27;,
      password: &#x27;upassword2&#x27;,
      database: &#x27;db2&#x27;,
    },
  },
  // default configuration for all databases
  default: {
    host: &#x27;mysql.com&#x27;,
    port: &#x27;3306&#x27;,
  },
};</code></pre></li><li><p>Access the corresponding instance by <code>app.mysql.get(&#x27;db1&#x27;)</code></p><pre><code class="language-js">// app/controller/post.js
class PostController extends Controller {
  async list() {
    const posts = await this.app.mysql.get(&#x27;db1&#x27;).query(sql, values);
  },
}</code></pre></li></ol><h5 id="dynamically-instantiate">Dynamically Instantiate</h5><p>Instead of declaring the configuration in the configuration file in advance, We can dynamically initialize an instance at the runtime of the application.</p><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  app.beforeStart(async () =&gt; {
    //  get MySQL config from configuration center { host, post, password, ... }
    const mysqlConfig = await app.configCenter.fetch(&#x27;mysql&#x27;);
    // create MySQL instance dynamically
    app.database = app.mysql.createInstanceAsync(mysqlConfig);
  });
};</code></pre><p>Access the instance through <code>app.database</code></p><pre><code class="language-js">// app/controller/post.js
class PostController extends Controller {
  async list() {
    const posts = await this.app.database.query(sql, values);
  },
}</code></pre><p><strong>Attention, when creating the instance dynamically, framework would read the <code>default</code> configuration in the config file as the default configuration</strong></p><h3 id="plugin-locate-rule">Plugin Locate Rule</h3><p>When loading the plugins in the framework, it will follow the rules to locate them as below:</p><ul><li>If there is the path configuration, load them in path directly</li><li><p>If there is no path configuration, search them with the package name, the search orders are:</p><ol><li><code>node_modules</code> directory of the application root</li><li><code>node_modules</code> directory of the dependencies</li><li><code>node_modules</code> of current directory(generally for unit test compatibility)</li></ol></li></ul><h3 id="plugin-specification">Plugin Specification</h3><p>We are very welcome your contribution to the new plugins, but also hope you follow some of following specifications:</p><ul><li>Naming Rules<ul><li><code>npm</code> packages must append prefix <code>egg-</code>,and all letters must be lowercase,for example:<code>egg-xxx</code>. The long names should be concatenated with middle-lines:<code>egg-foo-bar</code>.</li><li>The corresponding plugin should be named in camel-case. The name should be translated according to the middle-lines of the <code>npm</code> name:<code>egg-foo-bar</code> =&gt; <code>fooBar</code>.</li><li>The use of middle-lines is not compulsive,for example:userservice(egg-userservice) and user-service(egg-user-service) are both acceptable.</li></ul></li><li><p><code>package.json</code> Rules</p><ul><li>Add <code>eggPlugin</code> property according to the details discussed before.</li><li><p>For convenient index, add <code>egg</code>,<code>egg-plugin</code>,<code>eggPlugin</code> in <code>keywords</code>.</p><pre><code class="language-json">{
  &quot;name&quot;: &quot;egg-view-nunjucks&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;view plugin for egg&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;nunjucks&quot;,
    &quot;dep&quot;: [
      &quot;security&quot;
    ]
  },
  &quot;keywords&quot;: [
    &quot;egg&quot;,
    &quot;egg-plugin&quot;,
    &quot;eggPlugin&quot;,
    &quot;egg-plugin-view&quot;,
    &quot;egg-view&quot;,
    &quot;nunjucks&quot;
  ],
}</code></pre></li></ul></li></ul><h2 id="why-do-not-use-the-npm-package-name-as-the-plugin-name">Why do not use the npm package name as the plugin name?</h2><p>Egg defines the plugin name through the <code>eggPlugin.name</code>, it is only unique in application or framework, that means <strong>many npm packages might get the same plugin name</strong>, why design in this way?</p><p>First, Egg plugin do not only support npm package, it also supports search plugins in local directory. In Chapter <a href="../tutorials/progressive.md">progressive</a> we mentioned how to make progress by using these two configurations. Directory is more friendly to unit test. So, Egg can not ensure uniqueness through npm package name.</p><p>What&#x27;s more, Egg can use this feature to make Adapter. For example, the plugin defined in<a href="./view-plugin.md#PluginNameSpecification">Template Develop Spec</a> was named as view, but there are plugins named <code>egg-view-nunjucks</code> and <code>egg-view-react</code>, the users only need to change the plugin and modify the templates, no need to modify the Controller, because all these plugins have implemented the same API.</p><p><strong>Giving the same plugin name and the same API to the same plugin can make quick switch between them</strong>. This is really really useful in template and database.</p></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#plugin-development">Plugin Development</a><ul><li><a href="#quick-start-with-scaffold">Quick Start with Scaffold</a></li></ul></li><li><a href="#directory-of-plugin">Directory of Plugin</a></li><li><a href="#dependencies-management-of-plugins">Dependencies Management of Plugins</a></li><li><a href="#what-can-plugin-do">What can plugin do</a><ul><li><a href="#built-in-objects-api-extension">Built-in Objects API Extension</a></li><li><a href="#insert-custom-middlewares">Insert Custom Middlewares</a></li><li><a href="#initialization-on-application-starting">Initialization on Application Starting</a></li><li><a href="#setup-schedule-task">Setup Schedule Task</a></li><li><a href="#best-practice-of-global-instance-plugin">Best Practice of Global Instance Plugin</a><ul><li><a href="#writing-plugin">Writing Plugin</a></li><li><a href="#application-layer-usage-case">Application Layer Usage Case</a><ul><li><a href="#single-instance">Single Instance</a></li><li><a href="#multiple-instances">Multiple Instances</a></li><li><a href="#dynamically-instantiate">Dynamically Instantiate</a></li></ul></li></ul></li><li><a href="#plugin-locate-rule">Plugin Locate Rule</a></li><li><a href="#plugin-specification">Plugin Specification</a></li></ul></li><li><a href="#why-do-not-use-the-npm-package-name-as-the-plugin-name">Why do not use the npm package name as the plugin name?</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"en","props":{"toc":"-%20%5BPlugin%20Development%5D(%23plugin-development)%0A%20%20*%20%5BQuick%20Start%20with%20Scaffold%5D(%23quick-start-with-scaffold)%0A-%20%5BDirectory%20of%20Plugin%5D(%23directory-of-plugin)%0A-%20%5BDependencies%20Management%20of%20Plugins%5D(%23dependencies-management-of-plugins)%0A-%20%5BWhat%20can%20plugin%20do%5D(%23what-can-plugin-do)%0A%20%20*%20%5BBuilt-in%20Objects%20API%20Extension%5D(%23built-in-objects-api-extension)%0A%20%20*%20%5BInsert%20Custom%20Middlewares%5D(%23insert-custom-middlewares)%0A%20%20*%20%5BInitialization%20on%20Application%20Starting%5D(%23initialization-on-application-starting)%0A%20%20*%20%5BSetup%20Schedule%20Task%5D(%23setup-schedule-task)%0A%20%20*%20%5BBest%20Practice%20of%20Global%20Instance%20Plugin%5D(%23best-practice-of-global-instance-plugin)%0A%20%20%20%20%2B%20%5BWriting%20Plugin%5D(%23writing-plugin)%0A%20%20%20%20%2B%20%5BApplication%20Layer%20Usage%20Case%5D(%23application-layer-usage-case)%0A%20%20%20%20%20%20-%20%5BSingle%20Instance%5D(%23single-instance)%0A%20%20%20%20%20%20-%20%5BMultiple%20Instances%5D(%23multiple-instances)%0A%20%20%20%20%20%20-%20%5BDynamically%20Instantiate%5D(%23dynamically-instantiate)%0A%20%20*%20%5BPlugin%20Locate%20Rule%5D(%23plugin-locate-rule)%0A%20%20*%20%5BPlugin%20Specification%5D(%23plugin-specification)%0A-%20%5BWhy%20do%20not%20use%20the%20npm%20package%20name%20as%20the%20plugin%20name%3F%5D(%23why-do-not-use-the-npm-package-name-as-the-plugin-name)","meta":{"info":{"title":"Plugin Development"}},"content":"%0A%0A%0APlugins%20is%20the%20most%20important%20feature%20in%20Egg%20framework.%20It%20keeps%20Egg%20simple%2C%20stable%20and%20efficient%2C%20and%20also%20it%20can%20make%20the%20best%20reuse%20of%20business%20logic%2C%20to%20build%20an%20entire%20ecosystem.%20Someone%20should%20be%20confused%3A%0A%0A-%20Since%20Koa%20already%20has%20the%20mechanism%20of%20middleware%2C%20what's%20the%20point%20of%20the%20Egg's%20plugins%0A-%20What%20is%20the%20differences%20between%20middleware%2C%20plugin%20and%20application%2C%20what%20is%20the%20relationship%0A-%20How%20can%20I%20use%20the%20plugin%0A-%20How%20do%20I%20build%20a%20plugin%0A-%20...%0A%0AAs%20we've%20already%20explained%20some%20these%20points%20in%20Chapter%20%5Busing%20plugins%5D(..%2Fbasics%2Fplugin.md)%20before.%20Now%20we%20are%20going%20through%20how%20to%20build%20a%20plugin.%0A%0A%23%23%20Plugin%20Development%0A%0A%23%23%23%20Quick%20Start%20with%20Scaffold%0A%0AYou%20can%20choose%20%5Bplugin%5D%5Begg-boilerplate-plugin%5D%20scaffold%20in%20%5Begg-init%5D%20for%20quick%20start.%0A%0A%60%60%60bash%0A%24%20egg-init%20--type%3Dplugin%20egg-hello%0A%24%20cd%20egg-hello%0A%24%20npm%20i%0A%24%20npm%20test%0A%60%60%60%0A%0A%23%23%20Directory%20of%20Plugin%0A%0APlugin%20is%20actually%20a%20'mini%20application'%2C%20directory%20of%20plugin%20is%20as%20below%0A%0A%60%60%60js%0A.%20egg-hello%0A%E2%94%9C%E2%94%80%E2%94%80%20package.json%0A%E2%94%9C%E2%94%80%E2%94%80%20app.js%20(optional)%0A%E2%94%9C%E2%94%80%E2%94%80%20agent.js%20(optional)%0A%E2%94%9C%E2%94%80%E2%94%80%20app%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20extend%20(optional)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20helper.js%20(optional)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20request.js%20(optional)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20response.js%20(optional)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20context.js%20(optional)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20application.js%20(optional)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%94%E2%94%80%E2%94%80%20agent.js%20(optional)%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20service%20(optional)%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20middleware%20(optional)%0A%E2%94%82%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20mw.js%0A%E2%94%9C%E2%94%80%E2%94%80%20config%0A%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20config.default.js%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20config.prod.js%0A%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20config.test.js%20(optional)%0A%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20config.local.js%20(optional)%0A%7C%20%20%20%E2%94%94%E2%94%80%E2%94%80%20config.unittest.js%20(optional)%0A%E2%94%94%E2%94%80%E2%94%80%20test%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20middleware%0A%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20mw.test.js%0A%60%60%60%0A%0AIt%20is%20almost%20the%20same%20as%20the%20application%20directory%2C%20what's%20the%20difference%3F%0A%0A1.%20Plugin%20have%20no%20independant%20router%20or%20controller.%20This%20is%20because%3A%0A%0A%20%20%20%20-%20Usually%20routers%20are%20strongly%20bound%20to%20application%2C%20it%20is%20not%20fit%20here.%0A%20%20%20%20-%20An%20application%20might%20have%20plenty%20of%20dependant%20plugins%2C%20routers%20of%20plugin%20are%20very%20possible%20conflict%20with%20others.%20It%20would%20be%20a%20disaster.%0A%20%20%20%20-%20If%20you%20really%20need%20a%20general%20router%2C%20you%20should%20implement%20it%20as%20middleware%20of%20the%20plugin.%0A%0A2.%20The%20specific%20information%20of%20plugin%20should%20be%20declared%20in%20the%20%20%60package.json%60%20of%20%60eggPlugin%60%EF%BC%9A%0A%0A%20%20%20%20-%20%60%7BString%7D%20name%60%20-%20plugin%20name(required)%2C%20it%20must%20be%20unique%2C%20it%20will%20be%20used%20in%20the%20config%20of%20the%20dependencies%20of%20plugin.%0A%20%20%20%20-%20%60%7BArray%7D%20dependencies%60%20-%20strong%20dependant%20plugins%20list%20of%20current%20plugin(if%20one%20of%20these%20plugins%20here%20is%20not%20found%2C%20application's%20startup%20will%20be%20failed)%0A%20%20%20%20-%20%60%7BArray%7D%20optionalDependencies%60%20-%20optional%20dependencies%20list%20of%20this%20plugin.(if%20these%20plugins%20are%20not%20activated%2C%20only%20warnings%20would%20be%20occurred%2C%20and%20will%20not%20affect%20the%20startup%20of%20the%20application).%0A%20%20%20%20-%20%60%7BArray%7D%20env%60%20-%20this%20option%20is%20available%20only%20when%20specify%20the%20environment.%20The%20list%20of%20env%20please%20refer%20to%20%5Benv%5D(..%2Fbasics%2Fenv.md).%20This%20is%20optional%2C%20most%20time%20you%20can%20leave%20it.%0A%0A%20%20%20%20%20%20%60%60%60json%0A%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%22name%22%3A%20%22egg-rpc%22%2C%0A%20%20%20%20%20%20%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%22name%22%3A%20%22rpc%22%2C%0A%20%20%20%20%20%20%20%20%20%20%22dependencies%22%3A%20%5B%20%22registry%22%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%22optionalDependencies%22%3A%20%5B%20%22vip%22%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%22env%22%3A%20%5B%20%22local%22%2C%20%22test%22%2C%20%22unittest%22%2C%20%22prod%22%20%5D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%60%60%60%0A%0A3.%20No%20%60plugin.js%60%EF%BC%9A%0A%0A%20%20%20%20-%20%60eggPlugin.dependencies%60%20is%20for%20declaring%20dependencies%20only%2C%20not%20for%20importing%2C%20nor%20activating.%0A%20%20%20%20-%20If%20you%20want%20to%20manage%20multiple%20plugins%2C%20you%20should%20do%20it%20in%5Bupper%20framework%5D(.%2Fframework.md)%0A%0A%23%23%20Dependencies%20Management%20of%20Plugins%0A%0AThe%20dependencies%20are%20managed%20by%20plugin%20himself%2C%20this%20is%20different%20from%20middleware.%20Before%20loading%20plugins%2C%20application%20will%20read%20%60eggPlugin%20%3E%20dependencies%60%20and%20%60eggPlugin%20%3E%20optionalDependencies%60%20from%20%60package.json%60%2C%20and%20then%20sort%20out%20the%20loading%20orders%20according%20to%20their%20relationships%2C%20for%20example%2C%20the%20loading%20order%20of%20the%20following%20plugins%20is%20%60c%20%3D%3E%20b%20%3D%3E%20a%60%0A%0A%60%60%60json%0A%2F%2F%20plugin%20a%0A%7B%0A%20%20%22name%22%3A%20%22egg-plugin-a%22%2C%0A%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%22name%22%3A%20%22a%22%2C%0A%20%20%20%20%22dependencies%22%3A%20%5B%20%22b%22%20%5D%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20plugin%20b%0A%7B%0A%20%20%22name%22%3A%20%22egg-plugin-b%22%2C%0A%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%22name%22%3A%20%22b%22%2C%0A%20%20%20%20%22optionalDependencies%22%3A%20%5B%20%22c%22%20%5D%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20plugin%20c%0A%7B%0A%20%20%22name%22%3A%20%22egg-plugin-c%22%2C%0A%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%22name%22%3A%20%22c%22%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A**%20Attention%3A%20The%20values%20in%20%60dependencies%60%20and%20%60optionalDependencies%60%20are%20the%20%60eggPlugin.name%60%20of%20plugins%2C%20not%20%60package.name%60.%20**%0A%0AThe%20%60dependencies%60%20and%20%60optionalDependencies%60%20is%20studied%20from%20%60npm%60%2C%20most%20time%20we%20are%20using%20%60dependencies%60%2C%20it%20is%20recommended.%20There%20are%20about%20two%20situations%20to%20apply%20the%20%60optionalDependencies%60%3A%0A%0A-%20Only%20be%20dependant%20in%20specific%20environment%3A%20for%20example%2C%20a%20authentication%20plugin%2C%20only%20depends%20on%20the%20mock%20plugin%20in%20development%20environment.%0A-%20Weakly%20depending%2C%20for%20example%3A%20A%20depends%20on%20B%2C%20but%20without%20B%2C%20A%20can%20take%20other%20choice%0A%0APay%20attention%3A%20if%20you%20are%20using%20%60optionalDependencies%60%2C%20framework%20won't%20verify%20the%20activation%20of%20these%20dependencies%2C%20they%20are%20only%20for%20sorting%20loading%20orders.%20In%20such%20situation%2C%20the%20plugin%20will%20go%20through%20other%20ways%20such%20as%20%60interface%20detection%60%20to%20decide%20processing%20logic.%0A%0A%23%23%20What%20can%20plugin%20do%0A%0AWe've%20discussed%20what%20plugin%20is.%20Now%20what%20can%20it%20do%3F%0A%0A%23%23%23%20Built-in%20Objects%20API%20Extension%0A%0AExtend%20the%20built-in%20objects%20of%20the%20framework%2C%20just%20like%20the%20application%0A%0A-%20%60app%2Fextend%2Frequest.js%60%20-%20extends%20Koa%23Request%20object%0A-%20%60app%2Fextend%2Fresponse.js%60%20-%20extends%20Koa%23Response%20object%0A-%20%60app%2Fextend%2Fcontext.js%60%20-%20extends%20Koa%23Context%20object%0A-%20%60app%2Fextend%2Fhelper.js%20%60%20-%20extends%20Helper%20object%0A-%20%60app%2Fextend%2Fapplication.js%60%20-%20extends%20Application%20object%0A-%20%60app%2Fextend%2Fagent.js%60%20-%20extends%20Agent%20object%0A%0A%23%23%23%20Insert%20Custom%20Middlewares%0A%0A1.%20First%2C%20define%20and%20implement%20middleware%20under%20directory%20%60app%2Fmiddleware%60%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20'use%20strict'%3B%0A%0A%20%20%20%20const%20staticCache%20%3D%20require('koa-static-cache')%3B%0A%20%20%20%20const%20assert%20%3D%20require('assert')%3B%0A%20%20%20%20const%20mkdirp%20%3D%20require('mkdirp')%3B%0A%0A%20%20%20%20module.exports%20%3D%20(options%2C%20app)%20%3D%3E%20%7B%0A%20%20%20%20%20%20assert.strictEqual(typeof%20options.dir%2C%20'string'%2C%20'Must%20set%20%60app.config.static.dir%60%20when%20static%20plugin%20enable')%3B%0A%0A%20%20%20%20%20%20%2F%2F%20ensure%20directory%20exists%0A%20%20%20%20%20%20mkdirp.sync(options.dir)%3B%0A%0A%20%20%20%20%20%20app.loggers.coreLogger.info('%5Begg-static%5D%20starting%20static%20serve%20%25s%20-%3E%20%25s'%2C%20options.prefix%2C%20options.dir)%3B%0A%0A%20%20%20%20%20%20return%20staticCache(options)%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A2.%20Insert%20middleware%20to%20the%20appropriate%20position%20in%20%60app.js%60(e.g.%20insert%20static%20middleware%20before%20bodyParser%20)%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20const%20assert%20%3D%20require('assert')%3B%0A%0A%20%20%20%20module.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20insert%20static%20middleware%20before%20bodyParser%0A%20%20%20%20%20%20const%20index%20%3D%20app.config.coreMiddleware.indexOf('bodyParser')%3B%0A%20%20%20%20%20%20assert(index%20%3E%3D%200%2C%20'bodyParser%20highly%20needed')%3B%0A%0A%20%20%20%20%20%20app.config.coreMiddleware.splice(index%2C%200%2C%20'static')%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A%23%23%23%20Initialization%20on%20Application%20Starting%0A%0A-%20If%20you%20want%20to%20read%20some%20local%20config%20before%20startup%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20%24%7Bplugin_root%7D%2Fapp.js%0A%20%20%20%20const%20fs%20%3D%20require('fs')%3B%0A%20%20%20%20const%20path%20%3D%20require('path')%3B%0A%0A%20%20%20%20module.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%20%20%20%20app.customData%20%3D%20fs.readFileSync(path.join(app.config.baseDir%2C%20'data.bin'))%3B%0A%0A%20%20%20%20%20%20app.coreLogger.info('read%20data%20ok')%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A-%20If%20you%20want%20to%20do%20some%20async%20starting%20business%2C%20you%20can%20do%20it%20with%20%60app.beforeStart%60%20API%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20%24%7Bplugin_root%7D%2Fapp.js%0A%20%20%20%20const%20MyClient%20%3D%20require('my-client')%3B%0A%0A%20%20%20%20module.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%20%20%20%20app.myClient%20%3D%20new%20MyClient()%3B%0A%20%20%20%20%20%20app.myClient.on('error'%2C%20err%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20app.coreLogger.error(err)%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20await%20app.myClient.ready()%3B%0A%20%20%20%20%20%20%20%20app.coreLogger.info('my%20client%20is%20ready')%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A-%20You%20can%20add%20starting%20business%20of%20agent%20with%20%60agent.beforeStart%60%20API%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20%24%7Bplugin_root%7D%2Fagent.js%0A%20%20%20%20const%20MyClient%20%3D%20require('my-client')%3B%0A%0A%20%20%20%20module.exports%20%3D%20agent%20%3D%3E%20%7B%0A%20%20%20%20%20%20agent.myClient%20%3D%20new%20MyClient()%3B%0A%20%20%20%20%20%20agent.myClient.on('error'%2C%20err%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20agent.coreLogger.error(err)%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20agent.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20await%20agent.myClient.ready()%3B%0A%20%20%20%20%20%20%20%20agent.coreLogger.info('my%20client%20is%20ready')%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A%23%23%23%20Setup%20Schedule%20Task%0A%0A1.%20Setup%20dependencies%20of%20schedule%20plugin%20in%20%60package.json%60%0A%0A%20%20%20%20%60%60%60json%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%22name%22%3A%20%22your-plugin%22%2C%0A%20%20%20%20%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%22name%22%3A%20%22your-plugin%22%2C%0A%20%20%20%20%20%20%20%20%22dependencies%22%3A%20%5B%20%22schedule%22%20%5D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%60%60%60%0A%0A2.%20Create%20a%20new%20file%20in%20%60%24%7Bplugin_root%7D%2Fapp%2Fschedule%2F%60%20directory%20to%20edit%20your%20schedule%20task%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20exports.schedule%20%3D%20%7B%0A%20%20%20%20%20%20type%3A%20'worker'%2C%0A%20%20%20%20%20%20cron%3A%20'0%200%203%20*%20*%20*'%2C%0A%20%20%20%20%20%20%2F%2F%20interval%3A%20'1h'%2C%0A%20%20%20%20%20%20%2F%2F%20immediate%3A%20true%2C%0A%20%20%20%20%7D%3B%0A%0A%20%20%20%20exports.task%20%3D%20async%20ctx%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20your%20logic%20code%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A%23%23%23%20Best%20Practice%20of%20Global%20Instance%20Plugin%0A%0ASome%20plugins%20are%20made%20to%20introduce%20existing%20service%20into%20framework%2C%20like%20%5Begg-mysql%5D%2C%5Begg-oss%5D.They%20all%20need%20to%20create%20corresponding%20instance%20in%20application.%20We%20notice%20that%20there%20are%20some%20common%20problems%20when%20developing%20this%20kind%20of%20plugins%3A%0A%0A-%20Use%20different%20instances%20of%20the%20same%20service%20in%20one%20application(e.g%3Aconnect%20to%20two%20different%20MySQL%20Databases)%0A-%20Dynamically%20initialize%20connection%20after%20getting%20config%20from%20other%20service(gets%20MySQL%20server%20address%20from%20configuration%20center%20and%20then%20creates%20connection)%0A%0AIf%20each%20plugin%20makes%20their%20own%20implementation%2C%20all%20sorts%20of%20configs%20%20and%20%20initializations%20will%20be%20chaotic.%20So%20the%20framework%20supplies%20the%20%20%60app.addSingleton(name%2C%20creator)%60%20API%20to%20unify%20the%20creation%20of%20this%20kind%20of%20services.%20Note%20that%20while%20using%20the%20%60app.addSingleton(name%2C%20creator)%60%20method%2C%20the%20configuration%20file%20must%20have%20the%20%60client%60%20or%20%60clients%60%20key%20configuration%20as%20the%20%60config%60%20to%20the%20%60creator%60%20function.%0A%0A%23%23%23%23%20Writing%20Plugin%0A%0AWe%20simplify%20the%20%5Begg-mysql%5D%20plugin%20and%20to%20see%20how%20to%20write%20such%20a%20plugin%3A%0A%0A%60%60%60js%0A%2F%2F%20egg-mysql%2Fapp.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%2F%2F%20The%20first%20parameter%20mysql%20defines%20the%20field%20%20mounted%20to%20app%2C%20we%20can%20access%20MySQL%20singleton%20instance%20via%20%60app.mysql%60%0A%20%20%2F%2F%20The%20second%20parameter%20createMysql%20accepts%20two%20parameters%20(config%2C%20app)%2C%20and%20then%20returns%20a%20MySQL%20instance%0A%20%20app.addSingleton('mysql'%2C%20createMysql)%3B%0A%7D%0A%0A%2F**%0A%20*%20%40param%20%20%7BObject%7D%20config%20%20%20The%20config%20which%20already%20processed%20by%20the%20framework.%20If%20the%20application%20configured%20multiple%20MySQL%20instances%2C%20each%20config%20would%20be%20passed%20in%20and%20call%20multiple%20createMysql%0A%20*%20%40param%20%20%7BApplication%7D%20app%20%20the%20current%20application%0A%20*%20%40return%20%7BObject%7D%20%20%20%20%20%20%20%20%20%20return%20the%20created%20MySQL%20instance%0A%20*%2F%0Afunction%20createMysql(config%2C%20app)%20%7B%0A%20%20assert(config.host%20%26%26%20config.port%20%26%26%20config.user%20%26%26%20config.database)%3B%0A%20%20%2F%2F%20create%20instance%0A%20%20const%20client%20%3D%20new%20Mysql(config)%3B%0A%0A%20%20%2F%2F%20check%20before%20start%20the%20application%0A%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20rows%20%3D%20await%20client.query('select%20now()%20as%20currentTime%3B')%3B%0A%20%20%20%20app.coreLogger.info(%60%5Begg-mysql%5D%20init%20instance%20success%2C%20rds%20currentTime%3A%20%24%7Brows%5B0%5D.currentTime%7D%60)%3B%0A%20%20%7D)%3B%0A%0A%20%20return%20client%3B%0A%7D%0A%60%60%60%0A%0AThe%20initialization%20function%20also%20support%20%60Async%20function%60%2C%20convenient%20for%20some%20special%20plugins%20that%20need%20to%20be%20asynchronous%20to%20get%20some%20configuration%20files.%0A%0A%60%60%60js%0Aasync%20function%20createMysql(config%2C%20app)%20%7B%0A%20%20%2F%2F%20get%20mysql%20configurations%20asynchronous%0A%20%20const%20mysqlConfig%20%3D%20await%20app.configManager.getMysqlConfig(config.mysql)%3B%0A%20%20assert(mysqlConfig.host%20%26%26%20mysqlConfig.port%20%26%26%20mysqlConfig.user%20%26%26%20mysqlConfig.database)%3B%0A%20%20%2F%2F%20create%20instance%0A%20%20const%20client%20%3D%20new%20Mysql(mysqlConfig)%3B%0A%0A%20%20%2F%2F%20check%20before%20start%20the%20application%0A%20%20const%20rows%20%3D%20await%20client.query('select%20now()%20as%20currentTime%3B')%3B%0A%20%20app.coreLogger.info(%60%5Begg-mysql%5D%20init%20instance%20success%2C%20rds%20currentTime%3A%20%24%7Brows%5B0%5D.currentTime%7D%60)%3B%0A%0A%20%20return%20client%3B%0A%7D%0A%60%60%60%0A%0AAs%20you%20can%20see%2C%20all%20we%20need%20to%20do%20for%20this%20plugin%20is%20passing%20in%20the%20field%20that%20need%20to%20be%20mounted%20and%20the%20corresponding%20initialization%20function.%20Framework%20will%20be%20in%20charge%20of%20managing%20all%20the%20configs%20and%20the%20ways%20to%20access%20the%20instances.%0A%0A%23%23%23%23%20Application%20Layer%20Usage%20Case%0A%0A%23%23%23%23%23%20Single%20Instance%0A%0A1.%20Declare%20MySQL%20config%20in%20config%20file%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20config%2Fconfig.default.js%0A%20%20%20%20module.exports%20%3D%20%7B%0A%20%20%20%20%20%20mysql%3A%20%7B%0A%20%20%20%20%20%20%20%20client%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20host%3A%20'mysql.com'%2C%0A%20%20%20%20%20%20%20%20%20%20port%3A%20'3306'%2C%0A%20%20%20%20%20%20%20%20%20%20user%3A%20'test_user'%2C%0A%20%20%20%20%20%20%20%20%20%20password%3A%20'test_password'%2C%0A%20%20%20%20%20%20%20%20%20%20database%3A%20'test'%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A2.%20Access%20database%20through%20%60app.mysql%60%20directly%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20app%2Fcontroller%2Fpost.js%0A%20%20%20%20class%20PostController%20extends%20Controller%20%7B%0A%20%20%20%20%20%20async%20list()%20%7B%0A%20%20%20%20%20%20%20%20const%20posts%20%3D%20await%20this.app.mysql.query(sql%2C%20values)%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D%0A%20%20%20%20%60%60%60%0A%0A%23%23%23%23%23%20Multiple%20Instances%0A%0A1.%20Of%20course%20we%20need%20to%20configure%20MySQL%20in%20the%20config%20file%2C%20but%20different%20from%20single%20instance%2C%20we%20need%20to%20add%20%20%60clients%60%20in%20the%20config%20to%20declare%20the%20configuration%20of%20different%20instances.%20meanwhile%2C%20the%20%60default%60%20field%20can%20be%20used%20to%20configure%20the%20shared%20configuration%20in%20multiple%20instances(e.g.%20host%20and%20port).%20Note%20that%20in%20this%20case%2Cshould%20use%20%60get%60%20function%20to%20specify%20the%20corresponding%20instance(eg%3A%20use%20%60app.mysql.get('db1').query()%60%20instead%20of%20using%20%60app.mysql.query()%60%20directly%20to%20get%20a%20%60undefined%60).%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20config%2Fconfig.default.js%0A%20%20%20%20exports.mysql%20%3D%20%7B%0A%20%20%20%20%20%20clients%3A%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20clientId%2C%20access%20the%20client%20instance%20by%20app.mysql.get('clientId')%0A%20%20%20%20%20%20%20%20db1%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20user%3A%20'user1'%2C%0A%20%20%20%20%20%20%20%20%20%20password%3A%20'upassword1'%2C%0A%20%20%20%20%20%20%20%20%20%20database%3A%20'db1'%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20db2%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20user%3A%20'user2'%2C%0A%20%20%20%20%20%20%20%20%20%20password%3A%20'upassword2'%2C%0A%20%20%20%20%20%20%20%20%20%20database%3A%20'db2'%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%2F%2F%20default%20configuration%20for%20all%20databases%0A%20%20%20%20%20%20default%3A%20%7B%0A%20%20%20%20%20%20%20%20host%3A%20'mysql.com'%2C%0A%20%20%20%20%20%20%20%20port%3A%20'3306'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A2.%20Access%20the%20corresponding%20instance%20by%20%60app.mysql.get('db1')%60%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20app%2Fcontroller%2Fpost.js%0A%20%20%20%20class%20PostController%20extends%20Controller%20%7B%0A%20%20%20%20%20%20async%20list()%20%7B%0A%20%20%20%20%20%20%20%20const%20posts%20%3D%20await%20this.app.mysql.get('db1').query(sql%2C%20values)%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D%0A%20%20%20%20%60%60%60%0A%0A%23%23%23%23%23%20Dynamically%20Instantiate%0A%0AInstead%20of%20declaring%20the%20configuration%20in%20the%20configuration%20file%20in%20advance%2C%20We%20can%20dynamically%20initialize%20an%20instance%20at%20the%20runtime%20of%20the%20application.%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%20get%20MySQL%20config%20from%20configuration%20center%20%7B%20host%2C%20post%2C%20password%2C%20...%20%7D%0A%20%20%20%20const%20mysqlConfig%20%3D%20await%20app.configCenter.fetch('mysql')%3B%0A%20%20%20%20%2F%2F%20create%20MySQL%20instance%20dynamically%0A%20%20%20%20app.database%20%3D%20app.mysql.createInstanceAsync(mysqlConfig)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0AAccess%20the%20instance%20through%20%60app.database%60%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fpost.js%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20list()%20%7B%0A%20%20%20%20const%20posts%20%3D%20await%20this.app.database.query(sql%2C%20values)%3B%0A%20%20%7D%2C%0A%7D%0A%60%60%60%0A%0A**Attention%2C%20when%20creating%20the%20instance%20dynamically%2C%20framework%20would%20read%20the%20%60default%60%20configuration%20in%20the%20config%20file%20as%20the%20default%20configuration**%0A%0A%23%23%23%20Plugin%20Locate%20Rule%0A%0AWhen%20loading%20the%20plugins%20in%20the%20framework%2C%20it%20will%20follow%20the%20rules%20to%20locate%20them%20as%20below%3A%0A%0A-%20If%20there%20is%20the%20path%20configuration%2C%20load%20them%20in%20path%20directly%0A-%20If%20there%20is%20no%20path%20configuration%2C%20search%20them%20with%20the%20package%20name%2C%20the%20search%20orders%20are%3A%0A%0A%20%201.%20%60node_modules%60%20directory%20of%20the%20application%20root%0A%20%202.%20%60node_modules%60%20directory%20of%20the%20dependencies%0A%20%203.%20%60node_modules%60%20of%20current%20directory(generally%20for%20unit%20test%20compatibility)%0A%0A%23%23%23%20%20Plugin%20Specification%0A%0AWe%20are%20very%20welcome%20your%20contribution%20to%20the%20new%20plugins%2C%20but%20also%20hope%20you%20follow%20some%20of%20following%20specifications%3A%0A%0A-%20Naming%20Rules%0A%20%20-%20%60npm%60%20packages%20must%20append%20prefix%20%60egg-%60%2Cand%20all%20letters%20must%20be%20lowercase%2Cfor%20example%3A%60egg-xxx%60.%20The%20long%20names%20should%20be%20concatenated%20with%20middle-lines%3A%60egg-foo-bar%60.%0A%20%20-%20The%20corresponding%20plugin%20should%20be%20named%20in%20camel-case.%20The%20name%20should%20be%20translated%20according%20to%20the%20middle-lines%20of%20the%20%60npm%60%20name%3A%60egg-foo-bar%60%20%3D%3E%20%60fooBar%60.%0A%20%20-%20The%20use%20of%20middle-lines%20is%20not%20compulsive%2Cfor%20example%3Auserservice(egg-userservice)%20and%20user-service(egg-user-service)%20are%20both%20acceptable.%0A-%20%60package.json%60%20Rules%0A%20%20-%20Add%20%60eggPlugin%60%20property%20according%20to%20the%20details%20discussed%20before.%0A%20%20-%20For%20convenient%20index%2C%20add%20%60egg%60%2C%60egg-plugin%60%2C%60eggPlugin%60%20in%20%60keywords%60.%0A%0A%20%20%20%20%60%60%60json%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%22name%22%3A%20%22egg-view-nunjucks%22%2C%0A%20%20%20%20%20%20%22version%22%3A%20%221.0.0%22%2C%0A%20%20%20%20%20%20%22description%22%3A%20%22view%20plugin%20for%20egg%22%2C%0A%20%20%20%20%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%22name%22%3A%20%22nunjucks%22%2C%0A%20%20%20%20%20%20%20%20%22dep%22%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%22security%22%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%22keywords%22%3A%20%5B%0A%20%20%20%20%20%20%20%20%22egg%22%2C%0A%20%20%20%20%20%20%20%20%22egg-plugin%22%2C%0A%20%20%20%20%20%20%20%20%22eggPlugin%22%2C%0A%20%20%20%20%20%20%20%20%22egg-plugin-view%22%2C%0A%20%20%20%20%20%20%20%20%22egg-view%22%2C%0A%20%20%20%20%20%20%20%20%22nunjucks%22%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%7D%0A%20%20%20%20%60%60%60%0A%0A%23%23%20%20Why%20do%20not%20use%20the%20npm%20package%20name%20as%20the%20plugin%20name%3F%0A%0AEgg%20defines%20the%20plugin%20name%20through%20the%20%60eggPlugin.name%60%2C%20it%20is%20only%20unique%20in%20application%20or%20framework%2C%20that%20means%20**many%20npm%20packages%20might%20get%20the%20same%20plugin%20name**%2C%20why%20design%20in%20this%20way%3F%0A%0AFirst%2C%20Egg%20plugin%20do%20not%20only%20support%20npm%20package%2C%20it%20also%20supports%20search%20plugins%20in%20local%20directory.%20In%20Chapter%20%5Bprogressive%5D(..%2Ftutorials%2Fprogressive.md)%20we%20mentioned%20how%20to%20make%20progress%20by%20using%20these%20two%20configurations.%20Directory%20is%20more%20friendly%20to%20unit%20test.%20So%2C%20Egg%20can%20not%20ensure%20uniqueness%20through%20npm%20package%20name.%0A%0AWhat's%20more%2C%20Egg%20can%20use%20this%20feature%20to%20make%20Adapter.%20For%20example%2C%20the%20plugin%20defined%20in%5BTemplate%20Develop%20Spec%5D(.%2Fview-plugin.md%23PluginNameSpecification)%20was%20named%20as%20view%2C%20but%20there%20are%20plugins%20named%20%60egg-view-nunjucks%60%20and%20%60egg-view-react%60%2C%20the%20users%20only%20need%20to%20change%20the%20plugin%20and%20modify%20the%20templates%2C%20no%20need%20to%20modify%20the%20Controller%2C%20because%20all%20these%20plugins%20have%20implemented%20the%20same%20API.%0A%0A**Giving%20the%20same%20plugin%20name%20and%20the%20same%20API%20to%20the%20same%20plugin%20can%20make%20quick%20switch%20between%20them**.%20This%20is%20really%20really%20useful%20in%20template%20and%20database.%0A%0A%5Begg-init%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-init%0A%5Begg-boilerplate-plugin%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-boilerplate-plugin%0A%5Begg-mysql%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mysql%0A%5Begg-oss%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-oss%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>