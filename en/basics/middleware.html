<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Middleware</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/en/intro/">Guide</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/en/tutorials/index.html">Tutorials</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">Plugins</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">Release</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>切换语言</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>Guide</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/index.html">What is Egg?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/quickstart.html">Quick Start</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/progressive.html">Progressive</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/migration.html">Migration to 2.x</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>Basis Function</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/structure.html">Directory Structure</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/objects.html">Built-in Objects</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/env.html">Environment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/config.html">Configuration</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/middleware.html">Middleware</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/plugin.html">Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/schedule.html">Schedule</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/extend.html">Extend</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/app-start.html">Custom Init</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>Core</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/development.html">Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/unittest.html">Unit Testing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/deployment.html">Deployment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/logger.html">Logger</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/view.html">View</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/error-handling.html">Error Handling</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/security.html">Security</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/i18n.html">i18n</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>Tutorials</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/passport.html">Passport</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/assets.html">Assets</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>Advanced</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/plugin.html">Plugin Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/framework.html">Framework</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/view-plugin.html">View Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/style-guide.html">Style Guide</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>Community</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/plugins/">Plugin List</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/contributing.html">Contributing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/resource.html">Resource</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/faq.html">FAQ</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>In <a href="../intro/egg-and-koa.md">the previous chapter</a>, we say that Egg is based on Koa, so the form of middleware in Egg is the same as in Koa, i.e. they are both based on <a href="../intro/egg-and-koa.md#midlleware">the onion model</a>.</p><h2 id="writing-middleware">Writing Middleware</h2><h3 id="how-to-write">How to write</h3><p>Let&#x27;s take a look at how to write a middleware from a simple gzip example.</p><pre><code class="language-js">const isJSON = require(&#x27;koa-is-json&#x27;);
const zlib = require(&#x27;zlib&#x27;);

async function gzip(ctx, next) {
  await next();

  // convert the response body to gzip after the completion of the execution of subsequent middleware
  let body = ctx.body;
  if (!body) return;
  if (isJSON(body)) body = JSON.stringify(body);

  // set gzip body, correct the response header
  const stream = zlib.createGzip();
  stream.end(body);
  ctx.body = stream;
  ctx.set(&#x27;Content-Encoding&#x27;, &#x27;gzip&#x27;);
}</code></pre><p>You might find that the middleware&#x27;s style in the framework is exactly the same as in Koa, yes,  any middleware in Koa can be used directly by the framework.</p><h3 id="configuration">Configuration</h3><p>Usually the middleware has its own configuration. In the framework, a complete middleware includes the configuration process. A middleware is a single file placed under <code>app/middleware</code> directory, which needs to exports a function that accepts two parameters:</p><ul><li>options: the configuration field of the middleware, <code>app.config[${middlewareName}]</code> will be passed in by the framework</li><li>app: the Application instance of current application</li></ul><p>We will do a simple optimization to the gzip middleware above, making it do gzip compression only if the body size is greater than a configured threshold. So, we need to create a new file <code>gzip.js</code> in <code>app/middleware</code> directory.</p><pre><code class="language-js">// app/middleware/gzip.js
const isJSON = require(&#x27;koa-is-json&#x27;);
const zlib = require(&#x27;zlib&#x27;);

module.exports = options =&gt; {
  return async function gzip(ctx, next) {
    await next();

    // convert the response body to gzip after the completion of the execution of subsequent middleware
    let body = ctx.body;
    if (!body) return;

    // support options.threshold
    if (options.threshold &amp;&amp; ctx.length &lt; options.threshold) return;

    if (isJSON(body)) body = JSON.stringify(body);

    // set gzip body, correct the response header
    const stream = zlib.createGzip();
    stream.end(body);
    ctx.body = stream;
    ctx.set(&#x27;Content-Encoding&#x27;, &#x27;gzip&#x27;);
  };
};</code></pre><h2 id="using-middleware">Using Middleware</h2><p>After writing middleware, we also need to mount it, there are following ways to support: </p><h3 id="using-middleware-in-application">Using Middleware in Application</h3><p>We can load customized middleware completely by configuration in the application, and decide their order.
If we need to load the gzip middleware in the above,
we can edit <code>config.default.js</code> like this:</p><pre><code class="language-js">module.exports = {
  // configure the middleware you need, which loads in the order of array
  middleware: [ &#x27;gzip&#x27; ],

  // configure the gzip middleware
  gzip: {
    threshold: 1024, // skip response body which size is less than 1K
  },
};</code></pre><p>This config will be merged to <code>app.config.appMiddleware</code> at starting up.</p><h2 id="using-middleware-in-framework-and-plugin">Using Middleware in Framework and Plugin</h2><p>Framework and Plugin don&#x27;t support to configure <code>middleware</code> in <code>config.default.js</code>, you should mount it in <code>app.js</code>:</p><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  // put to the first place to count request cost
  app.config.coreMiddleware.unshift(&#x27;report&#x27;);
};

// app/middleware/report.js
module.exports = () =&gt; {
  return async function (ctx, next) {
    const startTime = Date.now();
    await next();
    reportTime(Date.now() - startTime);
  }
};</code></pre><p>Middlewares which are defined at Application (<code>app.config.appMiddleware</code>) and Framework(<code>app.config.coreMiddleware</code>) will be merged to <code>app.middleware</code> by loader at staring up.</p><h2 id="using-middleware-in-router">Using Middleware in Router</h2><p>The middleware configured in the above ways is global, and it will process every request.</p><p>If you do want to take effect only for single route, you could just instantiate and mount it at <code>app/router.js</code>:</p><pre><code class="language-js">module.exports = app =&gt; {
  const gzip = app.middleware.gzip({ threshold: 1024 });
  app.router.get(&#x27;/needgzip&#x27;, gzip, app.controller.handler);
};</code></pre><h2 id="default-framework-middleware">Default Framework Middleware</h2><p>In addition to application layer loading middleware, the framework itself and other plugins will also load many middlewares. All the config fields of these built-in middlewares can be modified by modifying the ones with the same name in the config file, for example <a href="https://github.com/eggjs/egg/tree/master/app/middleware">Framework Built-in Plugin</a> uses a bodyParser middleware(the framework loader will change the various delimiters in the file name into the camel style), and we can add configs below in <code>config/config.default.js</code> to modify the bodyParser:</p><pre><code class="language-js">module.exports = {
  bodyParser: {
    jsonLimit: &#x27;10m&#x27;,
  },
};</code></pre><p><strong> Note: middleware loaded by the framework and plugins are loaded earlier than those loaded by the application layer, and the application-layer middleware cannot overwrite the default framework middleware. If the application layer loads customized middleware that has the same name with default framework middleware, an error will be reported on starting up. </strong></p><h2 id="use-koas-middleware">Use Koa&#x27;s Middleware</h2><p>Developer is free to use Koa Middleware, all middlewares used in Koa can be directly used in the framework too.</p><p>For example, Koa uses <a href="https://github.com/koajs/compress">koa-compress</a> in this way:</p><pre><code class="language-js">const koa = require(&#x27;koa&#x27;);
const compress = require(&#x27;koa-compress&#x27;);

const app = koa();

const options = { threshold: 2048 };
app.use(compress(options));</code></pre><p>We can load the middleware according to the framework specification like this:</p><pre><code class="language-js">// app/middleware/compress.js
// interfaces(`(options) =&gt; middleware`) exposed by koa-compress match the framework middleware requirements
module.exports = require(&#x27;koa-compress&#x27;);</code></pre><pre><code class="language-js">// config/config.default.js
module.exports = {
  middleware: [ &#x27;compress&#x27; ],
  compress: {
    threshold: 2048,
  },
};</code></pre><p>If the third-party Koa middleware do not follow the rule, then you can wrap it yourself:</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  webpack: {
    compiler: {},
    others: {},
  },
};

// app/middleware/webpack.js
const webpackMiddleware = require(&#x27;some-koa-middleware&#x27;);

module.exports = (options, app) =&gt; {
  return webpackMiddleware(options.compiler, options.others);
}</code></pre><h2 id="general-configuration">General Configuration</h2><p>These general config fields are supported by middleware loaded by the application layer and built in by the framework:</p><ul><li>enable: enable the middleware or not</li><li>match: set some rules with which only the request matches can go through this middleware</li><li>ignore: set some rules with which the request matches can&#x27;t go through this middleware</li></ul><h3 id="enable">enable</h3><p>If our application does not need default bodyParser to resolve the request body, we can configure enable for false to close it.</p><pre><code class="language-js">module.exports = {
  bodyParser: {
    enable: false,
  },
};</code></pre><h3 id="match-and-ignore">match and ignore</h3><p>match and ignore share the same parameter but do the opposite things. match and ignore cannot be configured in the same time.</p><p>If we want gzip to be used only by url requests starting with <code>/static</code>, the match config field can be set like this:</p><pre><code class="language-js">module.exports = {
  gzip: {
    match: &#x27;/static&#x27;,
  },
};</code></pre><p>match and ignore support various types of configuration ways:</p><ol><li>String: when string, it sets the prefix of a url path, and all urls starting with this prefix will be matched.</li><li>Regular expression: when regular expression, all urls satisfy this regular expression will be matched.</li><li>Function: when function, the request context will be passed to it and what it returns(true/false) determines whether the request is matched or not.</li></ol><pre><code class="language-js">module.exports = {
  gzip: {
    match(ctx) {
      // enabled on ios devices
      const reg = /iphone|ipad|ipod/i;
      return reg.test(ctx.get(&#x27;user-agent&#x27;));
    },
  },
};</code></pre></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#writing-middleware">Writing Middleware</a><ul><li><a href="#how-to-write">How to write</a></li><li><a href="#configuration">Configuration</a></li></ul></li><li><a href="#using-middleware">Using Middleware</a><ul><li><a href="#using-middleware-in-application">Using Middleware in Application</a></li></ul></li><li><a href="#using-middleware-in-framework-and-plugin">Using Middleware in Framework and Plugin</a></li><li><a href="#using-middleware-in-router">Using Middleware in Router</a></li><li><a href="#default-framework-middleware">Default Framework Middleware</a></li><li><a href="#use-koas-middleware">Use Koa&#x27;s Middleware</a></li><li><a href="#general-configuration">General Configuration</a><ul><li><a href="#enable">enable</a></li><li><a href="#match-and-ignore">match and ignore</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"en","props":{"toc":"-%20%5BWriting%20Middleware%5D(%23writing-middleware)%0A%20%20*%20%5BHow%20to%20write%5D(%23how-to-write)%0A%20%20*%20%5BConfiguration%5D(%23configuration)%0A-%20%5BUsing%20Middleware%5D(%23using-middleware)%0A%20%20*%20%5BUsing%20Middleware%20in%20Application%5D(%23using-middleware-in-application)%0A-%20%5BUsing%20Middleware%20in%20Framework%20and%20Plugin%5D(%23using-middleware-in-framework-and-plugin)%0A-%20%5BUsing%20Middleware%20in%20Router%5D(%23using-middleware-in-router)%0A-%20%5BDefault%20Framework%20Middleware%5D(%23default-framework-middleware)%0A-%20%5BUse%20Koa's%20Middleware%5D(%23use-koas-middleware)%0A-%20%5BGeneral%20Configuration%5D(%23general-configuration)%0A%20%20*%20%5Benable%5D(%23enable)%0A%20%20*%20%5Bmatch%20and%20ignore%5D(%23match-and-ignore)","meta":{"info":{"title":"Middleware"}},"content":"%0A%0A%0AIn%20%5Bthe%20previous%20chapter%5D(..%2Fintro%2Fegg-and-koa.md)%2C%20we%20say%20that%20Egg%20is%20based%20on%20Koa%2C%20so%20the%20form%20of%20middleware%20in%20Egg%20is%20the%20same%20as%20in%20Koa%2C%20i.e.%20they%20are%20both%20based%20on%20%5Bthe%20onion%20model%5D(..%2Fintro%2Fegg-and-koa.md%23midlleware).%0A%0A%23%23%20Writing%20Middleware%0A%0A%23%23%23%20How%20to%20write%0A%0ALet's%20take%20a%20look%20at%20how%20to%20write%20a%20middleware%20from%20a%20simple%20gzip%20example.%0A%0A%60%60%60js%0Aconst%20isJSON%20%3D%20require('koa-is-json')%3B%0Aconst%20zlib%20%3D%20require('zlib')%3B%0A%0Aasync%20function%20gzip(ctx%2C%20next)%20%7B%0A%20%20await%20next()%3B%0A%0A%20%20%2F%2F%20convert%20the%20response%20body%20to%20gzip%20after%20the%20completion%20of%20the%20execution%20of%20subsequent%20middleware%0A%20%20let%20body%20%3D%20ctx.body%3B%0A%20%20if%20(!body)%20return%3B%0A%20%20if%20(isJSON(body))%20body%20%3D%20JSON.stringify(body)%3B%0A%0A%20%20%2F%2F%20set%20gzip%20body%2C%20correct%20the%20response%20header%0A%20%20const%20stream%20%3D%20zlib.createGzip()%3B%0A%20%20stream.end(body)%3B%0A%20%20ctx.body%20%3D%20stream%3B%0A%20%20ctx.set('Content-Encoding'%2C%20'gzip')%3B%0A%7D%0A%60%60%60%0A%0AYou%20might%20find%20that%20the%20middleware's%20style%20in%20the%20framework%20is%20exactly%20the%20same%20as%20in%20Koa%2C%20yes%2C%20%20any%20middleware%20in%20Koa%20can%20be%20used%20directly%20by%20the%20framework.%0A%0A%23%23%23%20Configuration%0A%0AUsually%20the%20middleware%20has%20its%20own%20configuration.%20In%20the%20framework%2C%20a%20complete%20middleware%20includes%20the%20configuration%20process.%20A%20middleware%20is%20a%20single%20file%20placed%20under%20%60app%2Fmiddleware%60%20directory%2C%20which%20needs%20to%20exports%20a%20function%20that%20accepts%20two%20parameters%3A%0A%0A-%20options%3A%20the%20configuration%20field%20of%20the%20middleware%2C%20%60app.config%5B%24%7BmiddlewareName%7D%5D%60%20will%20be%20passed%20in%20by%20the%20framework%0A-%20app%3A%20the%20Application%20instance%20of%20current%20application%0A%0AWe%20will%20do%20a%20simple%20optimization%20to%20the%20gzip%20middleware%20above%2C%20making%20it%20do%20gzip%20compression%20only%20if%20the%20body%20size%20is%20greater%20than%20a%20configured%20threshold.%20So%2C%20we%20need%20to%20create%20a%20new%20file%20%60gzip.js%60%20in%20%60app%2Fmiddleware%60%20directory.%0A%0A%60%60%60js%0A%2F%2F%20app%2Fmiddleware%2Fgzip.js%0Aconst%20isJSON%20%3D%20require('koa-is-json')%3B%0Aconst%20zlib%20%3D%20require('zlib')%3B%0A%0Amodule.exports%20%3D%20options%20%3D%3E%20%7B%0A%20%20return%20async%20function%20gzip(ctx%2C%20next)%20%7B%0A%20%20%20%20await%20next()%3B%0A%0A%20%20%20%20%2F%2F%20convert%20the%20response%20body%20to%20gzip%20after%20the%20completion%20of%20the%20execution%20of%20subsequent%20middleware%0A%20%20%20%20let%20body%20%3D%20ctx.body%3B%0A%20%20%20%20if%20(!body)%20return%3B%0A%0A%20%20%20%20%2F%2F%20support%20options.threshold%0A%20%20%20%20if%20(options.threshold%20%26%26%20ctx.length%20%3C%20options.threshold)%20return%3B%0A%0A%20%20%20%20if%20(isJSON(body))%20body%20%3D%20JSON.stringify(body)%3B%0A%0A%20%20%20%20%2F%2F%20set%20gzip%20body%2C%20correct%20the%20response%20header%0A%20%20%20%20const%20stream%20%3D%20zlib.createGzip()%3B%0A%20%20%20%20stream.end(body)%3B%0A%20%20%20%20ctx.body%20%3D%20stream%3B%0A%20%20%20%20ctx.set('Content-Encoding'%2C%20'gzip')%3B%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20Using%20Middleware%0A%0AAfter%20writing%20middleware%2C%20we%20also%20need%20to%20mount%20it%2C%20there%20are%20following%20ways%20to%20support%3A%20%0A%0A%23%23%23%20Using%20Middleware%20in%20Application%0A%0AWe%20can%20load%20customized%20middleware%20completely%20by%20configuration%20in%20the%20application%2C%20and%20decide%20their%20order.%0AIf%20we%20need%20to%20load%20the%20gzip%20middleware%20in%20the%20above%2C%0Awe%20can%20edit%20%60config.default.js%60%20like%20this%3A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20%2F%2F%20configure%20the%20middleware%20you%20need%2C%20which%20loads%20in%20the%20order%20of%20array%0A%20%20middleware%3A%20%5B%20'gzip'%20%5D%2C%0A%0A%20%20%2F%2F%20configure%20the%20gzip%20middleware%0A%20%20gzip%3A%20%7B%0A%20%20%20%20threshold%3A%201024%2C%20%2F%2F%20skip%20response%20body%20which%20size%20is%20less%20than%201K%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0AThis%20config%20will%20be%20merged%20to%20%60app.config.appMiddleware%60%20at%20starting%20up.%0A%0A%23%23%20Using%20Middleware%20in%20Framework%20and%20Plugin%0A%0AFramework%20and%20Plugin%20don't%20support%20to%20configure%20%60middleware%60%20in%20%60config.default.js%60%2C%20you%20should%20mount%20it%20in%20%60app.js%60%3A%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%2F%2F%20put%20to%20the%20first%20place%20to%20count%20request%20cost%0A%20%20app.config.coreMiddleware.unshift('report')%3B%0A%7D%3B%0A%0A%2F%2F%20app%2Fmiddleware%2Freport.js%0Amodule.exports%20%3D%20()%20%3D%3E%20%7B%0A%20%20return%20async%20function%20(ctx%2C%20next)%20%7B%0A%20%20%20%20const%20startTime%20%3D%20Date.now()%3B%0A%20%20%20%20await%20next()%3B%0A%20%20%20%20reportTime(Date.now()%20-%20startTime)%3B%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0AMiddlewares%20which%20are%20defined%20at%20Application%20(%60app.config.appMiddleware%60)%20and%20Framework(%60app.config.coreMiddleware%60)%20will%20be%20merged%20to%20%60app.middleware%60%20by%20loader%20at%20staring%20up.%0A%0A%23%23%20Using%20Middleware%20in%20Router%0A%0AThe%20middleware%20configured%20in%20the%20above%20ways%20is%20global%2C%20and%20it%20will%20process%20every%20request.%0A%0AIf%20you%20do%20want%20to%20take%20effect%20only%20for%20single%20route%2C%20you%20could%20just%20instantiate%20and%20mount%20it%20at%20%60app%2Frouter.js%60%3A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20gzip%20%3D%20app.middleware.gzip(%7B%20threshold%3A%201024%20%7D)%3B%0A%20%20app.router.get('%2Fneedgzip'%2C%20gzip%2C%20app.controller.handler)%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20Default%20Framework%20Middleware%0A%0AIn%20addition%20to%20application%20layer%20loading%20middleware%2C%20the%20framework%20itself%20and%20other%20plugins%20will%20also%20load%20many%20middlewares.%20All%20the%20config%20fields%20of%20these%20built-in%20middlewares%20can%20be%20modified%20by%20modifying%20the%20ones%20with%20the%20same%20name%20in%20the%20config%20file%2C%20for%20example%20%5BFramework%20Built-in%20Plugin%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg%2Ftree%2Fmaster%2Fapp%2Fmiddleware)%20uses%20a%20bodyParser%20middleware(the%20framework%20loader%20will%20change%20the%20various%20delimiters%20in%20the%20file%20name%20into%20the%20camel%20style)%2C%20and%20we%20can%20add%20configs%20below%20in%20%60config%2Fconfig.default.js%60%20to%20modify%20the%20bodyParser%3A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20bodyParser%3A%20%7B%0A%20%20%20%20jsonLimit%3A%20'10m'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A**%20Note%3A%20middleware%20loaded%20by%20the%20framework%20and%20plugins%20are%20loaded%20earlier%20than%20those%20loaded%20by%20the%20application%20layer%2C%20and%20the%20application-layer%20middleware%20cannot%20overwrite%20the%20default%20framework%20middleware.%20If%20the%20application%20layer%20loads%20customized%20middleware%20that%20has%20the%20same%20name%20with%20default%20framework%20middleware%2C%20an%20error%20will%20be%20reported%20on%20starting%20up.%20**%0A%0A%0A%23%23%20Use%20Koa's%20Middleware%0A%0ADeveloper%20is%20free%20to%20use%20Koa%20Middleware%2C%20all%20middlewares%20used%20in%20Koa%20can%20be%20directly%20used%20in%20the%20framework%20too.%0A%0AFor%20example%2C%20Koa%20uses%20%5Bkoa-compress%5D(https%3A%2F%2Fgithub.com%2Fkoajs%2Fcompress)%20in%20this%20way%3A%0A%0A%60%60%60js%0Aconst%20koa%20%3D%20require('koa')%3B%0Aconst%20compress%20%3D%20require('koa-compress')%3B%0A%0Aconst%20app%20%3D%20koa()%3B%0A%0Aconst%20options%20%3D%20%7B%20threshold%3A%202048%20%7D%3B%0Aapp.use(compress(options))%3B%0A%60%60%60%0A%0AWe%20can%20load%20the%20middleware%20according%20to%20the%20framework%20specification%20like%20this%3A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fmiddleware%2Fcompress.js%0A%2F%2F%20interfaces(%60(options)%20%3D%3E%20middleware%60)%20exposed%20by%20koa-compress%20match%20the%20framework%20middleware%20requirements%0Amodule.exports%20%3D%20require('koa-compress')%3B%0A%60%60%60%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20middleware%3A%20%5B%20'compress'%20%5D%2C%0A%20%20compress%3A%20%7B%0A%20%20%20%20threshold%3A%202048%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0AIf%20the%20third-party%20Koa%20middleware%20do%20not%20follow%20the%20rule%2C%20then%20you%20can%20wrap%20it%20yourself%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20webpack%3A%20%7B%0A%20%20%20%20compiler%3A%20%7B%7D%2C%0A%20%20%20%20others%3A%20%7B%7D%2C%0A%20%20%7D%2C%0A%7D%3B%0A%0A%2F%2F%20app%2Fmiddleware%2Fwebpack.js%0Aconst%20webpackMiddleware%20%3D%20require('some-koa-middleware')%3B%0A%0Amodule.exports%20%3D%20(options%2C%20app)%20%3D%3E%20%7B%0A%20%20return%20webpackMiddleware(options.compiler%2C%20options.others)%3B%0A%7D%0A%60%60%60%0A%0A%23%23%20General%20Configuration%0A%0AThese%20general%20config%20fields%20are%20supported%20by%20middleware%20loaded%20by%20the%20application%20layer%20and%20built%20in%20by%20the%20framework%3A%0A%0A-%20enable%3A%20enable%20the%20middleware%20or%20not%0A-%20match%3A%20set%20some%20rules%20with%20which%20only%20the%20request%20matches%20can%20go%20through%20this%20middleware%0A-%20ignore%3A%20set%20some%20rules%20with%20which%20the%20request%20matches%20can't%20go%20through%20this%20middleware%0A%0A%23%23%23%20enable%0A%0AIf%20our%20application%20does%20not%20need%20default%20bodyParser%20to%20resolve%20the%20request%20body%2C%20we%20can%20configure%20enable%20for%20false%20to%20close%20it.%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20bodyParser%3A%20%7B%0A%20%20%20%20enable%3A%20false%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20match%20and%20ignore%0A%0Amatch%20and%20ignore%20share%20the%20same%20parameter%20but%20do%20the%20opposite%20things.%20match%20and%20ignore%20cannot%20be%20configured%20in%20the%20same%20time.%0A%0AIf%20we%20want%20gzip%20to%20be%20used%20only%20by%20url%20requests%20starting%20with%20%60%2Fstatic%60%2C%20the%20match%20config%20field%20can%20be%20set%20like%20this%3A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20gzip%3A%20%7B%0A%20%20%20%20match%3A%20'%2Fstatic'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0Amatch%20and%20ignore%20support%20various%20types%20of%20configuration%20ways%3A%0A%0A1.%20String%3A%20when%20string%2C%20it%20sets%20the%20prefix%20of%20a%20url%20path%2C%20and%20all%20urls%20starting%20with%20this%20prefix%20will%20be%20matched.%0A2.%20Regular%20expression%3A%20when%20regular%20expression%2C%20all%20urls%20satisfy%20this%20regular%20expression%20will%20be%20matched.%0A3.%20Function%3A%20when%20function%2C%20the%20request%20context%20will%20be%20passed%20to%20it%20and%20what%20it%20returns(true%2Ffalse)%20determines%20whether%20the%20request%20is%20matched%20or%20not.%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20gzip%3A%20%7B%0A%20%20%20%20match(ctx)%20%7B%0A%20%20%20%20%20%20%2F%2F%20enabled%20on%20ios%20devices%0A%20%20%20%20%20%20const%20reg%20%3D%20%2Fiphone%7Cipad%7Cipod%2Fi%3B%0A%20%20%20%20%20%20return%20reg.test(ctx.get('user-agent'))%3B%0A%20%20%20%20%7D%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>