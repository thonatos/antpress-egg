<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Scheduled Tasks</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/en/intro/">Guide</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/en/tutorials/index.html">Tutorials</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">Plugins</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">Release</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>切换语言</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>Guide</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/index.html">What is Egg?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/quickstart.html">Quick Start</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/progressive.html">Progressive</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/migration.html">Migration to 2.x</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>Basis Function</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/structure.html">Directory Structure</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/objects.html">Built-in Objects</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/env.html">Environment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/config.html">Configuration</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/middleware.html">Middleware</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/plugin.html">Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/schedule.html">Schedule</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/extend.html">Extend</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/app-start.html">Custom Init</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>Core</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/development.html">Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/unittest.html">Unit Testing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/deployment.html">Deployment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/logger.html">Logger</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/view.html">View</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/error-handling.html">Error Handling</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/security.html">Security</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/i18n.html">i18n</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>Tutorials</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/passport.html">Passport</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/assets.html">Assets</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>Advanced</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/plugin.html">Plugin Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/framework.html">Framework</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/view-plugin.html">View Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/style-guide.html">Style Guide</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>Community</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/plugins/">Plugin List</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/contributing.html">Contributing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/resource.html">Resource</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/faq.html">FAQ</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>Although the HTTP Server we developed using the framework is a request-response model, there are still many scenarios that need to execute some scheduled tasks, for example:</p><ol><li>Regularly report server application status.</li><li>Regularly update the local cache from the remote interface.</li><li>Regularly split files, delete temporary files.</li></ol><p>The framework provides a mechanism to make the development and maintenance of scheduled tasks more elegant.</p><h2 id="develop-scheduled-tasks">Develop Scheduled Tasks</h2><p>All scheduled tasks should be placed in directory <code>app/schedule</code>. Each file is an independent scheduled task that could configure the properties and the detail methods to be executed.</p><p>A simple example, to define a scheduled task to update the remote data to the memory cache, we can create a <code>update_cache.js</code> file in the directory &#x27;app/schedule`</p><pre><code class="language-js">const Subscription = require(&#x27;egg&#x27;).Subscription;

class UpdateCache extends Subscription {
  // using `schedule` property to set the scheduled task execution interval and other configurations
  static get schedule() {
    return {
      interval: &#x27;1m&#x27;, // 1 minute interval
      type: &#x27;all&#x27;, // specify all `workers` need to execute
    };
  }

  // `subscribe` is the function to be executed when the scheduled task is triggered
  async subscribe() {
    const res = await this.ctx.curl(&#x27;http://www.api.com/cache&#x27;, {
      dataType: &#x27;json&#x27;,
    });
    this.ctx.app.cache = res.data;
  }
}

module.exports = UpdateCache;</code></pre><p>Can also be abbreviated as</p><pre><code class="language-js">module.exports = {
  schedule: {
    interval: &#x27;1m&#x27;, // 1 minute interval
    type: &#x27;all&#x27;, // specify all `workers` need to execute
  },
  async task(ctx) {
    const res = await ctx.curl(&#x27;http://www.api.com/cache&#x27;, {
      dataType: &#x27;json&#x27;,
    });
    ctx.app.cache = res.data;
  },
};</code></pre><p>This scheduled task will be executed every 1 minute on every worker process, the requested remote data will be mounted back to <code>app.cache</code>.</p><h3 id="task">Task</h3><ul><li><code>task</code> or <code>subscribe</code> is compatible with <code>generator function</code> and <code>async function</code>.</li><li>The parameter of <code>task</code> is <code>ctx</code>, anonymous Context instance, we could call <code>service</code> and others via it.</li></ul><h3 id="schedule-mode">Schedule Mode</h3><p>Schedule tasks can specify <code>interval</code> or <code>cron</code> two different schedule modes.</p><h4 id="interval">interval</h4><p>Configure the scheduled tasks by <code>schedule.interval</code>, scheduled tasks will be executed every specified time interval. <code>interval</code> can be configured as</p><ul><li>Integer type, the unit is milliseconds, e.g <code>5000</code>.</li><li>String type, will be transformed to milliseconds by <a href="https://github.com/zeit/ms">ms</a>, e.g <code>5s</code>.</li></ul><pre><code class="language-js">module.exports = {
  schedule: {
    // executed every 10 seconds
    interval: &#x27;10s&#x27;,
  },
};</code></pre><h4 id="cron">cron</h4><p>Configure the scheduled tasks by <code>schedule.cron</code>, scheduled tasks will be executed at specified timing according to the cron expressions. cron expressions are parsed by <a href="https://github.com/harrisiirak/cron-parser">cron-parser</a>.</p><p><strong>Note: cron-parser supports second (which don&#x27;t support by linux crontab).</strong></p><pre><code class="language-bash">*    *    *    *    *    *
┬    ┬    ┬    ┬    ┬    ┬
│    │    │    │    │    |
│    │    │    │    │    └ day of week (0 - 7) (0 or 7 is Sun)
│    │    │    │    └───── month (1 - 12)
│    │    │    └────────── day of month (1 - 31)
│    │    └─────────────── hour (0 - 23)
│    └──────────────────── minute (0 - 59)
└───────────────────────── second (0 - 59, optional)</code></pre><pre><code class="language-js">module.exports = {
  schedule: {
    // executed every three hours (zero minutes and zero seconds)
    cron: &#x27;0 0 */3 * * *&#x27;,
  },
};</code></pre><h3 id="type">Type</h3><p>The framework scheduled tasks support two types by default, worker and all. Both worker and all support the above two schedule modes, except when it comes time to execute, the worker who executes the scheduled tasks is different:</p><ul><li><code>worker</code> type: only one worker per machine executes this scheduled task, the worker to execute is random.</li><li><code>all</code> type: each worker on each machine executes this scheduled task.</li></ul><h3 id="other-parameters">Other Parameters</h3><p>In addition to the parameters just introduced, scheduled task also supports these parameters:</p><ul><li><code>cronOptions</code>: configure cron time zone and so on, reference <a href="https://github.com/harrisiirak/cron-parser#options">cron-parser</a></li><li><code>immediate</code>: when this parameter is set to true, this scheduled task will be executed immediately after the application is started and ready.</li><li><code>disable</code>: when this parameter is set to true, this scheduled task will not be executed.</li><li><code>env</code>: env list to decide whether start this task at current env.</li></ul><h3 id="logging">Logging</h3><p>Schedule log will be written to <code>${appInfo.root}/logs/{app_name}/egg-schedule.log</code>, but won&#x27;t be logged to terminal by default, you could customize via <code>config.customLogger.scheduleLogger</code>.</p><pre><code class="language-js">// config/config.default.js
config.customLogger = {
  scheduleLogger: {
    // consoleLevel: &#x27;NONE&#x27;,
    // file: path.join(appInfo.root, &#x27;logs&#x27;, appInfo.name, &#x27;egg-schedule.log&#x27;),
  },
};</code></pre><h3 id="dynamically-configure-scheduled-tasks">Dynamically Configure Scheduled Tasks</h3><p>Sometimes we need to configure the parameters of scheduled tasks. Scheduled tasks support another development style:</p><pre><code class="language-js">module.exports = app =&gt; {
  return {
    schedule: {
      interval: app.config.cacheTick,
      type: &#x27;all&#x27;,
    },
    async task(ctx) {
      const res = await ctx.curl(&#x27;http://www.api.com/cache&#x27;, {
        contentType: &#x27;json&#x27;,
      });
      ctx.app.cache = res.data;
    },
  };
};</code></pre><h2 id="manually-execute-scheduled-tasks">Manually Execute Scheduled Tasks</h2><p>We can run a scheduled task via <code>app.runSchedule(schedulePath)</code>. <code>app.runSchedule</code> reads a scheduled task file path (either a relative path in <code>app/schedule</code> or a complete absolute path), executes the corresponding scheduled task, and returns a Promise.</p><p>There are some scenarios we may need to manually execute scheduled tasks, for example</p><ul><li>Executing scheduled tasks manually for more elegant unit testing of scheduled tasks.</li></ul><pre><code class="language-js">const mm = require(&#x27;egg-mock&#x27;);
const assert = require(&#x27;assert&#x27;);

it(&#x27;should schedule work fine&#x27;, async () =&gt; {
  const app = mm.app();
  await app.ready();
  await app.runSchedule(&#x27;update_cache&#x27;);
  assert(app.cache);
});</code></pre><p>When the application starts up, manually perform the scheduled tasks for system initialization, waiting for the initialization finished and then starting the application. See chapter <a href="./app-start.md">Application Startup Configuration</a>, we can implement initialization logic in <code>app.js</code>.</p><pre><code class="language-js">module.exports = app =&gt; {
  app.beforeStart(async () =&gt; {
    // ensure the data is ready before the application starts listening port
    // follow-up data updates automatically by the scheduled task
    await app.runSchedule(&#x27;update_cache&#x27;);
  });
};</code></pre><h2 id="extend-scheduled-task-type">Extend Scheduled Task Type</h2><p>The framework scheduled tasks only support single worker execution and all worker execution, in some cases, our services are not deployed on a single machine, one of the worker processes in the cluster may execute a scheduled task.</p><p>The framework does not provide this functionality directly, but developers can extend the new type of scheduled tasks themselves in the upper framework.</p><p>Inherit <code>agent.ScheduleStrategy</code> in <code>agent.js</code> and register it with <code>agent.schedule.use()</code>:</p><pre><code class="language-js">module.exports = agent =&gt; {
  class ClusterStrategy extends agent.ScheduleStrategy {
    start() {
      // subscribe other distributed scheduling service message, after receiving the message, allow a worker process to execute scheduled tasks
      // the user configures the distributed scheduling scenario in the configuration of the scheduled task
      agent.mq.subscribe(schedule.scene, () =&gt; this.sendOne());
    }
  }
  agent.schedule.use(&#x27;cluster&#x27;, ClusterStrategy);
};</code></pre><p><code>ScheduleStrategy</code> base class provides:</p><ul><li><code>schedule</code> - Properties of schedule tasks, <code>disable</code> is supported by default, other configurations can be parsed by developers.</li><li><code>this.sendOne(...args)</code> - Notice worker to execute the task randomly, <code>args</code> will pass to <code>subscribe(...args)</code> or <code>task(ctx, ...args)</code>.</li><li><code>this.sendAll(...args)</code> - Notice all worker to execute the task.</li></ul></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#develop-scheduled-tasks">Develop Scheduled Tasks</a><ul><li><a href="#task">Task</a></li><li><a href="#schedule-mode">Schedule Mode</a><ul><li><a href="#interval">interval</a></li><li><a href="#cron">cron</a></li></ul></li><li><a href="#type">Type</a></li><li><a href="#other-parameters">Other Parameters</a></li><li><a href="#logging">Logging</a></li><li><a href="#dynamically-configure-scheduled-tasks">Dynamically Configure Scheduled Tasks</a></li></ul></li><li><a href="#manually-execute-scheduled-tasks">Manually Execute Scheduled Tasks</a></li><li><a href="#extend-scheduled-task-type">Extend Scheduled Task Type</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"en","props":{"toc":"-%20%5BDevelop%20Scheduled%20Tasks%5D(%23develop-scheduled-tasks)%0A%20%20*%20%5BTask%5D(%23task)%0A%20%20*%20%5BSchedule%20Mode%5D(%23schedule-mode)%0A%20%20%20%20%2B%20%5Binterval%5D(%23interval)%0A%20%20%20%20%2B%20%5Bcron%5D(%23cron)%0A%20%20*%20%5BType%5D(%23type)%0A%20%20*%20%5BOther%20Parameters%5D(%23other-parameters)%0A%20%20*%20%5BLogging%5D(%23logging)%0A%20%20*%20%5BDynamically%20Configure%20Scheduled%20Tasks%5D(%23dynamically-configure-scheduled-tasks)%0A-%20%5BManually%20Execute%20Scheduled%20Tasks%5D(%23manually-execute-scheduled-tasks)%0A-%20%5BExtend%20Scheduled%20Task%20Type%5D(%23extend-scheduled-task-type)","meta":{"info":{"title":"Scheduled Tasks"}},"content":"%0A%0A%0AAlthough%20the%20HTTP%20Server%20we%20developed%20using%20the%20framework%20is%20a%20request-response%20model%2C%20there%20are%20still%20many%20scenarios%20that%20need%20to%20execute%20some%20scheduled%20tasks%2C%20for%20example%3A%0A%0A1.%20Regularly%20report%20server%20application%20status.%0A1.%20Regularly%20update%20the%20local%20cache%20from%20the%20remote%20interface.%0A1.%20Regularly%20split%20files%2C%20delete%20temporary%20files.%0A%0AThe%20framework%20provides%20a%20mechanism%20to%20make%20the%20development%20and%20maintenance%20of%20scheduled%20tasks%20more%20elegant.%0A%0A%23%23%20Develop%20Scheduled%20Tasks%0A%0AAll%20scheduled%20tasks%20should%20be%20placed%20in%20directory%20%60app%2Fschedule%60.%20Each%20file%20is%20an%20independent%20scheduled%20task%20that%20could%20configure%20the%20properties%20and%20the%20detail%20methods%20to%20be%20executed.%0A%0AA%20simple%20example%2C%20to%20define%20a%20scheduled%20task%20to%20update%20the%20remote%20data%20to%20the%20memory%20cache%2C%20we%20can%20create%20a%20%60update_cache.js%60%20file%20in%20the%20directory%20'app%2Fschedule%60%0A%0A%60%60%60js%0Aconst%20Subscription%20%3D%20require('egg').Subscription%3B%0A%0Aclass%20UpdateCache%20extends%20Subscription%20%7B%0A%20%20%2F%2F%20using%20%60schedule%60%20property%20to%20set%20the%20scheduled%20task%20execution%20interval%20and%20other%20configurations%0A%20%20static%20get%20schedule()%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20interval%3A%20'1m'%2C%20%2F%2F%201%20minute%20interval%0A%20%20%20%20%20%20type%3A%20'all'%2C%20%2F%2F%20specify%20all%20%60workers%60%20need%20to%20execute%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20%60subscribe%60%20is%20the%20function%20to%20be%20executed%20when%20the%20scheduled%20task%20is%20triggered%0A%20%20async%20subscribe()%20%7B%0A%20%20%20%20const%20res%20%3D%20await%20this.ctx.curl('http%3A%2F%2Fwww.api.com%2Fcache'%2C%20%7B%0A%20%20%20%20%20%20dataType%3A%20'json'%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20this.ctx.app.cache%20%3D%20res.data%3B%0A%20%20%7D%0A%7D%0A%0Amodule.exports%20%3D%20UpdateCache%3B%0A%60%60%60%0A%0ACan%20also%20be%20abbreviated%20as%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20schedule%3A%20%7B%0A%20%20%20%20interval%3A%20'1m'%2C%20%2F%2F%201%20minute%20interval%0A%20%20%20%20type%3A%20'all'%2C%20%2F%2F%20specify%20all%20%60workers%60%20need%20to%20execute%0A%20%20%7D%2C%0A%20%20async%20task(ctx)%20%7B%0A%20%20%20%20const%20res%20%3D%20await%20ctx.curl('http%3A%2F%2Fwww.api.com%2Fcache'%2C%20%7B%0A%20%20%20%20%20%20dataType%3A%20'json'%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20ctx.app.cache%20%3D%20res.data%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0AThis%20scheduled%20task%20will%20be%20executed%20every%201%20minute%20on%20every%20worker%20process%2C%20the%20requested%20remote%20data%20will%20be%20mounted%20back%20to%20%60app.cache%60.%0A%0A%23%23%23%20Task%0A%0A-%20%60task%60%20or%20%60subscribe%60%20is%20compatible%20with%20%60generator%20function%60%20and%20%60async%20function%60.%0A-%20The%20parameter%20of%20%60task%60%20is%20%60ctx%60%2C%20anonymous%20Context%20instance%2C%20we%20could%20call%20%60service%60%20and%20others%20via%20it.%0A%0A%23%23%23%20Schedule%20Mode%0A%0ASchedule%20tasks%20can%20specify%20%60interval%60%20or%20%60cron%60%20two%20different%20schedule%20modes.%0A%0A%23%23%23%23%20interval%0A%0AConfigure%20the%20scheduled%20tasks%20by%20%60schedule.interval%60%2C%20scheduled%20tasks%20will%20be%20executed%20every%20specified%20time%20interval.%20%60interval%60%20can%20be%20configured%20as%0A%0A-%20Integer%20type%2C%20the%20unit%20is%20milliseconds%2C%20e.g%20%605000%60.%0A-%20String%20type%2C%20will%20be%20transformed%20to%20milliseconds%20by%20%5Bms%5D(https%3A%2F%2Fgithub.com%2Fzeit%2Fms)%2C%20e.g%20%605s%60.%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20schedule%3A%20%7B%0A%20%20%20%20%2F%2F%20executed%20every%2010%20seconds%0A%20%20%20%20interval%3A%20'10s'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%23%20cron%0A%0AConfigure%20the%20scheduled%20tasks%20by%20%60schedule.cron%60%2C%20scheduled%20tasks%20will%20be%20executed%20at%20specified%20timing%20according%20to%20the%20cron%20expressions.%20cron%20expressions%20are%20parsed%20by%20%5Bcron-parser%5D(https%3A%2F%2Fgithub.com%2Fharrisiirak%2Fcron-parser).%0A%0A**Note%3A%20cron-parser%20supports%20second%20(which%20don't%20support%20by%20linux%20crontab).**%0A%0A%60%60%60bash%0A*%20%20%20%20*%20%20%20%20*%20%20%20%20*%20%20%20%20*%20%20%20%20*%0A%E2%94%AC%20%20%20%20%E2%94%AC%20%20%20%20%E2%94%AC%20%20%20%20%E2%94%AC%20%20%20%20%E2%94%AC%20%20%20%20%E2%94%AC%0A%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%7C%0A%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%94%20day%20of%20week%20(0%20-%207)%20(0%20or%207%20is%20Sun)%0A%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%20month%20(1%20-%2012)%0A%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%20day%20of%20month%20(1%20-%2031)%0A%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%20hour%20(0%20-%2023)%0A%E2%94%82%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%20minute%20(0%20-%2059)%0A%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%20second%20(0%20-%2059%2C%20optional)%0A%60%60%60%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20schedule%3A%20%7B%0A%20%20%20%20%2F%2F%20executed%20every%20three%20hours%20(zero%20minutes%20and%20zero%20seconds)%0A%20%20%20%20cron%3A%20'0%200%20*%2F3%20*%20*%20*'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20Type%0A%0AThe%20framework%20scheduled%20tasks%20support%20two%20types%20by%20default%2C%20worker%20and%20all.%20Both%20worker%20and%20all%20support%20the%20above%20two%20schedule%20modes%2C%20except%20when%20it%20comes%20time%20to%20execute%2C%20the%20worker%20who%20executes%20the%20scheduled%20tasks%20is%20different%3A%0A%0A-%20%60worker%60%20type%3A%20only%20one%20worker%20per%20machine%20executes%20this%20scheduled%20task%2C%20the%20worker%20to%20execute%20is%20random.%0A-%20%60all%60%20type%3A%20each%20worker%20on%20each%20machine%20executes%20this%20scheduled%20task.%0A%0A%23%23%23%20Other%20Parameters%0A%0AIn%20addition%20to%20the%20parameters%20just%20introduced%2C%20scheduled%20task%20also%20supports%20these%20parameters%3A%0A%0A-%20%60cronOptions%60%3A%20configure%20cron%20time%20zone%20and%20so%20on%2C%20reference%20%5Bcron-parser%5D(https%3A%2F%2Fgithub.com%2Fharrisiirak%2Fcron-parser%23options)%0A-%20%60immediate%60%3A%20when%20this%20parameter%20is%20set%20to%20true%2C%20this%20scheduled%20task%20will%20be%20executed%20immediately%20after%20the%20application%20is%20started%20and%20ready.%0A-%20%60disable%60%3A%20when%20this%20parameter%20is%20set%20to%20true%2C%20this%20scheduled%20task%20will%20not%20be%20executed.%0A-%20%60env%60%3A%20env%20list%20to%20decide%20whether%20start%20this%20task%20at%20current%20env.%0A%0A%23%23%23%20Logging%0A%0ASchedule%20log%20will%20be%20written%20to%20%60%24%7BappInfo.root%7D%2Flogs%2F%7Bapp_name%7D%2Fegg-schedule.log%60%2C%20but%20won't%20be%20logged%20to%20terminal%20by%20default%2C%20you%20could%20customize%20via%20%60config.customLogger.scheduleLogger%60.%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Aconfig.customLogger%20%3D%20%7B%0A%20%20scheduleLogger%3A%20%7B%0A%20%20%20%20%2F%2F%20consoleLevel%3A%20'NONE'%2C%0A%20%20%20%20%2F%2F%20file%3A%20path.join(appInfo.root%2C%20'logs'%2C%20appInfo.name%2C%20'egg-schedule.log')%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20Dynamically%20Configure%20Scheduled%20Tasks%0A%0ASometimes%20we%20need%20to%20configure%20the%20parameters%20of%20scheduled%20tasks.%20Scheduled%20tasks%20support%20another%20development%20style%3A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20return%20%7B%0A%20%20%20%20schedule%3A%20%7B%0A%20%20%20%20%20%20interval%3A%20app.config.cacheTick%2C%0A%20%20%20%20%20%20type%3A%20'all'%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20async%20task(ctx)%20%7B%0A%20%20%20%20%20%20const%20res%20%3D%20await%20ctx.curl('http%3A%2F%2Fwww.api.com%2Fcache'%2C%20%7B%0A%20%20%20%20%20%20%20%20contentType%3A%20'json'%2C%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20ctx.app.cache%20%3D%20res.data%3B%0A%20%20%20%20%7D%2C%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20Manually%20Execute%20Scheduled%20Tasks%0A%0AWe%20can%20run%20a%20scheduled%20task%20via%20%60app.runSchedule(schedulePath)%60.%20%60app.runSchedule%60%20reads%20a%20scheduled%20task%20file%20path%20(either%20a%20relative%20path%20in%20%60app%2Fschedule%60%20or%20a%20complete%20absolute%20path)%2C%20executes%20the%20corresponding%20scheduled%20task%2C%20and%20returns%20a%20Promise.%0A%0AThere%20are%20some%20scenarios%20we%20may%20need%20to%20manually%20execute%20scheduled%20tasks%2C%20for%20example%0A%0A-%20Executing%20scheduled%20tasks%20manually%20for%20more%20elegant%20unit%20testing%20of%20scheduled%20tasks.%0A%0A%60%60%60js%0Aconst%20mm%20%3D%20require('egg-mock')%3B%0Aconst%20assert%20%3D%20require('assert')%3B%0A%0Ait('should%20schedule%20work%20fine'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20const%20app%20%3D%20mm.app()%3B%0A%20%20await%20app.ready()%3B%0A%20%20await%20app.runSchedule('update_cache')%3B%0A%20%20assert(app.cache)%3B%0A%7D)%3B%0A%60%60%60%0A%0AWhen%20the%20application%20starts%20up%2C%20manually%20perform%20the%20scheduled%20tasks%20for%20system%20initialization%2C%20waiting%20for%20the%20initialization%20finished%20and%20then%20starting%20the%20application.%20See%20chapter%20%5BApplication%20Startup%20Configuration%5D(.%2Fapp-start.md)%2C%20we%20can%20implement%20initialization%20logic%20in%20%60app.js%60.%0A%0A%60%60%60js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20ensure%20the%20data%20is%20ready%20before%20the%20application%20starts%20listening%20port%0A%20%20%20%20%2F%2F%20follow-up%20data%20updates%20automatically%20by%20the%20scheduled%20task%0A%20%20%20%20await%20app.runSchedule('update_cache')%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20Extend%20Scheduled%20Task%20Type%0A%0AThe%20framework%20scheduled%20tasks%20only%20support%20single%20worker%20execution%20and%20all%20worker%20execution%2C%20in%20some%20cases%2C%20our%20services%20are%20not%20deployed%20on%20a%20single%20machine%2C%20one%20of%20the%20worker%20processes%20in%20the%20cluster%20may%20execute%20a%20scheduled%20task.%0A%0AThe%20framework%20does%20not%20provide%20this%20functionality%20directly%2C%20but%20developers%20can%20extend%20the%20new%20type%20of%20scheduled%20tasks%20themselves%20in%20the%20upper%20framework.%0A%0AInherit%20%60agent.ScheduleStrategy%60%20in%20%60agent.js%60%20and%20register%20it%20with%20%60agent.schedule.use()%60%3A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20agent%20%3D%3E%20%7B%0A%20%20class%20ClusterStrategy%20extends%20agent.ScheduleStrategy%20%7B%0A%20%20%20%20start()%20%7B%0A%20%20%20%20%20%20%2F%2F%20subscribe%20other%20distributed%20scheduling%20service%20message%2C%20after%20receiving%20the%20message%2C%20allow%20a%20worker%20process%20to%20execute%20scheduled%20tasks%0A%20%20%20%20%20%20%2F%2F%20the%20user%20configures%20the%20distributed%20scheduling%20scenario%20in%20the%20configuration%20of%20the%20scheduled%20task%0A%20%20%20%20%20%20agent.mq.subscribe(schedule.scene%2C%20()%20%3D%3E%20this.sendOne())%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20agent.schedule.use('cluster'%2C%20ClusterStrategy)%3B%0A%7D%3B%0A%60%60%60%0A%0A%60ScheduleStrategy%60%20base%20class%20provides%3A%0A%0A-%20%60schedule%60%20-%20Properties%20of%20schedule%20tasks%2C%20%60disable%60%20is%20supported%20by%20default%2C%20other%20configurations%20can%20be%20parsed%20by%20developers.%0A-%20%60this.sendOne(...args)%60%20-%20Notice%20worker%20to%20execute%20the%20task%20randomly%2C%20%60args%60%20will%20pass%20to%20%60subscribe(...args)%60%20or%20%60task(ctx%2C%20...args)%60.%0A-%20%60this.sendAll(...args)%60%20-%20Notice%20all%20worker%20to%20execute%20the%20task.%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>