<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Egg and Koa</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/en/intro/">Guide</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/en/tutorials/index.html">Tutorials</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">Plugins</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">Release</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>切换语言</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>Guide</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/index.html">What is Egg?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/quickstart.html">Quick Start</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/progressive.html">Progressive</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/migration.html">Migration to 2.x</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>Basis Function</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/structure.html">Directory Structure</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/objects.html">Built-in Objects</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/env.html">Environment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/config.html">Configuration</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/middleware.html">Middleware</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/plugin.html">Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/schedule.html">Schedule</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/extend.html">Extend</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/app-start.html">Custom Init</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>Core</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/development.html">Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/unittest.html">Unit Testing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/deployment.html">Deployment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/logger.html">Logger</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/view.html">View</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/error-handling.html">Error Handling</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/security.html">Security</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/i18n.html">i18n</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>Tutorials</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/passport.html">Passport</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/assets.html">Assets</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>Advanced</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/plugin.html">Plugin Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/framework.html">Framework</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/view-plugin.html">View Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/style-guide.html">Style Guide</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>Community</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/plugins/">Plugin List</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/contributing.html">Contributing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/resource.html">Resource</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/faq.html">FAQ</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><h2 id="asynchronous-programming-model">Asynchronous programming model</h2><p>Node.js is an asynchronous world, asynchronous programming models in official API support are all in callback form ，it brings many problems. For example:</p><ul><li><a href="http://callbackhell.com/">callback hell</a>: Notorious &quot;callback hell&quot;。</li><li><a href="https://oren.github.io/blog/zalgo.html">release zalgo</a>: Asynchronous functions may call callback function response data synchronously which would bring inconsistency.</li></ul><p>The community has provided many solutions for the problems, the winner is Promise, it is built into ECMAScript 2015. On the basis of Promise, and with the ability of Generator to switch context, we can write asynchronous code in synchronous way with <a href="https://github.com/tj/co">co</a> and other third party libraries. Meanwhile <a href="https://github.com/tc39/ecmascript-asyncawait">async function</a>, the official solution has been published in ECMAScript 2017 and landed in Node.js 8.</p><h3 id="async-function">Async function</h3><p><a href="https://github.com/tc39/ecmascript-asyncawait">Async function</a> is a syntactic sugar at the language level. In async function, we can use <code>await</code> to wait for a promise to be resolved(or rejected, which will throw an exception), and Node.js LTS (8.x) has supported this feature.</p><pre><code class="language-js">const fn = async function() {
  const user = await getUser();
  const posts = await fetchPosts(user.id);
  return { user, posts };
};
fn().then(res =&gt; console.log(res)).catch(err =&gt; console.error(err.stack));</code></pre><h2 id="koa">Koa</h2><blockquote><p>Koa is a new Web framework designed by the team behind Express, which aims to be a smaller, more expressive, and more robust foundation for Web applications and APIs.</p></blockquote><p>The design styles of Koa and Express are very similar, The underlying basic library is the same, <a href="https://github.com/jshttp">HTTP library</a>. There are several significant differences between them. Besides the asynchronous solution by default mentioned above, there are the following points.</p><h3 id="midlleware">Midlleware</h3><p>The middleware in Koa is different from Express, Koa use the onion model:</p><ul><li>Middleware onion diagram:</li></ul><p><img src="https://camo.githubusercontent.com/d80cf3b511ef4898bcde9a464de491fa15a50d06/68747470733a2f2f7261772e6769746875622e636f6d2f66656e676d6b322f6b6f612d67756964652f6d61737465722f6f6e696f6e2e706e67"/></p><ul><li>Middleware execution sequence diagram:</li></ul><p><img src="https://raw.githubusercontent.com/koajs/koa/a7b6ed0529a58112bac4171e4729b8760a34ab8b/docs/middleware.gif"/></p><p>All the requests will be executed twice during one middleware. Compared to Express middleware, it is very easy to implement post-processing logic. You can obviously feel the advantage of Koa middleware model by comparing the compress middleware implementing in Koa and Express.</p><ul><li><a href="https://github.com/koajs/compress/blob/master/index.js">koa-compress</a> for Koa.</li><li><a href="https://github.com/expressjs/compression/blob/master/index.js">compression</a> for Express.</li></ul><h3 id="context">Context</h3><p>Unlike that there are only two objects <code>Request</code> and <code>Response</code> in Express, Koa has one more, <code>Context</code> object in one HTTP request(it is <code>this</code> in Koa 1, while it is the first parameter for middleware function in Koa 2). We can mount all the related properties in one request to this object. Such as <a href="https://github.com/eggjs/egg-tracer/blob/1.0.0/lib/tracer.js#L12">traceId</a> that runs through the whole request lifetime (which will be called anywhere afterward) could be mounted. It is more semantic other than request and response.</p><p>At the same time Request and Response are mounted to Context object. Just like Express, the two objects provide lots of easy ways to help developing. For example:</p><ul><li><code>get request.query</code></li><li><code>get request.hostname</code></li><li><code>set response.body</code></li><li><code>set response.status</code></li></ul><h3 id="exception-handlering">Exception handlering</h3><p>Another enormous advantage for writing asynchronous code in synchronous way is that it is quite at ease to handle exception. You can catch all the exceptions thrown in the codes followed the convention with <code>try catch</code>. We can easily write a customized exception handling middleware.</p><pre><code class="language-js">async function onerror(ctx, next) {
  try {
    await next();
  } catch (err) {
    ctx.app.emit(&#x27;error&#x27;, err);
    ctx.body = &#x27;server error&#x27;;
    ctx.status = err.status || 500;
  }
}</code></pre><p> Putting this middleware before others, you can catch all the exceptions thrown by the synchronous or asynchronous code.</p><h2 id="egg-inherits-from-koa">Egg inherits from Koa</h2><p>As described above, Koa is an excellent framework. However, it is not enough to build an enterprise-class application.</p><p>Egg is built around the Koa. On the basis of Koa model, Egg implements enhancements one step further.</p><h3 id="extension">Extension</h3><p>In the framework or application based on Egg, we can extend the prototype of 4 Koa objects by defining <code>app/extend/{application,context,request,response}.js</code>. With this, we can write more utility methods quickly. For example, we have the following code in <code>app/extend/context.js</code>:</p><pre><code class="language-js">// app/extend/context.js
module.exports = {
  get isIOS() {
    const iosReg = /iphone|ipad|ipod/i;
    return iosReg.test(this.get(&#x27;user-agent&#x27;));
  },
};</code></pre><p>It can be used in controller then:</p><pre><code class="language-js">// app/controller/home.js
exports.handler = ctx =&gt; {
  ctx.body = ctx.isIOS
    ? &#x27;Your operating system is iOS.&#x27;
    : &#x27;Your operating system is not iOS.&#x27;;
};</code></pre><p>More about extension, please check <a href="../basics/extend.md">Exception</a> section.</p><h3 id="plugin">Plugin</h3><p>As is known to all, Many middlewares are imported to provide different kind of features in Express and Koa. Eg, <a href="https://github.com/koajs/session">koa-session</a> provides the Session support, <a href="https://github.com/koajs/bodyparser">koa-bodyparser</a> help to parse request body. Egg has provided a powerful plugin mechanism to make it easier to write stand alone features.</p><p>One plugin can include:</p><ul><li>extend：extend the context of base object, provide utility and attributes.</li><li>middleware：add one or more middlewares, provide pre or post processing logic for request.</li><li>config：configure the default value in different environments.</li></ul><p>Stand alone module plugin can provide rich features with high maintenancability. You can almost forget the configuration as the plugin supports configuring the default value in different environments.</p><p><a href="https://github.com/eggjs/egg-security">egg-security</a> is a typical example.</p><p>More about plugin, please check <a href="../basics/plugin.md">Plugin</a> section.</p><h3 id="roadmap">Roadmap</h3><h4 id="egg-1x">Egg 1.x</h4><p>When Egg 1.x released, the Node.js LTS version did not support async function，so Egg 1.x was based on Koa 1.x. On the basis of this, Egg had added fully async function support. Egg is completely compatible with middlewares in Koa 2.x, all applications could write with <code>async function</code>.</p><ul><li>The underlying is based on Koa 1.x, asynchronous solution is based on generator function wrapped by <a href="https://github.com/tj/co">co</a>.</li><li>Official plugin and core of Egg are written in generator function,  keep supporting Node.js LTS version, use <a href="https://github.com/tj/co">co</a> when necessary to be compatiable with async function.</li><li>Application developers can choose either async function (Node.js 8.x+) or generator function (Node.js 6.x+).</li></ul><h4 id="egg-2x">Egg 2.x</h4><p>When Node.js 8 became LTS version, async function could be used in Node.js without any performance problem. Egg released 2.x based on Koa 2.x, the framework and built-in plugins were all written by async function, and Egg 2.x still kept compatibility with generator function and all the usages in Egg 1.x, applications based on Egg 1.x can migrate to Egg 2.x only by upgrading to Node.js 8.</p><ul><li>The underlying will be based on Koa 2.x, asynchronous solution will be based on async function.</li><li>Official plugin and core of egg will be written in async function.</li><li>Recommend user to transfer business layer to async function.</li><li>Only support Node.js 8+.</li></ul></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#asynchronous-programming-model">Asynchronous programming model</a><ul><li><a href="#async-function">Async function</a></li></ul></li><li><a href="#koa">Koa</a><ul><li><a href="#midlleware">Midlleware</a></li><li><a href="#context">Context</a></li><li><a href="#exception-handlering">Exception handlering</a></li></ul></li><li><a href="#egg-inherits-from-koa">Egg inherits from Koa</a><ul><li><a href="#extension">Extension</a></li><li><a href="#plugin">Plugin</a></li><li><a href="#roadmap">Roadmap</a><ul><li><a href="#egg-1x">Egg 1.x</a></li><li><a href="#egg-2x">Egg 2.x</a></li></ul></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"en","props":{"toc":"-%20%5BAsynchronous%20programming%20model%5D(%23asynchronous-programming-model)%0A%20%20*%20%5BAsync%20function%5D(%23async-function)%0A-%20%5BKoa%5D(%23koa)%0A%20%20*%20%5BMidlleware%5D(%23midlleware)%0A%20%20*%20%5BContext%5D(%23context)%0A%20%20*%20%5BException%20handlering%5D(%23exception-handlering)%0A-%20%5BEgg%20inherits%20from%20Koa%5D(%23egg-inherits-from-koa)%0A%20%20*%20%5BExtension%5D(%23extension)%0A%20%20*%20%5BPlugin%5D(%23plugin)%0A%20%20*%20%5BRoadmap%5D(%23roadmap)%0A%20%20%20%20%2B%20%5BEgg%201.x%5D(%23egg-1x)%0A%20%20%20%20%2B%20%5BEgg%202.x%5D(%23egg-2x)","meta":{"info":{"title":"Egg and Koa"}},"content":"%0A%0A%0A%23%23%20Asynchronous%20programming%20model%0A%0ANode.js%20is%20an%20asynchronous%20world%2C%20asynchronous%20programming%20models%20in%20official%20API%20support%20are%20all%20in%20callback%20form%20%EF%BC%8Cit%20brings%20many%20problems.%20For%20example%3A%0A%0A-%20%5Bcallback%20hell%5D(http%3A%2F%2Fcallbackhell.com%2F)%3A%20Notorious%20%22callback%20hell%22%E3%80%82%0A-%20%5Brelease%20zalgo%5D(https%3A%2F%2Foren.github.io%2Fblog%2Fzalgo.html)%3A%20Asynchronous%20functions%20may%20call%20callback%20function%20response%20data%20synchronously%20which%20would%20bring%20inconsistency.%0A%0AThe%20community%20has%20provided%20many%20solutions%20for%20the%20problems%2C%20the%20winner%20is%20Promise%2C%20it%20is%20built%20into%20ECMAScript%202015.%20On%20the%20basis%20of%20Promise%2C%20and%20with%20the%20ability%20of%20Generator%20to%20switch%20context%2C%20we%20can%20write%20asynchronous%20code%20in%20synchronous%20way%20with%20%5Bco%5D%20and%20other%20third%20party%20libraries.%20Meanwhile%20%5Basync%20function%5D%2C%20the%20official%20solution%20has%20been%20published%20in%20ECMAScript%202017%20and%20landed%20in%20Node.js%208.%0A%0A%23%23%23%20Async%20function%0A%0A%5BAsync%20function%5D%20is%20a%20syntactic%20sugar%20at%20the%20language%20level.%20In%20async%20function%2C%20we%20can%20use%20%60await%60%20to%20wait%20for%20a%20promise%20to%20be%20resolved(or%20rejected%2C%20which%20will%20throw%20an%20exception)%2C%20and%20Node.js%20LTS%20(8.x)%20has%20supported%20this%20feature.%0A%0A%60%60%60js%0Aconst%20fn%20%3D%20async%20function()%20%7B%0A%20%20const%20user%20%3D%20await%20getUser()%3B%0A%20%20const%20posts%20%3D%20await%20fetchPosts(user.id)%3B%0A%20%20return%20%7B%20user%2C%20posts%20%7D%3B%0A%7D%3B%0Afn().then(res%20%3D%3E%20console.log(res)).catch(err%20%3D%3E%20console.error(err.stack))%3B%0A%60%60%60%0A%0A%23%23%20Koa%0A%0A%3E%20Koa%20is%20a%20new%20Web%20framework%20designed%20by%20the%20team%20behind%20Express%2C%20which%20aims%20to%20be%20a%20smaller%2C%20more%20expressive%2C%20and%20more%20robust%20foundation%20for%20Web%20applications%20and%20APIs.%0A%0AThe%20design%20styles%20of%20Koa%20and%20Express%20are%20very%20similar%2C%20The%20underlying%20basic%20library%20is%20the%20same%2C%20%5BHTTP%20library%5D(https%3A%2F%2Fgithub.com%2Fjshttp).%20There%20are%20several%20significant%20differences%20between%20them.%20Besides%20the%20asynchronous%20solution%20by%20default%20mentioned%20above%2C%20there%20are%20the%20following%20points.%0A%0A%23%23%23%20Midlleware%0A%0AThe%20middleware%20in%20Koa%20is%20different%20from%20Express%2C%20Koa%20use%20the%20onion%20model%3A%0A%0A-%20Middleware%20onion%20diagram%3A%0A%0A!%5B%5D(https%3A%2F%2Fcamo.githubusercontent.com%2Fd80cf3b511ef4898bcde9a464de491fa15a50d06%2F68747470733a2f2f7261772e6769746875622e636f6d2f66656e676d6b322f6b6f612d67756964652f6d61737465722f6f6e696f6e2e706e67)%0A%0A-%20Middleware%20execution%20sequence%20diagram%3A%0A%0A!%5B%5D(https%3A%2F%2Fraw.githubusercontent.com%2Fkoajs%2Fkoa%2Fa7b6ed0529a58112bac4171e4729b8760a34ab8b%2Fdocs%2Fmiddleware.gif)%0A%0AAll%20the%20requests%20will%20be%20executed%20twice%20during%20one%20middleware.%20Compared%20to%20Express%20middleware%2C%20it%20is%20very%20easy%20to%20implement%20post-processing%20logic.%20You%20can%20obviously%20feel%20the%20advantage%20of%20Koa%20middleware%20model%20by%20comparing%20the%20compress%20middleware%20implementing%20in%20Koa%20and%20Express.%0A%0A-%20%5Bkoa-compress%5D(https%3A%2F%2Fgithub.com%2Fkoajs%2Fcompress%2Fblob%2Fmaster%2Findex.js)%20for%20Koa.%0A-%20%5Bcompression%5D(https%3A%2F%2Fgithub.com%2Fexpressjs%2Fcompression%2Fblob%2Fmaster%2Findex.js)%20for%20Express.%0A%0A%23%23%23%20Context%0A%0AUnlike%20that%20there%20are%20only%20two%20objects%20%60Request%60%20and%20%60Response%60%20in%20Express%2C%20Koa%20has%20one%20more%2C%20%60Context%60%20object%20in%20one%20HTTP%20request(it%20is%20%60this%60%20in%20Koa%201%2C%20while%20it%20is%20the%20first%20parameter%20for%20middleware%20function%20in%20Koa%202).%20We%20can%20mount%20all%20the%20related%20properties%20in%20one%20request%20to%20this%20object.%20Such%20as%20%5BtraceId%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-tracer%2Fblob%2F1.0.0%2Flib%2Ftracer.js%23L12)%20that%20runs%20through%20the%20whole%20request%20lifetime%20(which%20will%20be%20called%20anywhere%20afterward)%20could%20be%20mounted.%20It%20is%20more%20semantic%20other%20than%20request%20and%20response.%0A%0AAt%20the%20same%20time%20Request%20and%20Response%20are%20mounted%20to%20Context%20object.%20Just%20like%20Express%2C%20the%20two%20objects%20provide%20lots%20of%20easy%20ways%20to%20help%20developing.%20For%20example%3A%0A%0A-%20%60get%20request.query%60%0A-%20%60get%20request.hostname%60%0A-%20%60set%20response.body%60%0A-%20%60set%20response.status%60%0A%0A%23%23%23%20Exception%20handlering%0A%0AAnother%20enormous%20advantage%20for%20writing%20asynchronous%20code%20in%20synchronous%20way%20is%20that%20it%20is%20quite%20at%20ease%20to%20handle%20exception.%20You%20can%20catch%20all%20the%20exceptions%20thrown%20in%20the%20codes%20followed%20the%20convention%20with%20%60try%20catch%60.%20We%20can%20easily%20write%20a%20customized%20exception%20handling%20middleware.%0A%0A%60%60%60js%0Aasync%20function%20onerror(ctx%2C%20next)%20%7B%0A%20%20try%20%7B%0A%20%20%20%20await%20next()%3B%0A%20%20%7D%20catch%20(err)%20%7B%0A%20%20%20%20ctx.app.emit('error'%2C%20err)%3B%0A%20%20%20%20ctx.body%20%3D%20'server%20error'%3B%0A%20%20%20%20ctx.status%20%3D%20err.status%20%7C%7C%20500%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%20Putting%20this%20middleware%20before%20others%2C%20you%20can%20catch%20all%20the%20exceptions%20thrown%20by%20the%20synchronous%20or%20asynchronous%20code.%0A%0A%23%23%20Egg%20inherits%20from%20Koa%0A%0AAs%20described%20above%2C%20Koa%20is%20an%20excellent%20framework.%20However%2C%20it%20is%20not%20enough%20to%20build%20an%20enterprise-class%20application.%0A%0AEgg%20is%20built%20around%20the%20Koa.%20On%20the%20basis%20of%20Koa%20model%2C%20Egg%20implements%20enhancements%20one%20step%20further.%0A%0A%0A%23%23%23%20Extension%0A%0AIn%20the%20framework%20or%20application%20based%20on%20Egg%2C%20we%20can%20extend%20the%20prototype%20of%204%20Koa%20objects%20by%20defining%20%60app%2Fextend%2F%7Bapplication%2Ccontext%2Crequest%2Cresponse%7D.js%60.%20With%20this%2C%20we%20can%20write%20more%20utility%20methods%20quickly.%20For%20example%2C%20we%20have%20the%20following%20code%20in%20%60app%2Fextend%2Fcontext.js%60%3A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fextend%2Fcontext.js%0Amodule.exports%20%3D%20%7B%0A%20%20get%20isIOS()%20%7B%0A%20%20%20%20const%20iosReg%20%3D%20%2Fiphone%7Cipad%7Cipod%2Fi%3B%0A%20%20%20%20return%20iosReg.test(this.get('user-agent'))%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0AIt%20can%20be%20used%20in%20controller%20then%3A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fhome.js%0Aexports.handler%20%3D%20ctx%20%3D%3E%20%7B%0A%20%20ctx.body%20%3D%20ctx.isIOS%0A%20%20%20%20%3F%20'Your%20operating%20system%20is%20iOS.'%0A%20%20%20%20%3A%20'Your%20operating%20system%20is%20not%20iOS.'%3B%0A%7D%3B%0A%60%60%60%0A%0AMore%20about%20extension%2C%20please%20check%20%5BException%5D(..%2Fbasics%2Fextend.md)%20section.%0A%0A%23%23%23%20Plugin%0A%0AAs%20is%20known%20to%20all%2C%20Many%20middlewares%20are%20imported%20to%20provide%20different%20kind%20of%20features%20in%20Express%20and%20Koa.%20Eg%2C%20%5Bkoa-session%5D(https%3A%2F%2Fgithub.com%2Fkoajs%2Fsession)%20provides%20the%20Session%20support%2C%20%5Bkoa-bodyparser%5D(https%3A%2F%2Fgithub.com%2Fkoajs%2Fbodyparser)%20help%20to%20parse%20request%20body.%20Egg%20has%20provided%20a%20powerful%20plugin%20mechanism%20to%20make%20it%20easier%20to%20write%20stand%20alone%20features.%0A%0AOne%20plugin%20can%20include%3A%0A%0A-%20extend%EF%BC%9Aextend%20the%20context%20of%20base%20object%2C%20provide%20utility%20and%20attributes.%0A-%20middleware%EF%BC%9Aadd%20one%20or%20more%20middlewares%2C%20provide%20pre%20or%20post%20processing%20logic%20for%20request.%0A-%20config%EF%BC%9Aconfigure%20the%20default%20value%20in%20different%20environments.%0A%0AStand%20alone%20module%20plugin%20can%20provide%20rich%20features%20with%20high%20maintenancability.%20You%20can%20almost%20forget%20the%20configuration%20as%20the%20plugin%20supports%20configuring%20the%20default%20value%20in%20different%20environments.%0A%0A%5Begg-security%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-security)%20is%20a%20typical%20example.%0A%0AMore%20about%20plugin%2C%20please%20check%20%5BPlugin%5D(..%2Fbasics%2Fplugin.md)%20section.%0A%0A%23%23%23%20Roadmap%0A%0A%23%23%23%23%20Egg%201.x%0A%0AWhen%20Egg%201.x%20released%2C%20the%20Node.js%20LTS%20version%20did%20not%20support%20async%20function%EF%BC%8Cso%20Egg%201.x%20was%20based%20on%20Koa%201.x.%20On%20the%20basis%20of%20this%2C%20Egg%20had%20added%20fully%20async%20function%20support.%20Egg%20is%20completely%20compatible%20with%20middlewares%20in%20Koa%202.x%2C%20all%20applications%20could%20write%20with%20%60async%20function%60.%0A%0A-%20The%20underlying%20is%20based%20on%20Koa%201.x%2C%20asynchronous%20solution%20is%20based%20on%20generator%20function%20wrapped%20by%20%5Bco%5D.%0A-%20Official%20plugin%20and%20core%20of%20Egg%20are%20written%20in%20generator%20function%2C%20%20keep%20supporting%20Node.js%20LTS%20version%2C%20use%20%5Bco%5D%20when%20necessary%20to%20be%20compatiable%20with%20async%20function.%0A-%20Application%20developers%20can%20choose%20either%20async%20function%20(Node.js%208.x%2B)%20or%20generator%20function%20(Node.js%206.x%2B).%0A%0A%23%23%23%23%20Egg%202.x%0A%0AWhen%20Node.js%208%20became%20LTS%20version%2C%20async%20function%20could%20be%20used%20in%20Node.js%20without%20any%20performance%20problem.%20Egg%20released%202.x%20based%20on%20Koa%202.x%2C%20the%20framework%20and%20built-in%20plugins%20were%20all%20written%20by%20async%20function%2C%20and%20Egg%202.x%20still%20kept%20compatibility%20with%20generator%20function%20and%20all%20the%20usages%20in%20Egg%201.x%2C%20applications%20based%20on%20Egg%201.x%20can%20migrate%20to%20Egg%202.x%20only%20by%20upgrading%20to%20Node.js%208.%0A%0A-%20The%20underlying%20will%20be%20based%20on%20Koa%202.x%2C%20asynchronous%20solution%20will%20be%20based%20on%20async%20function.%0A-%20Official%20plugin%20and%20core%20of%20egg%20will%20be%20written%20in%20async%20function.%0A-%20Recommend%20user%20to%20transfer%20business%20layer%20to%20async%20function.%0A-%20Only%20support%20Node.js%208%2B.%0A%0A%5Bco%5D%3A%20https%3A%2F%2Fgithub.com%2Ftj%2Fco%0A%5BAsync%20function%5D%3A%20https%3A%2F%2Fgithub.com%2Ftc39%2Fecmascript-asyncawait%0A%5Basync%20function%5D%3A%20https%3A%2F%2Fgithub.com%2Ftc39%2Fecmascript-asyncawait%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>