<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Unit Testing</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/en/intro/">Guide</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/en/tutorials/index.html">Tutorials</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">Plugins</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">Release</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>切换语言</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>Guide</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/index.html">What is Egg?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/quickstart.html">Quick Start</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/progressive.html">Progressive</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/migration.html">Migration to 2.x</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>Basis Function</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/structure.html">Directory Structure</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/objects.html">Built-in Objects</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/env.html">Environment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/config.html">Configuration</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/middleware.html">Middleware</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/plugin.html">Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/schedule.html">Schedule</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/extend.html">Extend</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/app-start.html">Custom Init</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>Core</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/development.html">Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/unittest.html">Unit Testing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/deployment.html">Deployment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/logger.html">Logger</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/view.html">View</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/error-handling.html">Error Handling</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/security.html">Security</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/i18n.html">i18n</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>Tutorials</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/passport.html">Passport</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/assets.html">Assets</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>Advanced</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/plugin.html">Plugin Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/framework.html">Framework</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/view-plugin.html">View Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/style-guide.html">Style Guide</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>Community</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/plugins/">Plugin List</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/contributing.html">Contributing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/resource.html">Resource</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/faq.html">FAQ</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><h2 id="why-unit-testing">Why Unit Testing</h2><p>Let us start with a few questions:</p><ul><li>How to measure the quality of code</li><li>How to ensure the quality of code</li><li>Are you free to refactor code</li><li>How to guarantee the correctness of refactored code</li><li>Have you confidence to release your untested code</li></ul><p>If you are not sure, you probably need unit testing.</p><p>Actually, it brings us tremendous benefits:</p><ul><li>guarantee the quality of maintaining code </li><li>guarantee the correctness of reconstruction</li><li>enhance confidence</li><li>automation</li></ul><p>It&#x27;s more important to use unit tests in a web application during the fast iteration, because each testing case can contribute to the increasing stability of the application. The result of various inputs in each test is definite, so it&#x27;s obvious to detect whether the changed code has an impact on correctness or not.</p><p>Therefore, code, such as in Controller, Service, Helper, Extend and so on, require corresponding unit testing for quality assurances, especially modification of the framework or plugins, of which test coverage is strongly recommended to be 100%.</p><h2 id="test-framework">Test Framework</h2><p>When <a href="https://www.npmjs.com/search?q=test%20framework&amp;page=1&amp;ranking=popularity">searching &#x27;test framework&#x27; in npm</a>, there are a mass of test frameworks owning their own unique characteristics.</p><h3 id="mocha">Mocha</h3><p>We choose and recommend you to use <a href="http://mochajs.org">Mocha</a>, which is very rich in functionality and supports running in Node.js and Browser, what&#x27;s more, it&#x27;s very friendly to asynchronous test support.</p><blockquote><p>Mocha is a feature-rich JavaScript test framework running on Node.js and in the browser, making asynchronous testing simple and fun. Mocha tests run serially, allowing for flexible and accurate reporting, while mapping uncaught exceptions to the correct test cases.</p></blockquote><h3 id="ava">AVA</h3><p>Why not another recently popular framework <a href="https://github.com/avajs/ava">AVA</a> which looks like faster? AVA is great, but practice of several projects tells us the truth that code is harder to write.</p><p>Comments from <a href="https://github.com/dead-horse">@dead-horse</a>:</p><blockquote><ul><li>AVA is not stable enough, for example, CPU capacity is going to be overloaded when plenty of files are running concurrently. The solution of setting parameter to control concurrent could work, but &#x27;only mode&#x27; would be not functioning any more.</li><li>Running cases concurrently makes great demands on implementation, because each test has to be independent, especially containing mock.</li><li>Considering the expensive initialization of app, it&#x27;s irrational of AVA to execute each file in an independent process initializing their own app while serial framework does only one time.</li></ul></blockquote><p>Comments from <a href="https://github.com/fool2fish">@fool2fish</a>：</p><blockquote><ul><li>It&#x27;s faster to use AVA in simple application(maybe too simple to judge). But it&#x27;s not recommended to use in complicate one because of its considerable flaws, such as incapability of offering accurate error stacks; meanwhile, concurrency may cause service relying on other test settings to hang up which reduces the success rate of the test. Therefore, process testing, for example, CRUD operations of database, should not use AVA.</li></ul></blockquote><h2 id="assertion-library">Assertion Library</h2><p><a href="https://www.npmjs.com/search?q=assert&amp;page=1&amp;ranking=popularity">Assertion libraries</a>, as flourishing as test frameworks, are emerged continuously. The one we used has changed from <a href="https://nodejs.org/api/assert.html">assert</a> to <a href="https://github.com/shouldjs/should.js">should</a>, and then to <a href="https://github.com/Automattic/expect.js">expect</a>
, but we are still trying to find better one.</p><p>In the end, we go back to the original assertion library because of the appearance of <a href="https://github.com/power-assert-js/power-assert">power-assert</a>, which best expresses <a href="https://github.com/atian25/blog/issues/16">『No API is the best API』</a>.</p><p>To be Short, Here are it&#x27;s advantages:</p><ul><li>No API is the best API. Assert is all.</li><li><strong> powerful failure message </strong></li><li><strong> powerful failure message </strong></li><li><strong> powerful failure message </strong></li></ul><p>You may intentionally make mistakes in order to see these failure messages.
<img src="https://cloud.githubusercontent.com/assets/227713/20919940/19e83de8-bbd9-11e6-8951-bf4a332f9b5a.png"/></p><h2 id="test-rule">Test Rule</h2><p>Framework defines some fundamental rules on unit testing to keep us focus on coding rather than assistant work, such as how to execute test cases.
Egg does some basic conventions for unit testing.</p><h3 id="directory-structure">Directory Structure</h3><p>Test code is demand to be put in <code>test</code> directory, include <code>fixtures</code> and assistant scripts.</p><p>Each Test file has to be named by the pattern of <code>${filename}.test.js</code>, ending with <code>.test.js</code>.</p><p>For example:</p><pre><code class="language-bash">test
├── controller
│   └── home.test.js
├── hello.test.js
└── service
    └── user.test.js</code></pre><h3 id="test-tool">Test Tool</h3><p>Consistently using <a href="./development.md#unit_testing">egg-bin to launch tests</a> , which automatically loads modules like <a href="https://mochajs.org">Mocha</a>, <a href="https://github.com/blakeembrey/co-mocha">co-mocha</a>, <a href="https://github.com/power-assert-js/power-assert">power-assert</a>, <a href="https://github.com/istanbuljs/nyc">nyc</a> into test scripts, so that we can <strong>concentrate on writing tests</strong> without wasting time on the choice of various test tools or modules.</p><p>The only thing you need to do is setting <code>scripts.test</code> in <code>package.json</code>.</p><pre><code class="language-json">{
  &quot;scripts&quot;: {
    &quot;test&quot;: &quot;egg-bin test&quot;
  }
}</code></pre><p>Then tests would be launched by executing <code>npm test</code> command.</p><pre><code class="language-bas">npm test

&gt; unittest-example@ test /Users/mk2/git/github.com/eggjs/examples/unittest
&gt; egg-bin test

  test/hello.test.js
    ✓ should work

  1 passing (10ms)</code></pre><h2 id="test-preparation">Test Preparation</h2><p>This chapter introduces you how to write test, and introduction of tests for the framework and plugins are located in <a href="../advanced/framework.md">framework</a> and <a href="../advanced/plugin.md">plugin</a>.</p><h3 id="mock">mock</h3><p>Generally, a complete application test requires initialization and cleanup, such as deleting temporary files or destroy application. Also, we have to deal with exceptional situations like network problem and exception visit of server.</p><p>We extracted an <a href="https://github.com/eggjs/egg-mock">egg-mock</a>module for mock, help for quick implementation of application unit tests, supporting fast creation of ctx to test.</p><h3 id="app">app</h3><p>Before launching, we have to create an instance of App to test code of application-level like Controller, Middleware or Service.</p><p>We can easily create an app instance with Mocha&#x27;s <code>before</code> hook through egg-mock.</p><pre><code class="language-js">// test/controller/home.test.js
const assert = require(&#x27;assert&#x27;);
const mock = require(&#x27;egg-mock&#x27;);

describe(&#x27;test/controller/home.test.js&#x27;, () =&gt; {
  let app;
  before(() =&gt; {
    // create a current app instance
    app = mock.app();
    // execute tests after app is ready
    return app.ready();
  });
});</code></pre><p>Now, we have an app instance, and it&#x27;s the base of all the following tests. See more about app at <a href="https://github.com/eggjs/egg-mock#options"><code>mock.app(options)</code></a>.</p><p>It&#x27;s redundancy to create an instance in each test file, so we offered an bootstrap file in egg-mock to create it conveniently.</p><pre><code class="language-js">// test/controller/home.test.js
const { app, mock, assert } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;test/controller/home.test.js&#x27;, () =&gt; {
  // test cases
});</code></pre><h3 id="ctx">ctx</h3><p>Except app, tests for Extend, Service and Helper are also taken into consideration. Let&#x27;s create a context through <a href="https://github.com/eggjs/egg-mock#appmockcontextoptions"><code>app.mockContext(options)</code></a> offered by egg-mock.</p><pre><code class="language-js">it(&#x27;should get a ctx&#x27;, () =&gt; {
  const ctx = app.mockContext();
  assert(ctx.method === &#x27;GET&#x27;);
  assert(ctx.url === &#x27;/&#x27;);
});</code></pre><p>If we want to mock the data for <code>ctx.user</code>, we can do that by passing the data parameter to mockContext:</p><pre><code class="language-js">it(&#x27;should mock ctx.user&#x27;, () =&gt; {
  const ctx = app.mockContext({
    user: {
      name: &#x27;fengmk2&#x27;,
    },
  });
  assert(ctx.user);
  assert(ctx.user.name === &#x27;fengmk2&#x27;);
});</code></pre><p>Since we have got the app and the context, you are free to do a lot of tests.</p><h2 id="testing-order">Testing Order</h2><p>Pay close attention to testing order, and make sure any chunk of code is executed as you expected.</p><p>Common Error:</p><pre><code class="language-js">// Bad
const { app } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;bad test&#x27;, () =&gt; {
  doSomethingBefore();

  it(&#x27;should redirect&#x27;, () =&gt; {
    return app.httpRequest()
      .get(&#x27;/&#x27;)
      .expect(302);
  });
});</code></pre><p>Mocha is going to load all the code in the beginning, which means <code>doSomethingBefore</code> would be invoked before execution. It&#x27;s not expected when especially using &#x27;only&#x27; to specify the test.</p><p>It&#x27;s supposed to locate in a <code>before</code> hook in the suite of a particular test case.</p><pre><code class="language-js">// Good
const { app } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;good test&#x27;, () =&gt; {
  before(() =&gt; doSomethingBefore());

  it(&#x27;should redirect&#x27;, () =&gt; {
    return app.httpRequest()
      .get(&#x27;/&#x27;)
      .expect(302);
  });
});</code></pre><p>Mocha have keywords - before, after, beforeEach and afterEach - to set up preconditions and clean-up after your tests. These keywords could be multiple and execute in strict order.</p><pre><code class="language-js">describe(&#x27;egg test&#x27;, () =&gt; {
  before(() =&gt; console.log(&#x27;order 1&#x27;));
  before(() =&gt; console.log(&#x27;order 2&#x27;));
  after(() =&gt; console.log(&#x27;order 6&#x27;));
  beforeEach(() =&gt; console.log(&#x27;order 3&#x27;));
  afterEach(() =&gt; console.log(&#x27;order 5&#x27;));
  it(&#x27;should worker&#x27;, () =&gt; console.log(&#x27;order 4&#x27;));
});</code></pre><h2 id="asynchronous-test">Asynchronous Test</h2><p>egg-bin supports asynchronous test:</p><pre><code class="language-js">// using Promise
it(&#x27;should redirect&#x27;, () =&gt; {
  return app.httpRequest()
    .get(&#x27;/&#x27;)
    .expect(302);
});

// using callback
it(&#x27;should redirect&#x27;, done =&gt; {
  app.httpRequest()
    .get(&#x27;/&#x27;)
    .expect(302, done);
});

// using async
it(&#x27;should redirect&#x27;, async () =&gt; {
  await app.httpRequest()
    .get(&#x27;/&#x27;)
    .expect(302);
});</code></pre><p>According to specific situation, you could make different choice of these ways. Multiple asynchronous test cases could be composed to one test with async function, or divided into several independent tests.</p><h2 id="controller-test">Controller Test</h2><p>It&#x27;s the tough part of all application tests, since it&#x27;s closely related to router configuration. We need use <code>app.httpRequest()</code> to return a real instance <a href="https://github.com/visionmedia/supertest">SuperTest</a>, which connects Router and Controller and could also help us to examine param verification of Router by loading boundary conditions. <code>app.httpRequest()</code> is a request instance <a href="https://github.com/visionmedia/supertest">SuperTest</a> which is encapsulated by <a href="https://github.com/eggjs/egg-mock">egg-mock</a>.</p><p>Here is an <code>app/controller/home.js</code> example.</p><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  const { router, controller } = app;
  router.get(&#x27;homepage&#x27;, &#x27;/&#x27;, controller.home.index);
};

// app/controller/home.js
class HomeController extends Controller {
  async index() {
    this.ctx.body = &#x27;hello world&#x27;;
  }
}</code></pre><p>Then a test.</p><pre><code class="language-js">// test/controller/home.test.js
const { app, mock, assert } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;test/controller/home.test.js&#x27;, () =&gt; {
  describe(&#x27;GET /&#x27;, () =&gt; {
    it(&#x27;should status 200 and get the body&#x27;, () =&gt; {
      // load `GET /` request
      return app.httpRequest()
        .get(&#x27;/&#x27;)
        .expect(200) // set expectation of status to 200
        .expect(&#x27;hello world&#x27;); // set expectation of body to &#x27;hello world&#x27;
    });

    it(&#x27;should send multi requests&#x27;, async () =&gt; {
      await app.httpRequest()
        .get(&#x27;/&#x27;)
        .expect(200) v
        .expect(&#x27;hello world&#x27;); // set expectation of body to &#x27;hello world&#x27;

      // once more
      const result = await app.httpRequest()
        .get(&#x27;/&#x27;)
        .expect(200)
        .expect(&#x27;hello world&#x27;);

      // verify via assert
      assert(result.status === 200);
    });
  });
});</code></pre><p><code>app.httpRequest</code> based on SuperTest supports a majority of HTTP methods such as GET, POST, PUT, and it provides rich interfaces to construct request, such as a JSON POST request.</p><pre><code class="language-js">// app/controller/home.js
class HomeController extends Controller {
  async post() {
    this.ctx.body = this.ctx.request.body;
  }
}

// test/controller/home.test.js
it(&#x27;should status 200 and get the request body&#x27;, () =&gt; {
  // mock CSRF token，explain later
  app.mockCsrf();
  return app.httpRequest()
    .post(&#x27;/post&#x27;)
    .type(&#x27;form&#x27;)
    .send({
      foo: &#x27;bar&#x27;,
    })
    .expect(200)
    .expect({
      foo: &#x27;bar&#x27;,
    });
});</code></pre><p>See details at <a href="https://github.com/visionmedia/supertest#getting-started">SuperTest Document</a>。</p><h3 id="mock-csrf">mock CSRF</h3><p>The security plugin of framework would enable <a href="./security.md#csrf-prevention">CSRF prevention</a> as default. Typically, tests have to precede with a request of page in order to parse CSRF token from the response, and then use the token in later POST requests. But egg-mock provides the <code>app.mockCsrf()</code> function to skip the verification of the CSRF token of requests sent by SuperTest.</p><pre><code class="language-js">app.mockCsrf();
return app.httpRequest()
  .post(&#x27;/post&#x27;)
  .type(&#x27;form&#x27;)
  .send({
    foo: &#x27;bar&#x27;,
  })
  .expect(200)
  .expect({
    foo: &#x27;bar&#x27;,
  });</code></pre><h2 id="service-test">Service Test</h2><p>Service is easier to test than Controller. We need to create a ctx, and then get the instance of Service via <code>ctx.service.${serviceName}</code>, and then use the instance to test.</p><p>For example:</p><pre><code class="language-js">// app/service/user.js
class UserService extends Service {
  async get(name) {
    return await userDatabase.get(name);
  }
}</code></pre><p>And a test:</p><pre><code class="language-js">describe(&#x27;get()&#x27;, () =&gt; {
  // using generator function because of asynchronous invoking
  it(&#x27;should get exists user&#x27;, async () =&gt; {
    // create ctx
    const ctx = app.mockContext();
    // get service.user via ctx
    const user = await ctx.service.user.get(&#x27;fengmk2&#x27;);
    assert(user);
    assert(user.name === &#x27;fengmk2&#x27;);
  });

  it(&#x27;should get null when user not exists&#x27;, async () =&gt; {
    const ctx = app.mockContext();
    const user = await ctx.service.user.get(&#x27;fengmk1&#x27;);
    assert(!user);
  });
});</code></pre><p>Of course it&#x27;s just a sample, actual code would probably be more complicated.</p><h2 id="extend-test">Extend Test</h2><p>It&#x27;s extendable of Application, Request, Response and Context as well as Helper, and we are able to write specific test cases for extended functions or properties.</p><h3 id="application">Application</h3><p>When an app instance is created by egg-mock, the extended functions and properties are already available on the instance and can be tested directly.</p><p>For example, we extend the application in <code>app/extend/application</code> to support cache based on <a href="https://github.com/node-modules/ylru">ylru</a>.</p><pre><code class="language-js">const LRU = Symbol(&#x27;Application#lru&#x27;);
const LRUCache = require(&#x27;ylru&#x27;);
module.exports = {
  get lru() {
    if (!this[LRU]) {
      this[LRU] = new LRUCache(1000);
    }
    return this[LRU];
  },
};</code></pre><p>A corresponding test:</p><pre><code class="language-js">describe(&#x27;get lru&#x27;, () =&gt; {
  it(&#x27;should get a lru and it work&#x27;, () =&gt; {
    // set cache
    app.lru.set(&#x27;foo&#x27;, &#x27;bar&#x27;);
    // get cache
    assert(app.lru.get(&#x27;foo&#x27;) === &#x27;bar&#x27;);
  });
});</code></pre><p>As you can see, it&#x27;s easy.</p><h3 id="context">Context</h3><p>Compared to Application, you need only one more step for Context tests, which is to create an Context instance via <code>app.mockContext</code>.</p><p>Such as adding a property named <code>isXHR</code> to <code>app/extend/context.js</code> to present whether or not the request was submitted via <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/setRequestHeader">XMLHttpRequest</a>.</p><pre><code class="language-js">module.exports = {
  get isXHR() {
    return this.get(&#x27;X-Requested-With&#x27;) === &#x27;XMLHttpRequest&#x27;;
  },
};</code></pre><p>A corresponding test:</p><pre><code class="language-js">describe(&#x27;isXHR()&#x27;, () =&gt; {
  it(&#x27;should true&#x27;, () =&gt; {
    const ctx = app.mockContext({
      headers: {
        &#x27;X-Requested-With&#x27;: &#x27;XMLHttpRequest&#x27;,
      },
    });
    assert(ctx.isXHR === true);
  });

  it(&#x27;should false&#x27;, () =&gt; {
    const ctx = app.mockContext({
      headers: {
        &#x27;X-Requested-With&#x27;: &#x27;SuperAgent&#x27;,
      },
    });
    assert(ctx.isXHR === false);
  });
});</code></pre><h3 id="request">Request</h3><p>Extended properties and function are available on <code>ctx.request</code>, so they can be tested directly.</p><p>For example, provide a <code>isChrome</code> property to <code>app/extend/request.js</code> to verify requests whether they are from Chrome or not.</p><pre><code class="language-js">const IS_CHROME = Symbol(&#x27;Request#isChrome&#x27;);
module.exports = {
  get isChrome() {
    if (!this[IS_CHROME]) {
      const ua = this.get(&#x27;User-Agent&#x27;).toLowerCase();
      this[IS_CHROME] = ua.includes(&#x27;chrome/&#x27;);
    }
    return this[IS_CHROME];
  },
};</code></pre><p>A corresponding test:</p><pre><code class="language-js">describe(&#x27;isChrome()&#x27;, () =&gt; {
  it(&#x27;should true&#x27;, () =&gt; {
    const ctx = app.mockContext({
      headers: {
        &#x27;User-Agent&#x27;: &#x27;Chrome/56.0.2924.51&#x27;,
      },
    });
    assert(ctx.request.isChrome === true);
  });

  it(&#x27;should false&#x27;, () =&gt; {
    const ctx = app.mockContext({
      headers: {
        &#x27;User-Agent&#x27;: &#x27;FireFox/1&#x27;,
      },
    });
    assert(ctx.request.isChrome === false);
  });
});</code></pre><h3 id="response">Response</h3><p>Identical with Request, Response test could be based on <code>ctx.response</code> directly, accessing all the extended functions and properties.</p><p>For example, provide an <code>isSuccess</code> property to indicate current status code equal to 200 or not.</p><pre><code class="language-js">module.exports = {
  get isSuccess() {
    return this.status === 200;
  },
};</code></pre><p>The corresponding test:</p><pre><code class="language-js">describe(&#x27;isSuccess()&#x27;, () =&gt; {
  it(&#x27;should true&#x27;, () =&gt; {
    const ctx = app.mockContext();
    ctx.status = 200;
    assert(ctx.response.isSuccess === true);
  });

  it(&#x27;should false&#x27;, () =&gt; {
    const ctx = app.mockContext();
    ctx.status = 404;
    assert(ctx.response.isSuccess === false);
  });
});</code></pre><h3 id="helper">Helper</h3><p>Similar to Service, Helper is available on ctx, which can be tested directly.</p><p>Such as <code>app/extend/helper.js</code>:</p><pre><code class="language-js">module.exports = {
  money(val) {
    const lang = this.ctx.get(&#x27;Accept-Language&#x27;);
    if (lang.includes(&#x27;zh-CN&#x27;)) {
      return `￥ ${val}`;
    }
    return `$ ${val}`;
  },
};</code></pre><p>A corresponding test:</p><pre><code class="language-js">describe(&#x27;money()&#x27;, () =&gt; {
  it(&#x27;should RMB&#x27;, () =&gt; {
    const ctx = app.mockContext({
      // mock headers of ctx
      headers: {
        &#x27;Accept-Language&#x27;: &#x27;zh-CN,zh;q=0.5&#x27;,
      },
    });
    assert(ctx.helper.money(100) === &#x27;￥ 100&#x27;);
  });

  it(&#x27;should US Dolar&#x27;, () =&gt; {
    const ctx = app.mockContext();
    assert(ctx.helper.money(100) === &#x27;$ 100&#x27;);
  });
});</code></pre><h2 id="mock-function">Mock Function</h2><p>Except functions mentioned above, like <code>app.mockContext()</code> and <code>app.mockCsrf()</code>, egg-mock provides <a href="https://github.com/eggjs/egg-mock#api">quite a few mocking functions</a> to make writing tests easier.</p><ul><li>To prevent console logs through <code>mock.consoleLevel(&#x27;NONE&#x27;)</code></li><li>To mock session data through <code>app.mockSession(data)</code></li></ul><pre><code class="language-js">describe(&#x27;GET /session&#x27;, () =&gt; {
  it(&#x27;should mock session work&#x27;, () =&gt; {
    app.mockSession({
      foo: &#x27;bar&#x27;,
      uid: 123,
    });
    return app.httpRequest()
      .get(&#x27;/session&#x27;)
      .expect(200)
      .expect({
        session: {
          foo: &#x27;bar&#x27;,
          uid: 123,
        },
      });
  });
});</code></pre><p>Remember to restore mock data in an <code>afterEach</code> hook, otherwise it would take effect with all the tests that supposed to be independent to each other.</p><pre><code class="language-js">describe(&#x27;some test&#x27;, () =&gt; {
  // before hook

  afterEach(mock.restore);

  // it tests
});</code></pre><p><strong>When you use <code>egg-mock/bootstrap</code>, resetting work would be done automatically in an <code>afterEach</code> hook, Do not need to write these code any more.</strong></p><p>The following will describe the common usage of egg-mock.</p><h3 id="mock-properties-and-functions">Mock Properties And Functions</h3><p>Egg-mock is extended from <a href="https://github.com/node-modules/mm">mm</a> module which contains full features of mm, so we can directly mock any objects&#x27; properties and functions.</p><h4 id="mock-properties">Mock Properties</h4><p>Mock <code>app.config.baseDir</code> to return a given value - <code>/tmp/mockapp</code>.</p><pre><code class="language-js">mock(app.config, &#x27;baseDir&#x27;, &#x27;/tmp/mockapp&#x27;);
assert(app.config.baseDir === &#x27;/tmp/mockapp&#x27;);</code></pre><h4 id="mock-functions">Mock Functions</h4><p>Mock <code>fs.readFileSync</code> to return a given function.</p><pre><code class="language-js">mock(fs, &#x27;readFileSync&#x27;, filename =&gt; {
  return &#x27;hello world&#x27;;
});
assert(fs.readFileSync(&#x27;foo.txt&#x27;) === &#x27;hello world&#x27;);</code></pre><p>See more detail in <a href="https://github.com/node-modules/mm#api">mm API</a>, include advanced usage like <code>mock.data()</code>，<code>mock.error()</code> and so on.</p><h3 id="mock-service">Mock Service</h3><p>Service is a standard built-in member of the framework, <code>app.mockService(service, methodName, fn)</code> is offered to conveniently mock its result.</p><p>For example, mock the method <code>get(name)</code> in <code>app/service/user</code> to return a nonexistent user.</p><pre><code class="language-js">it(&#x27;should mock fengmk1 exists&#x27;, () =&gt; {
  app.mockService(&#x27;user&#x27;, &#x27;get&#x27;, () =&gt; {
    return {
      name: &#x27;fengmk1&#x27;,
    };
  });

  return app.httpRequest()
    .get(&#x27;/user?name=fengmk1&#x27;)
    .expect(200)
    // return an originally nonexistent user
    .expect({
      name: &#x27;fengmk1&#x27;,
    });
});</code></pre><p>Using <code>app.mockServiceError(service, methodName, error)</code> to mock exception.</p><p>For example, mock the method <code>get(name)</code> in <code>app/service/user</code> to throw an exception.</p><pre><code class="language-js">it(&#x27;should mock service error&#x27;, () =&gt; {
  app.mockServiceError(&#x27;user&#x27;, &#x27;get&#x27;, &#x27;mock user service error&#x27;);
  return app.httpRequest()
    .get(&#x27;/user?name=fengmk2&#x27;)
    // service exception causing the 500 status code
    .expect(500)
    .expect(/mock user service error/);
});</code></pre><h3 id="mock-httpclient">Mock HttpClient</h3><p>External HTTP requests should be performed though <a href="./httpclient.md">HttpClient</a>, a built-in member of Egg, and <code>app.mockHttpclient(url, method, data)</code> is able to simulate various network exceptions of requests performed by <code>app.curl</code> and <code>ctx.curl</code>.</p><p>For example, we submit a request in <code>app/controller/home.js</code>.</p><pre><code class="language-js">class HomeController extends Controller {
  async httpclient () {
    const res = await this.ctx.curl(&#x27;https://eggjs.org&#x27;);
    this.ctx.body = res.data.toString();
  }
}</code></pre><p>Then mock it&#x27;s response.</p><pre><code class="language-js">describe(&#x27;GET /httpclient&#x27;, () =&gt; {
  it(&#x27;should mock httpclient response&#x27;, () =&gt; {
    app.mockHttpclient(&#x27;https://eggjs.org&#x27;, {
      // parameter allowed to be a buffer / string / json,
      // will be finally converted to buffer
      // according to options.dataType
      data: &#x27;mock eggjs.org response&#x27;,
    });
    return app.httpRequest()
      .get(&#x27;/httpclient&#x27;)
      .expect(&#x27;mock eggjs.org response&#x27;);
  });
});</code></pre><h2 id="sample-code">Sample Code</h2><p>All sample code can be found in <a href="https://github.com/eggjs/examples/blob/master/unittest">eggjs/exmaples/unittest</a></p></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#why-unit-testing">Why Unit Testing</a></li><li><a href="#test-framework">Test Framework</a><ul><li><a href="#mocha">Mocha</a></li><li><a href="#ava">AVA</a></li></ul></li><li><a href="#assertion-library">Assertion Library</a></li><li><a href="#test-rule">Test Rule</a><ul><li><a href="#directory-structure">Directory Structure</a></li><li><a href="#test-tool">Test Tool</a></li></ul></li><li><a href="#test-preparation">Test Preparation</a><ul><li><a href="#mock">mock</a></li><li><a href="#app">app</a></li><li><a href="#ctx">ctx</a></li></ul></li><li><a href="#testing-order">Testing Order</a></li><li><a href="#asynchronous-test">Asynchronous Test</a></li><li><a href="#controller-test">Controller Test</a><ul><li><a href="#mock-csrf">mock CSRF</a></li></ul></li><li><a href="#service-test">Service Test</a></li><li><a href="#extend-test">Extend Test</a><ul><li><a href="#application">Application</a></li><li><a href="#context">Context</a></li><li><a href="#request">Request</a></li><li><a href="#response">Response</a></li><li><a href="#helper">Helper</a></li></ul></li><li><a href="#mock-function">Mock Function</a><ul><li><a href="#mock-properties-and-functions">Mock Properties And Functions</a><ul><li><a href="#mock-properties">Mock Properties</a></li><li><a href="#mock-functions">Mock Functions</a></li></ul></li><li><a href="#mock-service">Mock Service</a></li><li><a href="#mock-httpclient">Mock HttpClient</a></li></ul></li><li><a href="#sample-code">Sample Code</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"en","props":{"toc":"-%20%5BWhy%20Unit%20Testing%5D(%23why-unit-testing)%0A-%20%5BTest%20Framework%5D(%23test-framework)%0A%20%20*%20%5BMocha%5D(%23mocha)%0A%20%20*%20%5BAVA%5D(%23ava)%0A-%20%5BAssertion%20Library%5D(%23assertion-library)%0A-%20%5BTest%20Rule%5D(%23test-rule)%0A%20%20*%20%5BDirectory%20Structure%5D(%23directory-structure)%0A%20%20*%20%5BTest%20Tool%5D(%23test-tool)%0A-%20%5BTest%20Preparation%5D(%23test-preparation)%0A%20%20*%20%5Bmock%5D(%23mock)%0A%20%20*%20%5Bapp%5D(%23app)%0A%20%20*%20%5Bctx%5D(%23ctx)%0A-%20%5BTesting%20Order%5D(%23testing-order)%0A-%20%5BAsynchronous%20Test%5D(%23asynchronous-test)%0A-%20%5BController%20Test%5D(%23controller-test)%0A%20%20*%20%5Bmock%20CSRF%5D(%23mock-csrf)%0A-%20%5BService%20Test%5D(%23service-test)%0A-%20%5BExtend%20Test%5D(%23extend-test)%0A%20%20*%20%5BApplication%5D(%23application)%0A%20%20*%20%5BContext%5D(%23context)%0A%20%20*%20%5BRequest%5D(%23request)%0A%20%20*%20%5BResponse%5D(%23response)%0A%20%20*%20%5BHelper%5D(%23helper)%0A-%20%5BMock%20Function%5D(%23mock-function)%0A%20%20*%20%5BMock%20Properties%20And%20Functions%5D(%23mock-properties-and-functions)%0A%20%20%20%20%2B%20%5BMock%20Properties%5D(%23mock-properties)%0A%20%20%20%20%2B%20%5BMock%20Functions%5D(%23mock-functions)%0A%20%20*%20%5BMock%20Service%5D(%23mock-service)%0A%20%20*%20%5BMock%20HttpClient%5D(%23mock-httpclient)%0A-%20%5BSample%20Code%5D(%23sample-code)","meta":{"info":{"title":"Unit Testing"}},"content":"%0A%0A%0A%23%23%20Why%20Unit%20Testing%0A%0ALet%20us%20start%20with%20a%20few%20questions%3A%0A%0A-%20How%20to%20measure%20the%20quality%20of%20code%0A-%20How%20to%20ensure%20the%20quality%20of%20code%0A-%20Are%20you%20free%20to%20refactor%20code%0A-%20How%20to%20guarantee%20the%20correctness%20of%20refactored%20code%0A-%20Have%20you%20confidence%20to%20release%20your%20untested%20code%0A%0AIf%20you%20are%20not%20sure%2C%20you%20probably%20need%20unit%20testing.%0A%0AActually%2C%20it%20brings%20us%20tremendous%20benefits%3A%0A-%20guarantee%20the%20quality%20of%20maintaining%20code%20%0A-%20guarantee%20the%20correctness%20of%20reconstruction%0A-%20enhance%20confidence%0A-%20automation%0A%0AIt's%20more%20important%20to%20use%20unit%20tests%20in%20a%20web%20application%20during%20the%20fast%20iteration%2C%20because%20each%20testing%20case%20can%20contribute%20to%20the%20increasing%20stability%20of%20the%20application.%20The%20result%20of%20various%20inputs%20in%20each%20test%20is%20definite%2C%20so%20it's%20obvious%20to%20detect%20whether%20the%20changed%20code%20has%20an%20impact%20on%20correctness%20or%20not.%0A%0ATherefore%2C%20code%2C%20such%20as%20in%20Controller%2C%20Service%2C%20Helper%2C%20Extend%20and%20so%20on%2C%20require%20corresponding%20unit%20testing%20for%20quality%20assurances%2C%20especially%20modification%20of%20the%20framework%20or%20plugins%2C%20of%20which%20test%20coverage%20is%20strongly%20recommended%20to%20be%20100%25.%0A%0A%23%23%20Test%20Framework%0A%0AWhen%20%5Bsearching%20'test%20framework'%20in%20npm%5D(https%3A%2F%2Fwww.npmjs.com%2Fsearch%3Fq%3Dtest%2520framework%26page%3D1%26ranking%3Dpopularity)%2C%20there%20are%20a%20mass%20of%20test%20frameworks%20owning%20their%20own%20unique%20characteristics.%0A%0A%23%23%23%20Mocha%0A%0AWe%20choose%20and%20recommend%20you%20to%20use%20%5BMocha%5D(http%3A%2F%2Fmochajs.org)%2C%20which%20is%20very%20rich%20in%20functionality%20and%20supports%20running%20in%20Node.js%20and%20Browser%2C%20what's%20more%2C%20it's%20very%20friendly%20to%20asynchronous%20test%20support.%0A%0A%3E%20Mocha%20is%20a%20feature-rich%20JavaScript%20test%20framework%20running%20on%20Node.js%20and%20in%20the%20browser%2C%20making%20asynchronous%20testing%20simple%20and%20fun.%20Mocha%20tests%20run%20serially%2C%20allowing%20for%20flexible%20and%20accurate%20reporting%2C%20while%20mapping%20uncaught%20exceptions%20to%20the%20correct%20test%20cases.%0A%0A%23%23%23%20AVA%0A%0AWhy%20not%20another%20recently%20popular%20framework%20%5BAVA%5D(https%3A%2F%2Fgithub.com%2Favajs%2Fava)%20which%20looks%20like%20faster%3F%20AVA%20is%20great%2C%20but%20practice%20of%20several%20projects%20tells%20us%20the%20truth%20that%20code%20is%20harder%20to%20write.%0A%0AComments%20from%20%5B%40dead-horse%5D(https%3A%2F%2Fgithub.com%2Fdead-horse)%3A%0A%3E%20-%20AVA%20is%20not%20stable%20enough%2C%20for%20example%2C%20CPU%20capacity%20is%20going%20to%20be%20overloaded%20when%20plenty%20of%20files%20are%20running%20concurrently.%20The%20solution%20of%20setting%20parameter%20to%20control%20concurrent%20could%20work%2C%20but%20'only%20mode'%20would%20be%20not%20functioning%20any%20more.%0A%3E%20-%20Running%20cases%20concurrently%20makes%20great%20demands%20on%20implementation%2C%20because%20each%20test%20has%20to%20be%20independent%2C%20especially%20containing%20mock.%0A%3E%20-%20Considering%20the%20expensive%20initialization%20of%20app%2C%20it's%20irrational%20of%20AVA%20to%20execute%20each%20file%20in%20an%20independent%20process%20initializing%20their%20own%20app%20while%20serial%20framework%20does%20only%20one%20time.%0A%0AComments%20from%20%5B%40fool2fish%5D(https%3A%2F%2Fgithub.com%2Ffool2fish)%EF%BC%9A%0A%3E%20-%20It's%20faster%20to%20use%20AVA%20in%20simple%20application(maybe%20too%20simple%20to%20judge).%20But%20it's%20not%20recommended%20to%20use%20in%20complicate%20one%20because%20of%20its%20considerable%20flaws%2C%20such%20as%20incapability%20of%20offering%20accurate%20error%20stacks%3B%20meanwhile%2C%20concurrency%20may%20cause%20service%20relying%20on%20other%20test%20settings%20to%20hang%20up%20which%20reduces%20the%20success%20rate%20of%20the%20test.%20Therefore%2C%20process%20testing%2C%20for%20example%2C%20CRUD%20operations%20of%20database%2C%20should%20not%20use%20AVA.%0A%0A%23%23%20Assertion%20Library%0A%0A%5BAssertion%20libraries%5D(https%3A%2F%2Fwww.npmjs.com%2Fsearch%3Fq%3Dassert%26page%3D1%26ranking%3Dpopularity)%2C%20as%20flourishing%20as%20test%20frameworks%2C%20are%20emerged%20continuously.%20The%20one%20we%20used%20has%20changed%20from%20%5Bassert%5D(https%3A%2F%2Fnodejs.org%2Fapi%2Fassert.html)%20to%20%5Bshould%5D(https%3A%2F%2Fgithub.com%2Fshouldjs%2Fshould.js)%2C%20and%20then%20to%20%5Bexpect%5D(https%3A%2F%2Fgithub.com%2FAutomattic%2Fexpect.js)%0A%2C%20but%20we%20are%20still%20trying%20to%20find%20better%20one.%0A%0AIn%20the%20end%2C%20we%20go%20back%20to%20the%20original%20assertion%20library%20because%20of%20the%20appearance%20of%20%5Bpower-assert%5D%2C%20which%20best%20expresses%20%5B%E3%80%8ENo%20API%20is%20the%20best%20API%E3%80%8F%5D(https%3A%2F%2Fgithub.com%2Fatian25%2Fblog%2Fissues%2F16).%0A%0ATo%20be%20Short%2C%20Here%20are%20it's%20advantages%3A%0A-%20No%20API%20is%20the%20best%20API.%20Assert%20is%20all.%0A-%20**%20powerful%20failure%20message%20**%0A-%20**%20powerful%20failure%20message%20**%0A-%20**%20powerful%20failure%20message%20**%0A%0AYou%20may%20intentionally%20make%20mistakes%20in%20order%20to%20see%20these%20failure%20messages.%0A!%5B%5D(https%3A%2F%2Fcloud.githubusercontent.com%2Fassets%2F227713%2F20919940%2F19e83de8-bbd9-11e6-8951-bf4a332f9b5a.png)%0A%0A%23%23%20Test%20Rule%0A%0AFramework%20defines%20some%20fundamental%20rules%20on%20unit%20testing%20to%20keep%20us%20focus%20on%20coding%20rather%20than%20assistant%20work%2C%20such%20as%20how%20to%20execute%20test%20cases.%0AEgg%20does%20some%20basic%20conventions%20for%20unit%20testing.%0A%0A%23%23%23%20Directory%20Structure%0A%0ATest%20code%20is%20demand%20to%20be%20put%20in%20%60test%60%20directory%2C%20include%20%60fixtures%60%20and%20assistant%20scripts.%0A%0AEach%20Test%20file%20has%20to%20be%20named%20by%20the%20pattern%20of%20%60%24%7Bfilename%7D.test.js%60%2C%20ending%20with%20%60.test.js%60.%0A%0AFor%20example%3A%0A%0A%60%60%60bash%0Atest%0A%E2%94%9C%E2%94%80%E2%94%80%20controller%0A%E2%94%82%C2%A0%C2%A0%20%E2%94%94%E2%94%80%E2%94%80%20home.test.js%0A%E2%94%9C%E2%94%80%E2%94%80%20hello.test.js%0A%E2%94%94%E2%94%80%E2%94%80%20service%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20user.test.js%0A%60%60%60%0A%0A%23%23%23%20Test%20Tool%0A%0AConsistently%20using%20%5Begg-bin%20to%20launch%20tests%5D(.%2Fdevelopment.md%23unit_testing)%20%2C%20which%20automatically%20loads%20modules%20like%20%5BMocha%5D%2C%20%5Bco-mocha%5D%2C%20%5Bpower-assert%5D%2C%20%5Bnyc%5D%20into%20test%20scripts%2C%20so%20that%20we%20can%20**concentrate%20on%20writing%20tests**%20without%20wasting%20time%20on%20the%20choice%20of%20various%20test%20tools%20or%20modules.%0A%0AThe%20only%20thing%20you%20need%20to%20do%20is%20setting%20%60scripts.test%60%20in%20%60package.json%60.%0A%0A%60%60%60json%0A%7B%0A%20%20%22scripts%22%3A%20%7B%0A%20%20%20%20%22test%22%3A%20%22egg-bin%20test%22%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0AThen%20tests%20would%20be%20launched%20by%20executing%20%60npm%20test%60%20command.%0A%0A%60%60%60bas%0Anpm%20test%0A%0A%3E%20unittest-example%40%20test%20%2FUsers%2Fmk2%2Fgit%2Fgithub.com%2Feggjs%2Fexamples%2Funittest%0A%3E%20egg-bin%20test%0A%0A%20%20test%2Fhello.test.js%0A%20%20%20%20%E2%9C%93%20should%20work%0A%0A%20%201%20passing%20(10ms)%0A%60%60%60%0A%0A%23%23%20Test%20Preparation%0A%0AThis%20chapter%20introduces%20you%20how%20to%20write%20test%2C%20and%20introduction%20of%20tests%20for%20the%20framework%20and%20plugins%20are%20located%20in%20%5Bframework%5D(..%2Fadvanced%2Fframework.md)%20and%20%5Bplugin%5D(..%2Fadvanced%2Fplugin.md).%0A%0A%23%23%23%20mock%0A%0AGenerally%2C%20a%20complete%20application%20test%20requires%20initialization%20and%20cleanup%2C%20such%20as%20deleting%20temporary%20files%20or%20destroy%20application.%20Also%2C%20we%20have%20to%20deal%20with%20exceptional%20situations%20like%20network%20problem%20and%20exception%20visit%20of%20server.%0A%0AWe%20extracted%20an%20%5Begg-mock%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock)module%20for%20mock%2C%20help%20for%20quick%20implementation%20of%20application%20unit%20tests%2C%20supporting%20fast%20creation%20of%20ctx%20to%20test.%0A%0A%23%23%23%20app%0A%0ABefore%20launching%2C%20we%20have%20to%20create%20an%20instance%20of%20App%20to%20test%20code%20of%20application-level%20like%20Controller%2C%20Middleware%20or%20Service.%0A%0AWe%20can%20easily%20create%20an%20app%20instance%20with%20Mocha's%20%60before%60%20hook%20through%20egg-mock.%0A%0A%60%60%60js%0A%2F%2F%20test%2Fcontroller%2Fhome.test.js%0Aconst%20assert%20%3D%20require('assert')%3B%0Aconst%20mock%20%3D%20require('egg-mock')%3B%0A%0Adescribe('test%2Fcontroller%2Fhome.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20app%3B%0A%20%20before(()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20create%20a%20current%20app%20instance%0A%20%20%20%20app%20%3D%20mock.app()%3B%0A%20%20%20%20%2F%2F%20execute%20tests%20after%20app%20is%20ready%0A%20%20%20%20return%20app.ready()%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0ANow%2C%20we%20have%20an%20app%20instance%2C%20and%20it's%20the%20base%20of%20all%20the%20following%20tests.%20See%20more%20about%20app%20at%20%5B%60mock.app(options)%60%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock%23options).%0A%0AIt's%20redundancy%20to%20create%20an%20instance%20in%20each%20test%20file%2C%20so%20we%20offered%20an%20bootstrap%20file%20in%20egg-mock%20to%20create%20it%20conveniently.%0A%0A%60%60%60js%0A%2F%2F%20test%2Fcontroller%2Fhome.test.js%0Aconst%20%7B%20app%2C%20mock%2C%20assert%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('test%2Fcontroller%2Fhome.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20%2F%2F%20test%20cases%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20ctx%0A%0AExcept%20app%2C%20tests%20for%20Extend%2C%20Service%20and%20Helper%20are%20also%20taken%20into%20consideration.%20Let's%20create%20a%20context%20through%20%5B%60app.mockContext(options)%60%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock%23appmockcontextoptions)%20offered%20by%20egg-mock.%0A%0A%60%60%60js%0Ait('should%20get%20a%20ctx'%2C%20()%20%3D%3E%20%7B%0A%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20assert(ctx.method%20%3D%3D%3D%20'GET')%3B%0A%20%20assert(ctx.url%20%3D%3D%3D%20'%2F')%3B%0A%7D)%3B%0A%60%60%60%0A%0AIf%20we%20want%20to%20mock%20the%20data%20for%20%60ctx.user%60%2C%20we%20can%20do%20that%20by%20passing%20the%20data%20parameter%20to%20mockContext%3A%0A%0A%60%60%60js%0Ait('should%20mock%20ctx.user'%2C%20()%20%3D%3E%20%7B%0A%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20user%3A%20%7B%0A%20%20%20%20%20%20name%3A%20'fengmk2'%2C%0A%20%20%20%20%7D%2C%0A%20%20%7D)%3B%0A%20%20assert(ctx.user)%3B%0A%20%20assert(ctx.user.name%20%3D%3D%3D%20'fengmk2')%3B%0A%7D)%3B%0A%60%60%60%0A%0ASince%20we%20have%20got%20the%20app%20and%20the%20context%2C%20you%20are%20free%20to%20do%20a%20lot%20of%20tests.%0A%0A%23%23%20Testing%20Order%0A%0APay%20close%20attention%20to%20testing%20order%2C%20and%20make%20sure%20any%20chunk%20of%20code%20is%20executed%20as%20you%20expected.%0A%0ACommon%20Error%3A%0A%0A%60%60%60js%0A%2F%2F%20Bad%0Aconst%20%7B%20app%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('bad%20test'%2C%20()%20%3D%3E%20%7B%0A%20%20doSomethingBefore()%3B%0A%0A%20%20it('should%20redirect'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20.expect(302)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0AMocha%20is%20going%20to%20load%20all%20the%20code%20in%20the%20beginning%2C%20which%20means%20%60doSomethingBefore%60%20would%20be%20invoked%20before%20execution.%20It's%20not%20expected%20when%20especially%20using%20'only'%20to%20specify%20the%20test.%0A%0AIt's%20supposed%20to%20locate%20in%20a%20%60before%60%20hook%20in%20the%20suite%20of%20a%20particular%20test%20case.%0A%0A%60%60%60js%0A%2F%2F%20Good%0Aconst%20%7B%20app%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('good%20test'%2C%20()%20%3D%3E%20%7B%0A%20%20before(()%20%3D%3E%20doSomethingBefore())%3B%0A%0A%20%20it('should%20redirect'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20.expect(302)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0AMocha%20have%20keywords%20-%20before%2C%20after%2C%20beforeEach%20and%20afterEach%20-%20to%20set%20up%20preconditions%20and%20clean-up%20after%20your%20tests.%20These%20keywords%20could%20be%20multiple%20and%20execute%20in%20strict%20order.%0A%0A%60%60%60js%0Adescribe('egg%20test'%2C%20()%20%3D%3E%20%7B%0A%20%20before(()%20%3D%3E%20console.log('order%201'))%3B%0A%20%20before(()%20%3D%3E%20console.log('order%202'))%3B%0A%20%20after(()%20%3D%3E%20console.log('order%206'))%3B%0A%20%20beforeEach(()%20%3D%3E%20console.log('order%203'))%3B%0A%20%20afterEach(()%20%3D%3E%20console.log('order%205'))%3B%0A%20%20it('should%20worker'%2C%20()%20%3D%3E%20console.log('order%204'))%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%20Asynchronous%20Test%0A%0Aegg-bin%20supports%20asynchronous%20test%3A%0A%0A%60%60%60js%0A%2F%2F%20using%20Promise%0Ait('should%20redirect'%2C%20()%20%3D%3E%20%7B%0A%20%20return%20app.httpRequest()%0A%20%20%20%20.get('%2F')%0A%20%20%20%20.expect(302)%3B%0A%7D)%3B%0A%0A%2F%2F%20using%20callback%0Ait('should%20redirect'%2C%20done%20%3D%3E%20%7B%0A%20%20app.httpRequest()%0A%20%20%20%20.get('%2F')%0A%20%20%20%20.expect(302%2C%20done)%3B%0A%7D)%3B%0A%0A%2F%2F%20using%20async%0Ait('should%20redirect'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20await%20app.httpRequest()%0A%20%20%20%20.get('%2F')%0A%20%20%20%20.expect(302)%3B%0A%7D)%3B%0A%60%60%60%0A%0AAccording%20to%20specific%20situation%2C%20you%20could%20make%20different%20choice%20of%20these%20ways.%20Multiple%20asynchronous%20test%20cases%20could%20be%20composed%20to%20one%20test%20with%20async%20function%2C%20or%20divided%20into%20several%20independent%20tests.%0A%0A%23%23%20Controller%20Test%0A%0AIt's%20the%20tough%20part%20of%20all%20application%20tests%2C%20since%20it's%20closely%20related%20to%20router%20configuration.%20We%20need%20use%20%60app.httpRequest()%60%20to%20return%20a%20real%20instance%20%5BSuperTest%5D(https%3A%2F%2Fgithub.com%2Fvisionmedia%2Fsupertest)%2C%20which%20connects%20Router%20and%20Controller%20and%20could%20also%20help%20us%20to%20examine%20param%20verification%20of%20Router%20by%20loading%20boundary%20conditions.%20%60app.httpRequest()%60%20is%20a%20request%20instance%20%5BSuperTest%5D(https%3A%2F%2Fgithub.com%2Fvisionmedia%2Fsupertest)%20which%20is%20encapsulated%20by%20%5Begg-mock%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock).%0A%0AHere%20is%20an%20%60app%2Fcontroller%2Fhome.js%60%20example.%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20%7B%20router%2C%20controller%20%7D%20%3D%20app%3B%0A%20%20router.get('homepage'%2C%20'%2F'%2C%20controller.home.index)%3B%0A%7D%3B%0A%0A%2F%2F%20app%2Fcontroller%2Fhome.js%0Aclass%20HomeController%20extends%20Controller%20%7B%0A%20%20async%20index()%20%7B%0A%20%20%20%20this.ctx.body%20%3D%20'hello%20world'%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0AThen%20a%20test.%0A%0A%60%60%60js%0A%2F%2F%20test%2Fcontroller%2Fhome.test.js%0Aconst%20%7B%20app%2C%20mock%2C%20assert%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('test%2Fcontroller%2Fhome.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20describe('GET%20%2F'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20status%20200%20and%20get%20the%20body'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20load%20%60GET%20%2F%60%20request%0A%20%20%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20%20%20.expect(200)%20%2F%2F%20set%20expectation%20of%20status%20to%20200%0A%20%20%20%20%20%20%20%20.expect('hello%20world')%3B%20%2F%2F%20set%20expectation%20of%20body%20to%20'hello%20world'%0A%20%20%20%20%7D)%3B%0A%0A%20%20%20%20it('should%20send%20multi%20requests'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20await%20app.httpRequest()%0A%20%20%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20%20%20.expect(200)%20v%0A%20%20%20%20%20%20%20%20.expect('hello%20world')%3B%20%2F%2F%20set%20expectation%20of%20body%20to%20'hello%20world'%0A%0A%20%20%20%20%20%20%2F%2F%20once%20more%0A%20%20%20%20%20%20const%20result%20%3D%20await%20app.httpRequest()%0A%20%20%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20%20%20.expect(200)%0A%20%20%20%20%20%20%20%20.expect('hello%20world')%3B%0A%0A%20%20%20%20%20%20%2F%2F%20verify%20via%20assert%0A%20%20%20%20%20%20assert(result.status%20%3D%3D%3D%20200)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%60app.httpRequest%60%20based%20on%20SuperTest%20supports%20a%20majority%20of%20HTTP%20methods%20such%20as%20GET%2C%20POST%2C%20PUT%2C%20and%20it%20provides%20rich%20interfaces%20to%20construct%20request%2C%20such%20as%20a%20JSON%20POST%20request.%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fhome.js%0Aclass%20HomeController%20extends%20Controller%20%7B%0A%20%20async%20post()%20%7B%0A%20%20%20%20this.ctx.body%20%3D%20this.ctx.request.body%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20test%2Fcontroller%2Fhome.test.js%0Ait('should%20status%20200%20and%20get%20the%20request%20body'%2C%20()%20%3D%3E%20%7B%0A%20%20%2F%2F%20mock%20CSRF%20token%EF%BC%8Cexplain%20later%0A%20%20app.mockCsrf()%3B%0A%20%20return%20app.httpRequest()%0A%20%20%20%20.post('%2Fpost')%0A%20%20%20%20.type('form')%0A%20%20%20%20.send(%7B%0A%20%20%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%20%20%7D)%0A%20%20%20%20.expect(200)%0A%20%20%20%20.expect(%7B%0A%20%20%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0ASee%20details%20at%20%5BSuperTest%20Document%5D(https%3A%2F%2Fgithub.com%2Fvisionmedia%2Fsupertest%23getting-started)%E3%80%82%0A%0A%23%23%23%20mock%20CSRF%0A%0AThe%20security%20plugin%20of%20framework%20would%20enable%20%5BCSRF%20prevention%5D(.%2Fsecurity.md%23csrf-prevention)%20as%20default.%20Typically%2C%20tests%20have%20to%20precede%20with%20a%20request%20of%20page%20in%20order%20to%20parse%20CSRF%20token%20from%20the%20response%2C%20and%20then%20use%20the%20token%20in%20later%20POST%20requests.%20But%20egg-mock%20provides%20the%20%60app.mockCsrf()%60%20function%20to%20skip%20the%20verification%20of%20the%20CSRF%20token%20of%20requests%20sent%20by%20SuperTest.%0A%0A%60%60%60js%0Aapp.mockCsrf()%3B%0Areturn%20app.httpRequest()%0A%20%20.post('%2Fpost')%0A%20%20.type('form')%0A%20%20.send(%7B%0A%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%7D)%0A%20%20.expect(200)%0A%20%20.expect(%7B%0A%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%7D)%3B%0A%60%60%60%0A%0A%23%23%20Service%20Test%0A%0AService%20is%20easier%20to%20test%20than%20Controller.%20We%20need%20to%20create%20a%20ctx%2C%20and%20then%20get%20the%20instance%20of%20Service%20via%20%60ctx.service.%24%7BserviceName%7D%60%2C%20and%20then%20use%20the%20instance%20to%20test.%0A%0AFor%20example%3A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fservice%2Fuser.js%0Aclass%20UserService%20extends%20Service%20%7B%0A%20%20async%20get(name)%20%7B%0A%20%20%20%20return%20await%20userDatabase.get(name)%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0AAnd%20a%20test%3A%0A%0A%60%60%60js%0Adescribe('get()'%2C%20()%20%3D%3E%20%7B%0A%20%20%2F%2F%20using%20generator%20function%20because%20of%20asynchronous%20invoking%0A%20%20it('should%20get%20exists%20user'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20create%20ctx%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%20%20%2F%2F%20get%20service.user%20via%20ctx%0A%20%20%20%20const%20user%20%3D%20await%20ctx.service.user.get('fengmk2')%3B%0A%20%20%20%20assert(user)%3B%0A%20%20%20%20assert(user.name%20%3D%3D%3D%20'fengmk2')%3B%0A%20%20%7D)%3B%0A%0A%20%20it('should%20get%20null%20when%20user%20not%20exists'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%20%20const%20user%20%3D%20await%20ctx.service.user.get('fengmk1')%3B%0A%20%20%20%20assert(!user)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0AOf%20course%20it's%20just%20a%20sample%2C%20actual%20code%20would%20probably%20be%20more%20complicated.%0A%0A%23%23%20Extend%20Test%0A%0AIt's%20extendable%20of%20Application%2C%20Request%2C%20Response%20and%20Context%20as%20well%20as%20Helper%2C%20and%20we%20are%20able%20to%20write%20specific%20test%20cases%20for%20extended%20functions%20or%20properties.%0A%0A%23%23%23%20Application%0A%0AWhen%20an%20app%20instance%20is%20created%20by%20egg-mock%2C%20the%20extended%20functions%20and%20properties%20are%20already%20available%20on%20the%20instance%20and%20can%20be%20tested%20directly.%0A%0AFor%20example%2C%20we%20extend%20the%20application%20in%20%60app%2Fextend%2Fapplication%60%20to%20support%20cache%20based%20on%20%5Bylru%5D(https%3A%2F%2Fgithub.com%2Fnode-modules%2Fylru).%0A%0A%60%60%60js%0Aconst%20LRU%20%3D%20Symbol('Application%23lru')%3B%0Aconst%20LRUCache%20%3D%20require('ylru')%3B%0Amodule.exports%20%3D%20%7B%0A%20%20get%20lru()%20%7B%0A%20%20%20%20if%20(!this%5BLRU%5D)%20%7B%0A%20%20%20%20%20%20this%5BLRU%5D%20%3D%20new%20LRUCache(1000)%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20this%5BLRU%5D%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0AA%20corresponding%20test%3A%0A%0A%60%60%60js%0Adescribe('get%20lru'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20get%20a%20lru%20and%20it%20work'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20set%20cache%0A%20%20%20%20app.lru.set('foo'%2C%20'bar')%3B%0A%20%20%20%20%2F%2F%20get%20cache%0A%20%20%20%20assert(app.lru.get('foo')%20%3D%3D%3D%20'bar')%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0AAs%20you%20can%20see%2C%20it's%20easy.%0A%0A%23%23%23%20Context%0A%0ACompared%20to%20Application%2C%20you%20need%20only%20one%20more%20step%20for%20Context%20tests%2C%20which%20is%20to%20create%20an%20Context%20instance%20via%20%60app.mockContext%60.%0A%0ASuch%20as%20adding%20a%20property%20named%20%60isXHR%60%20to%20%60app%2Fextend%2Fcontext.js%60%20to%20present%20whether%20or%20not%20the%20request%20was%20submitted%20via%20%5BXMLHttpRequest%5D(https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FXMLHttpRequest%2FsetRequestHeader).%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20get%20isXHR()%20%7B%0A%20%20%20%20return%20this.get('X-Requested-With')%20%3D%3D%3D%20'XMLHttpRequest'%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0AA%20corresponding%20test%3A%0A%0A%60%60%60js%0Adescribe('isXHR()'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20true'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20%20%20'X-Requested-With'%3A%20'XMLHttpRequest'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20assert(ctx.isXHR%20%3D%3D%3D%20true)%3B%0A%20%20%7D)%3B%0A%0A%20%20it('should%20false'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20%20%20'X-Requested-With'%3A%20'SuperAgent'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20assert(ctx.isXHR%20%3D%3D%3D%20false)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20Request%0A%0AExtended%20properties%20and%20function%20are%20available%20on%20%60ctx.request%60%2C%20so%20they%20can%20be%20tested%20directly.%0A%0AFor%20example%2C%20provide%20a%20%60isChrome%60%20property%20to%20%60app%2Fextend%2Frequest.js%60%20to%20verify%20requests%20whether%20they%20are%20from%20Chrome%20or%20not.%0A%0A%60%60%60js%0Aconst%20IS_CHROME%20%3D%20Symbol('Request%23isChrome')%3B%0Amodule.exports%20%3D%20%7B%0A%20%20get%20isChrome()%20%7B%0A%20%20%20%20if%20(!this%5BIS_CHROME%5D)%20%7B%0A%20%20%20%20%20%20const%20ua%20%3D%20this.get('User-Agent').toLowerCase()%3B%0A%20%20%20%20%20%20this%5BIS_CHROME%5D%20%3D%20ua.includes('chrome%2F')%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20this%5BIS_CHROME%5D%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0AA%20corresponding%20test%3A%0A%0A%60%60%60js%0Adescribe('isChrome()'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20true'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20%20%20'User-Agent'%3A%20'Chrome%2F56.0.2924.51'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20assert(ctx.request.isChrome%20%3D%3D%3D%20true)%3B%0A%20%20%7D)%3B%0A%0A%20%20it('should%20false'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20%20%20'User-Agent'%3A%20'FireFox%2F1'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20assert(ctx.request.isChrome%20%3D%3D%3D%20false)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20Response%0A%0AIdentical%20with%20Request%2C%20Response%20test%20could%20be%20based%20on%20%60ctx.response%60%20directly%2C%20accessing%20all%20the%20extended%20functions%20and%20properties.%0A%0AFor%20example%2C%20provide%20an%20%60isSuccess%60%20property%20to%20indicate%20current%20status%20code%20equal%20to%20200%20or%20not.%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20get%20isSuccess()%20%7B%0A%20%20%20%20return%20this.status%20%3D%3D%3D%20200%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0AThe%20corresponding%20test%3A%0A%0A%60%60%60js%0Adescribe('isSuccess()'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20true'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%20%20ctx.status%20%3D%20200%3B%0A%20%20%20%20assert(ctx.response.isSuccess%20%3D%3D%3D%20true)%3B%0A%20%20%7D)%3B%0A%0A%20%20it('should%20false'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%20%20ctx.status%20%3D%20404%3B%0A%20%20%20%20assert(ctx.response.isSuccess%20%3D%3D%3D%20false)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20Helper%0A%0ASimilar%20to%20Service%2C%20Helper%20is%20available%20on%20ctx%2C%20which%20can%20be%20tested%20directly.%0A%0ASuch%20as%20%60app%2Fextend%2Fhelper.js%60%3A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20money(val)%20%7B%0A%20%20%20%20const%20lang%20%3D%20this.ctx.get('Accept-Language')%3B%0A%20%20%20%20if%20(lang.includes('zh-CN'))%20%7B%0A%20%20%20%20%20%20return%20%60%EF%BF%A5%20%24%7Bval%7D%60%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20%60%24%20%24%7Bval%7D%60%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0AA%20corresponding%20test%3A%0A%0A%60%60%60js%0Adescribe('money()'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20RMB'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20%20%20%2F%2F%20mock%20headers%20of%20ctx%0A%20%20%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20%20%20'Accept-Language'%3A%20'zh-CN%2Czh%3Bq%3D0.5'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20assert(ctx.helper.money(100)%20%3D%3D%3D%20'%EF%BF%A5%20100')%3B%0A%20%20%7D)%3B%0A%0A%20%20it('should%20US%20Dolar'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%20%20assert(ctx.helper.money(100)%20%3D%3D%3D%20'%24%20100')%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%20Mock%20Function%0A%0AExcept%20functions%20mentioned%20above%2C%20like%20%60app.mockContext()%60%20and%20%60app.mockCsrf()%60%2C%20egg-mock%20provides%20%5Bquite%20a%20few%20mocking%20functions%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock%23api)%20to%20make%20writing%20tests%20easier.%0A%0A-%20To%20prevent%20console%20logs%20through%20%60mock.consoleLevel('NONE')%60%0A-%20To%20mock%20session%20data%20through%20%60app.mockSession(data)%60%0A%0A%60%60%60js%0Adescribe('GET%20%2Fsession'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20mock%20session%20work'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20app.mockSession(%7B%0A%20%20%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%20%20%20%20uid%3A%20123%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.get('%2Fsession')%0A%20%20%20%20%20%20.expect(200)%0A%20%20%20%20%20%20.expect(%7B%0A%20%20%20%20%20%20%20%20session%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%20%20%20%20%20%20%20%20uid%3A%20123%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0ARemember%20to%20restore%20mock%20data%20in%20an%20%60afterEach%60%20hook%2C%20otherwise%20it%20would%20take%20effect%20with%20all%20the%20tests%20that%20supposed%20to%20be%20independent%20to%20each%20other.%0A%0A%60%60%60js%0Adescribe('some%20test'%2C%20()%20%3D%3E%20%7B%0A%20%20%2F%2F%20before%20hook%0A%0A%20%20afterEach(mock.restore)%3B%0A%0A%20%20%2F%2F%20it%20tests%0A%7D)%3B%0A%60%60%60%0A%0A**When%20you%20use%20%60egg-mock%2Fbootstrap%60%2C%20resetting%20work%20would%20be%20done%20automatically%20in%20an%20%60afterEach%60%20hook%2C%20Do%20not%20need%20to%20write%20these%20code%20any%20more.**%0A%0AThe%20following%20will%20describe%20the%20common%20usage%20of%20egg-mock.%0A%0A%23%23%23%20Mock%20Properties%20And%20Functions%0A%0AEgg-mock%20is%20extended%20from%20%5Bmm%5D(https%3A%2F%2Fgithub.com%2Fnode-modules%2Fmm)%20module%20which%20contains%20full%20features%20of%20mm%2C%20so%20we%20can%20directly%20mock%20any%20objects'%20properties%20and%20functions.%0A%0A%23%23%23%23%20Mock%20Properties%0A%0AMock%20%60app.config.baseDir%60%20to%20return%20a%20given%20value%20-%20%60%2Ftmp%2Fmockapp%60.%0A%0A%60%60%60js%0Amock(app.config%2C%20'baseDir'%2C%20'%2Ftmp%2Fmockapp')%3B%0Aassert(app.config.baseDir%20%3D%3D%3D%20'%2Ftmp%2Fmockapp')%3B%0A%60%60%60%0A%0A%23%23%23%23%20Mock%20Functions%0A%0AMock%20%60fs.readFileSync%60%20to%20return%20a%20given%20function.%0A%0A%60%60%60js%0Amock(fs%2C%20'readFileSync'%2C%20filename%20%3D%3E%20%7B%0A%20%20return%20'hello%20world'%3B%0A%7D)%3B%0Aassert(fs.readFileSync('foo.txt')%20%3D%3D%3D%20'hello%20world')%3B%0A%60%60%60%0A%0ASee%20more%20detail%20in%20%5Bmm%20API%5D(https%3A%2F%2Fgithub.com%2Fnode-modules%2Fmm%23api)%2C%20include%20advanced%20usage%20like%20%60mock.data()%60%EF%BC%8C%60mock.error()%60%20and%20so%20on.%0A%0A%23%23%23%20Mock%20Service%0A%0AService%20is%20a%20standard%20built-in%20member%20of%20the%20framework%2C%20%60app.mockService(service%2C%20methodName%2C%20fn)%60%20is%20offered%20to%20conveniently%20mock%20its%20result.%0A%0AFor%20example%2C%20mock%20the%20method%20%60get(name)%60%20in%20%60app%2Fservice%2Fuser%60%20to%20return%20a%20nonexistent%20user.%0A%0A%60%60%60js%0Ait('should%20mock%20fengmk1%20exists'%2C%20()%20%3D%3E%20%7B%0A%20%20app.mockService('user'%2C%20'get'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20name%3A%20'fengmk1'%2C%0A%20%20%20%20%7D%3B%0A%20%20%7D)%3B%0A%0A%20%20return%20app.httpRequest()%0A%20%20%20%20.get('%2Fuser%3Fname%3Dfengmk1')%0A%20%20%20%20.expect(200)%0A%20%20%20%20%2F%2F%20return%20an%20originally%20nonexistent%20user%0A%20%20%20%20.expect(%7B%0A%20%20%20%20%20%20name%3A%20'fengmk1'%2C%0A%20%20%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0AUsing%20%60app.mockServiceError(service%2C%20methodName%2C%20error)%60%20to%20mock%20exception.%0A%0AFor%20example%2C%20mock%20the%20method%20%60get(name)%60%20in%20%60app%2Fservice%2Fuser%60%20to%20throw%20an%20exception.%0A%0A%60%60%60js%0Ait('should%20mock%20service%20error'%2C%20()%20%3D%3E%20%7B%0A%20%20app.mockServiceError('user'%2C%20'get'%2C%20'mock%20user%20service%20error')%3B%0A%20%20return%20app.httpRequest()%0A%20%20%20%20.get('%2Fuser%3Fname%3Dfengmk2')%0A%20%20%20%20%2F%2F%20service%20exception%20causing%20the%20500%20status%20code%0A%20%20%20%20.expect(500)%0A%20%20%20%20.expect(%2Fmock%20user%20service%20error%2F)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20Mock%20HttpClient%0A%0AExternal%20HTTP%20requests%20should%20be%20performed%20though%20%5BHttpClient%5D(.%2Fhttpclient.md)%2C%20a%20built-in%20member%20of%20Egg%2C%20and%20%60app.mockHttpclient(url%2C%20method%2C%20data)%60%20is%20able%20to%20simulate%20various%20network%20exceptions%20of%20requests%20performed%20by%20%60app.curl%60%20and%20%60ctx.curl%60.%0A%0AFor%20example%2C%20we%20submit%20a%20request%20in%20%60app%2Fcontroller%2Fhome.js%60.%0A%0A%60%60%60js%0Aclass%20HomeController%20extends%20Controller%20%7B%0A%20%20async%20httpclient%20()%20%7B%0A%20%20%20%20const%20res%20%3D%20await%20this.ctx.curl('https%3A%2F%2Feggjs.org')%3B%0A%20%20%20%20this.ctx.body%20%3D%20res.data.toString()%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0AThen%20mock%20it's%20response.%0A%0A%60%60%60js%0Adescribe('GET%20%2Fhttpclient'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20mock%20httpclient%20response'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20app.mockHttpclient('https%3A%2F%2Feggjs.org'%2C%20%7B%0A%20%20%20%20%20%20%2F%2F%20parameter%20allowed%20to%20be%20a%20buffer%20%2F%20string%20%2F%20json%2C%0A%20%20%20%20%20%20%2F%2F%20will%20be%20finally%20converted%20to%20buffer%0A%20%20%20%20%20%20%2F%2F%20according%20to%20options.dataType%0A%20%20%20%20%20%20data%3A%20'mock%20eggjs.org%20response'%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.get('%2Fhttpclient')%0A%20%20%20%20%20%20.expect('mock%20eggjs.org%20response')%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%20Sample%20Code%0A%0AAll%20sample%20code%20can%20be%20found%20in%20%5Beggjs%2Fexmaples%2Funittest%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fexamples%2Fblob%2Fmaster%2Funittest)%0A%0A%5BMocha%5D%3A%20https%3A%2F%2Fmochajs.org%0A%5Bco-mocha%5D%3A%20https%3A%2F%2Fgithub.com%2Fblakeembrey%2Fco-mocha%0A%5Bnyc%5D%3A%20https%3A%2F%2Fgithub.com%2Fistanbuljs%2Fnyc%0A%5Bpower-assert%5D%3A%20https%3A%2F%2Fgithub.com%2Fpower-assert-js%2Fpower-assert%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>