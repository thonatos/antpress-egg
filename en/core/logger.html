<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Logger</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/en/intro/">Guide</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/en/tutorials/index.html">Tutorials</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">Plugins</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">Release</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>切换语言</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>Guide</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/index.html">What is Egg?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/egg-and-koa.html">Egg and Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/intro/quickstart.html">Quick Start</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/progressive.html">Progressive</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/migration.html">Migration to 2.x</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>Basis Function</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/structure.html">Directory Structure</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/objects.html">Built-in Objects</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/env.html">Environment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/config.html">Configuration</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/middleware.html">Middleware</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/plugin.html">Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/schedule.html">Schedule</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/extend.html">Extend</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/basics/app-start.html">Custom Init</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>Core</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/development.html">Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/unittest.html">Unit Testing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/deployment.html">Deployment</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/logger.html">Logger</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/cluster-and-ipc.html">Cluster and IPC</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/view.html">View</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/error-handling.html">Error Handling</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/security.html">Security</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/core/i18n.html">i18n</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>Tutorials</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/passport.html">Passport</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/assets.html">Assets</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>Advanced</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/plugin.html">Plugin Development</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/framework.html">Framework</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/cluster-client.html">Cluster Enhancement</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/advanced/view-plugin.html">View Plugin</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/style-guide.html">Style Guide</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>Community</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/plugins/">Plugin List</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/contributing.html">Contributing</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/resource.html">Resource</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/en/faq.html">FAQ</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>There is no doubt that logs are important part for monitoring application and debugging in Web development.</p><p>Built-in enterprise scaled logger, <a href="https://github.com/eggjs/egg-logger">egg-logger</a>, makes developer implement logging more easily than ever before.</p><p>Core features:</p><ul><li>Levels</li><li>Universal logging, <code>.error()</code> will save <code>ERROR</code> level logs into a file for later debugging</li><li>Logs from dispatch and runtime are separated</li><li>Create your logger</li><li>Multi-process logs</li><li>Automatic sharding</li><li>High Performance</li></ul><h2 id="location">Location</h2><ul><li>Log files are located in <code>${appInfo.root}/logs/${appInfo.name}</code> by default. For instance, <code>/home/admin/logs/example-app</code>.</li><li>To avoid conflicts between environments and provide a more convenience way to manage logs, log files will be written into <code>logs</code> directory. For instance, <code>/path/to/example-app/logs/example-app</code>.</li></ul><p>Change <code>dir</code> in logger:</p><pre><code class="language-js">// config/config.${env}.js
exports.logger = {
  dir: &#x27;/path/to/your/custom/log/dir&#x27;,
};</code></pre><h2 id="type-of-logs">Type of Logs</h2><p>Egg offers a few loggers for different scenarios:</p><ul><li>appLogger <code>${appInfo.name}-web.log</code>，for example <code>example-app-web.log</code> stores logs from application, it will be used in general.</li><li>coreLogger <code>egg-web.log</code>, logs from Egg&#x27;s core and plugin.</li><li>errorLogger <code>common-error.log</code> should not be invoked directly. However, <code>.error()</code> in every logger will redirect logs to it for debugging.</li><li>agentLogger <code>egg-agent.log</code>, logs from agent process.</li></ul><p>If you want to change names of above loggers, you can override them in config:</p><pre><code class="language-js">// config/config.${env}.js
module.exports = appInfo =&gt; {
  return {
    logger: {
      appLogName: `${appInfo.name}-web.log`,
      coreLogName: &#x27;egg-web.log&#x27;,
      agentLogName: &#x27;egg-agent.log&#x27;,
      errorLogName: &#x27;common-error.log&#x27;,
    },
  };
};</code></pre><h2 id="printing">Printing</h2><h3 id="context-logger">Context Logger</h3><p>It&#x27;s proper to log details in requests with context logger. The logger will append basics about requests to each log. For example, <code>[$userId/$ip/$traceId/${cost}ms $method $url]</code>.</p><pre><code class="language-js">ctx.logger.debug(&#x27;debug info&#x27;);
ctx.logger.info(&#x27;some request data: %j&#x27;, ctx.request.body);
ctx.logger.warn(&#x27;WARNING!!!!&#x27;);

// .error will save information in call stack into errorLog file.
// Exceptions must be guaranteed to be Error or object extended from Error, which offers a trace of what functions were called.
ctx.logger.error(new Error(&#x27;whoops&#x27;));</code></pre><p>For developers who create frameworks or plugins, <code>ctx.coreLogger</code> is another option in Context Logger.</p><pre><code class="language-js">ctx.coreLogger.info(&#x27;info&#x27;);</code></pre><h3 id="app-logger">App Logger</h3><p>For developers who want to know more details about dispatch in Egg, they can easily use <code>App Logger</code> to make that happen:</p><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  app.logger.debug(&#x27;debug info&#x27;);
  app.logger.info(&#x27;Latency: %d ms&#x27;, Date.now() - start);
  app.logger.warn(&#x27;warning!&#x27;);

  app.logger.error(someErrorObj);
};</code></pre><p><code>app.coreLogger</code> in app is similar to <code>ctx.coreLogger</code> in context:</p><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  app.coreLogger.info(&#x27;Latency: %d ms&#x27;, Date.now() - start);
};</code></pre><h3 id="agent-logger">Agent Logger</h3><p>Agent also supports <code>agent.coreLogger</code> as the same feature to context and app above.</p><pre><code class="language-js">// agent.js
module.exports = agent =&gt; {
  agent.logger.debug(&#x27;debug info&#x27;);
  agent.logger.info(&#x27;Latency: %d ms&#x27;, Date.now() - start);
  agent.logger.warn(&#x27;warning!&#x27;);

  agent.logger.error(someErrorObj);
};</code></pre><p>For more about Agent, you can take a look at <a href="./cluster-and-ipc.md">Multi-process</a>.</p><h2 id="encoding">Encoding</h2><p>The default encoding setting(<code>utf-8</code>) can be changed via <code>encoding</code> in config:</p><pre><code class="language-js">// config/config.${env}.js
exports.logger = {
  encoding: &#x27;gbk&#x27;,
};</code></pre><h2 id="log-level">Log Level</h2><p>Logs are designed in 5 levels, including <code>NONE</code>, <code>DEBUG</code>, <code>INFO</code>, <code>WARN</code> and <code>ERROR</code>. For inspecting in development, they will also be written into files and printed into terminal as well.</p><h3 id="levels">Levels</h3><p>Generally, Egg will only write logs in levels higher than <code>INFO</code>, so it means that <code>NONE</code> and <code>DEBUG</code> information will be lost in files.</p><p>If you want to change the level of the logger, you can make it as follow:</p><pre><code class="language-js">// config/config.${env}.js
exports.logger = {
  level: &#x27;DEBUG&#x27;, // logs in all level will be written into files
};</code></pre><p>Stop writing logs in all levels:</p><pre><code class="language-js">// config/config.${env}.js
exports.logger = {
  level: &#x27;NONE&#x27;,
};</code></pre><h4 id="debug-log-in-prodction-environment">DEBUG Log in Prodction Environment</h4><p>To avoid some plugin&#x27;s DEBUG logs printing in the production environment causing performance problems, the production environment prohibits printing DEBUG-level logs by default. If there is a need to print DEBUG logs for debugging in the production environment, you need to set <code>allowDebugAtProd</code> configuration to <code>ture</code>.</p><pre><code class="language-js">// config/config.prod.js
exports.logger = {
  level: &#x27;DEBUG&#x27;,
  allowDebugAtProd: true,
};</code></pre><h3 id="in-terminal">In terminal</h3><p>By default, Egg will only print out <code>INFO</code>, <code>WARN</code> and <code>ERROR</code> in terminal. <code>logger.consoleLevel</code>(default: <code>INFO</code>) is defined as the logger level in terminal. Similarly, it can be changed as following:</p><p>Print logs in all levels:</p><pre><code class="language-js">// config/config.${env}.js
exports.logger = {
  consoleLevel: &#x27;DEBUG&#x27;,
};</code></pre><p>Stop printing logs in all levels:</p><pre><code class="language-js">// config/config.${env}.js
exports.logger = {
  consoleLevel: &#x27;NONE&#x27;,
};</code></pre><h2 id="create-your-logger">Create your logger</h2><h3 id="customized">Customized</h3><p>For common scenarios, <strong>it&#x27;s unnecessary to create new logger</strong>, because too many loggers will make them hard to be managed for later debugging.</p><p>The logger you create can be declared in config:</p><pre><code class="language-js">// config/config.${env}.js
const path = require(&#x27;path&#x27;);

module.exports = appInfo =&gt; {
  return {
    customLogger: {
      xxLogger: {
        file: path.join(appInfo.root, &#x27;logs/xx.log&#x27;),
      },
    },
  };
};</code></pre><p>Now, you can get loggers via <code>app.getLogger(&#x27;xxLogger&#x27;)</code> or <code>ctx.getLogger(&#x27;xxLogger&#x27;)</code>, and the logs printed from those loggers are similar to the ones from <code>coreLogger</code>.</p><h3 id="advanced">Advanced</h3><p>Logs will be written into files by default. Further, they will also be printed into terminal in development. But what if we need to print those into another place? Creating customized transport can take you there.</p><p>Transport can be considered as a tunnel to transfer data in Egg. A logger contains multiple transports, for example the one by default contains <code>fileTransport</code> and <code>consoleTransport</code>.</p><p>For concrete scenario, we take <code>common-error.log</code> as an example, which not only printed into files, but also sent to another remote service. At first, we can create a new transport for sending logs to remote:</p><pre><code class="language-js">const co = require(&#x27;co&#x27;);
const util = require(&#x27;util&#x27;);
const Transport = require(&#x27;egg-logger&#x27;).Transport;

class RemoteErrorTransport extends Transport {

  // Create log() to upload logs
  log(level, args) {
    let log;
    if (args[0] instanceof Error) {
      const err = args[0];
      log = util.format(&#x27;%s: %s\n%s\npid: %s\n&#x27;, err.name, err.message, err.stack, process.pid);
    } else {
      log = util.format(...args);
    }

    this.options.app.curl(&#x27;http://url/to/remote/error/log/service/logs&#x27;, {
      data: log,
      method: &#x27;POST&#x27;,
    }).catch(console.error);
  }
}

// Transport attached to errorLogger in app.js, makes logs sync to it once those are created.
app.getLogger(&#x27;errorLogger&#x27;).set(&#x27;remote&#x27;, new RemoteErrorTransport({ level: &#x27;ERROR&#x27;, app }));</code></pre><p>Performance is what we always consider as important part in our services so that logs will firstly be written into memory and transferred to remote later.</p><h2 id="log-sharding">Log Sharding</h2><p>One common requirement you can find in enterprise logs is automatic log sharding, which offers a convenient way for management. Luckily, Egg takes <a href="https://github.com/eggjs/egg-logrotator">egg-logrotator</a> as built-in solution to meet the need.</p><h3 id="daily-sharding">Daily Sharding</h3><p>This is the default way in Egg to cut the logs into files named by <code>.log.YYYY-MM-DD</code> at every <code>00:00</code>. For example, <code>example-app-web.log</code> will be cut into files as follow, <code>example-app-web.log.YYYY-MM-DD</code>.</p><h3 id="size-sharding">Size Sharding</h3><p>The log file also can be cut into ones by size. For example, Egg will process <code>egg-web.log</code> when its size reach 2G:</p><pre><code class="language-js">// config/config.${env}.js
const path = require(&#x27;path&#x27;);

module.exports = appInfo =&gt; {
  return {
    logrotator: {
      filesRotateBySize: [
        path.join(appInfo.root, &#x27;logs&#x27;, appInfo.name, &#x27;egg-web.log&#x27;),
      ],
      maxFileSize: 2 * 1024 * 1024 * 1024,
    },
  };
};</code></pre><p>Logs written into <code>filesRotateBySize</code> file will never be processed again by date.</p><h3 id="hourly-sharding">Hourly Sharding</h3><p>There is another option that the log files can be divided into small ones by hour.</p><p>For example, we need to cut <code>common-error.log</code> by hour just like following implementation.</p><pre><code class="language-js">// config/config.${env}.js
const path = require(&#x27;path&#x27;);

module.exports = appInfo =&gt; {
  return {
    logrotator: {
      filesRotateByHour: [
        path.join(appInfo.root, &#x27;logs&#x27;, appInfo.name, &#x27;common-error.log&#x27;),
      ],
    },
  };
};</code></pre><p>Logs written into <code>filesRotateByHour</code> file will never be processed again by date.</p><h2 id="performance">Performance</h2><p>Generally, requests are frequent events to Web services, so writing logs into disk after each event will cause more unexpected I/O. Egg takes following strategy to write logs:</p><blockquote><p>Logs will be firstly transferred into memory, and then Egg will asynchronously write them into files by second.</p></blockquote><p>More about <a href="https://github.com/eggjs/egg-logger">egg-logger</a> and <a href="https://github.com/eggjs/egg-logrotator">egg-logrotator</a>。</p></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#location">Location</a></li><li><a href="#type-of-logs">Type of Logs</a></li><li><a href="#printing">Printing</a><ul><li><a href="#context-logger">Context Logger</a></li><li><a href="#app-logger">App Logger</a></li><li><a href="#agent-logger">Agent Logger</a></li></ul></li><li><a href="#encoding">Encoding</a></li><li><a href="#log-level">Log Level</a><ul><li><a href="#levels">Levels</a><ul><li><a href="#debug-log-in-prodction-environment">DEBUG Log in Prodction Environment</a></li></ul></li><li><a href="#in-terminal">In terminal</a></li></ul></li><li><a href="#create-your-logger">Create your logger</a><ul><li><a href="#customized">Customized</a></li><li><a href="#advanced">Advanced</a></li></ul></li><li><a href="#log-sharding">Log Sharding</a><ul><li><a href="#daily-sharding">Daily Sharding</a></li><li><a href="#size-sharding">Size Sharding</a></li><li><a href="#hourly-sharding">Hourly Sharding</a></li></ul></li><li><a href="#performance">Performance</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"en","props":{"toc":"-%20%5BLocation%5D(%23location)%0A-%20%5BType%20of%20Logs%5D(%23type-of-logs)%0A-%20%5BPrinting%5D(%23printing)%0A%20%20*%20%5BContext%20Logger%5D(%23context-logger)%0A%20%20*%20%5BApp%20Logger%5D(%23app-logger)%0A%20%20*%20%5BAgent%20Logger%5D(%23agent-logger)%0A-%20%5BEncoding%5D(%23encoding)%0A-%20%5BLog%20Level%5D(%23log-level)%0A%20%20*%20%5BLevels%5D(%23levels)%0A%20%20%20%20%2B%20%5BDEBUG%20Log%20in%20Prodction%20Environment%5D(%23debug-log-in-prodction-environment)%0A%20%20*%20%5BIn%20terminal%5D(%23in-terminal)%0A-%20%5BCreate%20your%20logger%5D(%23create-your-logger)%0A%20%20*%20%5BCustomized%5D(%23customized)%0A%20%20*%20%5BAdvanced%5D(%23advanced)%0A-%20%5BLog%20Sharding%5D(%23log-sharding)%0A%20%20*%20%5BDaily%20Sharding%5D(%23daily-sharding)%0A%20%20*%20%5BSize%20Sharding%5D(%23size-sharding)%0A%20%20*%20%5BHourly%20Sharding%5D(%23hourly-sharding)%0A-%20%5BPerformance%5D(%23performance)","meta":{"info":{"title":"Logger"}},"content":"%0A%0A%0AThere%20is%20no%20doubt%20that%20logs%20are%20important%20part%20for%20monitoring%20application%20and%20debugging%20in%20Web%20development.%0A%0ABuilt-in%20enterprise%20scaled%20logger%2C%20%5Begg-logger%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-logger)%2C%20makes%20developer%20implement%20logging%20more%20easily%20than%20ever%20before.%0A%0ACore%20features%3A%0A%0A-%20Levels%0A-%20Universal%20logging%2C%20%60.error()%60%20will%20save%20%60ERROR%60%20level%20logs%20into%20a%20file%20for%20later%20debugging%0A-%20Logs%20from%20dispatch%20and%20runtime%20are%20separated%0A-%20Create%20your%20logger%0A-%20Multi-process%20logs%0A-%20Automatic%20sharding%0A-%20High%20Performance%0A%0A%23%23%20Location%0A%0A-%20Log%20files%20are%20located%20in%20%60%24%7BappInfo.root%7D%2Flogs%2F%24%7BappInfo.name%7D%60%20by%20default.%20For%20instance%2C%20%60%2Fhome%2Fadmin%2Flogs%2Fexample-app%60.%0A-%20To%20avoid%20conflicts%20between%20environments%20and%20provide%20a%20more%20convenience%20way%20to%20manage%20logs%2C%20log%20files%20will%20be%20written%20into%20%60logs%60%20directory.%20For%20instance%2C%20%60%2Fpath%2Fto%2Fexample-app%2Flogs%2Fexample-app%60.%0A%0AChange%20%60dir%60%20in%20logger%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Aexports.logger%20%3D%20%7B%0A%20%20dir%3A%20'%2Fpath%2Fto%2Fyour%2Fcustom%2Flog%2Fdir'%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20Type%20of%20Logs%0A%0AEgg%20offers%20a%20few%20loggers%20for%20different%20scenarios%3A%0A%0A-%20appLogger%20%60%24%7BappInfo.name%7D-web.log%60%EF%BC%8Cfor%20example%20%60example-app-web.log%60%20stores%20logs%20from%20application%2C%20it%20will%20be%20used%20in%20general.%0A-%20coreLogger%20%60egg-web.log%60%2C%20logs%20from%20Egg's%20core%20and%20plugin.%0A-%20errorLogger%20%60common-error.log%60%20should%20not%20be%20invoked%20directly.%20However%2C%20%60.error()%60%20in%20every%20logger%20will%20redirect%20logs%20to%20it%20for%20debugging.%0A-%20agentLogger%20%60egg-agent.log%60%2C%20logs%20from%20agent%20process.%0A%0AIf%20you%20want%20to%20change%20names%20of%20above%20loggers%2C%20you%20can%20override%20them%20in%20config%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Amodule.exports%20%3D%20appInfo%20%3D%3E%20%7B%0A%20%20return%20%7B%0A%20%20%20%20logger%3A%20%7B%0A%20%20%20%20%20%20appLogName%3A%20%60%24%7BappInfo.name%7D-web.log%60%2C%0A%20%20%20%20%20%20coreLogName%3A%20'egg-web.log'%2C%0A%20%20%20%20%20%20agentLogName%3A%20'egg-agent.log'%2C%0A%20%20%20%20%20%20errorLogName%3A%20'common-error.log'%2C%0A%20%20%20%20%7D%2C%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20Printing%0A%0A%23%23%23%20Context%20Logger%0A%0AIt's%20proper%20to%20log%20details%20in%20requests%20with%20context%20logger.%20The%20logger%20will%20append%20basics%20about%20requests%20to%20each%20log.%20For%20example%2C%20%60%5B%24userId%2F%24ip%2F%24traceId%2F%24%7Bcost%7Dms%20%24method%20%24url%5D%60.%0A%0A%60%60%60js%0Actx.logger.debug('debug%20info')%3B%0Actx.logger.info('some%20request%20data%3A%20%25j'%2C%20ctx.request.body)%3B%0Actx.logger.warn('WARNING!!!!')%3B%0A%0A%2F%2F%20.error%20will%20save%20information%20in%20call%20stack%20into%20errorLog%20file.%0A%2F%2F%20Exceptions%20must%20be%20guaranteed%20to%20be%20Error%20or%20object%20extended%20from%20Error%2C%20which%20offers%20a%20trace%20of%20what%20functions%20were%20called.%0Actx.logger.error(new%20Error('whoops'))%3B%0A%60%60%60%0A%0AFor%20developers%20who%20create%20frameworks%20or%20plugins%2C%20%60ctx.coreLogger%60%20is%20another%20option%20in%20Context%20Logger.%0A%0A%60%60%60js%0Actx.coreLogger.info('info')%3B%0A%60%60%60%0A%0A%23%23%23%20App%20Logger%0A%0AFor%20developers%20who%20want%20to%20know%20more%20details%20about%20dispatch%20in%20Egg%2C%20they%20can%20easily%20use%20%60App%20Logger%60%20to%20make%20that%20happen%3A%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.logger.debug('debug%20info')%3B%0A%20%20app.logger.info('Latency%3A%20%25d%20ms'%2C%20Date.now()%20-%20start)%3B%0A%20%20app.logger.warn('warning!')%3B%0A%0A%20%20app.logger.error(someErrorObj)%3B%0A%7D%3B%0A%60%60%60%0A%0A%60app.coreLogger%60%20in%20app%20is%20similar%20to%20%60ctx.coreLogger%60%20in%20context%3A%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.coreLogger.info('Latency%3A%20%25d%20ms'%2C%20Date.now()%20-%20start)%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20Agent%20Logger%0A%0AAgent%20also%20supports%20%60agent.coreLogger%60%20as%20the%20same%20feature%20to%20context%20and%20app%20above.%0A%0A%60%60%60js%0A%2F%2F%20agent.js%0Amodule.exports%20%3D%20agent%20%3D%3E%20%7B%0A%20%20agent.logger.debug('debug%20info')%3B%0A%20%20agent.logger.info('Latency%3A%20%25d%20ms'%2C%20Date.now()%20-%20start)%3B%0A%20%20agent.logger.warn('warning!')%3B%0A%0A%20%20agent.logger.error(someErrorObj)%3B%0A%7D%3B%0A%60%60%60%0A%0AFor%20more%20about%20Agent%2C%20you%20can%20take%20a%20look%20at%20%5BMulti-process%5D(.%2Fcluster-and-ipc.md).%0A%0A%23%23%20Encoding%0A%0AThe%20default%20encoding%20setting(%60utf-8%60)%20can%20be%20changed%20via%20%60encoding%60%20in%20config%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Aexports.logger%20%3D%20%7B%0A%20%20encoding%3A%20'gbk'%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20Log%20Level%0A%0ALogs%20are%20designed%20in%205%20levels%2C%20including%20%60NONE%60%2C%20%60DEBUG%60%2C%20%60INFO%60%2C%20%60WARN%60%20and%20%60ERROR%60.%20For%20inspecting%20in%20development%2C%20they%20will%20also%20be%20written%20into%20files%20and%20printed%20into%20terminal%20as%20well.%0A%0A%23%23%23%20Levels%0A%0AGenerally%2C%20Egg%20will%20only%20write%20logs%20in%20levels%20higher%20than%20%60INFO%60%2C%20so%20it%20means%20that%20%60NONE%60%20and%20%60DEBUG%60%20information%20will%20be%20lost%20in%20files.%0A%0AIf%20you%20want%20to%20change%20the%20level%20of%20the%20logger%2C%20you%20can%20make%20it%20as%20follow%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Aexports.logger%20%3D%20%7B%0A%20%20level%3A%20'DEBUG'%2C%20%2F%2F%20logs%20in%20all%20level%20will%20be%20written%20into%20files%0A%7D%3B%0A%60%60%60%0A%0AStop%20writing%20logs%20in%20all%20levels%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Aexports.logger%20%3D%20%7B%0A%20%20level%3A%20'NONE'%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%23%20DEBUG%20Log%20in%20Prodction%20Environment%0A%0ATo%20avoid%20some%20plugin's%20DEBUG%20logs%20printing%20in%20the%20production%20environment%20causing%20performance%20problems%2C%20the%20production%20environment%20prohibits%20printing%20DEBUG-level%20logs%20by%20default.%20If%20there%20is%20a%20need%20to%20print%20DEBUG%20logs%20for%20debugging%20in%20the%20production%20environment%2C%20you%20need%20to%20set%20%60allowDebugAtProd%60%20configuration%20to%20%60ture%60.%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.prod.js%0Aexports.logger%20%3D%20%7B%0A%20%20level%3A%20'DEBUG'%2C%0A%20%20allowDebugAtProd%3A%20true%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20In%20terminal%0A%0ABy%20default%2C%20Egg%20will%20only%20print%20out%20%60INFO%60%2C%20%60WARN%60%20and%20%60ERROR%60%20in%20terminal.%20%60logger.consoleLevel%60(default%3A%20%60INFO%60)%20is%20defined%20as%20the%20logger%20level%20in%20terminal.%20Similarly%2C%20it%20can%20be%20changed%20as%20following%3A%0A%0APrint%20logs%20in%20all%20levels%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Aexports.logger%20%3D%20%7B%0A%20%20consoleLevel%3A%20'DEBUG'%2C%0A%7D%3B%0A%60%60%60%0A%0AStop%20printing%20logs%20in%20all%20levels%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Aexports.logger%20%3D%20%7B%0A%20%20consoleLevel%3A%20'NONE'%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20Create%20your%20logger%0A%0A%23%23%23%20Customized%0A%0AFor%20common%20scenarios%2C%20**it's%20unnecessary%20to%20create%20new%20logger**%2C%20because%20too%20many%20loggers%20will%20make%20them%20hard%20to%20be%20managed%20for%20later%20debugging.%0A%0AThe%20logger%20you%20create%20can%20be%20declared%20in%20config%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Aconst%20path%20%3D%20require('path')%3B%0A%0Amodule.exports%20%3D%20appInfo%20%3D%3E%20%7B%0A%20%20return%20%7B%0A%20%20%20%20customLogger%3A%20%7B%0A%20%20%20%20%20%20xxLogger%3A%20%7B%0A%20%20%20%20%20%20%20%20file%3A%20path.join(appInfo.root%2C%20'logs%2Fxx.log')%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D%2C%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0ANow%2C%20you%20can%20get%20loggers%20via%20%60app.getLogger('xxLogger')%60%20or%20%60ctx.getLogger('xxLogger')%60%2C%20and%20the%20logs%20printed%20from%20those%20loggers%20are%20similar%20to%20the%20ones%20from%20%60coreLogger%60.%0A%0A%23%23%23%20Advanced%0A%0ALogs%20will%20be%20written%20into%20files%20by%20default.%20Further%2C%20they%20will%20also%20be%20printed%20into%20terminal%20in%20development.%20But%20what%20if%20we%20need%20to%20print%20those%20into%20another%20place%3F%20Creating%20customized%20transport%20can%20take%20you%20there.%0A%0ATransport%20can%20be%20considered%20as%20a%20tunnel%20to%20transfer%20data%20in%20Egg.%20A%20logger%20contains%20multiple%20transports%2C%20for%20example%20the%20one%20by%20default%20contains%20%60fileTransport%60%20and%20%60consoleTransport%60.%0A%0AFor%20concrete%20scenario%2C%20we%20take%20%60common-error.log%60%20as%20an%20example%2C%20which%20not%20only%20printed%20into%20files%2C%20but%20also%20sent%20to%20another%20remote%20service.%20At%20first%2C%20we%20can%20create%20a%20new%20transport%20for%20sending%20logs%20to%20remote%3A%0A%0A%60%60%60js%0Aconst%20co%20%3D%20require('co')%3B%0Aconst%20util%20%3D%20require('util')%3B%0Aconst%20Transport%20%3D%20require('egg-logger').Transport%3B%0A%0Aclass%20RemoteErrorTransport%20extends%20Transport%20%7B%0A%0A%20%20%2F%2F%20Create%20log()%20to%20upload%20logs%0A%20%20log(level%2C%20args)%20%7B%0A%20%20%20%20let%20log%3B%0A%20%20%20%20if%20(args%5B0%5D%20instanceof%20Error)%20%7B%0A%20%20%20%20%20%20const%20err%20%3D%20args%5B0%5D%3B%0A%20%20%20%20%20%20log%20%3D%20util.format('%25s%3A%20%25s%5Cn%25s%5Cnpid%3A%20%25s%5Cn'%2C%20err.name%2C%20err.message%2C%20err.stack%2C%20process.pid)%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20log%20%3D%20util.format(...args)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20this.options.app.curl('http%3A%2F%2Furl%2Fto%2Fremote%2Ferror%2Flog%2Fservice%2Flogs'%2C%20%7B%0A%20%20%20%20%20%20data%3A%20log%2C%0A%20%20%20%20%20%20method%3A%20'POST'%2C%0A%20%20%20%20%7D).catch(console.error)%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20Transport%20attached%20to%20errorLogger%20in%20app.js%2C%20makes%20logs%20sync%20to%20it%20once%20those%20are%20created.%0Aapp.getLogger('errorLogger').set('remote'%2C%20new%20RemoteErrorTransport(%7B%20level%3A%20'ERROR'%2C%20app%20%7D))%3B%0A%60%60%60%0A%0APerformance%20is%20what%20we%20always%20consider%20as%20important%20part%20in%20our%20services%20so%20that%20logs%20will%20firstly%20be%20written%20into%20memory%20and%20transferred%20to%20remote%20later.%0A%0A%23%23%20Log%20Sharding%0A%0AOne%20common%20requirement%20you%20can%20find%20in%20enterprise%20logs%20is%20automatic%20log%20sharding%2C%20which%20offers%20a%20convenient%20way%20for%20management.%20Luckily%2C%20Egg%20takes%20%5Begg-logrotator%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-logrotator)%20as%20built-in%20solution%20to%20meet%20the%20need.%0A%0A%23%23%23%20Daily%20Sharding%0A%0AThis%20is%20the%20default%20way%20in%20Egg%20to%20cut%20the%20logs%20into%20files%20named%20by%20%60.log.YYYY-MM-DD%60%20at%20every%20%6000%3A00%60.%20For%20example%2C%20%60example-app-web.log%60%20will%20be%20cut%20into%20files%20as%20follow%2C%20%60example-app-web.log.YYYY-MM-DD%60.%0A%0A%23%23%23%20Size%20Sharding%0A%0AThe%20log%20file%20also%20can%20be%20cut%20into%20ones%20by%20size.%20For%20example%2C%20Egg%20will%20process%20%60egg-web.log%60%20when%20its%20size%20reach%202G%3A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Aconst%20path%20%3D%20require('path')%3B%0A%0Amodule.exports%20%3D%20appInfo%20%3D%3E%20%7B%0A%20%20return%20%7B%0A%20%20%20%20logrotator%3A%20%7B%0A%20%20%20%20%20%20filesRotateBySize%3A%20%5B%0A%20%20%20%20%20%20%20%20path.join(appInfo.root%2C%20'logs'%2C%20appInfo.name%2C%20'egg-web.log')%2C%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20maxFileSize%3A%202%20*%201024%20*%201024%20*%201024%2C%0A%20%20%20%20%7D%2C%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0ALogs%20written%20into%20%60filesRotateBySize%60%20file%20will%20never%20be%20processed%20again%20by%20date.%0A%0A%23%23%23%20Hourly%20Sharding%0A%0AThere%20is%20another%20option%20that%20the%20log%20files%20can%20be%20divided%20into%20small%20ones%20by%20hour.%0A%0AFor%20example%2C%20we%20need%20to%20cut%20%60common-error.log%60%20by%20hour%20just%20like%20following%20implementation.%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Aconst%20path%20%3D%20require('path')%3B%0A%0Amodule.exports%20%3D%20appInfo%20%3D%3E%20%7B%0A%20%20return%20%7B%0A%20%20%20%20logrotator%3A%20%7B%0A%20%20%20%20%20%20filesRotateByHour%3A%20%5B%0A%20%20%20%20%20%20%20%20path.join(appInfo.root%2C%20'logs'%2C%20appInfo.name%2C%20'common-error.log')%2C%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%7D%2C%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0ALogs%20written%20into%20%60filesRotateByHour%60%20file%20will%20never%20be%20processed%20again%20by%20date.%0A%0A%23%23%20Performance%0A%0AGenerally%2C%20requests%20are%20frequent%20events%20to%20Web%20services%2C%20so%20writing%20logs%20into%20disk%20after%20each%20event%20will%20cause%20more%20unexpected%20I%2FO.%20Egg%20takes%20following%20strategy%20to%20write%20logs%3A%0A%0A%3E%20Logs%20will%20be%20firstly%20transferred%20into%20memory%2C%20and%20then%20Egg%20will%20asynchronously%20write%20them%20into%20files%20by%20second.%0A%0AMore%20about%20%5Begg-logger%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-logger)%20and%20%5Begg-logrotator%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-logrotator)%E3%80%82%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>