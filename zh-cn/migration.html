<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Egg@2 升级指南</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><h2 id="背景">背景</h2><p>随着 Node.js 8 LTS 的发布， 内建了对 ES2017 Async Function 的支持。</p><p>在这之前，TJ 的 <a href="https://github.com/tj/co">co</a> 使我们可以提前享受到 <code>async/await</code> 的编程体验，但同时它不可避免的也带来一些问题：</p><ul><li>性能损失</li><li><a href="https://github.com/eggjs/egg/wiki/co-vs-async">错误堆栈不友好</a></li></ul><p>现在 Egg 正式发布了 2.x 版本：</p><ul><li>保持了对 Egg 1.x 以及 <code>generator function</code> 的<strong>完全兼容</strong>。</li><li>基于 Koa 2.x，异步解决方案基于 <code>async function</code>。</li><li>只支持 Node.js 8 及以上版本。</li><li>去除 <a href="https://github.com/tj/co">co</a> 后堆栈信息更清晰，带来 30% 左右的性能提升（不含 Node 带来的性能提升），详细参见：<a href="https://eggjs.github.io/benchmark/plot/">benchmark</a>。</li></ul><p>Egg 的理念之一是<code>渐进式增强</code>，故我们为开发者提供<code>渐进升级</code>的体验。</p><ul><li><a href="#快速升级">快速升级</a></li><li><a href="#插件变更说明">插件变更说明</a></li><li><a href="#进一步升级">进一步升级</a></li><li><a href="#插件升级">针对<code>插件开发者</code>的升级指南</a></li></ul><h2 id="快速升级">快速升级</h2><ul><li>Node.js 使用最新的 LTS 版本（<code>&gt;=8.9.0</code>）。</li><li>修改 <code>package.json</code> 中 <code>egg</code> 的依赖为 <code>^2.0.0</code>。</li><li>检查相关插件是否发布新版本（可选）。</li><li>重新安装依赖，跑单元测试。</li></ul><p><strong>搞定！几乎不需要修改任何一行代码，就已经完成了升级。</strong></p><h2 id="插件变更说明">插件变更说明</h2><h3 id="egg-multipart">egg-multipart</h3><p><code>yield parts</code> 需修改为 <code>await parts()</code> 或 <code>yield parts()</code></p><pre><code class="language-js">// old
const parts = ctx.multipart();
while ((part = yield parts) != null) {
  // do something
}

// yield parts() also work
while ((part = yield parts()) != null) {
  // do something
}

// new
const parts = ctx.multipart();
while ((part = await parts()) != null) {
  // do something
}</code></pre><ul><li><a href="https://github.com/eggjs/egg-multipart#upload-multiple-files">egg-multipart#upload-multiple-files</a></li></ul><h3 id="egg-userrole">egg-userrole</h3><p>不再兼容 1.x 形式的 role 定义，因为 koa-roles 已经无法兼容了。
请求上下文 <code>Context</code> 从 this 传入改成了第一个参数 <code>ctx</code> 传入，原有的 <code>scope</code> 变成了第二个参数。</p><pre><code class="language-js">// old
app.role.use(&#x27;user&#x27;, function() {
  return !!this.user;
});

// new
app.role.use((ctx, scope) =&gt; {
  return !!ctx.user
});

app.role.use(&#x27;user&#x27;, ctx =&gt; {
  return !!ctx.user;
});</code></pre><ul><li><a href="https://github.com/koajs/koa-roles/pull/13">koajs/koa-roles#13</a></li><li><a href="https://github.com/eggjs/egg-userrole/pull/9">eggjs/egg-userrole#9</a></li></ul><h2 id="进一步升级">进一步升级</h2><p>得益于 Egg 对 1.x 的<strong>完全兼容</strong>，我们可以如何非常快速的完成升级。</p><p>不过，为了更好的统一代码风格，以及更佳的性能和错误堆栈，我们建议开发者进一步升级：</p><ul><li>修改为推荐的代码风格，传送门：<a href="./style-guide.md">代码风格指南</a></li><li><a href="#中间件使用-Koa2-风格">中间件使用 Koa2 风格</a></li><li><a href="#yieldable-To-awaitable">函数调用的 <code>yieldable</code> 转为 <code>awaitable</code></a></li></ul><h3 id="中间件使用-koa2-风格">中间件使用 Koa2 风格</h3><blockquote><p>2.x 仍然保持对 1.x 风格的中间件的兼容，故不修改也能继续使用。</p></blockquote><ul><li>返回的函数入参改为 Koa 2 的 <code>(ctx, next)</code> 风格。<ul><li>第一个参数为 <code>ctx</code>，代表当前请求的上下文，是 <a href="./basics/extend.md#Context">Context</a> 的实例。</li><li>第二个参数为 <code>next</code>，用 await 执行它来执行后续中间件的逻辑。</li></ul></li><li>不建议使用 <code>async (ctx, next) =&gt; {}</code> 格式，避免错误堆栈丢失函数名。</li><li><code>yield next</code> 改为函数调用 <code>await next()</code> 的方式。</li></ul><pre><code class="language-js">// 1.x
module.exports = () =&gt; {
  return function* responseTime(next) {
    const start = Date.now();
    yield next;
    const delta = Math.ceil(Date.now() - start);
    this.set(&#x27;X-Response-Time&#x27;, delta + &#x27;ms&#x27;);
  };
};

// 2.x
module.exports = () =&gt; {
  return async function responseTime(ctx, next) {
    const start = Date.now();
    // 注意，和 generator function 格式的中间件不同，此时 next 是一个方法，必须要调用它
    await next();
    const delta = Math.ceil(Date.now() - start);
    ctx.set(&#x27;X-Response-Time&#x27;, delta + &#x27;ms&#x27;);
  };
};</code></pre><h3 id="yieldable-to-awaitable">yieldable to awaitable</h3><blockquote><p>我们早在 Egg 1.x 时就已经支持 async，故若应用层已经是 async-base 的，就可以跳过本小节内容了。</p></blockquote><p><a href="https://github.com/tj/co">co</a> 支持了 <code>yieldable</code> 兼容类型：</p><ul><li>promises</li><li>array (parallel execution)</li><li>objects (parallel execution)</li><li>thunks (functions)</li><li>generators (delegation)</li><li>generator functions (delegation)</li></ul><p>尽管 <code>generator</code> 和 <code>async</code> 两者的编程模型基本一模一样，但由于上述的 <code>co</code> 的一些特殊处理，导致在移除 <code>co</code> 后，我们需要根据不同场景自行处理：</p><h4 id="promise">promise</h4><p>直接替换即可：</p><pre><code class="language-js">function echo(msg) {
  return Promise.resolve(msg);
}

yield echo(&#x27;hi egg&#x27;);
// change to
await echo(&#x27;hi egg&#x27;);</code></pre><h4 id="array-yield">array - yield []</h4><p><code>yield []</code> 常用于并发请求，如：</p><pre><code class="language-js">const [ news, user ] = yield [
  ctx.service.news.list(topic),
  ctx.service.user.get(uid),
];</code></pre><p>这种修改起来比较简单，用 <code>Promise.all()</code> 包装下即可：</p><pre><code class="language-js">const [ news, user ] = await Promise.all([
  ctx.service.news.list(topic),
  ctx.service.user.get(uid),
]);</code></pre><h4 id="object-yield">object - yield {}</h4><p><code>yield {}</code> 和 <code>yield map</code> 的方式也常用于并发请求，但由于 <code>Promise.all</code> 不支持 Object，会稍微有点复杂。</p><pre><code class="language-js">// app/service/biz.js
class BizService extends Service {
  * list(topic, uid) {
    return {
      news: ctx.service.news.list(topic),
      user: ctx.service.user.get(uid),
    };
  }
}

// app/controller/home.js
const { news, user } = yield ctx.service.biz.list(topic, uid);</code></pre><p>建议修改为 <code>await Promise.all([])</code> 的方式：</p><pre><code class="language-js">// app/service/biz.js
class BizService extends Service {
  list(topic, uid) {
    return Promise.all([
      ctx.service.news.list(topic),
      ctx.service.user.get(uid),
    ]);
  }
}

// app/controller/home.js
const [ news, user ] = await ctx.service.biz.list(topic, uid);</code></pre><p>如果无法修改对应的接口，可以临时兼容下：</p><ul><li>使用我们提供的 Utils 方法 <a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L353">app.toPromise</a>。</li><li><strong>建议尽量改掉，因为实际上就是丢给 co，会带回对应的性能损失和堆栈问题。</strong></li></ul><pre><code class="language-js">const { news, user } = await app.toPromise(ctx.service.biz.list(topic, uid));</code></pre><h4 id="其他">其他</h4><ul><li>thunks (functions)</li><li>generators (delegation)</li><li>generator functions (delegation)</li></ul><p>修改为对应的 async function 即可，如果不能修改，则可以用 <a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L344">app.toAsyncFunction</a> 简单包装下。</p><p><strong>注意</strong></p><ul><li><a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L344">toAsyncFunction</a> 和 <a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L353">toPromise</a> 实际使用的是 <a href="https://github.com/tj/co">co</a> 包装，因此会带回对应的性能损失和堆栈问题，建议开发者还是尽量全链路升级。</li><li><a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L344">toAsyncFunction</a> 在调用 async function 时不会有损失。</li></ul><p>@sindresorhus 编写了许多<a href="https://github.com/sindresorhus/promise-fun">基于 promise 的 helper 方法</a>，灵活的运用它们配合 async function 能让代码更加具有可读性。</p><h2 id="插件升级">插件升级</h2><p><code>应用开发者</code>只需升级<code>插件开发者</code>修改后的依赖版本即可，也可以用我们提供的命令 <code>egg-bin autod</code> 快速更新。</p><p>以下内容针对<code>插件开发者</code>，指导如何升级插件：</p><h3 id="升级事项">升级事项</h3><ul><li>完成上面章节提到的升级项。<ul><li>所有的 <code>generator function</code> 改为 <code>async function</code> 格式。</li><li>升级中间件风格。</li></ul></li><li>接口兼容（可选），如下。</li><li>发布大版本。</li></ul><h3 id="接口兼容">接口兼容</h3><p>某些场景下，<code>插件开发者</code>提供给<code>应用开发者</code>的接口是同时支持 generator 和 async 的，一般是会用 co 包装一层。</p><ul><li>在 2.x 里为了更好的性能和错误堆栈，我们建议修改为 <code>async-first</code>。</li><li>如有需要，使用 <a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L344">toAsyncFunction</a> 和 <a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L353">toPromise</a> 来兼容。</li></ul><p>譬如 <a href="https://github.com/eggjs/egg-schedule">egg-schedule</a> 插件，支持应用层使用 generator 或 async 定义 task。</p><pre><code class="language-js">// {app_root}/app/schedule/cleandb.js
exports.task = function* (ctx) {
  yield ctx.service.db.clean();
};

// {app_root}/app/schedule/log.js
exports.task = async function splitLog(ctx) {
  await ctx.service.log.split();
};</code></pre><p><code>插件开发者</code>可以简单包装下原始函数：</p><pre><code class="language-js">// https://github.com/eggjs/egg-schedule/blob/80252ef/lib/load_schedule.js#L38
task = app.toAsyncFunction(schedule.task);</code></pre><h3 id="插件发布规则">插件发布规则</h3><ul><li><strong>需要发布大版本</strong><ul><li>除非插件提供的接口都是 promise 的，且代码里面不存在 <code>async</code>，如 <a href="https://github.com/eggjs/egg-view-nunjucks">egg-view-nunjucks</a>。</li></ul></li><li>修改 <code>package.json</code><ul><li>修改 <code>devDependencies</code> 依赖的 <code>egg</code> 为 <code>^2.0.0</code>。</li><li>修改 <code>engines.node</code> 为 <code>&gt;=8.0.0</code>。</li><li>修改 <code>ci.version</code> 为 <code>8, 9</code>， 并重新安装依赖以便生成新的 travis 配置文件。</li></ul></li><li>修改 <code>README.md</code> 的示例为 async function。</li><li>编写升级指引。</li><li>修改 <code>test/fixtures</code> 为 async function，可选，建议分开另一个 PR 方便 Review。</li></ul><p>一般还会需要继续维护上一个版本，故需要：</p><ul><li>对上一个版本建立一个 <code>1.x</code> 这类的 branch 分支</li><li>修改上一个版本的 <code>package.json</code> 的 <code>publishConfig.tag</code> 为 <code>release-1.x</code></li><li>这样如果上一个版本有 BugFix 时，npm 版本时就会发布为 <code>release-1.x</code> 这个 tag，用户通过 <code>npm i egg-xx@release-1.x</code> 来引入旧版本。</li><li>参见 <a href="https://docs.npmjs.com/cli/dist-tag">npm 文档</a>。</li></ul></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E8%83%8C%E6%99%AF">背景</a></li><li><a href="#%E5%BF%AB%E9%80%9F%E5%8D%87%E7%BA%A7">快速升级</a></li><li><a href="#%E6%8F%92%E4%BB%B6%E5%8F%98%E6%9B%B4%E8%AF%B4%E6%98%8E">插件变更说明</a><ul><li><a href="#egg-multipart">egg-multipart</a></li><li><a href="#egg-userrole">egg-userrole</a></li></ul></li><li><a href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%8D%87%E7%BA%A7">进一步升级</a><ul><li><a href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%BD%BF%E7%94%A8-koa2-%E9%A3%8E%E6%A0%BC">中间件使用 Koa2 风格</a></li><li><a href="#yieldable-to-awaitable">yieldable to awaitable</a><ul><li><a href="#promise">promise</a></li><li><a href="#array-yield">array - yield []</a></li><li><a href="#object-yield">object - yield {}</a></li><li><a href="#%E5%85%B6%E4%BB%96">其他</a></li></ul></li></ul></li><li><a href="#%E6%8F%92%E4%BB%B6%E5%8D%87%E7%BA%A7">插件升级</a><ul><li><a href="#%E5%8D%87%E7%BA%A7%E4%BA%8B%E9%A1%B9">升级事项</a></li><li><a href="#%E6%8E%A5%E5%8F%A3%E5%85%BC%E5%AE%B9">接口兼容</a></li><li><a href="#%E6%8F%92%E4%BB%B6%E5%8F%91%E5%B8%83%E8%A7%84%E5%88%99">插件发布规则</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E8%83%8C%E6%99%AF%5D(%23%25E8%2583%258C%25E6%2599%25AF)%0A-%20%5B%E5%BF%AB%E9%80%9F%E5%8D%87%E7%BA%A7%5D(%23%25E5%25BF%25AB%25E9%2580%259F%25E5%258D%2587%25E7%25BA%25A7)%0A-%20%5B%E6%8F%92%E4%BB%B6%E5%8F%98%E6%9B%B4%E8%AF%B4%E6%98%8E%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E5%258F%2598%25E6%259B%25B4%25E8%25AF%25B4%25E6%2598%258E)%0A%20%20*%20%5Begg-multipart%5D(%23egg-multipart)%0A%20%20*%20%5Begg-userrole%5D(%23egg-userrole)%0A-%20%5B%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%8D%87%E7%BA%A7%5D(%23%25E8%25BF%259B%25E4%25B8%2580%25E6%25AD%25A5%25E5%258D%2587%25E7%25BA%25A7)%0A%20%20*%20%5B%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%BD%BF%E7%94%A8%20Koa2%20%E9%A3%8E%E6%A0%BC%5D(%23%25E4%25B8%25AD%25E9%2597%25B4%25E4%25BB%25B6%25E4%25BD%25BF%25E7%2594%25A8-koa2-%25E9%25A3%258E%25E6%25A0%25BC)%0A%20%20*%20%5Byieldable%20to%20awaitable%5D(%23yieldable-to-awaitable)%0A%20%20%20%20%2B%20%5Bpromise%5D(%23promise)%0A%20%20%20%20%2B%20%5Barray%20-%20yield%20%5B%5D%5D(%23array-yield)%0A%20%20%20%20%2B%20%5Bobject%20-%20yield%20%7B%7D%5D(%23object-yield)%0A%20%20%20%20%2B%20%5B%E5%85%B6%E4%BB%96%5D(%23%25E5%2585%25B6%25E4%25BB%2596)%0A-%20%5B%E6%8F%92%E4%BB%B6%E5%8D%87%E7%BA%A7%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E5%258D%2587%25E7%25BA%25A7)%0A%20%20*%20%5B%E5%8D%87%E7%BA%A7%E4%BA%8B%E9%A1%B9%5D(%23%25E5%258D%2587%25E7%25BA%25A7%25E4%25BA%258B%25E9%25A1%25B9)%0A%20%20*%20%5B%E6%8E%A5%E5%8F%A3%E5%85%BC%E5%AE%B9%5D(%23%25E6%258E%25A5%25E5%258F%25A3%25E5%2585%25BC%25E5%25AE%25B9)%0A%20%20*%20%5B%E6%8F%92%E4%BB%B6%E5%8F%91%E5%B8%83%E8%A7%84%E5%88%99%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E5%258F%2591%25E5%25B8%2583%25E8%25A7%2584%25E5%2588%2599)","meta":{"info":{"title":"Egg@2 升级指南"}},"content":"%0A%0A%0A%23%23%20%E8%83%8C%E6%99%AF%0A%0A%E9%9A%8F%E7%9D%80%20Node.js%208%20LTS%20%E7%9A%84%E5%8F%91%E5%B8%83%EF%BC%8C%20%E5%86%85%E5%BB%BA%E4%BA%86%E5%AF%B9%20ES2017%20Async%20Function%20%E7%9A%84%E6%94%AF%E6%8C%81%E3%80%82%0A%0A%E5%9C%A8%E8%BF%99%E4%B9%8B%E5%89%8D%EF%BC%8CTJ%20%E7%9A%84%20%5Bco%5D%20%E4%BD%BF%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%8F%90%E5%89%8D%E4%BA%AB%E5%8F%97%E5%88%B0%20%60async%2Fawait%60%20%E7%9A%84%E7%BC%96%E7%A8%8B%E4%BD%93%E9%AA%8C%EF%BC%8C%E4%BD%86%E5%90%8C%E6%97%B6%E5%AE%83%E4%B8%8D%E5%8F%AF%E9%81%BF%E5%85%8D%E7%9A%84%E4%B9%9F%E5%B8%A6%E6%9D%A5%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98%EF%BC%9A%0A%0A-%20%E6%80%A7%E8%83%BD%E6%8D%9F%E5%A4%B1%0A-%20%5B%E9%94%99%E8%AF%AF%E5%A0%86%E6%A0%88%E4%B8%8D%E5%8F%8B%E5%A5%BD%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg%2Fwiki%2Fco-vs-async)%0A%0A%E7%8E%B0%E5%9C%A8%20Egg%20%E6%AD%A3%E5%BC%8F%E5%8F%91%E5%B8%83%E4%BA%86%202.x%20%E7%89%88%E6%9C%AC%EF%BC%9A%0A-%20%E4%BF%9D%E6%8C%81%E4%BA%86%E5%AF%B9%20Egg%201.x%20%E4%BB%A5%E5%8F%8A%20%60generator%20function%60%20%E7%9A%84**%E5%AE%8C%E5%85%A8%E5%85%BC%E5%AE%B9**%E3%80%82%0A-%20%E5%9F%BA%E4%BA%8E%20Koa%202.x%EF%BC%8C%E5%BC%82%E6%AD%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E5%9F%BA%E4%BA%8E%20%60async%20function%60%E3%80%82%0A-%20%E5%8F%AA%E6%94%AF%E6%8C%81%20Node.js%208%20%E5%8F%8A%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E3%80%82%0A-%20%E5%8E%BB%E9%99%A4%20%5Bco%5D%20%E5%90%8E%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF%E6%9B%B4%E6%B8%85%E6%99%B0%EF%BC%8C%E5%B8%A6%E6%9D%A5%2030%25%20%E5%B7%A6%E5%8F%B3%E7%9A%84%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87%EF%BC%88%E4%B8%8D%E5%90%AB%20Node%20%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87%EF%BC%89%EF%BC%8C%E8%AF%A6%E7%BB%86%E5%8F%82%E8%A7%81%EF%BC%9A%5Bbenchmark%5D(https%3A%2F%2Feggjs.github.io%2Fbenchmark%2Fplot%2F)%E3%80%82%0A%0AEgg%20%E7%9A%84%E7%90%86%E5%BF%B5%E4%B9%8B%E4%B8%80%E6%98%AF%60%E6%B8%90%E8%BF%9B%E5%BC%8F%E5%A2%9E%E5%BC%BA%60%EF%BC%8C%E6%95%85%E6%88%91%E4%BB%AC%E4%B8%BA%E5%BC%80%E5%8F%91%E8%80%85%E6%8F%90%E4%BE%9B%60%E6%B8%90%E8%BF%9B%E5%8D%87%E7%BA%A7%60%E7%9A%84%E4%BD%93%E9%AA%8C%E3%80%82%0A%0A-%20%5B%E5%BF%AB%E9%80%9F%E5%8D%87%E7%BA%A7%5D(%23%E5%BF%AB%E9%80%9F%E5%8D%87%E7%BA%A7)%0A-%20%5B%E6%8F%92%E4%BB%B6%E5%8F%98%E6%9B%B4%E8%AF%B4%E6%98%8E%5D(%23%E6%8F%92%E4%BB%B6%E5%8F%98%E6%9B%B4%E8%AF%B4%E6%98%8E)%0A-%20%5B%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%8D%87%E7%BA%A7%5D(%23%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%8D%87%E7%BA%A7)%0A-%20%5B%E9%92%88%E5%AF%B9%60%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E8%80%85%60%E7%9A%84%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97%5D(%23%E6%8F%92%E4%BB%B6%E5%8D%87%E7%BA%A7)%0A%0A%23%23%20%E5%BF%AB%E9%80%9F%E5%8D%87%E7%BA%A7%0A%0A-%20Node.js%20%E4%BD%BF%E7%94%A8%E6%9C%80%E6%96%B0%E7%9A%84%20LTS%20%E7%89%88%E6%9C%AC%EF%BC%88%60%3E%3D8.9.0%60%EF%BC%89%E3%80%82%0A-%20%E4%BF%AE%E6%94%B9%20%60package.json%60%20%E4%B8%AD%20%60egg%60%20%E7%9A%84%E4%BE%9D%E8%B5%96%E4%B8%BA%20%60%5E2.0.0%60%E3%80%82%0A-%20%E6%A3%80%E6%9F%A5%E7%9B%B8%E5%85%B3%E6%8F%92%E4%BB%B6%E6%98%AF%E5%90%A6%E5%8F%91%E5%B8%83%E6%96%B0%E7%89%88%E6%9C%AC%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89%E3%80%82%0A-%20%E9%87%8D%E6%96%B0%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%EF%BC%8C%E8%B7%91%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A**%E6%90%9E%E5%AE%9A%EF%BC%81%E5%87%A0%E4%B9%8E%E4%B8%8D%E9%9C%80%E8%A6%81%E4%BF%AE%E6%94%B9%E4%BB%BB%E4%BD%95%E4%B8%80%E8%A1%8C%E4%BB%A3%E7%A0%81%EF%BC%8C%E5%B0%B1%E5%B7%B2%E7%BB%8F%E5%AE%8C%E6%88%90%E4%BA%86%E5%8D%87%E7%BA%A7%E3%80%82**%0A%0A%0A%23%23%20%E6%8F%92%E4%BB%B6%E5%8F%98%E6%9B%B4%E8%AF%B4%E6%98%8E%0A%0A%23%23%23%20egg-multipart%0A%0A%60yield%20parts%60%20%E9%9C%80%E4%BF%AE%E6%94%B9%E4%B8%BA%20%60await%20parts()%60%20%E6%88%96%20%60yield%20parts()%60%0A%0A%60%60%60js%0A%2F%2F%20old%0Aconst%20parts%20%3D%20ctx.multipart()%3B%0Awhile%20((part%20%3D%20yield%20parts)%20!%3D%20null)%20%7B%0A%20%20%2F%2F%20do%20something%0A%7D%0A%0A%2F%2F%20yield%20parts()%20also%20work%0Awhile%20((part%20%3D%20yield%20parts())%20!%3D%20null)%20%7B%0A%20%20%2F%2F%20do%20something%0A%7D%0A%0A%2F%2F%20new%0Aconst%20parts%20%3D%20ctx.multipart()%3B%0Awhile%20((part%20%3D%20await%20parts())%20!%3D%20null)%20%7B%0A%20%20%2F%2F%20do%20something%0A%7D%0A%60%60%60%0A%0A-%20%5Begg-multipart%23upload-multiple-files%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-multipart%23upload-multiple-files)%0A%0A%23%23%23%20egg-userrole%0A%0A%E4%B8%8D%E5%86%8D%E5%85%BC%E5%AE%B9%201.x%20%E5%BD%A2%E5%BC%8F%E7%9A%84%20role%20%E5%AE%9A%E4%B9%89%EF%BC%8C%E5%9B%A0%E4%B8%BA%20koa-roles%20%E5%B7%B2%E7%BB%8F%E6%97%A0%E6%B3%95%E5%85%BC%E5%AE%B9%E4%BA%86%E3%80%82%0A%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87%20%60Context%60%20%E4%BB%8E%20this%20%E4%BC%A0%E5%85%A5%E6%94%B9%E6%88%90%E4%BA%86%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%20%60ctx%60%20%E4%BC%A0%E5%85%A5%EF%BC%8C%E5%8E%9F%E6%9C%89%E7%9A%84%20%60scope%60%20%E5%8F%98%E6%88%90%E4%BA%86%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20old%0Aapp.role.use('user'%2C%20function()%20%7B%0A%20%20return%20!!this.user%3B%0A%7D)%3B%0A%0A%2F%2F%20new%0Aapp.role.use((ctx%2C%20scope)%20%3D%3E%20%7B%0A%20%20return%20!!ctx.user%0A%7D)%3B%0A%0Aapp.role.use('user'%2C%20ctx%20%3D%3E%20%7B%0A%20%20return%20!!ctx.user%3B%0A%7D)%3B%0A%60%60%60%0A%0A-%20%5Bkoajs%2Fkoa-roles%2313%5D(https%3A%2F%2Fgithub.com%2Fkoajs%2Fkoa-roles%2Fpull%2F13)%0A-%20%5Beggjs%2Fegg-userrole%239%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-userrole%2Fpull%2F9)%0A%0A%23%23%20%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%8D%87%E7%BA%A7%0A%0A%E5%BE%97%E7%9B%8A%E4%BA%8E%20Egg%20%E5%AF%B9%201.x%20%E7%9A%84**%E5%AE%8C%E5%85%A8%E5%85%BC%E5%AE%B9**%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%A6%82%E4%BD%95%E9%9D%9E%E5%B8%B8%E5%BF%AB%E9%80%9F%E7%9A%84%E5%AE%8C%E6%88%90%E5%8D%87%E7%BA%A7%E3%80%82%0A%0A%E4%B8%8D%E8%BF%87%EF%BC%8C%E4%B8%BA%E4%BA%86%E6%9B%B4%E5%A5%BD%E7%9A%84%E7%BB%9F%E4%B8%80%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%9B%B4%E4%BD%B3%E7%9A%84%E6%80%A7%E8%83%BD%E5%92%8C%E9%94%99%E8%AF%AF%E5%A0%86%E6%A0%88%EF%BC%8C%E6%88%91%E4%BB%AC%E5%BB%BA%E8%AE%AE%E5%BC%80%E5%8F%91%E8%80%85%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%8D%87%E7%BA%A7%EF%BC%9A%0A%0A-%20%E4%BF%AE%E6%94%B9%E4%B8%BA%E6%8E%A8%E8%8D%90%E7%9A%84%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%EF%BC%8C%E4%BC%A0%E9%80%81%E9%97%A8%EF%BC%9A%5B%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E6%8C%87%E5%8D%97%5D(.%2Fstyle-guide.md)%0A-%20%5B%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%BD%BF%E7%94%A8%20Koa2%20%E9%A3%8E%E6%A0%BC%5D(%23%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%BD%BF%E7%94%A8-Koa2-%E9%A3%8E%E6%A0%BC)%0A-%20%5B%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E7%9A%84%20%60yieldable%60%20%E8%BD%AC%E4%B8%BA%20%60awaitable%60%5D(%23yieldable-To-awaitable)%0A%0A%23%23%23%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%BD%BF%E7%94%A8%20Koa2%20%E9%A3%8E%E6%A0%BC%0A%0A%3E%202.x%20%E4%BB%8D%E7%84%B6%E4%BF%9D%E6%8C%81%E5%AF%B9%201.x%20%E9%A3%8E%E6%A0%BC%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%85%BC%E5%AE%B9%EF%BC%8C%E6%95%85%E4%B8%8D%E4%BF%AE%E6%94%B9%E4%B9%9F%E8%83%BD%E7%BB%A7%E7%BB%AD%E4%BD%BF%E7%94%A8%E3%80%82%0A%0A-%20%E8%BF%94%E5%9B%9E%E7%9A%84%E5%87%BD%E6%95%B0%E5%85%A5%E5%8F%82%E6%94%B9%E4%B8%BA%20Koa%202%20%E7%9A%84%20%60(ctx%2C%20next)%60%20%E9%A3%8E%E6%A0%BC%E3%80%82%0A%20%20-%20%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E4%B8%BA%20%60ctx%60%EF%BC%8C%E4%BB%A3%E8%A1%A8%E5%BD%93%E5%89%8D%E8%AF%B7%E6%B1%82%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%8C%E6%98%AF%20%5BContext%5D(.%2Fbasics%2Fextend.md%23Context)%20%E7%9A%84%E5%AE%9E%E4%BE%8B%E3%80%82%0A%20%20-%20%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E4%B8%BA%20%60next%60%EF%BC%8C%E7%94%A8%20await%20%E6%89%A7%E8%A1%8C%E5%AE%83%E6%9D%A5%E6%89%A7%E8%A1%8C%E5%90%8E%E7%BB%AD%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E9%80%BB%E8%BE%91%E3%80%82%0A-%20%E4%B8%8D%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8%20%60async%20(ctx%2C%20next)%20%3D%3E%20%7B%7D%60%20%E6%A0%BC%E5%BC%8F%EF%BC%8C%E9%81%BF%E5%85%8D%E9%94%99%E8%AF%AF%E5%A0%86%E6%A0%88%E4%B8%A2%E5%A4%B1%E5%87%BD%E6%95%B0%E5%90%8D%E3%80%82%0A-%20%60yield%20next%60%20%E6%94%B9%E4%B8%BA%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%20%60await%20next()%60%20%E7%9A%84%E6%96%B9%E5%BC%8F%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%201.x%0Amodule.exports%20%3D%20()%20%3D%3E%20%7B%0A%20%20return%20function*%20responseTime(next)%20%7B%0A%20%20%20%20const%20start%20%3D%20Date.now()%3B%0A%20%20%20%20yield%20next%3B%0A%20%20%20%20const%20delta%20%3D%20Math.ceil(Date.now()%20-%20start)%3B%0A%20%20%20%20this.set('X-Response-Time'%2C%20delta%20%2B%20'ms')%3B%0A%20%20%7D%3B%0A%7D%3B%0A%0A%2F%2F%202.x%0Amodule.exports%20%3D%20()%20%3D%3E%20%7B%0A%20%20return%20async%20function%20responseTime(ctx%2C%20next)%20%7B%0A%20%20%20%20const%20start%20%3D%20Date.now()%3B%0A%20%20%20%20%2F%2F%20%E6%B3%A8%E6%84%8F%EF%BC%8C%E5%92%8C%20generator%20function%20%E6%A0%BC%E5%BC%8F%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B8%8D%E5%90%8C%EF%BC%8C%E6%AD%A4%E6%97%B6%20next%20%E6%98%AF%E4%B8%80%E4%B8%AA%E6%96%B9%E6%B3%95%EF%BC%8C%E5%BF%85%E9%A1%BB%E8%A6%81%E8%B0%83%E7%94%A8%E5%AE%83%0A%20%20%20%20await%20next()%3B%0A%20%20%20%20const%20delta%20%3D%20Math.ceil(Date.now()%20-%20start)%3B%0A%20%20%20%20ctx.set('X-Response-Time'%2C%20delta%20%2B%20'ms')%3B%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20yieldable%20to%20awaitable%0A%0A%3E%20%E6%88%91%E4%BB%AC%E6%97%A9%E5%9C%A8%20Egg%201.x%20%E6%97%B6%E5%B0%B1%E5%B7%B2%E7%BB%8F%E6%94%AF%E6%8C%81%20async%EF%BC%8C%E6%95%85%E8%8B%A5%E5%BA%94%E7%94%A8%E5%B1%82%E5%B7%B2%E7%BB%8F%E6%98%AF%20async-base%20%E7%9A%84%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%B7%B3%E8%BF%87%E6%9C%AC%E5%B0%8F%E8%8A%82%E5%86%85%E5%AE%B9%E4%BA%86%E3%80%82%0A%0A%5Bco%5D%20%E6%94%AF%E6%8C%81%E4%BA%86%20%60yieldable%60%20%E5%85%BC%E5%AE%B9%E7%B1%BB%E5%9E%8B%EF%BC%9A%0A%0A-%20promises%0A-%20array%20(parallel%20execution)%0A-%20objects%20(parallel%20execution)%0A-%20thunks%20(functions)%0A-%20generators%20(delegation)%0A-%20generator%20functions%20(delegation)%0A%0A%E5%B0%BD%E7%AE%A1%20%60generator%60%20%E5%92%8C%20%60async%60%20%E4%B8%A4%E8%80%85%E7%9A%84%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%9F%BA%E6%9C%AC%E4%B8%80%E6%A8%A1%E4%B8%80%E6%A0%B7%EF%BC%8C%E4%BD%86%E7%94%B1%E4%BA%8E%E4%B8%8A%E8%BF%B0%E7%9A%84%20%60co%60%20%E7%9A%84%E4%B8%80%E4%BA%9B%E7%89%B9%E6%AE%8A%E5%A4%84%E7%90%86%EF%BC%8C%E5%AF%BC%E8%87%B4%E5%9C%A8%E7%A7%BB%E9%99%A4%20%60co%60%20%E5%90%8E%EF%BC%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E6%A0%B9%E6%8D%AE%E4%B8%8D%E5%90%8C%E5%9C%BA%E6%99%AF%E8%87%AA%E8%A1%8C%E5%A4%84%E7%90%86%EF%BC%9A%0A%0A%23%23%23%23%20promise%0A%0A%E7%9B%B4%E6%8E%A5%E6%9B%BF%E6%8D%A2%E5%8D%B3%E5%8F%AF%EF%BC%9A%0A%0A%60%60%60js%0Afunction%20echo(msg)%20%7B%0A%20%20return%20Promise.resolve(msg)%3B%0A%7D%0A%0Ayield%20echo('hi%20egg')%3B%0A%2F%2F%20change%20to%0Aawait%20echo('hi%20egg')%3B%0A%60%60%60%0A%0A%23%23%23%23%20array%20-%20yield%20%5B%5D%0A%0A%60yield%20%5B%5D%60%20%E5%B8%B8%E7%94%A8%E4%BA%8E%E5%B9%B6%E5%8F%91%E8%AF%B7%E6%B1%82%EF%BC%8C%E5%A6%82%EF%BC%9A%0A%0A%60%60%60js%0Aconst%20%5B%20news%2C%20user%20%5D%20%3D%20yield%20%5B%0A%20%20ctx.service.news.list(topic)%2C%0A%20%20ctx.service.user.get(uid)%2C%0A%5D%3B%0A%60%60%60%0A%0A%E8%BF%99%E7%A7%8D%E4%BF%AE%E6%94%B9%E8%B5%B7%E6%9D%A5%E6%AF%94%E8%BE%83%E7%AE%80%E5%8D%95%EF%BC%8C%E7%94%A8%20%60Promise.all()%60%20%E5%8C%85%E8%A3%85%E4%B8%8B%E5%8D%B3%E5%8F%AF%EF%BC%9A%0A%0A%60%60%60js%0Aconst%20%5B%20news%2C%20user%20%5D%20%3D%20await%20Promise.all(%5B%0A%20%20ctx.service.news.list(topic)%2C%0A%20%20ctx.service.user.get(uid)%2C%0A%5D)%3B%0A%60%60%60%0A%0A%23%23%23%23%20object%20-%20yield%20%7B%7D%0A%0A%60yield%20%7B%7D%60%20%E5%92%8C%20%60yield%20map%60%20%E7%9A%84%E6%96%B9%E5%BC%8F%E4%B9%9F%E5%B8%B8%E7%94%A8%E4%BA%8E%E5%B9%B6%E5%8F%91%E8%AF%B7%E6%B1%82%EF%BC%8C%E4%BD%86%E7%94%B1%E4%BA%8E%20%60Promise.all%60%20%E4%B8%8D%E6%94%AF%E6%8C%81%20Object%EF%BC%8C%E4%BC%9A%E7%A8%8D%E5%BE%AE%E6%9C%89%E7%82%B9%E5%A4%8D%E6%9D%82%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fservice%2Fbiz.js%0Aclass%20BizService%20extends%20Service%20%7B%0A%20%20*%20list(topic%2C%20uid)%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20news%3A%20ctx.service.news.list(topic)%2C%0A%20%20%20%20%20%20user%3A%20ctx.service.user.get(uid)%2C%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20app%2Fcontroller%2Fhome.js%0Aconst%20%7B%20news%2C%20user%20%7D%20%3D%20yield%20ctx.service.biz.list(topic%2C%20uid)%3B%0A%60%60%60%0A%0A%E5%BB%BA%E8%AE%AE%E4%BF%AE%E6%94%B9%E4%B8%BA%20%60await%20Promise.all(%5B%5D)%60%20%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fservice%2Fbiz.js%0Aclass%20BizService%20extends%20Service%20%7B%0A%20%20list(topic%2C%20uid)%20%7B%0A%20%20%20%20return%20Promise.all(%5B%0A%20%20%20%20%20%20ctx.service.news.list(topic)%2C%0A%20%20%20%20%20%20ctx.service.user.get(uid)%2C%0A%20%20%20%20%5D)%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20app%2Fcontroller%2Fhome.js%0Aconst%20%5B%20news%2C%20user%20%5D%20%3D%20await%20ctx.service.biz.list(topic%2C%20uid)%3B%0A%60%60%60%0A%0A%E5%A6%82%E6%9E%9C%E6%97%A0%E6%B3%95%E4%BF%AE%E6%94%B9%E5%AF%B9%E5%BA%94%E7%9A%84%E6%8E%A5%E5%8F%A3%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%B8%B4%E6%97%B6%E5%85%BC%E5%AE%B9%E4%B8%8B%EF%BC%9A%0A%0A-%20%E4%BD%BF%E7%94%A8%E6%88%91%E4%BB%AC%E6%8F%90%E4%BE%9B%E7%9A%84%20Utils%20%E6%96%B9%E6%B3%95%20%5Bapp.toPromise%5D%E3%80%82%0A-%20**%E5%BB%BA%E8%AE%AE%E5%B0%BD%E9%87%8F%E6%94%B9%E6%8E%89%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AE%9E%E9%99%85%E4%B8%8A%E5%B0%B1%E6%98%AF%E4%B8%A2%E7%BB%99%20co%EF%BC%8C%E4%BC%9A%E5%B8%A6%E5%9B%9E%E5%AF%B9%E5%BA%94%E7%9A%84%E6%80%A7%E8%83%BD%E6%8D%9F%E5%A4%B1%E5%92%8C%E5%A0%86%E6%A0%88%E9%97%AE%E9%A2%98%E3%80%82**%0A%0A%60%60%60js%0Aconst%20%7B%20news%2C%20user%20%7D%20%3D%20await%20app.toPromise(ctx.service.biz.list(topic%2C%20uid))%3B%0A%60%60%60%0A%0A%23%23%23%23%20%E5%85%B6%E4%BB%96%0A%0A-%20thunks%20(functions)%0A-%20generators%20(delegation)%0A-%20generator%20functions%20(delegation)%0A%0A%E4%BF%AE%E6%94%B9%E4%B8%BA%E5%AF%B9%E5%BA%94%E7%9A%84%20async%20function%20%E5%8D%B3%E5%8F%AF%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%8D%E8%83%BD%E4%BF%AE%E6%94%B9%EF%BC%8C%E5%88%99%E5%8F%AF%E4%BB%A5%E7%94%A8%20%5Bapp.toAsyncFunction%5D%20%E7%AE%80%E5%8D%95%E5%8C%85%E8%A3%85%E4%B8%8B%E3%80%82%0A%0A**%E6%B3%A8%E6%84%8F**%0A-%20%5BtoAsyncFunction%5D%5Bapp.toAsyncFunction%5D%20%E5%92%8C%20%5BtoPromise%5D%5Bapp.toPromise%5D%20%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AF%20%5Bco%5D%20%E5%8C%85%E8%A3%85%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%BC%9A%E5%B8%A6%E5%9B%9E%E5%AF%B9%E5%BA%94%E7%9A%84%E6%80%A7%E8%83%BD%E6%8D%9F%E5%A4%B1%E5%92%8C%E5%A0%86%E6%A0%88%E9%97%AE%E9%A2%98%EF%BC%8C%E5%BB%BA%E8%AE%AE%E5%BC%80%E5%8F%91%E8%80%85%E8%BF%98%E6%98%AF%E5%B0%BD%E9%87%8F%E5%85%A8%E9%93%BE%E8%B7%AF%E5%8D%87%E7%BA%A7%E3%80%82%0A-%20%5BtoAsyncFunction%5D%5Bapp.toAsyncFunction%5D%20%E5%9C%A8%E8%B0%83%E7%94%A8%20async%20function%20%E6%97%B6%E4%B8%8D%E4%BC%9A%E6%9C%89%E6%8D%9F%E5%A4%B1%E3%80%82%0A%0A%40sindresorhus%20%E7%BC%96%E5%86%99%E4%BA%86%E8%AE%B8%E5%A4%9A%5B%E5%9F%BA%E4%BA%8E%20promise%20%E7%9A%84%20helper%20%E6%96%B9%E6%B3%95%5D(https%3A%2F%2Fgithub.com%2Fsindresorhus%2Fpromise-fun)%EF%BC%8C%E7%81%B5%E6%B4%BB%E7%9A%84%E8%BF%90%E7%94%A8%E5%AE%83%E4%BB%AC%E9%85%8D%E5%90%88%20async%20function%20%E8%83%BD%E8%AE%A9%E4%BB%A3%E7%A0%81%E6%9B%B4%E5%8A%A0%E5%85%B7%E6%9C%89%E5%8F%AF%E8%AF%BB%E6%80%A7%E3%80%82%0A%0A%23%23%20%E6%8F%92%E4%BB%B6%E5%8D%87%E7%BA%A7%0A%0A%60%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E8%80%85%60%E5%8F%AA%E9%9C%80%E5%8D%87%E7%BA%A7%60%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E8%80%85%60%E4%BF%AE%E6%94%B9%E5%90%8E%E7%9A%84%E4%BE%9D%E8%B5%96%E7%89%88%E6%9C%AC%E5%8D%B3%E5%8F%AF%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%94%A8%E6%88%91%E4%BB%AC%E6%8F%90%E4%BE%9B%E7%9A%84%E5%91%BD%E4%BB%A4%20%60egg-bin%20autod%60%20%E5%BF%AB%E9%80%9F%E6%9B%B4%E6%96%B0%E3%80%82%0A%0A%E4%BB%A5%E4%B8%8B%E5%86%85%E5%AE%B9%E9%92%88%E5%AF%B9%60%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E8%80%85%60%EF%BC%8C%E6%8C%87%E5%AF%BC%E5%A6%82%E4%BD%95%E5%8D%87%E7%BA%A7%E6%8F%92%E4%BB%B6%EF%BC%9A%0A%0A%23%23%23%20%E5%8D%87%E7%BA%A7%E4%BA%8B%E9%A1%B9%0A%0A-%20%E5%AE%8C%E6%88%90%E4%B8%8A%E9%9D%A2%E7%AB%A0%E8%8A%82%E6%8F%90%E5%88%B0%E7%9A%84%E5%8D%87%E7%BA%A7%E9%A1%B9%E3%80%82%0A%20%20-%20%E6%89%80%E6%9C%89%E7%9A%84%20%60generator%20function%60%20%E6%94%B9%E4%B8%BA%20%60async%20function%60%20%E6%A0%BC%E5%BC%8F%E3%80%82%0A%20%20-%20%E5%8D%87%E7%BA%A7%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%A3%8E%E6%A0%BC%E3%80%82%0A-%20%E6%8E%A5%E5%8F%A3%E5%85%BC%E5%AE%B9%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89%EF%BC%8C%E5%A6%82%E4%B8%8B%E3%80%82%0A-%20%E5%8F%91%E5%B8%83%E5%A4%A7%E7%89%88%E6%9C%AC%E3%80%82%0A%0A%23%23%23%20%E6%8E%A5%E5%8F%A3%E5%85%BC%E5%AE%B9%0A%0A%E6%9F%90%E4%BA%9B%E5%9C%BA%E6%99%AF%E4%B8%8B%EF%BC%8C%60%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E8%80%85%60%E6%8F%90%E4%BE%9B%E7%BB%99%60%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E8%80%85%60%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%98%AF%E5%90%8C%E6%97%B6%E6%94%AF%E6%8C%81%20generator%20%E5%92%8C%20async%20%E7%9A%84%EF%BC%8C%E4%B8%80%E8%88%AC%E6%98%AF%E4%BC%9A%E7%94%A8%20co%20%E5%8C%85%E8%A3%85%E4%B8%80%E5%B1%82%E3%80%82%0A%0A-%20%E5%9C%A8%202.x%20%E9%87%8C%E4%B8%BA%E4%BA%86%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%80%A7%E8%83%BD%E5%92%8C%E9%94%99%E8%AF%AF%E5%A0%86%E6%A0%88%EF%BC%8C%E6%88%91%E4%BB%AC%E5%BB%BA%E8%AE%AE%E4%BF%AE%E6%94%B9%E4%B8%BA%20%60async-first%60%E3%80%82%0A-%20%E5%A6%82%E6%9C%89%E9%9C%80%E8%A6%81%EF%BC%8C%E4%BD%BF%E7%94%A8%20%5BtoAsyncFunction%5D%5Bapp.toAsyncFunction%5D%20%E5%92%8C%20%5BtoPromise%5D%5Bapp.toPromise%5D%20%E6%9D%A5%E5%85%BC%E5%AE%B9%E3%80%82%0A%0A%E8%AD%AC%E5%A6%82%20%5Begg-schedule%5D%20%E6%8F%92%E4%BB%B6%EF%BC%8C%E6%94%AF%E6%8C%81%E5%BA%94%E7%94%A8%E5%B1%82%E4%BD%BF%E7%94%A8%20generator%20%E6%88%96%20async%20%E5%AE%9A%E4%B9%89%20task%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%2Fapp%2Fschedule%2Fcleandb.js%0Aexports.task%20%3D%20function*%20(ctx)%20%7B%0A%20%20yield%20ctx.service.db.clean()%3B%0A%7D%3B%0A%0A%2F%2F%20%7Bapp_root%7D%2Fapp%2Fschedule%2Flog.js%0Aexports.task%20%3D%20async%20function%20splitLog(ctx)%20%7B%0A%20%20await%20ctx.service.log.split()%3B%0A%7D%3B%0A%60%60%60%0A%0A%60%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E8%80%85%60%E5%8F%AF%E4%BB%A5%E7%AE%80%E5%8D%95%E5%8C%85%E8%A3%85%E4%B8%8B%E5%8E%9F%E5%A7%8B%E5%87%BD%E6%95%B0%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-schedule%2Fblob%2F80252ef%2Flib%2Fload_schedule.js%23L38%0Atask%20%3D%20app.toAsyncFunction(schedule.task)%3B%0A%60%60%60%0A%0A%23%23%23%20%E6%8F%92%E4%BB%B6%E5%8F%91%E5%B8%83%E8%A7%84%E5%88%99%0A%0A-%20**%E9%9C%80%E8%A6%81%E5%8F%91%E5%B8%83%E5%A4%A7%E7%89%88%E6%9C%AC**%0A%20%20-%20%E9%99%A4%E9%9D%9E%E6%8F%92%E4%BB%B6%E6%8F%90%E4%BE%9B%E7%9A%84%E6%8E%A5%E5%8F%A3%E9%83%BD%E6%98%AF%20promise%20%E7%9A%84%EF%BC%8C%E4%B8%94%E4%BB%A3%E7%A0%81%E9%87%8C%E9%9D%A2%E4%B8%8D%E5%AD%98%E5%9C%A8%20%60async%60%EF%BC%8C%E5%A6%82%20%5Begg-view-nunjucks%5D%E3%80%82%0A-%20%E4%BF%AE%E6%94%B9%20%60package.json%60%0A%20%20-%20%E4%BF%AE%E6%94%B9%20%60devDependencies%60%20%E4%BE%9D%E8%B5%96%E7%9A%84%20%60egg%60%20%E4%B8%BA%20%60%5E2.0.0%60%E3%80%82%0A%20%20-%20%E4%BF%AE%E6%94%B9%20%60engines.node%60%20%E4%B8%BA%20%60%3E%3D8.0.0%60%E3%80%82%0A%20%20-%20%E4%BF%AE%E6%94%B9%20%60ci.version%60%20%E4%B8%BA%20%608%2C%209%60%EF%BC%8C%20%E5%B9%B6%E9%87%8D%E6%96%B0%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E4%BB%A5%E4%BE%BF%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84%20travis%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E3%80%82%0A-%20%E4%BF%AE%E6%94%B9%20%60README.md%60%20%E7%9A%84%E7%A4%BA%E4%BE%8B%E4%B8%BA%20async%20function%E3%80%82%0A-%20%E7%BC%96%E5%86%99%E5%8D%87%E7%BA%A7%E6%8C%87%E5%BC%95%E3%80%82%0A-%20%E4%BF%AE%E6%94%B9%20%60test%2Ffixtures%60%20%E4%B8%BA%20async%20function%EF%BC%8C%E5%8F%AF%E9%80%89%EF%BC%8C%E5%BB%BA%E8%AE%AE%E5%88%86%E5%BC%80%E5%8F%A6%E4%B8%80%E4%B8%AA%20PR%20%E6%96%B9%E4%BE%BF%20Review%E3%80%82%0A%0A%0A%E4%B8%80%E8%88%AC%E8%BF%98%E4%BC%9A%E9%9C%80%E8%A6%81%E7%BB%A7%E7%BB%AD%E7%BB%B4%E6%8A%A4%E4%B8%8A%E4%B8%80%E4%B8%AA%E7%89%88%E6%9C%AC%EF%BC%8C%E6%95%85%E9%9C%80%E8%A6%81%EF%BC%9A%0A%20%20-%20%E5%AF%B9%E4%B8%8A%E4%B8%80%E4%B8%AA%E7%89%88%E6%9C%AC%E5%BB%BA%E7%AB%8B%E4%B8%80%E4%B8%AA%20%601.x%60%20%E8%BF%99%E7%B1%BB%E7%9A%84%20branch%20%E5%88%86%E6%94%AF%0A%20%20-%20%E4%BF%AE%E6%94%B9%E4%B8%8A%E4%B8%80%E4%B8%AA%E7%89%88%E6%9C%AC%E7%9A%84%20%60package.json%60%20%E7%9A%84%20%60publishConfig.tag%60%20%E4%B8%BA%20%60release-1.x%60%0A%20%20-%20%E8%BF%99%E6%A0%B7%E5%A6%82%E6%9E%9C%E4%B8%8A%E4%B8%80%E4%B8%AA%E7%89%88%E6%9C%AC%E6%9C%89%20BugFix%20%E6%97%B6%EF%BC%8Cnpm%20%E7%89%88%E6%9C%AC%E6%97%B6%E5%B0%B1%E4%BC%9A%E5%8F%91%E5%B8%83%E4%B8%BA%20%60release-1.x%60%20%E8%BF%99%E4%B8%AA%20tag%EF%BC%8C%E7%94%A8%E6%88%B7%E9%80%9A%E8%BF%87%20%60npm%20i%20egg-xx%40release-1.x%60%20%E6%9D%A5%E5%BC%95%E5%85%A5%E6%97%A7%E7%89%88%E6%9C%AC%E3%80%82%0A%20%20-%20%E5%8F%82%E8%A7%81%20%5Bnpm%20%E6%96%87%E6%A1%A3%5D(https%3A%2F%2Fdocs.npmjs.com%2Fcli%2Fdist-tag)%E3%80%82%0A%0A%0A%5Bco%5D%3A%20https%3A%2F%2Fgithub.com%2Ftj%2Fco%0A%5Begg-schedule%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-schedule%0A%5Begg-view%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-view%0A%5Begg-view-nunjucks%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-view-nunjucks%0A%5Bapp.toAsyncFunction%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-core%2Fblob%2Fda4ba1784175c43217125f3d5cd7f0be3d5396bf%2Flib%2Fegg.js%23L344%0A%5Bapp.toPromise%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-core%2Fblob%2Fda4ba1784175c43217125f3d5cd7f0be3d5396bf%2Flib%2Fegg.js%23L353"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>