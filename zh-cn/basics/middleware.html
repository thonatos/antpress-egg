<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Middleware 中间件</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>在<a href="../intro/egg-and-koa.md">前面的章节</a>中，我们介绍了 Egg 是基于 Koa 实现的，所以 Egg 的中间件形式和 Koa 的中间件形式是一样的，都是基于<a href="../intro/egg-and-koa.md#midlleware">洋葱圈模型</a>。每次我们编写一个中间件，就相当于在洋葱外面包了一层。</p><h2 id="编写中间件">编写中间件</h2><h3 id="写法">写法</h3><p>我们先来通过编写一个简单的 gzip 中间件，来看看中间件的写法。</p><pre><code class="language-js">// app/middleware/gzip.js
const isJSON = require(&#x27;koa-is-json&#x27;);
const zlib = require(&#x27;zlib&#x27;);

async function gzip(ctx, next) {
  await next();

  // 后续中间件执行完成后将响应体转换成 gzip
  let body = ctx.body;
  if (!body) return;
  if (isJSON(body)) body = JSON.stringify(body);

  // 设置 gzip body，修正响应头
  const stream = zlib.createGzip();
  stream.end(body);
  ctx.body = stream;
  ctx.set(&#x27;Content-Encoding&#x27;, &#x27;gzip&#x27;);
}</code></pre><p>可以看到，框架的中间件和 Koa 的中间件写法是一模一样的，所以任何 Koa 的中间件都可以直接被框架使用。</p><h3 id="配置">配置</h3><p>一般来说中间件也会有自己的配置。在框架中，一个完整的中间件是包含了配置处理的。我们约定一个中间件是一个放置在 <code>app/middleware</code> 目录下的单独文件，它需要 exports 一个普通的 function，接受两个参数：</p><ul><li>options: 中间件的配置项，框架会将 <code>app.config[${middlewareName}]</code> 传递进来。</li><li>app: 当前应用 Application 的实例。</li></ul><p>我们将上面的 gzip 中间件做一个简单的优化，让它支持指定只有当 body 大于配置的 threshold 时才进行 gzip 压缩，我们要在 <code>app/middleware</code> 目录下新建一个文件 <code>gzip.js</code></p><pre><code class="language-js">// app/middleware/gzip.js
const isJSON = require(&#x27;koa-is-json&#x27;);
const zlib = require(&#x27;zlib&#x27;);

module.exports = options =&gt; {
  return async function gzip(ctx, next) {
    await next();

    // 后续中间件执行完成后将响应体转换成 gzip
    let body = ctx.body;
    if (!body) return;

    // 支持 options.threshold
    if (options.threshold &amp;&amp; ctx.length &lt; options.threshold) return;

    if (isJSON(body)) body = JSON.stringify(body);

    // 设置 gzip body，修正响应头
    const stream = zlib.createGzip();
    stream.end(body);
    ctx.body = stream;
    ctx.set(&#x27;Content-Encoding&#x27;, &#x27;gzip&#x27;);
  };
};</code></pre><h2 id="使用中间件">使用中间件</h2><p>中间件编写完成后，我们还需要手动挂载，支持以下方式：</p><h3 id="在应用中使用中间件">在应用中使用中间件</h3><p>在应用中，我们可以完全通过配置来加载自定义的中间件，并决定它们的顺序。</p><p>如果我们需要加载上面的 gzip 中间件，在 <code>config.default.js</code> 中加入下面的配置就完成了中间件的开启和配置：</p><pre><code class="language-js">module.exports = {
  // 配置需要的中间件，数组顺序即为中间件的加载顺序
  middleware: [ &#x27;gzip&#x27; ],

  // 配置 gzip 中间件的配置
  gzip: {
    threshold: 1024, // 小于 1k 的响应体不压缩
  },
};</code></pre><p>该配置最终将在启动时合并到 <code>app.config.appMiddleware</code>。</p><h3 id="在框架和插件中使用中间件">在框架和插件中使用中间件</h3><p>框架和插件不支持在 <code>config.default.js</code> 中匹配 <code>middleware</code>，需要通过以下方式：</p><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  // 在中间件最前面统计请求时间
  app.config.coreMiddleware.unshift(&#x27;report&#x27;);
};

// app/middleware/report.js
module.exports = () =&gt; {
  return async function (ctx, next) {
    const startTime = Date.now();
    await next();
    // 上报请求时间
    reportTime(Date.now() - startTime);
  }
};</code></pre><p>应用层定义的中间件（<code>app.config.appMiddleware</code>）和框架默认中间件（<code>app.config.coreMiddleware</code>）都会被加载器加载，并挂载到 <code>app.middleware</code> 上。</p><h3 id="router-中使用中间件">router 中使用中间件</h3><p>以上两种方式配置的中间件是全局的，会处理每一次请求。
如果你只想针对单个路由生效，可以直接在 <code>app/router.js</code> 中实例化和挂载，如下：</p><pre><code class="language-js">module.exports = app =&gt; {
  const gzip = app.middleware.gzip({ threshold: 1024 });
  app.router.get(&#x27;/needgzip&#x27;, gzip, app.controller.handler);
};</code></pre><h2 id="框架默认中间件">框架默认中间件</h2><p>除了应用层加载中间件之外，框架自身和其他的插件也会加载许多中间件。所有的这些自带中间件的配置项都通过在配置中修改中间件同名配置项进行修改，例如<a href="https://github.com/eggjs/egg/tree/master/app/middleware">框架自带的中间件</a>中有一个 bodyParser 中间件（框架的加载器会将文件名中的各种分隔符都修改成驼峰形式的变量名），我们想要修改 bodyParser 的配置，只需要在 <code>config/config.default.js</code> 中编写</p><pre><code class="language-js">module.exports = {
  bodyParser: {
    jsonLimit: &#x27;10mb&#x27;,
  },
};</code></pre><p><strong>注意：框架和插件加载的中间件会在应用层配置的中间件之前，框架默认中间件不能被应用层中间件覆盖，如果应用层有自定义同名中间件，在启动时会报错。</strong></p><h2 id="使用-koa-的中间件">使用 Koa 的中间件</h2><p>在框架里面可以非常容易的引入 Koa 中间件生态。</p><p>以 <a href="https://github.com/koajs/compress">koa-compress</a> 为例，在 Koa 中使用时：</p><pre><code class="language-js">const koa = require(&#x27;koa&#x27;);
const compress = require(&#x27;koa-compress&#x27;);

const app = koa();

const options = { threshold: 2048 };
app.use(compress(options));</code></pre><p>我们按照框架的规范来在应用中加载这个 Koa 的中间件：</p><pre><code class="language-js">// app/middleware/compress.js
// koa-compress 暴露的接口(`(options) =&gt; middleware`)和框架对中间件要求一致
module.exports = require(&#x27;koa-compress&#x27;);</code></pre><pre><code class="language-js">// config/config.default.js
module.exports = {
  middleware: [ &#x27;compress&#x27; ],
  compress: {
    threshold: 2048,
  },
};</code></pre><p>如果使用到的 Koa 中间件不符合入参规范，则可以自行处理下：</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  webpack: {
    compiler: {},
    others: {},
  },
};

// app/middleware/webpack.js
const webpackMiddleware = require(&#x27;some-koa-middleware&#x27;);

module.exports = (options, app) =&gt; {
  return webpackMiddleware(options.compiler, options.others);
}</code></pre><h2 id="通用配置">通用配置</h2><p>无论是应用层加载的中间件还是框架自带中间件，都支持几个通用的配置项：</p><ul><li>enable：控制中间件是否开启。</li><li>match：设置只有符合某些规则的请求才会经过这个中间件。</li><li>ignore：设置符合某些规则的请求不经过这个中间件。</li></ul><h3 id="enable">enable</h3><p>如果我们的应用并不需要默认的 bodyParser 中间件来进行请求体的解析，此时我们可以通过配置 enable 为 false 来关闭它</p><pre><code class="language-js">module.exports = {
  bodyParser: {
    enable: false,
  },
};</code></pre><h3 id="match-和-ignore">match 和 ignore</h3><p>match 和 ignore 支持的参数都一样，只是作用完全相反，match 和 ignore 不允许同时配置。</p><p>如果我们想让 gzip 只针对 <code>/static</code> 前缀开头的 url 请求开启，我们可以配置 match 选项</p><pre><code class="language-js">module.exports = {
  gzip: {
    match: &#x27;/static&#x27;,
  },
};</code></pre><p>match 和 ignore 支持多种类型的配置方式</p><ol><li>字符串：当参数为字符串类型时，配置的是一个 url 的路径前缀，所有以配置的字符串作为前缀的 url 都会匹配上。</li><li>正则：当参数为正则时，直接匹配满足正则验证的 url 的路径。</li><li>函数：当参数为一个函数时，会将请求上下文传递给这个函数，最终取函数返回的结果（ture/false）来判断是否匹配。</li></ol><pre><code class="language-js">module.exports = {
  gzip: {
    match(ctx) {
      // 只有 ios 设备才开启
      const reg = /iphone|ipad|ipod/i;
      return reg.test(ctx.get(&#x27;user-agent&#x27;));
    },
  },
};</code></pre></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E7%BC%96%E5%86%99%E4%B8%AD%E9%97%B4%E4%BB%B6">编写中间件</a><ul><li><a href="#%E5%86%99%E6%B3%95">写法</a></li><li><a href="#%E9%85%8D%E7%BD%AE">配置</a></li></ul></li><li><a href="#%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6">使用中间件</a><ul><li><a href="#%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6">在应用中使用中间件</a></li><li><a href="#%E5%9C%A8%E6%A1%86%E6%9E%B6%E5%92%8C%E6%8F%92%E4%BB%B6%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6">在框架和插件中使用中间件</a></li><li><a href="#router-%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6">router 中使用中间件</a></li></ul></li><li><a href="#%E6%A1%86%E6%9E%B6%E9%BB%98%E8%AE%A4%E4%B8%AD%E9%97%B4%E4%BB%B6">框架默认中间件</a></li><li><a href="#%E4%BD%BF%E7%94%A8-koa-%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6">使用 Koa 的中间件</a></li><li><a href="#%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE">通用配置</a><ul><li><a href="#enable">enable</a></li><li><a href="#match-%E5%92%8C-ignore">match 和 ignore</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E7%BC%96%E5%86%99%E4%B8%AD%E9%97%B4%E4%BB%B6%5D(%23%25E7%25BC%2596%25E5%2586%2599%25E4%25B8%25AD%25E9%2597%25B4%25E4%25BB%25B6)%0A%20%20*%20%5B%E5%86%99%E6%B3%95%5D(%23%25E5%2586%2599%25E6%25B3%2595)%0A%20%20*%20%5B%E9%85%8D%E7%BD%AE%5D(%23%25E9%2585%258D%25E7%25BD%25AE)%0A-%20%5B%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%5D(%23%25E4%25BD%25BF%25E7%2594%25A8%25E4%25B8%25AD%25E9%2597%25B4%25E4%25BB%25B6)%0A%20%20*%20%5B%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%5D(%23%25E5%259C%25A8%25E5%25BA%2594%25E7%2594%25A8%25E4%25B8%25AD%25E4%25BD%25BF%25E7%2594%25A8%25E4%25B8%25AD%25E9%2597%25B4%25E4%25BB%25B6)%0A%20%20*%20%5B%E5%9C%A8%E6%A1%86%E6%9E%B6%E5%92%8C%E6%8F%92%E4%BB%B6%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%5D(%23%25E5%259C%25A8%25E6%25A1%2586%25E6%259E%25B6%25E5%2592%258C%25E6%258F%2592%25E4%25BB%25B6%25E4%25B8%25AD%25E4%25BD%25BF%25E7%2594%25A8%25E4%25B8%25AD%25E9%2597%25B4%25E4%25BB%25B6)%0A%20%20*%20%5Brouter%20%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%5D(%23router-%25E4%25B8%25AD%25E4%25BD%25BF%25E7%2594%25A8%25E4%25B8%25AD%25E9%2597%25B4%25E4%25BB%25B6)%0A-%20%5B%E6%A1%86%E6%9E%B6%E9%BB%98%E8%AE%A4%E4%B8%AD%E9%97%B4%E4%BB%B6%5D(%23%25E6%25A1%2586%25E6%259E%25B6%25E9%25BB%2598%25E8%25AE%25A4%25E4%25B8%25AD%25E9%2597%25B4%25E4%25BB%25B6)%0A-%20%5B%E4%BD%BF%E7%94%A8%20Koa%20%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%5D(%23%25E4%25BD%25BF%25E7%2594%25A8-koa-%25E7%259A%2584%25E4%25B8%25AD%25E9%2597%25B4%25E4%25BB%25B6)%0A-%20%5B%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE%5D(%23%25E9%2580%259A%25E7%2594%25A8%25E9%2585%258D%25E7%25BD%25AE)%0A%20%20*%20%5Benable%5D(%23enable)%0A%20%20*%20%5Bmatch%20%E5%92%8C%20ignore%5D(%23match-%25E5%2592%258C-ignore)","meta":{"info":{"title":"Middleware 中间件"}},"content":"%0A%0A%0A%E5%9C%A8%5B%E5%89%8D%E9%9D%A2%E7%9A%84%E7%AB%A0%E8%8A%82%5D(..%2Fintro%2Fegg-and-koa.md)%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BB%8B%E7%BB%8D%E4%BA%86%20Egg%20%E6%98%AF%E5%9F%BA%E4%BA%8E%20Koa%20%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%8C%E6%89%80%E4%BB%A5%20Egg%20%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BD%A2%E5%BC%8F%E5%92%8C%20Koa%20%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BD%A2%E5%BC%8F%E6%98%AF%E4%B8%80%E6%A0%B7%E7%9A%84%EF%BC%8C%E9%83%BD%E6%98%AF%E5%9F%BA%E4%BA%8E%5B%E6%B4%8B%E8%91%B1%E5%9C%88%E6%A8%A1%E5%9E%8B%5D(..%2Fintro%2Fegg-and-koa.md%23midlleware)%E3%80%82%E6%AF%8F%E6%AC%A1%E6%88%91%E4%BB%AC%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%8C%E5%B0%B1%E7%9B%B8%E5%BD%93%E4%BA%8E%E5%9C%A8%E6%B4%8B%E8%91%B1%E5%A4%96%E9%9D%A2%E5%8C%85%E4%BA%86%E4%B8%80%E5%B1%82%E3%80%82%0A%0A%23%23%20%E7%BC%96%E5%86%99%E4%B8%AD%E9%97%B4%E4%BB%B6%0A%0A%23%23%23%20%E5%86%99%E6%B3%95%0A%0A%E6%88%91%E4%BB%AC%E5%85%88%E6%9D%A5%E9%80%9A%E8%BF%87%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%20gzip%20%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%8C%E6%9D%A5%E7%9C%8B%E7%9C%8B%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%86%99%E6%B3%95%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fmiddleware%2Fgzip.js%0Aconst%20isJSON%20%3D%20require('koa-is-json')%3B%0Aconst%20zlib%20%3D%20require('zlib')%3B%0A%0Aasync%20function%20gzip(ctx%2C%20next)%20%7B%0A%20%20await%20next()%3B%0A%0A%20%20%2F%2F%20%E5%90%8E%E7%BB%AD%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%88%90%E5%90%8E%E5%B0%86%E5%93%8D%E5%BA%94%E4%BD%93%E8%BD%AC%E6%8D%A2%E6%88%90%20gzip%0A%20%20let%20body%20%3D%20ctx.body%3B%0A%20%20if%20(!body)%20return%3B%0A%20%20if%20(isJSON(body))%20body%20%3D%20JSON.stringify(body)%3B%0A%0A%20%20%2F%2F%20%E8%AE%BE%E7%BD%AE%20gzip%20body%EF%BC%8C%E4%BF%AE%E6%AD%A3%E5%93%8D%E5%BA%94%E5%A4%B4%0A%20%20const%20stream%20%3D%20zlib.createGzip()%3B%0A%20%20stream.end(body)%3B%0A%20%20ctx.body%20%3D%20stream%3B%0A%20%20ctx.set('Content-Encoding'%2C%20'gzip')%3B%0A%7D%0A%60%60%60%0A%0A%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E6%A1%86%E6%9E%B6%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%92%8C%20Koa%20%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%86%99%E6%B3%95%E6%98%AF%E4%B8%80%E6%A8%A1%E4%B8%80%E6%A0%B7%E7%9A%84%EF%BC%8C%E6%89%80%E4%BB%A5%E4%BB%BB%E4%BD%95%20Koa%20%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%83%BD%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E8%A2%AB%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8%E3%80%82%0A%0A%23%23%23%20%E9%85%8D%E7%BD%AE%0A%0A%E4%B8%80%E8%88%AC%E6%9D%A5%E8%AF%B4%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B9%9F%E4%BC%9A%E6%9C%89%E8%87%AA%E5%B7%B1%E7%9A%84%E9%85%8D%E7%BD%AE%E3%80%82%E5%9C%A8%E6%A1%86%E6%9E%B6%E4%B8%AD%EF%BC%8C%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%98%AF%E5%8C%85%E5%90%AB%E4%BA%86%E9%85%8D%E7%BD%AE%E5%A4%84%E7%90%86%E7%9A%84%E3%80%82%E6%88%91%E4%BB%AC%E7%BA%A6%E5%AE%9A%E4%B8%80%E4%B8%AA%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%98%AF%E4%B8%80%E4%B8%AA%E6%94%BE%E7%BD%AE%E5%9C%A8%20%60app%2Fmiddleware%60%20%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84%E5%8D%95%E7%8B%AC%E6%96%87%E4%BB%B6%EF%BC%8C%E5%AE%83%E9%9C%80%E8%A6%81%20exports%20%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%E7%9A%84%20function%EF%BC%8C%E6%8E%A5%E5%8F%97%E4%B8%A4%E4%B8%AA%E5%8F%82%E6%95%B0%EF%BC%9A%0A%0A-%20options%3A%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%EF%BC%8C%E6%A1%86%E6%9E%B6%E4%BC%9A%E5%B0%86%20%60app.config%5B%24%7BmiddlewareName%7D%5D%60%20%E4%BC%A0%E9%80%92%E8%BF%9B%E6%9D%A5%E3%80%82%0A-%20app%3A%20%E5%BD%93%E5%89%8D%E5%BA%94%E7%94%A8%20Application%20%E7%9A%84%E5%AE%9E%E4%BE%8B%E3%80%82%0A%0A%E6%88%91%E4%BB%AC%E5%B0%86%E4%B8%8A%E9%9D%A2%E7%9A%84%20gzip%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%81%9A%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BC%98%E5%8C%96%EF%BC%8C%E8%AE%A9%E5%AE%83%E6%94%AF%E6%8C%81%E6%8C%87%E5%AE%9A%E5%8F%AA%E6%9C%89%E5%BD%93%20body%20%E5%A4%A7%E4%BA%8E%E9%85%8D%E7%BD%AE%E7%9A%84%20threshold%20%E6%97%B6%E6%89%8D%E8%BF%9B%E8%A1%8C%20gzip%20%E5%8E%8B%E7%BC%A9%EF%BC%8C%E6%88%91%E4%BB%AC%E8%A6%81%E5%9C%A8%20%60app%2Fmiddleware%60%20%E7%9B%AE%E5%BD%95%E4%B8%8B%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%20%60gzip.js%60%0A%0A%60%60%60js%0A%2F%2F%20app%2Fmiddleware%2Fgzip.js%0Aconst%20isJSON%20%3D%20require('koa-is-json')%3B%0Aconst%20zlib%20%3D%20require('zlib')%3B%0A%0Amodule.exports%20%3D%20options%20%3D%3E%20%7B%0A%20%20return%20async%20function%20gzip(ctx%2C%20next)%20%7B%0A%20%20%20%20await%20next()%3B%0A%0A%20%20%20%20%2F%2F%20%E5%90%8E%E7%BB%AD%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%88%90%E5%90%8E%E5%B0%86%E5%93%8D%E5%BA%94%E4%BD%93%E8%BD%AC%E6%8D%A2%E6%88%90%20gzip%0A%20%20%20%20let%20body%20%3D%20ctx.body%3B%0A%20%20%20%20if%20(!body)%20return%3B%0A%0A%20%20%20%20%2F%2F%20%E6%94%AF%E6%8C%81%20options.threshold%0A%20%20%20%20if%20(options.threshold%20%26%26%20ctx.length%20%3C%20options.threshold)%20return%3B%0A%0A%20%20%20%20if%20(isJSON(body))%20body%20%3D%20JSON.stringify(body)%3B%0A%0A%20%20%20%20%2F%2F%20%E8%AE%BE%E7%BD%AE%20gzip%20body%EF%BC%8C%E4%BF%AE%E6%AD%A3%E5%93%8D%E5%BA%94%E5%A4%B4%0A%20%20%20%20const%20stream%20%3D%20zlib.createGzip()%3B%0A%20%20%20%20stream.end(body)%3B%0A%20%20%20%20ctx.body%20%3D%20stream%3B%0A%20%20%20%20ctx.set('Content-Encoding'%2C%20'gzip')%3B%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%0A%0A%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%BC%96%E5%86%99%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E6%88%91%E4%BB%AC%E8%BF%98%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BD%EF%BC%8C%E6%94%AF%E6%8C%81%E4%BB%A5%E4%B8%8B%E6%96%B9%E5%BC%8F%EF%BC%9A%0A%0A%23%23%23%20%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%0A%0A%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%AE%8C%E5%85%A8%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%E6%9D%A5%E5%8A%A0%E8%BD%BD%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%8C%E5%B9%B6%E5%86%B3%E5%AE%9A%E5%AE%83%E4%BB%AC%E7%9A%84%E9%A1%BA%E5%BA%8F%E3%80%82%0A%0A%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%8A%A0%E8%BD%BD%E4%B8%8A%E9%9D%A2%E7%9A%84%20gzip%20%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%8C%E5%9C%A8%20%60config.default.js%60%20%E4%B8%AD%E5%8A%A0%E5%85%A5%E4%B8%8B%E9%9D%A2%E7%9A%84%E9%85%8D%E7%BD%AE%E5%B0%B1%E5%AE%8C%E6%88%90%E4%BA%86%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%BC%80%E5%90%AF%E5%92%8C%E9%85%8D%E7%BD%AE%EF%BC%9A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20%2F%2F%20%E9%85%8D%E7%BD%AE%E9%9C%80%E8%A6%81%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%8C%E6%95%B0%E7%BB%84%E9%A1%BA%E5%BA%8F%E5%8D%B3%E4%B8%BA%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F%0A%20%20middleware%3A%20%5B%20'gzip'%20%5D%2C%0A%0A%20%20%2F%2F%20%E9%85%8D%E7%BD%AE%20gzip%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E9%85%8D%E7%BD%AE%0A%20%20gzip%3A%20%7B%0A%20%20%20%20threshold%3A%201024%2C%20%2F%2F%20%E5%B0%8F%E4%BA%8E%201k%20%E7%9A%84%E5%93%8D%E5%BA%94%E4%BD%93%E4%B8%8D%E5%8E%8B%E7%BC%A9%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%E8%AF%A5%E9%85%8D%E7%BD%AE%E6%9C%80%E7%BB%88%E5%B0%86%E5%9C%A8%E5%90%AF%E5%8A%A8%E6%97%B6%E5%90%88%E5%B9%B6%E5%88%B0%20%60app.config.appMiddleware%60%E3%80%82%0A%0A%23%23%23%20%E5%9C%A8%E6%A1%86%E6%9E%B6%E5%92%8C%E6%8F%92%E4%BB%B6%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%0A%0A%E6%A1%86%E6%9E%B6%E5%92%8C%E6%8F%92%E4%BB%B6%E4%B8%8D%E6%94%AF%E6%8C%81%E5%9C%A8%20%60config.default.js%60%20%E4%B8%AD%E5%8C%B9%E9%85%8D%20%60middleware%60%EF%BC%8C%E9%9C%80%E8%A6%81%E9%80%9A%E8%BF%87%E4%BB%A5%E4%B8%8B%E6%96%B9%E5%BC%8F%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%2F%2F%20%E5%9C%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%9C%80%E5%89%8D%E9%9D%A2%E7%BB%9F%E8%AE%A1%E8%AF%B7%E6%B1%82%E6%97%B6%E9%97%B4%0A%20%20app.config.coreMiddleware.unshift('report')%3B%0A%7D%3B%0A%0A%2F%2F%20app%2Fmiddleware%2Freport.js%0Amodule.exports%20%3D%20()%20%3D%3E%20%7B%0A%20%20return%20async%20function%20(ctx%2C%20next)%20%7B%0A%20%20%20%20const%20startTime%20%3D%20Date.now()%3B%0A%20%20%20%20await%20next()%3B%0A%20%20%20%20%2F%2F%20%E4%B8%8A%E6%8A%A5%E8%AF%B7%E6%B1%82%E6%97%B6%E9%97%B4%0A%20%20%20%20reportTime(Date.now()%20-%20startTime)%3B%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%E5%BA%94%E7%94%A8%E5%B1%82%E5%AE%9A%E4%B9%89%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%88%60app.config.appMiddleware%60%EF%BC%89%E5%92%8C%E6%A1%86%E6%9E%B6%E9%BB%98%E8%AE%A4%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%88%60app.config.coreMiddleware%60%EF%BC%89%E9%83%BD%E4%BC%9A%E8%A2%AB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%8A%A0%E8%BD%BD%EF%BC%8C%E5%B9%B6%E6%8C%82%E8%BD%BD%E5%88%B0%20%60app.middleware%60%20%E4%B8%8A%E3%80%82%0A%0A%23%23%23%20router%20%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%0A%0A%E4%BB%A5%E4%B8%8A%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F%E9%85%8D%E7%BD%AE%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%98%AF%E5%85%A8%E5%B1%80%E7%9A%84%EF%BC%8C%E4%BC%9A%E5%A4%84%E7%90%86%E6%AF%8F%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E3%80%82%0A%E5%A6%82%E6%9E%9C%E4%BD%A0%E5%8F%AA%E6%83%B3%E9%92%88%E5%AF%B9%E5%8D%95%E4%B8%AA%E8%B7%AF%E7%94%B1%E7%94%9F%E6%95%88%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E5%9C%A8%20%60app%2Frouter.js%60%20%E4%B8%AD%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%92%8C%E6%8C%82%E8%BD%BD%EF%BC%8C%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20gzip%20%3D%20app.middleware.gzip(%7B%20threshold%3A%201024%20%7D)%3B%0A%20%20app.router.get('%2Fneedgzip'%2C%20gzip%2C%20app.controller.handler)%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20%E6%A1%86%E6%9E%B6%E9%BB%98%E8%AE%A4%E4%B8%AD%E9%97%B4%E4%BB%B6%0A%0A%E9%99%A4%E4%BA%86%E5%BA%94%E7%94%A8%E5%B1%82%E5%8A%A0%E8%BD%BD%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B9%8B%E5%A4%96%EF%BC%8C%E6%A1%86%E6%9E%B6%E8%87%AA%E8%BA%AB%E5%92%8C%E5%85%B6%E4%BB%96%E7%9A%84%E6%8F%92%E4%BB%B6%E4%B9%9F%E4%BC%9A%E5%8A%A0%E8%BD%BD%E8%AE%B8%E5%A4%9A%E4%B8%AD%E9%97%B4%E4%BB%B6%E3%80%82%E6%89%80%E6%9C%89%E7%9A%84%E8%BF%99%E4%BA%9B%E8%87%AA%E5%B8%A6%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%E9%83%BD%E9%80%9A%E8%BF%87%E5%9C%A8%E9%85%8D%E7%BD%AE%E4%B8%AD%E4%BF%AE%E6%94%B9%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%90%8C%E5%90%8D%E9%85%8D%E7%BD%AE%E9%A1%B9%E8%BF%9B%E8%A1%8C%E4%BF%AE%E6%94%B9%EF%BC%8C%E4%BE%8B%E5%A6%82%5B%E6%A1%86%E6%9E%B6%E8%87%AA%E5%B8%A6%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg%2Ftree%2Fmaster%2Fapp%2Fmiddleware)%E4%B8%AD%E6%9C%89%E4%B8%80%E4%B8%AA%20bodyParser%20%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%88%E6%A1%86%E6%9E%B6%E7%9A%84%E5%8A%A0%E8%BD%BD%E5%99%A8%E4%BC%9A%E5%B0%86%E6%96%87%E4%BB%B6%E5%90%8D%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E5%88%86%E9%9A%94%E7%AC%A6%E9%83%BD%E4%BF%AE%E6%94%B9%E6%88%90%E9%A9%BC%E5%B3%B0%E5%BD%A2%E5%BC%8F%E7%9A%84%E5%8F%98%E9%87%8F%E5%90%8D%EF%BC%89%EF%BC%8C%E6%88%91%E4%BB%AC%E6%83%B3%E8%A6%81%E4%BF%AE%E6%94%B9%20bodyParser%20%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E5%9C%A8%20%60config%2Fconfig.default.js%60%20%E4%B8%AD%E7%BC%96%E5%86%99%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20bodyParser%3A%20%7B%0A%20%20%20%20jsonLimit%3A%20'10mb'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A**%E6%B3%A8%E6%84%8F%EF%BC%9A%E6%A1%86%E6%9E%B6%E5%92%8C%E6%8F%92%E4%BB%B6%E5%8A%A0%E8%BD%BD%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%BC%9A%E5%9C%A8%E5%BA%94%E7%94%A8%E5%B1%82%E9%85%8D%E7%BD%AE%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B9%8B%E5%89%8D%EF%BC%8C%E6%A1%86%E6%9E%B6%E9%BB%98%E8%AE%A4%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B8%8D%E8%83%BD%E8%A2%AB%E5%BA%94%E7%94%A8%E5%B1%82%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%A6%86%E7%9B%96%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%BA%94%E7%94%A8%E5%B1%82%E6%9C%89%E8%87%AA%E5%AE%9A%E4%B9%89%E5%90%8C%E5%90%8D%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%8C%E5%9C%A8%E5%90%AF%E5%8A%A8%E6%97%B6%E4%BC%9A%E6%8A%A5%E9%94%99%E3%80%82**%0A%0A%23%23%20%E4%BD%BF%E7%94%A8%20Koa%20%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%0A%0A%E5%9C%A8%E6%A1%86%E6%9E%B6%E9%87%8C%E9%9D%A2%E5%8F%AF%E4%BB%A5%E9%9D%9E%E5%B8%B8%E5%AE%B9%E6%98%93%E7%9A%84%E5%BC%95%E5%85%A5%20Koa%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%94%9F%E6%80%81%E3%80%82%0A%0A%E4%BB%A5%20%5Bkoa-compress%5D(https%3A%2F%2Fgithub.com%2Fkoajs%2Fcompress)%20%E4%B8%BA%E4%BE%8B%EF%BC%8C%E5%9C%A8%20Koa%20%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%97%B6%EF%BC%9A%0A%0A%60%60%60js%0Aconst%20koa%20%3D%20require('koa')%3B%0Aconst%20compress%20%3D%20require('koa-compress')%3B%0A%0Aconst%20app%20%3D%20koa()%3B%0A%0Aconst%20options%20%3D%20%7B%20threshold%3A%202048%20%7D%3B%0Aapp.use(compress(options))%3B%0A%60%60%60%0A%0A%E6%88%91%E4%BB%AC%E6%8C%89%E7%85%A7%E6%A1%86%E6%9E%B6%E7%9A%84%E8%A7%84%E8%8C%83%E6%9D%A5%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8A%A0%E8%BD%BD%E8%BF%99%E4%B8%AA%20Koa%20%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fmiddleware%2Fcompress.js%0A%2F%2F%20koa-compress%20%E6%9A%B4%E9%9C%B2%E7%9A%84%E6%8E%A5%E5%8F%A3(%60(options)%20%3D%3E%20middleware%60)%E5%92%8C%E6%A1%86%E6%9E%B6%E5%AF%B9%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%A6%81%E6%B1%82%E4%B8%80%E8%87%B4%0Amodule.exports%20%3D%20require('koa-compress')%3B%0A%60%60%60%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20middleware%3A%20%5B%20'compress'%20%5D%2C%0A%20%20compress%3A%20%7B%0A%20%20%20%20threshold%3A%202048%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%E5%A6%82%E6%9E%9C%E4%BD%BF%E7%94%A8%E5%88%B0%E7%9A%84%20Koa%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B8%8D%E7%AC%A6%E5%90%88%E5%85%A5%E5%8F%82%E8%A7%84%E8%8C%83%EF%BC%8C%E5%88%99%E5%8F%AF%E4%BB%A5%E8%87%AA%E8%A1%8C%E5%A4%84%E7%90%86%E4%B8%8B%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20webpack%3A%20%7B%0A%20%20%20%20compiler%3A%20%7B%7D%2C%0A%20%20%20%20others%3A%20%7B%7D%2C%0A%20%20%7D%2C%0A%7D%3B%0A%0A%2F%2F%20app%2Fmiddleware%2Fwebpack.js%0Aconst%20webpackMiddleware%20%3D%20require('some-koa-middleware')%3B%0A%0Amodule.exports%20%3D%20(options%2C%20app)%20%3D%3E%20%7B%0A%20%20return%20webpackMiddleware(options.compiler%2C%20options.others)%3B%0A%7D%0A%60%60%60%0A%0A%23%23%20%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE%0A%0A%E6%97%A0%E8%AE%BA%E6%98%AF%E5%BA%94%E7%94%A8%E5%B1%82%E5%8A%A0%E8%BD%BD%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%BF%98%E6%98%AF%E6%A1%86%E6%9E%B6%E8%87%AA%E5%B8%A6%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%8C%E9%83%BD%E6%94%AF%E6%8C%81%E5%87%A0%E4%B8%AA%E9%80%9A%E7%94%A8%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%EF%BC%9A%0A%0A-%20enable%EF%BC%9A%E6%8E%A7%E5%88%B6%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AF%E3%80%82%0A-%20match%EF%BC%9A%E8%AE%BE%E7%BD%AE%E5%8F%AA%E6%9C%89%E7%AC%A6%E5%90%88%E6%9F%90%E4%BA%9B%E8%A7%84%E5%88%99%E7%9A%84%E8%AF%B7%E6%B1%82%E6%89%8D%E4%BC%9A%E7%BB%8F%E8%BF%87%E8%BF%99%E4%B8%AA%E4%B8%AD%E9%97%B4%E4%BB%B6%E3%80%82%0A-%20ignore%EF%BC%9A%E8%AE%BE%E7%BD%AE%E7%AC%A6%E5%90%88%E6%9F%90%E4%BA%9B%E8%A7%84%E5%88%99%E7%9A%84%E8%AF%B7%E6%B1%82%E4%B8%8D%E7%BB%8F%E8%BF%87%E8%BF%99%E4%B8%AA%E4%B8%AD%E9%97%B4%E4%BB%B6%E3%80%82%0A%0A%23%23%23%20enable%0A%0A%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E7%9A%84%E5%BA%94%E7%94%A8%E5%B9%B6%E4%B8%8D%E9%9C%80%E8%A6%81%E9%BB%98%E8%AE%A4%E7%9A%84%20bodyParser%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%9D%A5%E8%BF%9B%E8%A1%8C%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E8%A7%A3%E6%9E%90%EF%BC%8C%E6%AD%A4%E6%97%B6%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%20enable%20%E4%B8%BA%20false%20%E6%9D%A5%E5%85%B3%E9%97%AD%E5%AE%83%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20bodyParser%3A%20%7B%0A%20%20%20%20enable%3A%20false%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20match%20%E5%92%8C%20ignore%0A%0Amatch%20%E5%92%8C%20ignore%20%E6%94%AF%E6%8C%81%E7%9A%84%E5%8F%82%E6%95%B0%E9%83%BD%E4%B8%80%E6%A0%B7%EF%BC%8C%E5%8F%AA%E6%98%AF%E4%BD%9C%E7%94%A8%E5%AE%8C%E5%85%A8%E7%9B%B8%E5%8F%8D%EF%BC%8Cmatch%20%E5%92%8C%20ignore%20%E4%B8%8D%E5%85%81%E8%AE%B8%E5%90%8C%E6%97%B6%E9%85%8D%E7%BD%AE%E3%80%82%0A%0A%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E6%83%B3%E8%AE%A9%20gzip%20%E5%8F%AA%E9%92%88%E5%AF%B9%20%60%2Fstatic%60%20%E5%89%8D%E7%BC%80%E5%BC%80%E5%A4%B4%E7%9A%84%20url%20%E8%AF%B7%E6%B1%82%E5%BC%80%E5%90%AF%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%85%8D%E7%BD%AE%20match%20%E9%80%89%E9%A1%B9%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20gzip%3A%20%7B%0A%20%20%20%20match%3A%20'%2Fstatic'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0Amatch%20%E5%92%8C%20ignore%20%E6%94%AF%E6%8C%81%E5%A4%9A%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%0A%0A1.%20%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%9A%E5%BD%93%E5%8F%82%E6%95%B0%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B%E6%97%B6%EF%BC%8C%E9%85%8D%E7%BD%AE%E7%9A%84%E6%98%AF%E4%B8%80%E4%B8%AA%20url%20%E7%9A%84%E8%B7%AF%E5%BE%84%E5%89%8D%E7%BC%80%EF%BC%8C%E6%89%80%E6%9C%89%E4%BB%A5%E9%85%8D%E7%BD%AE%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BD%9C%E4%B8%BA%E5%89%8D%E7%BC%80%E7%9A%84%20url%20%E9%83%BD%E4%BC%9A%E5%8C%B9%E9%85%8D%E4%B8%8A%E3%80%82%0A2.%20%E6%AD%A3%E5%88%99%EF%BC%9A%E5%BD%93%E5%8F%82%E6%95%B0%E4%B8%BA%E6%AD%A3%E5%88%99%E6%97%B6%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%8C%B9%E9%85%8D%E6%BB%A1%E8%B6%B3%E6%AD%A3%E5%88%99%E9%AA%8C%E8%AF%81%E7%9A%84%20url%20%E7%9A%84%E8%B7%AF%E5%BE%84%E3%80%82%0A3.%20%E5%87%BD%E6%95%B0%EF%BC%9A%E5%BD%93%E5%8F%82%E6%95%B0%E4%B8%BA%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E6%97%B6%EF%BC%8C%E4%BC%9A%E5%B0%86%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BC%A0%E9%80%92%E7%BB%99%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%EF%BC%8C%E6%9C%80%E7%BB%88%E5%8F%96%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E7%9A%84%E7%BB%93%E6%9E%9C%EF%BC%88ture%2Ffalse%EF%BC%89%E6%9D%A5%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E5%8C%B9%E9%85%8D%E3%80%82%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20gzip%3A%20%7B%0A%20%20%20%20match(ctx)%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E5%8F%AA%E6%9C%89%20ios%20%E8%AE%BE%E5%A4%87%E6%89%8D%E5%BC%80%E5%90%AF%0A%20%20%20%20%20%20const%20reg%20%3D%20%2Fiphone%7Cipad%7Cipod%2Fi%3B%0A%20%20%20%20%20%20return%20reg.test(ctx.get('user-agent'))%3B%0A%20%20%20%20%7D%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>