<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>controller</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><h2 id="什么是-controller">什么是 Controller</h2><p><a href="./router.md">前面章节</a>写到，我们通过 Router 将用户的请求基于 method 和 URL 分发到了对应的 Controller 上，那 Controller 负责做什么？</p><p>简单的说 Controller 负责<strong>解析用户的输入，处理后返回相应的结果</strong>，例如</p><ul><li>在 <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a> 接口中，Controller 接受用户的参数，从数据库中查找内容返回给用户或者将用户的请求更新到数据库中。</li><li>在 HTML 页面请求中，Controller 根据用户访问不同的 URL，渲染不同的模板得到 HTML 返回给用户。</li><li>在代理服务器中，Controller 将用户的请求转发到其他服务器上，并将其他服务器的处理结果返回给用户。</li></ul><p>框架推荐 Controller 层主要对用户的请求参数进行处理（校验、转换），然后调用对应的 <a href="./service.md">service</a> 方法处理业务，得到业务结果后封装并返回：</p><ol><li>获取用户通过 HTTP 传递过来的请求参数。</li><li>校验、组装参数。</li><li>调用 Service 进行业务处理，必要时处理转换 Service 的返回结果，让它适应用户的需求。</li><li>通过 HTTP 将结果响应给用户。</li></ol><h2 id="如何编写-controller">如何编写 Controller</h2><p>所有的 Controller 文件都必须放在 <code>app/controller</code> 目录下，可以支持多级目录，访问的时候可以通过目录名级联访问。Controller 支持多种形式进行编写，可以根据不同的项目场景和开发习惯来选择。</p><h3 id="controller-类推荐">Controller 类（推荐）</h3><p>我们可以通过定义 Controller 类的方式来编写代码：</p><pre><code class="language-js">// app/controller/post.js
const Controller = require(&#x27;egg&#x27;).Controller;
class PostController extends Controller {
  async create() {
    const { ctx, service } = this;
    const createRule = {
      title: { type: &#x27;string&#x27; },
      content: { type: &#x27;string&#x27; },
    };
    // 校验参数
    ctx.validate(createRule);
    // 组装参数
    const author = ctx.session.userId;
    const req = Object.assign(ctx.request.body, { author });
    // 调用 Service 进行业务处理
    const res = await service.post.create(req);
    // 设置响应内容和响应状态码
    ctx.body = { id: res.id };
    ctx.status = 201;
  }
}
module.exports = PostController;</code></pre><p>我们通过上面的代码定义了一个 <code>PostController</code> 的类，类里面的每一个方法都可以作为一个 Controller 在 Router 中引用到，我们可以从 <code>app.controller</code> 根据文件名和方法名定位到它。</p><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  const { router, controller } = app;
  router.post(&#x27;createPost&#x27;, &#x27;/api/posts&#x27;, controller.post.create);
}</code></pre><p>Controller 支持多级目录，例如如果我们将上面的 Controller 代码放到 <code>app/controller/sub/post.js</code> 中，则可以在 router 中这样使用：</p><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  app.router.post(&#x27;createPost&#x27;, &#x27;/api/posts&#x27;, app.controller.sub.post.create);
}</code></pre><p>定义的 Controller 类，会在每一个请求访问到 server 时实例化一个全新的对象，而项目中的 Controller 类继承于 <code>egg.Controller</code>，会有下面几个属性挂在 <code>this</code> 上。</p><ul><li><code>this.ctx</code>: 当前请求的上下文 <a href="./extend.md#context">Context</a> 对象的实例，通过它我们可以拿到框架封装好的处理当前请求的各种便捷属性和方法。</li><li><code>this.app</code>: 当前应用 <a href="./extend.md#application">Application</a> 对象的实例，通过它我们可以拿到框架提供的全局对象和方法。</li><li><code>this.service</code>：应用定义的 <a href="./service.md">Service</a>，通过它我们可以访问到抽象出的业务层，等价于 <code>this.ctx.service</code> 。</li><li><code>this.config</code>：应用运行时的<a href="./config.md">配置项</a>。</li><li><code>this.logger</code>：logger 对象，上面有四个方法（<code>debug</code>，<code>info</code>，<code>warn</code>，<code>error</code>），分别代表打印四个不同级别的日志，使用方法和效果与 <a href="../core/logger.md#context-logger">context logger</a> 中介绍的一样，但是通过这个 logger 对象记录的日志，在日志前面会加上打印该日志的文件路径，以便快速定位日志打印位置。</li></ul><h4 id="自定义-controller-基类">自定义 Controller 基类</h4><p>按照类的方式编写 Controller，不仅可以让我们更好的对 Controller 层代码进行抽象（例如将一些统一的处理抽象成一些私有方法），还可以通过自定义 Controller 基类的方式封装应用中常用的方法。</p><pre><code class="language-js">// app/core/base_controller.js
const { Controller } = require(&#x27;egg&#x27;);
class BaseController extends Controller {
  get user() {
    return this.ctx.session.user;
  }

  success(data) {
    this.ctx.body = {
      success: true,
      data,
    };
  }

  notFound(msg) {
    msg = msg || &#x27;not found&#x27;;
    this.ctx.throw(404, msg);
  }
}
module.exports = BaseController;</code></pre><p>此时在编写应用的 Controller 时，可以继承 BaseController，直接使用基类上的方法：</p><pre><code class="language-js">//app/controller/post.js
const Controller = require(&#x27;../core/base_controller&#x27;);
class PostController extends Controller {
  async list() {
    const posts = await this.service.listByUser(this.user);
    this.success(posts);
  }
}</code></pre><h3 id="controller-方法不推荐使用只是为了兼容">Controller 方法（不推荐使用，只是为了兼容）</h3><p>每一个 Controller 都是一个 async function，它的入参为请求的上下文 <a href="./extend.md#context">Context</a> 对象的实例，通过它我们可以拿到框架封装好的各种便捷属性和方法。</p><p>例如我们写一个对应到 <code>POST /api/posts</code> 接口的 Controller，我们会在 <code>app/controller</code> 目录下创建一个 <code>post.js</code> 文件</p><pre><code class="language-js">// app/controller/post.js
exports.create = async ctx =&gt; {
  const createRule = {
    title: { type: &#x27;string&#x27; },
    content: { type: &#x27;string&#x27; },
  };
  // 校验参数
  ctx.validate(createRule);
  // 组装参数
  const author = ctx.session.userId;
  const req = Object.assign(ctx.request.body, { author });
  // 调用 service 进行业务处理
  const res = await ctx.service.post.create(req);
  // 设置响应内容和响应状态码
  ctx.body = { id: res.id };
  ctx.status = 201;
};</code></pre><p>在上面的例子中我们引入了许多新的概念，但还是比较直观，容易理解的，我们会在下面对它们进行更详细的介绍。</p><h2 id="http-基础">HTTP 基础</h2><p>由于 Controller 基本上是业务开发中唯一和 HTTP 协议打交道的地方，在继续往下了解之前，我们首先简单的看一下 HTTP 协议是怎样的。</p><p>如果我们发起一个 HTTP 请求来访问前面例子中提到的 Controller：</p><pre><code>curl -X POST http://localhost:3000/api/posts --data &#x27;{&quot;title&quot;:&quot;controller&quot;, &quot;content&quot;: &quot;what is controller&quot;}&#x27; --header &#x27;Content-Type:application/json; charset=UTF-8&#x27;</code></pre><p>通过 curl 发出的 HTTP 请求的内容就会是下面这样的：</p><pre><code>POST /api/posts HTTP/1.1
Host: localhost:3000
Content-Type: application/json; charset=UTF-8

{&quot;title&quot;: &quot;controller&quot;, &quot;content&quot;: &quot;what is controller&quot;}</code></pre><p>请求的第一行包含了三个信息，我们比较常用的是前面两个：</p><ul><li>method：这个请求中 method 的值是 <code>POST</code>。</li><li>path：值为 <code>/api/posts</code>，如果用户的请求中包含 query，也会在这里出现</li></ul><p>从第二行开始直到遇到的第一个空行位置，都是请求的 Headers 部分，这一部分中有许多常用的属性，包括这里看到的 Host，Content-Type，还有 <code>Cookie</code>，<code>User-Agent</code> 等等。在这个请求中有两个头：</p><ul><li><code>Host</code>：我们在浏览器发起请求的时候，域名会用来通过 DNS 解析找到服务的 IP 地址，但是浏览器也会将域名和端口号放在 Host 头中一并发送给服务端。</li><li><code>Content-Type</code>：当我们的请求有 body 的时候，都会有 Content-Type 来标明我们的请求体是什么格式的。</li></ul><p>之后的内容全部都是请求的 body，当请求是 POST, PUT, DELETE 等方法的时候，可以带上请求体，服务端会根据 Content-Type 来解析请求体。</p><p>在服务端处理完这个请求后，会发送一个 HTTP 响应给客户端</p><pre><code>HTTP/1.1 201 Created
Content-Type: application/json; charset=utf-8
Content-Length: 8
Date: Mon, 09 Jan 2017 08:40:28 GMT
Connection: keep-alive

{&quot;id&quot;: 1}</code></pre><p>第一行中也包含了三段，其中我们常用的主要是<a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">响应状态码</a>，这个例子中它的值是 201，它的含义是在服务端成功创建了一条资源。</p><p>和请求一样，从第二行开始到下一个空行之间都是响应头，这里的 Content-Type, Content-Length 表示这个响应的格式是 JSON，长度为 8 个字节。</p><p>最后剩下的部分就是这次响应真正的内容。</p><h2 id="获取-http-请求参数">获取 HTTP 请求参数</h2><p>从上面的 HTTP 请求示例中可以看到，有好多地方可以放用户的请求数据，框架通过在 Controller 上绑定的 Context 实例，提供了许多便捷方法和属性获取用户通过 HTTP 请求发送过来的参数。</p><h3 id="query">query</h3><p>在 URL 中 <code>?</code> 后面的部分是一个 Query String，这一部分经常用于 GET 类型的请求中传递参数。例如 <code>GET /posts?category=egg&amp;language=node</code> 中 <code>category=egg&amp;language=node</code> 就是用户传递过来的参数。我们可以通过 <code>ctx.query</code> 拿到解析过后的这个参数体</p><pre><code class="language-js">class PostController extends Controller {
  async listPosts() {
    const query = this.ctx.query;
    // {
    //   category: &#x27;egg&#x27;,
    //   language: &#x27;node&#x27;,
    // }
  }
}</code></pre><p>当 Query String 中的 key 重复时，<code>ctx.query</code> 只取 key 第一次出现时的值，后面再出现的都会被忽略。<code>GET /posts?category=egg&amp;category=koa</code> 通过 <code>ctx.query</code> 拿到的值是 <code>{ category: &#x27;egg&#x27; }</code>。</p><p>这样处理的原因是为了保持统一性，由于通常情况下我们都不会设计让用户传递 key 相同的 Query String，所以我们经常会写类似下面的代码：</p><pre><code class="language-js">const key = ctx.query.key || &#x27;&#x27;;
if (key.startsWith(&#x27;egg&#x27;)) {
  // do something
}</code></pre><p>而如果有人故意发起请求在 Query String 中带上重复的 key 来请求时就会引发系统异常。因此框架保证了从 <code>ctx.query</code> 上获取的参数一旦存在，一定是字符串类型。</p><h4 id="queries">queries</h4><p>有时候我们的系统会设计成让用户传递相同的 key，例如 <code>GET /posts?category=egg&amp;id=1&amp;id=2&amp;id=3</code>。针对此类情况，框架提供了 <code>ctx.queries</code> 对象，这个对象也解析了 Query String，但是它不会丢弃任何一个重复的数据，而是将他们都放到一个数组中：</p><pre><code class="language-js">// GET /posts?category=egg&amp;id=1&amp;id=2&amp;id=3
class PostController extends Controller {
  async listPosts() {
    console.log(this.ctx.queries);
    // {
    //   category: [ &#x27;egg&#x27; ],
    //   id: [ &#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27; ],
    // }
  }
}</code></pre><p><code>ctx.queries</code> 上所有的 key 如果有值，也一定会是数组类型。</p><h3 id="router-params">Router params</h3><p>在 <a href="./router.md">Router</a> 中，我们介绍了 Router 上也可以申明参数，这些参数都可以通过 <code>ctx.params</code> 获取到。</p><pre><code class="language-js">// app.get(&#x27;/projects/:projectId/app/:appId&#x27;, &#x27;app.listApp&#x27;);
// GET /projects/1/app/2
class AppController extends Controller {
  async listApp() {
    assert.equal(this.ctx.params.projectId, &#x27;1&#x27;);
    assert.equal(this.ctx.params.appId, &#x27;2&#x27;);
  }
}</code></pre><h3 id="body">body</h3><p>虽然我们可以通过 URL 传递参数，但是还是有诸多限制：</p><ul><li><a href="http://stackoverflow.com/questions/417142/what-is-the-maximum-length-of-a-url-in-different-browsers">浏览器中会对 URL 的长度有所限制</a>，如果需要传递的参数过多就会无法传递。</li><li>服务端经常会将访问的完整 URL 记录到日志文件中，有一些敏感数据通过 URL 传递会不安全。</li></ul><p>在前面的 HTTP 请求报文示例中，我们看到在 header 之后还有一个 body 部分，我们通常会在这个部分传递 POST、PUT 和 DELETE 等方法的参数。一般请求中有 body 的时候，客户端（浏览器）会同时发送 <code>Content-Type</code> 告诉服务端这次请求的 body 是什么格式的。Web 开发中数据传递最常用的两类格式分别是 JSON 和 Form。</p><p>框架内置了 <a href="https://github.com/koajs/bodyparser">bodyParser</a> 中间件来对这两类格式的请求 body 解析成 object 挂载到 <code>ctx.request.body</code> 上。HTTP 协议中并不建议在通过 GET、HEAD 方法访问时传递 body，所以我们无法在 GET、HEAD 方法中按照此方法获取到内容。</p><pre><code class="language-js">// POST /api/posts HTTP/1.1
// Host: localhost:3000
// Content-Type: application/json; charset=UTF-8
//
// {&quot;title&quot;: &quot;controller&quot;, &quot;content&quot;: &quot;what is controller&quot;}
class PostController extends Controller {
  async listPosts() {
    assert.equal(this.ctx.request.body.title, &#x27;controller&#x27;);
    assert.equal(this.ctx.request.body.content, &#x27;what is controller&#x27;);
  }
}</code></pre><p>框架对 bodyParser 设置了一些默认参数，配置好之后拥有以下特性：</p><ul><li>当请求的 Content-Type 为 <code>application/json</code>，<code>application/json-patch+json</code>，<code>application/vnd.api+json</code> 和 <code>application/csp-report</code> 时，会按照 json 格式对请求 body 进行解析，并限制 body 最大长度为 <code>100kb</code>。</li><li>当请求的 Content-Type 为 <code>application/x-www-form-urlencoded</code> 时，会按照 form 格式对请求 body 进行解析，并限制 body 最大长度为 <code>100kb</code>。</li><li>如果解析成功，body 一定会是一个 Object（可能是一个数组）。</li></ul><p>一般来说我们最经常调整的配置项就是变更解析时允许的最大长度，可以在 <code>config/config.default.js</code> 中覆盖框架的默认值。</p><pre><code class="language-js">module.exports = {
  bodyParser: {
    jsonLimit: &#x27;1mb&#x27;,
    formLimit: &#x27;1mb&#x27;,
  },
};</code></pre><p>如果用户的请求 body 超过了我们配置的解析最大长度，会抛出一个状态码为 <code>413</code> 的异常，如果用户请求的 body 解析失败（错误的 JSON），会抛出一个状态码为 <code>400</code> 的异常。</p><p><strong>注意：在调整 bodyParser 支持的 body 长度时，如果我们应用前面还有一层反向代理（Nginx），可能也需要调整它的配置，确保反向代理也支持同样长度的请求 body。</strong></p><p><strong>一个常见的错误是把 <code>ctx.request.body</code> 和 <code>ctx.body</code> 混淆，后者其实是 <code>ctx.response.body</code> 的简写。</strong></p><h3 id="获取上传的文件">获取上传的文件</h3><p>请求 body 除了可以带参数之外，还可以发送文件，一般来说，浏览器上都是通过 <code>Multipart/form-data</code> 格式发送文件的，框架通过内置 <a href="https://github.com/eggjs/egg-multipart">Multipart</a> 插件来支持获取用户上传的文件。</p><p>完整的上传示例参见：<a href="https://github.com/eggjs/examples/tree/master/multipart">eggjs/examples/multipart</a>。</p><p>在 Controller 中，我们可以通过 <code>ctx.getFileStream()</code> 接口能获取到上传的文件流。</p><pre><code class="language-html">&lt;form method=&quot;POST&quot; action=&quot;/upload?_csrf={{ ctx.csrf | safe }}&quot; enctype=&quot;multipart/form-data&quot;&gt;
  title: &lt;input name=&quot;title&quot; /&gt;
  file: &lt;input name=&quot;file&quot; type=&quot;file&quot; /&gt;
  &lt;button type=&quot;submit&quot;&gt;上传&lt;/button&gt;
&lt;/form&gt;</code></pre><pre><code class="language-js">const path = require(&#x27;path&#x27;);
const sendToWormhole = require(&#x27;stream-wormhole&#x27;);
const Controller = require(&#x27;egg&#x27;).Controller;

class UploaderController extends Controller {
  async upload() {
    const ctx = this.ctx;
    const stream = await ctx.getFileStream();
    const name = &#x27;egg-multipart-test/&#x27; + path.basename(stream.filename);
    // 文件处理，上传到云存储等等
    let result;
    try {
      result = await ctx.oss.put(name, stream);
    } catch (err) {
      // 必须将上传的文件流消费掉，要不然浏览器响应会卡死
      await sendToWormhole(stream);
      throw err;
    }

    ctx.body = {
      url: result.url,
      // 所有表单字段都能通过 `stream.fields` 获取到
      fields: stream.fields,
    };
  }
}

module.exports = UploaderController;</code></pre><p>要通过 <code>ctx.getFileStream</code> 便捷的获取到用户上传的文件，需要满足两个条件：</p><ul><li>只支持上传一个文件。</li><li>上传文件必须在所有其他的 fields 后面，否则在拿到文件流时可能还获取不到 fields。</li></ul><p>如果要获取同时上传的多个文件，不能通过 <code>ctx.getFileStream()</code> 来获取，只能通过下面这种方式：</p><pre><code class="language-js">const sendToWormhole = require(&#x27;stream-wormhole&#x27;);
const Controller = require(&#x27;egg&#x27;).Controller;

class UploaderController extends Controller {
  async upload() {
    const ctx = this.ctx;
    const parts = ctx.multipart();
    let part;
    // parts() return a promise
    while ((part = await parts()) != null) {
      if (part.length) {
        // 如果是数组的话是 filed
        console.log(&#x27;field: &#x27; + part[0]);
        console.log(&#x27;value: &#x27; + part[1]);
        console.log(&#x27;valueTruncated: &#x27; + part[2]);
        console.log(&#x27;fieldnameTruncated: &#x27; + part[3]);
      } else {
        if (!part.filename) {
          // 这时是用户没有选择文件就点击了上传(part 是 file stream，但是 part.filename 为空)
          // 需要做出处理，例如给出错误提示消息
          return;
        }
        // part 是上传的文件流
        console.log(&#x27;field: &#x27; + part.fieldname);
        console.log(&#x27;filename: &#x27; + part.filename);
        console.log(&#x27;encoding: &#x27; + part.encoding);
        console.log(&#x27;mime: &#x27; + part.mime);
        // 文件处理，上传到云存储等等
        let result;
        try {
          result = await ctx.oss.put(&#x27;egg-multipart-test/&#x27; + part.filename, part);
        } catch (err) {
          // 必须将上传的文件流消费掉，要不然浏览器响应会卡死
          await sendToWormhole(part);
          throw err;
        }
        console.log(result);
      }
    }
    console.log(&#x27;and we are done parsing the form!&#x27;);
  }
}

module.exports = UploaderController;</code></pre><p>为了保证文件上传的安全，框架限制了支持的的文件格式，框架默认支持白名单如下：</p><pre><code class="language-js">// images
&#x27;.jpg&#x27;, &#x27;.jpeg&#x27;, // image/jpeg
&#x27;.png&#x27;, // image/png, image/x-png
&#x27;.gif&#x27;, // image/gif
&#x27;.bmp&#x27;, // image/bmp
&#x27;.wbmp&#x27;, // image/vnd.wap.wbmp
&#x27;.webp&#x27;,
&#x27;.tif&#x27;,
&#x27;.psd&#x27;,
// text
&#x27;.svg&#x27;,
&#x27;.js&#x27;, &#x27;.jsx&#x27;,
&#x27;.json&#x27;,
&#x27;.css&#x27;, &#x27;.less&#x27;,
&#x27;.html&#x27;, &#x27;.htm&#x27;,
&#x27;.xml&#x27;,
// tar
&#x27;.zip&#x27;,
&#x27;.gz&#x27;, &#x27;.tgz&#x27;, &#x27;.gzip&#x27;,
// video
&#x27;.mp3&#x27;,
&#x27;.mp4&#x27;,
&#x27;.avi&#x27;,</code></pre><p>用户可以通过在 <code>config/config.default.js</code> 中配置来新增支持的文件扩展名，或者重写整个白名单</p><ul><li>新增支持的文件扩展名</li></ul><pre><code class="language-js">module.exports = {
  multipart: {
    fileExtensions: [ &#x27;.apk&#x27; ], // 增加对 .apk 扩展名的支持
  },
};</code></pre><ul><li>覆盖整个白名单</li></ul><pre><code class="language-js">module.exports = {
  multipart: {
    whitelist: [ &#x27;.png&#x27; ], // 覆盖整个白名单，只允许上传 &#x27;.png&#x27; 格式
  },
};</code></pre><p><strong>注意：当传递了 whitelist 属性时，fileExtensions 属性不生效。</strong></p><h3 id="header">header</h3><p>除了从 URL 和请求 body 上获取参数之外，还有许多参数是通过请求 header 传递的。框架提供了一些辅助属性和方法来获取。</p><ul><li><code>ctx.headers</code>，<code>ctx.header</code>，<code>ctx.request.headers</code>，<code>ctx.request.header</code>：这几个方法是等价的，都是获取整个 header 对象。</li><li><code>ctx.get(name)</code>，<code>ctx.request.get(name)</code>：获取请求 header 中的一个字段的值，如果这个字段不存在，会返回空字符串。</li><li>我们建议用 <code>ctx.get(name)</code> 而不是 <code>ctx.headers[&#x27;name&#x27;]</code>，因为前者会自动处理大小写。</li></ul><p>由于 header 比较特殊，有一些是 <code>HTTP</code> 协议规定了具体含义的（例如 <code>Content-Type</code>，<code>Accept</code>），有些是反向代理设置的，已经约定俗成（X-Forwarded-For），框架也会对他们增加一些便捷的 getter，详细的 getter 可以查看 <a href="https://eggjs.org/api/">API</a> 文档。</p><p>特别是如果我们通过 <code>config.proxy = true</code> 设置了应用部署在反向代理（Nginx）之后，有一些 Getter 的内部处理会发生改变。</p><h4 id="ctxhost"><code>ctx.host</code></h4><p>优先读通过 <code>config.hostHeaders</code> 中配置的 header 的值，读不到时再尝试获取 host 这个 header 的值，如果都获取不到，返回空字符串。</p><p><code>config.hostHeaders</code> 默认配置为 <code>x-forwarded-host</code>。</p><h4 id="ctxprotocol"><code>ctx.protocol</code></h4><p>通过这个 Getter 获取 protocol 时，首先会判断当前连接是否是加密连接，如果是加密连接，返回 https。</p><p>如果处于非加密连接时，优先读通过 <code>config.protocolHeaders</code> 中配置的 header 的值来判断是 HTTP 还是 https，如果读取不到，我们可以在配置中通过 <code>config.protocol</code> 来设置兜底值，默认为 HTTP。</p><p><code>config.protocolHeaders</code> 默认配置为 <code>x-forwarded-proto</code>。</p><h4 id="ctxips"><code>ctx.ips</code></h4><p>通过 <code>ctx.ips</code> 获取请求经过所有的中间设备 IP 地址列表，只有在 <code>config.proxy = true</code> 时，才会通过读取 <code>config.ipHeaders</code> 中配置的 header 的值来获取，获取不到时为空数组。</p><p><code>config.ipHeaders</code> 默认配置为 <code>x-forwarded-for</code>。</p><h4 id="ctxip"><code>ctx.ip</code></h4><p>通过 <code>ctx.ip</code> 获取请求发起方的 IP 地址，优先从 <code>ctx.ips</code> 中获取，<code>ctx.ips</code> 为空时使用连接上发起方的 IP 地址。</p><p><strong>注意：<code>ip</code> 和 <code>ips</code> 不同，<code>ip</code> 当 <code>config.proxy = false</code> 时会返回当前连接发起者的 <code>ip</code> 地址，<code>ips</code> 此时会为空数组。</strong></p><h3 id="cookie">Cookie</h3><p>HTTP 请求都是无状态的，但是我们的 Web 应用通常都需要知道发起请求的人是谁。为了解决这个问题，HTTP 协议设计了一个特殊的请求头：<a href="https://en.wikipedia.org/wiki/HTTP_cookie">Cookie</a>。服务端可以通过响应头（set-cookie）将少量数据响应给客户端，浏览器会遵循协议将数据保存，并在下次请求同一个服务的时候带上（浏览器也会遵循协议，只在访问符合 Cookie 指定规则的网站时带上对应的 Cookie 来保证安全性）。</p><p>通过 <code>ctx.cookies</code>，我们可以在 Controller 中便捷、安全的设置和读取 Cookie。</p><pre><code class="language-js">class CookieController extends Controller {
  async add() {
    const ctx = this.ctx;
    const count = ctx.cookies.get(&#x27;count&#x27;);
    count = count ? Number(count) : 0;
    ctx.cookies.set(&#x27;count&#x27;, ++count);
    ctx.body = count;
  }

  async remove() {
    const ctx = this.ctx;
    const count = ctx.cookies.set(&#x27;count&#x27;, null);
    ctx.status = 204;
  }
}</code></pre><p>Cookie 虽然在 HTTP 中只是一个头，但是通过 <code>foo=bar;foo1=bar1;</code> 的格式可以设置多个键值对。</p><p>Cookie 在 Web 应用中经常承担了传递客户端身份信息的作用，因此有许多安全相关的配置，不可忽视，<a href="../core/cookie-and-session.md#cookie">Cookie</a> 文档中详细介绍了 Cookie 的用法和安全相关的配置项，可以深入阅读了解。</p><h3 id="session">Session</h3><p>通过 Cookie，我们可以给每一个用户设置一个 Session，用来存储用户身份相关的信息，这份信息会加密后存储在 Cookie 中，实现跨请求的用户身份保持。</p><p>框架内置了 <a href="https://github.com/eggjs/egg-session">Session</a> 插件，给我们提供了 <code>ctx.session</code> 来访问或者修改当前用户 Session 。</p><pre><code class="language-js">class PostController extends Controller {
  async fetchPosts() {
    const ctx = this.ctx;
    // 获取 Session 上的内容
    const userId = ctx.session.userId;
    const posts = await ctx.service.post.fetch(userId);
    // 修改 Session 的值
    ctx.session.visited = ctx.session.visited ? ++ctx.session.visited : 1;
    ctx.body = {
      success: true,
      posts,
    };
  }
}</code></pre><p>Session 的使用方法非常直观，直接读取它或者修改它就可以了，如果要删除它，直接将它赋值为 <code>null</code>：</p><pre><code class="language-js">class SessionController extends Controller {
  async deleteSession() {
    this.ctx.session = null;
  }
};</code></pre><p>和 Cookie 一样，Session 也有许多安全等选项和功能，在使用之前也最好阅读 <a href="../core/cookie-and-session.md#session">Session</a> 文档深入了解。</p><h4 id="配置">配置</h4><p>对于 Session 来说，主要有下面几个属性可以在 <code>config.default.js</code> 中进行配置:</p><pre><code class="language-js">module.exports = {
  key: &#x27;EGG_SESS&#x27;, // 承载 Session 的 Cookie 键值对名字
  maxAge: 86400000, // Session 的最大有效时间
};</code></pre><h2 id="参数校验">参数校验</h2><p>在获取到用户请求的参数后，不可避免的要对参数进行一些校验。</p><p>借助 <a href="https://github.com/eggjs/egg-validate">Validate</a> 插件提供便捷的参数校验机制，帮助我们完成各种复杂的参数校验。</p><pre><code class="language-js">// config/plugin.js
exports.validate = {
  enable: true,
  package: &#x27;egg-validate&#x27;,
};</code></pre><p>通过 <code>ctx.validate(rule, [body])</code> 直接对参数进行校验：</p><pre><code class="language-js">class PostController extends Controller {
  async create() {
    // 校验参数
    // 如果不传第二个参数会自动校验 `ctx.request.body`
    this.ctx.validate({
      title: { type: &#x27;string&#x27; },
      content: { type: &#x27;string&#x27; },
    });
  }
}</code></pre><p>当校验异常时，会直接抛出一个异常，异常的状态码为 422，errors 字段包含了详细的验证不通过信息。如果想要自己处理检查的异常，可以通过 <code>try catch</code> 来自行捕获。</p><pre><code class="language-js">class PostController extends Controller {
  async create() {
    const ctx = this.ctx;
    try {
      ctx.validate(createRule);
    } catch (err) {
      ctx.logger.warn(err.errors);
      ctx.body = { success: false };
      return;
    }
  }
};</code></pre><h3 id="校验规则">校验规则</h3><p>参数校验通过 <a href="https://github.com/node-modules/parameter#rule">Parameter</a> 完成，支持的校验规则可以在该模块的文档中查阅到。</p><h4 id="自定义校验规则">自定义校验规则</h4><p>除了上一节介绍的内置检验类型外，有时候我们希望自定义一些校验规则，让开发时更便捷，此时可以通过 <code>app.validator.addRule(type, check)</code> 的方式新增自定义规则。</p><pre><code class="language-js">// app.js
app.validator.addRule(&#x27;json&#x27;, (rule, value) =&gt; {
  try {
    JSON.parse(value);
  } catch (err) {
    return &#x27;must be json string&#x27;;
  }
});</code></pre><p>添加完自定义规则之后，就可以在 Controller 中直接使用这条规则来进行参数校验了</p><pre><code class="language-js">class PostController extends Controller {
  async handler() {
    const ctx = this.ctx;
    // query.test 字段必须是 json 字符串
    const rule = { test: &#x27;json&#x27; };
    ctx.validate(rule, ctx.query);
  }
};</code></pre><h2 id="调用-service">调用 Service</h2><p>我们并不想在 Controller 中实现太多业务逻辑，所以提供了一个 <a href="./service.md">Service</a> 层进行业务逻辑的封装，这不仅能提高代码的复用性，同时可以让我们的业务逻辑更好测试。</p><p>在 Controller 中可以调用任何一个 Service 上的任何方法，同时 Service 是懒加载的，只有当访问到它的时候框架才会去实例化它。</p><pre><code class="language-js">class PostController extends Controller {
  async create() {
    const ctx = this.ctx;
    const author = ctx.session.userId;
    const req = Object.assign(ctx.request.body, { author });
    // 调用 service 进行业务处理
    const res = await ctx.service.post.create(req);
    ctx.body = { id: res.id };
    ctx.status = 201;
  }
}</code></pre><p>Service 的具体写法，请查看 <a href="./service.md">Service</a> 章节。</p><h2 id="发送-http-响应">发送 HTTP 响应</h2><p>当业务逻辑完成之后，Controller 的最后一个职责就是将业务逻辑的处理结果通过 HTTP 响应发送给用户。</p><h3 id="设置-status">设置 status</h3><p>HTTP 设计了非常多的<a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">状态码</a>，每一个状态码都代表了一个特定的含义，通过设置正确的状态码，可以让响应更符合语义。</p><p>框架提供了一个便捷的 Setter 来进行状态码的设置</p><pre><code class="language-js">class PostController extends Controller {
  async create() {
    // 设置状态码为 201
    this.ctx.status = 201;
  }
};</code></pre><p>具体什么场景设置什么样的状态码，可以参考 <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">List of HTTP status codes</a> 中各个状态码的含义。</p><h3 id="设置-body">设置 body</h3><p>绝大多数的数据都是通过 body 发送给请求方的，和请求中的 body 一样，在响应中发送的 body，也需要有配套的 Content-Type 告知客户端如何对数据进行解析。</p><ul><li>作为一个 RESTful 的 API 接口 controller，我们通常会返回 Content-Type 为 <code>application/json</code> 格式的 body，内容是一个 JSON 字符串。</li><li>作为一个 html 页面的 controller，我们通常会返回 Content-Type 为 <code>text/html</code> 格式的 body，内容是 html 代码段。</li></ul><p><strong>注意：<code>ctx.body</code> 是 <code>ctx.response.body</code> 的简写，不要和 <code>ctx.request.body</code> 混淆了。</strong></p><pre><code class="language-js">class ViewController extends Controller {
  async show() {
    this.ctx.body = {
      name: &#x27;egg&#x27;,
      category: &#x27;framework&#x27;,
      language: &#x27;Node.js&#x27;,
    };
  }

  async page() {
    this.ctx.body = &#x27;&lt;html&gt;&lt;h1&gt;Hello&lt;/h1&gt;&lt;/html&gt;&#x27;;
  }
}</code></pre><p>由于 Node.js 的流式特性，我们还有很多场景需要通过 Stream 返回响应，例如返回一个大文件，代理服务器直接返回上游的内容，框架也支持直接将 body 设置成一个 Stream，并会同时处理好这个 Stream 上的错误事件。</p><pre><code class="language-js">class ProxyController extends Controller {
  async proxy() {
    const ctx = this.ctx;
    const result = await ctx.curl(url, {
      streaming: true,
    });
    ctx.set(result.header);
    // result.res 是一个 stream
    ctx.body = result.res;
  }
};</code></pre><h4 id="渲染模板">渲染模板</h4><p>通常来说，我们不会手写 HTML 页面，而是会通过模板引擎进行生成。
框架自身没有集成任何一个模板引擎，但是约定了 <a href="../advanced/view-plugin.md">View 插件的规范</a>，通过接入的模板引擎，可以直接使用 <code>ctx.render(template)</code> 来渲染模板生成 html。</p><pre><code class="language-js">class HomeController extends Controller {
  async index() {
    const ctx = this.ctx;
    await ctx.render(&#x27;home.tpl&#x27;, { name: &#x27;egg&#x27; });
    // ctx.body = await ctx.renderString(&#x27;hi, {{ name }}&#x27;, { name: &#x27;egg&#x27; });
  }
};</code></pre><p>具体示例可以查看<a href="../core/view.md">模板渲染</a>。</p><h4 id="jsonp">JSONP</h4><p>有时我们需要给非本域的页面提供接口服务，又由于一些历史原因无法通过 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">CORS</a> 实现，可以通过 <a href="https://en.wikipedia.org/wiki/JSONP">JSONP</a> 来进行响应。</p><p>由于 JSONP 如果使用不当会导致非常多的安全问题，所以框架中提供了便捷的响应 JSONP 格式数据的方法，封装了 <a href="../core/security.md#jsonp-xss">JSONP XSS 相关的安全防范</a>，并支持进行 CSRF 校验和 referrer 校验。</p><ul><li>通过 <code>app.jsonp()</code> 提供的中间件来让一个 controller 支持响应 JSONP 格式的数据。在路由中，我们给需要支持 jsonp 的路由加上这个中间件：</li></ul><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  const jsonp = app.jsonp();
  app.router.get(&#x27;/api/posts/:id&#x27;, jsonp, app.controller.posts.show);
  app.router.get(&#x27;/api/posts&#x27;, jsonp, app.controller.posts.list);
};</code></pre><ul><li>在 Controller 中，只需要正常编写即可：</li></ul><pre><code class="language-js">// app/controller/posts.js
class PostController extends Controller {
  async show() {
    this.ctx.body = {
      name: &#x27;egg&#x27;,
      category: &#x27;framework&#x27;,
      language: &#x27;Node.js&#x27;,
    };
  }
}</code></pre><p>用户请求对应的 URL 访问到这个 controller 的时候，如果 query 中有 <code>_callback=fn</code> 参数，将会返回 JSONP 格式的数据，否则返回 JSON 格式的数据。</p><h5 id="jsonp-配置">JSONP 配置</h5><p>框架默认通过 query 中的 <code>_callback</code> 参数作为识别是否返回 JSONP 格式数据的依据，并且 <code>_callback</code> 中设置的方法名长度最多只允许 50 个字符。应用可以在 <code>config/config.default.js</code> 全局覆盖默认的配置：</p><pre><code class="language-js">// config/config.default.js
exports.jsonp = {
  callback: &#x27;callback&#x27;, // 识别 query 中的 `callback` 参数
  limit: 100, // 函数名最长为 100 个字符
};</code></pre><p>通过上面的方式配置之后，如果用户请求 <code>/api/posts/1?callback=fn</code>，响应为 JSONP 格式，如果用户请求 <code>/api/posts/1</code>，响应格式为 JSON。</p><p>我们同样可以在 <code>app.jsonp()</code> 创建中间件时覆盖默认的配置，以达到不同路由使用不同配置的目的：</p><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  const { router, controller, jsonp } = app;
  router.get(&#x27;/api/posts/:id&#x27;, jsonp({ callback: &#x27;callback&#x27; }), controller.posts.show);
  router.get(&#x27;/api/posts&#x27;, jsonp({ callback: &#x27;cb&#x27; }), controller.posts.list);
};</code></pre><h5 id="跨站防御配置">跨站防御配置</h5><p>默认配置下，响应 JSONP 时不会进行任何跨站攻击的防范，在某些情况下，这是很危险的。我们初略将 JSONP 接口分为三种类型：</p><ol><li>查询非敏感数据，例如获取一个论坛的公开文章列表。</li><li>查询敏感数据，例如获取一个用户的交易记录。</li><li>提交数据并修改数据库，例如给某一个用户创建一笔订单。</li></ol><p>如果我们的 JSONP 接口提供下面两类服务，在不做任何跨站防御的情况下，可能泄露用户敏感数据甚至导致用户被钓鱼。因此框架给 JSONP 默认提供了 CSRF 校验支持和 referrer 校验支持。</p><h6 id="csrf">CSRF</h6><p>在 JSONP 配置中，我们只需要打开 <code>csrf: true</code>，即可对 JSONP 接口开启 CSRF 校验。</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  jsonp: {
    csrf: true,
  },
};</code></pre><p><strong>注意，CSRF 校验依赖于 <a href="../core/security.md">security</a> 插件提供的基于 Cookie 的 CSRF 校验。</strong></p><p>在开启 CSRF 校验时，客户端在发起 JSONP 请求时，也要带上 CSRF token，如果发起 JSONP 的请求方所在的页面和我们的服务在同一个主域名之下的话，可以读取到 Cookie 中的 CSRF token（在 CSRF token 缺失时也可以自行设置 CSRF token 到 Cookie 中），并在请求时带上该 token。</p><h5 id="referrer-校验">referrer 校验</h5><p>如果在同一个主域之下，可以通过开启 CSRF 的方式来校验 JSONP 请求的来源，而如果想对其他域名的网页提供 JSONP 服务，我们可以通过配置 referrer 白名单的方式来限制 JSONP 的请求方在可控范围之内。</p><pre><code class="language-js">//config/config.default.js
exports.jsonp = {
  whiteList: /^https?:\/\/test.com\//,
  // whiteList: &#x27;.test.com&#x27;,
  // whiteList: &#x27;sub.test.com&#x27;,
  // whiteList: [ &#x27;sub.test.com&#x27;, &#x27;sub2.test.com&#x27; ],
};</code></pre><p><code>whiteList</code> 可以配置为正则表达式、字符串或者数组：</p><ul><li>正则表达式：此时只有请求的 Referrer 匹配该正则时才允许访问 JSONP 接口。在设置正则表达式的时候，注意开头的 <code>^</code> 以及结尾的 <code>\/</code>，保证匹配到完整的域名。</li></ul><pre><code class="language-js">exports.jsonp = {
  whiteList: /^https?:\/\/test.com\//,
};
// matches referrer:
// https://test.com/hello
// http://test.com/</code></pre><ul><li>字符串：设置字符串形式的白名单时分为两种，当字符串以 <code>.</code> 开头，例如 <code>.test.com</code> 时，代表 referrer 白名单为 <code>test.com</code> 的所有子域名，包括 <code>test.com</code> 自身。当字符串不以 <code>.</code> 开头，例如 <code>sub.test.com</code>，代表 referrer 白名单为 <code>sub.test.com</code> 这一个域名。（同时支持 HTTP 和 HTTPS）。</li></ul><pre><code class="language-js">exports.jsonp = {
  whiteList: &#x27;.test.com&#x27;,
};
// matches domain test.com:
// https://test.com/hello
// http://test.com/

// matches subdomain
// https://sub.test.com/hello
// http://sub.sub.test.com/

exports.jsonp = {
  whiteList: &#x27;sub.test.com&#x27;,
};
// only matches domain sub.test.com:
// https://sub.test.com/hello
// http://sub.test.com/</code></pre><ul><li>数组：当设置的白名单为数组时，代表只要满足数组中任意一个元素的条件即可通过 referrer 校验。</li></ul><pre><code class="language-js">exports.jsonp = {
  whiteList: [ &#x27;sub.test.com&#x27;, &#x27;sub2.test.com&#x27; ],
};
// matches domain sub.test.com and sub2.test.com:
// https://sub.test.com/hello
// http://sub2.test.com/</code></pre><p><strong>当 CSRF 和 referrer 校验同时开启时，请求发起方只需要满足任意一个条件即可通过 JSONP 的安全校验。</strong></p><h3 id="设置-header">设置 Header</h3><p>我们通过状态码标识请求成功与否、状态如何，在 body 中设置响应的内容。而通过响应的 Header，还可以设置一些扩展信息。</p><p>通过 <code>ctx.set(key, value)</code> 方法可以设置一个响应头，<code>ctx.set(headers)</code> 设置多个 Header。</p><pre><code class="language-js">// app/controller/api.js
class ProxyController extends Controller {
  async show() {
    const ctx = this.ctx;
    const start = Date.now();
    ctx.body = await ctx.service.post.get();
    const used = Date.now() - start;
    // 设置一个响应头
    ctx.set(&#x27;show-response-time&#x27;, used.toString());
  }
};</code></pre><h3 id="重定向">重定向</h3><p>框架通过 security 插件覆盖了 koa 原生的 <code>ctx.redirect</code> 实现，以提供更加安全的重定向。</p><ul><li><code>ctx.redirect(url)</code> 如果不在配置的白名单域名内，则禁止跳转。</li><li><code>ctx.unsafeRedirect(url)</code> 不判断域名，直接跳转，一般不建议使用，明确了解可能带来的风险后使用。</li></ul><p>用户如果使用<code>ctx.redirect</code>方法，需要在应用的配置文件中做如下配置：</p><pre><code class="language-js">// config/config.default.js
exports.security = {
  domainWhiteList:[&#x27;.domain.com&#x27;],  // 安全白名单，以 . 开头
};</code></pre><p>若用户没有配置 <code>domainWhiteList</code> 或者 <code>domainWhiteList</code>数组内为空，则默认会对所有跳转请求放行，即等同于<code>ctx.unsafeRedirect(url)</code></p></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-controller">什么是 Controller</a></li><li><a href="#%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99-controller">如何编写 Controller</a><ul><li><a href="#controller-%E7%B1%BB%E6%8E%A8%E8%8D%90">Controller 类（推荐）</a><ul><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89-controller-%E5%9F%BA%E7%B1%BB">自定义 Controller 基类</a></li></ul></li><li><a href="#controller-%E6%96%B9%E6%B3%95%E4%B8%8D%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8%E5%8F%AA%E6%98%AF%E4%B8%BA%E4%BA%86%E5%85%BC%E5%AE%B9">Controller 方法（不推荐使用，只是为了兼容）</a></li></ul></li><li><a href="#http-%E5%9F%BA%E7%A1%80">HTTP 基础</a></li><li><a href="#%E8%8E%B7%E5%8F%96-http-%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0">获取 HTTP 请求参数</a><ul><li><a href="#query">query</a><ul><li><a href="#queries">queries</a></li></ul></li><li><a href="#router-params">Router params</a></li><li><a href="#body">body</a></li><li><a href="#%E8%8E%B7%E5%8F%96%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6">获取上传的文件</a></li><li><a href="#header">header</a><ul><li><a href="#ctxhost"><code>ctx.host</code></a></li><li><a href="#ctxprotocol"><code>ctx.protocol</code></a></li><li><a href="#ctxips"><code>ctx.ips</code></a></li><li><a href="#ctxip"><code>ctx.ip</code></a></li></ul></li><li><a href="#cookie">Cookie</a></li><li><a href="#session">Session</a><ul><li><a href="#%E9%85%8D%E7%BD%AE">配置</a></li></ul></li></ul></li><li><a href="#%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C">参数校验</a><ul><li><a href="#%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99">校验规则</a><ul><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99">自定义校验规则</a></li></ul></li></ul></li><li><a href="#%E8%B0%83%E7%94%A8-service">调用 Service</a></li><li><a href="#%E5%8F%91%E9%80%81-http-%E5%93%8D%E5%BA%94">发送 HTTP 响应</a><ul><li><a href="#%E8%AE%BE%E7%BD%AE-status">设置 status</a></li><li><a href="#%E8%AE%BE%E7%BD%AE-body">设置 body</a><ul><li><a href="#%E6%B8%B2%E6%9F%93%E6%A8%A1%E6%9D%BF">渲染模板</a></li><li><a href="#jsonp">JSONP</a><ul><li><a href="#jsonp-%E9%85%8D%E7%BD%AE">JSONP 配置</a></li><li><a href="#%E8%B7%A8%E7%AB%99%E9%98%B2%E5%BE%A1%E9%85%8D%E7%BD%AE">跨站防御配置</a><ul><li><a href="#csrf">CSRF</a></li></ul></li><li><a href="#referrer-%E6%A0%A1%E9%AA%8C">referrer 校验</a></li></ul></li></ul></li><li><a href="#%E8%AE%BE%E7%BD%AE-header">设置 Header</a></li><li><a href="#%E9%87%8D%E5%AE%9A%E5%90%91">重定向</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E4%BB%80%E4%B9%88%E6%98%AF%20Controller%5D(%23%25E4%25BB%2580%25E4%25B9%2588%25E6%2598%25AF-controller)%0A-%20%5B%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%20Controller%5D(%23%25E5%25A6%2582%25E4%25BD%2595%25E7%25BC%2596%25E5%2586%2599-controller)%0A%20%20*%20%5BController%20%E7%B1%BB%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89%5D(%23controller-%25E7%25B1%25BB%25E6%258E%25A8%25E8%258D%2590)%0A%20%20%20%20%2B%20%5B%E8%87%AA%E5%AE%9A%E4%B9%89%20Controller%20%E5%9F%BA%E7%B1%BB%5D(%23%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589-controller-%25E5%259F%25BA%25E7%25B1%25BB)%0A%20%20*%20%5BController%20%E6%96%B9%E6%B3%95%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8%EF%BC%8C%E5%8F%AA%E6%98%AF%E4%B8%BA%E4%BA%86%E5%85%BC%E5%AE%B9%EF%BC%89%5D(%23controller-%25E6%2596%25B9%25E6%25B3%2595%25E4%25B8%258D%25E6%258E%25A8%25E8%258D%2590%25E4%25BD%25BF%25E7%2594%25A8%25E5%258F%25AA%25E6%2598%25AF%25E4%25B8%25BA%25E4%25BA%2586%25E5%2585%25BC%25E5%25AE%25B9)%0A-%20%5BHTTP%20%E5%9F%BA%E7%A1%80%5D(%23http-%25E5%259F%25BA%25E7%25A1%2580)%0A-%20%5B%E8%8E%B7%E5%8F%96%20HTTP%20%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%5D(%23%25E8%258E%25B7%25E5%258F%2596-http-%25E8%25AF%25B7%25E6%25B1%2582%25E5%258F%2582%25E6%2595%25B0)%0A%20%20*%20%5Bquery%5D(%23query)%0A%20%20%20%20%2B%20%5Bqueries%5D(%23queries)%0A%20%20*%20%5BRouter%20params%5D(%23router-params)%0A%20%20*%20%5Bbody%5D(%23body)%0A%20%20*%20%5B%E8%8E%B7%E5%8F%96%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6%5D(%23%25E8%258E%25B7%25E5%258F%2596%25E4%25B8%258A%25E4%25BC%25A0%25E7%259A%2584%25E6%2596%2587%25E4%25BB%25B6)%0A%20%20*%20%5Bheader%5D(%23header)%0A%20%20%20%20%2B%20%5B%60ctx.host%60%5D(%23ctxhost)%0A%20%20%20%20%2B%20%5B%60ctx.protocol%60%5D(%23ctxprotocol)%0A%20%20%20%20%2B%20%5B%60ctx.ips%60%5D(%23ctxips)%0A%20%20%20%20%2B%20%5B%60ctx.ip%60%5D(%23ctxip)%0A%20%20*%20%5BCookie%5D(%23cookie)%0A%20%20*%20%5BSession%5D(%23session)%0A%20%20%20%20%2B%20%5B%E9%85%8D%E7%BD%AE%5D(%23%25E9%2585%258D%25E7%25BD%25AE)%0A-%20%5B%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%5D(%23%25E5%258F%2582%25E6%2595%25B0%25E6%25A0%25A1%25E9%25AA%258C)%0A%20%20*%20%5B%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99%5D(%23%25E6%25A0%25A1%25E9%25AA%258C%25E8%25A7%2584%25E5%2588%2599)%0A%20%20%20%20%2B%20%5B%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99%5D(%23%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589%25E6%25A0%25A1%25E9%25AA%258C%25E8%25A7%2584%25E5%2588%2599)%0A-%20%5B%E8%B0%83%E7%94%A8%20Service%5D(%23%25E8%25B0%2583%25E7%2594%25A8-service)%0A-%20%5B%E5%8F%91%E9%80%81%20HTTP%20%E5%93%8D%E5%BA%94%5D(%23%25E5%258F%2591%25E9%2580%2581-http-%25E5%2593%258D%25E5%25BA%2594)%0A%20%20*%20%5B%E8%AE%BE%E7%BD%AE%20status%5D(%23%25E8%25AE%25BE%25E7%25BD%25AE-status)%0A%20%20*%20%5B%E8%AE%BE%E7%BD%AE%20body%5D(%23%25E8%25AE%25BE%25E7%25BD%25AE-body)%0A%20%20%20%20%2B%20%5B%E6%B8%B2%E6%9F%93%E6%A8%A1%E6%9D%BF%5D(%23%25E6%25B8%25B2%25E6%259F%2593%25E6%25A8%25A1%25E6%259D%25BF)%0A%20%20%20%20%2B%20%5BJSONP%5D(%23jsonp)%0A%20%20%20%20%20%20-%20%5BJSONP%20%E9%85%8D%E7%BD%AE%5D(%23jsonp-%25E9%2585%258D%25E7%25BD%25AE)%0A%20%20%20%20%20%20-%20%5B%E8%B7%A8%E7%AB%99%E9%98%B2%E5%BE%A1%E9%85%8D%E7%BD%AE%5D(%23%25E8%25B7%25A8%25E7%25AB%2599%25E9%2598%25B2%25E5%25BE%25A1%25E9%2585%258D%25E7%25BD%25AE)%0A%20%20%20%20%20%20%20%20*%20%5BCSRF%5D(%23csrf)%0A%20%20%20%20%20%20-%20%5Breferrer%20%E6%A0%A1%E9%AA%8C%5D(%23referrer-%25E6%25A0%25A1%25E9%25AA%258C)%0A%20%20*%20%5B%E8%AE%BE%E7%BD%AE%20Header%5D(%23%25E8%25AE%25BE%25E7%25BD%25AE-header)%0A%20%20*%20%5B%E9%87%8D%E5%AE%9A%E5%90%91%5D(%23%25E9%2587%258D%25E5%25AE%259A%25E5%2590%2591)","meta":{"info":{"title":"controller"}},"content":"%0A%0A%0A%23%23%20%E4%BB%80%E4%B9%88%E6%98%AF%20Controller%0A%0A%5B%E5%89%8D%E9%9D%A2%E7%AB%A0%E8%8A%82%5D(.%2Frouter.md)%E5%86%99%E5%88%B0%EF%BC%8C%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87%20Router%20%E5%B0%86%E7%94%A8%E6%88%B7%E7%9A%84%E8%AF%B7%E6%B1%82%E5%9F%BA%E4%BA%8E%20method%20%E5%92%8C%20URL%20%E5%88%86%E5%8F%91%E5%88%B0%E4%BA%86%E5%AF%B9%E5%BA%94%E7%9A%84%20Controller%20%E4%B8%8A%EF%BC%8C%E9%82%A3%20Controller%20%E8%B4%9F%E8%B4%A3%E5%81%9A%E4%BB%80%E4%B9%88%EF%BC%9F%0A%0A%E7%AE%80%E5%8D%95%E7%9A%84%E8%AF%B4%20Controller%20%E8%B4%9F%E8%B4%A3**%E8%A7%A3%E6%9E%90%E7%94%A8%E6%88%B7%E7%9A%84%E8%BE%93%E5%85%A5%EF%BC%8C%E5%A4%84%E7%90%86%E5%90%8E%E8%BF%94%E5%9B%9E%E7%9B%B8%E5%BA%94%E7%9A%84%E7%BB%93%E6%9E%9C**%EF%BC%8C%E4%BE%8B%E5%A6%82%0A%0A-%20%E5%9C%A8%20%5BRESTful%5D(https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FRepresentational_state_transfer)%20%E6%8E%A5%E5%8F%A3%E4%B8%AD%EF%BC%8CController%20%E6%8E%A5%E5%8F%97%E7%94%A8%E6%88%B7%E7%9A%84%E5%8F%82%E6%95%B0%EF%BC%8C%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E6%9F%A5%E6%89%BE%E5%86%85%E5%AE%B9%E8%BF%94%E5%9B%9E%E7%BB%99%E7%94%A8%E6%88%B7%E6%88%96%E8%80%85%E5%B0%86%E7%94%A8%E6%88%B7%E7%9A%84%E8%AF%B7%E6%B1%82%E6%9B%B4%E6%96%B0%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E3%80%82%0A-%20%E5%9C%A8%20HTML%20%E9%A1%B5%E9%9D%A2%E8%AF%B7%E6%B1%82%E4%B8%AD%EF%BC%8CController%20%E6%A0%B9%E6%8D%AE%E7%94%A8%E6%88%B7%E8%AE%BF%E9%97%AE%E4%B8%8D%E5%90%8C%E7%9A%84%20URL%EF%BC%8C%E6%B8%B2%E6%9F%93%E4%B8%8D%E5%90%8C%E7%9A%84%E6%A8%A1%E6%9D%BF%E5%BE%97%E5%88%B0%20HTML%20%E8%BF%94%E5%9B%9E%E7%BB%99%E7%94%A8%E6%88%B7%E3%80%82%0A-%20%E5%9C%A8%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%EF%BC%8CController%20%E5%B0%86%E7%94%A8%E6%88%B7%E7%9A%84%E8%AF%B7%E6%B1%82%E8%BD%AC%E5%8F%91%E5%88%B0%E5%85%B6%E4%BB%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%85%B6%E4%BB%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%A4%84%E7%90%86%E7%BB%93%E6%9E%9C%E8%BF%94%E5%9B%9E%E7%BB%99%E7%94%A8%E6%88%B7%E3%80%82%0A%0A%E6%A1%86%E6%9E%B6%E6%8E%A8%E8%8D%90%20Controller%20%E5%B1%82%E4%B8%BB%E8%A6%81%E5%AF%B9%E7%94%A8%E6%88%B7%E7%9A%84%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86%EF%BC%88%E6%A0%A1%E9%AA%8C%E3%80%81%E8%BD%AC%E6%8D%A2%EF%BC%89%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8%E5%AF%B9%E5%BA%94%E7%9A%84%20%5Bservice%5D(.%2Fservice.md)%20%E6%96%B9%E6%B3%95%E5%A4%84%E7%90%86%E4%B8%9A%E5%8A%A1%EF%BC%8C%E5%BE%97%E5%88%B0%E4%B8%9A%E5%8A%A1%E7%BB%93%E6%9E%9C%E5%90%8E%E5%B0%81%E8%A3%85%E5%B9%B6%E8%BF%94%E5%9B%9E%EF%BC%9A%0A%0A1.%20%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E9%80%9A%E8%BF%87%20HTTP%20%E4%BC%A0%E9%80%92%E8%BF%87%E6%9D%A5%E7%9A%84%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E3%80%82%0A1.%20%E6%A0%A1%E9%AA%8C%E3%80%81%E7%BB%84%E8%A3%85%E5%8F%82%E6%95%B0%E3%80%82%0A1.%20%E8%B0%83%E7%94%A8%20Service%20%E8%BF%9B%E8%A1%8C%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86%EF%BC%8C%E5%BF%85%E8%A6%81%E6%97%B6%E5%A4%84%E7%90%86%E8%BD%AC%E6%8D%A2%20Service%20%E7%9A%84%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%EF%BC%8C%E8%AE%A9%E5%AE%83%E9%80%82%E5%BA%94%E7%94%A8%E6%88%B7%E7%9A%84%E9%9C%80%E6%B1%82%E3%80%82%0A1.%20%E9%80%9A%E8%BF%87%20HTTP%20%E5%B0%86%E7%BB%93%E6%9E%9C%E5%93%8D%E5%BA%94%E7%BB%99%E7%94%A8%E6%88%B7%E3%80%82%0A%0A%23%23%20%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%20Controller%0A%0A%E6%89%80%E6%9C%89%E7%9A%84%20Controller%20%E6%96%87%E4%BB%B6%E9%83%BD%E5%BF%85%E9%A1%BB%E6%94%BE%E5%9C%A8%20%60app%2Fcontroller%60%20%E7%9B%AE%E5%BD%95%E4%B8%8B%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%94%AF%E6%8C%81%E5%A4%9A%E7%BA%A7%E7%9B%AE%E5%BD%95%EF%BC%8C%E8%AE%BF%E9%97%AE%E7%9A%84%E6%97%B6%E5%80%99%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E7%9B%AE%E5%BD%95%E5%90%8D%E7%BA%A7%E8%81%94%E8%AE%BF%E9%97%AE%E3%80%82Controller%20%E6%94%AF%E6%8C%81%E5%A4%9A%E7%A7%8D%E5%BD%A2%E5%BC%8F%E8%BF%9B%E8%A1%8C%E7%BC%96%E5%86%99%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%A0%B9%E6%8D%AE%E4%B8%8D%E5%90%8C%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%9C%BA%E6%99%AF%E5%92%8C%E5%BC%80%E5%8F%91%E4%B9%A0%E6%83%AF%E6%9D%A5%E9%80%89%E6%8B%A9%E3%80%82%0A%0A%23%23%23%20Controller%20%E7%B1%BB%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89%0A%0A%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%AE%9A%E4%B9%89%20Controller%20%E7%B1%BB%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fpost.js%0Aconst%20Controller%20%3D%20require('egg').Controller%3B%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20create()%20%7B%0A%20%20%20%20const%20%7B%20ctx%2C%20service%20%7D%20%3D%20this%3B%0A%20%20%20%20const%20createRule%20%3D%20%7B%0A%20%20%20%20%20%20title%3A%20%7B%20type%3A%20'string'%20%7D%2C%0A%20%20%20%20%20%20content%3A%20%7B%20type%3A%20'string'%20%7D%2C%0A%20%20%20%20%7D%3B%0A%20%20%20%20%2F%2F%20%E6%A0%A1%E9%AA%8C%E5%8F%82%E6%95%B0%0A%20%20%20%20ctx.validate(createRule)%3B%0A%20%20%20%20%2F%2F%20%E7%BB%84%E8%A3%85%E5%8F%82%E6%95%B0%0A%20%20%20%20const%20author%20%3D%20ctx.session.userId%3B%0A%20%20%20%20const%20req%20%3D%20Object.assign(ctx.request.body%2C%20%7B%20author%20%7D)%3B%0A%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8%20Service%20%E8%BF%9B%E8%A1%8C%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86%0A%20%20%20%20const%20res%20%3D%20await%20service.post.create(req)%3B%0A%20%20%20%20%2F%2F%20%E8%AE%BE%E7%BD%AE%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9%E5%92%8C%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81%0A%20%20%20%20ctx.body%20%3D%20%7B%20id%3A%20res.id%20%7D%3B%0A%20%20%20%20ctx.status%20%3D%20201%3B%0A%20%20%7D%0A%7D%0Amodule.exports%20%3D%20PostController%3B%0A%60%60%60%0A%0A%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87%E4%B8%8A%E9%9D%A2%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%9A%E4%B9%89%E4%BA%86%E4%B8%80%E4%B8%AA%20%60PostController%60%20%E7%9A%84%E7%B1%BB%EF%BC%8C%E7%B1%BB%E9%87%8C%E9%9D%A2%E7%9A%84%E6%AF%8F%E4%B8%80%E4%B8%AA%E6%96%B9%E6%B3%95%E9%83%BD%E5%8F%AF%E4%BB%A5%E4%BD%9C%E4%B8%BA%E4%B8%80%E4%B8%AA%20Controller%20%E5%9C%A8%20Router%20%E4%B8%AD%E5%BC%95%E7%94%A8%E5%88%B0%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%BB%8E%20%60app.controller%60%20%E6%A0%B9%E6%8D%AE%E6%96%87%E4%BB%B6%E5%90%8D%E5%92%8C%E6%96%B9%E6%B3%95%E5%90%8D%E5%AE%9A%E4%BD%8D%E5%88%B0%E5%AE%83%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20%7B%20router%2C%20controller%20%7D%20%3D%20app%3B%0A%20%20router.post('createPost'%2C%20'%2Fapi%2Fposts'%2C%20controller.post.create)%3B%0A%7D%0A%60%60%60%0A%0AController%20%E6%94%AF%E6%8C%81%E5%A4%9A%E7%BA%A7%E7%9B%AE%E5%BD%95%EF%BC%8C%E4%BE%8B%E5%A6%82%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E5%B0%86%E4%B8%8A%E9%9D%A2%E7%9A%84%20Controller%20%E4%BB%A3%E7%A0%81%E6%94%BE%E5%88%B0%20%60app%2Fcontroller%2Fsub%2Fpost.js%60%20%E4%B8%AD%EF%BC%8C%E5%88%99%E5%8F%AF%E4%BB%A5%E5%9C%A8%20router%20%E4%B8%AD%E8%BF%99%E6%A0%B7%E4%BD%BF%E7%94%A8%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.router.post('createPost'%2C%20'%2Fapi%2Fposts'%2C%20app.controller.sub.post.create)%3B%0A%7D%0A%60%60%60%0A%0A%E5%AE%9A%E4%B9%89%E7%9A%84%20Controller%20%E7%B1%BB%EF%BC%8C%E4%BC%9A%E5%9C%A8%E6%AF%8F%E4%B8%80%E4%B8%AA%E8%AF%B7%E6%B1%82%E8%AE%BF%E9%97%AE%E5%88%B0%20server%20%E6%97%B6%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E5%85%A8%E6%96%B0%E7%9A%84%E5%AF%B9%E8%B1%A1%EF%BC%8C%E8%80%8C%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%20Controller%20%E7%B1%BB%E7%BB%A7%E6%89%BF%E4%BA%8E%20%60egg.Controller%60%EF%BC%8C%E4%BC%9A%E6%9C%89%E4%B8%8B%E9%9D%A2%E5%87%A0%E4%B8%AA%E5%B1%9E%E6%80%A7%E6%8C%82%E5%9C%A8%20%60this%60%20%E4%B8%8A%E3%80%82%0A%0A-%20%60this.ctx%60%3A%20%E5%BD%93%E5%89%8D%E8%AF%B7%E6%B1%82%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%20%5BContext%5D(.%2Fextend.md%23context)%20%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AE%9E%E4%BE%8B%EF%BC%8C%E9%80%9A%E8%BF%87%E5%AE%83%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%8B%BF%E5%88%B0%E6%A1%86%E6%9E%B6%E5%B0%81%E8%A3%85%E5%A5%BD%E7%9A%84%E5%A4%84%E7%90%86%E5%BD%93%E5%89%8D%E8%AF%B7%E6%B1%82%E7%9A%84%E5%90%84%E7%A7%8D%E4%BE%BF%E6%8D%B7%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%E3%80%82%0A-%20%60this.app%60%3A%20%E5%BD%93%E5%89%8D%E5%BA%94%E7%94%A8%20%5BApplication%5D(.%2Fextend.md%23application)%20%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AE%9E%E4%BE%8B%EF%BC%8C%E9%80%9A%E8%BF%87%E5%AE%83%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%8B%BF%E5%88%B0%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E7%9A%84%E5%85%A8%E5%B1%80%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%96%B9%E6%B3%95%E3%80%82%0A-%20%60this.service%60%EF%BC%9A%E5%BA%94%E7%94%A8%E5%AE%9A%E4%B9%89%E7%9A%84%20%5BService%5D(.%2Fservice.md)%EF%BC%8C%E9%80%9A%E8%BF%87%E5%AE%83%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E5%88%B0%E6%8A%BD%E8%B1%A1%E5%87%BA%E7%9A%84%E4%B8%9A%E5%8A%A1%E5%B1%82%EF%BC%8C%E7%AD%89%E4%BB%B7%E4%BA%8E%20%60this.ctx.service%60%20%E3%80%82%0A-%20%60this.config%60%EF%BC%9A%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84%5B%E9%85%8D%E7%BD%AE%E9%A1%B9%5D(.%2Fconfig.md)%E3%80%82%0A-%20%60this.logger%60%EF%BC%9Alogger%20%E5%AF%B9%E8%B1%A1%EF%BC%8C%E4%B8%8A%E9%9D%A2%E6%9C%89%E5%9B%9B%E4%B8%AA%E6%96%B9%E6%B3%95%EF%BC%88%60debug%60%EF%BC%8C%60info%60%EF%BC%8C%60warn%60%EF%BC%8C%60error%60%EF%BC%89%EF%BC%8C%E5%88%86%E5%88%AB%E4%BB%A3%E8%A1%A8%E6%89%93%E5%8D%B0%E5%9B%9B%E4%B8%AA%E4%B8%8D%E5%90%8C%E7%BA%A7%E5%88%AB%E7%9A%84%E6%97%A5%E5%BF%97%EF%BC%8C%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%E5%92%8C%E6%95%88%E6%9E%9C%E4%B8%8E%20%5Bcontext%20logger%5D(..%2Fcore%2Flogger.md%23context-logger)%20%E4%B8%AD%E4%BB%8B%E7%BB%8D%E7%9A%84%E4%B8%80%E6%A0%B7%EF%BC%8C%E4%BD%86%E6%98%AF%E9%80%9A%E8%BF%87%E8%BF%99%E4%B8%AA%20logger%20%E5%AF%B9%E8%B1%A1%E8%AE%B0%E5%BD%95%E7%9A%84%E6%97%A5%E5%BF%97%EF%BC%8C%E5%9C%A8%E6%97%A5%E5%BF%97%E5%89%8D%E9%9D%A2%E4%BC%9A%E5%8A%A0%E4%B8%8A%E6%89%93%E5%8D%B0%E8%AF%A5%E6%97%A5%E5%BF%97%E7%9A%84%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%EF%BC%8C%E4%BB%A5%E4%BE%BF%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8D%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E4%BD%8D%E7%BD%AE%E3%80%82%0A%0A%23%23%23%23%20%E8%87%AA%E5%AE%9A%E4%B9%89%20Controller%20%E5%9F%BA%E7%B1%BB%0A%0A%E6%8C%89%E7%85%A7%E7%B1%BB%E7%9A%84%E6%96%B9%E5%BC%8F%E7%BC%96%E5%86%99%20Controller%EF%BC%8C%E4%B8%8D%E4%BB%85%E5%8F%AF%E4%BB%A5%E8%AE%A9%E6%88%91%E4%BB%AC%E6%9B%B4%E5%A5%BD%E7%9A%84%E5%AF%B9%20Controller%20%E5%B1%82%E4%BB%A3%E7%A0%81%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1%EF%BC%88%E4%BE%8B%E5%A6%82%E5%B0%86%E4%B8%80%E4%BA%9B%E7%BB%9F%E4%B8%80%E7%9A%84%E5%A4%84%E7%90%86%E6%8A%BD%E8%B1%A1%E6%88%90%E4%B8%80%E4%BA%9B%E7%A7%81%E6%9C%89%E6%96%B9%E6%B3%95%EF%BC%89%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E8%87%AA%E5%AE%9A%E4%B9%89%20Controller%20%E5%9F%BA%E7%B1%BB%E7%9A%84%E6%96%B9%E5%BC%8F%E5%B0%81%E8%A3%85%E5%BA%94%E7%94%A8%E4%B8%AD%E5%B8%B8%E7%94%A8%E7%9A%84%E6%96%B9%E6%B3%95%E3%80%82%0A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcore%2Fbase_controller.js%0Aconst%20%7B%20Controller%20%7D%20%3D%20require('egg')%3B%0Aclass%20BaseController%20extends%20Controller%20%7B%0A%20%20get%20user()%20%7B%0A%20%20%20%20return%20this.ctx.session.user%3B%0A%20%20%7D%0A%0A%20%20success(data)%20%7B%0A%20%20%20%20this.ctx.body%20%3D%20%7B%0A%20%20%20%20%20%20success%3A%20true%2C%0A%20%20%20%20%20%20data%2C%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20notFound(msg)%20%7B%0A%20%20%20%20msg%20%3D%20msg%20%7C%7C%20'not%20found'%3B%0A%20%20%20%20this.ctx.throw(404%2C%20msg)%3B%0A%20%20%7D%0A%7D%0Amodule.exports%20%3D%20BaseController%3B%0A%60%60%60%0A%0A%E6%AD%A4%E6%97%B6%E5%9C%A8%E7%BC%96%E5%86%99%E5%BA%94%E7%94%A8%E7%9A%84%20Controller%20%E6%97%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%BB%A7%E6%89%BF%20BaseController%EF%BC%8C%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%B1%BB%E4%B8%8A%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2Fapp%2Fcontroller%2Fpost.js%0Aconst%20Controller%20%3D%20require('..%2Fcore%2Fbase_controller')%3B%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20list()%20%7B%0A%20%20%20%20const%20posts%20%3D%20await%20this.service.listByUser(this.user)%3B%0A%20%20%20%20this.success(posts)%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%20Controller%20%E6%96%B9%E6%B3%95%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8%EF%BC%8C%E5%8F%AA%E6%98%AF%E4%B8%BA%E4%BA%86%E5%85%BC%E5%AE%B9%EF%BC%89%0A%0A%E6%AF%8F%E4%B8%80%E4%B8%AA%20Controller%20%E9%83%BD%E6%98%AF%E4%B8%80%E4%B8%AA%20async%20function%EF%BC%8C%E5%AE%83%E7%9A%84%E5%85%A5%E5%8F%82%E4%B8%BA%E8%AF%B7%E6%B1%82%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%20%5BContext%5D(.%2Fextend.md%23context)%20%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AE%9E%E4%BE%8B%EF%BC%8C%E9%80%9A%E8%BF%87%E5%AE%83%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%8B%BF%E5%88%B0%E6%A1%86%E6%9E%B6%E5%B0%81%E8%A3%85%E5%A5%BD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BE%BF%E6%8D%B7%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%E6%88%91%E4%BB%AC%E5%86%99%E4%B8%80%E4%B8%AA%E5%AF%B9%E5%BA%94%E5%88%B0%20%60POST%20%2Fapi%2Fposts%60%20%E6%8E%A5%E5%8F%A3%E7%9A%84%20Controller%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BC%9A%E5%9C%A8%20%60app%2Fcontroller%60%20%E7%9B%AE%E5%BD%95%E4%B8%8B%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20%60post.js%60%20%E6%96%87%E4%BB%B6%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fpost.js%0Aexports.create%20%3D%20async%20ctx%20%3D%3E%20%7B%0A%20%20const%20createRule%20%3D%20%7B%0A%20%20%20%20title%3A%20%7B%20type%3A%20'string'%20%7D%2C%0A%20%20%20%20content%3A%20%7B%20type%3A%20'string'%20%7D%2C%0A%20%20%7D%3B%0A%20%20%2F%2F%20%E6%A0%A1%E9%AA%8C%E5%8F%82%E6%95%B0%0A%20%20ctx.validate(createRule)%3B%0A%20%20%2F%2F%20%E7%BB%84%E8%A3%85%E5%8F%82%E6%95%B0%0A%20%20const%20author%20%3D%20ctx.session.userId%3B%0A%20%20const%20req%20%3D%20Object.assign(ctx.request.body%2C%20%7B%20author%20%7D)%3B%0A%20%20%2F%2F%20%E8%B0%83%E7%94%A8%20service%20%E8%BF%9B%E8%A1%8C%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86%0A%20%20const%20res%20%3D%20await%20ctx.service.post.create(req)%3B%0A%20%20%2F%2F%20%E8%AE%BE%E7%BD%AE%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9%E5%92%8C%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81%0A%20%20ctx.body%20%3D%20%7B%20id%3A%20res.id%20%7D%3B%0A%20%20ctx.status%20%3D%20201%3B%0A%7D%3B%0A%60%60%60%0A%0A%E5%9C%A8%E4%B8%8A%E9%9D%A2%E7%9A%84%E4%BE%8B%E5%AD%90%E4%B8%AD%E6%88%91%E4%BB%AC%E5%BC%95%E5%85%A5%E4%BA%86%E8%AE%B8%E5%A4%9A%E6%96%B0%E7%9A%84%E6%A6%82%E5%BF%B5%EF%BC%8C%E4%BD%86%E8%BF%98%E6%98%AF%E6%AF%94%E8%BE%83%E7%9B%B4%E8%A7%82%EF%BC%8C%E5%AE%B9%E6%98%93%E7%90%86%E8%A7%A3%E7%9A%84%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BC%9A%E5%9C%A8%E4%B8%8B%E9%9D%A2%E5%AF%B9%E5%AE%83%E4%BB%AC%E8%BF%9B%E8%A1%8C%E6%9B%B4%E8%AF%A6%E7%BB%86%E7%9A%84%E4%BB%8B%E7%BB%8D%E3%80%82%0A%0A%23%23%20HTTP%20%E5%9F%BA%E7%A1%80%0A%0A%E7%94%B1%E4%BA%8E%20Controller%20%E5%9F%BA%E6%9C%AC%E4%B8%8A%E6%98%AF%E4%B8%9A%E5%8A%A1%E5%BC%80%E5%8F%91%E4%B8%AD%E5%94%AF%E4%B8%80%E5%92%8C%20HTTP%20%E5%8D%8F%E8%AE%AE%E6%89%93%E4%BA%A4%E9%81%93%E7%9A%84%E5%9C%B0%E6%96%B9%EF%BC%8C%E5%9C%A8%E7%BB%A7%E7%BB%AD%E5%BE%80%E4%B8%8B%E4%BA%86%E8%A7%A3%E4%B9%8B%E5%89%8D%EF%BC%8C%E6%88%91%E4%BB%AC%E9%A6%96%E5%85%88%E7%AE%80%E5%8D%95%E7%9A%84%E7%9C%8B%E4%B8%80%E4%B8%8B%20HTTP%20%E5%8D%8F%E8%AE%AE%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84%E3%80%82%0A%0A%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E5%8F%91%E8%B5%B7%E4%B8%80%E4%B8%AA%20HTTP%20%E8%AF%B7%E6%B1%82%E6%9D%A5%E8%AE%BF%E9%97%AE%E5%89%8D%E9%9D%A2%E4%BE%8B%E5%AD%90%E4%B8%AD%E6%8F%90%E5%88%B0%E7%9A%84%20Controller%EF%BC%9A%0A%0A%60%60%60%0Acurl%20-X%20POST%20http%3A%2F%2Flocalhost%3A3000%2Fapi%2Fposts%20--data%20'%7B%22title%22%3A%22controller%22%2C%20%22content%22%3A%20%22what%20is%20controller%22%7D'%20--header%20'Content-Type%3Aapplication%2Fjson%3B%20charset%3DUTF-8'%0A%60%60%60%0A%0A%E9%80%9A%E8%BF%87%20curl%20%E5%8F%91%E5%87%BA%E7%9A%84%20HTTP%20%E8%AF%B7%E6%B1%82%E7%9A%84%E5%86%85%E5%AE%B9%E5%B0%B1%E4%BC%9A%E6%98%AF%E4%B8%8B%E9%9D%A2%E8%BF%99%E6%A0%B7%E7%9A%84%EF%BC%9A%0A%0A%60%60%60%0APOST%20%2Fapi%2Fposts%20HTTP%2F1.1%0AHost%3A%20localhost%3A3000%0AContent-Type%3A%20application%2Fjson%3B%20charset%3DUTF-8%0A%0A%7B%22title%22%3A%20%22controller%22%2C%20%22content%22%3A%20%22what%20is%20controller%22%7D%0A%60%60%60%0A%0A%E8%AF%B7%E6%B1%82%E7%9A%84%E7%AC%AC%E4%B8%80%E8%A1%8C%E5%8C%85%E5%90%AB%E4%BA%86%E4%B8%89%E4%B8%AA%E4%BF%A1%E6%81%AF%EF%BC%8C%E6%88%91%E4%BB%AC%E6%AF%94%E8%BE%83%E5%B8%B8%E7%94%A8%E7%9A%84%E6%98%AF%E5%89%8D%E9%9D%A2%E4%B8%A4%E4%B8%AA%EF%BC%9A%0A%0A-%20method%EF%BC%9A%E8%BF%99%E4%B8%AA%E8%AF%B7%E6%B1%82%E4%B8%AD%20method%20%E7%9A%84%E5%80%BC%E6%98%AF%20%60POST%60%E3%80%82%0A-%20path%EF%BC%9A%E5%80%BC%E4%B8%BA%20%60%2Fapi%2Fposts%60%EF%BC%8C%E5%A6%82%E6%9E%9C%E7%94%A8%E6%88%B7%E7%9A%84%E8%AF%B7%E6%B1%82%E4%B8%AD%E5%8C%85%E5%90%AB%20query%EF%BC%8C%E4%B9%9F%E4%BC%9A%E5%9C%A8%E8%BF%99%E9%87%8C%E5%87%BA%E7%8E%B0%0A%0A%E4%BB%8E%E7%AC%AC%E4%BA%8C%E8%A1%8C%E5%BC%80%E5%A7%8B%E7%9B%B4%E5%88%B0%E9%81%87%E5%88%B0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%A9%BA%E8%A1%8C%E4%BD%8D%E7%BD%AE%EF%BC%8C%E9%83%BD%E6%98%AF%E8%AF%B7%E6%B1%82%E7%9A%84%20Headers%20%E9%83%A8%E5%88%86%EF%BC%8C%E8%BF%99%E4%B8%80%E9%83%A8%E5%88%86%E4%B8%AD%E6%9C%89%E8%AE%B8%E5%A4%9A%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B1%9E%E6%80%A7%EF%BC%8C%E5%8C%85%E6%8B%AC%E8%BF%99%E9%87%8C%E7%9C%8B%E5%88%B0%E7%9A%84%20Host%EF%BC%8CContent-Type%EF%BC%8C%E8%BF%98%E6%9C%89%20%60Cookie%60%EF%BC%8C%60User-Agent%60%20%E7%AD%89%E7%AD%89%E3%80%82%E5%9C%A8%E8%BF%99%E4%B8%AA%E8%AF%B7%E6%B1%82%E4%B8%AD%E6%9C%89%E4%B8%A4%E4%B8%AA%E5%A4%B4%EF%BC%9A%0A%0A-%20%60Host%60%EF%BC%9A%E6%88%91%E4%BB%AC%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%9F%9F%E5%90%8D%E4%BC%9A%E7%94%A8%E6%9D%A5%E9%80%9A%E8%BF%87%20DNS%20%E8%A7%A3%E6%9E%90%E6%89%BE%E5%88%B0%E6%9C%8D%E5%8A%A1%E7%9A%84%20IP%20%E5%9C%B0%E5%9D%80%EF%BC%8C%E4%BD%86%E6%98%AF%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B9%9F%E4%BC%9A%E5%B0%86%E5%9F%9F%E5%90%8D%E5%92%8C%E7%AB%AF%E5%8F%A3%E5%8F%B7%E6%94%BE%E5%9C%A8%20Host%20%E5%A4%B4%E4%B8%AD%E4%B8%80%E5%B9%B6%E5%8F%91%E9%80%81%E7%BB%99%E6%9C%8D%E5%8A%A1%E7%AB%AF%E3%80%82%0A-%20%60Content-Type%60%EF%BC%9A%E5%BD%93%E6%88%91%E4%BB%AC%E7%9A%84%E8%AF%B7%E6%B1%82%E6%9C%89%20body%20%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E9%83%BD%E4%BC%9A%E6%9C%89%20Content-Type%20%E6%9D%A5%E6%A0%87%E6%98%8E%E6%88%91%E4%BB%AC%E7%9A%84%E8%AF%B7%E6%B1%82%E4%BD%93%E6%98%AF%E4%BB%80%E4%B9%88%E6%A0%BC%E5%BC%8F%E7%9A%84%E3%80%82%0A%0A%E4%B9%8B%E5%90%8E%E7%9A%84%E5%86%85%E5%AE%B9%E5%85%A8%E9%83%A8%E9%83%BD%E6%98%AF%E8%AF%B7%E6%B1%82%E7%9A%84%20body%EF%BC%8C%E5%BD%93%E8%AF%B7%E6%B1%82%E6%98%AF%20POST%2C%20PUT%2C%20DELETE%20%E7%AD%89%E6%96%B9%E6%B3%95%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%B8%A6%E4%B8%8A%E8%AF%B7%E6%B1%82%E4%BD%93%EF%BC%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BC%9A%E6%A0%B9%E6%8D%AE%20Content-Type%20%E6%9D%A5%E8%A7%A3%E6%9E%90%E8%AF%B7%E6%B1%82%E4%BD%93%E3%80%82%0A%0A%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A4%84%E7%90%86%E5%AE%8C%E8%BF%99%E4%B8%AA%E8%AF%B7%E6%B1%82%E5%90%8E%EF%BC%8C%E4%BC%9A%E5%8F%91%E9%80%81%E4%B8%80%E4%B8%AA%20HTTP%20%E5%93%8D%E5%BA%94%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF%0A%0A%60%60%60%0AHTTP%2F1.1%20201%20Created%0AContent-Type%3A%20application%2Fjson%3B%20charset%3Dutf-8%0AContent-Length%3A%208%0ADate%3A%20Mon%2C%2009%20Jan%202017%2008%3A40%3A28%20GMT%0AConnection%3A%20keep-alive%0A%0A%7B%22id%22%3A%201%7D%0A%60%60%60%0A%0A%E7%AC%AC%E4%B8%80%E8%A1%8C%E4%B8%AD%E4%B9%9F%E5%8C%85%E5%90%AB%E4%BA%86%E4%B8%89%E6%AE%B5%EF%BC%8C%E5%85%B6%E4%B8%AD%E6%88%91%E4%BB%AC%E5%B8%B8%E7%94%A8%E7%9A%84%E4%B8%BB%E8%A6%81%E6%98%AF%5B%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81%5D(https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FList_of_HTTP_status_codes)%EF%BC%8C%E8%BF%99%E4%B8%AA%E4%BE%8B%E5%AD%90%E4%B8%AD%E5%AE%83%E7%9A%84%E5%80%BC%E6%98%AF%20201%EF%BC%8C%E5%AE%83%E7%9A%84%E5%90%AB%E4%B9%89%E6%98%AF%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%88%90%E5%8A%9F%E5%88%9B%E5%BB%BA%E4%BA%86%E4%B8%80%E6%9D%A1%E8%B5%84%E6%BA%90%E3%80%82%0A%0A%E5%92%8C%E8%AF%B7%E6%B1%82%E4%B8%80%E6%A0%B7%EF%BC%8C%E4%BB%8E%E7%AC%AC%E4%BA%8C%E8%A1%8C%E5%BC%80%E5%A7%8B%E5%88%B0%E4%B8%8B%E4%B8%80%E4%B8%AA%E7%A9%BA%E8%A1%8C%E4%B9%8B%E9%97%B4%E9%83%BD%E6%98%AF%E5%93%8D%E5%BA%94%E5%A4%B4%EF%BC%8C%E8%BF%99%E9%87%8C%E7%9A%84%20Content-Type%2C%20Content-Length%20%E8%A1%A8%E7%A4%BA%E8%BF%99%E4%B8%AA%E5%93%8D%E5%BA%94%E7%9A%84%E6%A0%BC%E5%BC%8F%E6%98%AF%20JSON%EF%BC%8C%E9%95%BF%E5%BA%A6%E4%B8%BA%208%20%E4%B8%AA%E5%AD%97%E8%8A%82%E3%80%82%0A%0A%E6%9C%80%E5%90%8E%E5%89%A9%E4%B8%8B%E7%9A%84%E9%83%A8%E5%88%86%E5%B0%B1%E6%98%AF%E8%BF%99%E6%AC%A1%E5%93%8D%E5%BA%94%E7%9C%9F%E6%AD%A3%E7%9A%84%E5%86%85%E5%AE%B9%E3%80%82%0A%0A%23%23%20%E8%8E%B7%E5%8F%96%20HTTP%20%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%0A%0A%E4%BB%8E%E4%B8%8A%E9%9D%A2%E7%9A%84%20HTTP%20%E8%AF%B7%E6%B1%82%E7%A4%BA%E4%BE%8B%E4%B8%AD%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E6%9C%89%E5%A5%BD%E5%A4%9A%E5%9C%B0%E6%96%B9%E5%8F%AF%E4%BB%A5%E6%94%BE%E7%94%A8%E6%88%B7%E7%9A%84%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%A1%86%E6%9E%B6%E9%80%9A%E8%BF%87%E5%9C%A8%20Controller%20%E4%B8%8A%E7%BB%91%E5%AE%9A%E7%9A%84%20Context%20%E5%AE%9E%E4%BE%8B%EF%BC%8C%E6%8F%90%E4%BE%9B%E4%BA%86%E8%AE%B8%E5%A4%9A%E4%BE%BF%E6%8D%B7%E6%96%B9%E6%B3%95%E5%92%8C%E5%B1%9E%E6%80%A7%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E9%80%9A%E8%BF%87%20HTTP%20%E8%AF%B7%E6%B1%82%E5%8F%91%E9%80%81%E8%BF%87%E6%9D%A5%E7%9A%84%E5%8F%82%E6%95%B0%E3%80%82%0A%0A%23%23%23%20query%0A%0A%E5%9C%A8%20URL%20%E4%B8%AD%20%60%3F%60%20%E5%90%8E%E9%9D%A2%E7%9A%84%E9%83%A8%E5%88%86%E6%98%AF%E4%B8%80%E4%B8%AA%20Query%20String%EF%BC%8C%E8%BF%99%E4%B8%80%E9%83%A8%E5%88%86%E7%BB%8F%E5%B8%B8%E7%94%A8%E4%BA%8E%20GET%20%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%AF%B7%E6%B1%82%E4%B8%AD%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0%E3%80%82%E4%BE%8B%E5%A6%82%20%60GET%20%2Fposts%3Fcategory%3Degg%26language%3Dnode%60%20%E4%B8%AD%20%60category%3Degg%26language%3Dnode%60%20%E5%B0%B1%E6%98%AF%E7%94%A8%E6%88%B7%E4%BC%A0%E9%80%92%E8%BF%87%E6%9D%A5%E7%9A%84%E5%8F%82%E6%95%B0%E3%80%82%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60ctx.query%60%20%E6%8B%BF%E5%88%B0%E8%A7%A3%E6%9E%90%E8%BF%87%E5%90%8E%E7%9A%84%E8%BF%99%E4%B8%AA%E5%8F%82%E6%95%B0%E4%BD%93%0A%0A%60%60%60js%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20listPosts()%20%7B%0A%20%20%20%20const%20query%20%3D%20this.ctx.query%3B%0A%20%20%20%20%2F%2F%20%7B%0A%20%20%20%20%2F%2F%20%20%20category%3A%20'egg'%2C%0A%20%20%20%20%2F%2F%20%20%20language%3A%20'node'%2C%0A%20%20%20%20%2F%2F%20%7D%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E5%BD%93%20Query%20String%20%E4%B8%AD%E7%9A%84%20key%20%E9%87%8D%E5%A4%8D%E6%97%B6%EF%BC%8C%60ctx.query%60%20%E5%8F%AA%E5%8F%96%20key%20%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%87%BA%E7%8E%B0%E6%97%B6%E7%9A%84%E5%80%BC%EF%BC%8C%E5%90%8E%E9%9D%A2%E5%86%8D%E5%87%BA%E7%8E%B0%E7%9A%84%E9%83%BD%E4%BC%9A%E8%A2%AB%E5%BF%BD%E7%95%A5%E3%80%82%60GET%20%2Fposts%3Fcategory%3Degg%26category%3Dkoa%60%20%E9%80%9A%E8%BF%87%20%60ctx.query%60%20%E6%8B%BF%E5%88%B0%E7%9A%84%E5%80%BC%E6%98%AF%20%60%7B%20category%3A%20'egg'%20%7D%60%E3%80%82%0A%0A%E8%BF%99%E6%A0%B7%E5%A4%84%E7%90%86%E7%9A%84%E5%8E%9F%E5%9B%A0%E6%98%AF%E4%B8%BA%E4%BA%86%E4%BF%9D%E6%8C%81%E7%BB%9F%E4%B8%80%E6%80%A7%EF%BC%8C%E7%94%B1%E4%BA%8E%E9%80%9A%E5%B8%B8%E6%83%85%E5%86%B5%E4%B8%8B%E6%88%91%E4%BB%AC%E9%83%BD%E4%B8%8D%E4%BC%9A%E8%AE%BE%E8%AE%A1%E8%AE%A9%E7%94%A8%E6%88%B7%E4%BC%A0%E9%80%92%20key%20%E7%9B%B8%E5%90%8C%E7%9A%84%20Query%20String%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E7%BB%8F%E5%B8%B8%E4%BC%9A%E5%86%99%E7%B1%BB%E4%BC%BC%E4%B8%8B%E9%9D%A2%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%9A%0A%0A%60%60%60js%0Aconst%20key%20%3D%20ctx.query.key%20%7C%7C%20''%3B%0Aif%20(key.startsWith('egg'))%20%7B%0A%20%20%2F%2F%20do%20something%0A%7D%0A%60%60%60%0A%0A%E8%80%8C%E5%A6%82%E6%9E%9C%E6%9C%89%E4%BA%BA%E6%95%85%E6%84%8F%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82%E5%9C%A8%20Query%20String%20%E4%B8%AD%E5%B8%A6%E4%B8%8A%E9%87%8D%E5%A4%8D%E7%9A%84%20key%20%E6%9D%A5%E8%AF%B7%E6%B1%82%E6%97%B6%E5%B0%B1%E4%BC%9A%E5%BC%95%E5%8F%91%E7%B3%BB%E7%BB%9F%E5%BC%82%E5%B8%B8%E3%80%82%E5%9B%A0%E6%AD%A4%E6%A1%86%E6%9E%B6%E4%BF%9D%E8%AF%81%E4%BA%86%E4%BB%8E%20%60ctx.query%60%20%E4%B8%8A%E8%8E%B7%E5%8F%96%E7%9A%84%E5%8F%82%E6%95%B0%E4%B8%80%E6%97%A6%E5%AD%98%E5%9C%A8%EF%BC%8C%E4%B8%80%E5%AE%9A%E6%98%AF%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B%E3%80%82%0A%0A%23%23%23%23%20queries%0A%0A%E6%9C%89%E6%97%B6%E5%80%99%E6%88%91%E4%BB%AC%E7%9A%84%E7%B3%BB%E7%BB%9F%E4%BC%9A%E8%AE%BE%E8%AE%A1%E6%88%90%E8%AE%A9%E7%94%A8%E6%88%B7%E4%BC%A0%E9%80%92%E7%9B%B8%E5%90%8C%E7%9A%84%20key%EF%BC%8C%E4%BE%8B%E5%A6%82%20%60GET%20%2Fposts%3Fcategory%3Degg%26id%3D1%26id%3D2%26id%3D3%60%E3%80%82%E9%92%88%E5%AF%B9%E6%AD%A4%E7%B1%BB%E6%83%85%E5%86%B5%EF%BC%8C%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E4%BA%86%20%60ctx.queries%60%20%E5%AF%B9%E8%B1%A1%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%AF%B9%E8%B1%A1%E4%B9%9F%E8%A7%A3%E6%9E%90%E4%BA%86%20Query%20String%EF%BC%8C%E4%BD%86%E6%98%AF%E5%AE%83%E4%B8%8D%E4%BC%9A%E4%B8%A2%E5%BC%83%E4%BB%BB%E4%BD%95%E4%B8%80%E4%B8%AA%E9%87%8D%E5%A4%8D%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E8%80%8C%E6%98%AF%E5%B0%86%E4%BB%96%E4%BB%AC%E9%83%BD%E6%94%BE%E5%88%B0%E4%B8%80%E4%B8%AA%E6%95%B0%E7%BB%84%E4%B8%AD%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20GET%20%2Fposts%3Fcategory%3Degg%26id%3D1%26id%3D2%26id%3D3%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20listPosts()%20%7B%0A%20%20%20%20console.log(this.ctx.queries)%3B%0A%20%20%20%20%2F%2F%20%7B%0A%20%20%20%20%2F%2F%20%20%20category%3A%20%5B%20'egg'%20%5D%2C%0A%20%20%20%20%2F%2F%20%20%20id%3A%20%5B%20'1'%2C%20'2'%2C%20'3'%20%5D%2C%0A%20%20%20%20%2F%2F%20%7D%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%60ctx.queries%60%20%E4%B8%8A%E6%89%80%E6%9C%89%E7%9A%84%20key%20%E5%A6%82%E6%9E%9C%E6%9C%89%E5%80%BC%EF%BC%8C%E4%B9%9F%E4%B8%80%E5%AE%9A%E4%BC%9A%E6%98%AF%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B%E3%80%82%0A%0A%23%23%23%20Router%20params%0A%0A%E5%9C%A8%20%5BRouter%5D(.%2Frouter.md)%20%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BB%8B%E7%BB%8D%E4%BA%86%20Router%20%E4%B8%8A%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%94%B3%E6%98%8E%E5%8F%82%E6%95%B0%EF%BC%8C%E8%BF%99%E4%BA%9B%E5%8F%82%E6%95%B0%E9%83%BD%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60ctx.params%60%20%E8%8E%B7%E5%8F%96%E5%88%B0%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app.get('%2Fprojects%2F%3AprojectId%2Fapp%2F%3AappId'%2C%20'app.listApp')%3B%0A%2F%2F%20GET%20%2Fprojects%2F1%2Fapp%2F2%0Aclass%20AppController%20extends%20Controller%20%7B%0A%20%20async%20listApp()%20%7B%0A%20%20%20%20assert.equal(this.ctx.params.projectId%2C%20'1')%3B%0A%20%20%20%20assert.equal(this.ctx.params.appId%2C%20'2')%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%20body%0A%0A%E8%99%BD%E7%84%B6%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20URL%20%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0%EF%BC%8C%E4%BD%86%E6%98%AF%E8%BF%98%E6%98%AF%E6%9C%89%E8%AF%B8%E5%A4%9A%E9%99%90%E5%88%B6%EF%BC%9A%0A%0A-%20%5B%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BC%9A%E5%AF%B9%20URL%20%E7%9A%84%E9%95%BF%E5%BA%A6%E6%9C%89%E6%89%80%E9%99%90%E5%88%B6%5D(http%3A%2F%2Fstackoverflow.com%2Fquestions%2F417142%2Fwhat-is-the-maximum-length-of-a-url-in-different-browsers)%EF%BC%8C%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E4%BC%A0%E9%80%92%E7%9A%84%E5%8F%82%E6%95%B0%E8%BF%87%E5%A4%9A%E5%B0%B1%E4%BC%9A%E6%97%A0%E6%B3%95%E4%BC%A0%E9%80%92%E3%80%82%0A-%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%BB%8F%E5%B8%B8%E4%BC%9A%E5%B0%86%E8%AE%BF%E9%97%AE%E7%9A%84%E5%AE%8C%E6%95%B4%20URL%20%E8%AE%B0%E5%BD%95%E5%88%B0%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E4%B8%AD%EF%BC%8C%E6%9C%89%E4%B8%80%E4%BA%9B%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E9%80%9A%E8%BF%87%20URL%20%E4%BC%A0%E9%80%92%E4%BC%9A%E4%B8%8D%E5%AE%89%E5%85%A8%E3%80%82%0A%0A%E5%9C%A8%E5%89%8D%E9%9D%A2%E7%9A%84%20HTTP%20%E8%AF%B7%E6%B1%82%E6%8A%A5%E6%96%87%E7%A4%BA%E4%BE%8B%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9C%8B%E5%88%B0%E5%9C%A8%20header%20%E4%B9%8B%E5%90%8E%E8%BF%98%E6%9C%89%E4%B8%80%E4%B8%AA%20body%20%E9%83%A8%E5%88%86%EF%BC%8C%E6%88%91%E4%BB%AC%E9%80%9A%E5%B8%B8%E4%BC%9A%E5%9C%A8%E8%BF%99%E4%B8%AA%E9%83%A8%E5%88%86%E4%BC%A0%E9%80%92%20POST%E3%80%81PUT%20%E5%92%8C%20DELETE%20%E7%AD%89%E6%96%B9%E6%B3%95%E7%9A%84%E5%8F%82%E6%95%B0%E3%80%82%E4%B8%80%E8%88%AC%E8%AF%B7%E6%B1%82%E4%B8%AD%E6%9C%89%20body%20%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%88%E6%B5%8F%E8%A7%88%E5%99%A8%EF%BC%89%E4%BC%9A%E5%90%8C%E6%97%B6%E5%8F%91%E9%80%81%20%60Content-Type%60%20%E5%91%8A%E8%AF%89%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%BF%99%E6%AC%A1%E8%AF%B7%E6%B1%82%E7%9A%84%20body%20%E6%98%AF%E4%BB%80%E4%B9%88%E6%A0%BC%E5%BC%8F%E7%9A%84%E3%80%82Web%20%E5%BC%80%E5%8F%91%E4%B8%AD%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92%E6%9C%80%E5%B8%B8%E7%94%A8%E7%9A%84%E4%B8%A4%E7%B1%BB%E6%A0%BC%E5%BC%8F%E5%88%86%E5%88%AB%E6%98%AF%20JSON%20%E5%92%8C%20Form%E3%80%82%0A%0A%E6%A1%86%E6%9E%B6%E5%86%85%E7%BD%AE%E4%BA%86%20%5BbodyParser%5D(https%3A%2F%2Fgithub.com%2Fkoajs%2Fbodyparser)%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%9D%A5%E5%AF%B9%E8%BF%99%E4%B8%A4%E7%B1%BB%E6%A0%BC%E5%BC%8F%E7%9A%84%E8%AF%B7%E6%B1%82%20body%20%E8%A7%A3%E6%9E%90%E6%88%90%20object%20%E6%8C%82%E8%BD%BD%E5%88%B0%20%60ctx.request.body%60%20%E4%B8%8A%E3%80%82HTTP%20%E5%8D%8F%E8%AE%AE%E4%B8%AD%E5%B9%B6%E4%B8%8D%E5%BB%BA%E8%AE%AE%E5%9C%A8%E9%80%9A%E8%BF%87%20GET%E3%80%81HEAD%20%E6%96%B9%E6%B3%95%E8%AE%BF%E9%97%AE%E6%97%B6%E4%BC%A0%E9%80%92%20body%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E6%97%A0%E6%B3%95%E5%9C%A8%20GET%E3%80%81HEAD%20%E6%96%B9%E6%B3%95%E4%B8%AD%E6%8C%89%E7%85%A7%E6%AD%A4%E6%96%B9%E6%B3%95%E8%8E%B7%E5%8F%96%E5%88%B0%E5%86%85%E5%AE%B9%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20POST%20%2Fapi%2Fposts%20HTTP%2F1.1%0A%2F%2F%20Host%3A%20localhost%3A3000%0A%2F%2F%20Content-Type%3A%20application%2Fjson%3B%20charset%3DUTF-8%0A%2F%2F%0A%2F%2F%20%7B%22title%22%3A%20%22controller%22%2C%20%22content%22%3A%20%22what%20is%20controller%22%7D%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20listPosts()%20%7B%0A%20%20%20%20assert.equal(this.ctx.request.body.title%2C%20'controller')%3B%0A%20%20%20%20assert.equal(this.ctx.request.body.content%2C%20'what%20is%20controller')%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E6%A1%86%E6%9E%B6%E5%AF%B9%20bodyParser%20%E8%AE%BE%E7%BD%AE%E4%BA%86%E4%B8%80%E4%BA%9B%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0%EF%BC%8C%E9%85%8D%E7%BD%AE%E5%A5%BD%E4%B9%8B%E5%90%8E%E6%8B%A5%E6%9C%89%E4%BB%A5%E4%B8%8B%E7%89%B9%E6%80%A7%EF%BC%9A%0A%0A-%20%E5%BD%93%E8%AF%B7%E6%B1%82%E7%9A%84%20Content-Type%20%E4%B8%BA%20%60application%2Fjson%60%EF%BC%8C%60application%2Fjson-patch%2Bjson%60%EF%BC%8C%60application%2Fvnd.api%2Bjson%60%20%E5%92%8C%20%60application%2Fcsp-report%60%20%E6%97%B6%EF%BC%8C%E4%BC%9A%E6%8C%89%E7%85%A7%20json%20%E6%A0%BC%E5%BC%8F%E5%AF%B9%E8%AF%B7%E6%B1%82%20body%20%E8%BF%9B%E8%A1%8C%E8%A7%A3%E6%9E%90%EF%BC%8C%E5%B9%B6%E9%99%90%E5%88%B6%20body%20%E6%9C%80%E5%A4%A7%E9%95%BF%E5%BA%A6%E4%B8%BA%20%60100kb%60%E3%80%82%0A-%20%E5%BD%93%E8%AF%B7%E6%B1%82%E7%9A%84%20Content-Type%20%E4%B8%BA%20%60application%2Fx-www-form-urlencoded%60%20%E6%97%B6%EF%BC%8C%E4%BC%9A%E6%8C%89%E7%85%A7%20form%20%E6%A0%BC%E5%BC%8F%E5%AF%B9%E8%AF%B7%E6%B1%82%20body%20%E8%BF%9B%E8%A1%8C%E8%A7%A3%E6%9E%90%EF%BC%8C%E5%B9%B6%E9%99%90%E5%88%B6%20body%20%E6%9C%80%E5%A4%A7%E9%95%BF%E5%BA%A6%E4%B8%BA%20%60100kb%60%E3%80%82%0A-%20%E5%A6%82%E6%9E%9C%E8%A7%A3%E6%9E%90%E6%88%90%E5%8A%9F%EF%BC%8Cbody%20%E4%B8%80%E5%AE%9A%E4%BC%9A%E6%98%AF%E4%B8%80%E4%B8%AA%20Object%EF%BC%88%E5%8F%AF%E8%83%BD%E6%98%AF%E4%B8%80%E4%B8%AA%E6%95%B0%E7%BB%84%EF%BC%89%E3%80%82%0A%0A%E4%B8%80%E8%88%AC%E6%9D%A5%E8%AF%B4%E6%88%91%E4%BB%AC%E6%9C%80%E7%BB%8F%E5%B8%B8%E8%B0%83%E6%95%B4%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%E5%B0%B1%E6%98%AF%E5%8F%98%E6%9B%B4%E8%A7%A3%E6%9E%90%E6%97%B6%E5%85%81%E8%AE%B8%E7%9A%84%E6%9C%80%E5%A4%A7%E9%95%BF%E5%BA%A6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8%20%60config%2Fconfig.default.js%60%20%E4%B8%AD%E8%A6%86%E7%9B%96%E6%A1%86%E6%9E%B6%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC%E3%80%82%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20bodyParser%3A%20%7B%0A%20%20%20%20jsonLimit%3A%20'1mb'%2C%0A%20%20%20%20formLimit%3A%20'1mb'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%E5%A6%82%E6%9E%9C%E7%94%A8%E6%88%B7%E7%9A%84%E8%AF%B7%E6%B1%82%20body%20%E8%B6%85%E8%BF%87%E4%BA%86%E6%88%91%E4%BB%AC%E9%85%8D%E7%BD%AE%E7%9A%84%E8%A7%A3%E6%9E%90%E6%9C%80%E5%A4%A7%E9%95%BF%E5%BA%A6%EF%BC%8C%E4%BC%9A%E6%8A%9B%E5%87%BA%E4%B8%80%E4%B8%AA%E7%8A%B6%E6%80%81%E7%A0%81%E4%B8%BA%20%60413%60%20%E7%9A%84%E5%BC%82%E5%B8%B8%EF%BC%8C%E5%A6%82%E6%9E%9C%E7%94%A8%E6%88%B7%E8%AF%B7%E6%B1%82%E7%9A%84%20body%20%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%EF%BC%88%E9%94%99%E8%AF%AF%E7%9A%84%20JSON%EF%BC%89%EF%BC%8C%E4%BC%9A%E6%8A%9B%E5%87%BA%E4%B8%80%E4%B8%AA%E7%8A%B6%E6%80%81%E7%A0%81%E4%B8%BA%20%60400%60%20%E7%9A%84%E5%BC%82%E5%B8%B8%E3%80%82%0A%0A**%E6%B3%A8%E6%84%8F%EF%BC%9A%E5%9C%A8%E8%B0%83%E6%95%B4%20bodyParser%20%E6%94%AF%E6%8C%81%E7%9A%84%20body%20%E9%95%BF%E5%BA%A6%E6%97%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E5%BA%94%E7%94%A8%E5%89%8D%E9%9D%A2%E8%BF%98%E6%9C%89%E4%B8%80%E5%B1%82%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%EF%BC%88Nginx%EF%BC%89%EF%BC%8C%E5%8F%AF%E8%83%BD%E4%B9%9F%E9%9C%80%E8%A6%81%E8%B0%83%E6%95%B4%E5%AE%83%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E7%A1%AE%E4%BF%9D%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B9%9F%E6%94%AF%E6%8C%81%E5%90%8C%E6%A0%B7%E9%95%BF%E5%BA%A6%E7%9A%84%E8%AF%B7%E6%B1%82%20body%E3%80%82**%0A%0A**%E4%B8%80%E4%B8%AA%E5%B8%B8%E8%A7%81%E7%9A%84%E9%94%99%E8%AF%AF%E6%98%AF%E6%8A%8A%20%60ctx.request.body%60%20%E5%92%8C%20%60ctx.body%60%20%E6%B7%B7%E6%B7%86%EF%BC%8C%E5%90%8E%E8%80%85%E5%85%B6%E5%AE%9E%E6%98%AF%20%60ctx.response.body%60%20%E7%9A%84%E7%AE%80%E5%86%99%E3%80%82**%0A%0A%23%23%23%20%E8%8E%B7%E5%8F%96%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6%0A%0A%E8%AF%B7%E6%B1%82%20body%20%E9%99%A4%E4%BA%86%E5%8F%AF%E4%BB%A5%E5%B8%A6%E5%8F%82%E6%95%B0%E4%B9%8B%E5%A4%96%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%8F%91%E9%80%81%E6%96%87%E4%BB%B6%EF%BC%8C%E4%B8%80%E8%88%AC%E6%9D%A5%E8%AF%B4%EF%BC%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8A%E9%83%BD%E6%98%AF%E9%80%9A%E8%BF%87%20%60Multipart%2Fform-data%60%20%E6%A0%BC%E5%BC%8F%E5%8F%91%E9%80%81%E6%96%87%E4%BB%B6%E7%9A%84%EF%BC%8C%E6%A1%86%E6%9E%B6%E9%80%9A%E8%BF%87%E5%86%85%E7%BD%AE%20%5BMultipart%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-multipart)%20%E6%8F%92%E4%BB%B6%E6%9D%A5%E6%94%AF%E6%8C%81%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6%E3%80%82%0A%0A%E5%AE%8C%E6%95%B4%E7%9A%84%E4%B8%8A%E4%BC%A0%E7%A4%BA%E4%BE%8B%E5%8F%82%E8%A7%81%EF%BC%9A%5Beggjs%2Fexamples%2Fmultipart%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fexamples%2Ftree%2Fmaster%2Fmultipart)%E3%80%82%0A%0A%E5%9C%A8%20Controller%20%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60ctx.getFileStream()%60%20%E6%8E%A5%E5%8F%A3%E8%83%BD%E8%8E%B7%E5%8F%96%E5%88%B0%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6%E6%B5%81%E3%80%82%0A%0A%60%60%60html%0A%3Cform%20method%3D%22POST%22%20action%3D%22%2Fupload%3F_csrf%3D%7B%7B%20ctx.csrf%20%7C%20safe%20%7D%7D%22%20enctype%3D%22multipart%2Fform-data%22%3E%0A%20%20title%3A%20%3Cinput%20name%3D%22title%22%20%2F%3E%0A%20%20file%3A%20%3Cinput%20name%3D%22file%22%20type%3D%22file%22%20%2F%3E%0A%20%20%3Cbutton%20type%3D%22submit%22%3E%E4%B8%8A%E4%BC%A0%3C%2Fbutton%3E%0A%3C%2Fform%3E%0A%60%60%60%0A%0A%60%60%60js%0Aconst%20path%20%3D%20require('path')%3B%0Aconst%20sendToWormhole%20%3D%20require('stream-wormhole')%3B%0Aconst%20Controller%20%3D%20require('egg').Controller%3B%0A%0Aclass%20UploaderController%20extends%20Controller%20%7B%0A%20%20async%20upload()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20const%20stream%20%3D%20await%20ctx.getFileStream()%3B%0A%20%20%20%20const%20name%20%3D%20'egg-multipart-test%2F'%20%2B%20path.basename(stream.filename)%3B%0A%20%20%20%20%2F%2F%20%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86%EF%BC%8C%E4%B8%8A%E4%BC%A0%E5%88%B0%E4%BA%91%E5%AD%98%E5%82%A8%E7%AD%89%E7%AD%89%0A%20%20%20%20let%20result%3B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20result%20%3D%20await%20ctx.oss.put(name%2C%20stream)%3B%0A%20%20%20%20%7D%20catch%20(err)%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E5%BF%85%E9%A1%BB%E5%B0%86%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6%E6%B5%81%E6%B6%88%E8%B4%B9%E6%8E%89%EF%BC%8C%E8%A6%81%E4%B8%8D%E7%84%B6%E6%B5%8F%E8%A7%88%E5%99%A8%E5%93%8D%E5%BA%94%E4%BC%9A%E5%8D%A1%E6%AD%BB%0A%20%20%20%20%20%20await%20sendToWormhole(stream)%3B%0A%20%20%20%20%20%20throw%20err%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20ctx.body%20%3D%20%7B%0A%20%20%20%20%20%20url%3A%20result.url%2C%0A%20%20%20%20%20%20%2F%2F%20%E6%89%80%E6%9C%89%E8%A1%A8%E5%8D%95%E5%AD%97%E6%AE%B5%E9%83%BD%E8%83%BD%E9%80%9A%E8%BF%87%20%60stream.fields%60%20%E8%8E%B7%E5%8F%96%E5%88%B0%0A%20%20%20%20%20%20fields%3A%20stream.fields%2C%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%7D%0A%0Amodule.exports%20%3D%20UploaderController%3B%0A%60%60%60%0A%0A%E8%A6%81%E9%80%9A%E8%BF%87%20%60ctx.getFileStream%60%20%E4%BE%BF%E6%8D%B7%E7%9A%84%E8%8E%B7%E5%8F%96%E5%88%B0%E7%94%A8%E6%88%B7%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E6%BB%A1%E8%B6%B3%E4%B8%A4%E4%B8%AA%E6%9D%A1%E4%BB%B6%EF%BC%9A%0A%0A-%20%E5%8F%AA%E6%94%AF%E6%8C%81%E4%B8%8A%E4%BC%A0%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E3%80%82%0A-%20%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%BF%85%E9%A1%BB%E5%9C%A8%E6%89%80%E6%9C%89%E5%85%B6%E4%BB%96%E7%9A%84%20fields%20%E5%90%8E%E9%9D%A2%EF%BC%8C%E5%90%A6%E5%88%99%E5%9C%A8%E6%8B%BF%E5%88%B0%E6%96%87%E4%BB%B6%E6%B5%81%E6%97%B6%E5%8F%AF%E8%83%BD%E8%BF%98%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%20fields%E3%80%82%0A%0A%E5%A6%82%E6%9E%9C%E8%A6%81%E8%8E%B7%E5%8F%96%E5%90%8C%E6%97%B6%E4%B8%8A%E4%BC%A0%E7%9A%84%E5%A4%9A%E4%B8%AA%E6%96%87%E4%BB%B6%EF%BC%8C%E4%B8%8D%E8%83%BD%E9%80%9A%E8%BF%87%20%60ctx.getFileStream()%60%20%E6%9D%A5%E8%8E%B7%E5%8F%96%EF%BC%8C%E5%8F%AA%E8%83%BD%E9%80%9A%E8%BF%87%E4%B8%8B%E9%9D%A2%E8%BF%99%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9A%0A%0A%60%60%60js%0Aconst%20sendToWormhole%20%3D%20require('stream-wormhole')%3B%0Aconst%20Controller%20%3D%20require('egg').Controller%3B%0A%0Aclass%20UploaderController%20extends%20Controller%20%7B%0A%20%20async%20upload()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20const%20parts%20%3D%20ctx.multipart()%3B%0A%20%20%20%20let%20part%3B%0A%20%20%20%20%2F%2F%20parts()%20return%20a%20promise%0A%20%20%20%20while%20((part%20%3D%20await%20parts())%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20if%20(part.length)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E6%98%AF%E6%95%B0%E7%BB%84%E7%9A%84%E8%AF%9D%E6%98%AF%20filed%0A%20%20%20%20%20%20%20%20console.log('field%3A%20'%20%2B%20part%5B0%5D)%3B%0A%20%20%20%20%20%20%20%20console.log('value%3A%20'%20%2B%20part%5B1%5D)%3B%0A%20%20%20%20%20%20%20%20console.log('valueTruncated%3A%20'%20%2B%20part%5B2%5D)%3B%0A%20%20%20%20%20%20%20%20console.log('fieldnameTruncated%3A%20'%20%2B%20part%5B3%5D)%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20if%20(!part.filename)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%BF%99%E6%97%B6%E6%98%AF%E7%94%A8%E6%88%B7%E6%B2%A1%E6%9C%89%E9%80%89%E6%8B%A9%E6%96%87%E4%BB%B6%E5%B0%B1%E7%82%B9%E5%87%BB%E4%BA%86%E4%B8%8A%E4%BC%A0(part%20%E6%98%AF%20file%20stream%EF%BC%8C%E4%BD%86%E6%98%AF%20part.filename%20%E4%B8%BA%E7%A9%BA)%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E9%9C%80%E8%A6%81%E5%81%9A%E5%87%BA%E5%A4%84%E7%90%86%EF%BC%8C%E4%BE%8B%E5%A6%82%E7%BB%99%E5%87%BA%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E6%B6%88%E6%81%AF%0A%20%20%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2F%2F%20part%20%E6%98%AF%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6%E6%B5%81%0A%20%20%20%20%20%20%20%20console.log('field%3A%20'%20%2B%20part.fieldname)%3B%0A%20%20%20%20%20%20%20%20console.log('filename%3A%20'%20%2B%20part.filename)%3B%0A%20%20%20%20%20%20%20%20console.log('encoding%3A%20'%20%2B%20part.encoding)%3B%0A%20%20%20%20%20%20%20%20console.log('mime%3A%20'%20%2B%20part.mime)%3B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86%EF%BC%8C%E4%B8%8A%E4%BC%A0%E5%88%B0%E4%BA%91%E5%AD%98%E5%82%A8%E7%AD%89%E7%AD%89%0A%20%20%20%20%20%20%20%20let%20result%3B%0A%20%20%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20%20%20result%20%3D%20await%20ctx.oss.put('egg-multipart-test%2F'%20%2B%20part.filename%2C%20part)%3B%0A%20%20%20%20%20%20%20%20%7D%20catch%20(err)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BF%85%E9%A1%BB%E5%B0%86%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6%E6%B5%81%E6%B6%88%E8%B4%B9%E6%8E%89%EF%BC%8C%E8%A6%81%E4%B8%8D%E7%84%B6%E6%B5%8F%E8%A7%88%E5%99%A8%E5%93%8D%E5%BA%94%E4%BC%9A%E5%8D%A1%E6%AD%BB%0A%20%20%20%20%20%20%20%20%20%20await%20sendToWormhole(part)%3B%0A%20%20%20%20%20%20%20%20%20%20throw%20err%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20console.log(result)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20console.log('and%20we%20are%20done%20parsing%20the%20form!')%3B%0A%20%20%7D%0A%7D%0A%0Amodule.exports%20%3D%20UploaderController%3B%0A%60%60%60%0A%0A%E4%B8%BA%E4%BA%86%E4%BF%9D%E8%AF%81%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E7%9A%84%E5%AE%89%E5%85%A8%EF%BC%8C%E6%A1%86%E6%9E%B6%E9%99%90%E5%88%B6%E4%BA%86%E6%94%AF%E6%8C%81%E7%9A%84%E7%9A%84%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%EF%BC%8C%E6%A1%86%E6%9E%B6%E9%BB%98%E8%AE%A4%E6%94%AF%E6%8C%81%E7%99%BD%E5%90%8D%E5%8D%95%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20images%0A'.jpg'%2C%20'.jpeg'%2C%20%2F%2F%20image%2Fjpeg%0A'.png'%2C%20%2F%2F%20image%2Fpng%2C%20image%2Fx-png%0A'.gif'%2C%20%2F%2F%20image%2Fgif%0A'.bmp'%2C%20%2F%2F%20image%2Fbmp%0A'.wbmp'%2C%20%2F%2F%20image%2Fvnd.wap.wbmp%0A'.webp'%2C%0A'.tif'%2C%0A'.psd'%2C%0A%2F%2F%20text%0A'.svg'%2C%0A'.js'%2C%20'.jsx'%2C%0A'.json'%2C%0A'.css'%2C%20'.less'%2C%0A'.html'%2C%20'.htm'%2C%0A'.xml'%2C%0A%2F%2F%20tar%0A'.zip'%2C%0A'.gz'%2C%20'.tgz'%2C%20'.gzip'%2C%0A%2F%2F%20video%0A'.mp3'%2C%0A'.mp4'%2C%0A'.avi'%2C%0A%60%60%60%0A%0A%E7%94%A8%E6%88%B7%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%9C%A8%20%60config%2Fconfig.default.js%60%20%E4%B8%AD%E9%85%8D%E7%BD%AE%E6%9D%A5%E6%96%B0%E5%A2%9E%E6%94%AF%E6%8C%81%E7%9A%84%E6%96%87%E4%BB%B6%E6%89%A9%E5%B1%95%E5%90%8D%EF%BC%8C%E6%88%96%E8%80%85%E9%87%8D%E5%86%99%E6%95%B4%E4%B8%AA%E7%99%BD%E5%90%8D%E5%8D%95%0A%0A-%20%E6%96%B0%E5%A2%9E%E6%94%AF%E6%8C%81%E7%9A%84%E6%96%87%E4%BB%B6%E6%89%A9%E5%B1%95%E5%90%8D%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20multipart%3A%20%7B%0A%20%20%20%20fileExtensions%3A%20%5B%20'.apk'%20%5D%2C%20%2F%2F%20%E5%A2%9E%E5%8A%A0%E5%AF%B9%20.apk%20%E6%89%A9%E5%B1%95%E5%90%8D%E7%9A%84%E6%94%AF%E6%8C%81%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A-%20%E8%A6%86%E7%9B%96%E6%95%B4%E4%B8%AA%E7%99%BD%E5%90%8D%E5%8D%95%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20multipart%3A%20%7B%0A%20%20%20%20whitelist%3A%20%5B%20'.png'%20%5D%2C%20%2F%2F%20%E8%A6%86%E7%9B%96%E6%95%B4%E4%B8%AA%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%8C%E5%8F%AA%E5%85%81%E8%AE%B8%E4%B8%8A%E4%BC%A0%20'.png'%20%E6%A0%BC%E5%BC%8F%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A**%E6%B3%A8%E6%84%8F%EF%BC%9A%E5%BD%93%E4%BC%A0%E9%80%92%E4%BA%86%20whitelist%20%E5%B1%9E%E6%80%A7%E6%97%B6%EF%BC%8CfileExtensions%20%E5%B1%9E%E6%80%A7%E4%B8%8D%E7%94%9F%E6%95%88%E3%80%82**%0A%0A%23%23%23%20header%0A%0A%E9%99%A4%E4%BA%86%E4%BB%8E%20URL%20%E5%92%8C%E8%AF%B7%E6%B1%82%20body%20%E4%B8%8A%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0%E4%B9%8B%E5%A4%96%EF%BC%8C%E8%BF%98%E6%9C%89%E8%AE%B8%E5%A4%9A%E5%8F%82%E6%95%B0%E6%98%AF%E9%80%9A%E8%BF%87%E8%AF%B7%E6%B1%82%20header%20%E4%BC%A0%E9%80%92%E7%9A%84%E3%80%82%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E4%BA%9B%E8%BE%85%E5%8A%A9%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%E6%9D%A5%E8%8E%B7%E5%8F%96%E3%80%82%0A%0A-%20%60ctx.headers%60%EF%BC%8C%60ctx.header%60%EF%BC%8C%60ctx.request.headers%60%EF%BC%8C%60ctx.request.header%60%EF%BC%9A%E8%BF%99%E5%87%A0%E4%B8%AA%E6%96%B9%E6%B3%95%E6%98%AF%E7%AD%89%E4%BB%B7%E7%9A%84%EF%BC%8C%E9%83%BD%E6%98%AF%E8%8E%B7%E5%8F%96%E6%95%B4%E4%B8%AA%20header%20%E5%AF%B9%E8%B1%A1%E3%80%82%0A-%20%60ctx.get(name)%60%EF%BC%8C%60ctx.request.get(name)%60%EF%BC%9A%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%20header%20%E4%B8%AD%E7%9A%84%E4%B8%80%E4%B8%AA%E5%AD%97%E6%AE%B5%E7%9A%84%E5%80%BC%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%BF%99%E4%B8%AA%E5%AD%97%E6%AE%B5%E4%B8%8D%E5%AD%98%E5%9C%A8%EF%BC%8C%E4%BC%9A%E8%BF%94%E5%9B%9E%E7%A9%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E3%80%82%0A-%20%E6%88%91%E4%BB%AC%E5%BB%BA%E8%AE%AE%E7%94%A8%20%60ctx.get(name)%60%20%E8%80%8C%E4%B8%8D%E6%98%AF%20%60ctx.headers%5B'name'%5D%60%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%89%8D%E8%80%85%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%A4%84%E7%90%86%E5%A4%A7%E5%B0%8F%E5%86%99%E3%80%82%0A%0A%E7%94%B1%E4%BA%8E%20header%20%E6%AF%94%E8%BE%83%E7%89%B9%E6%AE%8A%EF%BC%8C%E6%9C%89%E4%B8%80%E4%BA%9B%E6%98%AF%20%60HTTP%60%20%E5%8D%8F%E8%AE%AE%E8%A7%84%E5%AE%9A%E4%BA%86%E5%85%B7%E4%BD%93%E5%90%AB%E4%B9%89%E7%9A%84%EF%BC%88%E4%BE%8B%E5%A6%82%20%60Content-Type%60%EF%BC%8C%60Accept%60%EF%BC%89%EF%BC%8C%E6%9C%89%E4%BA%9B%E6%98%AF%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%AE%BE%E7%BD%AE%E7%9A%84%EF%BC%8C%E5%B7%B2%E7%BB%8F%E7%BA%A6%E5%AE%9A%E4%BF%97%E6%88%90%EF%BC%88X-Forwarded-For%EF%BC%89%EF%BC%8C%E6%A1%86%E6%9E%B6%E4%B9%9F%E4%BC%9A%E5%AF%B9%E4%BB%96%E4%BB%AC%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%BA%9B%E4%BE%BF%E6%8D%B7%E7%9A%84%20getter%EF%BC%8C%E8%AF%A6%E7%BB%86%E7%9A%84%20getter%20%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8B%20%5BAPI%5D(https%3A%2F%2Feggjs.org%2Fapi%2F)%20%E6%96%87%E6%A1%A3%E3%80%82%0A%0A%E7%89%B9%E5%88%AB%E6%98%AF%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87%20%60config.proxy%20%3D%20true%60%20%E8%AE%BE%E7%BD%AE%E4%BA%86%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E5%9C%A8%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%EF%BC%88Nginx%EF%BC%89%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%9C%89%E4%B8%80%E4%BA%9B%20Getter%20%E7%9A%84%E5%86%85%E9%83%A8%E5%A4%84%E7%90%86%E4%BC%9A%E5%8F%91%E7%94%9F%E6%94%B9%E5%8F%98%E3%80%82%0A%0A%23%23%23%23%20%60ctx.host%60%0A%0A%E4%BC%98%E5%85%88%E8%AF%BB%E9%80%9A%E8%BF%87%20%60config.hostHeaders%60%20%E4%B8%AD%E9%85%8D%E7%BD%AE%E7%9A%84%20header%20%E7%9A%84%E5%80%BC%EF%BC%8C%E8%AF%BB%E4%B8%8D%E5%88%B0%E6%97%B6%E5%86%8D%E5%B0%9D%E8%AF%95%E8%8E%B7%E5%8F%96%20host%20%E8%BF%99%E4%B8%AA%20header%20%E7%9A%84%E5%80%BC%EF%BC%8C%E5%A6%82%E6%9E%9C%E9%83%BD%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%EF%BC%8C%E8%BF%94%E5%9B%9E%E7%A9%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E3%80%82%0A%0A%60config.hostHeaders%60%20%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E4%B8%BA%20%60x-forwarded-host%60%E3%80%82%0A%0A%23%23%23%23%20%60ctx.protocol%60%0A%0A%E9%80%9A%E8%BF%87%E8%BF%99%E4%B8%AA%20Getter%20%E8%8E%B7%E5%8F%96%20protocol%20%E6%97%B6%EF%BC%8C%E9%A6%96%E5%85%88%E4%BC%9A%E5%88%A4%E6%96%AD%E5%BD%93%E5%89%8D%E8%BF%9E%E6%8E%A5%E6%98%AF%E5%90%A6%E6%98%AF%E5%8A%A0%E5%AF%86%E8%BF%9E%E6%8E%A5%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AF%E5%8A%A0%E5%AF%86%E8%BF%9E%E6%8E%A5%EF%BC%8C%E8%BF%94%E5%9B%9E%20https%E3%80%82%0A%0A%E5%A6%82%E6%9E%9C%E5%A4%84%E4%BA%8E%E9%9D%9E%E5%8A%A0%E5%AF%86%E8%BF%9E%E6%8E%A5%E6%97%B6%EF%BC%8C%E4%BC%98%E5%85%88%E8%AF%BB%E9%80%9A%E8%BF%87%20%60config.protocolHeaders%60%20%E4%B8%AD%E9%85%8D%E7%BD%AE%E7%9A%84%20header%20%E7%9A%84%E5%80%BC%E6%9D%A5%E5%88%A4%E6%96%AD%E6%98%AF%20HTTP%20%E8%BF%98%E6%98%AF%20https%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%AF%BB%E5%8F%96%E4%B8%8D%E5%88%B0%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%9C%A8%E9%85%8D%E7%BD%AE%E4%B8%AD%E9%80%9A%E8%BF%87%20%60config.protocol%60%20%E6%9D%A5%E8%AE%BE%E7%BD%AE%E5%85%9C%E5%BA%95%E5%80%BC%EF%BC%8C%E9%BB%98%E8%AE%A4%E4%B8%BA%20HTTP%E3%80%82%0A%0A%60config.protocolHeaders%60%20%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E4%B8%BA%20%60x-forwarded-proto%60%E3%80%82%0A%0A%23%23%23%23%20%60ctx.ips%60%0A%0A%E9%80%9A%E8%BF%87%20%60ctx.ips%60%20%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E7%BB%8F%E8%BF%87%E6%89%80%E6%9C%89%E7%9A%84%E4%B8%AD%E9%97%B4%E8%AE%BE%E5%A4%87%20IP%20%E5%9C%B0%E5%9D%80%E5%88%97%E8%A1%A8%EF%BC%8C%E5%8F%AA%E6%9C%89%E5%9C%A8%20%60config.proxy%20%3D%20true%60%20%E6%97%B6%EF%BC%8C%E6%89%8D%E4%BC%9A%E9%80%9A%E8%BF%87%E8%AF%BB%E5%8F%96%20%60config.ipHeaders%60%20%E4%B8%AD%E9%85%8D%E7%BD%AE%E7%9A%84%20header%20%E7%9A%84%E5%80%BC%E6%9D%A5%E8%8E%B7%E5%8F%96%EF%BC%8C%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E6%97%B6%E4%B8%BA%E7%A9%BA%E6%95%B0%E7%BB%84%E3%80%82%0A%0A%60config.ipHeaders%60%20%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E4%B8%BA%20%60x-forwarded-for%60%E3%80%82%0A%0A%23%23%23%23%20%60ctx.ip%60%0A%0A%E9%80%9A%E8%BF%87%20%60ctx.ip%60%20%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%91%E8%B5%B7%E6%96%B9%E7%9A%84%20IP%20%E5%9C%B0%E5%9D%80%EF%BC%8C%E4%BC%98%E5%85%88%E4%BB%8E%20%60ctx.ips%60%20%E4%B8%AD%E8%8E%B7%E5%8F%96%EF%BC%8C%60ctx.ips%60%20%E4%B8%BA%E7%A9%BA%E6%97%B6%E4%BD%BF%E7%94%A8%E8%BF%9E%E6%8E%A5%E4%B8%8A%E5%8F%91%E8%B5%B7%E6%96%B9%E7%9A%84%20IP%20%E5%9C%B0%E5%9D%80%E3%80%82%0A%0A**%E6%B3%A8%E6%84%8F%EF%BC%9A%60ip%60%20%E5%92%8C%20%60ips%60%20%E4%B8%8D%E5%90%8C%EF%BC%8C%60ip%60%20%E5%BD%93%20%60config.proxy%20%3D%20false%60%20%E6%97%B6%E4%BC%9A%E8%BF%94%E5%9B%9E%E5%BD%93%E5%89%8D%E8%BF%9E%E6%8E%A5%E5%8F%91%E8%B5%B7%E8%80%85%E7%9A%84%20%60ip%60%20%E5%9C%B0%E5%9D%80%EF%BC%8C%60ips%60%20%E6%AD%A4%E6%97%B6%E4%BC%9A%E4%B8%BA%E7%A9%BA%E6%95%B0%E7%BB%84%E3%80%82**%0A%0A%23%23%23%20Cookie%0A%0AHTTP%20%E8%AF%B7%E6%B1%82%E9%83%BD%E6%98%AF%E6%97%A0%E7%8A%B6%E6%80%81%E7%9A%84%EF%BC%8C%E4%BD%86%E6%98%AF%E6%88%91%E4%BB%AC%E7%9A%84%20Web%20%E5%BA%94%E7%94%A8%E9%80%9A%E5%B8%B8%E9%83%BD%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82%E7%9A%84%E4%BA%BA%E6%98%AF%E8%B0%81%E3%80%82%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%8CHTTP%20%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1%E4%BA%86%E4%B8%80%E4%B8%AA%E7%89%B9%E6%AE%8A%E7%9A%84%E8%AF%B7%E6%B1%82%E5%A4%B4%EF%BC%9A%5BCookie%5D(https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FHTTP_cookie)%E3%80%82%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%93%8D%E5%BA%94%E5%A4%B4%EF%BC%88set-cookie%EF%BC%89%E5%B0%86%E5%B0%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BC%9A%E9%81%B5%E5%BE%AA%E5%8D%8F%E8%AE%AE%E5%B0%86%E6%95%B0%E6%8D%AE%E4%BF%9D%E5%AD%98%EF%BC%8C%E5%B9%B6%E5%9C%A8%E4%B8%8B%E6%AC%A1%E8%AF%B7%E6%B1%82%E5%90%8C%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%97%B6%E5%80%99%E5%B8%A6%E4%B8%8A%EF%BC%88%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B9%9F%E4%BC%9A%E9%81%B5%E5%BE%AA%E5%8D%8F%E8%AE%AE%EF%BC%8C%E5%8F%AA%E5%9C%A8%E8%AE%BF%E9%97%AE%E7%AC%A6%E5%90%88%20Cookie%20%E6%8C%87%E5%AE%9A%E8%A7%84%E5%88%99%E7%9A%84%E7%BD%91%E7%AB%99%E6%97%B6%E5%B8%A6%E4%B8%8A%E5%AF%B9%E5%BA%94%E7%9A%84%20Cookie%20%E6%9D%A5%E4%BF%9D%E8%AF%81%E5%AE%89%E5%85%A8%E6%80%A7%EF%BC%89%E3%80%82%0A%0A%E9%80%9A%E8%BF%87%20%60ctx.cookies%60%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%9C%A8%20Controller%20%E4%B8%AD%E4%BE%BF%E6%8D%B7%E3%80%81%E5%AE%89%E5%85%A8%E7%9A%84%E8%AE%BE%E7%BD%AE%E5%92%8C%E8%AF%BB%E5%8F%96%20Cookie%E3%80%82%0A%0A%60%60%60js%0Aclass%20CookieController%20extends%20Controller%20%7B%0A%20%20async%20add()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20const%20count%20%3D%20ctx.cookies.get('count')%3B%0A%20%20%20%20count%20%3D%20count%20%3F%20Number(count)%20%3A%200%3B%0A%20%20%20%20ctx.cookies.set('count'%2C%20%2B%2Bcount)%3B%0A%20%20%20%20ctx.body%20%3D%20count%3B%0A%20%20%7D%0A%0A%20%20async%20remove()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20const%20count%20%3D%20ctx.cookies.set('count'%2C%20null)%3B%0A%20%20%20%20ctx.status%20%3D%20204%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0ACookie%20%E8%99%BD%E7%84%B6%E5%9C%A8%20HTTP%20%E4%B8%AD%E5%8F%AA%E6%98%AF%E4%B8%80%E4%B8%AA%E5%A4%B4%EF%BC%8C%E4%BD%86%E6%98%AF%E9%80%9A%E8%BF%87%20%60foo%3Dbar%3Bfoo1%3Dbar1%3B%60%20%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8F%AF%E4%BB%A5%E8%AE%BE%E7%BD%AE%E5%A4%9A%E4%B8%AA%E9%94%AE%E5%80%BC%E5%AF%B9%E3%80%82%0A%0ACookie%20%E5%9C%A8%20Web%20%E5%BA%94%E7%94%A8%E4%B8%AD%E7%BB%8F%E5%B8%B8%E6%89%BF%E6%8B%85%E4%BA%86%E4%BC%A0%E9%80%92%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BA%AB%E4%BB%BD%E4%BF%A1%E6%81%AF%E7%9A%84%E4%BD%9C%E7%94%A8%EF%BC%8C%E5%9B%A0%E6%AD%A4%E6%9C%89%E8%AE%B8%E5%A4%9A%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E4%B8%8D%E5%8F%AF%E5%BF%BD%E8%A7%86%EF%BC%8C%5BCookie%5D(..%2Fcore%2Fcookie-and-session.md%23cookie)%20%E6%96%87%E6%A1%A3%E4%B8%AD%E8%AF%A6%E7%BB%86%E4%BB%8B%E7%BB%8D%E4%BA%86%20Cookie%20%E7%9A%84%E7%94%A8%E6%B3%95%E5%92%8C%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%B7%B1%E5%85%A5%E9%98%85%E8%AF%BB%E4%BA%86%E8%A7%A3%E3%80%82%0A%0A%23%23%23%20Session%0A%0A%E9%80%9A%E8%BF%87%20Cookie%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%BB%99%E6%AF%8F%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%AA%20Session%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8%E7%94%A8%E6%88%B7%E8%BA%AB%E4%BB%BD%E7%9B%B8%E5%85%B3%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%8C%E8%BF%99%E4%BB%BD%E4%BF%A1%E6%81%AF%E4%BC%9A%E5%8A%A0%E5%AF%86%E5%90%8E%E5%AD%98%E5%82%A8%E5%9C%A8%20Cookie%20%E4%B8%AD%EF%BC%8C%E5%AE%9E%E7%8E%B0%E8%B7%A8%E8%AF%B7%E6%B1%82%E7%9A%84%E7%94%A8%E6%88%B7%E8%BA%AB%E4%BB%BD%E4%BF%9D%E6%8C%81%E3%80%82%0A%0A%E6%A1%86%E6%9E%B6%E5%86%85%E7%BD%AE%E4%BA%86%20%5BSession%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-session)%20%E6%8F%92%E4%BB%B6%EF%BC%8C%E7%BB%99%E6%88%91%E4%BB%AC%E6%8F%90%E4%BE%9B%E4%BA%86%20%60ctx.session%60%20%E6%9D%A5%E8%AE%BF%E9%97%AE%E6%88%96%E8%80%85%E4%BF%AE%E6%94%B9%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%20Session%20%E3%80%82%0A%0A%60%60%60js%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20fetchPosts()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20%2F%2F%20%E8%8E%B7%E5%8F%96%20Session%20%E4%B8%8A%E7%9A%84%E5%86%85%E5%AE%B9%0A%20%20%20%20const%20userId%20%3D%20ctx.session.userId%3B%0A%20%20%20%20const%20posts%20%3D%20await%20ctx.service.post.fetch(userId)%3B%0A%20%20%20%20%2F%2F%20%E4%BF%AE%E6%94%B9%20Session%20%E7%9A%84%E5%80%BC%0A%20%20%20%20ctx.session.visited%20%3D%20ctx.session.visited%20%3F%20%2B%2Bctx.session.visited%20%3A%201%3B%0A%20%20%20%20ctx.body%20%3D%20%7B%0A%20%20%20%20%20%20success%3A%20true%2C%0A%20%20%20%20%20%20posts%2C%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0ASession%20%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%E9%9D%9E%E5%B8%B8%E7%9B%B4%E8%A7%82%EF%BC%8C%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96%E5%AE%83%E6%88%96%E8%80%85%E4%BF%AE%E6%94%B9%E5%AE%83%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BA%86%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%A6%81%E5%88%A0%E9%99%A4%E5%AE%83%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%B0%86%E5%AE%83%E8%B5%8B%E5%80%BC%E4%B8%BA%20%60null%60%EF%BC%9A%0A%0A%60%60%60js%0Aclass%20SessionController%20extends%20Controller%20%7B%0A%20%20async%20deleteSession()%20%7B%0A%20%20%20%20this.ctx.session%20%3D%20null%3B%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%E5%92%8C%20Cookie%20%E4%B8%80%E6%A0%B7%EF%BC%8CSession%20%E4%B9%9F%E6%9C%89%E8%AE%B8%E5%A4%9A%E5%AE%89%E5%85%A8%E7%AD%89%E9%80%89%E9%A1%B9%E5%92%8C%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%9C%A8%E4%BD%BF%E7%94%A8%E4%B9%8B%E5%89%8D%E4%B9%9F%E6%9C%80%E5%A5%BD%E9%98%85%E8%AF%BB%20%5BSession%5D(..%2Fcore%2Fcookie-and-session.md%23session)%20%E6%96%87%E6%A1%A3%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3%E3%80%82%0A%0A%23%23%23%23%20%E9%85%8D%E7%BD%AE%0A%0A%E5%AF%B9%E4%BA%8E%20Session%20%E6%9D%A5%E8%AF%B4%EF%BC%8C%E4%B8%BB%E8%A6%81%E6%9C%89%E4%B8%8B%E9%9D%A2%E5%87%A0%E4%B8%AA%E5%B1%9E%E6%80%A7%E5%8F%AF%E4%BB%A5%E5%9C%A8%20%60config.default.js%60%20%E4%B8%AD%E8%BF%9B%E8%A1%8C%E9%85%8D%E7%BD%AE%3A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20key%3A%20'EGG_SESS'%2C%20%2F%2F%20%E6%89%BF%E8%BD%BD%20Session%20%E7%9A%84%20Cookie%20%E9%94%AE%E5%80%BC%E5%AF%B9%E5%90%8D%E5%AD%97%0A%20%20maxAge%3A%2086400000%2C%20%2F%2F%20Session%20%E7%9A%84%E6%9C%80%E5%A4%A7%E6%9C%89%E6%95%88%E6%97%B6%E9%97%B4%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%0A%0A%E5%9C%A8%E8%8E%B7%E5%8F%96%E5%88%B0%E7%94%A8%E6%88%B7%E8%AF%B7%E6%B1%82%E7%9A%84%E5%8F%82%E6%95%B0%E5%90%8E%EF%BC%8C%E4%B8%8D%E5%8F%AF%E9%81%BF%E5%85%8D%E7%9A%84%E8%A6%81%E5%AF%B9%E5%8F%82%E6%95%B0%E8%BF%9B%E8%A1%8C%E4%B8%80%E4%BA%9B%E6%A0%A1%E9%AA%8C%E3%80%82%0A%0A%E5%80%9F%E5%8A%A9%20%5BValidate%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-validate)%20%E6%8F%92%E4%BB%B6%E6%8F%90%E4%BE%9B%E4%BE%BF%E6%8D%B7%E7%9A%84%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%E6%9C%BA%E5%88%B6%EF%BC%8C%E5%B8%AE%E5%8A%A9%E6%88%91%E4%BB%AC%E5%AE%8C%E6%88%90%E5%90%84%E7%A7%8D%E5%A4%8D%E6%9D%82%E7%9A%84%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20config%2Fplugin.js%0Aexports.validate%20%3D%20%7B%0A%20%20enable%3A%20true%2C%0A%20%20package%3A%20'egg-validate'%2C%0A%7D%3B%0A%60%60%60%0A%0A%E9%80%9A%E8%BF%87%20%60ctx.validate(rule%2C%20%5Bbody%5D)%60%20%E7%9B%B4%E6%8E%A5%E5%AF%B9%E5%8F%82%E6%95%B0%E8%BF%9B%E8%A1%8C%E6%A0%A1%E9%AA%8C%EF%BC%9A%0A%0A%60%60%60js%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20create()%20%7B%0A%20%20%20%20%2F%2F%20%E6%A0%A1%E9%AA%8C%E5%8F%82%E6%95%B0%0A%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E4%B8%8D%E4%BC%A0%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E4%BC%9A%E8%87%AA%E5%8A%A8%E6%A0%A1%E9%AA%8C%20%60ctx.request.body%60%0A%20%20%20%20this.ctx.validate(%7B%0A%20%20%20%20%20%20title%3A%20%7B%20type%3A%20'string'%20%7D%2C%0A%20%20%20%20%20%20content%3A%20%7B%20type%3A%20'string'%20%7D%2C%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E5%BD%93%E6%A0%A1%E9%AA%8C%E5%BC%82%E5%B8%B8%E6%97%B6%EF%BC%8C%E4%BC%9A%E7%9B%B4%E6%8E%A5%E6%8A%9B%E5%87%BA%E4%B8%80%E4%B8%AA%E5%BC%82%E5%B8%B8%EF%BC%8C%E5%BC%82%E5%B8%B8%E7%9A%84%E7%8A%B6%E6%80%81%E7%A0%81%E4%B8%BA%20422%EF%BC%8Cerrors%20%E5%AD%97%E6%AE%B5%E5%8C%85%E5%90%AB%E4%BA%86%E8%AF%A6%E7%BB%86%E7%9A%84%E9%AA%8C%E8%AF%81%E4%B8%8D%E9%80%9A%E8%BF%87%E4%BF%A1%E6%81%AF%E3%80%82%E5%A6%82%E6%9E%9C%E6%83%B3%E8%A6%81%E8%87%AA%E5%B7%B1%E5%A4%84%E7%90%86%E6%A3%80%E6%9F%A5%E7%9A%84%E5%BC%82%E5%B8%B8%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60try%20catch%60%20%E6%9D%A5%E8%87%AA%E8%A1%8C%E6%8D%95%E8%8E%B7%E3%80%82%0A%0A%60%60%60js%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20create()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20ctx.validate(createRule)%3B%0A%20%20%20%20%7D%20catch%20(err)%20%7B%0A%20%20%20%20%20%20ctx.logger.warn(err.errors)%3B%0A%20%20%20%20%20%20ctx.body%20%3D%20%7B%20success%3A%20false%20%7D%3B%0A%20%20%20%20%20%20return%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99%0A%0A%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%E9%80%9A%E8%BF%87%20%5BParameter%5D(https%3A%2F%2Fgithub.com%2Fnode-modules%2Fparameter%23rule)%20%E5%AE%8C%E6%88%90%EF%BC%8C%E6%94%AF%E6%8C%81%E7%9A%84%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99%E5%8F%AF%E4%BB%A5%E5%9C%A8%E8%AF%A5%E6%A8%A1%E5%9D%97%E7%9A%84%E6%96%87%E6%A1%A3%E4%B8%AD%E6%9F%A5%E9%98%85%E5%88%B0%E3%80%82%0A%0A%23%23%23%23%20%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99%0A%0A%E9%99%A4%E4%BA%86%E4%B8%8A%E4%B8%80%E8%8A%82%E4%BB%8B%E7%BB%8D%E7%9A%84%E5%86%85%E7%BD%AE%E6%A3%80%E9%AA%8C%E7%B1%BB%E5%9E%8B%E5%A4%96%EF%BC%8C%E6%9C%89%E6%97%B6%E5%80%99%E6%88%91%E4%BB%AC%E5%B8%8C%E6%9C%9B%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%80%E4%BA%9B%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99%EF%BC%8C%E8%AE%A9%E5%BC%80%E5%8F%91%E6%97%B6%E6%9B%B4%E4%BE%BF%E6%8D%B7%EF%BC%8C%E6%AD%A4%E6%97%B6%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60app.validator.addRule(type%2C%20check)%60%20%E7%9A%84%E6%96%B9%E5%BC%8F%E6%96%B0%E5%A2%9E%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Aapp.validator.addRule('json'%2C%20(rule%2C%20value)%20%3D%3E%20%7B%0A%20%20try%20%7B%0A%20%20%20%20JSON.parse(value)%3B%0A%20%20%7D%20catch%20(err)%20%7B%0A%20%20%20%20return%20'must%20be%20json%20string'%3B%0A%20%20%7D%0A%7D)%3B%0A%60%60%60%0A%0A%E6%B7%BB%E5%8A%A0%E5%AE%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%9C%A8%20Controller%20%E4%B8%AD%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E8%BF%99%E6%9D%A1%E8%A7%84%E5%88%99%E6%9D%A5%E8%BF%9B%E8%A1%8C%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%E4%BA%86%0A%0A%60%60%60js%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20handler()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20%2F%2F%20query.test%20%E5%AD%97%E6%AE%B5%E5%BF%85%E9%A1%BB%E6%98%AF%20json%20%E5%AD%97%E7%AC%A6%E4%B8%B2%0A%20%20%20%20const%20rule%20%3D%20%7B%20test%3A%20'json'%20%7D%3B%0A%20%20%20%20ctx.validate(rule%2C%20ctx.query)%3B%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20%E8%B0%83%E7%94%A8%20Service%0A%0A%E6%88%91%E4%BB%AC%E5%B9%B6%E4%B8%8D%E6%83%B3%E5%9C%A8%20Controller%20%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%A4%AA%E5%A4%9A%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%EF%BC%8C%E6%89%80%E4%BB%A5%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E4%B8%AA%20%5BService%5D(.%2Fservice.md)%20%E5%B1%82%E8%BF%9B%E8%A1%8C%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E7%9A%84%E5%B0%81%E8%A3%85%EF%BC%8C%E8%BF%99%E4%B8%8D%E4%BB%85%E8%83%BD%E6%8F%90%E9%AB%98%E4%BB%A3%E7%A0%81%E7%9A%84%E5%A4%8D%E7%94%A8%E6%80%A7%EF%BC%8C%E5%90%8C%E6%97%B6%E5%8F%AF%E4%BB%A5%E8%AE%A9%E6%88%91%E4%BB%AC%E7%9A%84%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E6%9B%B4%E5%A5%BD%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A%E5%9C%A8%20Controller%20%E4%B8%AD%E5%8F%AF%E4%BB%A5%E8%B0%83%E7%94%A8%E4%BB%BB%E4%BD%95%E4%B8%80%E4%B8%AA%20Service%20%E4%B8%8A%E7%9A%84%E4%BB%BB%E4%BD%95%E6%96%B9%E6%B3%95%EF%BC%8C%E5%90%8C%E6%97%B6%20Service%20%E6%98%AF%E6%87%92%E5%8A%A0%E8%BD%BD%E7%9A%84%EF%BC%8C%E5%8F%AA%E6%9C%89%E5%BD%93%E8%AE%BF%E9%97%AE%E5%88%B0%E5%AE%83%E7%9A%84%E6%97%B6%E5%80%99%E6%A1%86%E6%9E%B6%E6%89%8D%E4%BC%9A%E5%8E%BB%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%AE%83%E3%80%82%0A%0A%60%60%60js%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20create()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20const%20author%20%3D%20ctx.session.userId%3B%0A%20%20%20%20const%20req%20%3D%20Object.assign(ctx.request.body%2C%20%7B%20author%20%7D)%3B%0A%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8%20service%20%E8%BF%9B%E8%A1%8C%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86%0A%20%20%20%20const%20res%20%3D%20await%20ctx.service.post.create(req)%3B%0A%20%20%20%20ctx.body%20%3D%20%7B%20id%3A%20res.id%20%7D%3B%0A%20%20%20%20ctx.status%20%3D%20201%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0AService%20%E7%9A%84%E5%85%B7%E4%BD%93%E5%86%99%E6%B3%95%EF%BC%8C%E8%AF%B7%E6%9F%A5%E7%9C%8B%20%5BService%5D(.%2Fservice.md)%20%E7%AB%A0%E8%8A%82%E3%80%82%0A%0A%23%23%20%E5%8F%91%E9%80%81%20HTTP%20%E5%93%8D%E5%BA%94%0A%0A%E5%BD%93%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%AE%8C%E6%88%90%E4%B9%8B%E5%90%8E%EF%BC%8CController%20%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E8%81%8C%E8%B4%A3%E5%B0%B1%E6%98%AF%E5%B0%86%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E7%9A%84%E5%A4%84%E7%90%86%E7%BB%93%E6%9E%9C%E9%80%9A%E8%BF%87%20HTTP%20%E5%93%8D%E5%BA%94%E5%8F%91%E9%80%81%E7%BB%99%E7%94%A8%E6%88%B7%E3%80%82%0A%0A%23%23%23%20%E8%AE%BE%E7%BD%AE%20status%0A%0AHTTP%20%E8%AE%BE%E8%AE%A1%E4%BA%86%E9%9D%9E%E5%B8%B8%E5%A4%9A%E7%9A%84%5B%E7%8A%B6%E6%80%81%E7%A0%81%5D(https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FList_of_HTTP_status_codes)%EF%BC%8C%E6%AF%8F%E4%B8%80%E4%B8%AA%E7%8A%B6%E6%80%81%E7%A0%81%E9%83%BD%E4%BB%A3%E8%A1%A8%E4%BA%86%E4%B8%80%E4%B8%AA%E7%89%B9%E5%AE%9A%E7%9A%84%E5%90%AB%E4%B9%89%EF%BC%8C%E9%80%9A%E8%BF%87%E8%AE%BE%E7%BD%AE%E6%AD%A3%E7%A1%AE%E7%9A%84%E7%8A%B6%E6%80%81%E7%A0%81%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%AE%A9%E5%93%8D%E5%BA%94%E6%9B%B4%E7%AC%A6%E5%90%88%E8%AF%AD%E4%B9%89%E3%80%82%0A%0A%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E4%B8%AA%E4%BE%BF%E6%8D%B7%E7%9A%84%20Setter%20%E6%9D%A5%E8%BF%9B%E8%A1%8C%E7%8A%B6%E6%80%81%E7%A0%81%E7%9A%84%E8%AE%BE%E7%BD%AE%0A%0A%60%60%60js%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20create()%20%7B%0A%20%20%20%20%2F%2F%20%E8%AE%BE%E7%BD%AE%E7%8A%B6%E6%80%81%E7%A0%81%E4%B8%BA%20201%0A%20%20%20%20this.ctx.status%20%3D%20201%3B%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%E5%85%B7%E4%BD%93%E4%BB%80%E4%B9%88%E5%9C%BA%E6%99%AF%E8%AE%BE%E7%BD%AE%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84%E7%8A%B6%E6%80%81%E7%A0%81%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83%20%5BList%20of%20HTTP%20status%20codes%5D(https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FList_of_HTTP_status_codes)%20%E4%B8%AD%E5%90%84%E4%B8%AA%E7%8A%B6%E6%80%81%E7%A0%81%E7%9A%84%E5%90%AB%E4%B9%89%E3%80%82%0A%0A%23%23%23%20%E8%AE%BE%E7%BD%AE%20body%0A%0A%E7%BB%9D%E5%A4%A7%E5%A4%9A%E6%95%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E9%83%BD%E6%98%AF%E9%80%9A%E8%BF%87%20body%20%E5%8F%91%E9%80%81%E7%BB%99%E8%AF%B7%E6%B1%82%E6%96%B9%E7%9A%84%EF%BC%8C%E5%92%8C%E8%AF%B7%E6%B1%82%E4%B8%AD%E7%9A%84%20body%20%E4%B8%80%E6%A0%B7%EF%BC%8C%E5%9C%A8%E5%93%8D%E5%BA%94%E4%B8%AD%E5%8F%91%E9%80%81%E7%9A%84%20body%EF%BC%8C%E4%B9%9F%E9%9C%80%E8%A6%81%E6%9C%89%E9%85%8D%E5%A5%97%E7%9A%84%20Content-Type%20%E5%91%8A%E7%9F%A5%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A6%82%E4%BD%95%E5%AF%B9%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E8%A7%A3%E6%9E%90%E3%80%82%0A%0A-%20%E4%BD%9C%E4%B8%BA%E4%B8%80%E4%B8%AA%20RESTful%20%E7%9A%84%20API%20%E6%8E%A5%E5%8F%A3%20controller%EF%BC%8C%E6%88%91%E4%BB%AC%E9%80%9A%E5%B8%B8%E4%BC%9A%E8%BF%94%E5%9B%9E%20Content-Type%20%E4%B8%BA%20%60application%2Fjson%60%20%E6%A0%BC%E5%BC%8F%E7%9A%84%20body%EF%BC%8C%E5%86%85%E5%AE%B9%E6%98%AF%E4%B8%80%E4%B8%AA%20JSON%20%E5%AD%97%E7%AC%A6%E4%B8%B2%E3%80%82%0A-%20%E4%BD%9C%E4%B8%BA%E4%B8%80%E4%B8%AA%20html%20%E9%A1%B5%E9%9D%A2%E7%9A%84%20controller%EF%BC%8C%E6%88%91%E4%BB%AC%E9%80%9A%E5%B8%B8%E4%BC%9A%E8%BF%94%E5%9B%9E%20Content-Type%20%E4%B8%BA%20%60text%2Fhtml%60%20%E6%A0%BC%E5%BC%8F%E7%9A%84%20body%EF%BC%8C%E5%86%85%E5%AE%B9%E6%98%AF%20html%20%E4%BB%A3%E7%A0%81%E6%AE%B5%E3%80%82%0A%0A**%E6%B3%A8%E6%84%8F%EF%BC%9A%60ctx.body%60%20%E6%98%AF%20%60ctx.response.body%60%20%E7%9A%84%E7%AE%80%E5%86%99%EF%BC%8C%E4%B8%8D%E8%A6%81%E5%92%8C%20%60ctx.request.body%60%20%E6%B7%B7%E6%B7%86%E4%BA%86%E3%80%82**%0A%0A%60%60%60js%0Aclass%20ViewController%20extends%20Controller%20%7B%0A%20%20async%20show()%20%7B%0A%20%20%20%20this.ctx.body%20%3D%20%7B%0A%20%20%20%20%20%20name%3A%20'egg'%2C%0A%20%20%20%20%20%20category%3A%20'framework'%2C%0A%20%20%20%20%20%20language%3A%20'Node.js'%2C%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20async%20page()%20%7B%0A%20%20%20%20this.ctx.body%20%3D%20'%3Chtml%3E%3Ch1%3EHello%3C%2Fh1%3E%3C%2Fhtml%3E'%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E7%94%B1%E4%BA%8E%20Node.js%20%E7%9A%84%E6%B5%81%E5%BC%8F%E7%89%B9%E6%80%A7%EF%BC%8C%E6%88%91%E4%BB%AC%E8%BF%98%E6%9C%89%E5%BE%88%E5%A4%9A%E5%9C%BA%E6%99%AF%E9%9C%80%E8%A6%81%E9%80%9A%E8%BF%87%20Stream%20%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94%EF%BC%8C%E4%BE%8B%E5%A6%82%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E5%A4%A7%E6%96%87%E4%BB%B6%EF%BC%8C%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E4%B8%8A%E6%B8%B8%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%8C%E6%A1%86%E6%9E%B6%E4%B9%9F%E6%94%AF%E6%8C%81%E7%9B%B4%E6%8E%A5%E5%B0%86%20body%20%E8%AE%BE%E7%BD%AE%E6%88%90%E4%B8%80%E4%B8%AA%20Stream%EF%BC%8C%E5%B9%B6%E4%BC%9A%E5%90%8C%E6%97%B6%E5%A4%84%E7%90%86%E5%A5%BD%E8%BF%99%E4%B8%AA%20Stream%20%E4%B8%8A%E7%9A%84%E9%94%99%E8%AF%AF%E4%BA%8B%E4%BB%B6%E3%80%82%0A%0A%60%60%60js%0Aclass%20ProxyController%20extends%20Controller%20%7B%0A%20%20async%20proxy()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20const%20result%20%3D%20await%20ctx.curl(url%2C%20%7B%0A%20%20%20%20%20%20streaming%3A%20true%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20ctx.set(result.header)%3B%0A%20%20%20%20%2F%2F%20result.res%20%E6%98%AF%E4%B8%80%E4%B8%AA%20stream%0A%20%20%20%20ctx.body%20%3D%20result.res%3B%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%23%20%E6%B8%B2%E6%9F%93%E6%A8%A1%E6%9D%BF%0A%0A%E9%80%9A%E5%B8%B8%E6%9D%A5%E8%AF%B4%EF%BC%8C%E6%88%91%E4%BB%AC%E4%B8%8D%E4%BC%9A%E6%89%8B%E5%86%99%20HTML%20%E9%A1%B5%E9%9D%A2%EF%BC%8C%E8%80%8C%E6%98%AF%E4%BC%9A%E9%80%9A%E8%BF%87%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E8%BF%9B%E8%A1%8C%E7%94%9F%E6%88%90%E3%80%82%0A%E6%A1%86%E6%9E%B6%E8%87%AA%E8%BA%AB%E6%B2%A1%E6%9C%89%E9%9B%86%E6%88%90%E4%BB%BB%E4%BD%95%E4%B8%80%E4%B8%AA%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%EF%BC%8C%E4%BD%86%E6%98%AF%E7%BA%A6%E5%AE%9A%E4%BA%86%20%5BView%20%E6%8F%92%E4%BB%B6%E7%9A%84%E8%A7%84%E8%8C%83%5D(..%2Fadvanced%2Fview-plugin.md)%EF%BC%8C%E9%80%9A%E8%BF%87%E6%8E%A5%E5%85%A5%E7%9A%84%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%20%60ctx.render(template)%60%20%E6%9D%A5%E6%B8%B2%E6%9F%93%E6%A8%A1%E6%9D%BF%E7%94%9F%E6%88%90%20html%E3%80%82%0A%0A%60%60%60js%0Aclass%20HomeController%20extends%20Controller%20%7B%0A%20%20async%20index()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20await%20ctx.render('home.tpl'%2C%20%7B%20name%3A%20'egg'%20%7D)%3B%0A%20%20%20%20%2F%2F%20ctx.body%20%3D%20await%20ctx.renderString('hi%2C%20%7B%7B%20name%20%7D%7D'%2C%20%7B%20name%3A%20'egg'%20%7D)%3B%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%E5%85%B7%E4%BD%93%E7%A4%BA%E4%BE%8B%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8B%5B%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93%5D(..%2Fcore%2Fview.md)%E3%80%82%0A%0A%23%23%23%23%20JSONP%0A%0A%E6%9C%89%E6%97%B6%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E7%BB%99%E9%9D%9E%E6%9C%AC%E5%9F%9F%E7%9A%84%E9%A1%B5%E9%9D%A2%E6%8F%90%E4%BE%9B%E6%8E%A5%E5%8F%A3%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%8F%88%E7%94%B1%E4%BA%8E%E4%B8%80%E4%BA%9B%E5%8E%86%E5%8F%B2%E5%8E%9F%E5%9B%A0%E6%97%A0%E6%B3%95%E9%80%9A%E8%BF%87%20%5BCORS%5D(https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTTP%2FAccess_control_CORS)%20%E5%AE%9E%E7%8E%B0%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%5BJSONP%5D(https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FJSONP)%20%E6%9D%A5%E8%BF%9B%E8%A1%8C%E5%93%8D%E5%BA%94%E3%80%82%0A%0A%E7%94%B1%E4%BA%8E%20JSONP%20%E5%A6%82%E6%9E%9C%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%BD%93%E4%BC%9A%E5%AF%BC%E8%87%B4%E9%9D%9E%E5%B8%B8%E5%A4%9A%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%EF%BC%8C%E6%89%80%E4%BB%A5%E6%A1%86%E6%9E%B6%E4%B8%AD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BE%BF%E6%8D%B7%E7%9A%84%E5%93%8D%E5%BA%94%20JSONP%20%E6%A0%BC%E5%BC%8F%E6%95%B0%E6%8D%AE%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%8C%E5%B0%81%E8%A3%85%E4%BA%86%20%5BJSONP%20XSS%20%E7%9B%B8%E5%85%B3%E7%9A%84%E5%AE%89%E5%85%A8%E9%98%B2%E8%8C%83%5D(..%2Fcore%2Fsecurity.md%23jsonp-xss)%EF%BC%8C%E5%B9%B6%E6%94%AF%E6%8C%81%E8%BF%9B%E8%A1%8C%20CSRF%20%E6%A0%A1%E9%AA%8C%E5%92%8C%20referrer%20%E6%A0%A1%E9%AA%8C%E3%80%82%0A%0A-%20%E9%80%9A%E8%BF%87%20%60app.jsonp()%60%20%E6%8F%90%E4%BE%9B%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%9D%A5%E8%AE%A9%E4%B8%80%E4%B8%AA%20controller%20%E6%94%AF%E6%8C%81%E5%93%8D%E5%BA%94%20JSONP%20%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%95%B0%E6%8D%AE%E3%80%82%E5%9C%A8%E8%B7%AF%E7%94%B1%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E7%BB%99%E9%9C%80%E8%A6%81%E6%94%AF%E6%8C%81%20jsonp%20%E7%9A%84%E8%B7%AF%E7%94%B1%E5%8A%A0%E4%B8%8A%E8%BF%99%E4%B8%AA%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20jsonp%20%3D%20app.jsonp()%3B%0A%20%20app.router.get('%2Fapi%2Fposts%2F%3Aid'%2C%20jsonp%2C%20app.controller.posts.show)%3B%0A%20%20app.router.get('%2Fapi%2Fposts'%2C%20jsonp%2C%20app.controller.posts.list)%3B%0A%7D%3B%0A%60%60%60%0A%0A-%20%E5%9C%A8%20Controller%20%E4%B8%AD%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E6%AD%A3%E5%B8%B8%E7%BC%96%E5%86%99%E5%8D%B3%E5%8F%AF%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fposts.js%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20show()%20%7B%0A%20%20%20%20this.ctx.body%20%3D%20%7B%0A%20%20%20%20%20%20name%3A%20'egg'%2C%0A%20%20%20%20%20%20category%3A%20'framework'%2C%0A%20%20%20%20%20%20language%3A%20'Node.js'%2C%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E7%94%A8%E6%88%B7%E8%AF%B7%E6%B1%82%E5%AF%B9%E5%BA%94%E7%9A%84%20URL%20%E8%AE%BF%E9%97%AE%E5%88%B0%E8%BF%99%E4%B8%AA%20controller%20%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%A6%82%E6%9E%9C%20query%20%E4%B8%AD%E6%9C%89%20%60_callback%3Dfn%60%20%E5%8F%82%E6%95%B0%EF%BC%8C%E5%B0%86%E4%BC%9A%E8%BF%94%E5%9B%9E%20JSONP%20%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%90%A6%E5%88%99%E8%BF%94%E5%9B%9E%20JSON%20%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%95%B0%E6%8D%AE%E3%80%82%0A%0A%23%23%23%23%23%20JSONP%20%E9%85%8D%E7%BD%AE%0A%0A%E6%A1%86%E6%9E%B6%E9%BB%98%E8%AE%A4%E9%80%9A%E8%BF%87%20query%20%E4%B8%AD%E7%9A%84%20%60_callback%60%20%E5%8F%82%E6%95%B0%E4%BD%9C%E4%B8%BA%E8%AF%86%E5%88%AB%E6%98%AF%E5%90%A6%E8%BF%94%E5%9B%9E%20JSONP%20%E6%A0%BC%E5%BC%8F%E6%95%B0%E6%8D%AE%E7%9A%84%E4%BE%9D%E6%8D%AE%EF%BC%8C%E5%B9%B6%E4%B8%94%20%60_callback%60%20%E4%B8%AD%E8%AE%BE%E7%BD%AE%E7%9A%84%E6%96%B9%E6%B3%95%E5%90%8D%E9%95%BF%E5%BA%A6%E6%9C%80%E5%A4%9A%E5%8F%AA%E5%85%81%E8%AE%B8%2050%20%E4%B8%AA%E5%AD%97%E7%AC%A6%E3%80%82%E5%BA%94%E7%94%A8%E5%8F%AF%E4%BB%A5%E5%9C%A8%20%60config%2Fconfig.default.js%60%20%E5%85%A8%E5%B1%80%E8%A6%86%E7%9B%96%E9%BB%98%E8%AE%A4%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Aexports.jsonp%20%3D%20%7B%0A%20%20callback%3A%20'callback'%2C%20%2F%2F%20%E8%AF%86%E5%88%AB%20query%20%E4%B8%AD%E7%9A%84%20%60callback%60%20%E5%8F%82%E6%95%B0%0A%20%20limit%3A%20100%2C%20%2F%2F%20%E5%87%BD%E6%95%B0%E5%90%8D%E6%9C%80%E9%95%BF%E4%B8%BA%20100%20%E4%B8%AA%E5%AD%97%E7%AC%A6%0A%7D%3B%0A%60%60%60%0A%0A%E9%80%9A%E8%BF%87%E4%B8%8A%E9%9D%A2%E7%9A%84%E6%96%B9%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%A6%82%E6%9E%9C%E7%94%A8%E6%88%B7%E8%AF%B7%E6%B1%82%20%60%2Fapi%2Fposts%2F1%3Fcallback%3Dfn%60%EF%BC%8C%E5%93%8D%E5%BA%94%E4%B8%BA%20JSONP%20%E6%A0%BC%E5%BC%8F%EF%BC%8C%E5%A6%82%E6%9E%9C%E7%94%A8%E6%88%B7%E8%AF%B7%E6%B1%82%20%60%2Fapi%2Fposts%2F1%60%EF%BC%8C%E5%93%8D%E5%BA%94%E6%A0%BC%E5%BC%8F%E4%B8%BA%20JSON%E3%80%82%0A%0A%E6%88%91%E4%BB%AC%E5%90%8C%E6%A0%B7%E5%8F%AF%E4%BB%A5%E5%9C%A8%20%60app.jsonp()%60%20%E5%88%9B%E5%BB%BA%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%97%B6%E8%A6%86%E7%9B%96%E9%BB%98%E8%AE%A4%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E4%BB%A5%E8%BE%BE%E5%88%B0%E4%B8%8D%E5%90%8C%E8%B7%AF%E7%94%B1%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE%E7%9A%84%E7%9B%AE%E7%9A%84%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20%7B%20router%2C%20controller%2C%20jsonp%20%7D%20%3D%20app%3B%0A%20%20router.get('%2Fapi%2Fposts%2F%3Aid'%2C%20jsonp(%7B%20callback%3A%20'callback'%20%7D)%2C%20controller.posts.show)%3B%0A%20%20router.get('%2Fapi%2Fposts'%2C%20jsonp(%7B%20callback%3A%20'cb'%20%7D)%2C%20controller.posts.list)%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%23%23%20%E8%B7%A8%E7%AB%99%E9%98%B2%E5%BE%A1%E9%85%8D%E7%BD%AE%0A%0A%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E4%B8%8B%EF%BC%8C%E5%93%8D%E5%BA%94%20JSONP%20%E6%97%B6%E4%B8%8D%E4%BC%9A%E8%BF%9B%E8%A1%8C%E4%BB%BB%E4%BD%95%E8%B7%A8%E7%AB%99%E6%94%BB%E5%87%BB%E7%9A%84%E9%98%B2%E8%8C%83%EF%BC%8C%E5%9C%A8%E6%9F%90%E4%BA%9B%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E8%BF%99%E6%98%AF%E5%BE%88%E5%8D%B1%E9%99%A9%E7%9A%84%E3%80%82%E6%88%91%E4%BB%AC%E5%88%9D%E7%95%A5%E5%B0%86%20JSONP%20%E6%8E%A5%E5%8F%A3%E5%88%86%E4%B8%BA%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B%EF%BC%9A%0A%0A1.%20%E6%9F%A5%E8%AF%A2%E9%9D%9E%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BE%8B%E5%A6%82%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E8%AE%BA%E5%9D%9B%E7%9A%84%E5%85%AC%E5%BC%80%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E3%80%82%0A2.%20%E6%9F%A5%E8%AF%A2%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BE%8B%E5%A6%82%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E7%9A%84%E4%BA%A4%E6%98%93%E8%AE%B0%E5%BD%95%E3%80%82%0A3.%20%E6%8F%90%E4%BA%A4%E6%95%B0%E6%8D%AE%E5%B9%B6%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E4%BE%8B%E5%A6%82%E7%BB%99%E6%9F%90%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E5%88%9B%E5%BB%BA%E4%B8%80%E7%AC%94%E8%AE%A2%E5%8D%95%E3%80%82%0A%0A%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E7%9A%84%20JSONP%20%E6%8E%A5%E5%8F%A3%E6%8F%90%E4%BE%9B%E4%B8%8B%E9%9D%A2%E4%B8%A4%E7%B1%BB%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%9C%A8%E4%B8%8D%E5%81%9A%E4%BB%BB%E4%BD%95%E8%B7%A8%E7%AB%99%E9%98%B2%E5%BE%A1%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E5%8F%AF%E8%83%BD%E6%B3%84%E9%9C%B2%E7%94%A8%E6%88%B7%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E7%94%9A%E8%87%B3%E5%AF%BC%E8%87%B4%E7%94%A8%E6%88%B7%E8%A2%AB%E9%92%93%E9%B1%BC%E3%80%82%E5%9B%A0%E6%AD%A4%E6%A1%86%E6%9E%B6%E7%BB%99%20JSONP%20%E9%BB%98%E8%AE%A4%E6%8F%90%E4%BE%9B%E4%BA%86%20CSRF%20%E6%A0%A1%E9%AA%8C%E6%94%AF%E6%8C%81%E5%92%8C%20referrer%20%E6%A0%A1%E9%AA%8C%E6%94%AF%E6%8C%81%E3%80%82%0A%0A%23%23%23%23%23%23%20CSRF%0A%0A%E5%9C%A8%20JSONP%20%E9%85%8D%E7%BD%AE%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AA%E9%9C%80%E8%A6%81%E6%89%93%E5%BC%80%20%60csrf%3A%20true%60%EF%BC%8C%E5%8D%B3%E5%8F%AF%E5%AF%B9%20JSONP%20%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%90%AF%20CSRF%20%E6%A0%A1%E9%AA%8C%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20jsonp%3A%20%7B%0A%20%20%20%20csrf%3A%20true%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A**%E6%B3%A8%E6%84%8F%EF%BC%8CCSRF%20%E6%A0%A1%E9%AA%8C%E4%BE%9D%E8%B5%96%E4%BA%8E%20%5Bsecurity%5D(..%2Fcore%2Fsecurity.md)%20%E6%8F%92%E4%BB%B6%E6%8F%90%E4%BE%9B%E7%9A%84%E5%9F%BA%E4%BA%8E%20Cookie%20%E7%9A%84%20CSRF%20%E6%A0%A1%E9%AA%8C%E3%80%82**%0A%0A%E5%9C%A8%E5%BC%80%E5%90%AF%20CSRF%20%E6%A0%A1%E9%AA%8C%E6%97%B6%EF%BC%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9C%A8%E5%8F%91%E8%B5%B7%20JSONP%20%E8%AF%B7%E6%B1%82%E6%97%B6%EF%BC%8C%E4%B9%9F%E8%A6%81%E5%B8%A6%E4%B8%8A%20CSRF%20token%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%8F%91%E8%B5%B7%20JSONP%20%E7%9A%84%E8%AF%B7%E6%B1%82%E6%96%B9%E6%89%80%E5%9C%A8%E7%9A%84%E9%A1%B5%E9%9D%A2%E5%92%8C%E6%88%91%E4%BB%AC%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E4%B8%BB%E5%9F%9F%E5%90%8D%E4%B9%8B%E4%B8%8B%E7%9A%84%E8%AF%9D%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%AF%BB%E5%8F%96%E5%88%B0%20Cookie%20%E4%B8%AD%E7%9A%84%20CSRF%20token%EF%BC%88%E5%9C%A8%20CSRF%20token%20%E7%BC%BA%E5%A4%B1%E6%97%B6%E4%B9%9F%E5%8F%AF%E4%BB%A5%E8%87%AA%E8%A1%8C%E8%AE%BE%E7%BD%AE%20CSRF%20token%20%E5%88%B0%20Cookie%20%E4%B8%AD%EF%BC%89%EF%BC%8C%E5%B9%B6%E5%9C%A8%E8%AF%B7%E6%B1%82%E6%97%B6%E5%B8%A6%E4%B8%8A%E8%AF%A5%20token%E3%80%82%0A%0A%23%23%23%23%23%20referrer%20%E6%A0%A1%E9%AA%8C%0A%0A%E5%A6%82%E6%9E%9C%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E4%B8%BB%E5%9F%9F%E4%B9%8B%E4%B8%8B%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%BC%80%E5%90%AF%20CSRF%20%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E6%A0%A1%E9%AA%8C%20JSONP%20%E8%AF%B7%E6%B1%82%E7%9A%84%E6%9D%A5%E6%BA%90%EF%BC%8C%E8%80%8C%E5%A6%82%E6%9E%9C%E6%83%B3%E5%AF%B9%E5%85%B6%E4%BB%96%E5%9F%9F%E5%90%8D%E7%9A%84%E7%BD%91%E9%A1%B5%E6%8F%90%E4%BE%9B%20JSONP%20%E6%9C%8D%E5%8A%A1%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%20referrer%20%E7%99%BD%E5%90%8D%E5%8D%95%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E9%99%90%E5%88%B6%20JSONP%20%E7%9A%84%E8%AF%B7%E6%B1%82%E6%96%B9%E5%9C%A8%E5%8F%AF%E6%8E%A7%E8%8C%83%E5%9B%B4%E4%B9%8B%E5%86%85%E3%80%82%0A%0A%60%60%60js%0A%2F%2Fconfig%2Fconfig.default.js%0Aexports.jsonp%20%3D%20%7B%0A%20%20whiteList%3A%20%2F%5Ehttps%3F%3A%5C%2F%5C%2Ftest.com%5C%2F%2F%2C%0A%20%20%2F%2F%20whiteList%3A%20'.test.com'%2C%0A%20%20%2F%2F%20whiteList%3A%20'sub.test.com'%2C%0A%20%20%2F%2F%20whiteList%3A%20%5B%20'sub.test.com'%2C%20'sub2.test.com'%20%5D%2C%0A%7D%3B%0A%60%60%60%0A%0A%60whiteList%60%20%E5%8F%AF%E4%BB%A5%E9%85%8D%E7%BD%AE%E4%B8%BA%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E3%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%88%96%E8%80%85%E6%95%B0%E7%BB%84%EF%BC%9A%0A%0A-%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%9A%E6%AD%A4%E6%97%B6%E5%8F%AA%E6%9C%89%E8%AF%B7%E6%B1%82%E7%9A%84%20Referrer%20%E5%8C%B9%E9%85%8D%E8%AF%A5%E6%AD%A3%E5%88%99%E6%97%B6%E6%89%8D%E5%85%81%E8%AE%B8%E8%AE%BF%E9%97%AE%20JSONP%20%E6%8E%A5%E5%8F%A3%E3%80%82%E5%9C%A8%E8%AE%BE%E7%BD%AE%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E6%B3%A8%E6%84%8F%E5%BC%80%E5%A4%B4%E7%9A%84%20%60%5E%60%20%E4%BB%A5%E5%8F%8A%E7%BB%93%E5%B0%BE%E7%9A%84%20%60%5C%2F%60%EF%BC%8C%E4%BF%9D%E8%AF%81%E5%8C%B9%E9%85%8D%E5%88%B0%E5%AE%8C%E6%95%B4%E7%9A%84%E5%9F%9F%E5%90%8D%E3%80%82%0A%0A%60%60%60js%0Aexports.jsonp%20%3D%20%7B%0A%20%20whiteList%3A%20%2F%5Ehttps%3F%3A%5C%2F%5C%2Ftest.com%5C%2F%2F%2C%0A%7D%3B%0A%2F%2F%20matches%20referrer%3A%0A%2F%2F%20https%3A%2F%2Ftest.com%2Fhello%0A%2F%2F%20http%3A%2F%2Ftest.com%2F%0A%60%60%60%0A%0A-%20%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%9A%E8%AE%BE%E7%BD%AE%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%BD%A2%E5%BC%8F%E7%9A%84%E7%99%BD%E5%90%8D%E5%8D%95%E6%97%B6%E5%88%86%E4%B8%BA%E4%B8%A4%E7%A7%8D%EF%BC%8C%E5%BD%93%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%A5%20%60.%60%20%E5%BC%80%E5%A4%B4%EF%BC%8C%E4%BE%8B%E5%A6%82%20%60.test.com%60%20%E6%97%B6%EF%BC%8C%E4%BB%A3%E8%A1%A8%20referrer%20%E7%99%BD%E5%90%8D%E5%8D%95%E4%B8%BA%20%60test.com%60%20%E7%9A%84%E6%89%80%E6%9C%89%E5%AD%90%E5%9F%9F%E5%90%8D%EF%BC%8C%E5%8C%85%E6%8B%AC%20%60test.com%60%20%E8%87%AA%E8%BA%AB%E3%80%82%E5%BD%93%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8D%E4%BB%A5%20%60.%60%20%E5%BC%80%E5%A4%B4%EF%BC%8C%E4%BE%8B%E5%A6%82%20%60sub.test.com%60%EF%BC%8C%E4%BB%A3%E8%A1%A8%20referrer%20%E7%99%BD%E5%90%8D%E5%8D%95%E4%B8%BA%20%60sub.test.com%60%20%E8%BF%99%E4%B8%80%E4%B8%AA%E5%9F%9F%E5%90%8D%E3%80%82%EF%BC%88%E5%90%8C%E6%97%B6%E6%94%AF%E6%8C%81%20HTTP%20%E5%92%8C%20HTTPS%EF%BC%89%E3%80%82%0A%0A%60%60%60js%0Aexports.jsonp%20%3D%20%7B%0A%20%20whiteList%3A%20'.test.com'%2C%0A%7D%3B%0A%2F%2F%20matches%20domain%20test.com%3A%0A%2F%2F%20https%3A%2F%2Ftest.com%2Fhello%0A%2F%2F%20http%3A%2F%2Ftest.com%2F%0A%0A%2F%2F%20matches%20subdomain%0A%2F%2F%20https%3A%2F%2Fsub.test.com%2Fhello%0A%2F%2F%20http%3A%2F%2Fsub.sub.test.com%2F%0A%0Aexports.jsonp%20%3D%20%7B%0A%20%20whiteList%3A%20'sub.test.com'%2C%0A%7D%3B%0A%2F%2F%20only%20matches%20domain%20sub.test.com%3A%0A%2F%2F%20https%3A%2F%2Fsub.test.com%2Fhello%0A%2F%2F%20http%3A%2F%2Fsub.test.com%2F%0A%60%60%60%0A%0A-%20%E6%95%B0%E7%BB%84%EF%BC%9A%E5%BD%93%E8%AE%BE%E7%BD%AE%E7%9A%84%E7%99%BD%E5%90%8D%E5%8D%95%E4%B8%BA%E6%95%B0%E7%BB%84%E6%97%B6%EF%BC%8C%E4%BB%A3%E8%A1%A8%E5%8F%AA%E8%A6%81%E6%BB%A1%E8%B6%B3%E6%95%B0%E7%BB%84%E4%B8%AD%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0%E7%9A%84%E6%9D%A1%E4%BB%B6%E5%8D%B3%E5%8F%AF%E9%80%9A%E8%BF%87%20referrer%20%E6%A0%A1%E9%AA%8C%E3%80%82%0A%0A%60%60%60js%0Aexports.jsonp%20%3D%20%7B%0A%20%20whiteList%3A%20%5B%20'sub.test.com'%2C%20'sub2.test.com'%20%5D%2C%0A%7D%3B%0A%2F%2F%20matches%20domain%20sub.test.com%20and%20sub2.test.com%3A%0A%2F%2F%20https%3A%2F%2Fsub.test.com%2Fhello%0A%2F%2F%20http%3A%2F%2Fsub2.test.com%2F%0A%60%60%60%0A%0A**%E5%BD%93%20CSRF%20%E5%92%8C%20referrer%20%E6%A0%A1%E9%AA%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%90%AF%E6%97%B6%EF%BC%8C%E8%AF%B7%E6%B1%82%E5%8F%91%E8%B5%B7%E6%96%B9%E5%8F%AA%E9%9C%80%E8%A6%81%E6%BB%A1%E8%B6%B3%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E6%9D%A1%E4%BB%B6%E5%8D%B3%E5%8F%AF%E9%80%9A%E8%BF%87%20JSONP%20%E7%9A%84%E5%AE%89%E5%85%A8%E6%A0%A1%E9%AA%8C%E3%80%82**%0A%0A%23%23%23%20%E8%AE%BE%E7%BD%AE%20Header%0A%0A%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87%E7%8A%B6%E6%80%81%E7%A0%81%E6%A0%87%E8%AF%86%E8%AF%B7%E6%B1%82%E6%88%90%E5%8A%9F%E4%B8%8E%E5%90%A6%E3%80%81%E7%8A%B6%E6%80%81%E5%A6%82%E4%BD%95%EF%BC%8C%E5%9C%A8%20body%20%E4%B8%AD%E8%AE%BE%E7%BD%AE%E5%93%8D%E5%BA%94%E7%9A%84%E5%86%85%E5%AE%B9%E3%80%82%E8%80%8C%E9%80%9A%E8%BF%87%E5%93%8D%E5%BA%94%E7%9A%84%20Header%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%BA%9B%E6%89%A9%E5%B1%95%E4%BF%A1%E6%81%AF%E3%80%82%0A%0A%E9%80%9A%E8%BF%87%20%60ctx.set(key%2C%20value)%60%20%E6%96%B9%E6%B3%95%E5%8F%AF%E4%BB%A5%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%AA%E5%93%8D%E5%BA%94%E5%A4%B4%EF%BC%8C%60ctx.set(headers)%60%20%E8%AE%BE%E7%BD%AE%E5%A4%9A%E4%B8%AA%20Header%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fapi.js%0Aclass%20ProxyController%20extends%20Controller%20%7B%0A%20%20async%20show()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20const%20start%20%3D%20Date.now()%3B%0A%20%20%20%20ctx.body%20%3D%20await%20ctx.service.post.get()%3B%0A%20%20%20%20const%20used%20%3D%20Date.now()%20-%20start%3B%0A%20%20%20%20%2F%2F%20%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%AA%E5%93%8D%E5%BA%94%E5%A4%B4%0A%20%20%20%20ctx.set('show-response-time'%2C%20used.toString())%3B%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20%E9%87%8D%E5%AE%9A%E5%90%91%0A%0A%E6%A1%86%E6%9E%B6%E9%80%9A%E8%BF%87%20security%20%E6%8F%92%E4%BB%B6%E8%A6%86%E7%9B%96%E4%BA%86%20koa%20%E5%8E%9F%E7%94%9F%E7%9A%84%20%60ctx.redirect%60%20%E5%AE%9E%E7%8E%B0%EF%BC%8C%E4%BB%A5%E6%8F%90%E4%BE%9B%E6%9B%B4%E5%8A%A0%E5%AE%89%E5%85%A8%E7%9A%84%E9%87%8D%E5%AE%9A%E5%90%91%E3%80%82%0A%0A*%20%60ctx.redirect(url)%60%20%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%9C%A8%E9%85%8D%E7%BD%AE%E7%9A%84%E7%99%BD%E5%90%8D%E5%8D%95%E5%9F%9F%E5%90%8D%E5%86%85%EF%BC%8C%E5%88%99%E7%A6%81%E6%AD%A2%E8%B7%B3%E8%BD%AC%E3%80%82%0A*%20%60ctx.unsafeRedirect(url)%60%20%E4%B8%8D%E5%88%A4%E6%96%AD%E5%9F%9F%E5%90%8D%EF%BC%8C%E7%9B%B4%E6%8E%A5%E8%B7%B3%E8%BD%AC%EF%BC%8C%E4%B8%80%E8%88%AC%E4%B8%8D%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8%EF%BC%8C%E6%98%8E%E7%A1%AE%E4%BA%86%E8%A7%A3%E5%8F%AF%E8%83%BD%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%A3%8E%E9%99%A9%E5%90%8E%E4%BD%BF%E7%94%A8%E3%80%82%0A%0A%E7%94%A8%E6%88%B7%E5%A6%82%E6%9E%9C%E4%BD%BF%E7%94%A8%60ctx.redirect%60%E6%96%B9%E6%B3%95%EF%BC%8C%E9%9C%80%E8%A6%81%E5%9C%A8%E5%BA%94%E7%94%A8%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E5%81%9A%E5%A6%82%E4%B8%8B%E9%85%8D%E7%BD%AE%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Aexports.security%20%3D%20%7B%0A%20%20domainWhiteList%3A%5B'.domain.com'%5D%2C%20%20%2F%2F%20%E5%AE%89%E5%85%A8%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%8C%E4%BB%A5%20.%20%E5%BC%80%E5%A4%B4%0A%7D%3B%0A%60%60%60%0A%0A%E8%8B%A5%E7%94%A8%E6%88%B7%E6%B2%A1%E6%9C%89%E9%85%8D%E7%BD%AE%20%60domainWhiteList%60%20%E6%88%96%E8%80%85%20%60domainWhiteList%60%E6%95%B0%E7%BB%84%E5%86%85%E4%B8%BA%E7%A9%BA%EF%BC%8C%E5%88%99%E9%BB%98%E8%AE%A4%E4%BC%9A%E5%AF%B9%E6%89%80%E6%9C%89%E8%B7%B3%E8%BD%AC%E8%AF%B7%E6%B1%82%E6%94%BE%E8%A1%8C%EF%BC%8C%E5%8D%B3%E7%AD%89%E5%90%8C%E4%BA%8E%60ctx.unsafeRedirect(url)%60%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>