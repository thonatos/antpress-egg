<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>定时任务</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>虽然我们通过框架开发的 HTTP Server 是请求响应模型的，但是仍然还会有许多场景需要执行一些定时任务，例如：</p><ol><li>定时上报应用状态。</li><li>定时从远程接口更新本地缓存。</li><li>定时进行文件切割、临时文件删除。</li></ol><p>框架提供了一套机制来让定时任务的编写和维护更加优雅。</p><h2 id="编写定时任务">编写定时任务</h2><p>所有的定时任务都统一存放在 <code>app/schedule</code> 目录下，每一个文件都是一个独立的定时任务，可以配置定时任务的属性和要执行的方法。</p><p>一个简单的例子，我们定义一个更新远程数据到内存缓存的定时任务，就可以在 <code>app/schedule</code> 目录下创建一个 <code>update_cache.js</code> 文件</p><pre><code class="language-js">const Subscription = require(&#x27;egg&#x27;).Subscription;

class UpdateCache extends Subscription {
  // 通过 schedule 属性来设置定时任务的执行间隔等配置
  static get schedule() {
    return {
      interval: &#x27;1m&#x27;, // 1 分钟间隔
      type: &#x27;all&#x27;, // 指定所有的 worker 都需要执行
    };
  }

  // subscribe 是真正定时任务执行时被运行的函数
  async subscribe() {
    const res = await this.ctx.curl(&#x27;http://www.api.com/cache&#x27;, {
      dataType: &#x27;json&#x27;,
    });
    this.ctx.app.cache = res.data;
  }
}

module.exports = UpdateCache;</code></pre><p>还可以简写为</p><pre><code class="language-js">module.exports = {
  schedule: {
    interval: &#x27;1m&#x27;, // 1 分钟间隔
    type: &#x27;all&#x27;, // 指定所有的 worker 都需要执行
  },
  async task(ctx) {
    const res = await ctx.curl(&#x27;http://www.api.com/cache&#x27;, {
      dataType: &#x27;json&#x27;,
    });
    ctx.app.cache = res.data;
  },
};</code></pre><p>这个定时任务会在每一个 Worker 进程上每 1 分钟执行一次，将远程数据请求回来挂载到 <code>app.cache</code> 上。</p><h3 id="任务">任务</h3><ul><li><code>task</code> 或 <code>subscribe</code> 同时支持 <code>generator function</code> 和 <code>async function</code>。</li><li><code>task</code> 的入参为 <code>ctx</code>，匿名的 Context 实例，可以通过它调用 <code>service</code> 等。</li></ul><h3 id="定时方式">定时方式</h3><p>定时任务可以指定 interval 或者 cron 两种不同的定时方式。</p><h4 id="interval">interval</h4><p>通过 <code>schedule.interval</code> 参数来配置定时任务的执行时机，定时任务将会每间隔指定的时间执行一次。interval 可以配置成</p><ul><li>数字类型，单位为毫秒数，例如 <code>5000</code>。</li><li>字符类型，会通过 <a href="https://github.com/zeit/ms">ms</a> 转换成毫秒数，例如 <code>5s</code>。</li></ul><pre><code class="language-js">module.exports = {
  schedule: {
    // 每 10 秒执行一次
    interval: &#x27;10s&#x27;,
  },
};</code></pre><h4 id="cron">cron</h4><p>通过 <code>schedule.cron</code> 参数来配置定时任务的执行时机，定时任务将会按照 cron 表达式在特定的时间点执行。cron 表达式通过 <a href="https://github.com/harrisiirak/cron-parser">cron-parser</a> 进行解析。</p><p><strong>注意：cron-parser 支持可选的秒（linux crontab 不支持）。</strong></p><pre><code class="language-bash">*    *    *    *    *    *
┬    ┬    ┬    ┬    ┬    ┬
│    │    │    │    │    |
│    │    │    │    │    └ day of week (0 - 7) (0 or 7 is Sun)
│    │    │    │    └───── month (1 - 12)
│    │    │    └────────── day of month (1 - 31)
│    │    └─────────────── hour (0 - 23)
│    └──────────────────── minute (0 - 59)
└───────────────────────── second (0 - 59, optional)</code></pre><pre><code class="language-js">module.exports = {
  schedule: {
    // 每三小时准点执行一次
    cron: &#x27;0 0 */3 * * *&#x27;,
  },
};</code></pre><h3 id="类型">类型</h3><p>框架提供的定时任务默认支持两种类型，worker 和 all。worker 和 all 都支持上面的两种定时方式，只是当到执行时机时，会执行定时任务的 worker 不同：</p><ul><li><code>worker</code> 类型：每台机器上只有一个 worker 会执行这个定时任务，每次执行定时任务的 worker 的选择是随机的。</li><li><code>all</code> 类型：每台机器上的每个 worker 都会执行这个定时任务。</li></ul><h3 id="其他参数">其他参数</h3><p>除了刚才介绍到的几个参数之外，定时任务还支持这些参数：</p><ul><li><code>cronOptions</code>: 配置 cron 的时区等，参见 <a href="https://github.com/harrisiirak/cron-parser#options">cron-parser</a> 文档</li><li><code>immediate</code>：配置了该参数为 true 时，这个定时任务会在应用启动并 ready 后立刻执行一次这个定时任务。</li><li><code>disable</code>：配置该参数为 true 时，这个定时任务不会被启动。</li><li><code>env</code>：数组，仅在指定的环境下才启动该定时任务。</li></ul><h3 id="执行日志">执行日志</h3><p>执行日志会输出到 <code>${appInfo.root}/logs/{app_name}/egg-schedule.log</code>，默认不会输出到控制台，可以通过 <code>config.customLogger.scheduleLogger</code> 来自定义。</p><pre><code class="language-js">// config/config.default.js
config.customLogger = {
  scheduleLogger: {
    // consoleLevel: &#x27;NONE&#x27;,
    // file: path.join(appInfo.root, &#x27;logs&#x27;, appInfo.name, &#x27;egg-schedule.log&#x27;),
  },
};</code></pre><h3 id="动态配置定时任务">动态配置定时任务</h3><p>有时候我们需要配置定时任务的参数。定时任务还有支持另一种写法：</p><pre><code class="language-js">module.exports = app =&gt; {
  return {
    schedule: {
      interval: app.config.cacheTick,
      type: &#x27;all&#x27;,
    },
    async task(ctx) {
      const res = await ctx.curl(&#x27;http://www.api.com/cache&#x27;, {
        contentType: &#x27;json&#x27;,
      });
      ctx.app.cache = res.data;
    },
  };
};</code></pre><h2 id="手动执行定时任务">手动执行定时任务</h2><p>我们可以通过 <code>app.runSchedule(schedulePath)</code> 来运行一个定时任务。<code>app.runSchedule</code> 接受一个定时任务文件路径（<code>app/schedule</code> 目录下的相对路径或者完整的绝对路径），执行对应的定时任务，返回一个 Promise。</p><p>有一些场景我们可能需要手动的执行定时任务，例如</p><ul><li>通过手动执行定时任务可以更优雅的编写对定时任务的单元测试。</li></ul><pre><code class="language-js">const mm = require(&#x27;egg-mock&#x27;);
const assert = require(&#x27;assert&#x27;);

it(&#x27;should schedule work fine&#x27;, async () =&gt; {
  const app = mm.app();
  await app.ready();
  await app.runSchedule(&#x27;update_cache&#x27;);
  assert(app.cache);
});</code></pre><ul><li>应用启动时，手动执行定时任务进行系统初始化，等初始化完毕后再启动应用。参见<a href="./app-start.md">应用启动自定义</a>章节，我们可以在 <code>app.js</code> 中编写初始化逻辑。</li></ul><pre><code class="language-js">module.exports = app =&gt; {
  app.beforeStart(async () =&gt; {
    // 保证应用启动监听端口前数据已经准备好了
    // 后续数据的更新由定时任务自动触发
    await app.runSchedule(&#x27;update_cache&#x27;);
  });
};</code></pre><h2 id="扩展定时任务类型">扩展定时任务类型</h2><p>默认框架提供的定时任务只支持每台机器的单个进程执行和全部进程执行，有些情况下，我们的服务并不是单机部署的，这时候可能有一个集群的某一个进程执行一个定时任务的需求。</p><p>框架并没有直接提供此功能，但开发者可以在上层框架自行扩展新的定时任务类型。</p><p>在 <code>agent.js</code> 中继承 <code>agent.ScheduleStrategy</code>，然后通过 <code>agent.schedule.use()</code> 注册即可：</p><pre><code class="language-js">module.exports = agent =&gt; {
  class ClusterStrategy extends agent.ScheduleStrategy {
    start() {
      // 订阅其他的分布式调度服务发送的消息，收到消息后让一个进程执行定时任务
      // 用户在定时任务的 schedule 配置中来配置分布式调度的场景（scene）
      agent.mq.subscribe(schedule.scene, () =&gt; this.sendOne());
    }
  }
  agent.schedule.use(&#x27;cluster&#x27;, ClusterStrategy);
};</code></pre><p><code>ScheduleStrategy</code> 基类提供了：</p><ul><li><code>schedule</code> - 定时任务的属性，<code>disable</code>  是默认统一支持的，其他配置可以自行解析。</li><li><code>this.sendOne(...args)</code> - 随机通知一个 worker 执行 task，<code>args</code> 会传递给 <code>subscribe(...args)</code> 或 <code>task(ctx, ...args)</code>。</li><li><code>this.sendAll(...args)</code> - 通知所有的 worker 执行 task。</li></ul></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E7%BC%96%E5%86%99%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1">编写定时任务</a><ul><li><a href="#%E4%BB%BB%E5%8A%A1">任务</a></li><li><a href="#%E5%AE%9A%E6%97%B6%E6%96%B9%E5%BC%8F">定时方式</a><ul><li><a href="#interval">interval</a></li><li><a href="#cron">cron</a></li></ul></li><li><a href="#%E7%B1%BB%E5%9E%8B">类型</a></li><li><a href="#%E5%85%B6%E4%BB%96%E5%8F%82%E6%95%B0">其他参数</a></li><li><a href="#%E6%89%A7%E8%A1%8C%E6%97%A5%E5%BF%97">执行日志</a></li><li><a href="#%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1">动态配置定时任务</a></li></ul></li><li><a href="#%E6%89%8B%E5%8A%A8%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1">手动执行定时任务</a></li><li><a href="#%E6%89%A9%E5%B1%95%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%B1%BB%E5%9E%8B">扩展定时任务类型</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E7%BC%96%E5%86%99%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%5D(%23%25E7%25BC%2596%25E5%2586%2599%25E5%25AE%259A%25E6%2597%25B6%25E4%25BB%25BB%25E5%258A%25A1)%0A%20%20*%20%5B%E4%BB%BB%E5%8A%A1%5D(%23%25E4%25BB%25BB%25E5%258A%25A1)%0A%20%20*%20%5B%E5%AE%9A%E6%97%B6%E6%96%B9%E5%BC%8F%5D(%23%25E5%25AE%259A%25E6%2597%25B6%25E6%2596%25B9%25E5%25BC%258F)%0A%20%20%20%20%2B%20%5Binterval%5D(%23interval)%0A%20%20%20%20%2B%20%5Bcron%5D(%23cron)%0A%20%20*%20%5B%E7%B1%BB%E5%9E%8B%5D(%23%25E7%25B1%25BB%25E5%259E%258B)%0A%20%20*%20%5B%E5%85%B6%E4%BB%96%E5%8F%82%E6%95%B0%5D(%23%25E5%2585%25B6%25E4%25BB%2596%25E5%258F%2582%25E6%2595%25B0)%0A%20%20*%20%5B%E6%89%A7%E8%A1%8C%E6%97%A5%E5%BF%97%5D(%23%25E6%2589%25A7%25E8%25A1%258C%25E6%2597%25A5%25E5%25BF%2597)%0A%20%20*%20%5B%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%5D(%23%25E5%258A%25A8%25E6%2580%2581%25E9%2585%258D%25E7%25BD%25AE%25E5%25AE%259A%25E6%2597%25B6%25E4%25BB%25BB%25E5%258A%25A1)%0A-%20%5B%E6%89%8B%E5%8A%A8%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%5D(%23%25E6%2589%258B%25E5%258A%25A8%25E6%2589%25A7%25E8%25A1%258C%25E5%25AE%259A%25E6%2597%25B6%25E4%25BB%25BB%25E5%258A%25A1)%0A-%20%5B%E6%89%A9%E5%B1%95%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%B1%BB%E5%9E%8B%5D(%23%25E6%2589%25A9%25E5%25B1%2595%25E5%25AE%259A%25E6%2597%25B6%25E4%25BB%25BB%25E5%258A%25A1%25E7%25B1%25BB%25E5%259E%258B)","meta":{"info":{"title":"定时任务"}},"content":"%0A%0A%0A%E8%99%BD%E7%84%B6%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87%E6%A1%86%E6%9E%B6%E5%BC%80%E5%8F%91%E7%9A%84%20HTTP%20Server%20%E6%98%AF%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94%E6%A8%A1%E5%9E%8B%E7%9A%84%EF%BC%8C%E4%BD%86%E6%98%AF%E4%BB%8D%E7%84%B6%E8%BF%98%E4%BC%9A%E6%9C%89%E8%AE%B8%E5%A4%9A%E5%9C%BA%E6%99%AF%E9%9C%80%E8%A6%81%E6%89%A7%E8%A1%8C%E4%B8%80%E4%BA%9B%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9A%0A%0A1.%20%E5%AE%9A%E6%97%B6%E4%B8%8A%E6%8A%A5%E5%BA%94%E7%94%A8%E7%8A%B6%E6%80%81%E3%80%82%0A1.%20%E5%AE%9A%E6%97%B6%E4%BB%8E%E8%BF%9C%E7%A8%8B%E6%8E%A5%E5%8F%A3%E6%9B%B4%E6%96%B0%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E3%80%82%0A1.%20%E5%AE%9A%E6%97%B6%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%88%87%E5%89%B2%E3%80%81%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E3%80%82%0A%0A%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E5%A5%97%E6%9C%BA%E5%88%B6%E6%9D%A5%E8%AE%A9%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E7%BC%96%E5%86%99%E5%92%8C%E7%BB%B4%E6%8A%A4%E6%9B%B4%E5%8A%A0%E4%BC%98%E9%9B%85%E3%80%82%0A%0A%23%23%20%E7%BC%96%E5%86%99%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%0A%0A%E6%89%80%E6%9C%89%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E9%83%BD%E7%BB%9F%E4%B8%80%E5%AD%98%E6%94%BE%E5%9C%A8%20%60app%2Fschedule%60%20%E7%9B%AE%E5%BD%95%E4%B8%8B%EF%BC%8C%E6%AF%8F%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E9%83%BD%E6%98%AF%E4%B8%80%E4%B8%AA%E7%8B%AC%E7%AB%8B%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E8%A6%81%E6%89%A7%E8%A1%8C%E7%9A%84%E6%96%B9%E6%B3%95%E3%80%82%0A%0A%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90%EF%BC%8C%E6%88%91%E4%BB%AC%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E6%9B%B4%E6%96%B0%E8%BF%9C%E7%A8%8B%E6%95%B0%E6%8D%AE%E5%88%B0%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%9C%A8%20%60app%2Fschedule%60%20%E7%9B%AE%E5%BD%95%E4%B8%8B%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20%60update_cache.js%60%20%E6%96%87%E4%BB%B6%0A%0A%60%60%60js%0Aconst%20Subscription%20%3D%20require('egg').Subscription%3B%0A%0Aclass%20UpdateCache%20extends%20Subscription%20%7B%0A%20%20%2F%2F%20%E9%80%9A%E8%BF%87%20schedule%20%E5%B1%9E%E6%80%A7%E6%9D%A5%E8%AE%BE%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C%E9%97%B4%E9%9A%94%E7%AD%89%E9%85%8D%E7%BD%AE%0A%20%20static%20get%20schedule()%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20interval%3A%20'1m'%2C%20%2F%2F%201%20%E5%88%86%E9%92%9F%E9%97%B4%E9%9A%94%0A%20%20%20%20%20%20type%3A%20'all'%2C%20%2F%2F%20%E6%8C%87%E5%AE%9A%E6%89%80%E6%9C%89%E7%9A%84%20worker%20%E9%83%BD%E9%9C%80%E8%A6%81%E6%89%A7%E8%A1%8C%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20subscribe%20%E6%98%AF%E7%9C%9F%E6%AD%A3%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E6%97%B6%E8%A2%AB%E8%BF%90%E8%A1%8C%E7%9A%84%E5%87%BD%E6%95%B0%0A%20%20async%20subscribe()%20%7B%0A%20%20%20%20const%20res%20%3D%20await%20this.ctx.curl('http%3A%2F%2Fwww.api.com%2Fcache'%2C%20%7B%0A%20%20%20%20%20%20dataType%3A%20'json'%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20this.ctx.app.cache%20%3D%20res.data%3B%0A%20%20%7D%0A%7D%0A%0Amodule.exports%20%3D%20UpdateCache%3B%0A%60%60%60%0A%0A%E8%BF%98%E5%8F%AF%E4%BB%A5%E7%AE%80%E5%86%99%E4%B8%BA%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20schedule%3A%20%7B%0A%20%20%20%20interval%3A%20'1m'%2C%20%2F%2F%201%20%E5%88%86%E9%92%9F%E9%97%B4%E9%9A%94%0A%20%20%20%20type%3A%20'all'%2C%20%2F%2F%20%E6%8C%87%E5%AE%9A%E6%89%80%E6%9C%89%E7%9A%84%20worker%20%E9%83%BD%E9%9C%80%E8%A6%81%E6%89%A7%E8%A1%8C%0A%20%20%7D%2C%0A%20%20async%20task(ctx)%20%7B%0A%20%20%20%20const%20res%20%3D%20await%20ctx.curl('http%3A%2F%2Fwww.api.com%2Fcache'%2C%20%7B%0A%20%20%20%20%20%20dataType%3A%20'json'%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20ctx.app.cache%20%3D%20res.data%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%E8%BF%99%E4%B8%AA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E4%BC%9A%E5%9C%A8%E6%AF%8F%E4%B8%80%E4%B8%AA%20Worker%20%E8%BF%9B%E7%A8%8B%E4%B8%8A%E6%AF%8F%201%20%E5%88%86%E9%92%9F%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%EF%BC%8C%E5%B0%86%E8%BF%9C%E7%A8%8B%E6%95%B0%E6%8D%AE%E8%AF%B7%E6%B1%82%E5%9B%9E%E6%9D%A5%E6%8C%82%E8%BD%BD%E5%88%B0%20%60app.cache%60%20%E4%B8%8A%E3%80%82%0A%0A%23%23%23%20%E4%BB%BB%E5%8A%A1%0A%0A-%20%60task%60%20%E6%88%96%20%60subscribe%60%20%E5%90%8C%E6%97%B6%E6%94%AF%E6%8C%81%20%60generator%20function%60%20%E5%92%8C%20%60async%20function%60%E3%80%82%0A-%20%60task%60%20%E7%9A%84%E5%85%A5%E5%8F%82%E4%B8%BA%20%60ctx%60%EF%BC%8C%E5%8C%BF%E5%90%8D%E7%9A%84%20Context%20%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%AE%83%E8%B0%83%E7%94%A8%20%60service%60%20%E7%AD%89%E3%80%82%0A%0A%23%23%23%20%E5%AE%9A%E6%97%B6%E6%96%B9%E5%BC%8F%0A%0A%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%8F%AF%E4%BB%A5%E6%8C%87%E5%AE%9A%20interval%20%E6%88%96%E8%80%85%20cron%20%E4%B8%A4%E7%A7%8D%E4%B8%8D%E5%90%8C%E7%9A%84%E5%AE%9A%E6%97%B6%E6%96%B9%E5%BC%8F%E3%80%82%0A%0A%23%23%23%23%20interval%0A%0A%E9%80%9A%E8%BF%87%20%60schedule.interval%60%20%E5%8F%82%E6%95%B0%E6%9D%A5%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C%E6%97%B6%E6%9C%BA%EF%BC%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%B0%86%E4%BC%9A%E6%AF%8F%E9%97%B4%E9%9A%94%E6%8C%87%E5%AE%9A%E7%9A%84%E6%97%B6%E9%97%B4%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%E3%80%82interval%20%E5%8F%AF%E4%BB%A5%E9%85%8D%E7%BD%AE%E6%88%90%0A%0A-%20%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B%EF%BC%8C%E5%8D%95%E4%BD%8D%E4%B8%BA%E6%AF%AB%E7%A7%92%E6%95%B0%EF%BC%8C%E4%BE%8B%E5%A6%82%20%605000%60%E3%80%82%0A-%20%E5%AD%97%E7%AC%A6%E7%B1%BB%E5%9E%8B%EF%BC%8C%E4%BC%9A%E9%80%9A%E8%BF%87%20%5Bms%5D(https%3A%2F%2Fgithub.com%2Fzeit%2Fms)%20%E8%BD%AC%E6%8D%A2%E6%88%90%E6%AF%AB%E7%A7%92%E6%95%B0%EF%BC%8C%E4%BE%8B%E5%A6%82%20%605s%60%E3%80%82%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20schedule%3A%20%7B%0A%20%20%20%20%2F%2F%20%E6%AF%8F%2010%20%E7%A7%92%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%0A%20%20%20%20interval%3A%20'10s'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%23%20cron%0A%0A%E9%80%9A%E8%BF%87%20%60schedule.cron%60%20%E5%8F%82%E6%95%B0%E6%9D%A5%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C%E6%97%B6%E6%9C%BA%EF%BC%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%B0%86%E4%BC%9A%E6%8C%89%E7%85%A7%20cron%20%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%9C%A8%E7%89%B9%E5%AE%9A%E7%9A%84%E6%97%B6%E9%97%B4%E7%82%B9%E6%89%A7%E8%A1%8C%E3%80%82cron%20%E8%A1%A8%E8%BE%BE%E5%BC%8F%E9%80%9A%E8%BF%87%20%5Bcron-parser%5D(https%3A%2F%2Fgithub.com%2Fharrisiirak%2Fcron-parser)%20%E8%BF%9B%E8%A1%8C%E8%A7%A3%E6%9E%90%E3%80%82%0A%0A**%E6%B3%A8%E6%84%8F%EF%BC%9Acron-parser%20%E6%94%AF%E6%8C%81%E5%8F%AF%E9%80%89%E7%9A%84%E7%A7%92%EF%BC%88linux%20crontab%20%E4%B8%8D%E6%94%AF%E6%8C%81%EF%BC%89%E3%80%82**%0A%0A%60%60%60bash%0A*%20%20%20%20*%20%20%20%20*%20%20%20%20*%20%20%20%20*%20%20%20%20*%0A%E2%94%AC%20%20%20%20%E2%94%AC%20%20%20%20%E2%94%AC%20%20%20%20%E2%94%AC%20%20%20%20%E2%94%AC%20%20%20%20%E2%94%AC%0A%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%7C%0A%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%94%20day%20of%20week%20(0%20-%207)%20(0%20or%207%20is%20Sun)%0A%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%20month%20(1%20-%2012)%0A%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%20day%20of%20month%20(1%20-%2031)%0A%E2%94%82%20%20%20%20%E2%94%82%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%20hour%20(0%20-%2023)%0A%E2%94%82%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%20minute%20(0%20-%2059)%0A%E2%94%94%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%20second%20(0%20-%2059%2C%20optional)%0A%60%60%60%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20schedule%3A%20%7B%0A%20%20%20%20%2F%2F%20%E6%AF%8F%E4%B8%89%E5%B0%8F%E6%97%B6%E5%87%86%E7%82%B9%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%0A%20%20%20%20cron%3A%20'0%200%20*%2F3%20*%20*%20*'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20%E7%B1%BB%E5%9E%8B%0A%0A%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E9%BB%98%E8%AE%A4%E6%94%AF%E6%8C%81%E4%B8%A4%E7%A7%8D%E7%B1%BB%E5%9E%8B%EF%BC%8Cworker%20%E5%92%8C%20all%E3%80%82worker%20%E5%92%8C%20all%20%E9%83%BD%E6%94%AF%E6%8C%81%E4%B8%8A%E9%9D%A2%E7%9A%84%E4%B8%A4%E7%A7%8D%E5%AE%9A%E6%97%B6%E6%96%B9%E5%BC%8F%EF%BC%8C%E5%8F%AA%E6%98%AF%E5%BD%93%E5%88%B0%E6%89%A7%E8%A1%8C%E6%97%B6%E6%9C%BA%E6%97%B6%EF%BC%8C%E4%BC%9A%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%20worker%20%E4%B8%8D%E5%90%8C%EF%BC%9A%0A%0A-%20%60worker%60%20%E7%B1%BB%E5%9E%8B%EF%BC%9A%E6%AF%8F%E5%8F%B0%E6%9C%BA%E5%99%A8%E4%B8%8A%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%20worker%20%E4%BC%9A%E6%89%A7%E8%A1%8C%E8%BF%99%E4%B8%AA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%EF%BC%8C%E6%AF%8F%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%20worker%20%E7%9A%84%E9%80%89%E6%8B%A9%E6%98%AF%E9%9A%8F%E6%9C%BA%E7%9A%84%E3%80%82%0A-%20%60all%60%20%E7%B1%BB%E5%9E%8B%EF%BC%9A%E6%AF%8F%E5%8F%B0%E6%9C%BA%E5%99%A8%E4%B8%8A%E7%9A%84%E6%AF%8F%E4%B8%AA%20worker%20%E9%83%BD%E4%BC%9A%E6%89%A7%E8%A1%8C%E8%BF%99%E4%B8%AA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E3%80%82%0A%0A%23%23%23%20%E5%85%B6%E4%BB%96%E5%8F%82%E6%95%B0%0A%0A%E9%99%A4%E4%BA%86%E5%88%9A%E6%89%8D%E4%BB%8B%E7%BB%8D%E5%88%B0%E7%9A%84%E5%87%A0%E4%B8%AA%E5%8F%82%E6%95%B0%E4%B9%8B%E5%A4%96%EF%BC%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%BF%98%E6%94%AF%E6%8C%81%E8%BF%99%E4%BA%9B%E5%8F%82%E6%95%B0%EF%BC%9A%0A%0A-%20%60cronOptions%60%3A%20%E9%85%8D%E7%BD%AE%20cron%20%E7%9A%84%E6%97%B6%E5%8C%BA%E7%AD%89%EF%BC%8C%E5%8F%82%E8%A7%81%20%5Bcron-parser%5D(https%3A%2F%2Fgithub.com%2Fharrisiirak%2Fcron-parser%23options)%20%E6%96%87%E6%A1%A3%0A-%20%60immediate%60%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%BA%86%E8%AF%A5%E5%8F%82%E6%95%B0%E4%B8%BA%20true%20%E6%97%B6%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E4%BC%9A%E5%9C%A8%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E5%B9%B6%20ready%20%E5%90%8E%E7%AB%8B%E5%88%BB%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%E8%BF%99%E4%B8%AA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E3%80%82%0A-%20%60disable%60%EF%BC%9A%E9%85%8D%E7%BD%AE%E8%AF%A5%E5%8F%82%E6%95%B0%E4%B8%BA%20true%20%E6%97%B6%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E4%B8%8D%E4%BC%9A%E8%A2%AB%E5%90%AF%E5%8A%A8%E3%80%82%0A-%20%60env%60%EF%BC%9A%E6%95%B0%E7%BB%84%EF%BC%8C%E4%BB%85%E5%9C%A8%E6%8C%87%E5%AE%9A%E7%9A%84%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%89%8D%E5%90%AF%E5%8A%A8%E8%AF%A5%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E3%80%82%0A%0A%23%23%23%20%E6%89%A7%E8%A1%8C%E6%97%A5%E5%BF%97%0A%0A%E6%89%A7%E8%A1%8C%E6%97%A5%E5%BF%97%E4%BC%9A%E8%BE%93%E5%87%BA%E5%88%B0%20%60%24%7BappInfo.root%7D%2Flogs%2F%7Bapp_name%7D%2Fegg-schedule.log%60%EF%BC%8C%E9%BB%98%E8%AE%A4%E4%B8%8D%E4%BC%9A%E8%BE%93%E5%87%BA%E5%88%B0%E6%8E%A7%E5%88%B6%E5%8F%B0%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60config.customLogger.scheduleLogger%60%20%E6%9D%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Aconfig.customLogger%20%3D%20%7B%0A%20%20scheduleLogger%3A%20%7B%0A%20%20%20%20%2F%2F%20consoleLevel%3A%20'NONE'%2C%0A%20%20%20%20%2F%2F%20file%3A%20path.join(appInfo.root%2C%20'logs'%2C%20appInfo.name%2C%20'egg-schedule.log')%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%0A%0A%E6%9C%89%E6%97%B6%E5%80%99%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%8F%82%E6%95%B0%E3%80%82%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%BF%98%E6%9C%89%E6%94%AF%E6%8C%81%E5%8F%A6%E4%B8%80%E7%A7%8D%E5%86%99%E6%B3%95%EF%BC%9A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20return%20%7B%0A%20%20%20%20schedule%3A%20%7B%0A%20%20%20%20%20%20interval%3A%20app.config.cacheTick%2C%0A%20%20%20%20%20%20type%3A%20'all'%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20async%20task(ctx)%20%7B%0A%20%20%20%20%20%20const%20res%20%3D%20await%20ctx.curl('http%3A%2F%2Fwww.api.com%2Fcache'%2C%20%7B%0A%20%20%20%20%20%20%20%20contentType%3A%20'json'%2C%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20ctx.app.cache%20%3D%20res.data%3B%0A%20%20%20%20%7D%2C%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20%E6%89%8B%E5%8A%A8%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%0A%0A%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60app.runSchedule(schedulePath)%60%20%E6%9D%A5%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%AA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E3%80%82%60app.runSchedule%60%20%E6%8E%A5%E5%8F%97%E4%B8%80%E4%B8%AA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%EF%BC%88%60app%2Fschedule%60%20%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84%E7%9B%B8%E5%AF%B9%E8%B7%AF%E5%BE%84%E6%88%96%E8%80%85%E5%AE%8C%E6%95%B4%E7%9A%84%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84%EF%BC%89%EF%BC%8C%E6%89%A7%E8%A1%8C%E5%AF%B9%E5%BA%94%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%EF%BC%8C%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%20Promise%E3%80%82%0A%0A%E6%9C%89%E4%B8%80%E4%BA%9B%E5%9C%BA%E6%99%AF%E6%88%91%E4%BB%AC%E5%8F%AF%E8%83%BD%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E7%9A%84%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%EF%BC%8C%E4%BE%8B%E5%A6%82%0A%0A-%20%E9%80%9A%E8%BF%87%E6%89%8B%E5%8A%A8%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%8F%AF%E4%BB%A5%E6%9B%B4%E4%BC%98%E9%9B%85%E7%9A%84%E7%BC%96%E5%86%99%E5%AF%B9%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A%60%60%60js%0Aconst%20mm%20%3D%20require('egg-mock')%3B%0Aconst%20assert%20%3D%20require('assert')%3B%0A%0Ait('should%20schedule%20work%20fine'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20const%20app%20%3D%20mm.app()%3B%0A%20%20await%20app.ready()%3B%0A%20%20await%20app.runSchedule('update_cache')%3B%0A%20%20assert(app.cache)%3B%0A%7D)%3B%0A%60%60%60%0A%0A-%20%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%97%B6%EF%BC%8C%E6%89%8B%E5%8A%A8%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%BF%9B%E8%A1%8C%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%8C%E7%AD%89%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%8C%E6%AF%95%E5%90%8E%E5%86%8D%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8%E3%80%82%E5%8F%82%E8%A7%81%5B%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E8%87%AA%E5%AE%9A%E4%B9%89%5D(.%2Fapp-start.md)%E7%AB%A0%E8%8A%82%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%9C%A8%20%60app.js%60%20%E4%B8%AD%E7%BC%96%E5%86%99%E5%88%9D%E5%A7%8B%E5%8C%96%E9%80%BB%E8%BE%91%E3%80%82%0A%0A%60%60%60js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%E4%BF%9D%E8%AF%81%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E7%9B%91%E5%90%AC%E7%AB%AF%E5%8F%A3%E5%89%8D%E6%95%B0%E6%8D%AE%E5%B7%B2%E7%BB%8F%E5%87%86%E5%A4%87%E5%A5%BD%E4%BA%86%0A%20%20%20%20%2F%2F%20%E5%90%8E%E7%BB%AD%E6%95%B0%E6%8D%AE%E7%9A%84%E6%9B%B4%E6%96%B0%E7%94%B1%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%87%AA%E5%8A%A8%E8%A7%A6%E5%8F%91%0A%20%20%20%20await%20app.runSchedule('update_cache')%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20%E6%89%A9%E5%B1%95%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%B1%BB%E5%9E%8B%0A%0A%E9%BB%98%E8%AE%A4%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%8F%AA%E6%94%AF%E6%8C%81%E6%AF%8F%E5%8F%B0%E6%9C%BA%E5%99%A8%E7%9A%84%E5%8D%95%E4%B8%AA%E8%BF%9B%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%92%8C%E5%85%A8%E9%83%A8%E8%BF%9B%E7%A8%8B%E6%89%A7%E8%A1%8C%EF%BC%8C%E6%9C%89%E4%BA%9B%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%B9%B6%E4%B8%8D%E6%98%AF%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2%E7%9A%84%EF%BC%8C%E8%BF%99%E6%97%B6%E5%80%99%E5%8F%AF%E8%83%BD%E6%9C%89%E4%B8%80%E4%B8%AA%E9%9B%86%E7%BE%A4%E7%9A%84%E6%9F%90%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E6%89%A7%E8%A1%8C%E4%B8%80%E4%B8%AA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E9%9C%80%E6%B1%82%E3%80%82%0A%0A%E6%A1%86%E6%9E%B6%E5%B9%B6%E6%B2%A1%E6%9C%89%E7%9B%B4%E6%8E%A5%E6%8F%90%E4%BE%9B%E6%AD%A4%E5%8A%9F%E8%83%BD%EF%BC%8C%E4%BD%86%E5%BC%80%E5%8F%91%E8%80%85%E5%8F%AF%E4%BB%A5%E5%9C%A8%E4%B8%8A%E5%B1%82%E6%A1%86%E6%9E%B6%E8%87%AA%E8%A1%8C%E6%89%A9%E5%B1%95%E6%96%B0%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%B1%BB%E5%9E%8B%E3%80%82%0A%0A%E5%9C%A8%20%60agent.js%60%20%E4%B8%AD%E7%BB%A7%E6%89%BF%20%60agent.ScheduleStrategy%60%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%9A%E8%BF%87%20%60agent.schedule.use()%60%20%E6%B3%A8%E5%86%8C%E5%8D%B3%E5%8F%AF%EF%BC%9A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20agent%20%3D%3E%20%7B%0A%20%20class%20ClusterStrategy%20extends%20agent.ScheduleStrategy%20%7B%0A%20%20%20%20start()%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E8%AE%A2%E9%98%85%E5%85%B6%E4%BB%96%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6%E6%9C%8D%E5%8A%A1%E5%8F%91%E9%80%81%E7%9A%84%E6%B6%88%E6%81%AF%EF%BC%8C%E6%94%B6%E5%88%B0%E6%B6%88%E6%81%AF%E5%90%8E%E8%AE%A9%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%0A%20%20%20%20%20%20%2F%2F%20%E7%94%A8%E6%88%B7%E5%9C%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%20schedule%20%E9%85%8D%E7%BD%AE%E4%B8%AD%E6%9D%A5%E9%85%8D%E7%BD%AE%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6%E7%9A%84%E5%9C%BA%E6%99%AF%EF%BC%88scene%EF%BC%89%0A%20%20%20%20%20%20agent.mq.subscribe(schedule.scene%2C%20()%20%3D%3E%20this.sendOne())%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20agent.schedule.use('cluster'%2C%20ClusterStrategy)%3B%0A%7D%3B%0A%60%60%60%0A%0A%60ScheduleStrategy%60%20%E5%9F%BA%E7%B1%BB%E6%8F%90%E4%BE%9B%E4%BA%86%EF%BC%9A%0A%0A-%20%60schedule%60%20-%20%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%B1%9E%E6%80%A7%EF%BC%8C%60disable%60%20%20%E6%98%AF%E9%BB%98%E8%AE%A4%E7%BB%9F%E4%B8%80%E6%94%AF%E6%8C%81%E7%9A%84%EF%BC%8C%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE%E5%8F%AF%E4%BB%A5%E8%87%AA%E8%A1%8C%E8%A7%A3%E6%9E%90%E3%80%82%0A-%20%60this.sendOne(...args)%60%20-%20%E9%9A%8F%E6%9C%BA%E9%80%9A%E7%9F%A5%E4%B8%80%E4%B8%AA%20worker%20%E6%89%A7%E8%A1%8C%20task%EF%BC%8C%60args%60%20%E4%BC%9A%E4%BC%A0%E9%80%92%E7%BB%99%20%60subscribe(...args)%60%20%E6%88%96%20%60task(ctx%2C%20...args)%60%E3%80%82%0A-%20%60this.sendAll(...args)%60%20-%20%E9%80%9A%E7%9F%A5%E6%89%80%E6%9C%89%E7%9A%84%20worker%20%E6%89%A7%E8%A1%8C%20task%E3%80%82%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>