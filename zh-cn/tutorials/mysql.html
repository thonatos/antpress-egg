<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>MySQL</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>在 Web 应用方面 MySQL 是最常见，最好的关系型数据库之一。非常多网站都选择 MySQL 作为网站数据库。</p><h2 id="egg-mysql">egg-mysql</h2><p>框架提供了 <a href="https://github.com/eggjs/egg-mysql">egg-mysql</a> 插件来访问 MySQL 数据库。这个插件既可以访问普通的 MySQL 数据库，也可以访问基于 MySQL 协议的在线数据库服务。</p><h3 id="安装与配置">安装与配置</h3><p>安装对应的插件 <a href="https://github.com/eggjs/egg-mysql">egg-mysql</a> ：</p><pre><code class="language-bash">$ npm i --save egg-mysql</code></pre><p>开启插件：</p><pre><code class="language-js">// config/plugin.js
exports.mysql = {
  enable: true,
  package: &#x27;egg-mysql&#x27;,
};</code></pre><p>在 <code>config/config.${env}.js</code> 配置各个环境的数据库连接信息。</p><h4 id="单数据源">单数据源</h4><p>如果我们的应用只需要访问一个 MySQL 数据库实例，可以如下配置：</p><pre><code class="language-js">// config/config.${env}.js
exports.mysql = {
  // 单数据库信息配置
  client: {
    // host
    host: &#x27;mysql.com&#x27;,
    // 端口号
    port: &#x27;3306&#x27;,
    // 用户名
    user: &#x27;test_user&#x27;,
    // 密码
    password: &#x27;test_password&#x27;,
    // 数据库名
    database: &#x27;test&#x27;,
  },
  // 是否加载到 app 上，默认开启
  app: true,
  // 是否加载到 agent 上，默认关闭
  agent: false,
};</code></pre><p>使用方式：</p><pre><code class="language-js">await app.mysql.query(sql, values); // 单实例可以直接通过 app.mysql 访问</code></pre><h4 id="多数据源">多数据源</h4><p>如果我们的应用需要访问多个 MySQL 数据源，可以按照如下配置：</p><pre><code class="language-js">exports.mysql = {
  clients: {
    // clientId, 获取client实例，需要通过 app.mysql.get(&#x27;clientId&#x27;) 获取
    db1: {
      // host
      host: &#x27;mysql.com&#x27;,
      // 端口号
      port: &#x27;3306&#x27;,
      // 用户名
      user: &#x27;test_user&#x27;,
      // 密码
      password: &#x27;test_password&#x27;,
      // 数据库名
      database: &#x27;test&#x27;,
    },
    db2: {
      // host
      host: &#x27;mysql2.com&#x27;,
      // 端口号
      port: &#x27;3307&#x27;,
      // 用户名
      user: &#x27;test_user&#x27;,
      // 密码
      password: &#x27;test_password&#x27;,
      // 数据库名
      database: &#x27;test&#x27;,
    },
    // ...
  },
  // 所有数据库配置的默认值
  default: {

  },

  // 是否加载到 app 上，默认开启
  app: true,
  // 是否加载到 agent 上，默认关闭
  agent: false,
};</code></pre><p>使用方式：</p><pre><code class="language-js">const client1 = app.mysql.get(&#x27;db1&#x27;);
await client1.query(sql, values);

const client2 = app.mysql.get(&#x27;db2&#x27;);
await client2.query(sql, values);</code></pre><h4 id="动态创建">动态创建</h4><p>我们可以不需要将配置提前申明在配置文件中，而是在应用运行时动态的从配置中心获取实际的参数，再来初始化一个实例。</p><pre><code class="language-js">// {app_root}/app.js
module.exports = app =&gt; {
  app.beforeStart(async () =&gt; {
    // 从配置中心获取 MySQL 的配置
    // { host: &#x27;mysql.com&#x27;, port: &#x27;3306&#x27;, user: &#x27;test_user&#x27;, password: &#x27;test_password&#x27;, database: &#x27;test&#x27; }
    const mysqlConfig = await app.configCenter.fetch(&#x27;mysql&#x27;);
    app.database = app.mysql.createInstance(mysqlConfig);
  });
};</code></pre><h2 id="service-层">Service 层</h2><p>由于对 MySQL 数据库的访问操作属于 Web 层中的数据处理层，因此我们强烈建议将这部分代码放在 Service 层中维护。</p><p>下面是一个 Service 中访问 MySQL 数据库的例子。</p><p>更多 Service 层的介绍，可以参考 <a href="../basics/service.md">Service</a></p><pre><code class="language-js">// app/service/user.js
class UserService extends Service {
  async find(uid) {
    // 假如 我们拿到用户 id 从数据库获取用户详细信息
    const user = await this.app.mysql.get(&#x27;users&#x27;, { id: 11 });
    return { user };
  }
}</code></pre><p>之后可以通过 Controller 获取 Service 层拿到的数据。</p><pre><code class="language-js">// app/controller/user.js
class UserController extends Controller {
  async info() {
    const ctx = this.ctx;
    const userId = ctx.params.id;
    const user = await ctx.service.user.find(userId);
    ctx.body = user;
  }
}</code></pre><h2 id="如何编写-crud-语句">如何编写 CRUD 语句</h2><p>下面的语句若没有特殊注明，默认都书写在 <code>app/service</code> 下。</p><h3 id="create">Create</h3><p>可以直接使用 <code>insert</code> 方法插入一条记录。</p><pre><code class="language-js">// 插入
const result = await this.app.mysql.insert(&#x27;posts&#x27;, { title: &#x27;Hello World&#x27; }); // 在 post 表中，插入 title 为 Hello World 的记录

=&gt; INSERT INTO `posts`(`title`) VALUES(&#x27;Hello World&#x27;);

console.log(result);
=&gt;
{
  fieldCount: 0,
  affectedRows: 1,
  insertId: 3710,
  serverStatus: 2,
  warningCount: 2,
  message: &#x27;&#x27;,
  protocol41: true,
  changedRows: 0
}

// 判断插入成功
const insertSuccess = result.affectedRows === 1;</code></pre><h3 id="read">Read</h3><p>可以直接使用 <code>get</code> 方法或 <code>select</code> 方法获取一条或多条记录。<code>select</code> 方法支持条件查询与结果的定制。</p><ul><li>查询一条记录</li></ul><pre><code class="language-js">const post = await this.app.mysql.get(&#x27;posts&#x27;, { id: 12 });

=&gt; SELECT * FROM `posts` WHERE `id` = 12 LIMIT 0, 1;</code></pre><ul><li>查询全表</li></ul><pre><code class="language-js">const results = await this.app.mysql.select(&#x27;posts&#x27;);

=&gt; SELECT * FROM `posts`;</code></pre><ul><li>条件查询和结果定制</li></ul><pre><code class="language-js">const results = await this.app.mysql.select(&#x27;posts&#x27;, { // 搜索 post 表
  where: { status: &#x27;draft&#x27;, author: [&#x27;author1&#x27;, &#x27;author2&#x27;] }, // WHERE 条件
  columns: [&#x27;author&#x27;, &#x27;title&#x27;], // 要查询的表字段
  orders: [[&#x27;created_at&#x27;,&#x27;desc&#x27;], [&#x27;id&#x27;,&#x27;desc&#x27;]], // 排序方式
  limit: 10, // 返回数据量
  offset: 0, // 数据偏移量
});

=&gt; SELECT `author`, `title` FROM `posts`
  WHERE `status` = &#x27;draft&#x27; AND `author` IN(&#x27;author1&#x27;,&#x27;author2&#x27;)
  ORDER BY `created_at` DESC, `id` DESC LIMIT 0, 10;</code></pre><h3 id="update">Update</h3><p>可以直接使用 <code>update</code> 方法更新数据库记录。</p><pre><code class="language-js">// 修改数据，将会根据主键 ID 查找，并更新
const row = {
  id: 123,
  name: &#x27;fengmk2&#x27;,
  otherField: &#x27;other field value&#x27;,    // any other fields u want to update
  modifiedAt: this.app.mysql.literals.now, // `now()` on db server
};
const result = await this.app.mysql.update(&#x27;posts&#x27;, row); // 更新 posts 表中的记录

=&gt; UPDATE `posts` SET `name` = &#x27;fengmk2&#x27;, `modifiedAt` = NOW() WHERE id = 123 ;

// 判断更新成功
const updateSuccess = result.affectedRows === 1;

// 如果主键是自定义的 ID 名称，如 custom_id，则需要在 `where` 里面配置
const row = {
  name: &#x27;fengmk2&#x27;,
  otherField: &#x27;other field value&#x27;,    // any other fields u want to update
  modifiedAt: this.app.mysql.literals.now, // `now()` on db server
};

const options = {
  where: {
    custom_id: 456
  }
};
const result = await this.app.mysql.update(&#x27;posts&#x27;, row, options); // 更新 posts 表中的记录

=&gt; UPDATE `posts` SET `name` = &#x27;fengmk2&#x27;, `modifiedAt` = NOW() WHERE custom_id = 456 ;

// 判断更新成功
const updateSuccess = result.affectedRows === 1;</code></pre><h3 id="delete">Delete</h3><p>可以直接使用 <code>delete</code> 方法删除数据库记录。</p><pre><code class="language-js">const result = await this.app.mysql.delete(&#x27;posts&#x27;, {
  author: &#x27;fengmk2&#x27;,
});

=&gt; DELETE FROM `posts` WHERE `author` = &#x27;fengmk2&#x27;;</code></pre><h2 id="直接执行-sql-语句">直接执行 sql 语句</h2><p>插件本身也支持拼接与直接执行 sql 语句。使用 <code>query</code> 可以执行合法的 sql 语句。</p><p><strong>注意！！我们极其不建议开发者拼接 sql 语句，这样很容易引起 sql 注入！！</strong></p><p>如果必须要自己拼接 sql 语句，请使用 <code>mysql.escape</code> 方法。</p><p>参考 <a href="http://stackoverflow.com/questions/15778572/preventing-sql-injection-in-node-js">preventing-sql-injection-in-node-js</a></p><pre><code class="language-js">const postId = 1;
const results = await this.app.mysql.query(&#x27;update posts set hits = (hits + ?) where id = ?&#x27;, [1, postId]);

=&gt; update posts set hits = (hits + 1) where id = 1;</code></pre><h2 id="使用事务">使用事务</h2><p>MySQL 事务主要用于处理操作量大，复杂度高的数据。比如说，在人员管理系统中，你删除一个人员，你既需要删除人员的基本资料，也要删除和该人员相关的信息，如信箱，文章等等。这时候使用事务处理可以方便管理这一组操作。
一个事务将一组连续的数据库操作，放在一个单一的工作单元来执行。该组内的每个单独的操作是成功，事务才能成功。如果事务中的任何操作失败，则整个事务将失败。</p><p>一般来说，事务是必须满足4个条件（ACID）： Atomicity（原子性）、Consistency（一致性）、Isolation（隔离性）、Durability（可靠性）</p><ul><li>原子性：确保事务内的所有操作都成功完成，否则事务将被中止在故障点，以前的操作将回滚到以前的状态。</li><li>一致性：对于数据库的修改是一致的。</li><li>隔离性：事务是彼此独立的，不互相影响</li><li>持久性：确保提交事务后，事务产生的结果可以永久存在。</li></ul><p>因此，对于一个事务来讲，一定伴随着 beginTransaction、commit 或 rollback，分别代表事务的开始，成功和失败回滚。</p><p>egg-mysql 提供了两种类型的事务。</p><h3 id="手动控制">手动控制</h3><ul><li>优点：<code>beginTransaction</code>, <code>commit</code> 或 <code>rollback</code> 都由开发者来完全控制，可以做到非常细粒度的控制。</li><li>缺点：手写代码比较多，不是每个人都能写好。忘记了捕获异常和 cleanup 都会导致严重 bug。</li></ul><pre><code class="language-js">const conn = await app.mysql.beginTransaction(); // 初始化事务

try {
  await conn.insert(table, row1);  // 第一步操作
  await conn.update(table, row2);  // 第二步操作
  await conn.commit(); // 提交事务
} catch (err) {
  // error, rollback
  await conn.rollback(); // 一定记得捕获异常后回滚事务！！
  throw err;
}</code></pre><h3 id="自动控制transaction-with-scope">自动控制：Transaction with scope</h3><ul><li>API：<code>beginTransactionScope(scope, ctx)</code><ul><li><code>scope</code>: 一个 generatorFunction，在这个函数里面执行这次事务的所有 sql 语句。</li><li><code>ctx</code>: 当前请求的上下文对象，传入 ctx 可以保证即便在出现事务嵌套的情况下，一次请求中同时只有一个激活状态的事务。</li></ul></li><li>优点：使用简单，不容易犯错，就感觉事务不存在的样子。</li><li>缺点：整个事务要么成功，要么失败，无法做细粒度控制。</li></ul><pre><code class="language-js">const result = await app.mysql.beginTransactionScope(async conn =&gt; {
  // don&#x27;t commit or rollback by yourself
  await conn.insert(table, row1);
  await conn.update(table, row2);
  return { success: true };
}, ctx); // ctx 是当前请求的上下文，如果是在 service 文件中，可以从 `this.ctx` 获取到
// if error throw on scope, will auto rollback</code></pre><h2 id="表达式literal">表达式(Literal)</h2><p>如果需要调用 MySQL 内置的函数（或表达式），可以使用 <code>Literal</code>。</p><h3 id="内置表达式">内置表达式</h3><ul><li><code>NOW()</code>：数据库当前系统时间，通过 <code>app.mysql.literals.now</code> 获取。</li></ul><pre><code class="language-js">await this.app.mysql.insert(table, {
  create_time: this.app.mysql.literals.now,
});

=&gt; INSERT INTO `$table`(`create_time`) VALUES(NOW())</code></pre><h3 id="自定义表达式">自定义表达式</h3><p>下例展示了如何调用 MySQL 内置的 <code>CONCAT(s1, ...sn)</code> 函数，做字符串拼接。</p><pre><code class="language-js">const Literal = this.app.mysql.literals.Literal;
const first = &#x27;James&#x27;;
const last = &#x27;Bond&#x27;;
await this.app.mysql.insert(table, {
  id: 123,
  fullname: new Literal(`CONCAT(&quot;${first}&quot;, &quot;${last}&quot;`),
});

=&gt; INSERT INTO `$table`(`id`, `fullname`) VALUES(123, CONCAT(&quot;James&quot;, &quot;Bond&quot;))</code></pre></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#egg-mysql">egg-mysql</a><ul><li><a href="#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE">安装与配置</a><ul><li><a href="#%E5%8D%95%E6%95%B0%E6%8D%AE%E6%BA%90">单数据源</a></li><li><a href="#%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90">多数据源</a></li><li><a href="#%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA">动态创建</a></li></ul></li></ul></li><li><a href="#service-%E5%B1%82">Service 层</a></li><li><a href="#%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99-crud-%E8%AF%AD%E5%8F%A5">如何编写 CRUD 语句</a><ul><li><a href="#create">Create</a></li><li><a href="#read">Read</a></li><li><a href="#update">Update</a></li><li><a href="#delete">Delete</a></li></ul></li><li><a href="#%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C-sql-%E8%AF%AD%E5%8F%A5">直接执行 sql 语句</a></li><li><a href="#%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1">使用事务</a><ul><li><a href="#%E6%89%8B%E5%8A%A8%E6%8E%A7%E5%88%B6">手动控制</a></li><li><a href="#%E8%87%AA%E5%8A%A8%E6%8E%A7%E5%88%B6transaction-with-scope">自动控制：Transaction with scope</a></li></ul></li><li><a href="#%E8%A1%A8%E8%BE%BE%E5%BC%8Fliteral">表达式(Literal)</a><ul><li><a href="#%E5%86%85%E7%BD%AE%E8%A1%A8%E8%BE%BE%E5%BC%8F">内置表达式</a></li><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8%E8%BE%BE%E5%BC%8F">自定义表达式</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5Begg-mysql%5D(%23egg-mysql)%0A%20%20*%20%5B%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE%5D(%23%25E5%25AE%2589%25E8%25A3%2585%25E4%25B8%258E%25E9%2585%258D%25E7%25BD%25AE)%0A%20%20%20%20%2B%20%5B%E5%8D%95%E6%95%B0%E6%8D%AE%E6%BA%90%5D(%23%25E5%258D%2595%25E6%2595%25B0%25E6%258D%25AE%25E6%25BA%2590)%0A%20%20%20%20%2B%20%5B%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%5D(%23%25E5%25A4%259A%25E6%2595%25B0%25E6%258D%25AE%25E6%25BA%2590)%0A%20%20%20%20%2B%20%5B%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%5D(%23%25E5%258A%25A8%25E6%2580%2581%25E5%2588%259B%25E5%25BB%25BA)%0A-%20%5BService%20%E5%B1%82%5D(%23service-%25E5%25B1%2582)%0A-%20%5B%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%20CRUD%20%E8%AF%AD%E5%8F%A5%5D(%23%25E5%25A6%2582%25E4%25BD%2595%25E7%25BC%2596%25E5%2586%2599-crud-%25E8%25AF%25AD%25E5%258F%25A5)%0A%20%20*%20%5BCreate%5D(%23create)%0A%20%20*%20%5BRead%5D(%23read)%0A%20%20*%20%5BUpdate%5D(%23update)%0A%20%20*%20%5BDelete%5D(%23delete)%0A-%20%5B%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C%20sql%20%E8%AF%AD%E5%8F%A5%5D(%23%25E7%259B%25B4%25E6%258E%25A5%25E6%2589%25A7%25E8%25A1%258C-sql-%25E8%25AF%25AD%25E5%258F%25A5)%0A-%20%5B%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1%5D(%23%25E4%25BD%25BF%25E7%2594%25A8%25E4%25BA%258B%25E5%258A%25A1)%0A%20%20*%20%5B%E6%89%8B%E5%8A%A8%E6%8E%A7%E5%88%B6%5D(%23%25E6%2589%258B%25E5%258A%25A8%25E6%258E%25A7%25E5%2588%25B6)%0A%20%20*%20%5B%E8%87%AA%E5%8A%A8%E6%8E%A7%E5%88%B6%EF%BC%9ATransaction%20with%20scope%5D(%23%25E8%2587%25AA%25E5%258A%25A8%25E6%258E%25A7%25E5%2588%25B6transaction-with-scope)%0A-%20%5B%E8%A1%A8%E8%BE%BE%E5%BC%8F(Literal)%5D(%23%25E8%25A1%25A8%25E8%25BE%25BE%25E5%25BC%258Fliteral)%0A%20%20*%20%5B%E5%86%85%E7%BD%AE%E8%A1%A8%E8%BE%BE%E5%BC%8F%5D(%23%25E5%2586%2585%25E7%25BD%25AE%25E8%25A1%25A8%25E8%25BE%25BE%25E5%25BC%258F)%0A%20%20*%20%5B%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8%E8%BE%BE%E5%BC%8F%5D(%23%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589%25E8%25A1%25A8%25E8%25BE%25BE%25E5%25BC%258F)","meta":{"info":{"title":"MySQL"}},"content":"%0A%0A%0A%E5%9C%A8%20Web%20%E5%BA%94%E7%94%A8%E6%96%B9%E9%9D%A2%20MySQL%20%E6%98%AF%E6%9C%80%E5%B8%B8%E8%A7%81%EF%BC%8C%E6%9C%80%E5%A5%BD%E7%9A%84%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%B8%80%E3%80%82%E9%9D%9E%E5%B8%B8%E5%A4%9A%E7%BD%91%E7%AB%99%E9%83%BD%E9%80%89%E6%8B%A9%20MySQL%20%E4%BD%9C%E4%B8%BA%E7%BD%91%E7%AB%99%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%82%0A%0A%23%23%20egg-mysql%0A%0A%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E4%BA%86%20%5Begg-mysql%5D%20%E6%8F%92%E4%BB%B6%E6%9D%A5%E8%AE%BF%E9%97%AE%20MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%82%E8%BF%99%E4%B8%AA%E6%8F%92%E4%BB%B6%E6%97%A2%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E6%99%AE%E9%80%9A%E7%9A%84%20MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E5%9F%BA%E4%BA%8E%20MySQL%20%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%9C%A8%E7%BA%BF%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E3%80%82%0A%0A%23%23%23%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE%0A%0A%E5%AE%89%E8%A3%85%E5%AF%B9%E5%BA%94%E7%9A%84%E6%8F%92%E4%BB%B6%20%5Begg-mysql%5D%20%EF%BC%9A%0A%0A%60%60%60bash%0A%24%20npm%20i%20--save%20egg-mysql%0A%60%60%60%0A%0A%E5%BC%80%E5%90%AF%E6%8F%92%E4%BB%B6%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fplugin.js%0Aexports.mysql%20%3D%20%7B%0A%20%20enable%3A%20true%2C%0A%20%20package%3A%20'egg-mysql'%2C%0A%7D%3B%0A%60%60%60%0A%0A%E5%9C%A8%20%60config%2Fconfig.%24%7Benv%7D.js%60%20%E9%85%8D%E7%BD%AE%E5%90%84%E4%B8%AA%E7%8E%AF%E5%A2%83%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E4%BF%A1%E6%81%AF%E3%80%82%0A%0A%23%23%23%23%20%E5%8D%95%E6%95%B0%E6%8D%AE%E6%BA%90%0A%0A%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E7%9A%84%E5%BA%94%E7%94%A8%E5%8F%AA%E9%9C%80%E8%A6%81%E8%AE%BF%E9%97%AE%E4%B8%80%E4%B8%AA%20MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%A6%82%E4%B8%8B%E9%85%8D%E7%BD%AE%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.%24%7Benv%7D.js%0Aexports.mysql%20%3D%20%7B%0A%20%20%2F%2F%20%E5%8D%95%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE%0A%20%20client%3A%20%7B%0A%20%20%20%20%2F%2F%20host%0A%20%20%20%20host%3A%20'mysql.com'%2C%0A%20%20%20%20%2F%2F%20%E7%AB%AF%E5%8F%A3%E5%8F%B7%0A%20%20%20%20port%3A%20'3306'%2C%0A%20%20%20%20%2F%2F%20%E7%94%A8%E6%88%B7%E5%90%8D%0A%20%20%20%20user%3A%20'test_user'%2C%0A%20%20%20%20%2F%2F%20%E5%AF%86%E7%A0%81%0A%20%20%20%20password%3A%20'test_password'%2C%0A%20%20%20%20%2F%2F%20%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8D%0A%20%20%20%20database%3A%20'test'%2C%0A%20%20%7D%2C%0A%20%20%2F%2F%20%E6%98%AF%E5%90%A6%E5%8A%A0%E8%BD%BD%E5%88%B0%20app%20%E4%B8%8A%EF%BC%8C%E9%BB%98%E8%AE%A4%E5%BC%80%E5%90%AF%0A%20%20app%3A%20true%2C%0A%20%20%2F%2F%20%E6%98%AF%E5%90%A6%E5%8A%A0%E8%BD%BD%E5%88%B0%20agent%20%E4%B8%8A%EF%BC%8C%E9%BB%98%E8%AE%A4%E5%85%B3%E9%97%AD%0A%20%20agent%3A%20false%2C%0A%7D%3B%0A%60%60%60%0A%0A%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%EF%BC%9A%0A%0A%60%60%60js%0Aawait%20app.mysql.query(sql%2C%20values)%3B%20%2F%2F%20%E5%8D%95%E5%AE%9E%E4%BE%8B%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E9%80%9A%E8%BF%87%20app.mysql%20%E8%AE%BF%E9%97%AE%0A%60%60%60%0A%0A%23%23%23%23%20%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%0A%0A%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E7%9A%84%E5%BA%94%E7%94%A8%E9%9C%80%E8%A6%81%E8%AE%BF%E9%97%AE%E5%A4%9A%E4%B8%AA%20MySQL%20%E6%95%B0%E6%8D%AE%E6%BA%90%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%8C%89%E7%85%A7%E5%A6%82%E4%B8%8B%E9%85%8D%E7%BD%AE%EF%BC%9A%0A%0A%60%60%60js%0Aexports.mysql%20%3D%20%7B%0A%20%20clients%3A%20%7B%0A%20%20%20%20%2F%2F%20clientId%2C%20%E8%8E%B7%E5%8F%96client%E5%AE%9E%E4%BE%8B%EF%BC%8C%E9%9C%80%E8%A6%81%E9%80%9A%E8%BF%87%20app.mysql.get('clientId')%20%E8%8E%B7%E5%8F%96%0A%20%20%20%20db1%3A%20%7B%0A%20%20%20%20%20%20%2F%2F%20host%0A%20%20%20%20%20%20host%3A%20'mysql.com'%2C%0A%20%20%20%20%20%20%2F%2F%20%E7%AB%AF%E5%8F%A3%E5%8F%B7%0A%20%20%20%20%20%20port%3A%20'3306'%2C%0A%20%20%20%20%20%20%2F%2F%20%E7%94%A8%E6%88%B7%E5%90%8D%0A%20%20%20%20%20%20user%3A%20'test_user'%2C%0A%20%20%20%20%20%20%2F%2F%20%E5%AF%86%E7%A0%81%0A%20%20%20%20%20%20password%3A%20'test_password'%2C%0A%20%20%20%20%20%20%2F%2F%20%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8D%0A%20%20%20%20%20%20database%3A%20'test'%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20db2%3A%20%7B%0A%20%20%20%20%20%20%2F%2F%20host%0A%20%20%20%20%20%20host%3A%20'mysql2.com'%2C%0A%20%20%20%20%20%20%2F%2F%20%E7%AB%AF%E5%8F%A3%E5%8F%B7%0A%20%20%20%20%20%20port%3A%20'3307'%2C%0A%20%20%20%20%20%20%2F%2F%20%E7%94%A8%E6%88%B7%E5%90%8D%0A%20%20%20%20%20%20user%3A%20'test_user'%2C%0A%20%20%20%20%20%20%2F%2F%20%E5%AF%86%E7%A0%81%0A%20%20%20%20%20%20password%3A%20'test_password'%2C%0A%20%20%20%20%20%20%2F%2F%20%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8D%0A%20%20%20%20%20%20database%3A%20'test'%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20%2F%2F%20...%0A%20%20%7D%2C%0A%20%20%2F%2F%20%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC%0A%20%20default%3A%20%7B%0A%0A%20%20%7D%2C%0A%0A%20%20%2F%2F%20%E6%98%AF%E5%90%A6%E5%8A%A0%E8%BD%BD%E5%88%B0%20app%20%E4%B8%8A%EF%BC%8C%E9%BB%98%E8%AE%A4%E5%BC%80%E5%90%AF%0A%20%20app%3A%20true%2C%0A%20%20%2F%2F%20%E6%98%AF%E5%90%A6%E5%8A%A0%E8%BD%BD%E5%88%B0%20agent%20%E4%B8%8A%EF%BC%8C%E9%BB%98%E8%AE%A4%E5%85%B3%E9%97%AD%0A%20%20agent%3A%20false%2C%0A%7D%3B%0A%60%60%60%0A%0A%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%EF%BC%9A%0A%0A%60%60%60js%0Aconst%20client1%20%3D%20app.mysql.get('db1')%3B%0Aawait%20client1.query(sql%2C%20values)%3B%0A%0Aconst%20client2%20%3D%20app.mysql.get('db2')%3B%0Aawait%20client2.query(sql%2C%20values)%3B%0A%60%60%60%0A%0A%23%23%23%23%20%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%0A%0A%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%B8%8D%E9%9C%80%E8%A6%81%E5%B0%86%E9%85%8D%E7%BD%AE%E6%8F%90%E5%89%8D%E7%94%B3%E6%98%8E%E5%9C%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%EF%BC%8C%E8%80%8C%E6%98%AF%E5%9C%A8%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8A%A8%E6%80%81%E7%9A%84%E4%BB%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%8E%B7%E5%8F%96%E5%AE%9E%E9%99%85%E7%9A%84%E5%8F%82%E6%95%B0%EF%BC%8C%E5%86%8D%E6%9D%A5%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20%7Bapp_root%7D%2Fapp.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%E4%BB%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%8E%B7%E5%8F%96%20MySQL%20%E7%9A%84%E9%85%8D%E7%BD%AE%0A%20%20%20%20%2F%2F%20%7B%20host%3A%20'mysql.com'%2C%20port%3A%20'3306'%2C%20user%3A%20'test_user'%2C%20password%3A%20'test_password'%2C%20database%3A%20'test'%20%7D%0A%20%20%20%20const%20mysqlConfig%20%3D%20await%20app.configCenter.fetch('mysql')%3B%0A%20%20%20%20app.database%20%3D%20app.mysql.createInstance(mysqlConfig)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20Service%20%E5%B1%82%0A%0A%E7%94%B1%E4%BA%8E%E5%AF%B9%20MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E8%AE%BF%E9%97%AE%E6%93%8D%E4%BD%9C%E5%B1%9E%E4%BA%8E%20Web%20%E5%B1%82%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%B1%82%EF%BC%8C%E5%9B%A0%E6%AD%A4%E6%88%91%E4%BB%AC%E5%BC%BA%E7%83%88%E5%BB%BA%E8%AE%AE%E5%B0%86%E8%BF%99%E9%83%A8%E5%88%86%E4%BB%A3%E7%A0%81%E6%94%BE%E5%9C%A8%20Service%20%E5%B1%82%E4%B8%AD%E7%BB%B4%E6%8A%A4%E3%80%82%0A%0A%E4%B8%8B%E9%9D%A2%E6%98%AF%E4%B8%80%E4%B8%AA%20Service%20%E4%B8%AD%E8%AE%BF%E9%97%AE%20MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E4%BE%8B%E5%AD%90%E3%80%82%0A%0A%E6%9B%B4%E5%A4%9A%20Service%20%E5%B1%82%E7%9A%84%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83%20%5BService%5D(..%2Fbasics%2Fservice.md)%0A%0A%60%60%60js%0A%2F%2F%20app%2Fservice%2Fuser.js%0Aclass%20UserService%20extends%20Service%20%7B%0A%20%20async%20find(uid)%20%7B%0A%20%20%20%20%2F%2F%20%E5%81%87%E5%A6%82%20%E6%88%91%E4%BB%AC%E6%8B%BF%E5%88%B0%E7%94%A8%E6%88%B7%20id%20%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF%0A%20%20%20%20const%20user%20%3D%20await%20this.app.mysql.get('users'%2C%20%7B%20id%3A%2011%20%7D)%3B%0A%20%20%20%20return%20%7B%20user%20%7D%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E4%B9%8B%E5%90%8E%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20Controller%20%E8%8E%B7%E5%8F%96%20Service%20%E5%B1%82%E6%8B%BF%E5%88%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fuser.js%0Aclass%20UserController%20extends%20Controller%20%7B%0A%20%20async%20info()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20const%20userId%20%3D%20ctx.params.id%3B%0A%20%20%20%20const%20user%20%3D%20await%20ctx.service.user.find(userId)%3B%0A%20%20%20%20ctx.body%20%3D%20user%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%20%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%20CRUD%20%E8%AF%AD%E5%8F%A5%0A%0A%E4%B8%8B%E9%9D%A2%E7%9A%84%E8%AF%AD%E5%8F%A5%E8%8B%A5%E6%B2%A1%E6%9C%89%E7%89%B9%E6%AE%8A%E6%B3%A8%E6%98%8E%EF%BC%8C%E9%BB%98%E8%AE%A4%E9%83%BD%E4%B9%A6%E5%86%99%E5%9C%A8%20%60app%2Fservice%60%20%E4%B8%8B%E3%80%82%0A%0A%23%23%23%20Create%0A%0A%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%20%60insert%60%20%E6%96%B9%E6%B3%95%E6%8F%92%E5%85%A5%E4%B8%80%E6%9D%A1%E8%AE%B0%E5%BD%95%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20%E6%8F%92%E5%85%A5%0Aconst%20result%20%3D%20await%20this.app.mysql.insert('posts'%2C%20%7B%20title%3A%20'Hello%20World'%20%7D)%3B%20%2F%2F%20%E5%9C%A8%20post%20%E8%A1%A8%E4%B8%AD%EF%BC%8C%E6%8F%92%E5%85%A5%20title%20%E4%B8%BA%20Hello%20World%20%E7%9A%84%E8%AE%B0%E5%BD%95%0A%0A%3D%3E%20INSERT%20INTO%20%60posts%60(%60title%60)%20VALUES('Hello%20World')%3B%0A%0Aconsole.log(result)%3B%0A%3D%3E%0A%7B%0A%20%20fieldCount%3A%200%2C%0A%20%20affectedRows%3A%201%2C%0A%20%20insertId%3A%203710%2C%0A%20%20serverStatus%3A%202%2C%0A%20%20warningCount%3A%202%2C%0A%20%20message%3A%20''%2C%0A%20%20protocol41%3A%20true%2C%0A%20%20changedRows%3A%200%0A%7D%0A%0A%2F%2F%20%E5%88%A4%E6%96%AD%E6%8F%92%E5%85%A5%E6%88%90%E5%8A%9F%0Aconst%20insertSuccess%20%3D%20result.affectedRows%20%3D%3D%3D%201%3B%0A%60%60%60%0A%0A%23%23%23%20Read%0A%0A%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%20%60get%60%20%E6%96%B9%E6%B3%95%E6%88%96%20%60select%60%20%E6%96%B9%E6%B3%95%E8%8E%B7%E5%8F%96%E4%B8%80%E6%9D%A1%E6%88%96%E5%A4%9A%E6%9D%A1%E8%AE%B0%E5%BD%95%E3%80%82%60select%60%20%E6%96%B9%E6%B3%95%E6%94%AF%E6%8C%81%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2%E4%B8%8E%E7%BB%93%E6%9E%9C%E7%9A%84%E5%AE%9A%E5%88%B6%E3%80%82%0A%0A-%20%E6%9F%A5%E8%AF%A2%E4%B8%80%E6%9D%A1%E8%AE%B0%E5%BD%95%0A%0A%60%60%60js%0Aconst%20post%20%3D%20await%20this.app.mysql.get('posts'%2C%20%7B%20id%3A%2012%20%7D)%3B%0A%0A%3D%3E%20SELECT%20*%20FROM%20%60posts%60%20WHERE%20%60id%60%20%3D%2012%20LIMIT%200%2C%201%3B%0A%60%60%60%0A%0A-%20%E6%9F%A5%E8%AF%A2%E5%85%A8%E8%A1%A8%0A%0A%60%60%60js%0Aconst%20results%20%3D%20await%20this.app.mysql.select('posts')%3B%0A%0A%3D%3E%20SELECT%20*%20FROM%20%60posts%60%3B%0A%60%60%60%0A%0A-%20%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2%E5%92%8C%E7%BB%93%E6%9E%9C%E5%AE%9A%E5%88%B6%0A%0A%60%60%60js%0Aconst%20results%20%3D%20await%20this.app.mysql.select('posts'%2C%20%7B%20%2F%2F%20%E6%90%9C%E7%B4%A2%20post%20%E8%A1%A8%0A%20%20where%3A%20%7B%20status%3A%20'draft'%2C%20author%3A%20%5B'author1'%2C%20'author2'%5D%20%7D%2C%20%2F%2F%20WHERE%20%E6%9D%A1%E4%BB%B6%0A%20%20columns%3A%20%5B'author'%2C%20'title'%5D%2C%20%2F%2F%20%E8%A6%81%E6%9F%A5%E8%AF%A2%E7%9A%84%E8%A1%A8%E5%AD%97%E6%AE%B5%0A%20%20orders%3A%20%5B%5B'created_at'%2C'desc'%5D%2C%20%5B'id'%2C'desc'%5D%5D%2C%20%2F%2F%20%E6%8E%92%E5%BA%8F%E6%96%B9%E5%BC%8F%0A%20%20limit%3A%2010%2C%20%2F%2F%20%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E9%87%8F%0A%20%20offset%3A%200%2C%20%2F%2F%20%E6%95%B0%E6%8D%AE%E5%81%8F%E7%A7%BB%E9%87%8F%0A%7D)%3B%0A%0A%3D%3E%20SELECT%20%60author%60%2C%20%60title%60%20FROM%20%60posts%60%0A%20%20WHERE%20%60status%60%20%3D%20'draft'%20AND%20%60author%60%20IN('author1'%2C'author2')%0A%20%20ORDER%20BY%20%60created_at%60%20DESC%2C%20%60id%60%20DESC%20LIMIT%200%2C%2010%3B%0A%60%60%60%0A%0A%0A%23%23%23%20Update%0A%0A%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%20%60update%60%20%E6%96%B9%E6%B3%95%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%B0%E5%BD%95%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%B0%86%E4%BC%9A%E6%A0%B9%E6%8D%AE%E4%B8%BB%E9%94%AE%20ID%20%E6%9F%A5%E6%89%BE%EF%BC%8C%E5%B9%B6%E6%9B%B4%E6%96%B0%0Aconst%20row%20%3D%20%7B%0A%20%20id%3A%20123%2C%0A%20%20name%3A%20'fengmk2'%2C%0A%20%20otherField%3A%20'other%20field%20value'%2C%20%20%20%20%2F%2F%20any%20other%20fields%20u%20want%20to%20update%0A%20%20modifiedAt%3A%20this.app.mysql.literals.now%2C%20%2F%2F%20%60now()%60%20on%20db%20server%0A%7D%3B%0Aconst%20result%20%3D%20await%20this.app.mysql.update('posts'%2C%20row)%3B%20%2F%2F%20%E6%9B%B4%E6%96%B0%20posts%20%E8%A1%A8%E4%B8%AD%E7%9A%84%E8%AE%B0%E5%BD%95%0A%0A%3D%3E%20UPDATE%20%60posts%60%20SET%20%60name%60%20%3D%20'fengmk2'%2C%20%60modifiedAt%60%20%3D%20NOW()%20WHERE%20id%20%3D%20123%20%3B%0A%0A%2F%2F%20%E5%88%A4%E6%96%AD%E6%9B%B4%E6%96%B0%E6%88%90%E5%8A%9F%0Aconst%20updateSuccess%20%3D%20result.affectedRows%20%3D%3D%3D%201%3B%0A%0A%2F%2F%20%E5%A6%82%E6%9E%9C%E4%B8%BB%E9%94%AE%E6%98%AF%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%20ID%20%E5%90%8D%E7%A7%B0%EF%BC%8C%E5%A6%82%20custom_id%EF%BC%8C%E5%88%99%E9%9C%80%E8%A6%81%E5%9C%A8%20%60where%60%20%E9%87%8C%E9%9D%A2%E9%85%8D%E7%BD%AE%0Aconst%20row%20%3D%20%7B%0A%20%20name%3A%20'fengmk2'%2C%0A%20%20otherField%3A%20'other%20field%20value'%2C%20%20%20%20%2F%2F%20any%20other%20fields%20u%20want%20to%20update%0A%20%20modifiedAt%3A%20this.app.mysql.literals.now%2C%20%2F%2F%20%60now()%60%20on%20db%20server%0A%7D%3B%0A%0Aconst%20options%20%3D%20%7B%0A%20%20where%3A%20%7B%0A%20%20%20%20custom_id%3A%20456%0A%20%20%7D%0A%7D%3B%0Aconst%20result%20%3D%20await%20this.app.mysql.update('posts'%2C%20row%2C%20options)%3B%20%2F%2F%20%E6%9B%B4%E6%96%B0%20posts%20%E8%A1%A8%E4%B8%AD%E7%9A%84%E8%AE%B0%E5%BD%95%0A%0A%3D%3E%20UPDATE%20%60posts%60%20SET%20%60name%60%20%3D%20'fengmk2'%2C%20%60modifiedAt%60%20%3D%20NOW()%20WHERE%20custom_id%20%3D%20456%20%3B%0A%0A%2F%2F%20%E5%88%A4%E6%96%AD%E6%9B%B4%E6%96%B0%E6%88%90%E5%8A%9F%0Aconst%20updateSuccess%20%3D%20result.affectedRows%20%3D%3D%3D%201%3B%0A%60%60%60%0A%0A%23%23%23%20Delete%0A%0A%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%20%60delete%60%20%E6%96%B9%E6%B3%95%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%B0%E5%BD%95%E3%80%82%0A%0A%60%60%60js%0Aconst%20result%20%3D%20await%20this.app.mysql.delete('posts'%2C%20%7B%0A%20%20author%3A%20'fengmk2'%2C%0A%7D)%3B%0A%0A%3D%3E%20DELETE%20FROM%20%60posts%60%20WHERE%20%60author%60%20%3D%20'fengmk2'%3B%0A%60%60%60%0A%0A%23%23%20%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C%20sql%20%E8%AF%AD%E5%8F%A5%0A%0A%E6%8F%92%E4%BB%B6%E6%9C%AC%E8%BA%AB%E4%B9%9F%E6%94%AF%E6%8C%81%E6%8B%BC%E6%8E%A5%E4%B8%8E%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C%20sql%20%E8%AF%AD%E5%8F%A5%E3%80%82%E4%BD%BF%E7%94%A8%20%60query%60%20%E5%8F%AF%E4%BB%A5%E6%89%A7%E8%A1%8C%E5%90%88%E6%B3%95%E7%9A%84%20sql%20%E8%AF%AD%E5%8F%A5%E3%80%82%0A%0A**%E6%B3%A8%E6%84%8F%EF%BC%81%EF%BC%81%E6%88%91%E4%BB%AC%E6%9E%81%E5%85%B6%E4%B8%8D%E5%BB%BA%E8%AE%AE%E5%BC%80%E5%8F%91%E8%80%85%E6%8B%BC%E6%8E%A5%20sql%20%E8%AF%AD%E5%8F%A5%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%BE%88%E5%AE%B9%E6%98%93%E5%BC%95%E8%B5%B7%20sql%20%E6%B3%A8%E5%85%A5%EF%BC%81%EF%BC%81**%0A%0A%E5%A6%82%E6%9E%9C%E5%BF%85%E9%A1%BB%E8%A6%81%E8%87%AA%E5%B7%B1%E6%8B%BC%E6%8E%A5%20sql%20%E8%AF%AD%E5%8F%A5%EF%BC%8C%E8%AF%B7%E4%BD%BF%E7%94%A8%20%60mysql.escape%60%20%E6%96%B9%E6%B3%95%E3%80%82%0A%0A%E5%8F%82%E8%80%83%20%5Bpreventing-sql-injection-in-node-js%5D(http%3A%2F%2Fstackoverflow.com%2Fquestions%2F15778572%2Fpreventing-sql-injection-in-node-js)%0A%0A%60%60%60js%0Aconst%20postId%20%3D%201%3B%0Aconst%20results%20%3D%20await%20this.app.mysql.query('update%20posts%20set%20hits%20%3D%20(hits%20%2B%20%3F)%20where%20id%20%3D%20%3F'%2C%20%5B1%2C%20postId%5D)%3B%0A%0A%3D%3E%20update%20posts%20set%20hits%20%3D%20(hits%20%2B%201)%20where%20id%20%3D%201%3B%0A%60%60%60%0A%0A%23%23%20%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1%0A%0AMySQL%20%E4%BA%8B%E5%8A%A1%E4%B8%BB%E8%A6%81%E7%94%A8%E4%BA%8E%E5%A4%84%E7%90%86%E6%93%8D%E4%BD%9C%E9%87%8F%E5%A4%A7%EF%BC%8C%E5%A4%8D%E6%9D%82%E5%BA%A6%E9%AB%98%E7%9A%84%E6%95%B0%E6%8D%AE%E3%80%82%E6%AF%94%E5%A6%82%E8%AF%B4%EF%BC%8C%E5%9C%A8%E4%BA%BA%E5%91%98%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%B8%AD%EF%BC%8C%E4%BD%A0%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E4%BA%BA%E5%91%98%EF%BC%8C%E4%BD%A0%E6%97%A2%E9%9C%80%E8%A6%81%E5%88%A0%E9%99%A4%E4%BA%BA%E5%91%98%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%B5%84%E6%96%99%EF%BC%8C%E4%B9%9F%E8%A6%81%E5%88%A0%E9%99%A4%E5%92%8C%E8%AF%A5%E4%BA%BA%E5%91%98%E7%9B%B8%E5%85%B3%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%A6%82%E4%BF%A1%E7%AE%B1%EF%BC%8C%E6%96%87%E7%AB%A0%E7%AD%89%E7%AD%89%E3%80%82%E8%BF%99%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E5%8F%AF%E4%BB%A5%E6%96%B9%E4%BE%BF%E7%AE%A1%E7%90%86%E8%BF%99%E4%B8%80%E7%BB%84%E6%93%8D%E4%BD%9C%E3%80%82%0A%E4%B8%80%E4%B8%AA%E4%BA%8B%E5%8A%A1%E5%B0%86%E4%B8%80%E7%BB%84%E8%BF%9E%E7%BB%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%EF%BC%8C%E6%94%BE%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%8D%95%E4%B8%80%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8D%95%E5%85%83%E6%9D%A5%E6%89%A7%E8%A1%8C%E3%80%82%E8%AF%A5%E7%BB%84%E5%86%85%E7%9A%84%E6%AF%8F%E4%B8%AA%E5%8D%95%E7%8B%AC%E7%9A%84%E6%93%8D%E4%BD%9C%E6%98%AF%E6%88%90%E5%8A%9F%EF%BC%8C%E4%BA%8B%E5%8A%A1%E6%89%8D%E8%83%BD%E6%88%90%E5%8A%9F%E3%80%82%E5%A6%82%E6%9E%9C%E4%BA%8B%E5%8A%A1%E4%B8%AD%E7%9A%84%E4%BB%BB%E4%BD%95%E6%93%8D%E4%BD%9C%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%88%99%E6%95%B4%E4%B8%AA%E4%BA%8B%E5%8A%A1%E5%B0%86%E5%A4%B1%E8%B4%A5%E3%80%82%0A%0A%E4%B8%80%E8%88%AC%E6%9D%A5%E8%AF%B4%EF%BC%8C%E4%BA%8B%E5%8A%A1%E6%98%AF%E5%BF%85%E9%A1%BB%E6%BB%A1%E8%B6%B34%E4%B8%AA%E6%9D%A1%E4%BB%B6%EF%BC%88ACID%EF%BC%89%EF%BC%9A%20Atomicity%EF%BC%88%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%89%E3%80%81Consistency%EF%BC%88%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%89%E3%80%81Isolation%EF%BC%88%E9%9A%94%E7%A6%BB%E6%80%A7%EF%BC%89%E3%80%81Durability%EF%BC%88%E5%8F%AF%E9%9D%A0%E6%80%A7%EF%BC%89%0A%0A-%20%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%9A%E7%A1%AE%E4%BF%9D%E4%BA%8B%E5%8A%A1%E5%86%85%E7%9A%84%E6%89%80%E6%9C%89%E6%93%8D%E4%BD%9C%E9%83%BD%E6%88%90%E5%8A%9F%E5%AE%8C%E6%88%90%EF%BC%8C%E5%90%A6%E5%88%99%E4%BA%8B%E5%8A%A1%E5%B0%86%E8%A2%AB%E4%B8%AD%E6%AD%A2%E5%9C%A8%E6%95%85%E9%9A%9C%E7%82%B9%EF%BC%8C%E4%BB%A5%E5%89%8D%E7%9A%84%E6%93%8D%E4%BD%9C%E5%B0%86%E5%9B%9E%E6%BB%9A%E5%88%B0%E4%BB%A5%E5%89%8D%E7%9A%84%E7%8A%B6%E6%80%81%E3%80%82%0A-%20%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%9A%E5%AF%B9%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E4%BF%AE%E6%94%B9%E6%98%AF%E4%B8%80%E8%87%B4%E7%9A%84%E3%80%82%0A-%20%E9%9A%94%E7%A6%BB%E6%80%A7%EF%BC%9A%E4%BA%8B%E5%8A%A1%E6%98%AF%E5%BD%BC%E6%AD%A4%E7%8B%AC%E7%AB%8B%E7%9A%84%EF%BC%8C%E4%B8%8D%E4%BA%92%E7%9B%B8%E5%BD%B1%E5%93%8D%0A-%20%E6%8C%81%E4%B9%85%E6%80%A7%EF%BC%9A%E7%A1%AE%E4%BF%9D%E6%8F%90%E4%BA%A4%E4%BA%8B%E5%8A%A1%E5%90%8E%EF%BC%8C%E4%BA%8B%E5%8A%A1%E4%BA%A7%E7%94%9F%E7%9A%84%E7%BB%93%E6%9E%9C%E5%8F%AF%E4%BB%A5%E6%B0%B8%E4%B9%85%E5%AD%98%E5%9C%A8%E3%80%82%0A%0A%E5%9B%A0%E6%AD%A4%EF%BC%8C%E5%AF%B9%E4%BA%8E%E4%B8%80%E4%B8%AA%E4%BA%8B%E5%8A%A1%E6%9D%A5%E8%AE%B2%EF%BC%8C%E4%B8%80%E5%AE%9A%E4%BC%B4%E9%9A%8F%E7%9D%80%20beginTransaction%E3%80%81commit%20%E6%88%96%20rollback%EF%BC%8C%E5%88%86%E5%88%AB%E4%BB%A3%E8%A1%A8%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%BC%80%E5%A7%8B%EF%BC%8C%E6%88%90%E5%8A%9F%E5%92%8C%E5%A4%B1%E8%B4%A5%E5%9B%9E%E6%BB%9A%E3%80%82%0A%0Aegg-mysql%20%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%A4%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84%E4%BA%8B%E5%8A%A1%E3%80%82%0A%0A%23%23%23%20%E6%89%8B%E5%8A%A8%E6%8E%A7%E5%88%B6%0A%0A-%20%E4%BC%98%E7%82%B9%EF%BC%9A%60beginTransaction%60%2C%20%60commit%60%20%E6%88%96%20%60rollback%60%20%E9%83%BD%E7%94%B1%E5%BC%80%E5%8F%91%E8%80%85%E6%9D%A5%E5%AE%8C%E5%85%A8%E6%8E%A7%E5%88%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%81%9A%E5%88%B0%E9%9D%9E%E5%B8%B8%E7%BB%86%E7%B2%92%E5%BA%A6%E7%9A%84%E6%8E%A7%E5%88%B6%E3%80%82%0A-%20%E7%BC%BA%E7%82%B9%EF%BC%9A%E6%89%8B%E5%86%99%E4%BB%A3%E7%A0%81%E6%AF%94%E8%BE%83%E5%A4%9A%EF%BC%8C%E4%B8%8D%E6%98%AF%E6%AF%8F%E4%B8%AA%E4%BA%BA%E9%83%BD%E8%83%BD%E5%86%99%E5%A5%BD%E3%80%82%E5%BF%98%E8%AE%B0%E4%BA%86%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%E5%92%8C%20cleanup%20%E9%83%BD%E4%BC%9A%E5%AF%BC%E8%87%B4%E4%B8%A5%E9%87%8D%20bug%E3%80%82%0A%0A%60%60%60js%0Aconst%20conn%20%3D%20await%20app.mysql.beginTransaction()%3B%20%2F%2F%20%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%8B%E5%8A%A1%0A%0Atry%20%7B%0A%20%20await%20conn.insert(table%2C%20row1)%3B%20%20%2F%2F%20%E7%AC%AC%E4%B8%80%E6%AD%A5%E6%93%8D%E4%BD%9C%0A%20%20await%20conn.update(table%2C%20row2)%3B%20%20%2F%2F%20%E7%AC%AC%E4%BA%8C%E6%AD%A5%E6%93%8D%E4%BD%9C%0A%20%20await%20conn.commit()%3B%20%2F%2F%20%E6%8F%90%E4%BA%A4%E4%BA%8B%E5%8A%A1%0A%7D%20catch%20(err)%20%7B%0A%20%20%2F%2F%20error%2C%20rollback%0A%20%20await%20conn.rollback()%3B%20%2F%2F%20%E4%B8%80%E5%AE%9A%E8%AE%B0%E5%BE%97%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%E5%90%8E%E5%9B%9E%E6%BB%9A%E4%BA%8B%E5%8A%A1%EF%BC%81%EF%BC%81%0A%20%20throw%20err%3B%0A%7D%0A%60%60%60%0A%0A%23%23%23%20%E8%87%AA%E5%8A%A8%E6%8E%A7%E5%88%B6%EF%BC%9ATransaction%20with%20scope%0A%0A-%20API%EF%BC%9A%60beginTransactionScope(scope%2C%20ctx)%60%0A%20%20-%20%60scope%60%3A%20%E4%B8%80%E4%B8%AA%20generatorFunction%EF%BC%8C%E5%9C%A8%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E9%87%8C%E9%9D%A2%E6%89%A7%E8%A1%8C%E8%BF%99%E6%AC%A1%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%89%80%E6%9C%89%20sql%20%E8%AF%AD%E5%8F%A5%E3%80%82%0A%20%20-%20%60ctx%60%3A%20%E5%BD%93%E5%89%8D%E8%AF%B7%E6%B1%82%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AF%B9%E8%B1%A1%EF%BC%8C%E4%BC%A0%E5%85%A5%20ctx%20%E5%8F%AF%E4%BB%A5%E4%BF%9D%E8%AF%81%E5%8D%B3%E4%BE%BF%E5%9C%A8%E5%87%BA%E7%8E%B0%E4%BA%8B%E5%8A%A1%E5%B5%8C%E5%A5%97%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E4%B8%AD%E5%90%8C%E6%97%B6%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E6%BF%80%E6%B4%BB%E7%8A%B6%E6%80%81%E7%9A%84%E4%BA%8B%E5%8A%A1%E3%80%82%0A-%20%E4%BC%98%E7%82%B9%EF%BC%9A%E4%BD%BF%E7%94%A8%E7%AE%80%E5%8D%95%EF%BC%8C%E4%B8%8D%E5%AE%B9%E6%98%93%E7%8A%AF%E9%94%99%EF%BC%8C%E5%B0%B1%E6%84%9F%E8%A7%89%E4%BA%8B%E5%8A%A1%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%A0%B7%E5%AD%90%E3%80%82%0A-%20%E7%BC%BA%E7%82%B9%EF%BC%9A%E6%95%B4%E4%B8%AA%E4%BA%8B%E5%8A%A1%E8%A6%81%E4%B9%88%E6%88%90%E5%8A%9F%EF%BC%8C%E8%A6%81%E4%B9%88%E5%A4%B1%E8%B4%A5%EF%BC%8C%E6%97%A0%E6%B3%95%E5%81%9A%E7%BB%86%E7%B2%92%E5%BA%A6%E6%8E%A7%E5%88%B6%E3%80%82%0A%0A%60%60%60js%0Aconst%20result%20%3D%20await%20app.mysql.beginTransactionScope(async%20conn%20%3D%3E%20%7B%0A%20%20%2F%2F%20don't%20commit%20or%20rollback%20by%20yourself%0A%20%20await%20conn.insert(table%2C%20row1)%3B%0A%20%20await%20conn.update(table%2C%20row2)%3B%0A%20%20return%20%7B%20success%3A%20true%20%7D%3B%0A%7D%2C%20ctx)%3B%20%2F%2F%20ctx%20%E6%98%AF%E5%BD%93%E5%89%8D%E8%AF%B7%E6%B1%82%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AF%E5%9C%A8%20service%20%E6%96%87%E4%BB%B6%E4%B8%AD%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BB%8E%20%60this.ctx%60%20%E8%8E%B7%E5%8F%96%E5%88%B0%0A%2F%2F%20if%20error%20throw%20on%20scope%2C%20will%20auto%20rollback%0A%60%60%60%0A%0A%23%23%20%E8%A1%A8%E8%BE%BE%E5%BC%8F(Literal)%0A%0A%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E8%B0%83%E7%94%A8%20MySQL%20%E5%86%85%E7%BD%AE%E7%9A%84%E5%87%BD%E6%95%B0%EF%BC%88%E6%88%96%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%89%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%20%60Literal%60%E3%80%82%0A%0A%23%23%23%20%E5%86%85%E7%BD%AE%E8%A1%A8%E8%BE%BE%E5%BC%8F%0A%0A-%20%60NOW()%60%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E6%97%B6%E9%97%B4%EF%BC%8C%E9%80%9A%E8%BF%87%20%60app.mysql.literals.now%60%20%E8%8E%B7%E5%8F%96%E3%80%82%0A%0A%60%60%60js%0Aawait%20this.app.mysql.insert(table%2C%20%7B%0A%20%20create_time%3A%20this.app.mysql.literals.now%2C%0A%7D)%3B%0A%0A%3D%3E%20INSERT%20INTO%20%60%24table%60(%60create_time%60)%20VALUES(NOW())%0A%60%60%60%0A%0A%23%23%23%20%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8%E8%BE%BE%E5%BC%8F%0A%0A%E4%B8%8B%E4%BE%8B%E5%B1%95%E7%A4%BA%E4%BA%86%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8%20MySQL%20%E5%86%85%E7%BD%AE%E7%9A%84%20%60CONCAT(s1%2C%20...sn)%60%20%E5%87%BD%E6%95%B0%EF%BC%8C%E5%81%9A%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E3%80%82%0A%0A%60%60%60js%0Aconst%20Literal%20%3D%20this.app.mysql.literals.Literal%3B%0Aconst%20first%20%3D%20'James'%3B%0Aconst%20last%20%3D%20'Bond'%3B%0Aawait%20this.app.mysql.insert(table%2C%20%7B%0A%20%20id%3A%20123%2C%0A%20%20fullname%3A%20new%20Literal(%60CONCAT(%22%24%7Bfirst%7D%22%2C%20%22%24%7Blast%7D%22%60)%2C%0A%7D)%3B%0A%0A%3D%3E%20INSERT%20INTO%20%60%24table%60(%60id%60%2C%20%60fullname%60)%20VALUES(123%2C%20CONCAT(%22James%22%2C%20%22Bond%22))%0A%60%60%60%0A%0A%5Begg-mysql%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mysql%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>