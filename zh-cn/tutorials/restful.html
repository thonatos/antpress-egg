<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>实现 RESTful API</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>通过 Web 技术开发服务给客户端提供接口，可能是各个 Web 框架最广泛的应用之一。这篇文章我们拿 <a href="https://cnodejs.org/">CNode 社区</a> 的接口来看一看通过 Egg 如何实现 <a href="https://zh.wikipedia.org/wiki/REST">RESTful</a> API 给客户端调用。</p><p>CNode 社区现在 v1 版本的接口不是完全符合 RESTful 语义，在这篇文章中，我们将基于 CNode V1 的接口，封装一个更符合 RESTful 语义的 V2 版本 API。</p><h2 id="设计响应格式">设计响应格式</h2><p>在 RESTful 风格的设计中，我们会通过响应状态码来标识响应的状态，保持响应的 body 简洁，只返回接口数据。以 <code>topics</code> 资源为例：</p><h3 id="获取主题列表">获取主题列表</h3><ul><li><code>GET /api/v2/topics</code></li><li>响应状态码：200</li><li>响应体：</li></ul><pre><code class="language-json">[
  {
    &quot;id&quot;: &quot;57ea257b3670ca3f44c5beb6&quot;,
    &quot;author_id&quot;: &quot;541bf9b9ad60405c1f151a03&quot;,
    &quot;tab&quot;: &quot;share&quot;,
    &quot;content&quot;: &quot;content&quot;,
    &quot;last_reply_at&quot;: &quot;2017-01-11T13:32:25.089Z&quot;,
    &quot;good&quot;: false,
    &quot;top&quot;: true,
    &quot;reply_count&quot;: 155,
    &quot;visit_count&quot;: 28176,
    &quot;create_at&quot;: &quot;2016-09-27T07:53:31.872Z&quot;,
  },
  {
    &quot;id&quot;: &quot;57ea257b3670ca3f44c5beb6&quot;,
    &quot;author_id&quot;: &quot;541bf9b9ad60405c1f151a03&quot;,
    &quot;tab&quot;: &quot;share&quot;,
    &quot;content&quot;: &quot;content&quot;,
    &quot;title&quot;: &quot;《一起学 Node.js》彻底重写完毕&quot;,
    &quot;last_reply_at&quot;: &quot;2017-01-11T10:20:56.496Z&quot;,
    &quot;good&quot;: false,
    &quot;top&quot;: true,
    &quot;reply_count&quot;: 193,
    &quot;visit_count&quot;: 47633,
  },
]</code></pre><h3 id="获取单个主题">获取单个主题</h3><ul><li><code>GET /api/v2/topics/57ea257b3670ca3f44c5beb6</code></li><li>响应状态码：200</li><li>响应体：</li></ul><pre><code class="language-json">{
  &quot;id&quot;: &quot;57ea257b3670ca3f44c5beb6&quot;,
  &quot;author_id&quot;: &quot;541bf9b9ad60405c1f151a03&quot;,
  &quot;tab&quot;: &quot;share&quot;,
  &quot;content&quot;: &quot;content&quot;,
  &quot;title&quot;: &quot;《一起学 Node.js》彻底重写完毕&quot;,
  &quot;last_reply_at&quot;: &quot;2017-01-11T10:20:56.496Z&quot;,
  &quot;good&quot;: false,
  &quot;top&quot;: true,
  &quot;reply_count&quot;: 193,
  &quot;visit_count&quot;: 47633,
}</code></pre><h3 id="创建主题">创建主题</h3><ul><li><code>POST /api/v2/topics</code></li><li>响应状态码：201</li><li>响应体：</li></ul><pre><code>{
  &quot;topic_id&quot;: &quot;57ea257b3670ca3f44c5beb6&quot;
}</code></pre><h3 id="更新主题">更新主题</h3><ul><li><code>PUT /api/v2/topics/57ea257b3670ca3f44c5beb6</code></li><li>响应状态码：204</li><li>响应体：空</li></ul><h3 id="错误处理">错误处理</h3><p>在接口处理发生错误的时候，如果是客户端请求参数导致的错误，我们会返回 4xx 状态码，如果是服务端自身的处理逻辑错误，我们会返回 5xx 状态码。所有的异常对象都是对这个异常状态的描述，其中 error 字段是错误的描述，detail 字段（可选）是导致错误的详细原因。</p><p>例如，当客户端传递的参数异常时，我们可能返回一个响应，状态码为 422，返回响应体为：</p><pre><code class="language-json">{
  &quot;error&quot;: &quot;Validation Failed&quot;,
  &quot;detail&quot;: [ { &quot;message&quot;: &quot;required&quot;, &quot;field&quot;: &quot;title&quot;, &quot;code&quot;: &quot;missing_field&quot; } ]
}</code></pre><h2 id="实现">实现</h2><p>在约定好接口之后，我们可以开始动手实现了。</p><h3 id="初始化项目">初始化项目</h3><p>还是通过<a href="../intro/quickstart.md">快速入门</a>章节介绍的 <a href="https://github.com/eggjs/egg-init">egg-init</a> 工具来初始化我们的应用</p><pre><code class="language-bash">$ egg-init cnode-api --type=simple
$ cd cnode-api
$ npm i</code></pre><h3 id="开启-validate-插件">开启 validate 插件</h3><p>我们选择 <a href="https://github.com/eggjs/egg-validate">egg-validate</a> 作为 validate 插件的示例。</p><pre><code class="language-js">// config/plugin.js
exports.validate = {
  enable: true,
  package: &#x27;egg-validate&#x27;,
};</code></pre><h3 id="注册路由">注册路由</h3><p>首先，我们先按照前面的设计来注册<a href="../basics/router.md">路由</a>，框架提供了一个便捷的方式来创建 RESTful 风格的路由，并将一个资源的接口映射到对应的 controller 文件。在 <code>app/router.js</code> 中：</p><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  app.router.resources(&#x27;topics&#x27;, &#x27;/api/v2/topics&#x27;, app.controller.topics);
};</code></pre><p>通过 <code>app.resources</code> 方法，我们将 topics 这个资源的增删改查接口映射到了 <code>app/controller/topics.js</code> 文件。</p><h3 id="controller-开发">controller 开发</h3><p>在 <a href="../basics/controller.md">controller</a> 中，我们只需要实现 <code>app.resources</code> 约定的 <a href="../basics/router.md#restful-风格的-url-定义">RESTful 风格的 URL 定义</a> 中我们需要提供的接口即可。例如我们来实现创建一个 topics 的接口：</p><pre><code class="language-js">// app/controller/topics.js
const Controller = require(&#x27;egg&#x27;).Controller;

// 定义创建接口的请求参数规则
const createRule = {
  accesstoken: &#x27;string&#x27;,
  title: &#x27;string&#x27;,
  tab: { type: &#x27;enum&#x27;, values: [ &#x27;ask&#x27;, &#x27;share&#x27;, &#x27;job&#x27; ], required: false },
  content: &#x27;string&#x27;,
};

class TopicController extends Controller {
  async create() {
    const ctx = this.ctx;
    // 校验 `ctx.request.body` 是否符合我们预期的格式
    // 如果参数校验未通过，将会抛出一个 status = 422 的异常
    ctx.validate(createRule, ctx.request.body);
    // 调用 service 创建一个 topic
    const id = await ctx.service.topics.create(ctx.request.body);
    // 设置响应体和状态码
    ctx.body = {
      topic_id: id,
    };
    ctx.status = 201;
  }
}
module.exports = TopicController;</code></pre><p>如同注释中说明的，一个 Controller 主要实现了下面的逻辑：</p><ol><li>调用 validate 方法对请求参数进行验证。</li><li>用验证过的参数调用 service 封装的业务逻辑来创建一个 topic。</li><li>按照接口约定的格式设置响应状态码和内容。</li></ol><h3 id="service-开发">service 开发</h3><p>在 <a href="../basics/service.md">service</a> 中，我们可以更加专注的编写实际生效的业务逻辑。</p><pre><code class="language-js">// app/service/topics.js
const Service = require(&#x27;egg&#x27;).Service;

class TopicService extends Service {
  constructor(ctx) {
    super(ctx);
    this.root = &#x27;https://cnodejs.org/api/v1&#x27;;
  }

  async create(params) {
    // 调用 CNode V1 版本 API
    const result = await this.ctx.curl(`${this.root}/topics`, {
      method: &#x27;post&#x27;,
      data: params,
      dataType: &#x27;json&#x27;,
      contentType: &#x27;json&#x27;,
    });
    // 检查调用是否成功，如果调用失败会抛出异常
    this.checkSuccess(result);
    // 返回创建的 topic 的 id
    return result.data.topic_id;
  }

  // 封装统一的调用检查函数，可以在查询、创建和更新等 Service 中复用
  checkSuccess(result) {
    if (result.status !== 200) {
      const errorMsg = result.data &amp;&amp; result.data.error_msg ? result.data.error_msg : &#x27;unknown error&#x27;;
      this.ctx.throw(result.status, errorMsg);
    }
    if (!result.data.success) {
      // 远程调用返回格式错误
      this.ctx.throw(500, &#x27;remote response error&#x27;, { data: result.data });
    }
  }
}

module.exports = TopicService;</code></pre><p>在创建 topic 的 Service 开发完成之后，我们就从上往下的完成了一个接口的开发。</p><h3 id="统一错误处理">统一错误处理</h3><p>正常的业务逻辑已经正常完成了，但是异常我们还没有进行处理。在前面编写的代码中，Controller 和 Service 都有可能抛出异常，这也是我们推荐的编码方式，当发现客户端参数传递错误或者调用后端服务异常时，通过抛出异常的方式来进行中断。</p><ul><li>Controller 中 <code>this.ctx.validate()</code> 进行参数校验，失败抛出异常。</li><li>Service 中调用 <code>this.ctx.curl()</code> 方法访问 CNode 服务，可能由于网络问题等原因抛出服务端异常。</li><li>Service 中拿到 CNode 服务端返回的结果后，可能会收到请求调用失败的返回结果，此时也会抛出异常。</li></ul><p>框架虽然提供了默认的异常处理，但是可能和我们在前面的接口约定不一致，因此我们需要自己实现一个统一错误处理的中间件来对错误进行处理。</p><p>在 <code>app/middleware</code> 目录下新建一个 <code>error_handler.js</code> 的文件来新建一个 <a href="../basics/middleware.md">middleware</a></p><pre><code class="language-js">// app/middleware/error_handler.js
module.exports = () =&gt; {
  return async function errorHandler(ctx, next) {
    try {
      await next();
    } catch (err) {
      // 所有的异常都在 app 上触发一个 error 事件，框架会记录一条错误日志
      ctx.app.emit(&#x27;error&#x27;, err, ctx);

      const status = err.status || 500;
      // 生产环境时 500 错误的详细错误内容不返回给客户端，因为可能包含敏感信息
      const error = status === 500 &amp;&amp; ctx.app.config.env === &#x27;prod&#x27;
        ? &#x27;Internal Server Error&#x27;
        : err.message;

      // 从 error 对象上读出各个属性，设置到响应中
      ctx.body = { error };
      if (status === 422) {
        ctx.body.detail = err.errors;
      }
      ctx.status = status;
    }
  };
};</code></pre><p>通过这个中间件，我们可以捕获所有异常，并按照我们想要的格式封装了响应。将这个中间件通过配置文件(<code>config/config.default.js</code>)加载进来：</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  // 加载 errorHandler 中间件
  middleware: [ &#x27;errorHandler&#x27; ],
  // 只对 /api 前缀的 url 路径生效
  errorHandler: {
    match: &#x27;/api&#x27;,
  },
};</code></pre><h2 id="测试">测试</h2><p>代码完成只是第一步，我们还需要给代码加上<a href="../core/unittest.md">单元测试</a>。</p><h3 id="controller-测试">Controller 测试</h3><p>我们先来编写 Controller 代码的单元测试。在写 Controller 单测的时候，我们可以适时的模拟 Service 层的实现，因为对 Controller 的单元测试而言，最重要的部分是测试自身的逻辑，而 Service 层按照约定的接口 mock 掉，Service 自身的逻辑可以让 Service 的单元测试来覆盖，这样我们开发的时候也可以分层进行开发测试。</p><pre><code class="language-js">const { app, mock, assert } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;test/app/controller/topics.test.js&#x27;, () =&gt; {
  // 测试请求参数错误时应用的响应
  it(&#x27;should POST /api/v2/topics/ 422&#x27;, () =&gt; {
    app.mockCsrf();
    return app.httpRequest()
      .post(&#x27;/api/v2/topics&#x27;)
      .send({
        accesstoken: &#x27;123&#x27;,
      })
      .expect(422)
      .expect({
        error: &#x27;Validation Failed&#x27;,
        detail: [
          { message: &#x27;required&#x27;, field: &#x27;title&#x27;, code: &#x27;missing_field&#x27; },
          { message: &#x27;required&#x27;, field: &#x27;content&#x27;, code: &#x27;missing_field&#x27; },
        ],
      });
  });

  // mock 掉 service 层，测试正常时的返回
  it(&#x27;should POST /api/v2/topics/ 201&#x27;, () =&gt; {
    app.mockCsrf();
    app.mockService(&#x27;topics&#x27;, &#x27;create&#x27;, 123);
    return app.httpRequest()
      .post(&#x27;/api/v2/topics&#x27;)
      .send({
        accesstoken: &#x27;123&#x27;,
        title: &#x27;title&#x27;,
        content: &#x27;hello&#x27;,
      })
      .expect(201)
      .expect({
        topic_id: 123,
      });
  });
});</code></pre><p>上面对 Controller 的测试中，我们通过 <a href="https://github.com/eggjs/egg-mock">egg-mock</a> 创建了一个应用，并通过 <a href="https://github.com/visionmedia/supertest">SuperTest</a> 来模拟客户端发送请求进行测试。在测试中我们会模拟 Service 层的响应来测试 Controller 层的处理逻辑。</p><h3 id="service-测试">Service 测试</h3><p>Service 层的测试也只需要聚焦于自身的代码逻辑，<a href="https://github.com/eggjs/egg-mock">egg-mock</a> 同样提供了快速测试 Service 的方法，不再需要用 SuperTest 模拟从客户端发起请求，而是直接调用 Service 中的方法进行测试。</p><pre><code class="language-js">const { app, mock, assert } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;test/app/service/topics.test.js&#x27;, () =&gt; {
  let ctx;

  beforeEach(() =&gt; {
    // 创建一个匿名的 context 对象，可以在 ctx 对象上调用 service 的方法
    ctx = app.mockContext();
  });

  describe(&#x27;create()&#x27;, () =&gt; {
    it(&#x27;should create failed by accesstoken error&#x27;, async () =&gt; {
      try {
        await ctx.service.topics.create({
          accesstoken: &#x27;hello&#x27;,
          title: &#x27;title&#x27;,
          content: &#x27;content&#x27;,
        });
      } catch (err) {
        assert(err.status === 401);
        assert(err.message === &#x27;错误的accessToken&#x27;);
        return;
      }
      throw &#x27;should not run here&#x27;;
    });

    it(&#x27;should create success&#x27;, async () =&gt; {
      // 不影响 CNode 的正常运行，我们可以将对 CNode 的调用按照接口约定模拟掉
      // app.mockHttpclient 方法可以便捷的对应用发起的 http 请求进行模拟
      app.mockHttpclient(`${ctx.service.topics.root}/topics`, &#x27;POST&#x27;, {
        data: {
          success: true,
          topic_id: &#x27;5433d5e4e737cbe96dcef312&#x27;,
        },
      });

      const id = await ctx.service.topics.create({
        accesstoken: &#x27;hello&#x27;,
        title: &#x27;title&#x27;,
        content: &#x27;content&#x27;,
      });
      assert(id === &#x27;5433d5e4e737cbe96dcef312&#x27;);
    });
  });
});</code></pre><p>上面对 Service 层的测试中，我们通过 egg-mock 提供的 <code>app.createContext()</code> 方法创建了一个 Context 对象，并直接调用 Context 上的 Service 方法进行测试，测试时可以通过 <code>app.mockHttpclient()</code> 方法模拟 HTTP 调用的响应，让我们剥离环境的影响而专注于 Service 自身逻辑的测试上。</p><hr/><p>完整的代码实现和测试都在 <a href="https://github.com/eggjs/examples/tree/master/cnode-api">eggjs/examples/cnode-api</a> 中可以找到。</p></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E8%AE%BE%E8%AE%A1%E5%93%8D%E5%BA%94%E6%A0%BC%E5%BC%8F">设计响应格式</a><ul><li><a href="#%E8%8E%B7%E5%8F%96%E4%B8%BB%E9%A2%98%E5%88%97%E8%A1%A8">获取主题列表</a></li><li><a href="#%E8%8E%B7%E5%8F%96%E5%8D%95%E4%B8%AA%E4%B8%BB%E9%A2%98">获取单个主题</a></li><li><a href="#%E5%88%9B%E5%BB%BA%E4%B8%BB%E9%A2%98">创建主题</a></li><li><a href="#%E6%9B%B4%E6%96%B0%E4%B8%BB%E9%A2%98">更新主题</a></li><li><a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">错误处理</a></li></ul></li><li><a href="#%E5%AE%9E%E7%8E%B0">实现</a><ul><li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE">初始化项目</a></li><li><a href="#%E5%BC%80%E5%90%AF-validate-%E6%8F%92%E4%BB%B6">开启 validate 插件</a></li><li><a href="#%E6%B3%A8%E5%86%8C%E8%B7%AF%E7%94%B1">注册路由</a></li><li><a href="#controller-%E5%BC%80%E5%8F%91">controller 开发</a></li><li><a href="#service-%E5%BC%80%E5%8F%91">service 开发</a></li><li><a href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">统一错误处理</a></li></ul></li><li><a href="#%E6%B5%8B%E8%AF%95">测试</a><ul><li><a href="#controller-%E6%B5%8B%E8%AF%95">Controller 测试</a></li><li><a href="#service-%E6%B5%8B%E8%AF%95">Service 测试</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E8%AE%BE%E8%AE%A1%E5%93%8D%E5%BA%94%E6%A0%BC%E5%BC%8F%5D(%23%25E8%25AE%25BE%25E8%25AE%25A1%25E5%2593%258D%25E5%25BA%2594%25E6%25A0%25BC%25E5%25BC%258F)%0A%20%20*%20%5B%E8%8E%B7%E5%8F%96%E4%B8%BB%E9%A2%98%E5%88%97%E8%A1%A8%5D(%23%25E8%258E%25B7%25E5%258F%2596%25E4%25B8%25BB%25E9%25A2%2598%25E5%2588%2597%25E8%25A1%25A8)%0A%20%20*%20%5B%E8%8E%B7%E5%8F%96%E5%8D%95%E4%B8%AA%E4%B8%BB%E9%A2%98%5D(%23%25E8%258E%25B7%25E5%258F%2596%25E5%258D%2595%25E4%25B8%25AA%25E4%25B8%25BB%25E9%25A2%2598)%0A%20%20*%20%5B%E5%88%9B%E5%BB%BA%E4%B8%BB%E9%A2%98%5D(%23%25E5%2588%259B%25E5%25BB%25BA%25E4%25B8%25BB%25E9%25A2%2598)%0A%20%20*%20%5B%E6%9B%B4%E6%96%B0%E4%B8%BB%E9%A2%98%5D(%23%25E6%259B%25B4%25E6%2596%25B0%25E4%25B8%25BB%25E9%25A2%2598)%0A%20%20*%20%5B%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%5D(%23%25E9%2594%2599%25E8%25AF%25AF%25E5%25A4%2584%25E7%2590%2586)%0A-%20%5B%E5%AE%9E%E7%8E%B0%5D(%23%25E5%25AE%259E%25E7%258E%25B0)%0A%20%20*%20%5B%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE%5D(%23%25E5%2588%259D%25E5%25A7%258B%25E5%258C%2596%25E9%25A1%25B9%25E7%259B%25AE)%0A%20%20*%20%5B%E5%BC%80%E5%90%AF%20validate%20%E6%8F%92%E4%BB%B6%5D(%23%25E5%25BC%2580%25E5%2590%25AF-validate-%25E6%258F%2592%25E4%25BB%25B6)%0A%20%20*%20%5B%E6%B3%A8%E5%86%8C%E8%B7%AF%E7%94%B1%5D(%23%25E6%25B3%25A8%25E5%2586%258C%25E8%25B7%25AF%25E7%2594%25B1)%0A%20%20*%20%5Bcontroller%20%E5%BC%80%E5%8F%91%5D(%23controller-%25E5%25BC%2580%25E5%258F%2591)%0A%20%20*%20%5Bservice%20%E5%BC%80%E5%8F%91%5D(%23service-%25E5%25BC%2580%25E5%258F%2591)%0A%20%20*%20%5B%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%5D(%23%25E7%25BB%259F%25E4%25B8%2580%25E9%2594%2599%25E8%25AF%25AF%25E5%25A4%2584%25E7%2590%2586)%0A-%20%5B%E6%B5%8B%E8%AF%95%5D(%23%25E6%25B5%258B%25E8%25AF%2595)%0A%20%20*%20%5BController%20%E6%B5%8B%E8%AF%95%5D(%23controller-%25E6%25B5%258B%25E8%25AF%2595)%0A%20%20*%20%5BService%20%E6%B5%8B%E8%AF%95%5D(%23service-%25E6%25B5%258B%25E8%25AF%2595)","meta":{"info":{"title":"实现 RESTful API"}},"content":"%0A%0A%0A%E9%80%9A%E8%BF%87%20Web%20%E6%8A%80%E6%9C%AF%E5%BC%80%E5%8F%91%E6%9C%8D%E5%8A%A1%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8F%90%E4%BE%9B%E6%8E%A5%E5%8F%A3%EF%BC%8C%E5%8F%AF%E8%83%BD%E6%98%AF%E5%90%84%E4%B8%AA%20Web%20%E6%A1%86%E6%9E%B6%E6%9C%80%E5%B9%BF%E6%B3%9B%E7%9A%84%E5%BA%94%E7%94%A8%E4%B9%8B%E4%B8%80%E3%80%82%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E6%88%91%E4%BB%AC%E6%8B%BF%20%5BCNode%20%E7%A4%BE%E5%8C%BA%5D(https%3A%2F%2Fcnodejs.org%2F)%20%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%9D%A5%E7%9C%8B%E4%B8%80%E7%9C%8B%E9%80%9A%E8%BF%87%20Egg%20%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%20%5BRESTful%5D(https%3A%2F%2Fzh.wikipedia.org%2Fwiki%2FREST)%20API%20%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E7%94%A8%E3%80%82%0A%0ACNode%20%E7%A4%BE%E5%8C%BA%E7%8E%B0%E5%9C%A8%20v1%20%E7%89%88%E6%9C%AC%E7%9A%84%E6%8E%A5%E5%8F%A3%E4%B8%8D%E6%98%AF%E5%AE%8C%E5%85%A8%E7%AC%A6%E5%90%88%20RESTful%20%E8%AF%AD%E4%B9%89%EF%BC%8C%E5%9C%A8%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B0%86%E5%9F%BA%E4%BA%8E%20CNode%20V1%20%E7%9A%84%E6%8E%A5%E5%8F%A3%EF%BC%8C%E5%B0%81%E8%A3%85%E4%B8%80%E4%B8%AA%E6%9B%B4%E7%AC%A6%E5%90%88%20RESTful%20%E8%AF%AD%E4%B9%89%E7%9A%84%20V2%20%E7%89%88%E6%9C%AC%20API%E3%80%82%0A%0A%23%23%20%E8%AE%BE%E8%AE%A1%E5%93%8D%E5%BA%94%E6%A0%BC%E5%BC%8F%0A%0A%E5%9C%A8%20RESTful%20%E9%A3%8E%E6%A0%BC%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BC%9A%E9%80%9A%E8%BF%87%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81%E6%9D%A5%E6%A0%87%E8%AF%86%E5%93%8D%E5%BA%94%E7%9A%84%E7%8A%B6%E6%80%81%EF%BC%8C%E4%BF%9D%E6%8C%81%E5%93%8D%E5%BA%94%E7%9A%84%20body%20%E7%AE%80%E6%B4%81%EF%BC%8C%E5%8F%AA%E8%BF%94%E5%9B%9E%E6%8E%A5%E5%8F%A3%E6%95%B0%E6%8D%AE%E3%80%82%E4%BB%A5%20%60topics%60%20%E8%B5%84%E6%BA%90%E4%B8%BA%E4%BE%8B%EF%BC%9A%0A%0A%23%23%23%20%E8%8E%B7%E5%8F%96%E4%B8%BB%E9%A2%98%E5%88%97%E8%A1%A8%0A%0A-%20%60GET%20%2Fapi%2Fv2%2Ftopics%60%0A-%20%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81%EF%BC%9A200%0A-%20%E5%93%8D%E5%BA%94%E4%BD%93%EF%BC%9A%0A%0A%60%60%60json%0A%5B%0A%20%20%7B%0A%20%20%20%20%22id%22%3A%20%2257ea257b3670ca3f44c5beb6%22%2C%0A%20%20%20%20%22author_id%22%3A%20%22541bf9b9ad60405c1f151a03%22%2C%0A%20%20%20%20%22tab%22%3A%20%22share%22%2C%0A%20%20%20%20%22content%22%3A%20%22content%22%2C%0A%20%20%20%20%22last_reply_at%22%3A%20%222017-01-11T13%3A32%3A25.089Z%22%2C%0A%20%20%20%20%22good%22%3A%20false%2C%0A%20%20%20%20%22top%22%3A%20true%2C%0A%20%20%20%20%22reply_count%22%3A%20155%2C%0A%20%20%20%20%22visit_count%22%3A%2028176%2C%0A%20%20%20%20%22create_at%22%3A%20%222016-09-27T07%3A53%3A31.872Z%22%2C%0A%20%20%7D%2C%0A%20%20%7B%0A%20%20%20%20%22id%22%3A%20%2257ea257b3670ca3f44c5beb6%22%2C%0A%20%20%20%20%22author_id%22%3A%20%22541bf9b9ad60405c1f151a03%22%2C%0A%20%20%20%20%22tab%22%3A%20%22share%22%2C%0A%20%20%20%20%22content%22%3A%20%22content%22%2C%0A%20%20%20%20%22title%22%3A%20%22%E3%80%8A%E4%B8%80%E8%B5%B7%E5%AD%A6%20Node.js%E3%80%8B%E5%BD%BB%E5%BA%95%E9%87%8D%E5%86%99%E5%AE%8C%E6%AF%95%22%2C%0A%20%20%20%20%22last_reply_at%22%3A%20%222017-01-11T10%3A20%3A56.496Z%22%2C%0A%20%20%20%20%22good%22%3A%20false%2C%0A%20%20%20%20%22top%22%3A%20true%2C%0A%20%20%20%20%22reply_count%22%3A%20193%2C%0A%20%20%20%20%22visit_count%22%3A%2047633%2C%0A%20%20%7D%2C%0A%5D%0A%60%60%60%0A%0A%23%23%23%20%E8%8E%B7%E5%8F%96%E5%8D%95%E4%B8%AA%E4%B8%BB%E9%A2%98%0A%0A-%20%60GET%20%2Fapi%2Fv2%2Ftopics%2F57ea257b3670ca3f44c5beb6%60%0A-%20%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81%EF%BC%9A200%0A-%20%E5%93%8D%E5%BA%94%E4%BD%93%EF%BC%9A%0A%0A%60%60%60json%0A%7B%0A%20%20%22id%22%3A%20%2257ea257b3670ca3f44c5beb6%22%2C%0A%20%20%22author_id%22%3A%20%22541bf9b9ad60405c1f151a03%22%2C%0A%20%20%22tab%22%3A%20%22share%22%2C%0A%20%20%22content%22%3A%20%22content%22%2C%0A%20%20%22title%22%3A%20%22%E3%80%8A%E4%B8%80%E8%B5%B7%E5%AD%A6%20Node.js%E3%80%8B%E5%BD%BB%E5%BA%95%E9%87%8D%E5%86%99%E5%AE%8C%E6%AF%95%22%2C%0A%20%20%22last_reply_at%22%3A%20%222017-01-11T10%3A20%3A56.496Z%22%2C%0A%20%20%22good%22%3A%20false%2C%0A%20%20%22top%22%3A%20true%2C%0A%20%20%22reply_count%22%3A%20193%2C%0A%20%20%22visit_count%22%3A%2047633%2C%0A%7D%0A%60%60%60%0A%0A%23%23%23%20%E5%88%9B%E5%BB%BA%E4%B8%BB%E9%A2%98%0A%0A-%20%60POST%20%2Fapi%2Fv2%2Ftopics%60%0A-%20%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81%EF%BC%9A201%0A-%20%E5%93%8D%E5%BA%94%E4%BD%93%EF%BC%9A%0A%0A%60%60%60%0A%7B%0A%20%20%22topic_id%22%3A%20%2257ea257b3670ca3f44c5beb6%22%0A%7D%0A%60%60%60%0A%0A%23%23%23%20%E6%9B%B4%E6%96%B0%E4%B8%BB%E9%A2%98%0A%0A-%20%60PUT%20%2Fapi%2Fv2%2Ftopics%2F57ea257b3670ca3f44c5beb6%60%0A-%20%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81%EF%BC%9A204%0A-%20%E5%93%8D%E5%BA%94%E4%BD%93%EF%BC%9A%E7%A9%BA%0A%0A%23%23%23%20%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%0A%0A%E5%9C%A8%E6%8E%A5%E5%8F%A3%E5%A4%84%E7%90%86%E5%8F%91%E7%94%9F%E9%94%99%E8%AF%AF%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AF%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E5%AF%BC%E8%87%B4%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BC%9A%E8%BF%94%E5%9B%9E%204xx%20%E7%8A%B6%E6%80%81%E7%A0%81%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AF%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%87%AA%E8%BA%AB%E7%9A%84%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AF%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BC%9A%E8%BF%94%E5%9B%9E%205xx%20%E7%8A%B6%E6%80%81%E7%A0%81%E3%80%82%E6%89%80%E6%9C%89%E7%9A%84%E5%BC%82%E5%B8%B8%E5%AF%B9%E8%B1%A1%E9%83%BD%E6%98%AF%E5%AF%B9%E8%BF%99%E4%B8%AA%E5%BC%82%E5%B8%B8%E7%8A%B6%E6%80%81%E7%9A%84%E6%8F%8F%E8%BF%B0%EF%BC%8C%E5%85%B6%E4%B8%AD%20error%20%E5%AD%97%E6%AE%B5%E6%98%AF%E9%94%99%E8%AF%AF%E7%9A%84%E6%8F%8F%E8%BF%B0%EF%BC%8Cdetail%20%E5%AD%97%E6%AE%B5%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89%E6%98%AF%E5%AF%BC%E8%87%B4%E9%94%99%E8%AF%AF%E7%9A%84%E8%AF%A6%E7%BB%86%E5%8E%9F%E5%9B%A0%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%EF%BC%8C%E5%BD%93%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BC%A0%E9%80%92%E7%9A%84%E5%8F%82%E6%95%B0%E5%BC%82%E5%B8%B8%E6%97%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E8%83%BD%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E5%93%8D%E5%BA%94%EF%BC%8C%E7%8A%B6%E6%80%81%E7%A0%81%E4%B8%BA%20422%EF%BC%8C%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94%E4%BD%93%E4%B8%BA%EF%BC%9A%0A%0A%60%60%60json%0A%7B%0A%20%20%22error%22%3A%20%22Validation%20Failed%22%2C%0A%20%20%22detail%22%3A%20%5B%20%7B%20%22message%22%3A%20%22required%22%2C%20%22field%22%3A%20%22title%22%2C%20%22code%22%3A%20%22missing_field%22%20%7D%20%5D%0A%7D%0A%60%60%60%0A%0A%23%23%20%E5%AE%9E%E7%8E%B0%0A%0A%E5%9C%A8%E7%BA%A6%E5%AE%9A%E5%A5%BD%E6%8E%A5%E5%8F%A3%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%BC%80%E5%A7%8B%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0%E4%BA%86%E3%80%82%0A%0A%23%23%23%20%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE%0A%0A%E8%BF%98%E6%98%AF%E9%80%9A%E8%BF%87%5B%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%5D(..%2Fintro%2Fquickstart.md)%E7%AB%A0%E8%8A%82%E4%BB%8B%E7%BB%8D%E7%9A%84%20%5Begg-init%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-init)%20%E5%B7%A5%E5%85%B7%E6%9D%A5%E5%88%9D%E5%A7%8B%E5%8C%96%E6%88%91%E4%BB%AC%E7%9A%84%E5%BA%94%E7%94%A8%0A%0A%60%60%60bash%0A%24%20egg-init%20cnode-api%20--type%3Dsimple%0A%24%20cd%20cnode-api%0A%24%20npm%20i%0A%60%60%60%0A%0A%23%23%23%20%E5%BC%80%E5%90%AF%20validate%20%E6%8F%92%E4%BB%B6%0A%0A%E6%88%91%E4%BB%AC%E9%80%89%E6%8B%A9%20%5Begg-validate%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-validate)%20%E4%BD%9C%E4%B8%BA%20validate%20%E6%8F%92%E4%BB%B6%E7%9A%84%E7%A4%BA%E4%BE%8B%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20config%2Fplugin.js%0Aexports.validate%20%3D%20%7B%0A%20%20enable%3A%20true%2C%0A%20%20package%3A%20'egg-validate'%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20%E6%B3%A8%E5%86%8C%E8%B7%AF%E7%94%B1%0A%0A%E9%A6%96%E5%85%88%EF%BC%8C%E6%88%91%E4%BB%AC%E5%85%88%E6%8C%89%E7%85%A7%E5%89%8D%E9%9D%A2%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%9D%A5%E6%B3%A8%E5%86%8C%5B%E8%B7%AF%E7%94%B1%5D(..%2Fbasics%2Frouter.md)%EF%BC%8C%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E4%B8%AA%E4%BE%BF%E6%8D%B7%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E5%88%9B%E5%BB%BA%20RESTful%20%E9%A3%8E%E6%A0%BC%E7%9A%84%E8%B7%AF%E7%94%B1%EF%BC%8C%E5%B9%B6%E5%B0%86%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%98%A0%E5%B0%84%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84%20controller%20%E6%96%87%E4%BB%B6%E3%80%82%E5%9C%A8%20%60app%2Frouter.js%60%20%E4%B8%AD%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.router.resources('topics'%2C%20'%2Fapi%2Fv2%2Ftopics'%2C%20app.controller.topics)%3B%0A%7D%3B%0A%60%60%60%0A%0A%E9%80%9A%E8%BF%87%20%60app.resources%60%20%E6%96%B9%E6%B3%95%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B0%86%20topics%20%E8%BF%99%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E6%8E%A5%E5%8F%A3%E6%98%A0%E5%B0%84%E5%88%B0%E4%BA%86%20%60app%2Fcontroller%2Ftopics.js%60%20%E6%96%87%E4%BB%B6%E3%80%82%0A%0A%23%23%23%20controller%20%E5%BC%80%E5%8F%91%0A%0A%E5%9C%A8%20%5Bcontroller%5D(..%2Fbasics%2Fcontroller.md)%20%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AA%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%20%60app.resources%60%20%E7%BA%A6%E5%AE%9A%E7%9A%84%20%5BRESTful%20%E9%A3%8E%E6%A0%BC%E7%9A%84%20URL%20%E5%AE%9A%E4%B9%89%5D(..%2Fbasics%2Frouter.md%23restful-%E9%A3%8E%E6%A0%BC%E7%9A%84-url-%E5%AE%9A%E4%B9%89)%20%E4%B8%AD%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E6%8F%90%E4%BE%9B%E7%9A%84%E6%8E%A5%E5%8F%A3%E5%8D%B3%E5%8F%AF%E3%80%82%E4%BE%8B%E5%A6%82%E6%88%91%E4%BB%AC%E6%9D%A5%E5%AE%9E%E7%8E%B0%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20topics%20%E7%9A%84%E6%8E%A5%E5%8F%A3%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Ftopics.js%0Aconst%20Controller%20%3D%20require('egg').Controller%3B%0A%0A%2F%2F%20%E5%AE%9A%E4%B9%89%E5%88%9B%E5%BB%BA%E6%8E%A5%E5%8F%A3%E7%9A%84%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E8%A7%84%E5%88%99%0Aconst%20createRule%20%3D%20%7B%0A%20%20accesstoken%3A%20'string'%2C%0A%20%20title%3A%20'string'%2C%0A%20%20tab%3A%20%7B%20type%3A%20'enum'%2C%20values%3A%20%5B%20'ask'%2C%20'share'%2C%20'job'%20%5D%2C%20required%3A%20false%20%7D%2C%0A%20%20content%3A%20'string'%2C%0A%7D%3B%0A%0Aclass%20TopicController%20extends%20Controller%20%7B%0A%20%20async%20create()%20%7B%0A%20%20%20%20const%20ctx%20%3D%20this.ctx%3B%0A%20%20%20%20%2F%2F%20%E6%A0%A1%E9%AA%8C%20%60ctx.request.body%60%20%E6%98%AF%E5%90%A6%E7%AC%A6%E5%90%88%E6%88%91%E4%BB%AC%E9%A2%84%E6%9C%9F%E7%9A%84%E6%A0%BC%E5%BC%8F%0A%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%E6%9C%AA%E9%80%9A%E8%BF%87%EF%BC%8C%E5%B0%86%E4%BC%9A%E6%8A%9B%E5%87%BA%E4%B8%80%E4%B8%AA%20status%20%3D%20422%20%E7%9A%84%E5%BC%82%E5%B8%B8%0A%20%20%20%20ctx.validate(createRule%2C%20ctx.request.body)%3B%0A%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8%20service%20%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20topic%0A%20%20%20%20const%20id%20%3D%20await%20ctx.service.topics.create(ctx.request.body)%3B%0A%20%20%20%20%2F%2F%20%E8%AE%BE%E7%BD%AE%E5%93%8D%E5%BA%94%E4%BD%93%E5%92%8C%E7%8A%B6%E6%80%81%E7%A0%81%0A%20%20%20%20ctx.body%20%3D%20%7B%0A%20%20%20%20%20%20topic_id%3A%20id%2C%0A%20%20%20%20%7D%3B%0A%20%20%20%20ctx.status%20%3D%20201%3B%0A%20%20%7D%0A%7D%0Amodule.exports%20%3D%20TopicController%3B%0A%60%60%60%0A%0A%E5%A6%82%E5%90%8C%E6%B3%A8%E9%87%8A%E4%B8%AD%E8%AF%B4%E6%98%8E%E7%9A%84%EF%BC%8C%E4%B8%80%E4%B8%AA%20Controller%20%E4%B8%BB%E8%A6%81%E5%AE%9E%E7%8E%B0%E4%BA%86%E4%B8%8B%E9%9D%A2%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%9A%0A%0A1.%20%E8%B0%83%E7%94%A8%20validate%20%E6%96%B9%E6%B3%95%E5%AF%B9%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81%E3%80%82%0A2.%20%E7%94%A8%E9%AA%8C%E8%AF%81%E8%BF%87%E7%9A%84%E5%8F%82%E6%95%B0%E8%B0%83%E7%94%A8%20service%20%E5%B0%81%E8%A3%85%E7%9A%84%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E6%9D%A5%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20topic%E3%80%82%0A3.%20%E6%8C%89%E7%85%A7%E6%8E%A5%E5%8F%A3%E7%BA%A6%E5%AE%9A%E7%9A%84%E6%A0%BC%E5%BC%8F%E8%AE%BE%E7%BD%AE%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81%E5%92%8C%E5%86%85%E5%AE%B9%E3%80%82%0A%0A%23%23%23%20service%20%E5%BC%80%E5%8F%91%0A%0A%E5%9C%A8%20%5Bservice%5D(..%2Fbasics%2Fservice.md)%20%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%9B%B4%E5%8A%A0%E4%B8%93%E6%B3%A8%E7%9A%84%E7%BC%96%E5%86%99%E5%AE%9E%E9%99%85%E7%94%9F%E6%95%88%E7%9A%84%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fservice%2Ftopics.js%0Aconst%20Service%20%3D%20require('egg').Service%3B%0A%0Aclass%20TopicService%20extends%20Service%20%7B%0A%20%20constructor(ctx)%20%7B%0A%20%20%20%20super(ctx)%3B%0A%20%20%20%20this.root%20%3D%20'https%3A%2F%2Fcnodejs.org%2Fapi%2Fv1'%3B%0A%20%20%7D%0A%0A%20%20async%20create(params)%20%7B%0A%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8%20CNode%20V1%20%E7%89%88%E6%9C%AC%20API%0A%20%20%20%20const%20result%20%3D%20await%20this.ctx.curl(%60%24%7Bthis.root%7D%2Ftopics%60%2C%20%7B%0A%20%20%20%20%20%20method%3A%20'post'%2C%0A%20%20%20%20%20%20data%3A%20params%2C%0A%20%20%20%20%20%20dataType%3A%20'json'%2C%0A%20%20%20%20%20%20contentType%3A%20'json'%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%2F%2F%20%E6%A3%80%E6%9F%A5%E8%B0%83%E7%94%A8%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%B0%83%E7%94%A8%E5%A4%B1%E8%B4%A5%E4%BC%9A%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%0A%20%20%20%20this.checkSuccess(result)%3B%0A%20%20%20%20%2F%2F%20%E8%BF%94%E5%9B%9E%E5%88%9B%E5%BB%BA%E7%9A%84%20topic%20%E7%9A%84%20id%0A%20%20%20%20return%20result.data.topic_id%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20%E5%B0%81%E8%A3%85%E7%BB%9F%E4%B8%80%E7%9A%84%E8%B0%83%E7%94%A8%E6%A3%80%E6%9F%A5%E5%87%BD%E6%95%B0%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%9F%A5%E8%AF%A2%E3%80%81%E5%88%9B%E5%BB%BA%E5%92%8C%E6%9B%B4%E6%96%B0%E7%AD%89%20Service%20%E4%B8%AD%E5%A4%8D%E7%94%A8%0A%20%20checkSuccess(result)%20%7B%0A%20%20%20%20if%20(result.status%20!%3D%3D%20200)%20%7B%0A%20%20%20%20%20%20const%20errorMsg%20%3D%20result.data%20%26%26%20result.data.error_msg%20%3F%20result.data.error_msg%20%3A%20'unknown%20error'%3B%0A%20%20%20%20%20%20this.ctx.throw(result.status%2C%20errorMsg)%3B%0A%20%20%20%20%7D%0A%20%20%20%20if%20(!result.data.success)%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E8%BF%94%E5%9B%9E%E6%A0%BC%E5%BC%8F%E9%94%99%E8%AF%AF%0A%20%20%20%20%20%20this.ctx.throw(500%2C%20'remote%20response%20error'%2C%20%7B%20data%3A%20result.data%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A%0Amodule.exports%20%3D%20TopicService%3B%0A%60%60%60%0A%0A%E5%9C%A8%E5%88%9B%E5%BB%BA%20topic%20%E7%9A%84%20Service%20%E5%BC%80%E5%8F%91%E5%AE%8C%E6%88%90%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B0%B1%E4%BB%8E%E4%B8%8A%E5%BE%80%E4%B8%8B%E7%9A%84%E5%AE%8C%E6%88%90%E4%BA%86%E4%B8%80%E4%B8%AA%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%BC%80%E5%8F%91%E3%80%82%0A%0A%23%23%23%20%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%0A%0A%E6%AD%A3%E5%B8%B8%E7%9A%84%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%B7%B2%E7%BB%8F%E6%AD%A3%E5%B8%B8%E5%AE%8C%E6%88%90%E4%BA%86%EF%BC%8C%E4%BD%86%E6%98%AF%E5%BC%82%E5%B8%B8%E6%88%91%E4%BB%AC%E8%BF%98%E6%B2%A1%E6%9C%89%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86%E3%80%82%E5%9C%A8%E5%89%8D%E9%9D%A2%E7%BC%96%E5%86%99%E7%9A%84%E4%BB%A3%E7%A0%81%E4%B8%AD%EF%BC%8CController%20%E5%92%8C%20Service%20%E9%83%BD%E6%9C%89%E5%8F%AF%E8%83%BD%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%EF%BC%8C%E8%BF%99%E4%B9%9F%E6%98%AF%E6%88%91%E4%BB%AC%E6%8E%A8%E8%8D%90%E7%9A%84%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F%EF%BC%8C%E5%BD%93%E5%8F%91%E7%8E%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E9%94%99%E8%AF%AF%E6%88%96%E8%80%85%E8%B0%83%E7%94%A8%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%BC%82%E5%B8%B8%E6%97%B6%EF%BC%8C%E9%80%9A%E8%BF%87%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E8%BF%9B%E8%A1%8C%E4%B8%AD%E6%96%AD%E3%80%82%0A%0A-%20Controller%20%E4%B8%AD%20%60this.ctx.validate()%60%20%E8%BF%9B%E8%A1%8C%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%EF%BC%8C%E5%A4%B1%E8%B4%A5%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%E3%80%82%0A-%20Service%20%E4%B8%AD%E8%B0%83%E7%94%A8%20%60this.ctx.curl()%60%20%E6%96%B9%E6%B3%95%E8%AE%BF%E9%97%AE%20CNode%20%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%8F%AF%E8%83%BD%E7%94%B1%E4%BA%8E%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%E7%AD%89%E5%8E%9F%E5%9B%A0%E6%8A%9B%E5%87%BA%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%82%E5%B8%B8%E3%80%82%0A-%20Service%20%E4%B8%AD%E6%8B%BF%E5%88%B0%20CNode%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%BF%94%E5%9B%9E%E7%9A%84%E7%BB%93%E6%9E%9C%E5%90%8E%EF%BC%8C%E5%8F%AF%E8%83%BD%E4%BC%9A%E6%94%B6%E5%88%B0%E8%AF%B7%E6%B1%82%E8%B0%83%E7%94%A8%E5%A4%B1%E8%B4%A5%E7%9A%84%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%EF%BC%8C%E6%AD%A4%E6%97%B6%E4%B9%9F%E4%BC%9A%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%E3%80%82%0A%0A%E6%A1%86%E6%9E%B6%E8%99%BD%E7%84%B6%E6%8F%90%E4%BE%9B%E4%BA%86%E9%BB%98%E8%AE%A4%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%EF%BC%8C%E4%BD%86%E6%98%AF%E5%8F%AF%E8%83%BD%E5%92%8C%E6%88%91%E4%BB%AC%E5%9C%A8%E5%89%8D%E9%9D%A2%E7%9A%84%E6%8E%A5%E5%8F%A3%E7%BA%A6%E5%AE%9A%E4%B8%8D%E4%B8%80%E8%87%B4%EF%BC%8C%E5%9B%A0%E6%AD%A4%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%9D%A5%E5%AF%B9%E9%94%99%E8%AF%AF%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86%E3%80%82%0A%0A%E5%9C%A8%20%60app%2Fmiddleware%60%20%E7%9B%AE%E5%BD%95%E4%B8%8B%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA%20%60error_handler.js%60%20%E7%9A%84%E6%96%87%E4%BB%B6%E6%9D%A5%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA%20%5Bmiddleware%5D(..%2Fbasics%2Fmiddleware.md)%0A%0A%60%60%60js%0A%2F%2F%20app%2Fmiddleware%2Ferror_handler.js%0Amodule.exports%20%3D%20()%20%3D%3E%20%7B%0A%20%20return%20async%20function%20errorHandler(ctx%2C%20next)%20%7B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20await%20next()%3B%0A%20%20%20%20%7D%20catch%20(err)%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E6%89%80%E6%9C%89%E7%9A%84%E5%BC%82%E5%B8%B8%E9%83%BD%E5%9C%A8%20app%20%E4%B8%8A%E8%A7%A6%E5%8F%91%E4%B8%80%E4%B8%AA%20error%20%E4%BA%8B%E4%BB%B6%EF%BC%8C%E6%A1%86%E6%9E%B6%E4%BC%9A%E8%AE%B0%E5%BD%95%E4%B8%80%E6%9D%A1%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%0A%20%20%20%20%20%20ctx.app.emit('error'%2C%20err%2C%20ctx)%3B%0A%0A%20%20%20%20%20%20const%20status%20%3D%20err.status%20%7C%7C%20500%3B%0A%20%20%20%20%20%20%2F%2F%20%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%97%B6%20500%20%E9%94%99%E8%AF%AF%E7%9A%84%E8%AF%A6%E7%BB%86%E9%94%99%E8%AF%AF%E5%86%85%E5%AE%B9%E4%B8%8D%E8%BF%94%E5%9B%9E%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%8F%AF%E8%83%BD%E5%8C%85%E5%90%AB%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%0A%20%20%20%20%20%20const%20error%20%3D%20status%20%3D%3D%3D%20500%20%26%26%20ctx.app.config.env%20%3D%3D%3D%20'prod'%0A%20%20%20%20%20%20%20%20%3F%20'Internal%20Server%20Error'%0A%20%20%20%20%20%20%20%20%3A%20err.message%3B%0A%0A%20%20%20%20%20%20%2F%2F%20%E4%BB%8E%20error%20%E5%AF%B9%E8%B1%A1%E4%B8%8A%E8%AF%BB%E5%87%BA%E5%90%84%E4%B8%AA%E5%B1%9E%E6%80%A7%EF%BC%8C%E8%AE%BE%E7%BD%AE%E5%88%B0%E5%93%8D%E5%BA%94%E4%B8%AD%0A%20%20%20%20%20%20ctx.body%20%3D%20%7B%20error%20%7D%3B%0A%20%20%20%20%20%20if%20(status%20%3D%3D%3D%20422)%20%7B%0A%20%20%20%20%20%20%20%20ctx.body.detail%20%3D%20err.errors%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20ctx.status%20%3D%20status%3B%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A%E9%80%9A%E8%BF%87%E8%BF%99%E4%B8%AA%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%8D%95%E8%8E%B7%E6%89%80%E6%9C%89%E5%BC%82%E5%B8%B8%EF%BC%8C%E5%B9%B6%E6%8C%89%E7%85%A7%E6%88%91%E4%BB%AC%E6%83%B3%E8%A6%81%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%B0%81%E8%A3%85%E4%BA%86%E5%93%8D%E5%BA%94%E3%80%82%E5%B0%86%E8%BF%99%E4%B8%AA%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6(%60config%2Fconfig.default.js%60)%E5%8A%A0%E8%BD%BD%E8%BF%9B%E6%9D%A5%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20%2F%2F%20%E5%8A%A0%E8%BD%BD%20errorHandler%20%E4%B8%AD%E9%97%B4%E4%BB%B6%0A%20%20middleware%3A%20%5B%20'errorHandler'%20%5D%2C%0A%20%20%2F%2F%20%E5%8F%AA%E5%AF%B9%20%2Fapi%20%E5%89%8D%E7%BC%80%E7%9A%84%20url%20%E8%B7%AF%E5%BE%84%E7%94%9F%E6%95%88%0A%20%20errorHandler%3A%20%7B%0A%20%20%20%20match%3A%20'%2Fapi'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20%E6%B5%8B%E8%AF%95%0A%0A%E4%BB%A3%E7%A0%81%E5%AE%8C%E6%88%90%E5%8F%AA%E6%98%AF%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%8C%E6%88%91%E4%BB%AC%E8%BF%98%E9%9C%80%E8%A6%81%E7%BB%99%E4%BB%A3%E7%A0%81%E5%8A%A0%E4%B8%8A%5B%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%5D(..%2Fcore%2Funittest.md)%E3%80%82%0A%0A%23%23%23%20Controller%20%E6%B5%8B%E8%AF%95%0A%0A%E6%88%91%E4%BB%AC%E5%85%88%E6%9D%A5%E7%BC%96%E5%86%99%20Controller%20%E4%BB%A3%E7%A0%81%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E3%80%82%E5%9C%A8%E5%86%99%20Controller%20%E5%8D%95%E6%B5%8B%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%82%E6%97%B6%E7%9A%84%E6%A8%A1%E6%8B%9F%20Service%20%E5%B1%82%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AF%B9%20Controller%20%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E8%80%8C%E8%A8%80%EF%BC%8C%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E9%83%A8%E5%88%86%E6%98%AF%E6%B5%8B%E8%AF%95%E8%87%AA%E8%BA%AB%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%8C%E8%80%8C%20Service%20%E5%B1%82%E6%8C%89%E7%85%A7%E7%BA%A6%E5%AE%9A%E7%9A%84%E6%8E%A5%E5%8F%A3%20mock%20%E6%8E%89%EF%BC%8CService%20%E8%87%AA%E8%BA%AB%E7%9A%84%E9%80%BB%E8%BE%91%E5%8F%AF%E4%BB%A5%E8%AE%A9%20Service%20%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%9D%A5%E8%A6%86%E7%9B%96%EF%BC%8C%E8%BF%99%E6%A0%B7%E6%88%91%E4%BB%AC%E5%BC%80%E5%8F%91%E7%9A%84%E6%97%B6%E5%80%99%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%88%86%E5%B1%82%E8%BF%9B%E8%A1%8C%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A%60%60%60js%0Aconst%20%7B%20app%2C%20mock%2C%20assert%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('test%2Fapp%2Fcontroller%2Ftopics.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20%2F%2F%20%E6%B5%8B%E8%AF%95%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E9%94%99%E8%AF%AF%E6%97%B6%E5%BA%94%E7%94%A8%E7%9A%84%E5%93%8D%E5%BA%94%0A%20%20it('should%20POST%20%2Fapi%2Fv2%2Ftopics%2F%20422'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20app.mockCsrf()%3B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.post('%2Fapi%2Fv2%2Ftopics')%0A%20%20%20%20%20%20.send(%7B%0A%20%20%20%20%20%20%20%20accesstoken%3A%20'123'%2C%0A%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20.expect(422)%0A%20%20%20%20%20%20.expect(%7B%0A%20%20%20%20%20%20%20%20error%3A%20'Validation%20Failed'%2C%0A%20%20%20%20%20%20%20%20detail%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%7B%20message%3A%20'required'%2C%20field%3A%20'title'%2C%20code%3A%20'missing_field'%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%7B%20message%3A%20'required'%2C%20field%3A%20'content'%2C%20code%3A%20'missing_field'%20%7D%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%0A%20%20%2F%2F%20mock%20%E6%8E%89%20service%20%E5%B1%82%EF%BC%8C%E6%B5%8B%E8%AF%95%E6%AD%A3%E5%B8%B8%E6%97%B6%E7%9A%84%E8%BF%94%E5%9B%9E%0A%20%20it('should%20POST%20%2Fapi%2Fv2%2Ftopics%2F%20201'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20app.mockCsrf()%3B%0A%20%20%20%20app.mockService('topics'%2C%20'create'%2C%20123)%3B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.post('%2Fapi%2Fv2%2Ftopics')%0A%20%20%20%20%20%20.send(%7B%0A%20%20%20%20%20%20%20%20accesstoken%3A%20'123'%2C%0A%20%20%20%20%20%20%20%20title%3A%20'title'%2C%0A%20%20%20%20%20%20%20%20content%3A%20'hello'%2C%0A%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20.expect(201)%0A%20%20%20%20%20%20.expect(%7B%0A%20%20%20%20%20%20%20%20topic_id%3A%20123%2C%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E4%B8%8A%E9%9D%A2%E5%AF%B9%20Controller%20%E7%9A%84%E6%B5%8B%E8%AF%95%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87%20%5Begg-mock%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock)%20%E5%88%9B%E5%BB%BA%E4%BA%86%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8%EF%BC%8C%E5%B9%B6%E9%80%9A%E8%BF%87%20%5BSuperTest%5D(https%3A%2F%2Fgithub.com%2Fvisionmedia%2Fsupertest)%20%E6%9D%A5%E6%A8%A1%E6%8B%9F%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%E3%80%82%E5%9C%A8%E6%B5%8B%E8%AF%95%E4%B8%AD%E6%88%91%E4%BB%AC%E4%BC%9A%E6%A8%A1%E6%8B%9F%20Service%20%E5%B1%82%E7%9A%84%E5%93%8D%E5%BA%94%E6%9D%A5%E6%B5%8B%E8%AF%95%20Controller%20%E5%B1%82%E7%9A%84%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91%E3%80%82%0A%0A%23%23%23%20Service%20%E6%B5%8B%E8%AF%95%0A%0AService%20%E5%B1%82%E7%9A%84%E6%B5%8B%E8%AF%95%E4%B9%9F%E5%8F%AA%E9%9C%80%E8%A6%81%E8%81%9A%E7%84%A6%E4%BA%8E%E8%87%AA%E8%BA%AB%E7%9A%84%E4%BB%A3%E7%A0%81%E9%80%BB%E8%BE%91%EF%BC%8C%5Begg-mock%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock)%20%E5%90%8C%E6%A0%B7%E6%8F%90%E4%BE%9B%E4%BA%86%E5%BF%AB%E9%80%9F%E6%B5%8B%E8%AF%95%20Service%20%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%8C%E4%B8%8D%E5%86%8D%E9%9C%80%E8%A6%81%E7%94%A8%20SuperTest%20%E6%A8%A1%E6%8B%9F%E4%BB%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82%EF%BC%8C%E8%80%8C%E6%98%AF%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8%20Service%20%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A%60%60%60js%0Aconst%20%7B%20app%2C%20mock%2C%20assert%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('test%2Fapp%2Fservice%2Ftopics.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20ctx%3B%0A%0A%20%20beforeEach(()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8C%BF%E5%90%8D%E7%9A%84%20context%20%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8%20ctx%20%E5%AF%B9%E8%B1%A1%E4%B8%8A%E8%B0%83%E7%94%A8%20service%20%E7%9A%84%E6%96%B9%E6%B3%95%0A%20%20%20%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%7D)%3B%0A%0A%20%20describe('create()'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20create%20failed%20by%20accesstoken%20error'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20await%20ctx.service.topics.create(%7B%0A%20%20%20%20%20%20%20%20%20%20accesstoken%3A%20'hello'%2C%0A%20%20%20%20%20%20%20%20%20%20title%3A%20'title'%2C%0A%20%20%20%20%20%20%20%20%20%20content%3A%20'content'%2C%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%7D%20catch%20(err)%20%7B%0A%20%20%20%20%20%20%20%20assert(err.status%20%3D%3D%3D%20401)%3B%0A%20%20%20%20%20%20%20%20assert(err.message%20%3D%3D%3D%20'%E9%94%99%E8%AF%AF%E7%9A%84accessToken')%3B%0A%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20throw%20'should%20not%20run%20here'%3B%0A%20%20%20%20%7D)%3B%0A%0A%20%20%20%20it('should%20create%20success'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E4%B8%8D%E5%BD%B1%E5%93%8D%20CNode%20%E7%9A%84%E6%AD%A3%E5%B8%B8%E8%BF%90%E8%A1%8C%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%B0%86%E5%AF%B9%20CNode%20%E7%9A%84%E8%B0%83%E7%94%A8%E6%8C%89%E7%85%A7%E6%8E%A5%E5%8F%A3%E7%BA%A6%E5%AE%9A%E6%A8%A1%E6%8B%9F%E6%8E%89%0A%20%20%20%20%20%20%2F%2F%20app.mockHttpclient%20%E6%96%B9%E6%B3%95%E5%8F%AF%E4%BB%A5%E4%BE%BF%E6%8D%B7%E7%9A%84%E5%AF%B9%E5%BA%94%E7%94%A8%E5%8F%91%E8%B5%B7%E7%9A%84%20http%20%E8%AF%B7%E6%B1%82%E8%BF%9B%E8%A1%8C%E6%A8%A1%E6%8B%9F%0A%20%20%20%20%20%20app.mockHttpclient(%60%24%7Bctx.service.topics.root%7D%2Ftopics%60%2C%20'POST'%2C%20%7B%0A%20%20%20%20%20%20%20%20data%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20success%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20topic_id%3A%20'5433d5e4e737cbe96dcef312'%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%7D)%3B%0A%0A%20%20%20%20%20%20const%20id%20%3D%20await%20ctx.service.topics.create(%7B%0A%20%20%20%20%20%20%20%20accesstoken%3A%20'hello'%2C%0A%20%20%20%20%20%20%20%20title%3A%20'title'%2C%0A%20%20%20%20%20%20%20%20content%3A%20'content'%2C%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20assert(id%20%3D%3D%3D%20'5433d5e4e737cbe96dcef312')%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E4%B8%8A%E9%9D%A2%E5%AF%B9%20Service%20%E5%B1%82%E7%9A%84%E6%B5%8B%E8%AF%95%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87%20egg-mock%20%E6%8F%90%E4%BE%9B%E7%9A%84%20%60app.createContext()%60%20%E6%96%B9%E6%B3%95%E5%88%9B%E5%BB%BA%E4%BA%86%E4%B8%80%E4%B8%AA%20Context%20%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B9%B6%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8%20Context%20%E4%B8%8A%E7%9A%84%20Service%20%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%EF%BC%8C%E6%B5%8B%E8%AF%95%E6%97%B6%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60app.mockHttpclient()%60%20%E6%96%B9%E6%B3%95%E6%A8%A1%E6%8B%9F%20HTTP%20%E8%B0%83%E7%94%A8%E7%9A%84%E5%93%8D%E5%BA%94%EF%BC%8C%E8%AE%A9%E6%88%91%E4%BB%AC%E5%89%A5%E7%A6%BB%E7%8E%AF%E5%A2%83%E7%9A%84%E5%BD%B1%E5%93%8D%E8%80%8C%E4%B8%93%E6%B3%A8%E4%BA%8E%20Service%20%E8%87%AA%E8%BA%AB%E9%80%BB%E8%BE%91%E7%9A%84%E6%B5%8B%E8%AF%95%E4%B8%8A%E3%80%82%0A%0A------%0A%0A%E5%AE%8C%E6%95%B4%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%92%8C%E6%B5%8B%E8%AF%95%E9%83%BD%E5%9C%A8%20%5Beggjs%2Fexamples%2Fcnode-api%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fexamples%2Ftree%2Fmaster%2Fcnode-api)%20%E4%B8%AD%E5%8F%AF%E4%BB%A5%E6%89%BE%E5%88%B0%E3%80%82%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>