<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>Passport</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p><strong>『登录鉴权』</strong> 是一个常见的业务场景，包括『账号密码登录方式』和『第三方统一登录』。</p><p>其中，后者我们经常使用到，如 Google， GitHub，QQ 统一登录，它们都是基于 <a href="https://oauth.net/2/">OAuth</a> 规范。</p><p><a href="http://www.passportjs.org/">Passport</a> 是一个扩展性很强的认证中间件，支持 <code>Github</code>，<code>Twitter</code>，<code>Facebook</code> 等知名服务厂商的 <code>Strategy</code>，同时也支持通过账号密码的方式进行登录授权校验。</p><p>Egg 在它之上提供了 <a href="https://github.com/eggjs/egg-passport">egg-passport</a> 插件，把初始化、鉴权成功后的回调处理等通用逻辑封装掉，使得开发者仅需调用几个 API 即可方便的使用 Passport 。</p><p><a href="http://www.passportjs.org/">Passport</a> 的执行时序如下：</p><ul><li>用户访问页面</li><li>检查 Session</li><li>拦截跳鉴权登录页面</li><li>Strategy 鉴权</li><li>校验和存储用户信息</li><li>序列化用户信息到 Session</li><li>跳转到指定页面</li></ul><h2 id="使用-egg-passport">使用 egg-passport</h2><p>下面，我们将以 GitHub 登录为例，来演示下如何使用。</p><h3 id="安装">安装</h3><pre><code class="language-bash">$ npm i --save egg-passport
$ npm i --save egg-passport-github</code></pre><p>更多插件参见 <a href="https://github.com/topics/egg-passport">GitHub Topic - egg-passport</a> 。</p><h3 id="配置">配置</h3><p><strong>开启插件：</strong></p><pre><code class="language-js">// config/plugin.js
module.exports.passport = {
  enable: true,
  package: &#x27;egg-passport&#x27;,
};

module.exports.passportGithub = {
  enable: true,
  package: &#x27;egg-passport-github&#x27;,
};</code></pre><p><strong>配置:</strong></p><p>注意：<a href="https://github.com/eggjs/egg-passport">egg-passport</a> 标准化了配置字段，统一为 <code>key</code> 和 <code>secret</code> 。</p><pre><code class="language-js">// config/default.js
config.passportGithub = {
  key: &#x27;your_clientID&#x27;,
  secret: &#x27;your_clientSecret&#x27;,
  // callbackURL: &#x27;/passport/github/callback&#x27;,
  // proxy: false,
};</code></pre><p><strong>注意：</strong></p><ul><li>创建一个 <a href="https://github.com/settings/applications/new">GitHub OAuth Apps</a>，得到 <code>clientID</code> 和 <code>clientSecret</code> 信息。</li><li>填写 <code>callbackURL</code>，如 <code>http://127.0.0.1:7001/passport/github/callback</code><ul><li>线上部署时需要更新为对应的域名</li><li>路径为配置的 <code>options.callbackURL</code>，默认为 <code>/passport/${strategy}/callback</code></li></ul></li><li>如应用部署在 Nginx/HAProxy 之后，需设置插件 <code>proxy</code> 选项为 <code>true</code>, 并检查以下配置：<ul><li>代理附加 HTTP 头字段：<code>x-forwarded-proto</code> 与 <code>x-forwarded-host</code></li><li>配置中 <code>config.proxy</code> 应设置为 <code>true</code></li></ul></li></ul><h3 id="挂载路由">挂载路由</h3><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  const { router, controller } = app;

  // 挂载鉴权路由
  app.passport.mount(&#x27;github&#x27;);

  // 上面的 mount 是语法糖，等价于
  // const github = app.passport.authenticate(&#x27;github&#x27;, {});
  // router.get(&#x27;/passport/github&#x27;, github);
  // router.get(&#x27;/passport/github/callback&#x27;, github);
}</code></pre><h3 id="用户信息处理">用户信息处理</h3><p>接着，我们还需要：</p><ul><li>首次登录时，一般需要把用户信息进行入库，并记录 Session 。</li><li>二次登录时，从 OAuth 或 Session 拿到的用户信息，读取数据库拿到完整的用户信息。</li></ul><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  app.passport.verify(async (ctx, user) =&gt; {
    // 检查用户
    assert(user.provider, &#x27;user.provider should exists&#x27;);
    assert(user.id, &#x27;user.id should exists&#x27;);

    // 从数据库中查找用户信息
    //
    // Authorization Table
    // column   | desc
    // ---      | --
    // provider | provider name, like github, twitter, facebook, weibo and so on
    // uid      | provider unique id
    // user_id  | current application user id
    const auth = await ctx.model.Authorization.findOne({
      uid: user.id,
      provider: user.provider,
    });
    const existsUser = await ctx.model.User.findOne({ id: auth.user_id });
    if (existsUser) {
      return existsUser;
    }
    // 调用 service 注册新用户
    const newUser = await ctx.service.user.register(user);
    return newUser;
  });

  // 将用户信息序列化后存进 session 里面，一般需要精简，只保存个别字段
  app.passport.serializeUser(async (ctx, user) =&gt; {
  // 处理 user
  // ...
  // return user;
  });

  // 反序列化后把用户信息从 session 中取出来，反查数据库拿到完整信息
  app.passport.deserializeUser(async (ctx, user) =&gt; {
  // 处理 user
  // ...
  // return user;
  });
};</code></pre><p>至此，我们就完成了所有的配置，完整的示例可以参见：<a href="https://github.com/eggjs/examples/tree/master/passport">eggjs/examples/passport</a></p><h3 id="api">API</h3><p><a href="https://github.com/eggjs/egg-passport">egg-passport</a> 提供了以下扩展：</p><ul><li><code>ctx.user</code> - 获取当前已登录的用户信息</li><li><code>ctx.isAuthenticated()</code> - 检查该请求是否已授权</li><li><code>ctx.login(user, [options])</code> - 为用户启动一个登录的 session</li><li><code>ctx.logout()</code> - 退出，将用户信息从 session 中清除</li><li><code>ctx.session.returnTo=</code> - 在跳转验证前设置，可以指定成功后的 redirect 地址</li></ul><p>还提供了 API：</p><ul><li><code>app.passport.verify(async (ctx, user) =&gt; {})</code> - 校验用户</li><li><code>app.passport.serializeUser(async (ctx, user) =&gt; {})</code> - 序列化用户信息后存储进 session</li><li><code>app.passport.deserializeUser(async (ctx, user) =&gt; {})</code> - 反序列化后取出用户信息</li><li><code>app.passport.authenticate(strategy, options)</code> - 生成指定的鉴权中间件<ul><li><code>options.successRedirect</code> - 指定鉴权成功后的 redirect 地址</li><li><code>options.loginURL</code> - 跳转登录地址，默认为 <code>/passport/${strategy}</code></li><li><code>options.callbackURL</code> - 授权后回调地址，默认为 <code>/passport/${strategy}/callback</code></li></ul></li><li><code>app.passport.mount(strategy, options)</code> - 语法糖，方便开发者配置路由</li></ul><h2 id="使用-passport-生态">使用 Passport 生态</h2><p><a href="http://www.passportjs.org/">Passport</a> 的中间件很多，不可能都进行二次封装。
接下来，我们来看看如何在框架中直接使用 Passport 中间件。
以『账号密码登录方式』的 <a href="https://github.com/jaredhanson/passport-local">passport-local</a> 为例：</p><h3 id="安装">安装</h3><pre><code class="language-bash">$ npm i --save passport-local</code></pre><h3 id="配置">配置</h3><pre><code class="language-js">// app.js
const LocalStrategy = require(&#x27;passport-local&#x27;).Strategy;

module.exports = app =&gt; {
  // 挂载 strategy
  app.passport.use(new LocalStrategy({
    passReqToCallback: true,
  }, (req, username, password, done) =&gt; {
    // format user
    const user = {
      provider: &#x27;local&#x27;,
      username,
      password,
    };
    debug(&#x27;%s %s get user: %j&#x27;, req.method, req.url, user);
    app.passport.doVerify(req, user, done);
  }));

  // 处理用户信息
  app.passport.verify(async (ctx, user) =&gt; {});
  app.passport.serializeUser(async (ctx, user) =&gt; {});
  app.passport.deserializeUser(async (ctx, user) =&gt; {});
};</code></pre><h3 id="挂载路由">挂载路由</h3><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  const { router, controller } = app;
  router.get(&#x27;/&#x27;, controller.home.index);

  // 鉴权成功后的回调页面
  router.get(&#x27;/authCallback&#x27;, controller.home.authCallback);

  // 渲染登录页面，用户输入账号密码
  router.get(&#x27;/login&#x27;, controller.home.login);
  // 登录校验
  router.post(&#x27;/login&#x27;, app.passport.authenticate(&#x27;local&#x27;, { successRedirect: &#x27;/authCallback&#x27; }));
};</code></pre><h2 id="如何开发一个-egg-passport-插件">如何开发一个 egg-passport 插件</h2><p>在上一节中，我们学会了如何在框架中使用 Passport 中间件，我们可以进一步把它封装成插件，回馈社区。</p><p><strong>初始化：</strong></p><pre><code class="language-bash">$ egg-init --type=plugin egg-passport-local</code></pre><p>在 <code>package.json</code> 中<strong>配置依赖：</strong></p><pre><code class="language-json">{
  &quot;name&quot;: &quot;egg-passport-local&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;passportLocal&quot;,
    &quot;dependencies&quot;: [
      &quot;passport&quot;
    ]
  },
  &quot;dependencies&quot;: {
    &quot;passport-local&quot;: &quot;^1.0.0&quot;
  }
}</code></pre><p><strong>配置：</strong></p><pre><code class="language-js">// {plugin_root}/config/config.default.js
// https://github.com/jaredhanson/passport-local
exports.passportLocal = {
};</code></pre><p>注意：<a href="https://github.com/eggjs/egg-passport">egg-passport</a> 标准化了配置字段，统一为 <code>key</code> 和 <code>secret</code>，故若对应的 Passport 中间件属性名不一致时，开发者应该进行转换。</p><p><strong>注册 passport 中间件：</strong></p><pre><code class="language-js">// {plugin_root}/app.js
const LocalStrategy = require(&#x27;passport-local&#x27;).Strategy;

module.exports = app =&gt; {
  const config = app.config.passportLocal;
  config.passReqToCallback = true;

  app.passport.use(new LocalStrategy(config, (req, username, password, done) =&gt; {
    // 把 Passport 插件返回的数据进行清洗处理，返回 User 对象
    const user = {
      provider: &#x27;local&#x27;,
      username,
      password,
    };
    // 这里不处理应用层逻辑，传给 app.passport.verify 统一处理
    app.passport.doVerify(req, user, done);
  }));
};</code></pre></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E4%BD%BF%E7%94%A8-egg-passport">使用 egg-passport</a><ul><li><a href="#%E5%AE%89%E8%A3%85">安装</a></li><li><a href="#%E9%85%8D%E7%BD%AE">配置</a></li><li><a href="#%E6%8C%82%E8%BD%BD%E8%B7%AF%E7%94%B1">挂载路由</a></li><li><a href="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%A4%84%E7%90%86">用户信息处理</a></li><li><a href="#api">API</a></li></ul></li><li><a href="#%E4%BD%BF%E7%94%A8-passport-%E7%94%9F%E6%80%81">使用 Passport 生态</a><ul><li><a href="#%E5%AE%89%E8%A3%85">安装</a></li><li><a href="#%E9%85%8D%E7%BD%AE">配置</a></li><li><a href="#%E6%8C%82%E8%BD%BD%E8%B7%AF%E7%94%B1">挂载路由</a></li></ul></li><li><a href="#%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-egg-passport-%E6%8F%92%E4%BB%B6">如何开发一个 egg-passport 插件</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E4%BD%BF%E7%94%A8%20egg-passport%5D(%23%25E4%25BD%25BF%25E7%2594%25A8-egg-passport)%0A%20%20*%20%5B%E5%AE%89%E8%A3%85%5D(%23%25E5%25AE%2589%25E8%25A3%2585)%0A%20%20*%20%5B%E9%85%8D%E7%BD%AE%5D(%23%25E9%2585%258D%25E7%25BD%25AE)%0A%20%20*%20%5B%E6%8C%82%E8%BD%BD%E8%B7%AF%E7%94%B1%5D(%23%25E6%258C%2582%25E8%25BD%25BD%25E8%25B7%25AF%25E7%2594%25B1)%0A%20%20*%20%5B%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%A4%84%E7%90%86%5D(%23%25E7%2594%25A8%25E6%2588%25B7%25E4%25BF%25A1%25E6%2581%25AF%25E5%25A4%2584%25E7%2590%2586)%0A%20%20*%20%5BAPI%5D(%23api)%0A-%20%5B%E4%BD%BF%E7%94%A8%20Passport%20%E7%94%9F%E6%80%81%5D(%23%25E4%25BD%25BF%25E7%2594%25A8-passport-%25E7%2594%259F%25E6%2580%2581)%0A%20%20*%20%5B%E5%AE%89%E8%A3%85%5D(%23%25E5%25AE%2589%25E8%25A3%2585)%0A%20%20*%20%5B%E9%85%8D%E7%BD%AE%5D(%23%25E9%2585%258D%25E7%25BD%25AE)%0A%20%20*%20%5B%E6%8C%82%E8%BD%BD%E8%B7%AF%E7%94%B1%5D(%23%25E6%258C%2582%25E8%25BD%25BD%25E8%25B7%25AF%25E7%2594%25B1)%0A-%20%5B%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%20egg-passport%20%E6%8F%92%E4%BB%B6%5D(%23%25E5%25A6%2582%25E4%25BD%2595%25E5%25BC%2580%25E5%258F%2591%25E4%25B8%2580%25E4%25B8%25AA-egg-passport-%25E6%258F%2592%25E4%25BB%25B6)","meta":{"info":{"title":"Passport"}},"content":"%0A%0A%0A**%E3%80%8E%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83%E3%80%8F**%20%E6%98%AF%E4%B8%80%E4%B8%AA%E5%B8%B8%E8%A7%81%E7%9A%84%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%EF%BC%8C%E5%8C%85%E6%8B%AC%E3%80%8E%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%96%B9%E5%BC%8F%E3%80%8F%E5%92%8C%E3%80%8E%E7%AC%AC%E4%B8%89%E6%96%B9%E7%BB%9F%E4%B8%80%E7%99%BB%E5%BD%95%E3%80%8F%E3%80%82%0A%0A%E5%85%B6%E4%B8%AD%EF%BC%8C%E5%90%8E%E8%80%85%E6%88%91%E4%BB%AC%E7%BB%8F%E5%B8%B8%E4%BD%BF%E7%94%A8%E5%88%B0%EF%BC%8C%E5%A6%82%20Google%EF%BC%8C%20GitHub%EF%BC%8CQQ%20%E7%BB%9F%E4%B8%80%E7%99%BB%E5%BD%95%EF%BC%8C%E5%AE%83%E4%BB%AC%E9%83%BD%E6%98%AF%E5%9F%BA%E4%BA%8E%20%5BOAuth%5D(https%3A%2F%2Foauth.net%2F2%2F)%20%E8%A7%84%E8%8C%83%E3%80%82%0A%0A%5BPassport%5D%20%E6%98%AF%E4%B8%80%E4%B8%AA%E6%89%A9%E5%B1%95%E6%80%A7%E5%BE%88%E5%BC%BA%E7%9A%84%E8%AE%A4%E8%AF%81%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%8C%E6%94%AF%E6%8C%81%20%60Github%60%EF%BC%8C%60Twitter%60%EF%BC%8C%60Facebook%60%20%E7%AD%89%E7%9F%A5%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%8E%82%E5%95%86%E7%9A%84%20%60Strategy%60%EF%BC%8C%E5%90%8C%E6%97%B6%E4%B9%9F%E6%94%AF%E6%8C%81%E9%80%9A%E8%BF%87%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%9A%84%E6%96%B9%E5%BC%8F%E8%BF%9B%E8%A1%8C%E7%99%BB%E5%BD%95%E6%8E%88%E6%9D%83%E6%A0%A1%E9%AA%8C%E3%80%82%0A%0AEgg%20%E5%9C%A8%E5%AE%83%E4%B9%8B%E4%B8%8A%E6%8F%90%E4%BE%9B%E4%BA%86%20%5Begg-passport%5D%20%E6%8F%92%E4%BB%B6%EF%BC%8C%E6%8A%8A%E5%88%9D%E5%A7%8B%E5%8C%96%E3%80%81%E9%89%B4%E6%9D%83%E6%88%90%E5%8A%9F%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E5%A4%84%E7%90%86%E7%AD%89%E9%80%9A%E7%94%A8%E9%80%BB%E8%BE%91%E5%B0%81%E8%A3%85%E6%8E%89%EF%BC%8C%E4%BD%BF%E5%BE%97%E5%BC%80%E5%8F%91%E8%80%85%E4%BB%85%E9%9C%80%E8%B0%83%E7%94%A8%E5%87%A0%E4%B8%AA%20API%20%E5%8D%B3%E5%8F%AF%E6%96%B9%E4%BE%BF%E7%9A%84%E4%BD%BF%E7%94%A8%20Passport%20%E3%80%82%0A%0A%5BPassport%5D%20%E7%9A%84%E6%89%A7%E8%A1%8C%E6%97%B6%E5%BA%8F%E5%A6%82%E4%B8%8B%EF%BC%9A%0A-%20%E7%94%A8%E6%88%B7%E8%AE%BF%E9%97%AE%E9%A1%B5%E9%9D%A2%0A-%20%E6%A3%80%E6%9F%A5%20Session%0A-%20%E6%8B%A6%E6%88%AA%E8%B7%B3%E9%89%B4%E6%9D%83%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%0A-%20Strategy%20%E9%89%B4%E6%9D%83%0A-%20%E6%A0%A1%E9%AA%8C%E5%92%8C%E5%AD%98%E5%82%A8%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%0A-%20%E5%BA%8F%E5%88%97%E5%8C%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%88%B0%20Session%0A-%20%E8%B7%B3%E8%BD%AC%E5%88%B0%E6%8C%87%E5%AE%9A%E9%A1%B5%E9%9D%A2%0A%0A%23%23%20%E4%BD%BF%E7%94%A8%20egg-passport%0A%0A%E4%B8%8B%E9%9D%A2%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B0%86%E4%BB%A5%20GitHub%20%E7%99%BB%E5%BD%95%E4%B8%BA%E4%BE%8B%EF%BC%8C%E6%9D%A5%E6%BC%94%E7%A4%BA%E4%B8%8B%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E3%80%82%0A%0A%23%23%23%20%E5%AE%89%E8%A3%85%0A%0A%60%60%60bash%0A%24%20npm%20i%20--save%20egg-passport%0A%24%20npm%20i%20--save%20egg-passport-github%0A%60%60%60%0A%0A%E6%9B%B4%E5%A4%9A%E6%8F%92%E4%BB%B6%E5%8F%82%E8%A7%81%20%5BGitHub%20Topic%20-%20egg-passport%5D(https%3A%2F%2Fgithub.com%2Ftopics%2Fegg-passport)%20%E3%80%82%0A%0A%23%23%23%20%E9%85%8D%E7%BD%AE%0A%0A**%E5%BC%80%E5%90%AF%E6%8F%92%E4%BB%B6%EF%BC%9A**%0A%0A%60%60%60js%0A%2F%2F%20config%2Fplugin.js%0Amodule.exports.passport%20%3D%20%7B%0A%20%20enable%3A%20true%2C%0A%20%20package%3A%20'egg-passport'%2C%0A%7D%3B%0A%0Amodule.exports.passportGithub%20%3D%20%7B%0A%20%20enable%3A%20true%2C%0A%20%20package%3A%20'egg-passport-github'%2C%0A%7D%3B%0A%60%60%60%0A%0A**%E9%85%8D%E7%BD%AE%3A**%0A%0A%E6%B3%A8%E6%84%8F%EF%BC%9A%5Begg-passport%5D%20%E6%A0%87%E5%87%86%E5%8C%96%E4%BA%86%E9%85%8D%E7%BD%AE%E5%AD%97%E6%AE%B5%EF%BC%8C%E7%BB%9F%E4%B8%80%E4%B8%BA%20%60key%60%20%E5%92%8C%20%60secret%60%20%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20config%2Fdefault.js%0Aconfig.passportGithub%20%3D%20%7B%0A%20%20key%3A%20'your_clientID'%2C%0A%20%20secret%3A%20'your_clientSecret'%2C%0A%20%20%2F%2F%20callbackURL%3A%20'%2Fpassport%2Fgithub%2Fcallback'%2C%0A%20%20%2F%2F%20proxy%3A%20false%2C%0A%7D%3B%0A%60%60%60%0A%0A**%E6%B3%A8%E6%84%8F%EF%BC%9A**%0A-%20%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20%5BGitHub%20OAuth%20Apps%5D(https%3A%2F%2Fgithub.com%2Fsettings%2Fapplications%2Fnew)%EF%BC%8C%E5%BE%97%E5%88%B0%20%60clientID%60%20%E5%92%8C%20%60clientSecret%60%20%E4%BF%A1%E6%81%AF%E3%80%82%0A-%20%E5%A1%AB%E5%86%99%20%60callbackURL%60%EF%BC%8C%E5%A6%82%20%60http%3A%2F%2F127.0.0.1%3A7001%2Fpassport%2Fgithub%2Fcallback%60%0A%20%20-%20%E7%BA%BF%E4%B8%8A%E9%83%A8%E7%BD%B2%E6%97%B6%E9%9C%80%E8%A6%81%E6%9B%B4%E6%96%B0%E4%B8%BA%E5%AF%B9%E5%BA%94%E7%9A%84%E5%9F%9F%E5%90%8D%0A%20%20-%20%E8%B7%AF%E5%BE%84%E4%B8%BA%E9%85%8D%E7%BD%AE%E7%9A%84%20%60options.callbackURL%60%EF%BC%8C%E9%BB%98%E8%AE%A4%E4%B8%BA%20%60%2Fpassport%2F%24%7Bstrategy%7D%2Fcallback%60%0A-%20%E5%A6%82%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E5%9C%A8%20Nginx%2FHAProxy%20%E4%B9%8B%E5%90%8E%EF%BC%8C%E9%9C%80%E8%AE%BE%E7%BD%AE%E6%8F%92%E4%BB%B6%20%60proxy%60%20%E9%80%89%E9%A1%B9%E4%B8%BA%20%60true%60%2C%20%E5%B9%B6%E6%A3%80%E6%9F%A5%E4%BB%A5%E4%B8%8B%E9%85%8D%E7%BD%AE%EF%BC%9A%0A%20%20-%20%E4%BB%A3%E7%90%86%E9%99%84%E5%8A%A0%20HTTP%20%E5%A4%B4%E5%AD%97%E6%AE%B5%EF%BC%9A%60x-forwarded-proto%60%20%E4%B8%8E%20%60x-forwarded-host%60%0A%20%20-%20%E9%85%8D%E7%BD%AE%E4%B8%AD%20%60config.proxy%60%20%E5%BA%94%E8%AE%BE%E7%BD%AE%E4%B8%BA%20%60true%60%0A%0A%23%23%23%20%E6%8C%82%E8%BD%BD%E8%B7%AF%E7%94%B1%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20%7B%20router%2C%20controller%20%7D%20%3D%20app%3B%0A%0A%20%20%2F%2F%20%E6%8C%82%E8%BD%BD%E9%89%B4%E6%9D%83%E8%B7%AF%E7%94%B1%0A%20%20app.passport.mount('github')%3B%0A%0A%20%20%2F%2F%20%E4%B8%8A%E9%9D%A2%E7%9A%84%20mount%20%E6%98%AF%E8%AF%AD%E6%B3%95%E7%B3%96%EF%BC%8C%E7%AD%89%E4%BB%B7%E4%BA%8E%0A%20%20%2F%2F%20const%20github%20%3D%20app.passport.authenticate('github'%2C%20%7B%7D)%3B%0A%20%20%2F%2F%20router.get('%2Fpassport%2Fgithub'%2C%20github)%3B%0A%20%20%2F%2F%20router.get('%2Fpassport%2Fgithub%2Fcallback'%2C%20github)%3B%0A%7D%0A%60%60%60%0A%0A%23%23%23%20%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%A4%84%E7%90%86%0A%0A%E6%8E%A5%E7%9D%80%EF%BC%8C%E6%88%91%E4%BB%AC%E8%BF%98%E9%9C%80%E8%A6%81%EF%BC%9A%0A-%20%E9%A6%96%E6%AC%A1%E7%99%BB%E5%BD%95%E6%97%B6%EF%BC%8C%E4%B8%80%E8%88%AC%E9%9C%80%E8%A6%81%E6%8A%8A%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E8%BF%9B%E8%A1%8C%E5%85%A5%E5%BA%93%EF%BC%8C%E5%B9%B6%E8%AE%B0%E5%BD%95%20Session%20%E3%80%82%0A-%20%E4%BA%8C%E6%AC%A1%E7%99%BB%E5%BD%95%E6%97%B6%EF%BC%8C%E4%BB%8E%20OAuth%20%E6%88%96%20Session%20%E6%8B%BF%E5%88%B0%E7%9A%84%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%EF%BC%8C%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8B%BF%E5%88%B0%E5%AE%8C%E6%95%B4%E7%9A%84%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.passport.verify(async%20(ctx%2C%20user)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%E6%A3%80%E6%9F%A5%E7%94%A8%E6%88%B7%0A%20%20%20%20assert(user.provider%2C%20'user.provider%20should%20exists')%3B%0A%20%20%20%20assert(user.id%2C%20'user.id%20should%20exists')%3B%0A%0A%20%20%20%20%2F%2F%20%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E6%9F%A5%E6%89%BE%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%0A%20%20%20%20%2F%2F%0A%20%20%20%20%2F%2F%20Authorization%20Table%0A%20%20%20%20%2F%2F%20column%20%20%20%7C%20desc%0A%20%20%20%20%2F%2F%20---%20%20%20%20%20%20%7C%20--%0A%20%20%20%20%2F%2F%20provider%20%7C%20provider%20name%2C%20like%20github%2C%20twitter%2C%20facebook%2C%20weibo%20and%20so%20on%0A%20%20%20%20%2F%2F%20uid%20%20%20%20%20%20%7C%20provider%20unique%20id%0A%20%20%20%20%2F%2F%20user_id%20%20%7C%20current%20application%20user%20id%0A%20%20%20%20const%20auth%20%3D%20await%20ctx.model.Authorization.findOne(%7B%0A%20%20%20%20%20%20uid%3A%20user.id%2C%0A%20%20%20%20%20%20provider%3A%20user.provider%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20const%20existsUser%20%3D%20await%20ctx.model.User.findOne(%7B%20id%3A%20auth.user_id%20%7D)%3B%0A%20%20%20%20if%20(existsUser)%20%7B%0A%20%20%20%20%20%20return%20existsUser%3B%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8%20service%20%E6%B3%A8%E5%86%8C%E6%96%B0%E7%94%A8%E6%88%B7%0A%20%20%20%20const%20newUser%20%3D%20await%20ctx.service.user.register(user)%3B%0A%20%20%20%20return%20newUser%3B%0A%20%20%7D)%3B%0A%0A%20%20%2F%2F%20%E5%B0%86%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E5%AD%98%E8%BF%9B%20session%20%E9%87%8C%E9%9D%A2%EF%BC%8C%E4%B8%80%E8%88%AC%E9%9C%80%E8%A6%81%E7%B2%BE%E7%AE%80%EF%BC%8C%E5%8F%AA%E4%BF%9D%E5%AD%98%E4%B8%AA%E5%88%AB%E5%AD%97%E6%AE%B5%0A%20%20app.passport.serializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%0A%20%20%2F%2F%20%E5%A4%84%E7%90%86%20user%0A%20%20%2F%2F%20...%0A%20%20%2F%2F%20return%20user%3B%0A%20%20%7D)%3B%0A%0A%20%20%2F%2F%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E6%8A%8A%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E4%BB%8E%20session%20%E4%B8%AD%E5%8F%96%E5%87%BA%E6%9D%A5%EF%BC%8C%E5%8F%8D%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8B%BF%E5%88%B0%E5%AE%8C%E6%95%B4%E4%BF%A1%E6%81%AF%0A%20%20app.passport.deserializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%0A%20%20%2F%2F%20%E5%A4%84%E7%90%86%20user%0A%20%20%2F%2F%20...%0A%20%20%2F%2F%20return%20user%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%E8%87%B3%E6%AD%A4%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B0%B1%E5%AE%8C%E6%88%90%E4%BA%86%E6%89%80%E6%9C%89%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%AE%8C%E6%95%B4%E7%9A%84%E7%A4%BA%E4%BE%8B%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%A7%81%EF%BC%9A%5Beggjs%2Fexamples%2Fpassport%5D%0A%0A%23%23%23%20API%0A%0A%5Begg-passport%5D%20%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%A5%E4%B8%8B%E6%89%A9%E5%B1%95%EF%BC%9A%0A%0A-%20%60ctx.user%60%20-%20%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%B7%B2%E7%99%BB%E5%BD%95%E7%9A%84%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%0A-%20%60ctx.isAuthenticated()%60%20-%20%E6%A3%80%E6%9F%A5%E8%AF%A5%E8%AF%B7%E6%B1%82%E6%98%AF%E5%90%A6%E5%B7%B2%E6%8E%88%E6%9D%83%0A-%20%60ctx.login(user%2C%20%5Boptions%5D)%60%20-%20%E4%B8%BA%E7%94%A8%E6%88%B7%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%E7%99%BB%E5%BD%95%E7%9A%84%20session%0A-%20%60ctx.logout()%60%20-%20%E9%80%80%E5%87%BA%EF%BC%8C%E5%B0%86%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E4%BB%8E%20session%20%E4%B8%AD%E6%B8%85%E9%99%A4%0A-%20%60ctx.session.returnTo%3D%60%20-%20%E5%9C%A8%E8%B7%B3%E8%BD%AC%E9%AA%8C%E8%AF%81%E5%89%8D%E8%AE%BE%E7%BD%AE%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%8C%87%E5%AE%9A%E6%88%90%E5%8A%9F%E5%90%8E%E7%9A%84%20redirect%20%E5%9C%B0%E5%9D%80%0A%0A%E8%BF%98%E6%8F%90%E4%BE%9B%E4%BA%86%20API%EF%BC%9A%0A%0A-%20%60app.passport.verify(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%60%20-%20%E6%A0%A1%E9%AA%8C%E7%94%A8%E6%88%B7%0A-%20%60app.passport.serializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%60%20-%20%E5%BA%8F%E5%88%97%E5%8C%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%90%8E%E5%AD%98%E5%82%A8%E8%BF%9B%20session%0A-%20%60app.passport.deserializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%60%20-%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E5%8F%96%E5%87%BA%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%0A-%20%60app.passport.authenticate(strategy%2C%20options)%60%20-%20%E7%94%9F%E6%88%90%E6%8C%87%E5%AE%9A%E7%9A%84%E9%89%B4%E6%9D%83%E4%B8%AD%E9%97%B4%E4%BB%B6%0A%20%20-%20%60options.successRedirect%60%20-%20%E6%8C%87%E5%AE%9A%E9%89%B4%E6%9D%83%E6%88%90%E5%8A%9F%E5%90%8E%E7%9A%84%20redirect%20%E5%9C%B0%E5%9D%80%0A%20%20-%20%60options.loginURL%60%20-%20%E8%B7%B3%E8%BD%AC%E7%99%BB%E5%BD%95%E5%9C%B0%E5%9D%80%EF%BC%8C%E9%BB%98%E8%AE%A4%E4%B8%BA%20%60%2Fpassport%2F%24%7Bstrategy%7D%60%0A%20%20-%20%60options.callbackURL%60%20-%20%E6%8E%88%E6%9D%83%E5%90%8E%E5%9B%9E%E8%B0%83%E5%9C%B0%E5%9D%80%EF%BC%8C%E9%BB%98%E8%AE%A4%E4%B8%BA%20%60%2Fpassport%2F%24%7Bstrategy%7D%2Fcallback%60%0A-%20%60app.passport.mount(strategy%2C%20options)%60%20-%20%E8%AF%AD%E6%B3%95%E7%B3%96%EF%BC%8C%E6%96%B9%E4%BE%BF%E5%BC%80%E5%8F%91%E8%80%85%E9%85%8D%E7%BD%AE%E8%B7%AF%E7%94%B1%0A%0A%23%23%20%E4%BD%BF%E7%94%A8%20Passport%20%E7%94%9F%E6%80%81%0A%0A%5BPassport%5D%20%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BE%88%E5%A4%9A%EF%BC%8C%E4%B8%8D%E5%8F%AF%E8%83%BD%E9%83%BD%E8%BF%9B%E8%A1%8C%E4%BA%8C%E6%AC%A1%E5%B0%81%E8%A3%85%E3%80%82%0A%E6%8E%A5%E4%B8%8B%E6%9D%A5%EF%BC%8C%E6%88%91%E4%BB%AC%E6%9D%A5%E7%9C%8B%E7%9C%8B%E5%A6%82%E4%BD%95%E5%9C%A8%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%20Passport%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E3%80%82%0A%E4%BB%A5%E3%80%8E%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%96%B9%E5%BC%8F%E3%80%8F%E7%9A%84%20%5Bpassport-local%5D%20%E4%B8%BA%E4%BE%8B%EF%BC%9A%0A%0A%23%23%23%20%E5%AE%89%E8%A3%85%0A%0A%60%60%60bash%0A%24%20npm%20i%20--save%20passport-local%0A%60%60%60%0A%0A%23%23%23%20%E9%85%8D%E7%BD%AE%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Aconst%20LocalStrategy%20%3D%20require('passport-local').Strategy%3B%0A%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%2F%2F%20%E6%8C%82%E8%BD%BD%20strategy%0A%20%20app.passport.use(new%20LocalStrategy(%7B%0A%20%20%20%20passReqToCallback%3A%20true%2C%0A%20%20%7D%2C%20(req%2C%20username%2C%20password%2C%20done)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20format%20user%0A%20%20%20%20const%20user%20%3D%20%7B%0A%20%20%20%20%20%20provider%3A%20'local'%2C%0A%20%20%20%20%20%20username%2C%0A%20%20%20%20%20%20password%2C%0A%20%20%20%20%7D%3B%0A%20%20%20%20debug('%25s%20%25s%20get%20user%3A%20%25j'%2C%20req.method%2C%20req.url%2C%20user)%3B%0A%20%20%20%20app.passport.doVerify(req%2C%20user%2C%20done)%3B%0A%20%20%7D))%3B%0A%0A%20%20%2F%2F%20%E5%A4%84%E7%90%86%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%0A%20%20app.passport.verify(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%3B%0A%20%20app.passport.serializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%3B%0A%20%20app.passport.deserializeUser(async%20(ctx%2C%20user)%20%3D%3E%20%7B%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20%E6%8C%82%E8%BD%BD%E8%B7%AF%E7%94%B1%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20%7B%20router%2C%20controller%20%7D%20%3D%20app%3B%0A%20%20router.get('%2F'%2C%20controller.home.index)%3B%0A%0A%20%20%2F%2F%20%E9%89%B4%E6%9D%83%E6%88%90%E5%8A%9F%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E9%A1%B5%E9%9D%A2%0A%20%20router.get('%2FauthCallback'%2C%20controller.home.authCallback)%3B%0A%0A%20%20%2F%2F%20%E6%B8%B2%E6%9F%93%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%EF%BC%8C%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%0A%20%20router.get('%2Flogin'%2C%20controller.home.login)%3B%0A%20%20%2F%2F%20%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%0A%20%20router.post('%2Flogin'%2C%20app.passport.authenticate('local'%2C%20%7B%20successRedirect%3A%20'%2FauthCallback'%20%7D))%3B%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%20egg-passport%20%E6%8F%92%E4%BB%B6%0A%0A%E5%9C%A8%E4%B8%8A%E4%B8%80%E8%8A%82%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E5%AD%A6%E4%BC%9A%E4%BA%86%E5%A6%82%E4%BD%95%E5%9C%A8%E6%A1%86%E6%9E%B6%E4%B8%AD%E4%BD%BF%E7%94%A8%20Passport%20%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%8A%8A%E5%AE%83%E5%B0%81%E8%A3%85%E6%88%90%E6%8F%92%E4%BB%B6%EF%BC%8C%E5%9B%9E%E9%A6%88%E7%A4%BE%E5%8C%BA%E3%80%82%0A%0A**%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%9A**%0A%0A%60%60%60bash%0A%24%20egg-init%20--type%3Dplugin%20egg-passport-local%0A%60%60%60%0A%0A%E5%9C%A8%20%60package.json%60%20%E4%B8%AD**%E9%85%8D%E7%BD%AE%E4%BE%9D%E8%B5%96%EF%BC%9A**%0A%0A%60%60%60json%0A%7B%0A%20%20%22name%22%3A%20%22egg-passport-local%22%2C%0A%20%20%22version%22%3A%20%221.0.0%22%2C%0A%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%22name%22%3A%20%22passportLocal%22%2C%0A%20%20%20%20%22dependencies%22%3A%20%5B%0A%20%20%20%20%20%20%22passport%22%0A%20%20%20%20%5D%0A%20%20%7D%2C%0A%20%20%22dependencies%22%3A%20%7B%0A%20%20%20%20%22passport-local%22%3A%20%22%5E1.0.0%22%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A**%E9%85%8D%E7%BD%AE%EF%BC%9A**%0A%0A%60%60%60js%0A%2F%2F%20%7Bplugin_root%7D%2Fconfig%2Fconfig.default.js%0A%2F%2F%20https%3A%2F%2Fgithub.com%2Fjaredhanson%2Fpassport-local%0Aexports.passportLocal%20%3D%20%7B%0A%7D%3B%0A%60%60%60%0A%0A%E6%B3%A8%E6%84%8F%EF%BC%9A%5Begg-passport%5D%20%E6%A0%87%E5%87%86%E5%8C%96%E4%BA%86%E9%85%8D%E7%BD%AE%E5%AD%97%E6%AE%B5%EF%BC%8C%E7%BB%9F%E4%B8%80%E4%B8%BA%20%60key%60%20%E5%92%8C%20%60secret%60%EF%BC%8C%E6%95%85%E8%8B%A5%E5%AF%B9%E5%BA%94%E7%9A%84%20Passport%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%B1%9E%E6%80%A7%E5%90%8D%E4%B8%8D%E4%B8%80%E8%87%B4%E6%97%B6%EF%BC%8C%E5%BC%80%E5%8F%91%E8%80%85%E5%BA%94%E8%AF%A5%E8%BF%9B%E8%A1%8C%E8%BD%AC%E6%8D%A2%E3%80%82%0A%0A**%E6%B3%A8%E5%86%8C%20passport%20%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%9A**%0A%0A%60%60%60js%0A%2F%2F%20%7Bplugin_root%7D%2Fapp.js%0Aconst%20LocalStrategy%20%3D%20require('passport-local').Strategy%3B%0A%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20config%20%3D%20app.config.passportLocal%3B%0A%20%20config.passReqToCallback%20%3D%20true%3B%0A%0A%20%20app.passport.use(new%20LocalStrategy(config%2C%20(req%2C%20username%2C%20password%2C%20done)%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%E6%8A%8A%20Passport%20%E6%8F%92%E4%BB%B6%E8%BF%94%E5%9B%9E%E7%9A%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E6%B8%85%E6%B4%97%E5%A4%84%E7%90%86%EF%BC%8C%E8%BF%94%E5%9B%9E%20User%20%E5%AF%B9%E8%B1%A1%0A%20%20%20%20const%20user%20%3D%20%7B%0A%20%20%20%20%20%20provider%3A%20'local'%2C%0A%20%20%20%20%20%20username%2C%0A%20%20%20%20%20%20password%2C%0A%20%20%20%20%7D%3B%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E4%B8%8D%E5%A4%84%E7%90%86%E5%BA%94%E7%94%A8%E5%B1%82%E9%80%BB%E8%BE%91%EF%BC%8C%E4%BC%A0%E7%BB%99%20app.passport.verify%20%E7%BB%9F%E4%B8%80%E5%A4%84%E7%90%86%0A%20%20%20%20app.passport.doVerify(req%2C%20user%2C%20done)%3B%0A%20%20%7D))%3B%0A%7D%3B%0A%60%60%60%0A%0A%5BPassport%5D%3A%20http%3A%2F%2Fwww.passportjs.org%2F%0A%5Begg-passport%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-passport%0A%5Bpassport-local%5D%3A%20https%3A%2F%2Fgithub.com%2Fjaredhanson%2Fpassport-local%0A%5Beggjs%2Fexamples%2Fpassport%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fexamples%2Ftree%2Fmaster%2Fpassport%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>