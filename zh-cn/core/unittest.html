<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>单元测试</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><h2 id="为什么要单元测试">为什么要单元测试</h2><p>先问我们自己以下几个问题：</p><ul><li>你的代码质量如何度量？</li><li>你是如何保证代码质量？</li><li>你敢随时重构代码吗？</li><li>你是如何确保重构的代码依然保持正确性？</li><li>你是否有足够信心在没有测试的情况下随时发布你的代码？</li></ul><p>如果答案都比较犹豫，那么就证明我们非常需要单元测试。</p><p>它能带给我们很多保障：</p><ul><li>代码质量持续有保障</li><li>重构正确性保障</li><li>增强自信心</li><li>自动化运行</li></ul><p>Web 应用中的单元测试更加重要，在 Web 产品快速迭代的时期，每个测试用例都给应用的稳定性提供了一层保障。
API 升级，测试用例可以很好地检查代码是否向下兼容。
对于各种可能的输入，一旦测试覆盖，都能明确它的输出。
代码改动后，可以通过测试结果判断代码的改动是否影响已确定的结果。</p><p>所以，应用的 Controller、Service、Helper、Extend 等代码，都必须有对应的单元测试保证代码质量。
当然，框架和插件的每个功能改动和重构都需要有相应的单元测试，并且要求尽量做到修改的代码能被 100% 覆盖到。</p><h2 id="测试框架">测试框架</h2><p>从 <a href="https://www.npmjs.com/search?q=test%20framework&amp;page=1&amp;ranking=popularity">npm 搜索『test framework』</a>，
我们会发现有大量测试框架存在，每个测试框架都有它的独特之处。</p><h3 id="mocha">Mocha</h3><p>我们选择和推荐大家使用 <a href="http://mochajs.org">Mocha</a>，功能非常丰富，支持运行在 Node.js 和浏览器中，
对异步测试支持非常友好。</p><blockquote><p>Mocha is a feature-rich JavaScript test framework running on Node.js and in the browser, making asynchronous testing simple and fun. Mocha tests run serially, allowing for flexible and accurate reporting, while mapping uncaught exceptions to the correct test cases.</p></blockquote><h3 id="ava">AVA</h3><p>为什么没有选择最近比较火的 <a href="https://github.com/avajs/ava">AVA</a>，它看起来会跑得很快。
经过我们几个真实项目实践下来，AVA 真的只是看起来很美，但是实际会让测试代码越来越难写，成本越来越高。</p><p><a href="https://github.com/dead-horse">@dead-horse</a> 的评价：</p><blockquote><ul><li>AVA 自身不够稳定，并发运行文件多的时候会撑爆 CPU；如果设置控制并发参数的方式运行，会导致 only 模式无效。</li><li>并发执行对测试用例的要求很高，所有的测试不能有依赖，特别是遇到一些需要做 mock 的场景时，写好很难。</li><li>app 在初始化的时候是有耗时的，如果串行运行，只需要初始化一个 app 对它测试。
但是 AVA 每一个文件都运行在独立进程，有多少个文件就需要初始化多少个 app。</li></ul></blockquote><p><a href="https://github.com/fool2fish">@fool2fish</a> 的评价：</p><blockquote><p>如果是简单的程序的话用 AVA 会快一些（但是本来就简单可能也没啥感觉），
如果是复杂的就不推荐了，比较大的问题是可能没法给出准确的错误堆栈，
另外并发可能会导致依赖的其他测试环境的服务挂掉，降低测试的成功率，
还有就是带流程的测试（比如测试数据库的增删改查功能）真心不适合用 AVA。</p></blockquote><h2 id="断言库">断言库</h2><p>同样，测试断言库也是<a href="https://www.npmjs.com/search?q=assert&amp;page=1&amp;ranking=popularity">百花齐放的时代</a>，
我们经历过 <a href="https://nodejs.org/api/assert.html">assert</a>，到 <a href="https://github.com/shouldjs/should.js">should</a> 和 <a href="https://github.com/Automattic/expect.js">expect</a>，还是不断地在尝试更好的断言库。</p><p>直到我们发现 <a href="https://github.com/power-assert-js/power-assert">power-assert</a>，
因为<a href="https://github.com/atian25/blog/issues/16">『No API is the best API』</a>，
最终我们重新回归原始的 assert 作为默认的断言库。</p><p>简单地说，它的优点是：</p><ul><li>没有 API 就是最好的 API，不需要任何记忆，只需 assert 即可。</li><li><strong>强大的错误信息反馈</strong></li><li><strong>强大的错误信息反馈</strong></li><li><strong>强大的错误信息反馈</strong></li></ul><p>报错信息实在太美太详细，让人有种想看错误报告的欲望：</p><p><img src="https://cloud.githubusercontent.com/assets/227713/20919940/19e83de8-bbd9-11e6-8951-bf4a332f9b5a.png"/></p><h2 id="测试约定">测试约定</h2><p>为了让我们更多地关注测试用例本身如何编写，而不是耗费时间在如何运行测试脚本等辅助工作上，
框架对单元测试做了一些基本约定。</p><h3 id="测试目录结构">测试目录结构</h3><p>我们约定 <code>test</code> 目录为存放所有测试脚本的目录，测试所使用到的 <code>fixtures</code> 和相关辅助脚本都应该放在此目录下。</p><p>测试脚本文件统一按 <code>${filename}.test.js</code> 命名，必须以 <code>.test.js</code> 作为文件后缀。</p><p>一个应用的测试目录示例：</p><pre><code class="language-bash">test
├── controller
│   └── home.test.js
├── hello.test.js
└── service
    └── user.test.js</code></pre><h3 id="测试运行工具">测试运行工具</h3><p>统一使用 <a href="./development.md#单元测试">egg-bin 来运行测试脚本</a>，
自动将内置的 <a href="https://mochajs.org">Mocha</a>、<a href="https://github.com/blakeembrey/co-mocha">co-mocha</a>、<a href="https://github.com/power-assert-js/power-assert">power-assert</a>，<a href="https://github.com/istanbuljs/nyc">nyc</a> 等模块组合引入到测试脚本中，
让我们<strong>聚焦精力在编写测试代码</strong>上，而不是纠结选择那些测试周边工具和模块。</p><p>只需要在 <code>package.json</code> 上配置好 <code>scripts.test</code> 即可。</p><pre><code class="language-json">{
  &quot;scripts&quot;: {
    &quot;test&quot;: &quot;egg-bin test&quot;
  }
}</code></pre><p>然后就可以按标准的 <code>npm test</code> 来运行测试了。</p><pre><code class="language-bash">npm test

&gt; unittest-example@ test /Users/mk2/git/github.com/eggjs/examples/unittest
&gt; egg-bin test

  test/hello.test.js
    ✓ should work

  1 passing (10ms)</code></pre><h2 id="准备测试">准备测试</h2><p>本文主要介绍如何编写应用的单元测试，关于框架和插件的单元测试请查看<a href="../advanced/framework.md">框架开发</a>和<a href="../advanced/plugin.md">插件开发</a>相关章节。</p><h3 id="mock">mock</h3><p>正常来说，如果要完整手写一个 app 创建和启动代码，还是需要写一段初始化脚本的，
并且还需要在测试跑完之后做一些清理工作，如删除临时文件，销毁 app。</p><p>常常还有模拟各种网络异常，服务访问异常等特殊情况。</p><p>所以我们单独为框架抽取了一个测试 mock 辅助模块：<a href="https://github.com/eggjs/egg-mock">egg-mock</a>，
有了它我们就可以非常快速地编写一个 app 的单元测试，并且还能快速创建一个 ctx 来测试它的属性、方法和 Service 等。</p><h3 id="app">app</h3><p>在测试运行之前，我们首先要创建应用的一个 app 实例，
通过它来访问需要被测试的 Controller、Middleware、Service 等应用层代码。</p><p>通过 egg-mock，结合 Mocha 的 <code>before</code> 钩子就可以便捷地创建出一个 app 实例。</p><pre><code class="language-js">// test/controller/home.test.js
const assert = require(&#x27;assert&#x27;);
const mock = require(&#x27;egg-mock&#x27;);

describe(&#x27;test/controller/home.test.js&#x27;, () =&gt; {
  let app;
  before(() =&gt; {
    // 创建当前应用的 app 实例
    app = mock.app();
    // 等待 app 启动成功，才能执行测试用例
    return app.ready();
  });
});</code></pre><p>这样我们就拿到了一个 app 的引用，接下来所有测试用例都会基于这个 app 进行。
更多关于创建 app 的信息请查看 <a href="https://github.com/eggjs/egg-mock#options"><code>mock.app(options)</code></a> 文档。</p><p>每一个测试文件都需要这样创建一个 app 实例非常冗余，因此 egg-mock 提供了一个 bootstrap 文件，可以直接从它上面拿到我们所常用的实例：</p><pre><code class="language-js">// test/controller/home.test.js
const { app, mock, assert } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;test/controller/home.test.js&#x27;, () =&gt; {
  // test cases
});</code></pre><h3 id="ctx">ctx</h3><p>我们除了 app，还需要一种方式便捷地拿到 ctx，方便我们进行 Extend、Service、Helper 等测试。
而我们已经通过上面的方式拿到了一个 app，结合 egg-mock 提供的 <a href="https://github.com/eggjs/egg-mock#appmockcontextoptions"><code>app.mockContext(options)</code></a> 方法来快速创建一个 ctx 实例。</p><pre><code class="language-js">it(&#x27;should get a ctx&#x27;, () =&gt; {
  const ctx = app.mockContext();
  assert(ctx.method === &#x27;GET&#x27;);
  assert(ctx.url === &#x27;/&#x27;);
});</code></pre><p>如果我们想模拟 <code>ctx.user</code> 这个数据，也可以通过给 mockContext 传递 data 参数实现：</p><pre><code class="language-js">it(&#x27;should mock ctx.user&#x27;, () =&gt; {
  const ctx = app.mockContext({
    user: {
      name: &#x27;fengmk2&#x27;,
    },
  });
  assert(ctx.user);
  assert(ctx.user.name === &#x27;fengmk2&#x27;);
});</code></pre><p>现在我们拿到了 app，也知道如何创建一个 ctx 了，那么就可以进行更多代码的单元测试了。</p><h2 id="测试执行顺序">测试执行顺序</h2><p>特别需要注意的是执行顺序，尽量保证在执行某个用例的时候执行相关代码。</p><p>常见的错误写法</p><pre><code class="language-js">// Bad
const { app } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;bad test&#x27;, () =&gt; {
  doSomethingBefore();

  it(&#x27;should redirect&#x27;, () =&gt; {
    return app.httpRequest()
      .get(&#x27;/&#x27;)
      .expect(302);
  });
});</code></pre><p>Mocha 刚开始运行的时候会载入所有用例，这时 describe 方法就会被调用，那 <code>doSomethingBefore</code> 就会启动。
如果希望使用 only 的方式只执行某个用例那段代码还是会被执行，这是非预期的。</p><p>正确的做法是将其放到 before 中，只有运行这个套件中某个用例才会执行。</p><pre><code class="language-js">// Good
const { app } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;good test&#x27;, () =&gt; {
  before(() =&gt; doSomethingBefore());

  it(&#x27;should redirect&#x27;, () =&gt; {
    return app.httpRequest()
      .get(&#x27;/&#x27;)
      .expect(302);
  });
});</code></pre><p>Mocha 使用 before/after/beforeEach/afterEach 来处理前置后置任务，基本能处理所有问题。
每个用例会按 before -&gt; beforeEach -&gt; it -&gt; afterEach -&gt; after 的顺序执行，而且可以定义多个。</p><pre><code class="language-js">describe(&#x27;egg test&#x27;, () =&gt; {
  before(() =&gt; console.log(&#x27;order 1&#x27;));
  before(() =&gt; console.log(&#x27;order 2&#x27;));
  after(() =&gt; console.log(&#x27;order 6&#x27;));
  beforeEach(() =&gt; console.log(&#x27;order 3&#x27;));
  afterEach(() =&gt; console.log(&#x27;order 5&#x27;));
  it(&#x27;should worker&#x27;, () =&gt; console.log(&#x27;order 4&#x27;));
});</code></pre><h2 id="异步测试">异步测试</h2><p>egg-bin 支持测试异步调用，它支持多种写法：</p><pre><code class="language-js">// 使用返回 Promise 的方式
it(&#x27;should redirect&#x27;, () =&gt; {
  return app.httpRequest()
    .get(&#x27;/&#x27;)
    .expect(302);
});

// 使用 callback 的方式
it(&#x27;should redirect&#x27;, done =&gt; {
  app.httpRequest()
    .get(&#x27;/&#x27;)
    .expect(302, done);
});

// 使用 async
it(&#x27;should redirect&#x27;, async () =&gt; {
  await app.httpRequest()
    .get(&#x27;/&#x27;)
    .expect(302);
});</code></pre><p>使用哪种写法取决于不同应用场景，如果遇到多个异步可以使用 async function，也可以拆分成多个测试用例。</p><h2 id="controller-测试">Controller 测试</h2><p>Controller 在整个应用代码里面属于比较难测试的部分了，因为它跟 router 配置紧密相关，
我们需要利用 <code>app.httpRequest()</code> <a href="https://github.com/visionmedia/supertest">SuperTest</a> 发起一个真实请求，
来将 Router 和 Controller 连接起来，并且可以帮助我们发送各种满足边界条件的请求数据，
以测试 Controller 的参数校验完整性。 <code>app.httpRequest()</code> 是 <a href="https://github.com/eggjs/egg-mock">egg-mock</a> 封装的 <a href="https://github.com/visionmedia/supertest">SuperTest</a> 请求实例。</p><p>例如我们要给 <code>app/controller/home.js</code>：</p><pre><code class="language-js">// app/router.js
module.exports = app =&gt; {
  const { router, controller } = app;
  router.get(&#x27;homepage&#x27;, &#x27;/&#x27;, controller.home.index);
};

// app/controller/home.js
class HomeController extends Controller {
  async index() {
    this.ctx.body = &#x27;hello world&#x27;;
  }
}</code></pre><p>写一个完整的单元测试，它的测试代码 <code>test/controller/home.test.js</code> 如下：</p><pre><code class="language-js">const { app, mock, assert } = require(&#x27;egg-mock/bootstrap&#x27;);

describe(&#x27;test/controller/home.test.js&#x27;, () =&gt; {
  describe(&#x27;GET /&#x27;, () =&gt; {
    it(&#x27;should status 200 and get the body&#x27;, () =&gt; {
      // 对 app 发起 `GET /` 请求
      return app.httpRequest()
        .get(&#x27;/&#x27;)
        .expect(200) // 期望返回 status 200
        .expect(&#x27;hello world&#x27;); // 期望 body 是 hello world
    });

    it(&#x27;should send multi requests&#x27;, async () =&gt; {
      // 使用 generator function 方式写测试用例，可以在一个用例中串行发起多次请求
      await app.httpRequest()
        .get(&#x27;/&#x27;)
        .expect(200) // 期望返回 status 200
        .expect(&#x27;hello world&#x27;); // 期望 body 是 hello world

      // 再请求一次
      const result = await app.httpRequest()
        .get(&#x27;/&#x27;)
        .expect(200)
        .expect(&#x27;hello world&#x27;);

      // 也可以这样验证
      assert(result.status === 200);
    });
  });
});</code></pre><p>通过基于 SuperTest 的 <code>app.httpRequest()</code> 可以轻松发起 GET、POST、PUT 等 HTTP 请求，并且它有非常丰富的请求数据构造接口，
例如以 POST 方式发送一个 JSON 请求：</p><pre><code class="language-js">// app/controller/home.js
class HomeController extends Controller {
  async post() {
    this.ctx.body = this.ctx.request.body;
  }
}

// test/controller/home.test.js
it(&#x27;should status 200 and get the request body&#x27;, () =&gt; {
  // 模拟 CSRF token，下文会详细说明
  app.mockCsrf();
  return app.httpRequest()
    .post(&#x27;/post&#x27;)
    .type(&#x27;form&#x27;)
    .send({
      foo: &#x27;bar&#x27;,
    })
    .expect(200)
    .expect({
      foo: &#x27;bar&#x27;,
    });
});</code></pre><p>更详细的 HTTP 请求构造方式，请查看 <a href="https://github.com/visionmedia/supertest#getting-started">SuperTest 文档</a>。</p><h3 id="mock-csrf">mock CSRF</h3><p>框架的默认安全插件会自动开启 <a href="./security.md#安全威胁csrf的防范">CSRF 防护</a>，
如果完整走 CSRF 校验逻辑，那么测试代码需要先请求一次页面，通过解析 HTML 拿到 CSRF token，
然后再使用此 token 发起 POST 请求。</p><p>所以 egg-mock 对 app 增加了 <code>app.mockCsrf()</code> 方法来模拟取 CSRF token 的过程。
这样在使用 SuperTest 请求 app 就会自动通过 CSRF 校验。</p><pre><code class="language-js">app.mockCsrf();
return app.httpRequest()
  .post(&#x27;/post&#x27;)
  .type(&#x27;form&#x27;)
  .send({
    foo: &#x27;bar&#x27;,
  })
  .expect(200)
  .expect({
    foo: &#x27;bar&#x27;,
  });</code></pre><h2 id="service-测试">Service 测试</h2><p>Service 相对于 Controller 来说，测试起来会更加简单，
我们只需要先创建一个 ctx，然后通过 <code>ctx.service.${serviceName}</code> 拿到 Service 实例，
然后调用 Service 方法即可。</p><p>例如</p><pre><code class="language-js">// app/service/user.js
class UserService extends Service {
  async get(name) {
    return await userDatabase.get(name);
  }
}</code></pre><p>编写单元测试：</p><pre><code class="language-js">describe(&#x27;get()&#x27;, () =&gt; {
  it(&#x27;should get exists user&#x27;, async () =&gt; {
    // 创建 ctx
    const ctx = app.mockContext();
    // 通过 ctx 访问到 service.user
    const user = await ctx.service.user.get(&#x27;fengmk2&#x27;);
    assert(user);
    assert(user.name === &#x27;fengmk2&#x27;);
  });

  it(&#x27;should get null when user not exists&#x27;, async () =&gt; {
    const ctx = app.mockContext();
    const user = await ctx.service.user.get(&#x27;fengmk1&#x27;);
    assert(!user);
  });
});</code></pre><p>当然，实际的 Service 代码不会像我们示例中那么简单，这里只是展示如何测试 Service 而已。</p><h2 id="extend-测试">Extend 测试</h2><p>应用可以对 Application、Request、Response、Context 和 Helper 进行扩展。
我们可以对扩展的方法或者属性针对性的编写单元测试。</p><h3 id="application">Application</h3><p>egg-mock 创建 app 的时候，已经将 Application 的扩展自动加载到 app 实例了，
直接使用这个 app 实例访问扩展的属性和方法即可进行测试。</p><p>例如 <code>app/extend/application.js</code>，我们给 app 增加了一个基于 <a href="https://github.com/node-modules/ylru">ylru</a> 的缓存功能：</p><pre><code class="language-js">const LRU = Symbol(&#x27;Application#lru&#x27;);
const LRUCache = require(&#x27;ylru&#x27;);
module.exports = {
  get lru() {
    if (!this[LRU]) {
      this[LRU] = new LRUCache(1000);
    }
    return this[LRU];
  },
};</code></pre><p>对应的单元测试：</p><pre><code class="language-js">describe(&#x27;get lru&#x27;, () =&gt; {
  it(&#x27;should get a lru and it work&#x27;, () =&gt; {
    // 设置缓存
    app.lru.set(&#x27;foo&#x27;, &#x27;bar&#x27;);
    // 读取缓存
    assert(app.lru.get(&#x27;foo&#x27;) === &#x27;bar&#x27;);
  });
});</code></pre><p>可以看到，测试 Application 的扩展是最容易的。</p><h3 id="context">Context</h3><p>Context 测试只比 Application 多了一个 <code>app.mockContext()</code> 步骤来模拟创建一个 Context 对象。</p><p>例如在 <code>app/extend/context.js</code> 中增加一个 <code>isXHR</code> 属性，判断是否通过 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/setRequestHeader">XMLHttpRequest</a> 发起的请求：</p><pre><code class="language-js">module.exports = {
  get isXHR() {
    return this.get(&#x27;X-Requested-With&#x27;) === &#x27;XMLHttpRequest&#x27;;
  },
};</code></pre><p>对应的单元测试：</p><pre><code class="language-js">describe(&#x27;isXHR()&#x27;, () =&gt; {
  it(&#x27;should true&#x27;, () =&gt; {
    const ctx = app.mockContext({
      headers: {
        &#x27;X-Requested-With&#x27;: &#x27;XMLHttpRequest&#x27;,
      },
    });
    assert(ctx.isXHR === true);
  });

  it(&#x27;should false&#x27;, () =&gt; {
    const ctx = app.mockContext({
      headers: {
        &#x27;X-Requested-With&#x27;: &#x27;SuperAgent&#x27;,
      },
    });
    assert(ctx.isXHR === false);
  });
});</code></pre><h3 id="request">Request</h3><p>通过 <code>ctx.request</code> 来访问 Request 扩展的属性和方法，直接即可进行测试。</p><p>例如在 <code>app/extend/request.js</code> 中增加一个 <code>isChrome</code> 属性，判断是否 Chrome 浏览器发起的请求：</p><pre><code class="language-js">const IS_CHROME = Symbol(&#x27;Request#isChrome&#x27;);
module.exports = {
  get isChrome() {
    if (!this[IS_CHROME]) {
      const ua = this.get(&#x27;User-Agent&#x27;).toLowerCase();
      this[IS_CHROME] = ua.includes(&#x27;chrome/&#x27;);
    }
    return this[IS_CHROME];
  },
};</code></pre><p>对应的单元测试：</p><pre><code class="language-js">describe(&#x27;isChrome()&#x27;, () =&gt; {
  it(&#x27;should true&#x27;, () =&gt; {
    const ctx = app.mockContext({
      headers: {
        &#x27;User-Agent&#x27;: &#x27;Chrome/56.0.2924.51&#x27;,
      },
    });
    assert(ctx.request.isChrome === true);
  });

  it(&#x27;should false&#x27;, () =&gt; {
    const ctx = app.mockContext({
      headers: {
        &#x27;User-Agent&#x27;: &#x27;FireFox/1&#x27;,
      },
    });
    assert(ctx.request.isChrome === false);
  });
});</code></pre><h3 id="response">Response</h3><p>Response 测试与 Request 完全一致。
通过 <code>ctx.response</code> 来访问 Response 扩展的属性和方法，直接即可进行测试。</p><p>例如在 <code>app/extend/response.js</code> 中增加一个 <code>isSuccess</code> 属性，判断当前响应状态码是否 200：</p><pre><code class="language-js">module.exports = {
  get isSuccess() {
    return this.status === 200;
  },
};</code></pre><p>对应的单元测试：</p><pre><code class="language-js">describe(&#x27;isSuccess()&#x27;, () =&gt; {
  it(&#x27;should true&#x27;, () =&gt; {
    const ctx = app.mockContext();
    ctx.status = 200;
    assert(ctx.response.isSuccess === true);
  });

  it(&#x27;should false&#x27;, () =&gt; {
    const ctx = app.mockContext();
    ctx.status = 404;
    assert(ctx.response.isSuccess === false);
  });
});</code></pre><h3 id="helper">Helper</h3><p>Helper 测试方式与 Service 类似，也是通过 ctx 来访问到 Helper，然后调用 Helper 方法测试。</p><p>例如 <code>app/extend/helper.js</code></p><pre><code class="language-js">module.exports = {
  money(val) {
    const lang = this.ctx.get(&#x27;Accept-Language&#x27;);
    if (lang.includes(&#x27;zh-CN&#x27;)) {
      return `￥ ${val}`;
    }
    return `$ ${val}`;
  },
};</code></pre><p>对应的单元测试：</p><pre><code class="language-js">describe(&#x27;money()&#x27;, () =&gt; {
  it(&#x27;should RMB&#x27;, () =&gt; {
    const ctx = app.mockContext({
      // 模拟 ctx 的 headers
      headers: {
        &#x27;Accept-Language&#x27;: &#x27;zh-CN,zh;q=0.5&#x27;,
      },
    });
    assert(ctx.helper.money(100) === &#x27;￥ 100&#x27;);
  });

  it(&#x27;should US Dolar&#x27;, () =&gt; {
    const ctx = app.mockContext();
    assert(ctx.helper.money(100) === &#x27;$ 100&#x27;);
  });
});</code></pre><h2 id="mock-方法">Mock 方法</h2><p>egg-mock 除了上面介绍过的 <code>app.mockContext()</code> 和 <code>app.mockCsrf()</code> 方法外，还提供了<a href="https://github.com/eggjs/egg-mock#api">非常多的 mock 方法</a>帮助我们便捷地写单元测试。</p><ul><li>如我们不想在终端 console 输出任何日志，可以通过 <code>mock.consoleLevel(&#x27;NONE&#x27;)</code> 来模拟。</li><li><p>又如我想模拟一次请求的 Session 数据，可以通过 <code>app.mockSession(data)</code> 来模拟。</p><pre><code class="language-js">describe(&#x27;GET /session&#x27;, () =&gt; {
  it(&#x27;should mock session work&#x27;, () =&gt; {
    app.mockSession({
      foo: &#x27;bar&#x27;,
      uid: 123,
    });
    return app.httpRequest()
      .get(&#x27;/session&#x27;)
      .expect(200)
      .expect({
        session: {
          foo: &#x27;bar&#x27;,
          uid: 123,
        },
      });
  });
});</code></pre></li></ul><p>因为 mock 之后会一直生效，我们需要避免每个单元测试用例之间是不能相互 mock 污染的，
所以通常我们都会在 <code>afterEach</code> 钩子里面还原掉所有 mock。</p><pre><code class="language-js">describe(&#x27;some test&#x27;, () =&gt; {
  // before hook

  afterEach(mock.restore);

  // it tests
});</code></pre><p><strong>引入 <code>egg-mock/bootstrap</code> 时，会自动在 <code>afterEach</code> 钩子中还原所有的 mock，不需要在测试文件中再次编写。</strong></p><p>下面会详细解释一下 egg-mock 的常见使用场景。</p><h3 id="mock-属性和方法">Mock 属性和方法</h3><p>因为 egg-mock 是扩展自 <a href="https://github.com/node-modules/mm">mm</a> 模块，
它包含了 mm 的所有功能，这样我们就可以非常方便地 mock 任意对象的属性和方法了。</p><h4 id="mock-一个对象的属性">Mock 一个对象的属性</h4><p>mock <code>app.config.baseDir</code> 指向 <code>/tmp/mockapp</code></p><pre><code class="language-js">mock(app.config, &#x27;baseDir&#x27;, &#x27;/tmp/mockapp&#x27;);
assert(app.config.baseDir === &#x27;/tmp/mockapp&#x27;);</code></pre><h4 id="mock-一个对象的方法">Mock 一个对象的方法</h4><p>mock <code>fs.readFileSync</code> 返回 <code>hello world</code></p><pre><code class="language-js">mock(fs, &#x27;readFileSync&#x27;, filename =&gt; {
  return &#x27;hello world&#x27;;
});
assert(fs.readFileSync(&#x27;foo.txt&#x27;) === &#x27;hello world&#x27;);</code></pre><p>还有 <code>mock.data()</code>，<code>mock.error()</code> 等更多高级的 mock 方法，
详细使用说明请查看 <a href="https://github.com/node-modules/mm#api">mm API</a>。</p><h3 id="mock-service">Mock Service</h3><p>Service 作为框架标准的内置对象，我们提供了便捷的 <code>app.mockService(service, methodName, fn)</code> 模拟 Service 方法返回值。</p><p>例如，模拟 <code>app/service/user</code> 中的 <code>get(name)</code> 方法，让它返回一个本来不存在的用户数据。</p><pre><code class="language-js">it(&#x27;should mock fengmk1 exists&#x27;, () =&gt; {
  app.mockService(&#x27;user&#x27;, &#x27;get&#x27;, () =&gt; {
    return {
      name: &#x27;fengmk1&#x27;,
    };
  });

  return app.httpRequest()
    .get(&#x27;/user?name=fengmk1&#x27;)
    .expect(200)
    // 返回了原本不存在的用户信息
    .expect({
      name: &#x27;fengmk1&#x27;,
    });
});</code></pre><p>通过 <code>app.mockServiceError(service, methodName, error)</code> 可以模拟 Service 调用异常。</p><p>例如，模拟 <code>app/service/user</code> 中的 <code>get(name)</code> 方法调用异常：</p><pre><code class="language-js">it(&#x27;should mock service error&#x27;, () =&gt; {
  app.mockServiceError(&#x27;user&#x27;, &#x27;get&#x27;, &#x27;mock user service error&#x27;);
  return app.httpRequest()
    .get(&#x27;/user?name=fengmk2&#x27;)
    // service 异常，触发 500 响应
    .expect(500)
    .expect(/mock user service error/);
});</code></pre><h3 id="mock-httpclient">Mock HttpClient</h3><p>框架内置了 <a href="./httpclient.md">HttpClient</a>，应用发起的对外 HTTP 请求基本都是通过它来处理。
我们可以通过 <code>app.mockHttpclient(url, method, data)</code> 来 mock 掉 <code>app.curl</code> 和 <code>ctx.curl</code> 方法，
从而实现各种网络异常情况。</p><p>例如在 <code>app/controller/home.js</code> 中发起了一个 curl 请求</p><pre><code class="language-js">class HomeController extends Controller {
  async httpclient () {
    const res = await this.ctx.curl(&#x27;https://eggjs.org&#x27;);
    this.ctx.body = res.data.toString();
  }
}</code></pre><p>需要 mock 它的返回值：</p><pre><code class="language-js">describe(&#x27;GET /httpclient&#x27;, () =&gt; {
  it(&#x27;should mock httpclient response&#x27;, () =&gt; {
    app.mockHttpclient(&#x27;https://eggjs.org&#x27;, {
      // 模拟的参数，可以是 buffer / string / json，
      // 都会转换成 buffer
      // 按照请求时的 options.dataType 来做对应的转换
      data: &#x27;mock eggjs.org response&#x27;,
    });
    return app.httpRequest()
      .get(&#x27;/httpclient&#x27;)
      .expect(&#x27;mock eggjs.org response&#x27;);
  });
});</code></pre><h2 id="示例代码">示例代码</h2><p>完整示例代码可以在 <a href="https://github.com/eggjs/examples/blob/master/unittest">eggjs/exmaples/unittest</a> 找到。</p></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">为什么要单元测试</a></li><li><a href="#%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6">测试框架</a><ul><li><a href="#mocha">Mocha</a></li><li><a href="#ava">AVA</a></li></ul></li><li><a href="#%E6%96%AD%E8%A8%80%E5%BA%93">断言库</a></li><li><a href="#%E6%B5%8B%E8%AF%95%E7%BA%A6%E5%AE%9A">测试约定</a><ul><li><a href="#%E6%B5%8B%E8%AF%95%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84">测试目录结构</a></li><li><a href="#%E6%B5%8B%E8%AF%95%E8%BF%90%E8%A1%8C%E5%B7%A5%E5%85%B7">测试运行工具</a></li></ul></li><li><a href="#%E5%87%86%E5%A4%87%E6%B5%8B%E8%AF%95">准备测试</a><ul><li><a href="#mock">mock</a></li><li><a href="#app">app</a></li><li><a href="#ctx">ctx</a></li></ul></li><li><a href="#%E6%B5%8B%E8%AF%95%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F">测试执行顺序</a></li><li><a href="#%E5%BC%82%E6%AD%A5%E6%B5%8B%E8%AF%95">异步测试</a></li><li><a href="#controller-%E6%B5%8B%E8%AF%95">Controller 测试</a><ul><li><a href="#mock-csrf">mock CSRF</a></li></ul></li><li><a href="#service-%E6%B5%8B%E8%AF%95">Service 测试</a></li><li><a href="#extend-%E6%B5%8B%E8%AF%95">Extend 测试</a><ul><li><a href="#application">Application</a></li><li><a href="#context">Context</a></li><li><a href="#request">Request</a></li><li><a href="#response">Response</a></li><li><a href="#helper">Helper</a></li></ul></li><li><a href="#mock-%E6%96%B9%E6%B3%95">Mock 方法</a><ul><li><a href="#mock-%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95">Mock 属性和方法</a><ul><li><a href="#mock-%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7">Mock 一个对象的属性</a></li><li><a href="#mock-%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%96%B9%E6%B3%95">Mock 一个对象的方法</a></li></ul></li><li><a href="#mock-service">Mock Service</a></li><li><a href="#mock-httpclient">Mock HttpClient</a></li></ul></li><li><a href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81">示例代码</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%5D(%23%25E4%25B8%25BA%25E4%25BB%2580%25E4%25B9%2588%25E8%25A6%2581%25E5%258D%2595%25E5%2585%2583%25E6%25B5%258B%25E8%25AF%2595)%0A-%20%5B%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%5D(%23%25E6%25B5%258B%25E8%25AF%2595%25E6%25A1%2586%25E6%259E%25B6)%0A%20%20*%20%5BMocha%5D(%23mocha)%0A%20%20*%20%5BAVA%5D(%23ava)%0A-%20%5B%E6%96%AD%E8%A8%80%E5%BA%93%5D(%23%25E6%2596%25AD%25E8%25A8%2580%25E5%25BA%2593)%0A-%20%5B%E6%B5%8B%E8%AF%95%E7%BA%A6%E5%AE%9A%5D(%23%25E6%25B5%258B%25E8%25AF%2595%25E7%25BA%25A6%25E5%25AE%259A)%0A%20%20*%20%5B%E6%B5%8B%E8%AF%95%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%5D(%23%25E6%25B5%258B%25E8%25AF%2595%25E7%259B%25AE%25E5%25BD%2595%25E7%25BB%2593%25E6%259E%2584)%0A%20%20*%20%5B%E6%B5%8B%E8%AF%95%E8%BF%90%E8%A1%8C%E5%B7%A5%E5%85%B7%5D(%23%25E6%25B5%258B%25E8%25AF%2595%25E8%25BF%2590%25E8%25A1%258C%25E5%25B7%25A5%25E5%2585%25B7)%0A-%20%5B%E5%87%86%E5%A4%87%E6%B5%8B%E8%AF%95%5D(%23%25E5%2587%2586%25E5%25A4%2587%25E6%25B5%258B%25E8%25AF%2595)%0A%20%20*%20%5Bmock%5D(%23mock)%0A%20%20*%20%5Bapp%5D(%23app)%0A%20%20*%20%5Bctx%5D(%23ctx)%0A-%20%5B%E6%B5%8B%E8%AF%95%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%5D(%23%25E6%25B5%258B%25E8%25AF%2595%25E6%2589%25A7%25E8%25A1%258C%25E9%25A1%25BA%25E5%25BA%258F)%0A-%20%5B%E5%BC%82%E6%AD%A5%E6%B5%8B%E8%AF%95%5D(%23%25E5%25BC%2582%25E6%25AD%25A5%25E6%25B5%258B%25E8%25AF%2595)%0A-%20%5BController%20%E6%B5%8B%E8%AF%95%5D(%23controller-%25E6%25B5%258B%25E8%25AF%2595)%0A%20%20*%20%5Bmock%20CSRF%5D(%23mock-csrf)%0A-%20%5BService%20%E6%B5%8B%E8%AF%95%5D(%23service-%25E6%25B5%258B%25E8%25AF%2595)%0A-%20%5BExtend%20%E6%B5%8B%E8%AF%95%5D(%23extend-%25E6%25B5%258B%25E8%25AF%2595)%0A%20%20*%20%5BApplication%5D(%23application)%0A%20%20*%20%5BContext%5D(%23context)%0A%20%20*%20%5BRequest%5D(%23request)%0A%20%20*%20%5BResponse%5D(%23response)%0A%20%20*%20%5BHelper%5D(%23helper)%0A-%20%5BMock%20%E6%96%B9%E6%B3%95%5D(%23mock-%25E6%2596%25B9%25E6%25B3%2595)%0A%20%20*%20%5BMock%20%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%5D(%23mock-%25E5%25B1%259E%25E6%2580%25A7%25E5%2592%258C%25E6%2596%25B9%25E6%25B3%2595)%0A%20%20%20%20%2B%20%5BMock%20%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7%5D(%23mock-%25E4%25B8%2580%25E4%25B8%25AA%25E5%25AF%25B9%25E8%25B1%25A1%25E7%259A%2584%25E5%25B1%259E%25E6%2580%25A7)%0A%20%20%20%20%2B%20%5BMock%20%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%96%B9%E6%B3%95%5D(%23mock-%25E4%25B8%2580%25E4%25B8%25AA%25E5%25AF%25B9%25E8%25B1%25A1%25E7%259A%2584%25E6%2596%25B9%25E6%25B3%2595)%0A%20%20*%20%5BMock%20Service%5D(%23mock-service)%0A%20%20*%20%5BMock%20HttpClient%5D(%23mock-httpclient)%0A-%20%5B%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%5D(%23%25E7%25A4%25BA%25E4%25BE%258B%25E4%25BB%25A3%25E7%25A0%2581)","meta":{"info":{"title":"单元测试"}},"content":"%0A%0A%0A%23%23%20%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%0A%0A%E5%85%88%E9%97%AE%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E4%BB%A5%E4%B8%8B%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%9A%0A%0A-%20%E4%BD%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%A6%82%E4%BD%95%E5%BA%A6%E9%87%8F%EF%BC%9F%0A-%20%E4%BD%A0%E6%98%AF%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%EF%BC%9F%0A-%20%E4%BD%A0%E6%95%A2%E9%9A%8F%E6%97%B6%E9%87%8D%E6%9E%84%E4%BB%A3%E7%A0%81%E5%90%97%EF%BC%9F%0A-%20%E4%BD%A0%E6%98%AF%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E9%87%8D%E6%9E%84%E7%9A%84%E4%BB%A3%E7%A0%81%E4%BE%9D%E7%84%B6%E4%BF%9D%E6%8C%81%E6%AD%A3%E7%A1%AE%E6%80%A7%EF%BC%9F%0A-%20%E4%BD%A0%E6%98%AF%E5%90%A6%E6%9C%89%E8%B6%B3%E5%A4%9F%E4%BF%A1%E5%BF%83%E5%9C%A8%E6%B2%A1%E6%9C%89%E6%B5%8B%E8%AF%95%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E9%9A%8F%E6%97%B6%E5%8F%91%E5%B8%83%E4%BD%A0%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%9F%0A%0A%E5%A6%82%E6%9E%9C%E7%AD%94%E6%A1%88%E9%83%BD%E6%AF%94%E8%BE%83%E7%8A%B9%E8%B1%AB%EF%BC%8C%E9%82%A3%E4%B9%88%E5%B0%B1%E8%AF%81%E6%98%8E%E6%88%91%E4%BB%AC%E9%9D%9E%E5%B8%B8%E9%9C%80%E8%A6%81%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A%E5%AE%83%E8%83%BD%E5%B8%A6%E7%BB%99%E6%88%91%E4%BB%AC%E5%BE%88%E5%A4%9A%E4%BF%9D%E9%9A%9C%EF%BC%9A%0A-%20%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E6%8C%81%E7%BB%AD%E6%9C%89%E4%BF%9D%E9%9A%9C%0A-%20%E9%87%8D%E6%9E%84%E6%AD%A3%E7%A1%AE%E6%80%A7%E4%BF%9D%E9%9A%9C%0A-%20%E5%A2%9E%E5%BC%BA%E8%87%AA%E4%BF%A1%E5%BF%83%0A-%20%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E8%A1%8C%0A%0AWeb%20%E5%BA%94%E7%94%A8%E4%B8%AD%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%9B%B4%E5%8A%A0%E9%87%8D%E8%A6%81%EF%BC%8C%E5%9C%A8%20Web%20%E4%BA%A7%E5%93%81%E5%BF%AB%E9%80%9F%E8%BF%AD%E4%BB%A3%E7%9A%84%E6%97%B6%E6%9C%9F%EF%BC%8C%E6%AF%8F%E4%B8%AA%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E9%83%BD%E7%BB%99%E5%BA%94%E7%94%A8%E7%9A%84%E7%A8%B3%E5%AE%9A%E6%80%A7%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E5%B1%82%E4%BF%9D%E9%9A%9C%E3%80%82%0AAPI%20%E5%8D%87%E7%BA%A7%EF%BC%8C%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E5%8F%AF%E4%BB%A5%E5%BE%88%E5%A5%BD%E5%9C%B0%E6%A3%80%E6%9F%A5%E4%BB%A3%E7%A0%81%E6%98%AF%E5%90%A6%E5%90%91%E4%B8%8B%E5%85%BC%E5%AE%B9%E3%80%82%0A%E5%AF%B9%E4%BA%8E%E5%90%84%E7%A7%8D%E5%8F%AF%E8%83%BD%E7%9A%84%E8%BE%93%E5%85%A5%EF%BC%8C%E4%B8%80%E6%97%A6%E6%B5%8B%E8%AF%95%E8%A6%86%E7%9B%96%EF%BC%8C%E9%83%BD%E8%83%BD%E6%98%8E%E7%A1%AE%E5%AE%83%E7%9A%84%E8%BE%93%E5%87%BA%E3%80%82%0A%E4%BB%A3%E7%A0%81%E6%94%B9%E5%8A%A8%E5%90%8E%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C%E5%88%A4%E6%96%AD%E4%BB%A3%E7%A0%81%E7%9A%84%E6%94%B9%E5%8A%A8%E6%98%AF%E5%90%A6%E5%BD%B1%E5%93%8D%E5%B7%B2%E7%A1%AE%E5%AE%9A%E7%9A%84%E7%BB%93%E6%9E%9C%E3%80%82%0A%0A%E6%89%80%E4%BB%A5%EF%BC%8C%E5%BA%94%E7%94%A8%E7%9A%84%20Controller%E3%80%81Service%E3%80%81Helper%E3%80%81Extend%20%E7%AD%89%E4%BB%A3%E7%A0%81%EF%BC%8C%E9%83%BD%E5%BF%85%E9%A1%BB%E6%9C%89%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%BF%9D%E8%AF%81%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E3%80%82%0A%E5%BD%93%E7%84%B6%EF%BC%8C%E6%A1%86%E6%9E%B6%E5%92%8C%E6%8F%92%E4%BB%B6%E7%9A%84%E6%AF%8F%E4%B8%AA%E5%8A%9F%E8%83%BD%E6%94%B9%E5%8A%A8%E5%92%8C%E9%87%8D%E6%9E%84%E9%83%BD%E9%9C%80%E8%A6%81%E6%9C%89%E7%9B%B8%E5%BA%94%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%A6%81%E6%B1%82%E5%B0%BD%E9%87%8F%E5%81%9A%E5%88%B0%E4%BF%AE%E6%94%B9%E7%9A%84%E4%BB%A3%E7%A0%81%E8%83%BD%E8%A2%AB%20100%25%20%E8%A6%86%E7%9B%96%E5%88%B0%E3%80%82%0A%0A%23%23%20%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%0A%0A%E4%BB%8E%20%5Bnpm%20%E6%90%9C%E7%B4%A2%E3%80%8Etest%20framework%E3%80%8F%5D(https%3A%2F%2Fwww.npmjs.com%2Fsearch%3Fq%3Dtest%2520framework%26page%3D1%26ranking%3Dpopularity)%EF%BC%8C%0A%E6%88%91%E4%BB%AC%E4%BC%9A%E5%8F%91%E7%8E%B0%E6%9C%89%E5%A4%A7%E9%87%8F%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E5%AD%98%E5%9C%A8%EF%BC%8C%E6%AF%8F%E4%B8%AA%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E9%83%BD%E6%9C%89%E5%AE%83%E7%9A%84%E7%8B%AC%E7%89%B9%E4%B9%8B%E5%A4%84%E3%80%82%0A%0A%23%23%23%20Mocha%0A%0A%E6%88%91%E4%BB%AC%E9%80%89%E6%8B%A9%E5%92%8C%E6%8E%A8%E8%8D%90%E5%A4%A7%E5%AE%B6%E4%BD%BF%E7%94%A8%20%5BMocha%5D(http%3A%2F%2Fmochajs.org)%EF%BC%8C%E5%8A%9F%E8%83%BD%E9%9D%9E%E5%B8%B8%E4%B8%B0%E5%AF%8C%EF%BC%8C%E6%94%AF%E6%8C%81%E8%BF%90%E8%A1%8C%E5%9C%A8%20Node.js%20%E5%92%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%EF%BC%8C%0A%E5%AF%B9%E5%BC%82%E6%AD%A5%E6%B5%8B%E8%AF%95%E6%94%AF%E6%8C%81%E9%9D%9E%E5%B8%B8%E5%8F%8B%E5%A5%BD%E3%80%82%0A%0A%3E%20Mocha%20is%20a%20feature-rich%20JavaScript%20test%20framework%20running%20on%20Node.js%20and%20in%20the%20browser%2C%20making%20asynchronous%20testing%20simple%20and%20fun.%20Mocha%20tests%20run%20serially%2C%20allowing%20for%20flexible%20and%20accurate%20reporting%2C%20while%20mapping%20uncaught%20exceptions%20to%20the%20correct%20test%20cases.%0A%0A%23%23%23%20AVA%0A%0A%E4%B8%BA%E4%BB%80%E4%B9%88%E6%B2%A1%E6%9C%89%E9%80%89%E6%8B%A9%E6%9C%80%E8%BF%91%E6%AF%94%E8%BE%83%E7%81%AB%E7%9A%84%20%5BAVA%5D(https%3A%2F%2Fgithub.com%2Favajs%2Fava)%EF%BC%8C%E5%AE%83%E7%9C%8B%E8%B5%B7%E6%9D%A5%E4%BC%9A%E8%B7%91%E5%BE%97%E5%BE%88%E5%BF%AB%E3%80%82%0A%E7%BB%8F%E8%BF%87%E6%88%91%E4%BB%AC%E5%87%A0%E4%B8%AA%E7%9C%9F%E5%AE%9E%E9%A1%B9%E7%9B%AE%E5%AE%9E%E8%B7%B5%E4%B8%8B%E6%9D%A5%EF%BC%8CAVA%20%E7%9C%9F%E7%9A%84%E5%8F%AA%E6%98%AF%E7%9C%8B%E8%B5%B7%E6%9D%A5%E5%BE%88%E7%BE%8E%EF%BC%8C%E4%BD%86%E6%98%AF%E5%AE%9E%E9%99%85%E4%BC%9A%E8%AE%A9%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%E8%B6%8A%E6%9D%A5%E8%B6%8A%E9%9A%BE%E5%86%99%EF%BC%8C%E6%88%90%E6%9C%AC%E8%B6%8A%E6%9D%A5%E8%B6%8A%E9%AB%98%E3%80%82%0A%0A%5B%40dead-horse%5D(https%3A%2F%2Fgithub.com%2Fdead-horse)%20%E7%9A%84%E8%AF%84%E4%BB%B7%EF%BC%9A%0A%3E%20-%20AVA%20%E8%87%AA%E8%BA%AB%E4%B8%8D%E5%A4%9F%E7%A8%B3%E5%AE%9A%EF%BC%8C%E5%B9%B6%E5%8F%91%E8%BF%90%E8%A1%8C%E6%96%87%E4%BB%B6%E5%A4%9A%E7%9A%84%E6%97%B6%E5%80%99%E4%BC%9A%E6%92%91%E7%88%86%20CPU%EF%BC%9B%E5%A6%82%E6%9E%9C%E8%AE%BE%E7%BD%AE%E6%8E%A7%E5%88%B6%E5%B9%B6%E5%8F%91%E5%8F%82%E6%95%B0%E7%9A%84%E6%96%B9%E5%BC%8F%E8%BF%90%E8%A1%8C%EF%BC%8C%E4%BC%9A%E5%AF%BC%E8%87%B4%20only%20%E6%A8%A1%E5%BC%8F%E6%97%A0%E6%95%88%E3%80%82%0A%3E%20-%20%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C%E5%AF%B9%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E7%9A%84%E8%A6%81%E6%B1%82%E5%BE%88%E9%AB%98%EF%BC%8C%E6%89%80%E6%9C%89%E7%9A%84%E6%B5%8B%E8%AF%95%E4%B8%8D%E8%83%BD%E6%9C%89%E4%BE%9D%E8%B5%96%EF%BC%8C%E7%89%B9%E5%88%AB%E6%98%AF%E9%81%87%E5%88%B0%E4%B8%80%E4%BA%9B%E9%9C%80%E8%A6%81%E5%81%9A%20mock%20%E7%9A%84%E5%9C%BA%E6%99%AF%E6%97%B6%EF%BC%8C%E5%86%99%E5%A5%BD%E5%BE%88%E9%9A%BE%E3%80%82%0A%3E%20-%20app%20%E5%9C%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E6%97%B6%E5%80%99%E6%98%AF%E6%9C%89%E8%80%97%E6%97%B6%E7%9A%84%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%B2%E8%A1%8C%E8%BF%90%E8%A1%8C%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%20app%20%E5%AF%B9%E5%AE%83%E6%B5%8B%E8%AF%95%E3%80%82%0A%3E%20%20%20%E4%BD%86%E6%98%AF%20AVA%20%E6%AF%8F%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E9%83%BD%E8%BF%90%E8%A1%8C%E5%9C%A8%E7%8B%AC%E7%AB%8B%E8%BF%9B%E7%A8%8B%EF%BC%8C%E6%9C%89%E5%A4%9A%E5%B0%91%E4%B8%AA%E6%96%87%E4%BB%B6%E5%B0%B1%E9%9C%80%E8%A6%81%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A4%9A%E5%B0%91%E4%B8%AA%20app%E3%80%82%0A%0A%5B%40fool2fish%5D(https%3A%2F%2Fgithub.com%2Ffool2fish)%20%E7%9A%84%E8%AF%84%E4%BB%B7%EF%BC%9A%0A%3E%20%E5%A6%82%E6%9E%9C%E6%98%AF%E7%AE%80%E5%8D%95%E7%9A%84%E7%A8%8B%E5%BA%8F%E7%9A%84%E8%AF%9D%E7%94%A8%20AVA%20%E4%BC%9A%E5%BF%AB%E4%B8%80%E4%BA%9B%EF%BC%88%E4%BD%86%E6%98%AF%E6%9C%AC%E6%9D%A5%E5%B0%B1%E7%AE%80%E5%8D%95%E5%8F%AF%E8%83%BD%E4%B9%9F%E6%B2%A1%E5%95%A5%E6%84%9F%E8%A7%89%EF%BC%89%EF%BC%8C%0A%3E%20%E5%A6%82%E6%9E%9C%E6%98%AF%E5%A4%8D%E6%9D%82%E7%9A%84%E5%B0%B1%E4%B8%8D%E6%8E%A8%E8%8D%90%E4%BA%86%EF%BC%8C%E6%AF%94%E8%BE%83%E5%A4%A7%E7%9A%84%E9%97%AE%E9%A2%98%E6%98%AF%E5%8F%AF%E8%83%BD%E6%B2%A1%E6%B3%95%E7%BB%99%E5%87%BA%E5%87%86%E7%A1%AE%E7%9A%84%E9%94%99%E8%AF%AF%E5%A0%86%E6%A0%88%EF%BC%8C%0A%3E%20%E5%8F%A6%E5%A4%96%E5%B9%B6%E5%8F%91%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%AF%BC%E8%87%B4%E4%BE%9D%E8%B5%96%E7%9A%84%E5%85%B6%E4%BB%96%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%8C%82%E6%8E%89%EF%BC%8C%E9%99%8D%E4%BD%8E%E6%B5%8B%E8%AF%95%E7%9A%84%E6%88%90%E5%8A%9F%E7%8E%87%EF%BC%8C%0A%3E%20%E8%BF%98%E6%9C%89%E5%B0%B1%E6%98%AF%E5%B8%A6%E6%B5%81%E7%A8%8B%E7%9A%84%E6%B5%8B%E8%AF%95%EF%BC%88%E6%AF%94%E5%A6%82%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E5%8A%9F%E8%83%BD%EF%BC%89%E7%9C%9F%E5%BF%83%E4%B8%8D%E9%80%82%E5%90%88%E7%94%A8%20AVA%E3%80%82%0A%0A%23%23%20%E6%96%AD%E8%A8%80%E5%BA%93%0A%0A%E5%90%8C%E6%A0%B7%EF%BC%8C%E6%B5%8B%E8%AF%95%E6%96%AD%E8%A8%80%E5%BA%93%E4%B9%9F%E6%98%AF%5B%E7%99%BE%E8%8A%B1%E9%BD%90%E6%94%BE%E7%9A%84%E6%97%B6%E4%BB%A3%5D(https%3A%2F%2Fwww.npmjs.com%2Fsearch%3Fq%3Dassert%26page%3D1%26ranking%3Dpopularity)%EF%BC%8C%0A%E6%88%91%E4%BB%AC%E7%BB%8F%E5%8E%86%E8%BF%87%20%5Bassert%5D(https%3A%2F%2Fnodejs.org%2Fapi%2Fassert.html)%EF%BC%8C%E5%88%B0%20%5Bshould%5D(https%3A%2F%2Fgithub.com%2Fshouldjs%2Fshould.js)%20%E5%92%8C%20%5Bexpect%5D(https%3A%2F%2Fgithub.com%2FAutomattic%2Fexpect.js)%EF%BC%8C%E8%BF%98%E6%98%AF%E4%B8%8D%E6%96%AD%E5%9C%B0%E5%9C%A8%E5%B0%9D%E8%AF%95%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%96%AD%E8%A8%80%E5%BA%93%E3%80%82%0A%0A%E7%9B%B4%E5%88%B0%E6%88%91%E4%BB%AC%E5%8F%91%E7%8E%B0%20%5Bpower-assert%5D%EF%BC%8C%0A%E5%9B%A0%E4%B8%BA%5B%E3%80%8ENo%20API%20is%20the%20best%20API%E3%80%8F%5D(https%3A%2F%2Fgithub.com%2Fatian25%2Fblog%2Fissues%2F16)%EF%BC%8C%0A%E6%9C%80%E7%BB%88%E6%88%91%E4%BB%AC%E9%87%8D%E6%96%B0%E5%9B%9E%E5%BD%92%E5%8E%9F%E5%A7%8B%E7%9A%84%20assert%20%E4%BD%9C%E4%B8%BA%E9%BB%98%E8%AE%A4%E7%9A%84%E6%96%AD%E8%A8%80%E5%BA%93%E3%80%82%0A%0A%E7%AE%80%E5%8D%95%E5%9C%B0%E8%AF%B4%EF%BC%8C%E5%AE%83%E7%9A%84%E4%BC%98%E7%82%B9%E6%98%AF%EF%BC%9A%0A-%20%E6%B2%A1%E6%9C%89%20API%20%E5%B0%B1%E6%98%AF%E6%9C%80%E5%A5%BD%E7%9A%84%20API%EF%BC%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E4%BB%BB%E4%BD%95%E8%AE%B0%E5%BF%86%EF%BC%8C%E5%8F%AA%E9%9C%80%20assert%20%E5%8D%B3%E5%8F%AF%E3%80%82%0A-%20**%E5%BC%BA%E5%A4%A7%E7%9A%84%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%E5%8F%8D%E9%A6%88**%0A-%20**%E5%BC%BA%E5%A4%A7%E7%9A%84%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%E5%8F%8D%E9%A6%88**%0A-%20**%E5%BC%BA%E5%A4%A7%E7%9A%84%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%E5%8F%8D%E9%A6%88**%0A%0A%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF%E5%AE%9E%E5%9C%A8%E5%A4%AA%E7%BE%8E%E5%A4%AA%E8%AF%A6%E7%BB%86%EF%BC%8C%E8%AE%A9%E4%BA%BA%E6%9C%89%E7%A7%8D%E6%83%B3%E7%9C%8B%E9%94%99%E8%AF%AF%E6%8A%A5%E5%91%8A%E7%9A%84%E6%AC%B2%E6%9C%9B%EF%BC%9A%0A%0A!%5B%5D(https%3A%2F%2Fcloud.githubusercontent.com%2Fassets%2F227713%2F20919940%2F19e83de8-bbd9-11e6-8951-bf4a332f9b5a.png)%0A%0A%23%23%20%E6%B5%8B%E8%AF%95%E7%BA%A6%E5%AE%9A%0A%0A%E4%B8%BA%E4%BA%86%E8%AE%A9%E6%88%91%E4%BB%AC%E6%9B%B4%E5%A4%9A%E5%9C%B0%E5%85%B3%E6%B3%A8%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E6%9C%AC%E8%BA%AB%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E8%80%97%E8%B4%B9%E6%97%B6%E9%97%B4%E5%9C%A8%E5%A6%82%E4%BD%95%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC%E7%AD%89%E8%BE%85%E5%8A%A9%E5%B7%A5%E4%BD%9C%E4%B8%8A%EF%BC%8C%0A%E6%A1%86%E6%9E%B6%E5%AF%B9%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%81%9A%E4%BA%86%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E7%BA%A6%E5%AE%9A%E3%80%82%0A%0A%23%23%23%20%E6%B5%8B%E8%AF%95%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%0A%0A%E6%88%91%E4%BB%AC%E7%BA%A6%E5%AE%9A%20%60test%60%20%E7%9B%AE%E5%BD%95%E4%B8%BA%E5%AD%98%E6%94%BE%E6%89%80%E6%9C%89%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC%E7%9A%84%E7%9B%AE%E5%BD%95%EF%BC%8C%E6%B5%8B%E8%AF%95%E6%89%80%E4%BD%BF%E7%94%A8%E5%88%B0%E7%9A%84%20%60fixtures%60%20%E5%92%8C%E7%9B%B8%E5%85%B3%E8%BE%85%E5%8A%A9%E8%84%9A%E6%9C%AC%E9%83%BD%E5%BA%94%E8%AF%A5%E6%94%BE%E5%9C%A8%E6%AD%A4%E7%9B%AE%E5%BD%95%E4%B8%8B%E3%80%82%0A%0A%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC%E6%96%87%E4%BB%B6%E7%BB%9F%E4%B8%80%E6%8C%89%20%60%24%7Bfilename%7D.test.js%60%20%E5%91%BD%E5%90%8D%EF%BC%8C%E5%BF%85%E9%A1%BB%E4%BB%A5%20%60.test.js%60%20%E4%BD%9C%E4%B8%BA%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E3%80%82%0A%0A%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8%E7%9A%84%E6%B5%8B%E8%AF%95%E7%9B%AE%E5%BD%95%E7%A4%BA%E4%BE%8B%EF%BC%9A%0A%0A%60%60%60bash%0Atest%0A%E2%94%9C%E2%94%80%E2%94%80%20controller%0A%E2%94%82%C2%A0%C2%A0%20%E2%94%94%E2%94%80%E2%94%80%20home.test.js%0A%E2%94%9C%E2%94%80%E2%94%80%20hello.test.js%0A%E2%94%94%E2%94%80%E2%94%80%20service%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20user.test.js%0A%60%60%60%0A%0A%23%23%23%20%E6%B5%8B%E8%AF%95%E8%BF%90%E8%A1%8C%E5%B7%A5%E5%85%B7%0A%0A%E7%BB%9F%E4%B8%80%E4%BD%BF%E7%94%A8%20%5Begg-bin%20%E6%9D%A5%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC%5D(.%2Fdevelopment.md%23%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95)%EF%BC%8C%0A%E8%87%AA%E5%8A%A8%E5%B0%86%E5%86%85%E7%BD%AE%E7%9A%84%20%5BMocha%5D%E3%80%81%5Bco-mocha%5D%E3%80%81%5Bpower-assert%5D%EF%BC%8C%5Bnyc%5D%20%E7%AD%89%E6%A8%A1%E5%9D%97%E7%BB%84%E5%90%88%E5%BC%95%E5%85%A5%E5%88%B0%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC%E4%B8%AD%EF%BC%8C%0A%E8%AE%A9%E6%88%91%E4%BB%AC**%E8%81%9A%E7%84%A6%E7%B2%BE%E5%8A%9B%E5%9C%A8%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81**%E4%B8%8A%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E7%BA%A0%E7%BB%93%E9%80%89%E6%8B%A9%E9%82%A3%E4%BA%9B%E6%B5%8B%E8%AF%95%E5%91%A8%E8%BE%B9%E5%B7%A5%E5%85%B7%E5%92%8C%E6%A8%A1%E5%9D%97%E3%80%82%0A%0A%E5%8F%AA%E9%9C%80%E8%A6%81%E5%9C%A8%20%60package.json%60%20%E4%B8%8A%E9%85%8D%E7%BD%AE%E5%A5%BD%20%60scripts.test%60%20%E5%8D%B3%E5%8F%AF%E3%80%82%0A%0A%60%60%60json%0A%7B%0A%20%20%22scripts%22%3A%20%7B%0A%20%20%20%20%22test%22%3A%20%22egg-bin%20test%22%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E7%84%B6%E5%90%8E%E5%B0%B1%E5%8F%AF%E4%BB%A5%E6%8C%89%E6%A0%87%E5%87%86%E7%9A%84%20%60npm%20test%60%20%E6%9D%A5%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95%E4%BA%86%E3%80%82%0A%0A%60%60%60bash%0Anpm%20test%0A%0A%3E%20unittest-example%40%20test%20%2FUsers%2Fmk2%2Fgit%2Fgithub.com%2Feggjs%2Fexamples%2Funittest%0A%3E%20egg-bin%20test%0A%0A%20%20test%2Fhello.test.js%0A%20%20%20%20%E2%9C%93%20should%20work%0A%0A%20%201%20passing%20(10ms)%0A%60%60%60%0A%0A%23%23%20%E5%87%86%E5%A4%87%E6%B5%8B%E8%AF%95%0A%0A%E6%9C%AC%E6%96%87%E4%B8%BB%E8%A6%81%E4%BB%8B%E7%BB%8D%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E5%BA%94%E7%94%A8%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%85%B3%E4%BA%8E%E6%A1%86%E6%9E%B6%E5%92%8C%E6%8F%92%E4%BB%B6%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E8%AF%B7%E6%9F%A5%E7%9C%8B%5B%E6%A1%86%E6%9E%B6%E5%BC%80%E5%8F%91%5D(..%2Fadvanced%2Fframework.md)%E5%92%8C%5B%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%5D(..%2Fadvanced%2Fplugin.md)%E7%9B%B8%E5%85%B3%E7%AB%A0%E8%8A%82%E3%80%82%0A%0A%23%23%23%20mock%0A%0A%E6%AD%A3%E5%B8%B8%E6%9D%A5%E8%AF%B4%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%A6%81%E5%AE%8C%E6%95%B4%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%20app%20%E5%88%9B%E5%BB%BA%E5%92%8C%E5%90%AF%E5%8A%A8%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%BF%98%E6%98%AF%E9%9C%80%E8%A6%81%E5%86%99%E4%B8%80%E6%AE%B5%E5%88%9D%E5%A7%8B%E5%8C%96%E8%84%9A%E6%9C%AC%E7%9A%84%EF%BC%8C%0A%E5%B9%B6%E4%B8%94%E8%BF%98%E9%9C%80%E8%A6%81%E5%9C%A8%E6%B5%8B%E8%AF%95%E8%B7%91%E5%AE%8C%E4%B9%8B%E5%90%8E%E5%81%9A%E4%B8%80%E4%BA%9B%E6%B8%85%E7%90%86%E5%B7%A5%E4%BD%9C%EF%BC%8C%E5%A6%82%E5%88%A0%E9%99%A4%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%EF%BC%8C%E9%94%80%E6%AF%81%20app%E3%80%82%0A%0A%E5%B8%B8%E5%B8%B8%E8%BF%98%E6%9C%89%E6%A8%A1%E6%8B%9F%E5%90%84%E7%A7%8D%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B8%EF%BC%8C%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE%E5%BC%82%E5%B8%B8%E7%AD%89%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5%E3%80%82%0A%0A%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E5%8D%95%E7%8B%AC%E4%B8%BA%E6%A1%86%E6%9E%B6%E6%8A%BD%E5%8F%96%E4%BA%86%E4%B8%80%E4%B8%AA%E6%B5%8B%E8%AF%95%20mock%20%E8%BE%85%E5%8A%A9%E6%A8%A1%E5%9D%97%EF%BC%9A%5Begg-mock%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock)%EF%BC%8C%0A%E6%9C%89%E4%BA%86%E5%AE%83%E6%88%91%E4%BB%AC%E5%B0%B1%E5%8F%AF%E4%BB%A5%E9%9D%9E%E5%B8%B8%E5%BF%AB%E9%80%9F%E5%9C%B0%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%20app%20%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%BF%98%E8%83%BD%E5%BF%AB%E9%80%9F%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20ctx%20%E6%9D%A5%E6%B5%8B%E8%AF%95%E5%AE%83%E7%9A%84%E5%B1%9E%E6%80%A7%E3%80%81%E6%96%B9%E6%B3%95%E5%92%8C%20Service%20%E7%AD%89%E3%80%82%0A%0A%23%23%23%20app%0A%0A%E5%9C%A8%E6%B5%8B%E8%AF%95%E8%BF%90%E8%A1%8C%E4%B9%8B%E5%89%8D%EF%BC%8C%E6%88%91%E4%BB%AC%E9%A6%96%E5%85%88%E8%A6%81%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8%E7%9A%84%E4%B8%80%E4%B8%AA%20app%20%E5%AE%9E%E4%BE%8B%EF%BC%8C%0A%E9%80%9A%E8%BF%87%E5%AE%83%E6%9D%A5%E8%AE%BF%E9%97%AE%E9%9C%80%E8%A6%81%E8%A2%AB%E6%B5%8B%E8%AF%95%E7%9A%84%20Controller%E3%80%81Middleware%E3%80%81Service%20%E7%AD%89%E5%BA%94%E7%94%A8%E5%B1%82%E4%BB%A3%E7%A0%81%E3%80%82%0A%0A%E9%80%9A%E8%BF%87%20egg-mock%EF%BC%8C%E7%BB%93%E5%90%88%20Mocha%20%E7%9A%84%20%60before%60%20%E9%92%A9%E5%AD%90%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BE%BF%E6%8D%B7%E5%9C%B0%E5%88%9B%E5%BB%BA%E5%87%BA%E4%B8%80%E4%B8%AA%20app%20%E5%AE%9E%E4%BE%8B%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20test%2Fcontroller%2Fhome.test.js%0Aconst%20assert%20%3D%20require('assert')%3B%0Aconst%20mock%20%3D%20require('egg-mock')%3B%0A%0Adescribe('test%2Fcontroller%2Fhome.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20app%3B%0A%20%20before(()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%E5%88%9B%E5%BB%BA%E5%BD%93%E5%89%8D%E5%BA%94%E7%94%A8%E7%9A%84%20app%20%E5%AE%9E%E4%BE%8B%0A%20%20%20%20app%20%3D%20mock.app()%3B%0A%20%20%20%20%2F%2F%20%E7%AD%89%E5%BE%85%20app%20%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F%EF%BC%8C%E6%89%8D%E8%83%BD%E6%89%A7%E8%A1%8C%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%0A%20%20%20%20return%20app.ready()%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E8%BF%99%E6%A0%B7%E6%88%91%E4%BB%AC%E5%B0%B1%E6%8B%BF%E5%88%B0%E4%BA%86%E4%B8%80%E4%B8%AA%20app%20%E7%9A%84%E5%BC%95%E7%94%A8%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E6%89%80%E6%9C%89%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E9%83%BD%E4%BC%9A%E5%9F%BA%E4%BA%8E%E8%BF%99%E4%B8%AA%20app%20%E8%BF%9B%E8%A1%8C%E3%80%82%0A%E6%9B%B4%E5%A4%9A%E5%85%B3%E4%BA%8E%E5%88%9B%E5%BB%BA%20app%20%E7%9A%84%E4%BF%A1%E6%81%AF%E8%AF%B7%E6%9F%A5%E7%9C%8B%20%5B%60mock.app(options)%60%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock%23options)%20%E6%96%87%E6%A1%A3%E3%80%82%0A%0A%E6%AF%8F%E4%B8%80%E4%B8%AA%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6%E9%83%BD%E9%9C%80%E8%A6%81%E8%BF%99%E6%A0%B7%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20app%20%E5%AE%9E%E4%BE%8B%E9%9D%9E%E5%B8%B8%E5%86%97%E4%BD%99%EF%BC%8C%E5%9B%A0%E6%AD%A4%20egg-mock%20%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E4%B8%AA%20bootstrap%20%E6%96%87%E4%BB%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BB%8E%E5%AE%83%E4%B8%8A%E9%9D%A2%E6%8B%BF%E5%88%B0%E6%88%91%E4%BB%AC%E6%89%80%E5%B8%B8%E7%94%A8%E7%9A%84%E5%AE%9E%E4%BE%8B%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20test%2Fcontroller%2Fhome.test.js%0Aconst%20%7B%20app%2C%20mock%2C%20assert%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('test%2Fcontroller%2Fhome.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20%2F%2F%20test%20cases%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20ctx%0A%0A%E6%88%91%E4%BB%AC%E9%99%A4%E4%BA%86%20app%EF%BC%8C%E8%BF%98%E9%9C%80%E8%A6%81%E4%B8%80%E7%A7%8D%E6%96%B9%E5%BC%8F%E4%BE%BF%E6%8D%B7%E5%9C%B0%E6%8B%BF%E5%88%B0%20ctx%EF%BC%8C%E6%96%B9%E4%BE%BF%E6%88%91%E4%BB%AC%E8%BF%9B%E8%A1%8C%20Extend%E3%80%81Service%E3%80%81Helper%20%E7%AD%89%E6%B5%8B%E8%AF%95%E3%80%82%0A%E8%80%8C%E6%88%91%E4%BB%AC%E5%B7%B2%E7%BB%8F%E9%80%9A%E8%BF%87%E4%B8%8A%E9%9D%A2%E7%9A%84%E6%96%B9%E5%BC%8F%E6%8B%BF%E5%88%B0%E4%BA%86%E4%B8%80%E4%B8%AA%20app%EF%BC%8C%E7%BB%93%E5%90%88%20egg-mock%20%E6%8F%90%E4%BE%9B%E7%9A%84%20%5B%60app.mockContext(options)%60%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock%23appmockcontextoptions)%20%E6%96%B9%E6%B3%95%E6%9D%A5%E5%BF%AB%E9%80%9F%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20ctx%20%E5%AE%9E%E4%BE%8B%E3%80%82%0A%0A%60%60%60js%0Ait('should%20get%20a%20ctx'%2C%20()%20%3D%3E%20%7B%0A%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20assert(ctx.method%20%3D%3D%3D%20'GET')%3B%0A%20%20assert(ctx.url%20%3D%3D%3D%20'%2F')%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E6%83%B3%E6%A8%A1%E6%8B%9F%20%60ctx.user%60%20%E8%BF%99%E4%B8%AA%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E7%BB%99%20mockContext%20%E4%BC%A0%E9%80%92%20data%20%E5%8F%82%E6%95%B0%E5%AE%9E%E7%8E%B0%EF%BC%9A%0A%0A%60%60%60js%0Ait('should%20mock%20ctx.user'%2C%20()%20%3D%3E%20%7B%0A%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20user%3A%20%7B%0A%20%20%20%20%20%20name%3A%20'fengmk2'%2C%0A%20%20%20%20%7D%2C%0A%20%20%7D)%3B%0A%20%20assert(ctx.user)%3B%0A%20%20assert(ctx.user.name%20%3D%3D%3D%20'fengmk2')%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E7%8E%B0%E5%9C%A8%E6%88%91%E4%BB%AC%E6%8B%BF%E5%88%B0%E4%BA%86%20app%EF%BC%8C%E4%B9%9F%E7%9F%A5%E9%81%93%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20ctx%20%E4%BA%86%EF%BC%8C%E9%82%A3%E4%B9%88%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%BF%9B%E8%A1%8C%E6%9B%B4%E5%A4%9A%E4%BB%A3%E7%A0%81%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%BA%86%E3%80%82%0A%0A%23%23%20%E6%B5%8B%E8%AF%95%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%0A%0A%E7%89%B9%E5%88%AB%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%EF%BC%8C%E5%B0%BD%E9%87%8F%E4%BF%9D%E8%AF%81%E5%9C%A8%E6%89%A7%E8%A1%8C%E6%9F%90%E4%B8%AA%E7%94%A8%E4%BE%8B%E7%9A%84%E6%97%B6%E5%80%99%E6%89%A7%E8%A1%8C%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E3%80%82%0A%0A%E5%B8%B8%E8%A7%81%E7%9A%84%E9%94%99%E8%AF%AF%E5%86%99%E6%B3%95%0A%0A%60%60%60js%0A%2F%2F%20Bad%0Aconst%20%7B%20app%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('bad%20test'%2C%20()%20%3D%3E%20%7B%0A%20%20doSomethingBefore()%3B%0A%0A%20%20it('should%20redirect'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20.expect(302)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0AMocha%20%E5%88%9A%E5%BC%80%E5%A7%8B%E8%BF%90%E8%A1%8C%E7%9A%84%E6%97%B6%E5%80%99%E4%BC%9A%E8%BD%BD%E5%85%A5%E6%89%80%E6%9C%89%E7%94%A8%E4%BE%8B%EF%BC%8C%E8%BF%99%E6%97%B6%20describe%20%E6%96%B9%E6%B3%95%E5%B0%B1%E4%BC%9A%E8%A2%AB%E8%B0%83%E7%94%A8%EF%BC%8C%E9%82%A3%20%60doSomethingBefore%60%20%E5%B0%B1%E4%BC%9A%E5%90%AF%E5%8A%A8%E3%80%82%0A%E5%A6%82%E6%9E%9C%E5%B8%8C%E6%9C%9B%E4%BD%BF%E7%94%A8%20only%20%E7%9A%84%E6%96%B9%E5%BC%8F%E5%8F%AA%E6%89%A7%E8%A1%8C%E6%9F%90%E4%B8%AA%E7%94%A8%E4%BE%8B%E9%82%A3%E6%AE%B5%E4%BB%A3%E7%A0%81%E8%BF%98%E6%98%AF%E4%BC%9A%E8%A2%AB%E6%89%A7%E8%A1%8C%EF%BC%8C%E8%BF%99%E6%98%AF%E9%9D%9E%E9%A2%84%E6%9C%9F%E7%9A%84%E3%80%82%0A%0A%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%81%9A%E6%B3%95%E6%98%AF%E5%B0%86%E5%85%B6%E6%94%BE%E5%88%B0%20before%20%E4%B8%AD%EF%BC%8C%E5%8F%AA%E6%9C%89%E8%BF%90%E8%A1%8C%E8%BF%99%E4%B8%AA%E5%A5%97%E4%BB%B6%E4%B8%AD%E6%9F%90%E4%B8%AA%E7%94%A8%E4%BE%8B%E6%89%8D%E4%BC%9A%E6%89%A7%E8%A1%8C%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20Good%0Aconst%20%7B%20app%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('good%20test'%2C%20()%20%3D%3E%20%7B%0A%20%20before(()%20%3D%3E%20doSomethingBefore())%3B%0A%0A%20%20it('should%20redirect'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20.expect(302)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0AMocha%20%E4%BD%BF%E7%94%A8%20before%2Fafter%2FbeforeEach%2FafterEach%20%E6%9D%A5%E5%A4%84%E7%90%86%E5%89%8D%E7%BD%AE%E5%90%8E%E7%BD%AE%E4%BB%BB%E5%8A%A1%EF%BC%8C%E5%9F%BA%E6%9C%AC%E8%83%BD%E5%A4%84%E7%90%86%E6%89%80%E6%9C%89%E9%97%AE%E9%A2%98%E3%80%82%0A%E6%AF%8F%E4%B8%AA%E7%94%A8%E4%BE%8B%E4%BC%9A%E6%8C%89%20before%20-%3E%20beforeEach%20-%3E%20it%20-%3E%20afterEach%20-%3E%20after%20%E7%9A%84%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C%EF%BC%8C%E8%80%8C%E4%B8%94%E5%8F%AF%E4%BB%A5%E5%AE%9A%E4%B9%89%E5%A4%9A%E4%B8%AA%E3%80%82%0A%0A%60%60%60js%0Adescribe('egg%20test'%2C%20()%20%3D%3E%20%7B%0A%20%20before(()%20%3D%3E%20console.log('order%201'))%3B%0A%20%20before(()%20%3D%3E%20console.log('order%202'))%3B%0A%20%20after(()%20%3D%3E%20console.log('order%206'))%3B%0A%20%20beforeEach(()%20%3D%3E%20console.log('order%203'))%3B%0A%20%20afterEach(()%20%3D%3E%20console.log('order%205'))%3B%0A%20%20it('should%20worker'%2C%20()%20%3D%3E%20console.log('order%204'))%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%20%E5%BC%82%E6%AD%A5%E6%B5%8B%E8%AF%95%0A%0Aegg-bin%20%E6%94%AF%E6%8C%81%E6%B5%8B%E8%AF%95%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%EF%BC%8C%E5%AE%83%E6%94%AF%E6%8C%81%E5%A4%9A%E7%A7%8D%E5%86%99%E6%B3%95%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20%E4%BD%BF%E7%94%A8%E8%BF%94%E5%9B%9E%20Promise%20%E7%9A%84%E6%96%B9%E5%BC%8F%0Ait('should%20redirect'%2C%20()%20%3D%3E%20%7B%0A%20%20return%20app.httpRequest()%0A%20%20%20%20.get('%2F')%0A%20%20%20%20.expect(302)%3B%0A%7D)%3B%0A%0A%2F%2F%20%E4%BD%BF%E7%94%A8%20callback%20%E7%9A%84%E6%96%B9%E5%BC%8F%0Ait('should%20redirect'%2C%20done%20%3D%3E%20%7B%0A%20%20app.httpRequest()%0A%20%20%20%20.get('%2F')%0A%20%20%20%20.expect(302%2C%20done)%3B%0A%7D)%3B%0A%0A%2F%2F%20%E4%BD%BF%E7%94%A8%20async%0Ait('should%20redirect'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20await%20app.httpRequest()%0A%20%20%20%20.get('%2F')%0A%20%20%20%20.expect(302)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E4%BD%BF%E7%94%A8%E5%93%AA%E7%A7%8D%E5%86%99%E6%B3%95%E5%8F%96%E5%86%B3%E4%BA%8E%E4%B8%8D%E5%90%8C%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%8C%E5%A6%82%E6%9E%9C%E9%81%87%E5%88%B0%E5%A4%9A%E4%B8%AA%E5%BC%82%E6%AD%A5%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%20async%20function%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E6%8B%86%E5%88%86%E6%88%90%E5%A4%9A%E4%B8%AA%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E3%80%82%0A%0A%23%23%20Controller%20%E6%B5%8B%E8%AF%95%0A%0AController%20%E5%9C%A8%E6%95%B4%E4%B8%AA%E5%BA%94%E7%94%A8%E4%BB%A3%E7%A0%81%E9%87%8C%E9%9D%A2%E5%B1%9E%E4%BA%8E%E6%AF%94%E8%BE%83%E9%9A%BE%E6%B5%8B%E8%AF%95%E7%9A%84%E9%83%A8%E5%88%86%E4%BA%86%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AE%83%E8%B7%9F%20router%20%E9%85%8D%E7%BD%AE%E7%B4%A7%E5%AF%86%E7%9B%B8%E5%85%B3%EF%BC%8C%0A%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%88%A9%E7%94%A8%20%60app.httpRequest()%60%20%5BSuperTest%5D(https%3A%2F%2Fgithub.com%2Fvisionmedia%2Fsupertest)%20%E5%8F%91%E8%B5%B7%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E8%AF%B7%E6%B1%82%EF%BC%8C%0A%E6%9D%A5%E5%B0%86%20Router%20%E5%92%8C%20Controller%20%E8%BF%9E%E6%8E%A5%E8%B5%B7%E6%9D%A5%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%8F%AF%E4%BB%A5%E5%B8%AE%E5%8A%A9%E6%88%91%E4%BB%AC%E5%8F%91%E9%80%81%E5%90%84%E7%A7%8D%E6%BB%A1%E8%B6%B3%E8%BE%B9%E7%95%8C%E6%9D%A1%E4%BB%B6%E7%9A%84%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%EF%BC%8C%0A%E4%BB%A5%E6%B5%8B%E8%AF%95%20Controller%20%E7%9A%84%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%E5%AE%8C%E6%95%B4%E6%80%A7%E3%80%82%20%60app.httpRequest()%60%20%E6%98%AF%20%5Begg-mock%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock)%20%E5%B0%81%E8%A3%85%E7%9A%84%20%5BSuperTest%5D(https%3A%2F%2Fgithub.com%2Fvisionmedia%2Fsupertest)%20%E8%AF%B7%E6%B1%82%E5%AE%9E%E4%BE%8B%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%E6%88%91%E4%BB%AC%E8%A6%81%E7%BB%99%20%60app%2Fcontroller%2Fhome.js%60%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Frouter.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20%7B%20router%2C%20controller%20%7D%20%3D%20app%3B%0A%20%20router.get('homepage'%2C%20'%2F'%2C%20controller.home.index)%3B%0A%7D%3B%0A%0A%2F%2F%20app%2Fcontroller%2Fhome.js%0Aclass%20HomeController%20extends%20Controller%20%7B%0A%20%20async%20index()%20%7B%0A%20%20%20%20this.ctx.body%20%3D%20'hello%20world'%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E5%86%99%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%AE%83%E7%9A%84%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%20%60test%2Fcontroller%2Fhome.test.js%60%20%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%0A%60%60%60js%0Aconst%20%7B%20app%2C%20mock%2C%20assert%20%7D%20%3D%20require('egg-mock%2Fbootstrap')%3B%0A%0Adescribe('test%2Fcontroller%2Fhome.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20describe('GET%20%2F'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20status%20200%20and%20get%20the%20body'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E5%AF%B9%20app%20%E5%8F%91%E8%B5%B7%20%60GET%20%2F%60%20%E8%AF%B7%E6%B1%82%0A%20%20%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20%20%20.expect(200)%20%2F%2F%20%E6%9C%9F%E6%9C%9B%E8%BF%94%E5%9B%9E%20status%20200%0A%20%20%20%20%20%20%20%20.expect('hello%20world')%3B%20%2F%2F%20%E6%9C%9F%E6%9C%9B%20body%20%E6%98%AF%20hello%20world%0A%20%20%20%20%7D)%3B%0A%0A%20%20%20%20it('should%20send%20multi%20requests'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E4%BD%BF%E7%94%A8%20generator%20function%20%E6%96%B9%E5%BC%8F%E5%86%99%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8%E4%B8%80%E4%B8%AA%E7%94%A8%E4%BE%8B%E4%B8%AD%E4%B8%B2%E8%A1%8C%E5%8F%91%E8%B5%B7%E5%A4%9A%E6%AC%A1%E8%AF%B7%E6%B1%82%0A%20%20%20%20%20%20await%20app.httpRequest()%0A%20%20%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20%20%20.expect(200)%20%2F%2F%20%E6%9C%9F%E6%9C%9B%E8%BF%94%E5%9B%9E%20status%20200%0A%20%20%20%20%20%20%20%20.expect('hello%20world')%3B%20%2F%2F%20%E6%9C%9F%E6%9C%9B%20body%20%E6%98%AF%20hello%20world%0A%0A%20%20%20%20%20%20%2F%2F%20%E5%86%8D%E8%AF%B7%E6%B1%82%E4%B8%80%E6%AC%A1%0A%20%20%20%20%20%20const%20result%20%3D%20await%20app.httpRequest()%0A%20%20%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20%20%20.expect(200)%0A%20%20%20%20%20%20%20%20.expect('hello%20world')%3B%0A%0A%20%20%20%20%20%20%2F%2F%20%E4%B9%9F%E5%8F%AF%E4%BB%A5%E8%BF%99%E6%A0%B7%E9%AA%8C%E8%AF%81%0A%20%20%20%20%20%20assert(result.status%20%3D%3D%3D%20200)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E9%80%9A%E8%BF%87%E5%9F%BA%E4%BA%8E%20SuperTest%20%E7%9A%84%20%60app.httpRequest()%60%20%E5%8F%AF%E4%BB%A5%E8%BD%BB%E6%9D%BE%E5%8F%91%E8%B5%B7%20GET%E3%80%81POST%E3%80%81PUT%20%E7%AD%89%20HTTP%20%E8%AF%B7%E6%B1%82%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%AE%83%E6%9C%89%E9%9D%9E%E5%B8%B8%E4%B8%B0%E5%AF%8C%E7%9A%84%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%E6%9E%84%E9%80%A0%E6%8E%A5%E5%8F%A3%EF%BC%8C%0A%E4%BE%8B%E5%A6%82%E4%BB%A5%20POST%20%E6%96%B9%E5%BC%8F%E5%8F%91%E9%80%81%E4%B8%80%E4%B8%AA%20JSON%20%E8%AF%B7%E6%B1%82%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fhome.js%0Aclass%20HomeController%20extends%20Controller%20%7B%0A%20%20async%20post()%20%7B%0A%20%20%20%20this.ctx.body%20%3D%20this.ctx.request.body%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20test%2Fcontroller%2Fhome.test.js%0Ait('should%20status%20200%20and%20get%20the%20request%20body'%2C%20()%20%3D%3E%20%7B%0A%20%20%2F%2F%20%E6%A8%A1%E6%8B%9F%20CSRF%20token%EF%BC%8C%E4%B8%8B%E6%96%87%E4%BC%9A%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E%0A%20%20app.mockCsrf()%3B%0A%20%20return%20app.httpRequest()%0A%20%20%20%20.post('%2Fpost')%0A%20%20%20%20.type('form')%0A%20%20%20%20.send(%7B%0A%20%20%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%20%20%7D)%0A%20%20%20%20.expect(200)%0A%20%20%20%20.expect(%7B%0A%20%20%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E6%9B%B4%E8%AF%A6%E7%BB%86%E7%9A%84%20HTTP%20%E8%AF%B7%E6%B1%82%E6%9E%84%E9%80%A0%E6%96%B9%E5%BC%8F%EF%BC%8C%E8%AF%B7%E6%9F%A5%E7%9C%8B%20%5BSuperTest%20%E6%96%87%E6%A1%A3%5D(https%3A%2F%2Fgithub.com%2Fvisionmedia%2Fsupertest%23getting-started)%E3%80%82%0A%0A%23%23%23%20mock%20CSRF%0A%0A%E6%A1%86%E6%9E%B6%E7%9A%84%E9%BB%98%E8%AE%A4%E5%AE%89%E5%85%A8%E6%8F%92%E4%BB%B6%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%BC%80%E5%90%AF%20%5BCSRF%20%E9%98%B2%E6%8A%A4%5D(.%2Fsecurity.md%23%E5%AE%89%E5%85%A8%E5%A8%81%E8%83%81csrf%E7%9A%84%E9%98%B2%E8%8C%83)%EF%BC%8C%0A%E5%A6%82%E6%9E%9C%E5%AE%8C%E6%95%B4%E8%B5%B0%20CSRF%20%E6%A0%A1%E9%AA%8C%E9%80%BB%E8%BE%91%EF%BC%8C%E9%82%A3%E4%B9%88%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%E9%9C%80%E8%A6%81%E5%85%88%E8%AF%B7%E6%B1%82%E4%B8%80%E6%AC%A1%E9%A1%B5%E9%9D%A2%EF%BC%8C%E9%80%9A%E8%BF%87%E8%A7%A3%E6%9E%90%20HTML%20%E6%8B%BF%E5%88%B0%20CSRF%20token%EF%BC%8C%0A%E7%84%B6%E5%90%8E%E5%86%8D%E4%BD%BF%E7%94%A8%E6%AD%A4%20token%20%E5%8F%91%E8%B5%B7%20POST%20%E8%AF%B7%E6%B1%82%E3%80%82%0A%0A%E6%89%80%E4%BB%A5%20egg-mock%20%E5%AF%B9%20app%20%E5%A2%9E%E5%8A%A0%E4%BA%86%20%60app.mockCsrf()%60%20%E6%96%B9%E6%B3%95%E6%9D%A5%E6%A8%A1%E6%8B%9F%E5%8F%96%20CSRF%20token%20%E7%9A%84%E8%BF%87%E7%A8%8B%E3%80%82%0A%E8%BF%99%E6%A0%B7%E5%9C%A8%E4%BD%BF%E7%94%A8%20SuperTest%20%E8%AF%B7%E6%B1%82%20app%20%E5%B0%B1%E4%BC%9A%E8%87%AA%E5%8A%A8%E9%80%9A%E8%BF%87%20CSRF%20%E6%A0%A1%E9%AA%8C%E3%80%82%0A%0A%60%60%60js%0Aapp.mockCsrf()%3B%0Areturn%20app.httpRequest()%0A%20%20.post('%2Fpost')%0A%20%20.type('form')%0A%20%20.send(%7B%0A%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%7D)%0A%20%20.expect(200)%0A%20%20.expect(%7B%0A%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%7D)%3B%0A%60%60%60%0A%0A%23%23%20Service%20%E6%B5%8B%E8%AF%95%0A%0AService%20%E7%9B%B8%E5%AF%B9%E4%BA%8E%20Controller%20%E6%9D%A5%E8%AF%B4%EF%BC%8C%E6%B5%8B%E8%AF%95%E8%B5%B7%E6%9D%A5%E4%BC%9A%E6%9B%B4%E5%8A%A0%E7%AE%80%E5%8D%95%EF%BC%8C%0A%E6%88%91%E4%BB%AC%E5%8F%AA%E9%9C%80%E8%A6%81%E5%85%88%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20ctx%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%9A%E8%BF%87%20%60ctx.service.%24%7BserviceName%7D%60%20%E6%8B%BF%E5%88%B0%20Service%20%E5%AE%9E%E4%BE%8B%EF%BC%8C%0A%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8%20Service%20%E6%96%B9%E6%B3%95%E5%8D%B3%E5%8F%AF%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fservice%2Fuser.js%0Aclass%20UserService%20extends%20Service%20%7B%0A%20%20async%20get(name)%20%7B%0A%20%20%20%20return%20await%20userDatabase.get(name)%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E7%BC%96%E5%86%99%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%9A%0A%0A%60%60%60js%0Adescribe('get()'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20get%20exists%20user'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%E5%88%9B%E5%BB%BA%20ctx%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%20%20%2F%2F%20%E9%80%9A%E8%BF%87%20ctx%20%E8%AE%BF%E9%97%AE%E5%88%B0%20service.user%0A%20%20%20%20const%20user%20%3D%20await%20ctx.service.user.get('fengmk2')%3B%0A%20%20%20%20assert(user)%3B%0A%20%20%20%20assert(user.name%20%3D%3D%3D%20'fengmk2')%3B%0A%20%20%7D)%3B%0A%0A%20%20it('should%20get%20null%20when%20user%20not%20exists'%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%20%20const%20user%20%3D%20await%20ctx.service.user.get('fengmk1')%3B%0A%20%20%20%20assert(!user)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E5%BD%93%E7%84%B6%EF%BC%8C%E5%AE%9E%E9%99%85%E7%9A%84%20Service%20%E4%BB%A3%E7%A0%81%E4%B8%8D%E4%BC%9A%E5%83%8F%E6%88%91%E4%BB%AC%E7%A4%BA%E4%BE%8B%E4%B8%AD%E9%82%A3%E4%B9%88%E7%AE%80%E5%8D%95%EF%BC%8C%E8%BF%99%E9%87%8C%E5%8F%AA%E6%98%AF%E5%B1%95%E7%A4%BA%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95%20Service%20%E8%80%8C%E5%B7%B2%E3%80%82%0A%0A%23%23%20Extend%20%E6%B5%8B%E8%AF%95%0A%0A%E5%BA%94%E7%94%A8%E5%8F%AF%E4%BB%A5%E5%AF%B9%20Application%E3%80%81Request%E3%80%81Response%E3%80%81Context%20%E5%92%8C%20Helper%20%E8%BF%9B%E8%A1%8C%E6%89%A9%E5%B1%95%E3%80%82%0A%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%AF%B9%E6%89%A9%E5%B1%95%E7%9A%84%E6%96%B9%E6%B3%95%E6%88%96%E8%80%85%E5%B1%9E%E6%80%A7%E9%92%88%E5%AF%B9%E6%80%A7%E7%9A%84%E7%BC%96%E5%86%99%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A%23%23%23%20Application%0A%0Aegg-mock%20%E5%88%9B%E5%BB%BA%20app%20%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%B7%B2%E7%BB%8F%E5%B0%86%20Application%20%E7%9A%84%E6%89%A9%E5%B1%95%E8%87%AA%E5%8A%A8%E5%8A%A0%E8%BD%BD%E5%88%B0%20app%20%E5%AE%9E%E4%BE%8B%E4%BA%86%EF%BC%8C%0A%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%20app%20%E5%AE%9E%E4%BE%8B%E8%AE%BF%E9%97%AE%E6%89%A9%E5%B1%95%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%E5%8D%B3%E5%8F%AF%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%20%60app%2Fextend%2Fapplication.js%60%EF%BC%8C%E6%88%91%E4%BB%AC%E7%BB%99%20app%20%E5%A2%9E%E5%8A%A0%E4%BA%86%E4%B8%80%E4%B8%AA%E5%9F%BA%E4%BA%8E%20%5Bylru%5D(https%3A%2F%2Fgithub.com%2Fnode-modules%2Fylru)%20%E7%9A%84%E7%BC%93%E5%AD%98%E5%8A%9F%E8%83%BD%EF%BC%9A%0A%0A%60%60%60js%0Aconst%20LRU%20%3D%20Symbol('Application%23lru')%3B%0Aconst%20LRUCache%20%3D%20require('ylru')%3B%0Amodule.exports%20%3D%20%7B%0A%20%20get%20lru()%20%7B%0A%20%20%20%20if%20(!this%5BLRU%5D)%20%7B%0A%20%20%20%20%20%20this%5BLRU%5D%20%3D%20new%20LRUCache(1000)%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20this%5BLRU%5D%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%9A%0A%0A%60%60%60js%0Adescribe('get%20lru'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20get%20a%20lru%20and%20it%20work'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%E8%AE%BE%E7%BD%AE%E7%BC%93%E5%AD%98%0A%20%20%20%20app.lru.set('foo'%2C%20'bar')%3B%0A%20%20%20%20%2F%2F%20%E8%AF%BB%E5%8F%96%E7%BC%93%E5%AD%98%0A%20%20%20%20assert(app.lru.get('foo')%20%3D%3D%3D%20'bar')%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E6%B5%8B%E8%AF%95%20Application%20%E7%9A%84%E6%89%A9%E5%B1%95%E6%98%AF%E6%9C%80%E5%AE%B9%E6%98%93%E7%9A%84%E3%80%82%0A%0A%23%23%23%20Context%0A%0AContext%20%E6%B5%8B%E8%AF%95%E5%8F%AA%E6%AF%94%20Application%20%E5%A4%9A%E4%BA%86%E4%B8%80%E4%B8%AA%20%60app.mockContext()%60%20%E6%AD%A5%E9%AA%A4%E6%9D%A5%E6%A8%A1%E6%8B%9F%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%20Context%20%E5%AF%B9%E8%B1%A1%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%E5%9C%A8%20%60app%2Fextend%2Fcontext.js%60%20%E4%B8%AD%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AA%20%60isXHR%60%20%E5%B1%9E%E6%80%A7%EF%BC%8C%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E9%80%9A%E8%BF%87%20%5BXMLHttpRequest%5D(https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FXMLHttpRequest%2FsetRequestHeader)%20%E5%8F%91%E8%B5%B7%E7%9A%84%E8%AF%B7%E6%B1%82%EF%BC%9A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20get%20isXHR()%20%7B%0A%20%20%20%20return%20this.get('X-Requested-With')%20%3D%3D%3D%20'XMLHttpRequest'%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%9A%0A%0A%60%60%60js%0Adescribe('isXHR()'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20true'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20%20%20'X-Requested-With'%3A%20'XMLHttpRequest'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20assert(ctx.isXHR%20%3D%3D%3D%20true)%3B%0A%20%20%7D)%3B%0A%0A%20%20it('should%20false'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20%20%20'X-Requested-With'%3A%20'SuperAgent'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20assert(ctx.isXHR%20%3D%3D%3D%20false)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20Request%0A%0A%E9%80%9A%E8%BF%87%20%60ctx.request%60%20%E6%9D%A5%E8%AE%BF%E9%97%AE%20Request%20%E6%89%A9%E5%B1%95%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%8D%B3%E5%8F%AF%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%E5%9C%A8%20%60app%2Fextend%2Frequest.js%60%20%E4%B8%AD%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AA%20%60isChrome%60%20%E5%B1%9E%E6%80%A7%EF%BC%8C%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%20Chrome%20%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8F%91%E8%B5%B7%E7%9A%84%E8%AF%B7%E6%B1%82%EF%BC%9A%0A%0A%60%60%60js%0Aconst%20IS_CHROME%20%3D%20Symbol('Request%23isChrome')%3B%0Amodule.exports%20%3D%20%7B%0A%20%20get%20isChrome()%20%7B%0A%20%20%20%20if%20(!this%5BIS_CHROME%5D)%20%7B%0A%20%20%20%20%20%20const%20ua%20%3D%20this.get('User-Agent').toLowerCase()%3B%0A%20%20%20%20%20%20this%5BIS_CHROME%5D%20%3D%20ua.includes('chrome%2F')%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20this%5BIS_CHROME%5D%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%9A%0A%0A%60%60%60js%0Adescribe('isChrome()'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20true'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20%20%20'User-Agent'%3A%20'Chrome%2F56.0.2924.51'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20assert(ctx.request.isChrome%20%3D%3D%3D%20true)%3B%0A%20%20%7D)%3B%0A%0A%20%20it('should%20false'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20%20%20'User-Agent'%3A%20'FireFox%2F1'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20assert(ctx.request.isChrome%20%3D%3D%3D%20false)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20Response%0A%0AResponse%20%E6%B5%8B%E8%AF%95%E4%B8%8E%20Request%20%E5%AE%8C%E5%85%A8%E4%B8%80%E8%87%B4%E3%80%82%0A%E9%80%9A%E8%BF%87%20%60ctx.response%60%20%E6%9D%A5%E8%AE%BF%E9%97%AE%20Response%20%E6%89%A9%E5%B1%95%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%8D%B3%E5%8F%AF%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%E5%9C%A8%20%60app%2Fextend%2Fresponse.js%60%20%E4%B8%AD%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AA%20%60isSuccess%60%20%E5%B1%9E%E6%80%A7%EF%BC%8C%E5%88%A4%E6%96%AD%E5%BD%93%E5%89%8D%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81%E6%98%AF%E5%90%A6%20200%EF%BC%9A%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20get%20isSuccess()%20%7B%0A%20%20%20%20return%20this.status%20%3D%3D%3D%20200%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%9A%0A%0A%60%60%60js%0Adescribe('isSuccess()'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20true'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%20%20ctx.status%20%3D%20200%3B%0A%20%20%20%20assert(ctx.response.isSuccess%20%3D%3D%3D%20true)%3B%0A%20%20%7D)%3B%0A%0A%20%20it('should%20false'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%20%20ctx.status%20%3D%20404%3B%0A%20%20%20%20assert(ctx.response.isSuccess%20%3D%3D%3D%20false)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20Helper%0A%0AHelper%20%E6%B5%8B%E8%AF%95%E6%96%B9%E5%BC%8F%E4%B8%8E%20Service%20%E7%B1%BB%E4%BC%BC%EF%BC%8C%E4%B9%9F%E6%98%AF%E9%80%9A%E8%BF%87%20ctx%20%E6%9D%A5%E8%AE%BF%E9%97%AE%E5%88%B0%20Helper%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8%20Helper%20%E6%96%B9%E6%B3%95%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%20%60app%2Fextend%2Fhelper.js%60%0A%0A%60%60%60js%0Amodule.exports%20%3D%20%7B%0A%20%20money(val)%20%7B%0A%20%20%20%20const%20lang%20%3D%20this.ctx.get('Accept-Language')%3B%0A%20%20%20%20if%20(lang.includes('zh-CN'))%20%7B%0A%20%20%20%20%20%20return%20%60%EF%BF%A5%20%24%7Bval%7D%60%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20%60%24%20%24%7Bval%7D%60%3B%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%9A%0A%0A%60%60%60js%0Adescribe('money()'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20RMB'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext(%7B%0A%20%20%20%20%20%20%2F%2F%20%E6%A8%A1%E6%8B%9F%20ctx%20%E7%9A%84%20headers%0A%20%20%20%20%20%20headers%3A%20%7B%0A%20%20%20%20%20%20%20%20'Accept-Language'%3A%20'zh-CN%2Czh%3Bq%3D0.5'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20assert(ctx.helper.money(100)%20%3D%3D%3D%20'%EF%BF%A5%20100')%3B%0A%20%20%7D)%3B%0A%0A%20%20it('should%20US%20Dolar'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20ctx%20%3D%20app.mockContext()%3B%0A%20%20%20%20assert(ctx.helper.money(100)%20%3D%3D%3D%20'%24%20100')%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%20Mock%20%E6%96%B9%E6%B3%95%0A%0Aegg-mock%20%E9%99%A4%E4%BA%86%E4%B8%8A%E9%9D%A2%E4%BB%8B%E7%BB%8D%E8%BF%87%E7%9A%84%20%60app.mockContext()%60%20%E5%92%8C%20%60app.mockCsrf()%60%20%E6%96%B9%E6%B3%95%E5%A4%96%EF%BC%8C%E8%BF%98%E6%8F%90%E4%BE%9B%E4%BA%86%5B%E9%9D%9E%E5%B8%B8%E5%A4%9A%E7%9A%84%20mock%20%E6%96%B9%E6%B3%95%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mock%23api)%E5%B8%AE%E5%8A%A9%E6%88%91%E4%BB%AC%E4%BE%BF%E6%8D%B7%E5%9C%B0%E5%86%99%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A-%20%E5%A6%82%E6%88%91%E4%BB%AC%E4%B8%8D%E6%83%B3%E5%9C%A8%E7%BB%88%E7%AB%AF%20console%20%E8%BE%93%E5%87%BA%E4%BB%BB%E4%BD%95%E6%97%A5%E5%BF%97%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60mock.consoleLevel('NONE')%60%20%E6%9D%A5%E6%A8%A1%E6%8B%9F%E3%80%82%0A-%20%E5%8F%88%E5%A6%82%E6%88%91%E6%83%B3%E6%A8%A1%E6%8B%9F%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E7%9A%84%20Session%20%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60app.mockSession(data)%60%20%E6%9D%A5%E6%A8%A1%E6%8B%9F%E3%80%82%0A%0A%20%20%60%60%60js%0A%20%20describe('GET%20%2Fsession'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20it('should%20mock%20session%20work'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20app.mockSession(%7B%0A%20%20%20%20%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%20%20%20%20%20%20uid%3A%20123%2C%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20%20%20.get('%2Fsession')%0A%20%20%20%20%20%20%20%20.expect(200)%0A%20%20%20%20%20%20%20%20.expect(%7B%0A%20%20%20%20%20%20%20%20%20%20session%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20foo%3A%20'bar'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20uid%3A%20123%2C%0A%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%20%20%60%60%60%0A%0A%E5%9B%A0%E4%B8%BA%20mock%20%E4%B9%8B%E5%90%8E%E4%BC%9A%E4%B8%80%E7%9B%B4%E7%94%9F%E6%95%88%EF%BC%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E9%81%BF%E5%85%8D%E6%AF%8F%E4%B8%AA%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E4%B9%8B%E9%97%B4%E6%98%AF%E4%B8%8D%E8%83%BD%E7%9B%B8%E4%BA%92%20mock%20%E6%B1%A1%E6%9F%93%E7%9A%84%EF%BC%8C%0A%E6%89%80%E4%BB%A5%E9%80%9A%E5%B8%B8%E6%88%91%E4%BB%AC%E9%83%BD%E4%BC%9A%E5%9C%A8%20%60afterEach%60%20%E9%92%A9%E5%AD%90%E9%87%8C%E9%9D%A2%E8%BF%98%E5%8E%9F%E6%8E%89%E6%89%80%E6%9C%89%20mock%E3%80%82%0A%0A%60%60%60js%0Adescribe('some%20test'%2C%20()%20%3D%3E%20%7B%0A%20%20%2F%2F%20before%20hook%0A%0A%20%20afterEach(mock.restore)%3B%0A%0A%20%20%2F%2F%20it%20tests%0A%7D)%3B%0A%60%60%60%0A%0A**%E5%BC%95%E5%85%A5%20%60egg-mock%2Fbootstrap%60%20%E6%97%B6%EF%BC%8C%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%9C%A8%20%60afterEach%60%20%E9%92%A9%E5%AD%90%E4%B8%AD%E8%BF%98%E5%8E%9F%E6%89%80%E6%9C%89%E7%9A%84%20mock%EF%BC%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E5%9C%A8%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6%E4%B8%AD%E5%86%8D%E6%AC%A1%E7%BC%96%E5%86%99%E3%80%82**%0A%0A%E4%B8%8B%E9%9D%A2%E4%BC%9A%E8%AF%A6%E7%BB%86%E8%A7%A3%E9%87%8A%E4%B8%80%E4%B8%8B%20egg-mock%20%E7%9A%84%E5%B8%B8%E8%A7%81%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E3%80%82%0A%0A%23%23%23%20Mock%20%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%0A%0A%E5%9B%A0%E4%B8%BA%20egg-mock%20%E6%98%AF%E6%89%A9%E5%B1%95%E8%87%AA%20%5Bmm%5D(https%3A%2F%2Fgithub.com%2Fnode-modules%2Fmm)%20%E6%A8%A1%E5%9D%97%EF%BC%8C%0A%E5%AE%83%E5%8C%85%E5%90%AB%E4%BA%86%20mm%20%E7%9A%84%E6%89%80%E6%9C%89%E5%8A%9F%E8%83%BD%EF%BC%8C%E8%BF%99%E6%A0%B7%E6%88%91%E4%BB%AC%E5%B0%B1%E5%8F%AF%E4%BB%A5%E9%9D%9E%E5%B8%B8%E6%96%B9%E4%BE%BF%E5%9C%B0%20mock%20%E4%BB%BB%E6%84%8F%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%E4%BA%86%E3%80%82%0A%0A%23%23%23%23%20Mock%20%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7%0A%0Amock%20%60app.config.baseDir%60%20%E6%8C%87%E5%90%91%20%60%2Ftmp%2Fmockapp%60%0A%0A%60%60%60js%0Amock(app.config%2C%20'baseDir'%2C%20'%2Ftmp%2Fmockapp')%3B%0Aassert(app.config.baseDir%20%3D%3D%3D%20'%2Ftmp%2Fmockapp')%3B%0A%60%60%60%0A%0A%23%23%23%23%20Mock%20%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%96%B9%E6%B3%95%0A%0Amock%20%60fs.readFileSync%60%20%E8%BF%94%E5%9B%9E%20%60hello%20world%60%0A%0A%60%60%60js%0Amock(fs%2C%20'readFileSync'%2C%20filename%20%3D%3E%20%7B%0A%20%20return%20'hello%20world'%3B%0A%7D)%3B%0Aassert(fs.readFileSync('foo.txt')%20%3D%3D%3D%20'hello%20world')%3B%0A%60%60%60%0A%0A%E8%BF%98%E6%9C%89%20%60mock.data()%60%EF%BC%8C%60mock.error()%60%20%E7%AD%89%E6%9B%B4%E5%A4%9A%E9%AB%98%E7%BA%A7%E7%9A%84%20mock%20%E6%96%B9%E6%B3%95%EF%BC%8C%0A%E8%AF%A6%E7%BB%86%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E%E8%AF%B7%E6%9F%A5%E7%9C%8B%20%5Bmm%20API%5D(https%3A%2F%2Fgithub.com%2Fnode-modules%2Fmm%23api)%E3%80%82%0A%0A%23%23%23%20Mock%20Service%0A%0AService%20%E4%BD%9C%E4%B8%BA%E6%A1%86%E6%9E%B6%E6%A0%87%E5%87%86%E7%9A%84%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1%EF%BC%8C%E6%88%91%E4%BB%AC%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BE%BF%E6%8D%B7%E7%9A%84%20%60app.mockService(service%2C%20methodName%2C%20fn)%60%20%E6%A8%A1%E6%8B%9F%20Service%20%E6%96%B9%E6%B3%95%E8%BF%94%E5%9B%9E%E5%80%BC%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%EF%BC%8C%E6%A8%A1%E6%8B%9F%20%60app%2Fservice%2Fuser%60%20%E4%B8%AD%E7%9A%84%20%60get(name)%60%20%E6%96%B9%E6%B3%95%EF%BC%8C%E8%AE%A9%E5%AE%83%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E6%9C%AC%E6%9D%A5%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E3%80%82%0A%0A%60%60%60js%0Ait('should%20mock%20fengmk1%20exists'%2C%20()%20%3D%3E%20%7B%0A%20%20app.mockService('user'%2C%20'get'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20name%3A%20'fengmk1'%2C%0A%20%20%20%20%7D%3B%0A%20%20%7D)%3B%0A%0A%20%20return%20app.httpRequest()%0A%20%20%20%20.get('%2Fuser%3Fname%3Dfengmk1')%0A%20%20%20%20.expect(200)%0A%20%20%20%20%2F%2F%20%E8%BF%94%E5%9B%9E%E4%BA%86%E5%8E%9F%E6%9C%AC%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%0A%20%20%20%20.expect(%7B%0A%20%20%20%20%20%20name%3A%20'fengmk1'%2C%0A%20%20%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E9%80%9A%E8%BF%87%20%60app.mockServiceError(service%2C%20methodName%2C%20error)%60%20%E5%8F%AF%E4%BB%A5%E6%A8%A1%E6%8B%9F%20Service%20%E8%B0%83%E7%94%A8%E5%BC%82%E5%B8%B8%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%EF%BC%8C%E6%A8%A1%E6%8B%9F%20%60app%2Fservice%2Fuser%60%20%E4%B8%AD%E7%9A%84%20%60get(name)%60%20%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E5%BC%82%E5%B8%B8%EF%BC%9A%0A%0A%60%60%60js%0Ait('should%20mock%20service%20error'%2C%20()%20%3D%3E%20%7B%0A%20%20app.mockServiceError('user'%2C%20'get'%2C%20'mock%20user%20service%20error')%3B%0A%20%20return%20app.httpRequest()%0A%20%20%20%20.get('%2Fuser%3Fname%3Dfengmk2')%0A%20%20%20%20%2F%2F%20service%20%E5%BC%82%E5%B8%B8%EF%BC%8C%E8%A7%A6%E5%8F%91%20500%20%E5%93%8D%E5%BA%94%0A%20%20%20%20.expect(500)%0A%20%20%20%20.expect(%2Fmock%20user%20service%20error%2F)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20Mock%20HttpClient%0A%0A%E6%A1%86%E6%9E%B6%E5%86%85%E7%BD%AE%E4%BA%86%20%5BHttpClient%5D(.%2Fhttpclient.md)%EF%BC%8C%E5%BA%94%E7%94%A8%E5%8F%91%E8%B5%B7%E7%9A%84%E5%AF%B9%E5%A4%96%20HTTP%20%E8%AF%B7%E6%B1%82%E5%9F%BA%E6%9C%AC%E9%83%BD%E6%98%AF%E9%80%9A%E8%BF%87%E5%AE%83%E6%9D%A5%E5%A4%84%E7%90%86%E3%80%82%0A%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60app.mockHttpclient(url%2C%20method%2C%20data)%60%20%E6%9D%A5%20mock%20%E6%8E%89%20%60app.curl%60%20%E5%92%8C%20%60ctx.curl%60%20%E6%96%B9%E6%B3%95%EF%BC%8C%0A%E4%BB%8E%E8%80%8C%E5%AE%9E%E7%8E%B0%E5%90%84%E7%A7%8D%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%E5%9C%A8%20%60app%2Fcontroller%2Fhome.js%60%20%E4%B8%AD%E5%8F%91%E8%B5%B7%E4%BA%86%E4%B8%80%E4%B8%AA%20curl%20%E8%AF%B7%E6%B1%82%0A%0A%60%60%60js%0Aclass%20HomeController%20extends%20Controller%20%7B%0A%20%20async%20httpclient%20()%20%7B%0A%20%20%20%20const%20res%20%3D%20await%20this.ctx.curl('https%3A%2F%2Feggjs.org')%3B%0A%20%20%20%20this.ctx.body%20%3D%20res.data.toString()%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E9%9C%80%E8%A6%81%20mock%20%E5%AE%83%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%EF%BC%9A%0A%0A%60%60%60js%0Adescribe('GET%20%2Fhttpclient'%2C%20()%20%3D%3E%20%7B%0A%20%20it('should%20mock%20httpclient%20response'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20app.mockHttpclient('https%3A%2F%2Feggjs.org'%2C%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E6%A8%A1%E6%8B%9F%E7%9A%84%E5%8F%82%E6%95%B0%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%98%AF%20buffer%20%2F%20string%20%2F%20json%EF%BC%8C%0A%20%20%20%20%20%20%2F%2F%20%E9%83%BD%E4%BC%9A%E8%BD%AC%E6%8D%A2%E6%88%90%20buffer%0A%20%20%20%20%20%20%2F%2F%20%E6%8C%89%E7%85%A7%E8%AF%B7%E6%B1%82%E6%97%B6%E7%9A%84%20options.dataType%20%E6%9D%A5%E5%81%9A%E5%AF%B9%E5%BA%94%E7%9A%84%E8%BD%AC%E6%8D%A2%0A%20%20%20%20%20%20data%3A%20'mock%20eggjs.org%20response'%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.get('%2Fhttpclient')%0A%20%20%20%20%20%20.expect('mock%20eggjs.org%20response')%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%20%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%0A%0A%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%E5%8F%AF%E4%BB%A5%E5%9C%A8%20%5Beggjs%2Fexmaples%2Funittest%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fexamples%2Fblob%2Fmaster%2Funittest)%20%E6%89%BE%E5%88%B0%E3%80%82%0A%0A%5BMocha%5D%3A%20https%3A%2F%2Fmochajs.org%0A%5Bco-mocha%5D%3A%20https%3A%2F%2Fgithub.com%2Fblakeembrey%2Fco-mocha%0A%5Bnyc%5D%3A%20https%3A%2F%2Fgithub.com%2Fistanbuljs%2Fnyc%0A%5Bpower-assert%5D%3A%20https%3A%2F%2Fgithub.com%2Fpower-assert-js%2Fpower-assert%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>