<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>多进程模型和进程间通讯</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>我们知道 JavaScript 代码是运行在单线程上的，换句话说一个 Node.js 进程只能运行在一个 CPU 上。那么如果用 Node.js 来做 Web Server，就无法享受到多核运算的好处。作为企业级的解决方案，我们要解决的一个问题就是:</p><blockquote><p>如何榨干服务器资源，利用上多核 CPU 的并发优势？</p></blockquote><p>而 Node.js 官方提供的解决方案是 <a href="https://nodejs.org/api/cluster.html">Cluster 模块</a></p><blockquote><p>A single instance of Node.js runs in a single thread. To take advantage of multi-core systems the user will sometimes want to launch a cluster of Node.js processes to handle the load.</p><p>The cluster module allows you to easily create child processes that all share server ports.</p></blockquote><h2 id="cluster-是什么呢">Cluster 是什么呢？</h2><p>简单的说，</p><ul><li>在服务器上同时启动多个进程。</li><li>每个进程里都跑的是同一份源代码（好比把以前一个进程的工作分给多个进程去做）。</li><li>更神奇的是，这些进程可以同时监听一个端口（具体原理推荐阅读 @DavidCai1993 这篇 <a href="https://cnodejs.org/topic/56e84480833b7c8a0492e20c">Cluster 实现原理</a>）。</li></ul><p>其中：</p><ul><li>负责启动其他进程的叫做 Master 进程，他好比是个『包工头』，不做具体的工作，只负责启动其他进程。</li><li>其他被启动的叫 Worker 进程，顾名思义就是干活的『工人』。它们接收请求，对外提供服务。</li><li>Worker 进程的数量一般根据服务器的 CPU 核数来定，这样就可以完美利用多核资源。</li></ul><pre><code class="language-js">const cluster = require(&#x27;cluster&#x27;);
const http = require(&#x27;http&#x27;);
const numCPUs = require(&#x27;os&#x27;).cpus().length;

if (cluster.isMaster) {
  // Fork workers.
  for (let i = 0; i &lt; numCPUs; i++) {
    cluster.fork();
  }

  cluster.on(&#x27;exit&#x27;, function(worker, code, signal) {
    console.log(&#x27;worker &#x27; + worker.process.pid + &#x27; died&#x27;);
  });
} else {
  // Workers can share any TCP connection
  // In this case it is an HTTP server
  http.createServer(function(req, res) {
    res.writeHead(200);
    res.end(&quot;hello world\n&quot;);
  }).listen(8000);
}</code></pre><h2 id="框架的多进程模型">框架的多进程模型</h2><p>上面的示例是不是很简单，但是作为企业级的解决方案，要考虑的东西还有很多。</p><ul><li>Worker 进程异常退出以后该如何处理？</li><li>多个 Worker 进程之间如何共享资源？</li><li>多个 Worker 进程之间如何调度？</li><li>...</li></ul><h3 id="进程守护">进程守护</h3><p>健壮性（又叫鲁棒性）是企业级应用必须考虑的问题，除了程序本身代码质量要保证，框架层面也需要提供相应的『兜底』机制保证极端情况下应用的可用性。</p><p>一般来说，Node.js 进程退出可以分为两类：</p><h4 id="未捕获异常">未捕获异常</h4><p>当代码抛出了异常没有被捕获到时，进程将会退出，此时 Node.js 提供了 <code>process.on(&#x27;uncaughtException&#x27;, handler)</code> 接口来捕获它，但是当一个 Worker 进程遇到 <a href="https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_event_uncaughtexception">未捕获的异常</a> 时，它已经处于一个不确定状态，此时我们应该让这个进程优雅退出：</p><ol><li>关闭异常 Worker 进程所有的 TCP Server（将已有的连接快速断开，且不再接收新的连接），断开和 Master 的 IPC 通道，不再接受新的用户请求。</li><li>Master 立刻 fork 一个新的 Worker 进程，保证在线的『工人』总数不变。</li><li>异常 Worker 等待一段时间，处理完已经接受的请求后退出。</li></ol><pre><code class="language-bash">   +---------+                 +---------+
   |  Worker |                 |  Master |
   +---------+                 +----+----+
        | uncaughtException         |
        +------------+              |
        |            |              |                   +---------+
        | &lt;----------+              |                   |  Worker |
        |                           |                   +----+----+
        |        disconnect         |   fork a new worker    |
        +-------------------------&gt; + ---------------------&gt; |
        |         wait...           |                        |
        |          exit             |                        |
        +-------------------------&gt; |                        |
        |                           |                        |
       die                          |                        |
                                    |                        |
                                    |                        |</code></pre><h4 id="oom-系统异常">OOM、系统异常</h4><p>而当一个进程出现异常导致 crash 或者 OOM 被系统杀死时，不像未捕获异常发生时我们还有机会让进程继续执行，只能够让当前进程直接退出，Master 立刻 fork 一个新的 Worker。</p><p>在框架里，我们采用 <a href="https://github.com/node-modules/graceful">graceful</a> 和 <a href="https://github.com/eggjs/egg-cluster">egg-cluster</a> 两个模块配合实现上面的逻辑。这套方案已在阿里巴巴和蚂蚁金服的生产环境广泛部署，且经受过『双11』大促的考验，所以是相对稳定和靠谱的。</p><h3 id="agent-机制">Agent 机制</h3><p>说到这里，Node.js 多进程方案貌似已经成型，这也是我们早期线上使用的方案。但后来我们发现有些工作其实不需要每个 Worker 都去做，如果都做，一来是浪费资源，更重要的是可能会导致多进程间资源访问冲突。举个例子：生产环境的日志文件我们一般会按照日期进行归档，在单进程模型下这再简单不过了：</p><blockquote><ol><li>每天凌晨 0 点，将当前日志文件按照日期进行重命名</li><li>销毁以前的文件句柄，并创建新的日志文件继续写入</li></ol></blockquote><p>试想如果现在是 4 个进程来做同样的事情，是不是就乱套了。所以，对于这一类后台运行的逻辑，我们希望将它们放到一个单独的进程上去执行，这个进程就叫 Agent Worker，简称 Agent。Agent 好比是 Master 给其他 Worker 请的一个『秘书』，它不对外提供服务，只给 App Worker 打工，专门处理一些公共事务。现在我们的多进程模型就变成下面这个样子了</p><pre><code class="language-bash">                  +--------+          +-------+
                  | Master |&lt;--------&gt;| Agent |
                  +--------+          +-------+
                  ^   ^    ^
                 /    |     \
               /      |       \
             /        |         \
           v          v          v
  +----------+   +----------+   +----------+
  | Worker 1 |   | Worker 2 |   | Worker 3 |
  +----------+   +----------+   +----------+</code></pre><p>那我们框架的启动时序如下：</p><pre><code class="language-bash">    +---------+           +---------+          +---------+
    |  Master |           |  Agent  |          |  Worker |
    +---------+           +----+----+          +----+----+
         |      fork agent     |                    |
         +--------------------&gt;|                    |
         |      agent ready    |                    |
         |&lt;--------------------+                    |
         |                     |     fork worker    |
         +-----------------------------------------&gt;|
         |     worker ready    |                    |
         |&lt;-----------------------------------------+
         |      Egg ready      |                    |
         +--------------------&gt;|                    |
         |      Egg ready      |                    |
         +-----------------------------------------&gt;|</code></pre><ol><li>Master 启动后先 fork Agent 进程</li><li>Agent 初始化成功后，通过 IPC 通道通知 Master</li><li>Master 再 fork 多个 App Worker</li><li>App Worker 初始化成功，通知 Master</li><li>所有的进程初始化成功后，Master 通知 Agent 和 Worker 应用启动成功</li></ol><p>另外，关于 Agent Worker 还有几点需要注意的是：</p><ol><li>由于 App Worker 依赖于 Agent，所以必须等 Agent 初始化完成后才能 fork App Worker</li><li>Agent 虽然是 App Worker 的『小秘』，但是业务相关的工作不应该放到 Agent 上去做，不然把她累垮了就不好了</li><li>由于 Agent 的特殊定位，<strong>我们应该保证它相对稳定</strong>。当它发生未捕获异常，框架不会像 App Worker 一样让他退出重启，而是记录异常日志、报警等待人工处理</li><li>Agent 和普通 App Worker 挂载的 API 不完全一样，如何识别差异可查看<a href="../advanced/framework.md">框架文档</a></li></ol><h3 id="agent-的用法">Agent 的用法</h3><p>你可以在应用或插件根目录下的 <code>agent.js</code> 中实现你自己的逻辑（和<a href="../basics/app-start.md">启动自定义</a> 用法类似，只是入口参数是 agent 对象）</p><pre><code class="language-js">// agent.js
module.exports = agent =&gt; {
  // 在这里写你的初始化逻辑

  // 也可以通过 messenger 对象发送消息给 App Worker
  // 但需要等待 App Worker 启动成功后才能发送，不然很可能丢失
  agent.messenger.on(&#x27;egg-ready&#x27;, () =&gt; {
    const data = { ... };
    agent.messenger.sendToApp(&#x27;xxx_action&#x27;, data);
  });
};</code></pre><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  app.messenger.on(&#x27;xxx_action&#x27;, data =&gt; {
    // ...
  });
};</code></pre><p>这个例子中，<code>agent.js</code> 的代码会执行在 agent 进程上，<code>app.js</code> 的代码会执行在 Worker 进程上，他们通过框架封装的 <code>messenger</code> 对象进行进程间通讯（IPC），后面的章节会对框架的 IPC 做详细的讲解。</p><h3 id="master-vs-agent-vs-worker">Master VS Agent VS Worker</h3><p>当一个应用启动时，会同时启动这三类进程。</p><table><thead><tr><th>类型</th><th>进程数量</th><th>作用</th><th>稳定性</th><th>是否运行业务代码</th></tr></thead><tbody><tr><td>Master</td><td>1</td><td>进程管理，进程间消息转发</td><td>非常高</td><td>否</td></tr><tr><td>Agent</td><td>1</td><td>后台运行工作（长连接客户端）</td><td>高</td><td>少量</td></tr><tr><td>Worker</td><td>一般设置为 CPU 核数</td><td>执行业务代码</td><td>一般</td><td>是</td></tr></tbody></table><h4 id="master">Master</h4><p>在这个模型下，Master 进程承担了进程管理的工作（类似 <a href="https://github.com/Unitech/pm2">pm2</a>），不运行任何业务代码，我们只需要运行起一个 Master 进程它就会帮我们搞定所有的 Worker、Agent 进程的初始化以及重启等工作了。</p><p>Master 进程的稳定性是极高的，线上运行时我们只需要通过 <a href="https://github.com/eggjs/egg-scripts">egg-scripts</a> 后台运行通过 <code>egg.startCluster</code> 启动的 Master 进程就可以了，不再需要使用 <a href="https://github.com/Unitech/pm2">pm2</a> 等进程守护模块。</p><pre><code class="language-bash">$ egg-scripts start --daemon</code></pre><h4 id="agent">Agent</h4><p>在大部分情况下，我们在写业务代码的时候完全不用考虑 Agent 进程的存在，但是当我们遇到一些场景，只想让代码运行在一个进程上的时候，Agent 进程就到了发挥作用的时候了。</p><p>由于 Agent 只有一个，而且会负责许多维持连接的脏活累活，因此它不能轻易挂掉和重启，所以 Agent 进程在监听到未捕获异常时不会退出，但是会打印出错误日志，<strong>我们需要对日志中的未捕获异常提高警惕</strong>。</p><h4 id="worker">Worker</h4><p>Worker 进程负责处理真正的用户请求和<a href="../basics/schedule.md">定时任务</a>的处理。而 Egg 的定时任务也提供了只让一个 Worker 进程运行的能力，<strong>所以能够通过定时任务解决的问题就不要放到 Agent 上执行</strong>。</p><p>Worker 运行的是业务代码，相对会比 Agent 和 Master 进程上运行的代码复杂度更高，稳定性也低一点，<strong>当 Worker 进程异常退出时，Master 进程会重启一个 Worker 进程。</strong></p><h2 id="进程间通讯ipc">进程间通讯（IPC）</h2><p>虽然每个 Worker 进程是相对独立的，但是它们之间始终还是需要通讯的，叫进程间通讯（IPC）。下面是 Node.js 官方提供的一段示例代码</p><pre><code class="language-js">&#x27;use strict&#x27;;
const cluster = require(&#x27;cluster&#x27;);

if (cluster.isMaster) {
  const worker = cluster.fork();
  worker.send(&#x27;hi there&#x27;);
  worker.on(&#x27;message&#x27;, msg =&gt; {
    console.log(`msg: ${msg} from worker#${worker.id}`);
  });
} else if (cluster.isWorker) {
  process.on(&#x27;message&#x27;, (msg) =&gt; {
    process.send(msg);
  });
}</code></pre><p>细心的你可能已经发现 cluster 的 IPC 通道只存在于 Master 和 Worker/Agent 之间，Worker 与 Agent 进程互相间是没有的。那么 Worker 之间想通讯该怎么办呢？是的，通过 Master 来转发。</p><pre><code class="language-bash">广播消息： agent =&gt; all workers
                  +--------+          +-------+
                  | Master |&lt;---------| Agent |
                  +--------+          +-------+
                 /    |     \
                /     |      \
               /      |       \
              /       |        \
             v        v         v
  +----------+   +----------+   +----------+
  | Worker 1 |   | Worker 2 |   | Worker 3 |
  +----------+   +----------+   +----------+

指定接收方： one worker =&gt; another worker
                  +--------+          +-------+
                  | Master |----------| Agent |
                  +--------+          +-------+
                 ^    |
     send to    /     |
    worker 2   /      |
              /       |
             /        v
  +----------+   +----------+   +----------+
  | Worker 1 |   | Worker 2 |   | Worker 3 |
  +----------+   +----------+   +----------+</code></pre><p>为了方便调用，我们封装了一个 messenger 对象挂在 app / agent 实例上，提供一系列友好的 API。</p><h3 id="发送">发送</h3><ul><li><code>app.messenger.broadcast(action, data)</code>：发送给所有的 agent / app 进程（包括自己）</li><li><code>app.messenger.sendToApp(action, data)</code>: 发送给所有的 app 进程<ul><li>在 app 上调用该方法会发送给自己和其他的 app 进程</li><li>在 agent 上调用该方法会发送给所有的 app 进程</li></ul></li><li><code>app.messenger.sendToAgent(action, data)</code>: 发送给 agent 进程<ul><li>在 app 上调用该方法会发送给 agent 进程</li><li>在 agent 上调用该方法会发送给 agent 自己</li></ul></li><li><code>agent.messenger.sendRandom(action, data)</code>:<ul><li>app 上没有该方法（现在 Egg 的实现是等同于 sentToAgent）</li><li>agent 会随机发送消息给一个 app 进程（由 master 来控制发送给谁）</li></ul></li><li><code>app.messenger.sendTo(pid, action, data)</code>: 发送给指定进程</li></ul><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  // 注意，只有在 egg-ready 事件拿到之后才能发送消息
  app.messenger.once(&#x27;egg-ready&#x27;, () =&gt; {
    app.messenger.sendToAgent(&#x27;agent-event&#x27;, { foo: &#x27;bar&#x27; });
    app.messenger.sendToApp(&#x27;app-event&#x27;, { foo: &#x27;bar&#x27; });
  });
}</code></pre><p><em>上面所有 <code>app.messenger</code> 上的方法都可以在 <code>agent.messenger</code> 上使用。</em></p><h4 id="egg-ready">egg-ready</h4><p>上面的示例中提到，需要等 <code>egg-ready</code> 消息之后才能发送消息。只有在 Master 确认所有的 Agent 进程和 Worker 进程都已经成功启动（并 ready）之后，才会通过 messenger 发送 <code>egg-ready</code> 消息给所有的 Agent 和 Worker，告知一切准备就绪，IPC 通道可以开始使用了。</p><h3 id="接收">接收</h3><p>在 messenger 上监听对应的 action 事件，就可以收到其他进程发送来的信息了。</p><pre><code class="language-js">app.messenger.on(action, data =&gt; {
  // process data
});
app.messenger.once(action, data =&gt; {
  // process data
});</code></pre><p><em>agent 上的 messenger 接收消息的用法和 app 上一致。</em></p><h2 id="ipc-实战">IPC 实战</h2><p>我们通过一个简单的例子来感受一下在框架的多进程模型下如何使用 IPC 解决实际问题。</p><h3 id="需求">需求</h3><p>我们有一个接口需要从远程数据源中读取一些数据，对外部提供 API，但是这个数据源的数据很少变化，因此我们希望将数据缓存到内存中以提升服务能力，降低 RT。此时就需要有一个更新内存缓存的机制。</p><ol><li>定时从远程数据源获取数据，更新内存缓存，为了降低对数据源压力，更新的间隔时间会设置的比较长。</li><li>远程数据源提供一个检查是否有数据更新的接口，我们的服务可以更频繁的调用检查接口，当有数据更新时才去重新拉取数据。</li><li>远程数据源通过消息中间件推送数据更新的消息，我们的服务监听消息来更新数据。</li></ol><p>在实际项目中，我们可以采用方案一用于兜底，结合方案三或者方案二的一种用于提升数据更新的实时性。而在这个示例中，我们会通过 IPC + <a href="../basics/schedule.md">定时任务</a>来同时实现这三种缓存更新方案。</p><h3 id="实现">实现</h3><p>我们将所有的与远程数据源交互的逻辑封装在一个 Service 中，并提供 <code>get</code> 方法给 Controller 调用。</p><pre><code class="language-js">// app/service/source.js
let memoryCache = {};

class SourceService extends Service {
  get(key) {
    return memoryCache[key];
  }

  async checkUpdate() {
    // check if remote data source has changed
    const updated = await mockCheck();
    this.ctx.logger.info(&#x27;check update response %s&#x27;, updated);
    return updated;
  }

  async update() {
    // update memory cache from remote
    memoryCache = await mockFetch();
    this.ctx.logger.info(&#x27;update memory cache from remote: %j&#x27;, memoryCache);
  }
}</code></pre><p>编写定时任务，实现方案一，每 10 分钟定时从远程数据源获取数据更新缓存做兜底。</p><pre><code class="language-js">// app/schedule/force_refresh.js
exports.schedule = {
  interval: &#x27;10m&#x27;,
  type: &#x27;all&#x27;, // run in all workers
};

exports.task = async ctx =&gt; {
  await ctx.service.source.update();
  ctx.app.lastUpdateBy = &#x27;force&#x27;;
};</code></pre><p>再编写一个定时任务来实现方案二的检查逻辑，每 10s 让一个 worker 调用检查接口，当发现数据有变化时，通过 messenger 提供的方法通知所有的 Worker。</p><pre><code class="language-js">// app/schedule/pull_refresh.js
exports.schedule = {
  interval: &#x27;10s&#x27;,
  type: &#x27;worker&#x27;, // only run in one worker
};

exports.task = async ctx =&gt; {
  const needRefresh = await ctx.service.source.checkUpdate();
  if (!needRefresh) return;

  // notify all workers to update memory cache from `file`
  ctx.app.messenger.sendToApp(&#x27;refresh&#x27;, &#x27;pull&#x27;);
};</code></pre><p>在启动自定义文件中监听 <code>refresh</code> 事件，并更新数据，所有的 Worker 进程都能收到这个消息，并触发更新，此时我们的方案二也已经大功告成了。</p><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  app.messenger.on(&#x27;refresh&#x27;, by =&gt; {
    app.logger.info(&#x27;start update by %s&#x27;, by);
    // create an anonymous context to access service
    const ctx = app.createAnonymousContext();
    ctx.runInBackground(async () =&gt; {
      await ctx.service.source.update();
      app.lastUpdateBy = by;
    });
  });
};</code></pre><p>现在我们来看看如何实现第三个方案。我们需要有一个消息中间件的客户端，它会和服务端保持长连接，这一类的长连接维持比较适合在 Agent 进程上做，可以有效降低连接数，减少两端的消耗。所以我们在 Agent 进程上来开启消息监听。</p><pre><code class="language-js">// agent.js

const Subscriber = require(&#x27;./lib/subscriber&#x27;);

module.exports = agent =&gt; {
  const subscriber = new Subscriber();
  // listen changed event, broadcast to all workers
  subscriber.on(&#x27;changed&#x27;, () =&gt; agent.messenger.sendToApp(&#x27;refresh&#x27;, &#x27;push&#x27;));
};</code></pre><p>通过合理使用 Agent 进程、定时任务和 IPC，我们可以轻松搞定类似的需求并降低对数据源的压力。具体的示例代码可以查看 <a href="https://github.com/eggjs/examples/tree/master/ipc">examples/ipc</a>。</p><h2 id="更复杂的场景">更复杂的场景</h2><p>上面的例子中，我们在 Agent 进程上运行了一个 subscriber，来监听消息中间件的消息，如果 Worker 进程也需要监听一些消息怎么办？如何通过 Agent 进程建立连接再转发给 Worker 进程呢？这些问题可以在<a href="../advanced/cluster-client.md">多进程研发模式增强</a>中找到答案。</p></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#cluster-%E6%98%AF%E4%BB%80%E4%B9%88%E5%91%A2">Cluster 是什么呢？</a></li><li><a href="#%E6%A1%86%E6%9E%B6%E7%9A%84%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B">框架的多进程模型</a><ul><li><a href="#%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4">进程守护</a><ul><li><a href="#%E6%9C%AA%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8">未捕获异常</a></li><li><a href="#oom-%E7%B3%BB%E7%BB%9F%E5%BC%82%E5%B8%B8">OOM、系统异常</a></li></ul></li><li><a href="#agent-%E6%9C%BA%E5%88%B6">Agent 机制</a></li><li><a href="#agent-%E7%9A%84%E7%94%A8%E6%B3%95">Agent 的用法</a></li><li><a href="#master-vs-agent-vs-worker">Master VS Agent VS Worker</a><ul><li><a href="#master">Master</a></li><li><a href="#agent">Agent</a></li><li><a href="#worker">Worker</a></li></ul></li></ul></li><li><a href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AFipc">进程间通讯（IPC）</a><ul><li><a href="#%E5%8F%91%E9%80%81">发送</a><ul><li><a href="#egg-ready">egg-ready</a></li></ul></li><li><a href="#%E6%8E%A5%E6%94%B6">接收</a></li></ul></li><li><a href="#ipc-%E5%AE%9E%E6%88%98">IPC 实战</a><ul><li><a href="#%E9%9C%80%E6%B1%82">需求</a></li><li><a href="#%E5%AE%9E%E7%8E%B0">实现</a></li></ul></li><li><a href="#%E6%9B%B4%E5%A4%8D%E6%9D%82%E7%9A%84%E5%9C%BA%E6%99%AF">更复杂的场景</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5BCluster%20%E6%98%AF%E4%BB%80%E4%B9%88%E5%91%A2%EF%BC%9F%5D(%23cluster-%25E6%2598%25AF%25E4%25BB%2580%25E4%25B9%2588%25E5%2591%25A2)%0A-%20%5B%E6%A1%86%E6%9E%B6%E7%9A%84%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%5D(%23%25E6%25A1%2586%25E6%259E%25B6%25E7%259A%2584%25E5%25A4%259A%25E8%25BF%259B%25E7%25A8%258B%25E6%25A8%25A1%25E5%259E%258B)%0A%20%20*%20%5B%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4%5D(%23%25E8%25BF%259B%25E7%25A8%258B%25E5%25AE%2588%25E6%258A%25A4)%0A%20%20%20%20%2B%20%5B%E6%9C%AA%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%5D(%23%25E6%259C%25AA%25E6%258D%2595%25E8%258E%25B7%25E5%25BC%2582%25E5%25B8%25B8)%0A%20%20%20%20%2B%20%5BOOM%E3%80%81%E7%B3%BB%E7%BB%9F%E5%BC%82%E5%B8%B8%5D(%23oom-%25E7%25B3%25BB%25E7%25BB%259F%25E5%25BC%2582%25E5%25B8%25B8)%0A%20%20*%20%5BAgent%20%E6%9C%BA%E5%88%B6%5D(%23agent-%25E6%259C%25BA%25E5%2588%25B6)%0A%20%20*%20%5BAgent%20%E7%9A%84%E7%94%A8%E6%B3%95%5D(%23agent-%25E7%259A%2584%25E7%2594%25A8%25E6%25B3%2595)%0A%20%20*%20%5BMaster%20VS%20Agent%20VS%20Worker%5D(%23master-vs-agent-vs-worker)%0A%20%20%20%20%2B%20%5BMaster%5D(%23master)%0A%20%20%20%20%2B%20%5BAgent%5D(%23agent)%0A%20%20%20%20%2B%20%5BWorker%5D(%23worker)%0A-%20%5B%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AF%EF%BC%88IPC%EF%BC%89%5D(%23%25E8%25BF%259B%25E7%25A8%258B%25E9%2597%25B4%25E9%2580%259A%25E8%25AE%25AFipc)%0A%20%20*%20%5B%E5%8F%91%E9%80%81%5D(%23%25E5%258F%2591%25E9%2580%2581)%0A%20%20%20%20%2B%20%5Begg-ready%5D(%23egg-ready)%0A%20%20*%20%5B%E6%8E%A5%E6%94%B6%5D(%23%25E6%258E%25A5%25E6%2594%25B6)%0A-%20%5BIPC%20%E5%AE%9E%E6%88%98%5D(%23ipc-%25E5%25AE%259E%25E6%2588%2598)%0A%20%20*%20%5B%E9%9C%80%E6%B1%82%5D(%23%25E9%259C%2580%25E6%25B1%2582)%0A%20%20*%20%5B%E5%AE%9E%E7%8E%B0%5D(%23%25E5%25AE%259E%25E7%258E%25B0)%0A-%20%5B%E6%9B%B4%E5%A4%8D%E6%9D%82%E7%9A%84%E5%9C%BA%E6%99%AF%5D(%23%25E6%259B%25B4%25E5%25A4%258D%25E6%259D%2582%25E7%259A%2584%25E5%259C%25BA%25E6%2599%25AF)","meta":{"info":{"title":"多进程模型和进程间通讯"}},"content":"%0A%0A%0A%E6%88%91%E4%BB%AC%E7%9F%A5%E9%81%93%20JavaScript%20%E4%BB%A3%E7%A0%81%E6%98%AF%E8%BF%90%E8%A1%8C%E5%9C%A8%E5%8D%95%E7%BA%BF%E7%A8%8B%E4%B8%8A%E7%9A%84%EF%BC%8C%E6%8D%A2%E5%8F%A5%E8%AF%9D%E8%AF%B4%E4%B8%80%E4%B8%AA%20Node.js%20%E8%BF%9B%E7%A8%8B%E5%8F%AA%E8%83%BD%E8%BF%90%E8%A1%8C%E5%9C%A8%E4%B8%80%E4%B8%AA%20CPU%20%E4%B8%8A%E3%80%82%E9%82%A3%E4%B9%88%E5%A6%82%E6%9E%9C%E7%94%A8%20Node.js%20%E6%9D%A5%E5%81%9A%20Web%20Server%EF%BC%8C%E5%B0%B1%E6%97%A0%E6%B3%95%E4%BA%AB%E5%8F%97%E5%88%B0%E5%A4%9A%E6%A0%B8%E8%BF%90%E7%AE%97%E7%9A%84%E5%A5%BD%E5%A4%84%E3%80%82%E4%BD%9C%E4%B8%BA%E4%BC%81%E4%B8%9A%E7%BA%A7%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%8C%E6%88%91%E4%BB%AC%E8%A6%81%E8%A7%A3%E5%86%B3%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98%E5%B0%B1%E6%98%AF%3A%0A%0A%3E%20%E5%A6%82%E4%BD%95%E6%A6%A8%E5%B9%B2%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%B5%84%E6%BA%90%EF%BC%8C%E5%88%A9%E7%94%A8%E4%B8%8A%E5%A4%9A%E6%A0%B8%20CPU%20%E7%9A%84%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8A%BF%EF%BC%9F%0A%0A%E8%80%8C%20Node.js%20%E5%AE%98%E6%96%B9%E6%8F%90%E4%BE%9B%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%98%AF%20%5BCluster%20%E6%A8%A1%E5%9D%97%5D(https%3A%2F%2Fnodejs.org%2Fapi%2Fcluster.html)%0A%0A%3E%20A%20single%20instance%20of%20Node.js%20runs%20in%20a%20single%20thread.%20To%20take%20advantage%20of%20multi-core%20systems%20the%20user%20will%20sometimes%20want%20to%20launch%20a%20cluster%20of%20Node.js%20processes%20to%20handle%20the%20load.%0A%0A%3E%20The%20cluster%20module%20allows%20you%20to%20easily%20create%20child%20processes%20that%20all%20share%20server%20ports.%0A%0A%23%23%20Cluster%20%E6%98%AF%E4%BB%80%E4%B9%88%E5%91%A2%EF%BC%9F%0A%0A%E7%AE%80%E5%8D%95%E7%9A%84%E8%AF%B4%EF%BC%8C%0A%0A-%20%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E5%90%8C%E6%97%B6%E5%90%AF%E5%8A%A8%E5%A4%9A%E4%B8%AA%E8%BF%9B%E7%A8%8B%E3%80%82%0A-%20%E6%AF%8F%E4%B8%AA%E8%BF%9B%E7%A8%8B%E9%87%8C%E9%83%BD%E8%B7%91%E7%9A%84%E6%98%AF%E5%90%8C%E4%B8%80%E4%BB%BD%E6%BA%90%E4%BB%A3%E7%A0%81%EF%BC%88%E5%A5%BD%E6%AF%94%E6%8A%8A%E4%BB%A5%E5%89%8D%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%88%86%E7%BB%99%E5%A4%9A%E4%B8%AA%E8%BF%9B%E7%A8%8B%E5%8E%BB%E5%81%9A%EF%BC%89%E3%80%82%0A-%20%E6%9B%B4%E7%A5%9E%E5%A5%87%E7%9A%84%E6%98%AF%EF%BC%8C%E8%BF%99%E4%BA%9B%E8%BF%9B%E7%A8%8B%E5%8F%AF%E4%BB%A5%E5%90%8C%E6%97%B6%E7%9B%91%E5%90%AC%E4%B8%80%E4%B8%AA%E7%AB%AF%E5%8F%A3%EF%BC%88%E5%85%B7%E4%BD%93%E5%8E%9F%E7%90%86%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB%20%40DavidCai1993%20%E8%BF%99%E7%AF%87%20%5BCluster%20%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%5D(https%3A%2F%2Fcnodejs.org%2Ftopic%2F56e84480833b7c8a0492e20c)%EF%BC%89%E3%80%82%0A%0A%E5%85%B6%E4%B8%AD%EF%BC%9A%0A%0A-%20%E8%B4%9F%E8%B4%A3%E5%90%AF%E5%8A%A8%E5%85%B6%E4%BB%96%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%8F%AB%E5%81%9A%20Master%20%E8%BF%9B%E7%A8%8B%EF%BC%8C%E4%BB%96%E5%A5%BD%E6%AF%94%E6%98%AF%E4%B8%AA%E3%80%8E%E5%8C%85%E5%B7%A5%E5%A4%B4%E3%80%8F%EF%BC%8C%E4%B8%8D%E5%81%9A%E5%85%B7%E4%BD%93%E7%9A%84%E5%B7%A5%E4%BD%9C%EF%BC%8C%E5%8F%AA%E8%B4%9F%E8%B4%A3%E5%90%AF%E5%8A%A8%E5%85%B6%E4%BB%96%E8%BF%9B%E7%A8%8B%E3%80%82%0A-%20%E5%85%B6%E4%BB%96%E8%A2%AB%E5%90%AF%E5%8A%A8%E7%9A%84%E5%8F%AB%20Worker%20%E8%BF%9B%E7%A8%8B%EF%BC%8C%E9%A1%BE%E5%90%8D%E6%80%9D%E4%B9%89%E5%B0%B1%E6%98%AF%E5%B9%B2%E6%B4%BB%E7%9A%84%E3%80%8E%E5%B7%A5%E4%BA%BA%E3%80%8F%E3%80%82%E5%AE%83%E4%BB%AC%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%EF%BC%8C%E5%AF%B9%E5%A4%96%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%E3%80%82%0A-%20Worker%20%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%95%B0%E9%87%8F%E4%B8%80%E8%88%AC%E6%A0%B9%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%20CPU%20%E6%A0%B8%E6%95%B0%E6%9D%A5%E5%AE%9A%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%AE%8C%E7%BE%8E%E5%88%A9%E7%94%A8%E5%A4%9A%E6%A0%B8%E8%B5%84%E6%BA%90%E3%80%82%0A%0A%60%60%60js%0Aconst%20cluster%20%3D%20require('cluster')%3B%0Aconst%20http%20%3D%20require('http')%3B%0Aconst%20numCPUs%20%3D%20require('os').cpus().length%3B%0A%0Aif%20(cluster.isMaster)%20%7B%0A%20%20%2F%2F%20Fork%20workers.%0A%20%20for%20(let%20i%20%3D%200%3B%20i%20%3C%20numCPUs%3B%20i%2B%2B)%20%7B%0A%20%20%20%20cluster.fork()%3B%0A%20%20%7D%0A%0A%20%20cluster.on('exit'%2C%20function(worker%2C%20code%2C%20signal)%20%7B%0A%20%20%20%20console.log('worker%20'%20%2B%20worker.process.pid%20%2B%20'%20died')%3B%0A%20%20%7D)%3B%0A%7D%20else%20%7B%0A%20%20%2F%2F%20Workers%20can%20share%20any%20TCP%20connection%0A%20%20%2F%2F%20In%20this%20case%20it%20is%20an%20HTTP%20server%0A%20%20http.createServer(function(req%2C%20res)%20%7B%0A%20%20%20%20res.writeHead(200)%3B%0A%20%20%20%20res.end(%22hello%20world%5Cn%22)%3B%0A%20%20%7D).listen(8000)%3B%0A%7D%0A%60%60%60%0A%0A%23%23%20%E6%A1%86%E6%9E%B6%E7%9A%84%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%0A%0A%E4%B8%8A%E9%9D%A2%E7%9A%84%E7%A4%BA%E4%BE%8B%E6%98%AF%E4%B8%8D%E6%98%AF%E5%BE%88%E7%AE%80%E5%8D%95%EF%BC%8C%E4%BD%86%E6%98%AF%E4%BD%9C%E4%B8%BA%E4%BC%81%E4%B8%9A%E7%BA%A7%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%8C%E8%A6%81%E8%80%83%E8%99%91%E7%9A%84%E4%B8%9C%E8%A5%BF%E8%BF%98%E6%9C%89%E5%BE%88%E5%A4%9A%E3%80%82%0A%0A-%20Worker%20%E8%BF%9B%E7%A8%8B%E5%BC%82%E5%B8%B8%E9%80%80%E5%87%BA%E4%BB%A5%E5%90%8E%E8%AF%A5%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%EF%BC%9F%0A-%20%E5%A4%9A%E4%B8%AA%20Worker%20%E8%BF%9B%E7%A8%8B%E4%B9%8B%E9%97%B4%E5%A6%82%E4%BD%95%E5%85%B1%E4%BA%AB%E8%B5%84%E6%BA%90%EF%BC%9F%0A-%20%E5%A4%9A%E4%B8%AA%20Worker%20%E8%BF%9B%E7%A8%8B%E4%B9%8B%E9%97%B4%E5%A6%82%E4%BD%95%E8%B0%83%E5%BA%A6%EF%BC%9F%0A-%20...%0A%0A%23%23%23%20%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4%0A%0A%E5%81%A5%E5%A3%AE%E6%80%A7%EF%BC%88%E5%8F%88%E5%8F%AB%E9%B2%81%E6%A3%92%E6%80%A7%EF%BC%89%E6%98%AF%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8%E5%BF%85%E9%A1%BB%E8%80%83%E8%99%91%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E9%99%A4%E4%BA%86%E7%A8%8B%E5%BA%8F%E6%9C%AC%E8%BA%AB%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E8%A6%81%E4%BF%9D%E8%AF%81%EF%BC%8C%E6%A1%86%E6%9E%B6%E5%B1%82%E9%9D%A2%E4%B9%9F%E9%9C%80%E8%A6%81%E6%8F%90%E4%BE%9B%E7%9B%B8%E5%BA%94%E7%9A%84%E3%80%8E%E5%85%9C%E5%BA%95%E3%80%8F%E6%9C%BA%E5%88%B6%E4%BF%9D%E8%AF%81%E6%9E%81%E7%AB%AF%E6%83%85%E5%86%B5%E4%B8%8B%E5%BA%94%E7%94%A8%E7%9A%84%E5%8F%AF%E7%94%A8%E6%80%A7%E3%80%82%0A%0A%E4%B8%80%E8%88%AC%E6%9D%A5%E8%AF%B4%EF%BC%8CNode.js%20%E8%BF%9B%E7%A8%8B%E9%80%80%E5%87%BA%E5%8F%AF%E4%BB%A5%E5%88%86%E4%B8%BA%E4%B8%A4%E7%B1%BB%EF%BC%9A%0A%0A%23%23%23%23%20%E6%9C%AA%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%0A%0A%E5%BD%93%E4%BB%A3%E7%A0%81%E6%8A%9B%E5%87%BA%E4%BA%86%E5%BC%82%E5%B8%B8%E6%B2%A1%E6%9C%89%E8%A2%AB%E6%8D%95%E8%8E%B7%E5%88%B0%E6%97%B6%EF%BC%8C%E8%BF%9B%E7%A8%8B%E5%B0%86%E4%BC%9A%E9%80%80%E5%87%BA%EF%BC%8C%E6%AD%A4%E6%97%B6%20Node.js%20%E6%8F%90%E4%BE%9B%E4%BA%86%20%60process.on('uncaughtException'%2C%20handler)%60%20%E6%8E%A5%E5%8F%A3%E6%9D%A5%E6%8D%95%E8%8E%B7%E5%AE%83%EF%BC%8C%E4%BD%86%E6%98%AF%E5%BD%93%E4%B8%80%E4%B8%AA%20Worker%20%E8%BF%9B%E7%A8%8B%E9%81%87%E5%88%B0%20%5B%E6%9C%AA%E6%8D%95%E8%8E%B7%E7%9A%84%E5%BC%82%E5%B8%B8%5D(https%3A%2F%2Fnodejs.org%2Fdist%2Flatest-v6.x%2Fdocs%2Fapi%2Fprocess.html%23process_event_uncaughtexception)%20%E6%97%B6%EF%BC%8C%E5%AE%83%E5%B7%B2%E7%BB%8F%E5%A4%84%E4%BA%8E%E4%B8%80%E4%B8%AA%E4%B8%8D%E7%A1%AE%E5%AE%9A%E7%8A%B6%E6%80%81%EF%BC%8C%E6%AD%A4%E6%97%B6%E6%88%91%E4%BB%AC%E5%BA%94%E8%AF%A5%E8%AE%A9%E8%BF%99%E4%B8%AA%E8%BF%9B%E7%A8%8B%E4%BC%98%E9%9B%85%E9%80%80%E5%87%BA%EF%BC%9A%0A%0A1.%20%E5%85%B3%E9%97%AD%E5%BC%82%E5%B8%B8%20Worker%20%E8%BF%9B%E7%A8%8B%E6%89%80%E6%9C%89%E7%9A%84%20TCP%20Server%EF%BC%88%E5%B0%86%E5%B7%B2%E6%9C%89%E7%9A%84%E8%BF%9E%E6%8E%A5%E5%BF%AB%E9%80%9F%E6%96%AD%E5%BC%80%EF%BC%8C%E4%B8%94%E4%B8%8D%E5%86%8D%E6%8E%A5%E6%94%B6%E6%96%B0%E7%9A%84%E8%BF%9E%E6%8E%A5%EF%BC%89%EF%BC%8C%E6%96%AD%E5%BC%80%E5%92%8C%20Master%20%E7%9A%84%20IPC%20%E9%80%9A%E9%81%93%EF%BC%8C%E4%B8%8D%E5%86%8D%E6%8E%A5%E5%8F%97%E6%96%B0%E7%9A%84%E7%94%A8%E6%88%B7%E8%AF%B7%E6%B1%82%E3%80%82%0A2.%20Master%20%E7%AB%8B%E5%88%BB%20fork%20%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%20Worker%20%E8%BF%9B%E7%A8%8B%EF%BC%8C%E4%BF%9D%E8%AF%81%E5%9C%A8%E7%BA%BF%E7%9A%84%E3%80%8E%E5%B7%A5%E4%BA%BA%E3%80%8F%E6%80%BB%E6%95%B0%E4%B8%8D%E5%8F%98%E3%80%82%0A3.%20%E5%BC%82%E5%B8%B8%20Worker%20%E7%AD%89%E5%BE%85%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%EF%BC%8C%E5%A4%84%E7%90%86%E5%AE%8C%E5%B7%B2%E7%BB%8F%E6%8E%A5%E5%8F%97%E7%9A%84%E8%AF%B7%E6%B1%82%E5%90%8E%E9%80%80%E5%87%BA%E3%80%82%0A%0A%60%60%60bash%0A%20%20%20%2B---------%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B---------%2B%0A%20%20%20%7C%20%20Worker%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20Master%20%7C%0A%20%20%20%2B---------%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B----%2B----%2B%0A%20%20%20%20%20%20%20%20%7C%20uncaughtException%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%2B------------%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B---------%2B%0A%20%20%20%20%20%20%20%20%7C%20%3C----------%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20Worker%20%7C%0A%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B----%2B----%2B%0A%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20disconnect%20%20%20%20%20%20%20%20%20%7C%20%20%20fork%20a%20new%20worker%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%2B-------------------------%3E%20%2B%20---------------------%3E%20%7C%0A%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20wait...%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20exit%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%2B-------------------------%3E%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20die%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%60%60%60%0A%0A%23%23%23%23%20OOM%E3%80%81%E7%B3%BB%E7%BB%9F%E5%BC%82%E5%B8%B8%0A%0A%E8%80%8C%E5%BD%93%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E5%87%BA%E7%8E%B0%E5%BC%82%E5%B8%B8%E5%AF%BC%E8%87%B4%20crash%20%E6%88%96%E8%80%85%20OOM%20%E8%A2%AB%E7%B3%BB%E7%BB%9F%E6%9D%80%E6%AD%BB%E6%97%B6%EF%BC%8C%E4%B8%8D%E5%83%8F%E6%9C%AA%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%E5%8F%91%E7%94%9F%E6%97%B6%E6%88%91%E4%BB%AC%E8%BF%98%E6%9C%89%E6%9C%BA%E4%BC%9A%E8%AE%A9%E8%BF%9B%E7%A8%8B%E7%BB%A7%E7%BB%AD%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%8F%AA%E8%83%BD%E5%A4%9F%E8%AE%A9%E5%BD%93%E5%89%8D%E8%BF%9B%E7%A8%8B%E7%9B%B4%E6%8E%A5%E9%80%80%E5%87%BA%EF%BC%8CMaster%20%E7%AB%8B%E5%88%BB%20fork%20%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%20Worker%E3%80%82%0A%0A%E5%9C%A8%E6%A1%86%E6%9E%B6%E9%87%8C%EF%BC%8C%E6%88%91%E4%BB%AC%E9%87%87%E7%94%A8%20%5Bgraceful%5D%20%E5%92%8C%20%5Begg-cluster%5D%20%E4%B8%A4%E4%B8%AA%E6%A8%A1%E5%9D%97%E9%85%8D%E5%90%88%E5%AE%9E%E7%8E%B0%E4%B8%8A%E9%9D%A2%E7%9A%84%E9%80%BB%E8%BE%91%E3%80%82%E8%BF%99%E5%A5%97%E6%96%B9%E6%A1%88%E5%B7%B2%E5%9C%A8%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4%E5%92%8C%E8%9A%82%E8%9A%81%E9%87%91%E6%9C%8D%E7%9A%84%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%B9%BF%E6%B3%9B%E9%83%A8%E7%BD%B2%EF%BC%8C%E4%B8%94%E7%BB%8F%E5%8F%97%E8%BF%87%E3%80%8E%E5%8F%8C11%E3%80%8F%E5%A4%A7%E4%BF%83%E7%9A%84%E8%80%83%E9%AA%8C%EF%BC%8C%E6%89%80%E4%BB%A5%E6%98%AF%E7%9B%B8%E5%AF%B9%E7%A8%B3%E5%AE%9A%E5%92%8C%E9%9D%A0%E8%B0%B1%E7%9A%84%E3%80%82%0A%0A%23%23%23%20Agent%20%E6%9C%BA%E5%88%B6%0A%0A%E8%AF%B4%E5%88%B0%E8%BF%99%E9%87%8C%EF%BC%8CNode.js%20%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%96%B9%E6%A1%88%E8%B2%8C%E4%BC%BC%E5%B7%B2%E7%BB%8F%E6%88%90%E5%9E%8B%EF%BC%8C%E8%BF%99%E4%B9%9F%E6%98%AF%E6%88%91%E4%BB%AC%E6%97%A9%E6%9C%9F%E7%BA%BF%E4%B8%8A%E4%BD%BF%E7%94%A8%E7%9A%84%E6%96%B9%E6%A1%88%E3%80%82%E4%BD%86%E5%90%8E%E6%9D%A5%E6%88%91%E4%BB%AC%E5%8F%91%E7%8E%B0%E6%9C%89%E4%BA%9B%E5%B7%A5%E4%BD%9C%E5%85%B6%E5%AE%9E%E4%B8%8D%E9%9C%80%E8%A6%81%E6%AF%8F%E4%B8%AA%20Worker%20%E9%83%BD%E5%8E%BB%E5%81%9A%EF%BC%8C%E5%A6%82%E6%9E%9C%E9%83%BD%E5%81%9A%EF%BC%8C%E4%B8%80%E6%9D%A5%E6%98%AF%E6%B5%AA%E8%B4%B9%E8%B5%84%E6%BA%90%EF%BC%8C%E6%9B%B4%E9%87%8D%E8%A6%81%E7%9A%84%E6%98%AF%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%AF%BC%E8%87%B4%E5%A4%9A%E8%BF%9B%E7%A8%8B%E9%97%B4%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE%E5%86%B2%E7%AA%81%E3%80%82%E4%B8%BE%E4%B8%AA%E4%BE%8B%E5%AD%90%EF%BC%9A%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E6%88%91%E4%BB%AC%E4%B8%80%E8%88%AC%E4%BC%9A%E6%8C%89%E7%85%A7%E6%97%A5%E6%9C%9F%E8%BF%9B%E8%A1%8C%E5%BD%92%E6%A1%A3%EF%BC%8C%E5%9C%A8%E5%8D%95%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%B8%8B%E8%BF%99%E5%86%8D%E7%AE%80%E5%8D%95%E4%B8%8D%E8%BF%87%E4%BA%86%EF%BC%9A%0A%0A%3E%201.%20%E6%AF%8F%E5%A4%A9%E5%87%8C%E6%99%A8%200%20%E7%82%B9%EF%BC%8C%E5%B0%86%E5%BD%93%E5%89%8D%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E6%8C%89%E7%85%A7%E6%97%A5%E6%9C%9F%E8%BF%9B%E8%A1%8C%E9%87%8D%E5%91%BD%E5%90%8D%0A%3E%202.%20%E9%94%80%E6%AF%81%E4%BB%A5%E5%89%8D%E7%9A%84%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84%EF%BC%8C%E5%B9%B6%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E7%BB%A7%E7%BB%AD%E5%86%99%E5%85%A5%0A%0A%E8%AF%95%E6%83%B3%E5%A6%82%E6%9E%9C%E7%8E%B0%E5%9C%A8%E6%98%AF%204%20%E4%B8%AA%E8%BF%9B%E7%A8%8B%E6%9D%A5%E5%81%9A%E5%90%8C%E6%A0%B7%E7%9A%84%E4%BA%8B%E6%83%85%EF%BC%8C%E6%98%AF%E4%B8%8D%E6%98%AF%E5%B0%B1%E4%B9%B1%E5%A5%97%E4%BA%86%E3%80%82%E6%89%80%E4%BB%A5%EF%BC%8C%E5%AF%B9%E4%BA%8E%E8%BF%99%E4%B8%80%E7%B1%BB%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B8%8C%E6%9C%9B%E5%B0%86%E5%AE%83%E4%BB%AC%E6%94%BE%E5%88%B0%E4%B8%80%E4%B8%AA%E5%8D%95%E7%8B%AC%E7%9A%84%E8%BF%9B%E7%A8%8B%E4%B8%8A%E5%8E%BB%E6%89%A7%E8%A1%8C%EF%BC%8C%E8%BF%99%E4%B8%AA%E8%BF%9B%E7%A8%8B%E5%B0%B1%E5%8F%AB%20Agent%20Worker%EF%BC%8C%E7%AE%80%E7%A7%B0%20Agent%E3%80%82Agent%20%E5%A5%BD%E6%AF%94%E6%98%AF%20Master%20%E7%BB%99%E5%85%B6%E4%BB%96%20Worker%20%E8%AF%B7%E7%9A%84%E4%B8%80%E4%B8%AA%E3%80%8E%E7%A7%98%E4%B9%A6%E3%80%8F%EF%BC%8C%E5%AE%83%E4%B8%8D%E5%AF%B9%E5%A4%96%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%8F%AA%E7%BB%99%20App%20Worker%20%E6%89%93%E5%B7%A5%EF%BC%8C%E4%B8%93%E9%97%A8%E5%A4%84%E7%90%86%E4%B8%80%E4%BA%9B%E5%85%AC%E5%85%B1%E4%BA%8B%E5%8A%A1%E3%80%82%E7%8E%B0%E5%9C%A8%E6%88%91%E4%BB%AC%E7%9A%84%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%B0%B1%E5%8F%98%E6%88%90%E4%B8%8B%E9%9D%A2%E8%BF%99%E4%B8%AA%E6%A0%B7%E5%AD%90%E4%BA%86%0A%0A%60%60%60bash%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B--------%2B%20%20%20%20%20%20%20%20%20%20%2B-------%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20Master%20%7C%3C--------%3E%7C%20Agent%20%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B--------%2B%20%20%20%20%20%20%20%20%20%20%2B-------%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5E%20%20%20%5E%20%20%20%20%5E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20%20%20%20%7C%20%20%20%20%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20%20v%0A%20%20%2B----------%2B%20%20%20%2B----------%2B%20%20%20%2B----------%2B%0A%20%20%7C%20Worker%201%20%7C%20%20%20%7C%20Worker%202%20%7C%20%20%20%7C%20Worker%203%20%7C%0A%20%20%2B----------%2B%20%20%20%2B----------%2B%20%20%20%2B----------%2B%0A%60%60%60%0A%0A%E9%82%A3%E6%88%91%E4%BB%AC%E6%A1%86%E6%9E%B6%E7%9A%84%E5%90%AF%E5%8A%A8%E6%97%B6%E5%BA%8F%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%0A%60%60%60bash%0A%20%20%20%20%2B---------%2B%20%20%20%20%20%20%20%20%20%20%20%2B---------%2B%20%20%20%20%20%20%20%20%20%20%2B---------%2B%0A%20%20%20%20%7C%20%20Master%20%7C%20%20%20%20%20%20%20%20%20%20%20%7C%20%20Agent%20%20%7C%20%20%20%20%20%20%20%20%20%20%7C%20%20Worker%20%7C%0A%20%20%20%20%2B---------%2B%20%20%20%20%20%20%20%20%20%20%20%2B----%2B----%2B%20%20%20%20%20%20%20%20%20%20%2B----%2B----%2B%0A%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20fork%20agent%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%2B--------------------%3E%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20agent%20ready%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%7C%3C--------------------%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20fork%20worker%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%2B-----------------------------------------%3E%7C%0A%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20worker%20ready%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%7C%3C-----------------------------------------%2B%0A%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20Egg%20ready%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%2B--------------------%3E%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20Egg%20ready%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%2B-----------------------------------------%3E%7C%0A%60%60%60%0A%0A1.%20Master%20%E5%90%AF%E5%8A%A8%E5%90%8E%E5%85%88%20fork%20Agent%20%E8%BF%9B%E7%A8%8B%0A2.%20Agent%20%E5%88%9D%E5%A7%8B%E5%8C%96%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8C%E9%80%9A%E8%BF%87%20IPC%20%E9%80%9A%E9%81%93%E9%80%9A%E7%9F%A5%20Master%0A3.%20Master%20%E5%86%8D%20fork%20%E5%A4%9A%E4%B8%AA%20App%20Worker%0A4.%20App%20Worker%20%E5%88%9D%E5%A7%8B%E5%8C%96%E6%88%90%E5%8A%9F%EF%BC%8C%E9%80%9A%E7%9F%A5%20Master%0A5.%20%E6%89%80%E6%9C%89%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%88%9D%E5%A7%8B%E5%8C%96%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8CMaster%20%E9%80%9A%E7%9F%A5%20Agent%20%E5%92%8C%20Worker%20%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F%0A%0A%E5%8F%A6%E5%A4%96%EF%BC%8C%E5%85%B3%E4%BA%8E%20Agent%20Worker%20%E8%BF%98%E6%9C%89%E5%87%A0%E7%82%B9%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%EF%BC%9A%0A%0A1.%20%E7%94%B1%E4%BA%8E%20App%20Worker%20%E4%BE%9D%E8%B5%96%E4%BA%8E%20Agent%EF%BC%8C%E6%89%80%E4%BB%A5%E5%BF%85%E9%A1%BB%E7%AD%89%20Agent%20%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%8C%E6%88%90%E5%90%8E%E6%89%8D%E8%83%BD%20fork%20App%20Worker%0A2.%20Agent%20%E8%99%BD%E7%84%B6%E6%98%AF%20App%20Worker%20%E7%9A%84%E3%80%8E%E5%B0%8F%E7%A7%98%E3%80%8F%EF%BC%8C%E4%BD%86%E6%98%AF%E4%B8%9A%E5%8A%A1%E7%9B%B8%E5%85%B3%E7%9A%84%E5%B7%A5%E4%BD%9C%E4%B8%8D%E5%BA%94%E8%AF%A5%E6%94%BE%E5%88%B0%20Agent%20%E4%B8%8A%E5%8E%BB%E5%81%9A%EF%BC%8C%E4%B8%8D%E7%84%B6%E6%8A%8A%E5%A5%B9%E7%B4%AF%E5%9E%AE%E4%BA%86%E5%B0%B1%E4%B8%8D%E5%A5%BD%E4%BA%86%0A3.%20%E7%94%B1%E4%BA%8E%20Agent%20%E7%9A%84%E7%89%B9%E6%AE%8A%E5%AE%9A%E4%BD%8D%EF%BC%8C**%E6%88%91%E4%BB%AC%E5%BA%94%E8%AF%A5%E4%BF%9D%E8%AF%81%E5%AE%83%E7%9B%B8%E5%AF%B9%E7%A8%B3%E5%AE%9A**%E3%80%82%E5%BD%93%E5%AE%83%E5%8F%91%E7%94%9F%E6%9C%AA%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%EF%BC%8C%E6%A1%86%E6%9E%B6%E4%B8%8D%E4%BC%9A%E5%83%8F%20App%20Worker%20%E4%B8%80%E6%A0%B7%E8%AE%A9%E4%BB%96%E9%80%80%E5%87%BA%E9%87%8D%E5%90%AF%EF%BC%8C%E8%80%8C%E6%98%AF%E8%AE%B0%E5%BD%95%E5%BC%82%E5%B8%B8%E6%97%A5%E5%BF%97%E3%80%81%E6%8A%A5%E8%AD%A6%E7%AD%89%E5%BE%85%E4%BA%BA%E5%B7%A5%E5%A4%84%E7%90%86%0A4.%20Agent%20%E5%92%8C%E6%99%AE%E9%80%9A%20App%20Worker%20%E6%8C%82%E8%BD%BD%E7%9A%84%20API%20%E4%B8%8D%E5%AE%8C%E5%85%A8%E4%B8%80%E6%A0%B7%EF%BC%8C%E5%A6%82%E4%BD%95%E8%AF%86%E5%88%AB%E5%B7%AE%E5%BC%82%E5%8F%AF%E6%9F%A5%E7%9C%8B%5B%E6%A1%86%E6%9E%B6%E6%96%87%E6%A1%A3%5D(..%2Fadvanced%2Fframework.md)%0A%0A%23%23%23%20Agent%20%E7%9A%84%E7%94%A8%E6%B3%95%0A%0A%E4%BD%A0%E5%8F%AF%E4%BB%A5%E5%9C%A8%E5%BA%94%E7%94%A8%E6%88%96%E6%8F%92%E4%BB%B6%E6%A0%B9%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84%20%60agent.js%60%20%E4%B8%AD%E5%AE%9E%E7%8E%B0%E4%BD%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%88%E5%92%8C%5B%E5%90%AF%E5%8A%A8%E8%87%AA%E5%AE%9A%E4%B9%89%5D(..%2Fbasics%2Fapp-start.md)%20%E7%94%A8%E6%B3%95%E7%B1%BB%E4%BC%BC%EF%BC%8C%E5%8F%AA%E6%98%AF%E5%85%A5%E5%8F%A3%E5%8F%82%E6%95%B0%E6%98%AF%20agent%20%E5%AF%B9%E8%B1%A1%EF%BC%89%0A%0A%60%60%60js%0A%2F%2F%20agent.js%0Amodule.exports%20%3D%20agent%20%3D%3E%20%7B%0A%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E5%86%99%E4%BD%A0%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E9%80%BB%E8%BE%91%0A%0A%20%20%2F%2F%20%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20messenger%20%E5%AF%B9%E8%B1%A1%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E7%BB%99%20App%20Worker%0A%20%20%2F%2F%20%E4%BD%86%E9%9C%80%E8%A6%81%E7%AD%89%E5%BE%85%20App%20Worker%20%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F%E5%90%8E%E6%89%8D%E8%83%BD%E5%8F%91%E9%80%81%EF%BC%8C%E4%B8%8D%E7%84%B6%E5%BE%88%E5%8F%AF%E8%83%BD%E4%B8%A2%E5%A4%B1%0A%20%20agent.messenger.on('egg-ready'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20data%20%3D%20%7B%20...%20%7D%3B%0A%20%20%20%20agent.messenger.sendToApp('xxx_action'%2C%20data)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.messenger.on('xxx_action'%2C%20data%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20...%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%E8%BF%99%E4%B8%AA%E4%BE%8B%E5%AD%90%E4%B8%AD%EF%BC%8C%60agent.js%60%20%E7%9A%84%E4%BB%A3%E7%A0%81%E4%BC%9A%E6%89%A7%E8%A1%8C%E5%9C%A8%20agent%20%E8%BF%9B%E7%A8%8B%E4%B8%8A%EF%BC%8C%60app.js%60%20%E7%9A%84%E4%BB%A3%E7%A0%81%E4%BC%9A%E6%89%A7%E8%A1%8C%E5%9C%A8%20Worker%20%E8%BF%9B%E7%A8%8B%E4%B8%8A%EF%BC%8C%E4%BB%96%E4%BB%AC%E9%80%9A%E8%BF%87%E6%A1%86%E6%9E%B6%E5%B0%81%E8%A3%85%E7%9A%84%20%60messenger%60%20%E5%AF%B9%E8%B1%A1%E8%BF%9B%E8%A1%8C%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AF%EF%BC%88IPC%EF%BC%89%EF%BC%8C%E5%90%8E%E9%9D%A2%E7%9A%84%E7%AB%A0%E8%8A%82%E4%BC%9A%E5%AF%B9%E6%A1%86%E6%9E%B6%E7%9A%84%20IPC%20%E5%81%9A%E8%AF%A6%E7%BB%86%E7%9A%84%E8%AE%B2%E8%A7%A3%E3%80%82%0A%0A%23%23%23%20Master%20VS%20Agent%20VS%20Worker%0A%0A%E5%BD%93%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%97%B6%EF%BC%8C%E4%BC%9A%E5%90%8C%E6%97%B6%E5%90%AF%E5%8A%A8%E8%BF%99%E4%B8%89%E7%B1%BB%E8%BF%9B%E7%A8%8B%E3%80%82%0A%0A%7C%20%E7%B1%BB%E5%9E%8B%20%7C%20%E8%BF%9B%E7%A8%8B%E6%95%B0%E9%87%8F%20%7C%20%E4%BD%9C%E7%94%A8%20%7C%20%E7%A8%B3%E5%AE%9A%E6%80%A7%20%7C%20%E6%98%AF%E5%90%A6%E8%BF%90%E8%A1%8C%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%0A%7C------%7C--------%7C-----%7C-------%7C--------------%0A%7C%20Master%20%7C%201%20%7C%20%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%EF%BC%8C%E8%BF%9B%E7%A8%8B%E9%97%B4%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91%20%7C%20%E9%9D%9E%E5%B8%B8%E9%AB%98%20%7C%20%E5%90%A6%0A%7C%20Agent%20%7C%201%20%7C%20%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%E5%B7%A5%E4%BD%9C%EF%BC%88%E9%95%BF%E8%BF%9E%E6%8E%A5%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%89%7C%E9%AB%98%20%7C%20%E5%B0%91%E9%87%8F%0A%7C%20Worker%20%7C%20%E4%B8%80%E8%88%AC%E8%AE%BE%E7%BD%AE%E4%B8%BA%20CPU%20%E6%A0%B8%E6%95%B0%20%7C%20%E6%89%A7%E8%A1%8C%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%20%7C%20%E4%B8%80%E8%88%AC%20%7C%20%E6%98%AF%0A%0A%23%23%23%23%20Master%0A%0A%E5%9C%A8%E8%BF%99%E4%B8%AA%E6%A8%A1%E5%9E%8B%E4%B8%8B%EF%BC%8CMaster%20%E8%BF%9B%E7%A8%8B%E6%89%BF%E6%8B%85%E4%BA%86%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E7%9A%84%E5%B7%A5%E4%BD%9C%EF%BC%88%E7%B1%BB%E4%BC%BC%20%5Bpm2%5D%EF%BC%89%EF%BC%8C%E4%B8%8D%E8%BF%90%E8%A1%8C%E4%BB%BB%E4%BD%95%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AA%E9%9C%80%E8%A6%81%E8%BF%90%E8%A1%8C%E8%B5%B7%E4%B8%80%E4%B8%AA%20Master%20%E8%BF%9B%E7%A8%8B%E5%AE%83%E5%B0%B1%E4%BC%9A%E5%B8%AE%E6%88%91%E4%BB%AC%E6%90%9E%E5%AE%9A%E6%89%80%E6%9C%89%E7%9A%84%20Worker%E3%80%81Agent%20%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BB%A5%E5%8F%8A%E9%87%8D%E5%90%AF%E7%AD%89%E5%B7%A5%E4%BD%9C%E4%BA%86%E3%80%82%0A%0AMaster%20%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%A8%B3%E5%AE%9A%E6%80%A7%E6%98%AF%E6%9E%81%E9%AB%98%E7%9A%84%EF%BC%8C%E7%BA%BF%E4%B8%8A%E8%BF%90%E8%A1%8C%E6%97%B6%E6%88%91%E4%BB%AC%E5%8F%AA%E9%9C%80%E8%A6%81%E9%80%9A%E8%BF%87%20%5Begg-scripts%5D%20%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%E9%80%9A%E8%BF%87%20%60egg.startCluster%60%20%E5%90%AF%E5%8A%A8%E7%9A%84%20Master%20%E8%BF%9B%E7%A8%8B%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BA%86%EF%BC%8C%E4%B8%8D%E5%86%8D%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%20%5Bpm2%5D%20%E7%AD%89%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4%E6%A8%A1%E5%9D%97%E3%80%82%0A%0A%60%60%60bash%0A%24%20egg-scripts%20start%20--daemon%0A%60%60%60%0A%0A%23%23%23%23%20Agent%0A%0A%E5%9C%A8%E5%A4%A7%E9%83%A8%E5%88%86%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E6%88%91%E4%BB%AC%E5%9C%A8%E5%86%99%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E7%9A%84%E6%97%B6%E5%80%99%E5%AE%8C%E5%85%A8%E4%B8%8D%E7%94%A8%E8%80%83%E8%99%91%20Agent%20%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%AD%98%E5%9C%A8%EF%BC%8C%E4%BD%86%E6%98%AF%E5%BD%93%E6%88%91%E4%BB%AC%E9%81%87%E5%88%B0%E4%B8%80%E4%BA%9B%E5%9C%BA%E6%99%AF%EF%BC%8C%E5%8F%AA%E6%83%B3%E8%AE%A9%E4%BB%A3%E7%A0%81%E8%BF%90%E8%A1%8C%E5%9C%A8%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B%E4%B8%8A%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8CAgent%20%E8%BF%9B%E7%A8%8B%E5%B0%B1%E5%88%B0%E4%BA%86%E5%8F%91%E6%8C%A5%E4%BD%9C%E7%94%A8%E7%9A%84%E6%97%B6%E5%80%99%E4%BA%86%E3%80%82%0A%0A%E7%94%B1%E4%BA%8E%20Agent%20%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%EF%BC%8C%E8%80%8C%E4%B8%94%E4%BC%9A%E8%B4%9F%E8%B4%A3%E8%AE%B8%E5%A4%9A%E7%BB%B4%E6%8C%81%E8%BF%9E%E6%8E%A5%E7%9A%84%E8%84%8F%E6%B4%BB%E7%B4%AF%E6%B4%BB%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%AE%83%E4%B8%8D%E8%83%BD%E8%BD%BB%E6%98%93%E6%8C%82%E6%8E%89%E5%92%8C%E9%87%8D%E5%90%AF%EF%BC%8C%E6%89%80%E4%BB%A5%20Agent%20%E8%BF%9B%E7%A8%8B%E5%9C%A8%E7%9B%91%E5%90%AC%E5%88%B0%E6%9C%AA%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%E6%97%B6%E4%B8%8D%E4%BC%9A%E9%80%80%E5%87%BA%EF%BC%8C%E4%BD%86%E6%98%AF%E4%BC%9A%E6%89%93%E5%8D%B0%E5%87%BA%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%EF%BC%8C**%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%AF%B9%E6%97%A5%E5%BF%97%E4%B8%AD%E7%9A%84%E6%9C%AA%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%E6%8F%90%E9%AB%98%E8%AD%A6%E6%83%95**%E3%80%82%0A%0A%23%23%23%23%20Worker%0A%0AWorker%20%E8%BF%9B%E7%A8%8B%E8%B4%9F%E8%B4%A3%E5%A4%84%E7%90%86%E7%9C%9F%E6%AD%A3%E7%9A%84%E7%94%A8%E6%88%B7%E8%AF%B7%E6%B1%82%E5%92%8C%5B%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%5D(..%2Fbasics%2Fschedule.md)%E7%9A%84%E5%A4%84%E7%90%86%E3%80%82%E8%80%8C%20Egg%20%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E4%B9%9F%E6%8F%90%E4%BE%9B%E4%BA%86%E5%8F%AA%E8%AE%A9%E4%B8%80%E4%B8%AA%20Worker%20%E8%BF%9B%E7%A8%8B%E8%BF%90%E8%A1%8C%E7%9A%84%E8%83%BD%E5%8A%9B%EF%BC%8C**%E6%89%80%E4%BB%A5%E8%83%BD%E5%A4%9F%E9%80%9A%E8%BF%87%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98%E5%B0%B1%E4%B8%8D%E8%A6%81%E6%94%BE%E5%88%B0%20Agent%20%E4%B8%8A%E6%89%A7%E8%A1%8C**%E3%80%82%0A%0AWorker%20%E8%BF%90%E8%A1%8C%E7%9A%84%E6%98%AF%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%EF%BC%8C%E7%9B%B8%E5%AF%B9%E4%BC%9A%E6%AF%94%20Agent%20%E5%92%8C%20Master%20%E8%BF%9B%E7%A8%8B%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%9A%84%E4%BB%A3%E7%A0%81%E5%A4%8D%E6%9D%82%E5%BA%A6%E6%9B%B4%E9%AB%98%EF%BC%8C%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%B9%9F%E4%BD%8E%E4%B8%80%E7%82%B9%EF%BC%8C**%E5%BD%93%20Worker%20%E8%BF%9B%E7%A8%8B%E5%BC%82%E5%B8%B8%E9%80%80%E5%87%BA%E6%97%B6%EF%BC%8CMaster%20%E8%BF%9B%E7%A8%8B%E4%BC%9A%E9%87%8D%E5%90%AF%E4%B8%80%E4%B8%AA%20Worker%20%E8%BF%9B%E7%A8%8B%E3%80%82**%0A%0A%23%23%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AF%EF%BC%88IPC%EF%BC%89%0A%0A%E8%99%BD%E7%84%B6%E6%AF%8F%E4%B8%AA%20Worker%20%E8%BF%9B%E7%A8%8B%E6%98%AF%E7%9B%B8%E5%AF%B9%E7%8B%AC%E7%AB%8B%E7%9A%84%EF%BC%8C%E4%BD%86%E6%98%AF%E5%AE%83%E4%BB%AC%E4%B9%8B%E9%97%B4%E5%A7%8B%E7%BB%88%E8%BF%98%E6%98%AF%E9%9C%80%E8%A6%81%E9%80%9A%E8%AE%AF%E7%9A%84%EF%BC%8C%E5%8F%AB%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AF%EF%BC%88IPC%EF%BC%89%E3%80%82%E4%B8%8B%E9%9D%A2%E6%98%AF%20Node.js%20%E5%AE%98%E6%96%B9%E6%8F%90%E4%BE%9B%E7%9A%84%E4%B8%80%E6%AE%B5%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%0A%0A%60%60%60js%0A'use%20strict'%3B%0Aconst%20cluster%20%3D%20require('cluster')%3B%0A%0Aif%20(cluster.isMaster)%20%7B%0A%20%20const%20worker%20%3D%20cluster.fork()%3B%0A%20%20worker.send('hi%20there')%3B%0A%20%20worker.on('message'%2C%20msg%20%3D%3E%20%7B%0A%20%20%20%20console.log(%60msg%3A%20%24%7Bmsg%7D%20from%20worker%23%24%7Bworker.id%7D%60)%3B%0A%20%20%7D)%3B%0A%7D%20else%20if%20(cluster.isWorker)%20%7B%0A%20%20process.on('message'%2C%20(msg)%20%3D%3E%20%7B%0A%20%20%20%20process.send(msg)%3B%0A%20%20%7D)%3B%0A%7D%0A%60%60%60%0A%0A%E7%BB%86%E5%BF%83%E7%9A%84%E4%BD%A0%E5%8F%AF%E8%83%BD%E5%B7%B2%E7%BB%8F%E5%8F%91%E7%8E%B0%20cluster%20%E7%9A%84%20IPC%20%E9%80%9A%E9%81%93%E5%8F%AA%E5%AD%98%E5%9C%A8%E4%BA%8E%20Master%20%E5%92%8C%20Worker%2FAgent%20%E4%B9%8B%E9%97%B4%EF%BC%8CWorker%20%E4%B8%8E%20Agent%20%E8%BF%9B%E7%A8%8B%E4%BA%92%E7%9B%B8%E9%97%B4%E6%98%AF%E6%B2%A1%E6%9C%89%E7%9A%84%E3%80%82%E9%82%A3%E4%B9%88%20Worker%20%E4%B9%8B%E9%97%B4%E6%83%B3%E9%80%9A%E8%AE%AF%E8%AF%A5%E6%80%8E%E4%B9%88%E5%8A%9E%E5%91%A2%EF%BC%9F%E6%98%AF%E7%9A%84%EF%BC%8C%E9%80%9A%E8%BF%87%20Master%20%E6%9D%A5%E8%BD%AC%E5%8F%91%E3%80%82%0A%0A%60%60%60bash%0A%E5%B9%BF%E6%92%AD%E6%B6%88%E6%81%AF%EF%BC%9A%20agent%20%3D%3E%20all%20workers%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B--------%2B%20%20%20%20%20%20%20%20%20%20%2B-------%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20Master%20%7C%3C---------%7C%20Agent%20%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B--------%2B%20%20%20%20%20%20%20%20%20%20%2B-------%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20%20%20%20%7C%20%20%20%20%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20%20%20%20%20%7C%20%20%20%20%20%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20v%20%20%20%20%20%20%20%20%20v%0A%20%20%2B----------%2B%20%20%20%2B----------%2B%20%20%20%2B----------%2B%0A%20%20%7C%20Worker%201%20%7C%20%20%20%7C%20Worker%202%20%7C%20%20%20%7C%20Worker%203%20%7C%0A%20%20%2B----------%2B%20%20%20%2B----------%2B%20%20%20%2B----------%2B%0A%0A%E6%8C%87%E5%AE%9A%E6%8E%A5%E6%94%B6%E6%96%B9%EF%BC%9A%20one%20worker%20%3D%3E%20another%20worker%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B--------%2B%20%20%20%20%20%20%20%20%20%20%2B-------%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20Master%20%7C----------%7C%20Agent%20%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B--------%2B%20%20%20%20%20%20%20%20%20%20%2B-------%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5E%20%20%20%20%7C%0A%20%20%20%20%20send%20to%20%20%20%20%2F%20%20%20%20%20%7C%0A%20%20%20%20worker%202%20%20%20%2F%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20%20%20%20%20%20%20%20v%0A%20%20%2B----------%2B%20%20%20%2B----------%2B%20%20%20%2B----------%2B%0A%20%20%7C%20Worker%201%20%7C%20%20%20%7C%20Worker%202%20%7C%20%20%20%7C%20Worker%203%20%7C%0A%20%20%2B----------%2B%20%20%20%2B----------%2B%20%20%20%2B----------%2B%0A%60%60%60%0A%0A%E4%B8%BA%E4%BA%86%E6%96%B9%E4%BE%BF%E8%B0%83%E7%94%A8%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B0%81%E8%A3%85%E4%BA%86%E4%B8%80%E4%B8%AA%20messenger%20%E5%AF%B9%E8%B1%A1%E6%8C%82%E5%9C%A8%20app%20%2F%20agent%20%E5%AE%9E%E4%BE%8B%E4%B8%8A%EF%BC%8C%E6%8F%90%E4%BE%9B%E4%B8%80%E7%B3%BB%E5%88%97%E5%8F%8B%E5%A5%BD%E7%9A%84%20API%E3%80%82%0A%0A%23%23%23%20%E5%8F%91%E9%80%81%0A%0A-%20%60app.messenger.broadcast(action%2C%20data)%60%EF%BC%9A%E5%8F%91%E9%80%81%E7%BB%99%E6%89%80%E6%9C%89%E7%9A%84%20agent%20%2F%20app%20%E8%BF%9B%E7%A8%8B%EF%BC%88%E5%8C%85%E6%8B%AC%E8%87%AA%E5%B7%B1%EF%BC%89%0A-%20%60app.messenger.sendToApp(action%2C%20data)%60%3A%20%E5%8F%91%E9%80%81%E7%BB%99%E6%89%80%E6%9C%89%E7%9A%84%20app%20%E8%BF%9B%E7%A8%8B%0A%20%20%20-%20%E5%9C%A8%20app%20%E4%B8%8A%E8%B0%83%E7%94%A8%E8%AF%A5%E6%96%B9%E6%B3%95%E4%BC%9A%E5%8F%91%E9%80%81%E7%BB%99%E8%87%AA%E5%B7%B1%E5%92%8C%E5%85%B6%E4%BB%96%E7%9A%84%20app%20%E8%BF%9B%E7%A8%8B%0A%20%20%20-%20%E5%9C%A8%20agent%20%E4%B8%8A%E8%B0%83%E7%94%A8%E8%AF%A5%E6%96%B9%E6%B3%95%E4%BC%9A%E5%8F%91%E9%80%81%E7%BB%99%E6%89%80%E6%9C%89%E7%9A%84%20app%20%E8%BF%9B%E7%A8%8B%0A-%20%60app.messenger.sendToAgent(action%2C%20data)%60%3A%20%E5%8F%91%E9%80%81%E7%BB%99%20agent%20%E8%BF%9B%E7%A8%8B%0A%20%20%20-%20%E5%9C%A8%20app%20%E4%B8%8A%E8%B0%83%E7%94%A8%E8%AF%A5%E6%96%B9%E6%B3%95%E4%BC%9A%E5%8F%91%E9%80%81%E7%BB%99%20agent%20%E8%BF%9B%E7%A8%8B%0A%20%20%20-%20%E5%9C%A8%20agent%20%E4%B8%8A%E8%B0%83%E7%94%A8%E8%AF%A5%E6%96%B9%E6%B3%95%E4%BC%9A%E5%8F%91%E9%80%81%E7%BB%99%20agent%20%E8%87%AA%E5%B7%B1%0A-%20%60agent.messenger.sendRandom(action%2C%20data)%60%3A%0A%20%20%20-%20app%20%E4%B8%8A%E6%B2%A1%E6%9C%89%E8%AF%A5%E6%96%B9%E6%B3%95%EF%BC%88%E7%8E%B0%E5%9C%A8%20Egg%20%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%98%AF%E7%AD%89%E5%90%8C%E4%BA%8E%20sentToAgent%EF%BC%89%0A%20%20%20-%20agent%20%E4%BC%9A%E9%9A%8F%E6%9C%BA%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E7%BB%99%E4%B8%80%E4%B8%AA%20app%20%E8%BF%9B%E7%A8%8B%EF%BC%88%E7%94%B1%20master%20%E6%9D%A5%E6%8E%A7%E5%88%B6%E5%8F%91%E9%80%81%E7%BB%99%E8%B0%81%EF%BC%89%0A-%20%60app.messenger.sendTo(pid%2C%20action%2C%20data)%60%3A%20%E5%8F%91%E9%80%81%E7%BB%99%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%2F%2F%20%E6%B3%A8%E6%84%8F%EF%BC%8C%E5%8F%AA%E6%9C%89%E5%9C%A8%20egg-ready%20%E4%BA%8B%E4%BB%B6%E6%8B%BF%E5%88%B0%E4%B9%8B%E5%90%8E%E6%89%8D%E8%83%BD%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%0A%20%20app.messenger.once('egg-ready'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20app.messenger.sendToAgent('agent-event'%2C%20%7B%20foo%3A%20'bar'%20%7D)%3B%0A%20%20%20%20app.messenger.sendToApp('app-event'%2C%20%7B%20foo%3A%20'bar'%20%7D)%3B%0A%20%20%7D)%3B%0A%7D%0A%60%60%60%0A%0A*%E4%B8%8A%E9%9D%A2%E6%89%80%E6%9C%89%20%60app.messenger%60%20%E4%B8%8A%E7%9A%84%E6%96%B9%E6%B3%95%E9%83%BD%E5%8F%AF%E4%BB%A5%E5%9C%A8%20%60agent.messenger%60%20%E4%B8%8A%E4%BD%BF%E7%94%A8%E3%80%82*%0A%0A%23%23%23%23%20egg-ready%0A%0A%E4%B8%8A%E9%9D%A2%E7%9A%84%E7%A4%BA%E4%BE%8B%E4%B8%AD%E6%8F%90%E5%88%B0%EF%BC%8C%E9%9C%80%E8%A6%81%E7%AD%89%20%60egg-ready%60%20%E6%B6%88%E6%81%AF%E4%B9%8B%E5%90%8E%E6%89%8D%E8%83%BD%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E3%80%82%E5%8F%AA%E6%9C%89%E5%9C%A8%20Master%20%E7%A1%AE%E8%AE%A4%E6%89%80%E6%9C%89%E7%9A%84%20Agent%20%E8%BF%9B%E7%A8%8B%E5%92%8C%20Worker%20%E8%BF%9B%E7%A8%8B%E9%83%BD%E5%B7%B2%E7%BB%8F%E6%88%90%E5%8A%9F%E5%90%AF%E5%8A%A8%EF%BC%88%E5%B9%B6%20ready%EF%BC%89%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%89%8D%E4%BC%9A%E9%80%9A%E8%BF%87%20messenger%20%E5%8F%91%E9%80%81%20%60egg-ready%60%20%E6%B6%88%E6%81%AF%E7%BB%99%E6%89%80%E6%9C%89%E7%9A%84%20Agent%20%E5%92%8C%20Worker%EF%BC%8C%E5%91%8A%E7%9F%A5%E4%B8%80%E5%88%87%E5%87%86%E5%A4%87%E5%B0%B1%E7%BB%AA%EF%BC%8CIPC%20%E9%80%9A%E9%81%93%E5%8F%AF%E4%BB%A5%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8%E4%BA%86%E3%80%82%0A%0A%23%23%23%20%E6%8E%A5%E6%94%B6%0A%0A%E5%9C%A8%20messenger%20%E4%B8%8A%E7%9B%91%E5%90%AC%E5%AF%B9%E5%BA%94%E7%9A%84%20action%20%E4%BA%8B%E4%BB%B6%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E6%94%B6%E5%88%B0%E5%85%B6%E4%BB%96%E8%BF%9B%E7%A8%8B%E5%8F%91%E9%80%81%E6%9D%A5%E7%9A%84%E4%BF%A1%E6%81%AF%E4%BA%86%E3%80%82%0A%0A%60%60%60js%0Aapp.messenger.on(action%2C%20data%20%3D%3E%20%7B%0A%20%20%2F%2F%20process%20data%0A%7D)%3B%0Aapp.messenger.once(action%2C%20data%20%3D%3E%20%7B%0A%20%20%2F%2F%20process%20data%0A%7D)%3B%0A%60%60%60%0A%0A*agent%20%E4%B8%8A%E7%9A%84%20messenger%20%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF%E7%9A%84%E7%94%A8%E6%B3%95%E5%92%8C%20app%20%E4%B8%8A%E4%B8%80%E8%87%B4%E3%80%82*%0A%0A%23%23%20IPC%20%E5%AE%9E%E6%88%98%0A%0A%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90%E6%9D%A5%E6%84%9F%E5%8F%97%E4%B8%80%E4%B8%8B%E5%9C%A8%E6%A1%86%E6%9E%B6%E7%9A%84%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%B8%8B%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20IPC%20%E8%A7%A3%E5%86%B3%E5%AE%9E%E9%99%85%E9%97%AE%E9%A2%98%E3%80%82%0A%0A%23%23%23%20%E9%9C%80%E6%B1%82%0A%0A%E6%88%91%E4%BB%AC%E6%9C%89%E4%B8%80%E4%B8%AA%E6%8E%A5%E5%8F%A3%E9%9C%80%E8%A6%81%E4%BB%8E%E8%BF%9C%E7%A8%8B%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%AD%E8%AF%BB%E5%8F%96%E4%B8%80%E4%BA%9B%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%AF%B9%E5%A4%96%E9%83%A8%E6%8F%90%E4%BE%9B%20API%EF%BC%8C%E4%BD%86%E6%98%AF%E8%BF%99%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BE%88%E5%B0%91%E5%8F%98%E5%8C%96%EF%BC%8C%E5%9B%A0%E6%AD%A4%E6%88%91%E4%BB%AC%E5%B8%8C%E6%9C%9B%E5%B0%86%E6%95%B0%E6%8D%AE%E7%BC%93%E5%AD%98%E5%88%B0%E5%86%85%E5%AD%98%E4%B8%AD%E4%BB%A5%E6%8F%90%E5%8D%87%E6%9C%8D%E5%8A%A1%E8%83%BD%E5%8A%9B%EF%BC%8C%E9%99%8D%E4%BD%8E%20RT%E3%80%82%E6%AD%A4%E6%97%B6%E5%B0%B1%E9%9C%80%E8%A6%81%E6%9C%89%E4%B8%80%E4%B8%AA%E6%9B%B4%E6%96%B0%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%E7%9A%84%E6%9C%BA%E5%88%B6%E3%80%82%0A%0A1.%20%E5%AE%9A%E6%97%B6%E4%BB%8E%E8%BF%9C%E7%A8%8B%E6%95%B0%E6%8D%AE%E6%BA%90%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%9B%B4%E6%96%B0%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%EF%BC%8C%E4%B8%BA%E4%BA%86%E9%99%8D%E4%BD%8E%E5%AF%B9%E6%95%B0%E6%8D%AE%E6%BA%90%E5%8E%8B%E5%8A%9B%EF%BC%8C%E6%9B%B4%E6%96%B0%E7%9A%84%E9%97%B4%E9%9A%94%E6%97%B6%E9%97%B4%E4%BC%9A%E8%AE%BE%E7%BD%AE%E7%9A%84%E6%AF%94%E8%BE%83%E9%95%BF%E3%80%82%0A2.%20%E8%BF%9C%E7%A8%8B%E6%95%B0%E6%8D%AE%E6%BA%90%E6%8F%90%E4%BE%9B%E4%B8%80%E4%B8%AA%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E6%9C%89%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E7%9A%84%E6%8E%A5%E5%8F%A3%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%AF%E4%BB%A5%E6%9B%B4%E9%A2%91%E7%B9%81%E7%9A%84%E8%B0%83%E7%94%A8%E6%A3%80%E6%9F%A5%E6%8E%A5%E5%8F%A3%EF%BC%8C%E5%BD%93%E6%9C%89%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E6%97%B6%E6%89%8D%E5%8E%BB%E9%87%8D%E6%96%B0%E6%8B%89%E5%8F%96%E6%95%B0%E6%8D%AE%E3%80%82%0A3.%20%E8%BF%9C%E7%A8%8B%E6%95%B0%E6%8D%AE%E6%BA%90%E9%80%9A%E8%BF%87%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%8E%A8%E9%80%81%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E7%9A%84%E6%B6%88%E6%81%AF%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%9B%91%E5%90%AC%E6%B6%88%E6%81%AF%E6%9D%A5%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E3%80%82%0A%0A%E5%9C%A8%E5%AE%9E%E9%99%85%E9%A1%B9%E7%9B%AE%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%87%87%E7%94%A8%E6%96%B9%E6%A1%88%E4%B8%80%E7%94%A8%E4%BA%8E%E5%85%9C%E5%BA%95%EF%BC%8C%E7%BB%93%E5%90%88%E6%96%B9%E6%A1%88%E4%B8%89%E6%88%96%E8%80%85%E6%96%B9%E6%A1%88%E4%BA%8C%E7%9A%84%E4%B8%80%E7%A7%8D%E7%94%A8%E4%BA%8E%E6%8F%90%E5%8D%87%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E7%9A%84%E5%AE%9E%E6%97%B6%E6%80%A7%E3%80%82%E8%80%8C%E5%9C%A8%E8%BF%99%E4%B8%AA%E7%A4%BA%E4%BE%8B%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BC%9A%E9%80%9A%E8%BF%87%20IPC%20%2B%20%5B%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%5D(..%2Fbasics%2Fschedule.md)%E6%9D%A5%E5%90%8C%E6%97%B6%E5%AE%9E%E7%8E%B0%E8%BF%99%E4%B8%89%E7%A7%8D%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E6%96%B9%E6%A1%88%E3%80%82%0A%0A%23%23%23%20%E5%AE%9E%E7%8E%B0%0A%0A%E6%88%91%E4%BB%AC%E5%B0%86%E6%89%80%E6%9C%89%E7%9A%84%E4%B8%8E%E8%BF%9C%E7%A8%8B%E6%95%B0%E6%8D%AE%E6%BA%90%E4%BA%A4%E4%BA%92%E7%9A%84%E9%80%BB%E8%BE%91%E5%B0%81%E8%A3%85%E5%9C%A8%E4%B8%80%E4%B8%AA%20Service%20%E4%B8%AD%EF%BC%8C%E5%B9%B6%E6%8F%90%E4%BE%9B%20%60get%60%20%E6%96%B9%E6%B3%95%E7%BB%99%20Controller%20%E8%B0%83%E7%94%A8%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fservice%2Fsource.js%0Alet%20memoryCache%20%3D%20%7B%7D%3B%0A%0Aclass%20SourceService%20extends%20Service%20%7B%0A%20%20get(key)%20%7B%0A%20%20%20%20return%20memoryCache%5Bkey%5D%3B%0A%20%20%7D%0A%0A%20%20async%20checkUpdate()%20%7B%0A%20%20%20%20%2F%2F%20check%20if%20remote%20data%20source%20has%20changed%0A%20%20%20%20const%20updated%20%3D%20await%20mockCheck()%3B%0A%20%20%20%20this.ctx.logger.info('check%20update%20response%20%25s'%2C%20updated)%3B%0A%20%20%20%20return%20updated%3B%0A%20%20%7D%0A%0A%20%20async%20update()%20%7B%0A%20%20%20%20%2F%2F%20update%20memory%20cache%20from%20remote%0A%20%20%20%20memoryCache%20%3D%20await%20mockFetch()%3B%0A%20%20%20%20this.ctx.logger.info('update%20memory%20cache%20from%20remote%3A%20%25j'%2C%20memoryCache)%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E7%BC%96%E5%86%99%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%EF%BC%8C%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%8C%E6%AF%8F%2010%20%E5%88%86%E9%92%9F%E5%AE%9A%E6%97%B6%E4%BB%8E%E8%BF%9C%E7%A8%8B%E6%95%B0%E6%8D%AE%E6%BA%90%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98%E5%81%9A%E5%85%9C%E5%BA%95%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fschedule%2Fforce_refresh.js%0Aexports.schedule%20%3D%20%7B%0A%20%20interval%3A%20'10m'%2C%0A%20%20type%3A%20'all'%2C%20%2F%2F%20run%20in%20all%20workers%0A%7D%3B%0A%0Aexports.task%20%3D%20async%20ctx%20%3D%3E%20%7B%0A%20%20await%20ctx.service.source.update()%3B%0A%20%20ctx.app.lastUpdateBy%20%3D%20'force'%3B%0A%7D%3B%0A%60%60%60%0A%0A%E5%86%8D%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%BA%8C%E7%9A%84%E6%A3%80%E6%9F%A5%E9%80%BB%E8%BE%91%EF%BC%8C%E6%AF%8F%2010s%20%E8%AE%A9%E4%B8%80%E4%B8%AA%20worker%20%E8%B0%83%E7%94%A8%E6%A3%80%E6%9F%A5%E6%8E%A5%E5%8F%A3%EF%BC%8C%E5%BD%93%E5%8F%91%E7%8E%B0%E6%95%B0%E6%8D%AE%E6%9C%89%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E9%80%9A%E8%BF%87%20messenger%20%E6%8F%90%E4%BE%9B%E7%9A%84%E6%96%B9%E6%B3%95%E9%80%9A%E7%9F%A5%E6%89%80%E6%9C%89%E7%9A%84%20Worker%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fschedule%2Fpull_refresh.js%0Aexports.schedule%20%3D%20%7B%0A%20%20interval%3A%20'10s'%2C%0A%20%20type%3A%20'worker'%2C%20%2F%2F%20only%20run%20in%20one%20worker%0A%7D%3B%0A%0Aexports.task%20%3D%20async%20ctx%20%3D%3E%20%7B%0A%20%20const%20needRefresh%20%3D%20await%20ctx.service.source.checkUpdate()%3B%0A%20%20if%20(!needRefresh)%20return%3B%0A%0A%20%20%2F%2F%20notify%20all%20workers%20to%20update%20memory%20cache%20from%20%60file%60%0A%20%20ctx.app.messenger.sendToApp('refresh'%2C%20'pull')%3B%0A%7D%3B%0A%60%60%60%0A%0A%E5%9C%A8%E5%90%AF%E5%8A%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9B%91%E5%90%AC%20%60refresh%60%20%E4%BA%8B%E4%BB%B6%EF%BC%8C%E5%B9%B6%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%89%80%E6%9C%89%E7%9A%84%20Worker%20%E8%BF%9B%E7%A8%8B%E9%83%BD%E8%83%BD%E6%94%B6%E5%88%B0%E8%BF%99%E4%B8%AA%E6%B6%88%E6%81%AF%EF%BC%8C%E5%B9%B6%E8%A7%A6%E5%8F%91%E6%9B%B4%E6%96%B0%EF%BC%8C%E6%AD%A4%E6%97%B6%E6%88%91%E4%BB%AC%E7%9A%84%E6%96%B9%E6%A1%88%E4%BA%8C%E4%B9%9F%E5%B7%B2%E7%BB%8F%E5%A4%A7%E5%8A%9F%E5%91%8A%E6%88%90%E4%BA%86%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.messenger.on('refresh'%2C%20by%20%3D%3E%20%7B%0A%20%20%20%20app.logger.info('start%20update%20by%20%25s'%2C%20by)%3B%0A%20%20%20%20%2F%2F%20create%20an%20anonymous%20context%20to%20access%20service%0A%20%20%20%20const%20ctx%20%3D%20app.createAnonymousContext()%3B%0A%20%20%20%20ctx.runInBackground(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20await%20ctx.service.source.update()%3B%0A%20%20%20%20%20%20app.lastUpdateBy%20%3D%20by%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%E7%8E%B0%E5%9C%A8%E6%88%91%E4%BB%AC%E6%9D%A5%E7%9C%8B%E7%9C%8B%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%B8%89%E4%B8%AA%E6%96%B9%E6%A1%88%E3%80%82%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E6%9C%89%E4%B8%80%E4%B8%AA%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%8C%E5%AE%83%E4%BC%9A%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BF%9D%E6%8C%81%E9%95%BF%E8%BF%9E%E6%8E%A5%EF%BC%8C%E8%BF%99%E4%B8%80%E7%B1%BB%E7%9A%84%E9%95%BF%E8%BF%9E%E6%8E%A5%E7%BB%B4%E6%8C%81%E6%AF%94%E8%BE%83%E9%80%82%E5%90%88%E5%9C%A8%20Agent%20%E8%BF%9B%E7%A8%8B%E4%B8%8A%E5%81%9A%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%9C%89%E6%95%88%E9%99%8D%E4%BD%8E%E8%BF%9E%E6%8E%A5%E6%95%B0%EF%BC%8C%E5%87%8F%E5%B0%91%E4%B8%A4%E7%AB%AF%E7%9A%84%E6%B6%88%E8%80%97%E3%80%82%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E5%9C%A8%20Agent%20%E8%BF%9B%E7%A8%8B%E4%B8%8A%E6%9D%A5%E5%BC%80%E5%90%AF%E6%B6%88%E6%81%AF%E7%9B%91%E5%90%AC%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20agent.js%0A%0Aconst%20Subscriber%20%3D%20require('.%2Flib%2Fsubscriber')%3B%0A%0Amodule.exports%20%3D%20agent%20%3D%3E%20%7B%0A%20%20const%20subscriber%20%3D%20new%20Subscriber()%3B%0A%20%20%2F%2F%20listen%20changed%20event%2C%20broadcast%20to%20all%20workers%0A%20%20subscriber.on('changed'%2C%20()%20%3D%3E%20agent.messenger.sendToApp('refresh'%2C%20'push'))%3B%0A%7D%3B%0A%60%60%60%0A%0A%E9%80%9A%E8%BF%87%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%20Agent%20%E8%BF%9B%E7%A8%8B%E3%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%92%8C%20IPC%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E8%BD%BB%E6%9D%BE%E6%90%9E%E5%AE%9A%E7%B1%BB%E4%BC%BC%E7%9A%84%E9%9C%80%E6%B1%82%E5%B9%B6%E9%99%8D%E4%BD%8E%E5%AF%B9%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E5%8E%8B%E5%8A%9B%E3%80%82%E5%85%B7%E4%BD%93%E7%9A%84%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8B%20%5Bexamples%2Fipc%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fexamples%2Ftree%2Fmaster%2Fipc)%E3%80%82%0A%0A%23%23%20%E6%9B%B4%E5%A4%8D%E6%9D%82%E7%9A%84%E5%9C%BA%E6%99%AF%0A%0A%E4%B8%8A%E9%9D%A2%E7%9A%84%E4%BE%8B%E5%AD%90%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E5%9C%A8%20Agent%20%E8%BF%9B%E7%A8%8B%E4%B8%8A%E8%BF%90%E8%A1%8C%E4%BA%86%E4%B8%80%E4%B8%AA%20subscriber%EF%BC%8C%E6%9D%A5%E7%9B%91%E5%90%AC%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E6%B6%88%E6%81%AF%EF%BC%8C%E5%A6%82%E6%9E%9C%20Worker%20%E8%BF%9B%E7%A8%8B%E4%B9%9F%E9%9C%80%E8%A6%81%E7%9B%91%E5%90%AC%E4%B8%80%E4%BA%9B%E6%B6%88%E6%81%AF%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87%20Agent%20%E8%BF%9B%E7%A8%8B%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%E5%86%8D%E8%BD%AC%E5%8F%91%E7%BB%99%20Worker%20%E8%BF%9B%E7%A8%8B%E5%91%A2%EF%BC%9F%E8%BF%99%E4%BA%9B%E9%97%AE%E9%A2%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%5B%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%A0%94%E5%8F%91%E6%A8%A1%E5%BC%8F%E5%A2%9E%E5%BC%BA%5D(..%2Fadvanced%2Fcluster-client.md)%E4%B8%AD%E6%89%BE%E5%88%B0%E7%AD%94%E6%A1%88%E3%80%82%0A%0A%5Bpm2%5D%3A%20https%3A%2F%2Fgithub.com%2FUnitech%2Fpm2%0A%5Begg-cluster%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-cluster%0A%5Begg-scripts%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-scripts%0A%5Bgraceful%5D%3A%20https%3A%2F%2Fgithub.com%2Fnode-modules%2Fgraceful%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>