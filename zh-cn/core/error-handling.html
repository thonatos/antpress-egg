<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>异常处理</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><h2 id="异常捕获">异常捕获</h2><p>得益于框架支持的异步编程模型，错误完全可以用 <code>try catch</code> 来捕获。在编写应用代码时，所有地方都可以直接用 <code>try catch</code> 来捕获异常。</p><pre><code class="language-js">// app/service/test.js
try {
  const res = await this.ctx.curl(&#x27;http://eggjs.com/api/echo&#x27;, { dataType: &#x27;json&#x27; });
  if (res.status !== 200) throw new Error(&#x27;response status is not 200&#x27;);
  return res.data;
} catch (err) {
  this.logger.error(err);
  return {};
}</code></pre><p>按照正常代码写法，所有的异常都可以用这个方式进行捕获并处理，但是一定要注意一些特殊的写法可能带来的问题。打一个不太正式的比方，我们的代码全部都在一个异步调用链上，所有的异步操作都通过 await 串接起来了，但是只要有一个地方跳出了异步调用链，异常就捕获不到了。</p><pre><code class="language-js">// app/controller/home.js
class HomeController extends Controller {
  async buy () {
    const request = {};
    const config = await ctx.service.trade.buy(request);
    // 下单后需要进行一次核对，且不阻塞当前请求
    setImmediate(() =&gt; {
      ctx.service.trade.check(request).catch(err =&gt; ctx.logger.error(err));
    });
  }
}</code></pre><p>在这个场景中，如果 <code>service.trade.check</code> 方法中代码有问题，导致执行时抛出了异常，尽管框架会在最外层通过 <code>try catch</code> 统一捕获错误，但是由于 <code>setImmediate</code> 中的代码『跳出』了异步链，它里面的错误就无法被捕捉到了。因此在编写类似代码的时候一定要注意。</p><p>当然，框架也考虑到了这类场景，提供了 <code>ctx.runInBackground(scope)</code> 辅助方法，通过它又包装了一个异步链，所有在这个 scope 里面的错误都会统一捕获。</p><pre><code class="language-js">class HomeController extends Controller {
  async buy () {
    const request = {};
    const config = await ctx.service.trade.buy(request);
    // 下单后需要进行一次核对，且不阻塞当前请求
    ctx.runInBackground(async () =&gt; {
      // 这里面的异常都会统统被 Backgroud 捕获掉，并打印错误日志
      await ctx.service.trade.check(request);
    });
  }
}</code></pre><p><strong>为了保证异常可追踪，必须保证所有抛出的异常都是 Error 类型，因为只有 Error 类型才会带上堆栈信息，定位到问题。</strong></p><h2 id="框架层统一异常处理">框架层统一异常处理</h2><p>框架通过 <a href="https://github.com/eggjs/egg-onerror">onerror</a> 插件提供了统一的错误处理机制。对一个请求的所有处理方法（Middleware、Controller、Service）中抛出的任何异常都会被它捕获，并自动根据请求想要获取的类型返回不同类型的错误（基于 <a href="https://tools.ietf.org/html/rfc7231#section-5.3.2">Content Negotiation</a>）。</p><table><thead><tr><th>请求需求的格式</th><th>环境</th><th>errorPageUrl 是否配置</th><th>返回内容</th></tr></thead><tbody><tr><td>HTML &amp; TEXT</td><td>local &amp; unittest</td><td>-</td><td>onerror 自带的错误页面，展示详细的错误信息</td></tr><tr><td>HTML &amp; TEXT</td><td>其他</td><td>是</td><td>重定向到 errorPageUrl</td></tr><tr><td>HTML &amp; TEXT</td><td>其他</td><td>否</td><td>onerror 自带的没有错误信息的简单错误页（不推荐）</td></tr><tr><td>JSON &amp; JSONP</td><td>local &amp; unittest</td><td>-</td><td>JSON 对象或对应的 JSONP 格式响应，带详细的错误信息</td></tr><tr><td>JSON &amp; JSONP</td><td>其他</td><td>-</td><td>JSON 对象或对应的 JSONP 格式响应，不带详细的错误信息</td></tr></tbody></table><h3 id="errorpageurl">errorPageUrl</h3><p>onerror 插件的配置中支持 errorPageUrl 属性，当配置了 errorPageUrl 时，一旦用户请求线上应用的 HTML 页面异常，就会重定向到这个地址。</p><p>在 <code>config/config.default.js</code> 中</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  onerror: {
    // 线上页面发生异常时，重定向到这个页面上
    errorPageUrl: &#x27;/50x.html&#x27;,
  },
};</code></pre><h2 id="自定义统一异常处理">自定义统一异常处理</h2><p>尽管框架提供了默认的统一异常处理机制，但是应用开发中经常需要对异常时的响应做自定义，特别是在做一些接口开发的时候。框架自带的 onerror 插件支持自定义配置错误处理方法，可以覆盖默认的错误处理方法。</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  onerror: {
    all(err, ctx) {
      // 在此处定义针对所有响应类型的错误处理方法
      // 注意，定义了 config.all 之后，其他错误处理方法不会再生效
      ctx.body = &#x27;error&#x27;;
      ctx.status = 500;
    },
    html(err, ctx) {
      // html hander
      ctx.body = &#x27;&lt;h3&gt;error&lt;/h3&gt;&#x27;;
      ctx.status = 500;
    },
    json(err, ctx) {
      // json hander
      ctx.body = { message: &#x27;error&#x27; };
      ctx.status = 500;
    },
    jsonp(err, ctx) {
      // 一般来说，不需要特殊针对 jsonp 进行错误定义，jsonp 的错误处理会自动调用 json 错误处理，并包装成 jsonp 的响应格式
    },
  },
};</code></pre><h2 id="404">404</h2><p>框架并不会将服务端返回的 404 状态当做异常来处理，但是框架提供了当响应为 404 且没有返回 body 时的默认响应。</p><ul><li><p>当请求被框架判定为需要 JSON 格式的响应时，会返回一段 JSON：</p><pre><code class="language-json">{ &quot;message&quot;: &quot;Not Found&quot; }</code></pre></li><li><p>当请求被框架判定为需要 HTML 格式的响应时，会返回一段 HTML：</p><pre><code class="language-html">&lt;h1&gt;404 Not Found&lt;/h1&gt;</code></pre></li></ul><p>框架支持通过配置，将默认的 HTML 请求的 404 响应重定向到指定的页面。</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  notfound: {
    pageUrl: &#x27;/404.html&#x27;,
  },
};</code></pre><h3 id="自定义-404-响应">自定义 404 响应</h3><p>在一些场景下，我们需要自定义服务器 404 时的响应，和自定义异常处理一样，我们也只需要加入一个中间件即可对 404 做统一处理：</p><pre><code class="language-js">// app/middleware/notfound_handler.js
module.exports = () =&gt; {
  return async function notFoundHandler(ctx, next) {
    await next();
    if (ctx.status === 404 &amp;&amp; !ctx.body) {
      if (ctx.acceptJSON) {
        ctx.body = { error: &#x27;Not Found&#x27; };
      } else {
        ctx.body = &#x27;&lt;h1&gt;Page Not Found&lt;/h1&gt;&#x27;;
      }
    }
  };
};</code></pre><p>在配置中引入中间件：</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  middleware: [ &#x27;notfoundHandler&#x27; ],
};</code></pre></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7">异常捕获</a></li><li><a href="#%E6%A1%86%E6%9E%B6%E5%B1%82%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">框架层统一异常处理</a><ul><li><a href="#errorpageurl">errorPageUrl</a></li></ul></li><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">自定义统一异常处理</a></li><li><a href="#404">404</a><ul><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89-404-%E5%93%8D%E5%BA%94">自定义 404 响应</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7%5D(%23%25E5%25BC%2582%25E5%25B8%25B8%25E6%258D%2595%25E8%258E%25B7)%0A-%20%5B%E6%A1%86%E6%9E%B6%E5%B1%82%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%5D(%23%25E6%25A1%2586%25E6%259E%25B6%25E5%25B1%2582%25E7%25BB%259F%25E4%25B8%2580%25E5%25BC%2582%25E5%25B8%25B8%25E5%25A4%2584%25E7%2590%2586)%0A%20%20*%20%5BerrorPageUrl%5D(%23errorpageurl)%0A-%20%5B%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%5D(%23%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589%25E7%25BB%259F%25E4%25B8%2580%25E5%25BC%2582%25E5%25B8%25B8%25E5%25A4%2584%25E7%2590%2586)%0A-%20%5B404%5D(%23404)%0A%20%20*%20%5B%E8%87%AA%E5%AE%9A%E4%B9%89%20404%20%E5%93%8D%E5%BA%94%5D(%23%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589-404-%25E5%2593%258D%25E5%25BA%2594)","meta":{"info":{"title":"异常处理"}},"content":"%0A%0A%0A%23%23%20%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7%0A%0A%E5%BE%97%E7%9B%8A%E4%BA%8E%E6%A1%86%E6%9E%B6%E6%94%AF%E6%8C%81%E7%9A%84%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B%EF%BC%8C%E9%94%99%E8%AF%AF%E5%AE%8C%E5%85%A8%E5%8F%AF%E4%BB%A5%E7%94%A8%20%60try%20catch%60%20%E6%9D%A5%E6%8D%95%E8%8E%B7%E3%80%82%E5%9C%A8%E7%BC%96%E5%86%99%E5%BA%94%E7%94%A8%E4%BB%A3%E7%A0%81%E6%97%B6%EF%BC%8C%E6%89%80%E6%9C%89%E5%9C%B0%E6%96%B9%E9%83%BD%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E7%94%A8%20%60try%20catch%60%20%E6%9D%A5%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fservice%2Ftest.js%0Atry%20%7B%0A%20%20const%20res%20%3D%20await%20this.ctx.curl('http%3A%2F%2Feggjs.com%2Fapi%2Fecho'%2C%20%7B%20dataType%3A%20'json'%20%7D)%3B%0A%20%20if%20(res.status%20!%3D%3D%20200)%20throw%20new%20Error('response%20status%20is%20not%20200')%3B%0A%20%20return%20res.data%3B%0A%7D%20catch%20(err)%20%7B%0A%20%20this.logger.error(err)%3B%0A%20%20return%20%7B%7D%3B%0A%7D%0A%60%60%60%0A%0A%E6%8C%89%E7%85%A7%E6%AD%A3%E5%B8%B8%E4%BB%A3%E7%A0%81%E5%86%99%E6%B3%95%EF%BC%8C%E6%89%80%E6%9C%89%E7%9A%84%E5%BC%82%E5%B8%B8%E9%83%BD%E5%8F%AF%E4%BB%A5%E7%94%A8%E8%BF%99%E4%B8%AA%E6%96%B9%E5%BC%8F%E8%BF%9B%E8%A1%8C%E6%8D%95%E8%8E%B7%E5%B9%B6%E5%A4%84%E7%90%86%EF%BC%8C%E4%BD%86%E6%98%AF%E4%B8%80%E5%AE%9A%E8%A6%81%E6%B3%A8%E6%84%8F%E4%B8%80%E4%BA%9B%E7%89%B9%E6%AE%8A%E7%9A%84%E5%86%99%E6%B3%95%E5%8F%AF%E8%83%BD%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98%E3%80%82%E6%89%93%E4%B8%80%E4%B8%AA%E4%B8%8D%E5%A4%AA%E6%AD%A3%E5%BC%8F%E7%9A%84%E6%AF%94%E6%96%B9%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9A%84%E4%BB%A3%E7%A0%81%E5%85%A8%E9%83%A8%E9%83%BD%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E9%93%BE%E4%B8%8A%EF%BC%8C%E6%89%80%E6%9C%89%E7%9A%84%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C%E9%83%BD%E9%80%9A%E8%BF%87%20await%20%E4%B8%B2%E6%8E%A5%E8%B5%B7%E6%9D%A5%E4%BA%86%EF%BC%8C%E4%BD%86%E6%98%AF%E5%8F%AA%E8%A6%81%E6%9C%89%E4%B8%80%E4%B8%AA%E5%9C%B0%E6%96%B9%E8%B7%B3%E5%87%BA%E4%BA%86%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E9%93%BE%EF%BC%8C%E5%BC%82%E5%B8%B8%E5%B0%B1%E6%8D%95%E8%8E%B7%E4%B8%8D%E5%88%B0%E4%BA%86%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fhome.js%0Aclass%20HomeController%20extends%20Controller%20%7B%0A%20%20async%20buy%20()%20%7B%0A%20%20%20%20const%20request%20%3D%20%7B%7D%3B%0A%20%20%20%20const%20config%20%3D%20await%20ctx.service.trade.buy(request)%3B%0A%20%20%20%20%2F%2F%20%E4%B8%8B%E5%8D%95%E5%90%8E%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8C%E4%B8%80%E6%AC%A1%E6%A0%B8%E5%AF%B9%EF%BC%8C%E4%B8%94%E4%B8%8D%E9%98%BB%E5%A1%9E%E5%BD%93%E5%89%8D%E8%AF%B7%E6%B1%82%0A%20%20%20%20setImmediate(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20ctx.service.trade.check(request).catch(err%20%3D%3E%20ctx.logger.error(err))%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E5%9C%A8%E8%BF%99%E4%B8%AA%E5%9C%BA%E6%99%AF%E4%B8%AD%EF%BC%8C%E5%A6%82%E6%9E%9C%20%60service.trade.check%60%20%E6%96%B9%E6%B3%95%E4%B8%AD%E4%BB%A3%E7%A0%81%E6%9C%89%E9%97%AE%E9%A2%98%EF%BC%8C%E5%AF%BC%E8%87%B4%E6%89%A7%E8%A1%8C%E6%97%B6%E6%8A%9B%E5%87%BA%E4%BA%86%E5%BC%82%E5%B8%B8%EF%BC%8C%E5%B0%BD%E7%AE%A1%E6%A1%86%E6%9E%B6%E4%BC%9A%E5%9C%A8%E6%9C%80%E5%A4%96%E5%B1%82%E9%80%9A%E8%BF%87%20%60try%20catch%60%20%E7%BB%9F%E4%B8%80%E6%8D%95%E8%8E%B7%E9%94%99%E8%AF%AF%EF%BC%8C%E4%BD%86%E6%98%AF%E7%94%B1%E4%BA%8E%20%60setImmediate%60%20%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%8E%E8%B7%B3%E5%87%BA%E3%80%8F%E4%BA%86%E5%BC%82%E6%AD%A5%E9%93%BE%EF%BC%8C%E5%AE%83%E9%87%8C%E9%9D%A2%E7%9A%84%E9%94%99%E8%AF%AF%E5%B0%B1%E6%97%A0%E6%B3%95%E8%A2%AB%E6%8D%95%E6%8D%89%E5%88%B0%E4%BA%86%E3%80%82%E5%9B%A0%E6%AD%A4%E5%9C%A8%E7%BC%96%E5%86%99%E7%B1%BB%E4%BC%BC%E4%BB%A3%E7%A0%81%E7%9A%84%E6%97%B6%E5%80%99%E4%B8%80%E5%AE%9A%E8%A6%81%E6%B3%A8%E6%84%8F%E3%80%82%0A%0A%E5%BD%93%E7%84%B6%EF%BC%8C%E6%A1%86%E6%9E%B6%E4%B9%9F%E8%80%83%E8%99%91%E5%88%B0%E4%BA%86%E8%BF%99%E7%B1%BB%E5%9C%BA%E6%99%AF%EF%BC%8C%E6%8F%90%E4%BE%9B%E4%BA%86%20%60ctx.runInBackground(scope)%60%20%E8%BE%85%E5%8A%A9%E6%96%B9%E6%B3%95%EF%BC%8C%E9%80%9A%E8%BF%87%E5%AE%83%E5%8F%88%E5%8C%85%E8%A3%85%E4%BA%86%E4%B8%80%E4%B8%AA%E5%BC%82%E6%AD%A5%E9%93%BE%EF%BC%8C%E6%89%80%E6%9C%89%E5%9C%A8%E8%BF%99%E4%B8%AA%20scope%20%E9%87%8C%E9%9D%A2%E7%9A%84%E9%94%99%E8%AF%AF%E9%83%BD%E4%BC%9A%E7%BB%9F%E4%B8%80%E6%8D%95%E8%8E%B7%E3%80%82%0A%0A%60%60%60js%0Aclass%20HomeController%20extends%20Controller%20%7B%0A%20%20async%20buy%20()%20%7B%0A%20%20%20%20const%20request%20%3D%20%7B%7D%3B%0A%20%20%20%20const%20config%20%3D%20await%20ctx.service.trade.buy(request)%3B%0A%20%20%20%20%2F%2F%20%E4%B8%8B%E5%8D%95%E5%90%8E%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8C%E4%B8%80%E6%AC%A1%E6%A0%B8%E5%AF%B9%EF%BC%8C%E4%B8%94%E4%B8%8D%E9%98%BB%E5%A1%9E%E5%BD%93%E5%89%8D%E8%AF%B7%E6%B1%82%0A%20%20%20%20ctx.runInBackground(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E9%9D%A2%E7%9A%84%E5%BC%82%E5%B8%B8%E9%83%BD%E4%BC%9A%E7%BB%9F%E7%BB%9F%E8%A2%AB%20Backgroud%20%E6%8D%95%E8%8E%B7%E6%8E%89%EF%BC%8C%E5%B9%B6%E6%89%93%E5%8D%B0%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%0A%20%20%20%20%20%20await%20ctx.service.trade.check(request)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A**%E4%B8%BA%E4%BA%86%E4%BF%9D%E8%AF%81%E5%BC%82%E5%B8%B8%E5%8F%AF%E8%BF%BD%E8%B8%AA%EF%BC%8C%E5%BF%85%E9%A1%BB%E4%BF%9D%E8%AF%81%E6%89%80%E6%9C%89%E6%8A%9B%E5%87%BA%E7%9A%84%E5%BC%82%E5%B8%B8%E9%83%BD%E6%98%AF%20Error%20%E7%B1%BB%E5%9E%8B%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%8F%AA%E6%9C%89%20Error%20%E7%B1%BB%E5%9E%8B%E6%89%8D%E4%BC%9A%E5%B8%A6%E4%B8%8A%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%AE%9A%E4%BD%8D%E5%88%B0%E9%97%AE%E9%A2%98%E3%80%82**%0A%0A%23%23%20%E6%A1%86%E6%9E%B6%E5%B1%82%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%0A%0A%E6%A1%86%E6%9E%B6%E9%80%9A%E8%BF%87%20%5Bonerror%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-onerror)%20%E6%8F%92%E4%BB%B6%E6%8F%90%E4%BE%9B%E4%BA%86%E7%BB%9F%E4%B8%80%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6%E3%80%82%E5%AF%B9%E4%B8%80%E4%B8%AA%E8%AF%B7%E6%B1%82%E7%9A%84%E6%89%80%E6%9C%89%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95%EF%BC%88Middleware%E3%80%81Controller%E3%80%81Service%EF%BC%89%E4%B8%AD%E6%8A%9B%E5%87%BA%E7%9A%84%E4%BB%BB%E4%BD%95%E5%BC%82%E5%B8%B8%E9%83%BD%E4%BC%9A%E8%A2%AB%E5%AE%83%E6%8D%95%E8%8E%B7%EF%BC%8C%E5%B9%B6%E8%87%AA%E5%8A%A8%E6%A0%B9%E6%8D%AE%E8%AF%B7%E6%B1%82%E6%83%B3%E8%A6%81%E8%8E%B7%E5%8F%96%E7%9A%84%E7%B1%BB%E5%9E%8B%E8%BF%94%E5%9B%9E%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%88%E5%9F%BA%E4%BA%8E%20%5BContent%20Negotiation%5D(https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7231%23section-5.3.2)%EF%BC%89%E3%80%82%0A%0A%7C%20%E8%AF%B7%E6%B1%82%E9%9C%80%E6%B1%82%E7%9A%84%E6%A0%BC%E5%BC%8F%20%7C%20%E7%8E%AF%E5%A2%83%20%7C%20errorPageUrl%20%E6%98%AF%E5%90%A6%E9%85%8D%E7%BD%AE%20%7C%20%E8%BF%94%E5%9B%9E%E5%86%85%E5%AE%B9%20%7C%0A%7C-------------%7C------%7C----------------------%7C--------%7C%0A%7C%20HTML%20%26%20TEXT%20%7C%20local%20%26%20unittest%20%7C%20-%20%7C%20onerror%20%E8%87%AA%E5%B8%A6%E7%9A%84%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2%EF%BC%8C%E5%B1%95%E7%A4%BA%E8%AF%A6%E7%BB%86%E7%9A%84%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%20%7C%0A%7C%20HTML%20%26%20TEXT%20%7C%20%E5%85%B6%E4%BB%96%20%7C%20%E6%98%AF%20%7C%20%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0%20errorPageUrl%20%7C%0A%7C%20HTML%20%26%20TEXT%20%7C%20%E5%85%B6%E4%BB%96%20%7C%20%E5%90%A6%20%7C%20onerror%20%E8%87%AA%E5%B8%A6%E7%9A%84%E6%B2%A1%E6%9C%89%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%E7%9A%84%E7%AE%80%E5%8D%95%E9%94%99%E8%AF%AF%E9%A1%B5%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%89%20%7C%0A%7C%20JSON%20%26%20JSONP%20%7C%20local%20%26%20unittest%20%7C%20-%20%7C%20JSON%20%E5%AF%B9%E8%B1%A1%E6%88%96%E5%AF%B9%E5%BA%94%E7%9A%84%20JSONP%20%E6%A0%BC%E5%BC%8F%E5%93%8D%E5%BA%94%EF%BC%8C%E5%B8%A6%E8%AF%A6%E7%BB%86%E7%9A%84%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%20%7C%0A%7C%20JSON%20%26%20JSONP%20%7C%20%E5%85%B6%E4%BB%96%20%7C%20-%20%7C%20JSON%20%E5%AF%B9%E8%B1%A1%E6%88%96%E5%AF%B9%E5%BA%94%E7%9A%84%20JSONP%20%E6%A0%BC%E5%BC%8F%E5%93%8D%E5%BA%94%EF%BC%8C%E4%B8%8D%E5%B8%A6%E8%AF%A6%E7%BB%86%E7%9A%84%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%20%7C%0A%0A%23%23%23%20errorPageUrl%0A%0Aonerror%20%E6%8F%92%E4%BB%B6%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%AD%E6%94%AF%E6%8C%81%20errorPageUrl%20%E5%B1%9E%E6%80%A7%EF%BC%8C%E5%BD%93%E9%85%8D%E7%BD%AE%E4%BA%86%20errorPageUrl%20%E6%97%B6%EF%BC%8C%E4%B8%80%E6%97%A6%E7%94%A8%E6%88%B7%E8%AF%B7%E6%B1%82%E7%BA%BF%E4%B8%8A%E5%BA%94%E7%94%A8%E7%9A%84%20HTML%20%E9%A1%B5%E9%9D%A2%E5%BC%82%E5%B8%B8%EF%BC%8C%E5%B0%B1%E4%BC%9A%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0%E8%BF%99%E4%B8%AA%E5%9C%B0%E5%9D%80%E3%80%82%0A%0A%E5%9C%A8%20%60config%2Fconfig.default.js%60%20%E4%B8%AD%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20onerror%3A%20%7B%0A%20%20%20%20%2F%2F%20%E7%BA%BF%E4%B8%8A%E9%A1%B5%E9%9D%A2%E5%8F%91%E7%94%9F%E5%BC%82%E5%B8%B8%E6%97%B6%EF%BC%8C%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0%E8%BF%99%E4%B8%AA%E9%A1%B5%E9%9D%A2%E4%B8%8A%0A%20%20%20%20errorPageUrl%3A%20'%2F50x.html'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%0A%0A%E5%B0%BD%E7%AE%A1%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E4%BA%86%E9%BB%98%E8%AE%A4%E7%9A%84%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6%EF%BC%8C%E4%BD%86%E6%98%AF%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E4%B8%AD%E7%BB%8F%E5%B8%B8%E9%9C%80%E8%A6%81%E5%AF%B9%E5%BC%82%E5%B8%B8%E6%97%B6%E7%9A%84%E5%93%8D%E5%BA%94%E5%81%9A%E8%87%AA%E5%AE%9A%E4%B9%89%EF%BC%8C%E7%89%B9%E5%88%AB%E6%98%AF%E5%9C%A8%E5%81%9A%E4%B8%80%E4%BA%9B%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%E7%9A%84%E6%97%B6%E5%80%99%E3%80%82%E6%A1%86%E6%9E%B6%E8%87%AA%E5%B8%A6%E7%9A%84%20onerror%20%E6%8F%92%E4%BB%B6%E6%94%AF%E6%8C%81%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%A6%86%E7%9B%96%E9%BB%98%E8%AE%A4%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20onerror%3A%20%7B%0A%20%20%20%20all(err%2C%20ctx)%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E6%AD%A4%E5%A4%84%E5%AE%9A%E4%B9%89%E9%92%88%E5%AF%B9%E6%89%80%E6%9C%89%E5%93%8D%E5%BA%94%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95%0A%20%20%20%20%20%20%2F%2F%20%E6%B3%A8%E6%84%8F%EF%BC%8C%E5%AE%9A%E4%B9%89%E4%BA%86%20config.all%20%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%85%B6%E4%BB%96%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95%E4%B8%8D%E4%BC%9A%E5%86%8D%E7%94%9F%E6%95%88%0A%20%20%20%20%20%20ctx.body%20%3D%20'error'%3B%0A%20%20%20%20%20%20ctx.status%20%3D%20500%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20html(err%2C%20ctx)%20%7B%0A%20%20%20%20%20%20%2F%2F%20html%20hander%0A%20%20%20%20%20%20ctx.body%20%3D%20'%3Ch3%3Eerror%3C%2Fh3%3E'%3B%0A%20%20%20%20%20%20ctx.status%20%3D%20500%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20json(err%2C%20ctx)%20%7B%0A%20%20%20%20%20%20%2F%2F%20json%20hander%0A%20%20%20%20%20%20ctx.body%20%3D%20%7B%20message%3A%20'error'%20%7D%3B%0A%20%20%20%20%20%20ctx.status%20%3D%20500%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20jsonp(err%2C%20ctx)%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E4%B8%80%E8%88%AC%E6%9D%A5%E8%AF%B4%EF%BC%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E7%89%B9%E6%AE%8A%E9%92%88%E5%AF%B9%20jsonp%20%E8%BF%9B%E8%A1%8C%E9%94%99%E8%AF%AF%E5%AE%9A%E4%B9%89%EF%BC%8Cjsonp%20%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%BC%9A%E8%87%AA%E5%8A%A8%E8%B0%83%E7%94%A8%20json%20%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%8C%E5%B9%B6%E5%8C%85%E8%A3%85%E6%88%90%20jsonp%20%E7%9A%84%E5%93%8D%E5%BA%94%E6%A0%BC%E5%BC%8F%0A%20%20%20%20%7D%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%20404%0A%0A%E6%A1%86%E6%9E%B6%E5%B9%B6%E4%B8%8D%E4%BC%9A%E5%B0%86%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%BF%94%E5%9B%9E%E7%9A%84%20404%20%E7%8A%B6%E6%80%81%E5%BD%93%E5%81%9A%E5%BC%82%E5%B8%B8%E6%9D%A5%E5%A4%84%E7%90%86%EF%BC%8C%E4%BD%86%E6%98%AF%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E4%BA%86%E5%BD%93%E5%93%8D%E5%BA%94%E4%B8%BA%20404%20%E4%B8%94%E6%B2%A1%E6%9C%89%E8%BF%94%E5%9B%9E%20body%20%E6%97%B6%E7%9A%84%E9%BB%98%E8%AE%A4%E5%93%8D%E5%BA%94%E3%80%82%0A%0A-%20%E5%BD%93%E8%AF%B7%E6%B1%82%E8%A2%AB%E6%A1%86%E6%9E%B6%E5%88%A4%E5%AE%9A%E4%B8%BA%E9%9C%80%E8%A6%81%20JSON%20%E6%A0%BC%E5%BC%8F%E7%9A%84%E5%93%8D%E5%BA%94%E6%97%B6%EF%BC%8C%E4%BC%9A%E8%BF%94%E5%9B%9E%E4%B8%80%E6%AE%B5%20JSON%EF%BC%9A%0A%0A%20%20%60%60%60json%0A%20%20%7B%20%22message%22%3A%20%22Not%20Found%22%20%7D%0A%20%20%60%60%60%0A%0A-%20%E5%BD%93%E8%AF%B7%E6%B1%82%E8%A2%AB%E6%A1%86%E6%9E%B6%E5%88%A4%E5%AE%9A%E4%B8%BA%E9%9C%80%E8%A6%81%20HTML%20%E6%A0%BC%E5%BC%8F%E7%9A%84%E5%93%8D%E5%BA%94%E6%97%B6%EF%BC%8C%E4%BC%9A%E8%BF%94%E5%9B%9E%E4%B8%80%E6%AE%B5%20HTML%EF%BC%9A%0A%0A%20%20%60%60%60html%0A%20%20%3Ch1%3E404%20Not%20Found%3C%2Fh1%3E%0A%20%20%60%60%60%0A%0A%E6%A1%86%E6%9E%B6%E6%94%AF%E6%8C%81%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%B0%86%E9%BB%98%E8%AE%A4%E7%9A%84%20HTML%20%E8%AF%B7%E6%B1%82%E7%9A%84%20404%20%E5%93%8D%E5%BA%94%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0%E6%8C%87%E5%AE%9A%E7%9A%84%E9%A1%B5%E9%9D%A2%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20notfound%3A%20%7B%0A%20%20%20%20pageUrl%3A%20'%2F404.html'%2C%0A%20%20%7D%2C%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20%E8%87%AA%E5%AE%9A%E4%B9%89%20404%20%E5%93%8D%E5%BA%94%0A%0A%E5%9C%A8%E4%B8%80%E4%BA%9B%E5%9C%BA%E6%99%AF%E4%B8%8B%EF%BC%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1%E5%99%A8%20404%20%E6%97%B6%E7%9A%84%E5%93%8D%E5%BA%94%EF%BC%8C%E5%92%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%80%E6%A0%B7%EF%BC%8C%E6%88%91%E4%BB%AC%E4%B9%9F%E5%8F%AA%E9%9C%80%E8%A6%81%E5%8A%A0%E5%85%A5%E4%B8%80%E4%B8%AA%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%8D%B3%E5%8F%AF%E5%AF%B9%20404%20%E5%81%9A%E7%BB%9F%E4%B8%80%E5%A4%84%E7%90%86%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app%2Fmiddleware%2Fnotfound_handler.js%0Amodule.exports%20%3D%20()%20%3D%3E%20%7B%0A%20%20return%20async%20function%20notFoundHandler(ctx%2C%20next)%20%7B%0A%20%20%20%20await%20next()%3B%0A%20%20%20%20if%20(ctx.status%20%3D%3D%3D%20404%20%26%26%20!ctx.body)%20%7B%0A%20%20%20%20%20%20if%20(ctx.acceptJSON)%20%7B%0A%20%20%20%20%20%20%20%20ctx.body%20%3D%20%7B%20error%3A%20'Not%20Found'%20%7D%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20ctx.body%20%3D%20'%3Ch1%3EPage%20Not%20Found%3C%2Fh1%3E'%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%7D%3B%0A%60%60%60%0A%0A%E5%9C%A8%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BC%95%E5%85%A5%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20middleware%3A%20%5B%20'notfoundHandler'%20%5D%2C%0A%7D%3B%0A%60%60%60%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>