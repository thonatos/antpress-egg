<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>插件开发</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>插件机制是我们框架的一大特色。它不但可以保证框架核心的足够精简、稳定、高效，还可以促进业务逻辑的复用，生态圈的形成。有人可能会问了</p><ul><li>Koa 已经有了中间件的机制，为啥还要插件呢？</li><li>中间件、插件、应用它们之间是什么关系，有什么区别？</li><li>我该怎么使用一个插件？</li><li>如何编写一个插件？</li><li>...</li></ul><p>在<a href="../basics/plugin.md">使用插件</a>章节我们已经讨论过前几点，接下来我们来看看如何开发一个插件。</p><h2 id="插件开发">插件开发</h2><h3 id="使用脚手架快速开发">使用脚手架快速开发</h3><p>你可以直接通过 <a href="https://github.com/eggjs/egg-init">egg-init</a> 选择 <a href="https://github.com/eggjs/egg-boilerplate-plugin">plugin</a> 脚手架来快速上手。</p><pre><code class="language-bash">$ egg-init --type=plugin egg-hello
$ cd egg-hello
$ npm i
$ npm test</code></pre><h2 id="插件的目录结构">插件的目录结构</h2><p>一个插件其实就是一个『迷你的应用』，下面展示的是一个插件的目录结构，和应用（app）几乎一样。</p><pre><code class="language-js">. egg-hello
├── package.json
├── app.js (可选)
├── agent.js (可选)
├── app
│   ├── extend (可选)
│   |   ├── helper.js (可选)
│   |   ├── request.js (可选)
│   |   ├── response.js (可选)
│   |   ├── context.js (可选)
│   |   ├── application.js (可选)
│   |   └── agent.js (可选)
│   ├── service (可选)
│   └── middleware (可选)
│       └── mw.js
├── config
|   ├── config.default.js
│   ├── config.prod.js
|   ├── config.test.js (可选)
|   ├── config.local.js (可选)
|   └── config.unittest.js (可选)
└── test
    └── middleware
        └── mw.test.js</code></pre><p>那区别在哪儿呢？</p><ol><li><p>插件没有独立的 router 和 controller。这主要出于几点考虑：</p><ul><li>路由一般和应用强绑定的，不具备通用性。</li><li>一个应用可能依赖很多个插件，如果插件支持路由可能导致路由冲突。</li><li>如果确实有统一路由的需求，可以考虑在插件里通过中间件来实现。</li></ul></li><li><p>插件需要在 <code>package.json</code> 中的 <code>eggPlugin</code> 节点指定插件特有的信息：</p><ul><li><code>{String} name</code> - 插件名（必须配置），具有唯一性，配置依赖关系时会指定依赖插件的 name。</li><li><code>{Array} dependencies</code> - 当前插件强依赖的插件列表（如果依赖的插件没找到，应用启动失败）。</li><li><code>{Array} optionalDependencies</code> - 当前插件的可选依赖插件列表（如果依赖的插件未开启，只会 warning，不会影响应用启动）。</li><li><p><code>{Array} env</code> - 只有在指定运行环境才能开启，具体有哪些环境可以参考<a href="../basics/env.md">运行环境</a>。此配置是可选的，一般情况下都不需要配置。</p><pre><code class="language-json">{
  &quot;name&quot;: &quot;egg-rpc&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;rpc&quot;,
    &quot;dependencies&quot;: [ &quot;registry&quot; ],
    &quot;optionalDependencies&quot;: [ &quot;vip&quot; ],
    &quot;env&quot;: [ &quot;local&quot;, &quot;test&quot;, &quot;unittest&quot;, &quot;prod&quot; ]
  }
}</code></pre></li></ul></li><li><p>插件没有 <code>plugin.js</code>：</p><ul><li><code>eggPlugin.dependencies</code> 只是用于声明依赖关系，而不是引入插件或开启插件。</li><li>如果期望统一管理多个插件的开启和配置，可以在<a href="./framework.md">上层框架</a>处理。</li></ul></li></ol><h2 id="插件的依赖管理">插件的依赖管理</h2><p>和中间件不同，插件是自己管理依赖的。应用在加载所有插件前会预先从它们的 <code>package.json</code> 中读取 <code>eggPlugin &gt; dependencies</code> 和 <code>eggPlugin &gt; optionalDependencies</code> 节点，然后根据依赖关系计算出加载顺序，举个例子，下面三个插件的加载顺序就应该是 <code>c =&gt; b =&gt; a</code></p><pre><code class="language-json">// plugin a
{
  &quot;name&quot;: &quot;egg-plugin-a&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;a&quot;,
    &quot;dependencies&quot;: [ &quot;b&quot; ]
  }
}

// plugin b
{
  &quot;name&quot;: &quot;egg-plugin-b&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;b&quot;,
    &quot;optionalDependencies&quot;: [ &quot;c&quot; ]
  }
}

// plugin c
{
  &quot;name&quot;: &quot;egg-plugin-c&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;c&quot;
  }
}</code></pre><p><strong>注意：<code>dependencies</code> 和 <code>optionalDependencies</code> 的取值是另一个插件的 <code>eggPlugin.name</code>，而不是 <code>package name</code>。</strong></p><p><code>dependencies</code> 和 <code>optionalDependencies</code> 是从 <code>npm</code> 借鉴来的概念，大多数情况下我们都使用 <code>dependencies</code>，这也是我们最推荐的依赖方式。那什么时候可以用 <code>optionalDependencies</code> 呢？大致就两种：</p><ul><li>只在某些环境下才依赖，比如：一个鉴权插件，只在开发环境依赖一个 mock 数据的插件</li><li>弱依赖，比如：A 依赖 B，但是如果没有 B，A 有相应的降级方案</li></ul><p>需要特别强调的是：如果采用 <code>optionalDependencies</code> 那么框架不会校验依赖的插件是否开启，它的作用仅仅是计算加载顺序。所以，这时候依赖方需要通过『接口探测』等方式来决定相应的处理逻辑。</p><h2 id="插件能做什么">插件能做什么？</h2><p>上面给出了插件的定义，那插件到底能做什么？</p><h3 id="扩展内置对象的接口">扩展内置对象的接口</h3><p>在插件相应的文件内对框架内置对象进行扩展，和应用一样</p><ul><li><code>app/extend/request.js</code> - 扩展 Koa#Request 类</li><li><code>app/extend/response.js</code> - 扩展 Koa#Response 类</li><li><code>app/extend/context.js</code> - 扩展 Koa#Context 类</li><li><code>app/extend/helper.js</code> - 扩展 Helper 类</li><li><code>app/extend/application.js</code> - 扩展 Application 类</li><li><code>app/extend/agent.js</code> - 扩展 Agent 类</li></ul><h3 id="插入自定义中间件">插入自定义中间件</h3><ol><li><p>首先在 <code>app/middleware</code> 目录下定义好中间件实现</p><pre><code class="language-js">&#x27;use strict&#x27;;

const staticCache = require(&#x27;koa-static-cache&#x27;);
const assert = require(&#x27;assert&#x27;);
const mkdirp = require(&#x27;mkdirp&#x27;);

module.exports = (options, app) =&gt; {
  assert.strictEqual(typeof options.dir, &#x27;string&#x27;, &#x27;Must set `app.config.static.dir` when static plugin enable&#x27;);

  // ensure directory exists
  mkdirp.sync(options.dir);

  app.loggers.coreLogger.info(&#x27;[egg-static] starting static serve %s -&gt; %s&#x27;, options.prefix, options.dir);

  return staticCache(options);
};</code></pre></li><li><p>在 <code>app.js</code> 中将中间件插入到合适的位置（例如：下面将 static 中间件放到 bodyParser 之前）</p><pre><code class="language-js">const assert = require(&#x27;assert&#x27;);

module.exports = app =&gt; {
  // 将 static 中间件放到 bodyParser 之前
  const index = app.config.coreMiddleware.indexOf(&#x27;bodyParser&#x27;);
  assert(index &gt;= 0, &#x27;bodyParser 中间件必须存在&#x27;);

  app.config.coreMiddleware.splice(index, 0, &#x27;static&#x27;);
};</code></pre></li></ol><h3 id="在应用启动时做一些初始化工作">在应用启动时做一些初始化工作</h3><ul><li><p>我在启动前想读取一些本地配置</p><pre><code class="language-js">// ${plugin_root}/app.js
const fs = require(&#x27;fs&#x27;);
const path = require(&#x27;path&#x27;);

module.exports = app =&gt; {
  app.customData = fs.readFileSync(path.join(app.config.baseDir, &#x27;data.bin&#x27;));

  app.coreLogger.info(&#x27;read data ok&#x27;);
};</code></pre></li><li><p>如果有异步启动逻辑，可以使用 <code>app.beforeStart</code> API</p><pre><code class="language-js">// ${plugin_root}/app.js
const MyClient = require(&#x27;my-client&#x27;);

module.exports = app =&gt; {
  app.myClient = new MyClient();
  app.myClient.on(&#x27;error&#x27;, err =&gt; {
    app.coreLogger.error(err);
  });
  app.beforeStart(async () =&gt; {
    await app.myClient.ready();
    app.coreLogger.info(&#x27;my client is ready&#x27;);
  });
};</code></pre></li><li><p>也可以添加 agent 启动逻辑，使用 <code>agent.beforeStart</code> API</p><pre><code class="language-js">// ${plugin_root}/agent.js
const MyClient = require(&#x27;my-client&#x27;);

module.exports = agent =&gt; {
  agent.myClient = new MyClient();
  agent.myClient.on(&#x27;error&#x27;, err =&gt; {
    agent.coreLogger.error(err);
  });
  agent.beforeStart(async () =&gt; {
    await agent.myClient.ready();
    agent.coreLogger.info(&#x27;my client is ready&#x27;);
  });
};</code></pre></li></ul><h3 id="设置定时任务">设置定时任务</h3><ol><li><p>在 <code>package.json</code> 里设置依赖 schedule 插件</p><pre><code class="language-json">{
  &quot;name&quot;: &quot;your-plugin&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;your-plugin&quot;,
    &quot;dependencies&quot;: [ &quot;schedule&quot; ]
  }
}</code></pre></li><li><p>在 <code>${plugin_root}/app/schedule/</code> 目录下新建文件，编写你的定时任务</p><pre><code class="language-js">exports.schedule = {
  type: &#x27;worker&#x27;,
  cron: &#x27;0 0 3 * * *&#x27;,
  // interval: &#x27;1h&#x27;,
  // immediate: true,
};

exports.task = async ctx =&gt; {
  // your logic code
};</code></pre></li></ol><h3 id="全局实例插件的最佳实践">全局实例插件的最佳实践</h3><p>许多插件的目的都是将一些已有的服务引入到框架中，如 <a href="https://github.com/eggjs/egg-mysql">egg-mysql</a>, <a href="https://github.com/eggjs/egg-oss">egg-oss</a>。他们都需要在 app 上创建对应的实例。而在开发这一类的插件时，我们发现存在一些普遍性的问题：</p><ul><li>在一个应用中同时使用同一个服务的不同实例（连接到两个不同的 MySQL 数据库）。</li><li>从其他服务获取配置后动态初始化连接（从配置中心获取到 MySQL 服务地址后再建立连接）。</li></ul><p>如果让插件各自实现，可能会出现各种奇怪的配置方式和初始化方式，所以框架提供了 <code>app.addSingleton(name, creator)</code> 方法来统一这一类服务的创建。需要注意的是在使用 <code>app.addSingleton(name, creator)</code> 方法时，配置文件中一定要有 <code>client</code> 或者 <code>clients</code> 为 key 的配置作为传入 <code>creator</code> 函数 的 <code>config</code>。</p><h4 id="插件写法">插件写法</h4><p>我们将 <a href="https://github.com/eggjs/egg-mysql">egg-mysql</a> 的实现简化之后来看看如何编写此类插件：</p><pre><code class="language-js">// egg-mysql/app.js
module.exports = app =&gt; {
  // 第一个参数 mysql 指定了挂载到 app 上的字段，我们可以通过 `app.mysql` 访问到 MySQL singleton 实例
  // 第二个参数 createMysql 接受两个参数(config, app)，并返回一个 MySQL 的实例
  app.addSingleton(&#x27;mysql&#x27;, createMysql);
}

/**
 * @param  {Object} config   框架处理之后的配置项，如果应用配置了多个 MySQL 实例，会将每一个配置项分别传入并调用多次 createMysql
 * @param  {Application} app 当前的应用
 * @return {Object}          返回创建的 MySQL 实例
 */
function createMysql(config, app) {
  assert(config.host &amp;&amp; config.port &amp;&amp; config.user &amp;&amp; config.database);
  // 创建实例
  const client = new Mysql(config);

  // 做启动应用前的检查
  app.beforeStart(async () =&gt; {
    const rows = await client.query(&#x27;select now() as currentTime;&#x27;);
    app.coreLogger.info(`[egg-mysql] init instance success, rds currentTime: ${rows[0].currentTime}`);
  });

  return client;
}</code></pre><p>初始化方法也支持 <code>Async function</code>，便于有些特殊的插件需要异步化获取一些配置文件：</p><pre><code class="language-js">async function createMysql(config, app) {
  // 异步获取 mysql 配置
  const mysqlConfig = await app.configManager.getMysqlConfig(config.mysql);
  assert(mysqlConfig.host &amp;&amp; mysqlConfig.port &amp;&amp; mysqlConfig.user &amp;&amp; mysqlConfig.database);
  // 创建实例
  const client = new Mysql(mysqlConfig);

  // 做启动应用前的检查
  const rows = await client.query(&#x27;select now() as currentTime;&#x27;);
  app.coreLogger.info(`[egg-mysql] init instance success, rds currentTime: ${rows[0].currentTime}`);

  return client;
}</code></pre><p>可以看到，插件中我们只需要提供要挂载的字段以及对应服务的初始化方法，所有的配置管理、实例获取方式都由框架封装并统一提供了。</p><h4 id="应用层使用方案">应用层使用方案</h4><h5 id="单实例">单实例</h5><ol><li><p>在配置文件中声明 MySQL 的配置。</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  mysql: {
    client: {
      host: &#x27;mysql.com&#x27;,
      port: &#x27;3306&#x27;,
      user: &#x27;test_user&#x27;,
      password: &#x27;test_password&#x27;,
      database: &#x27;test&#x27;,
    },
  },
};</code></pre></li><li><p>直接通过 <code>app.mysql</code> 访问数据库。</p><pre><code class="language-js">// app/controller/post.js
class PostController extends Controller {
  async list() {
    const posts = await this.app.mysql.query(sql, values);
  },
}</code></pre></li></ol><h5 id="多实例">多实例</h5><ol><li><p>同样需要在配置文件中声明 MySQL 的配置，不过和单实例时不同，配置项中需要有一个 <code>clients</code> 字段，分别申明不同实例的配置，同时可以通过 <code>default</code> 字段来配置多个实例中共享的配置（如 host 和 port）。需要注意的是在这种情况下要用 <code>get</code> 方法指定相应的实例。（例如：使用 <code>app.mysql.get(&#x27;db1&#x27;).query()</code>，而不是直接使用 <code>app.mysql.query()</code> 得到一个 <code>undefined</code>）。</p><pre><code class="language-js">// config/config.default.js
exports.mysql = {
  clients: {
    // clientId, access the client instance by app.mysql.get(&#x27;clientId&#x27;)
    db1: {
      user: &#x27;user1&#x27;,
      password: &#x27;upassword1&#x27;,
      database: &#x27;db1&#x27;,
    },
    db2: {
      user: &#x27;user2&#x27;,
      password: &#x27;upassword2&#x27;,
      database: &#x27;db2&#x27;,
    },
  },
  // default configuration for all databases
  default: {
    host: &#x27;mysql.com&#x27;,
    port: &#x27;3306&#x27;,
  },
};</code></pre></li><li><p>通过 <code>app.mysql.get(&#x27;db1&#x27;)</code> 来获取对应的实例并使用。</p><pre><code class="language-js">// app/controller/post.js
class PostController extends Controller {
  async list() {
    const posts = await this.app.mysql.get(&#x27;db1&#x27;).query(sql, values);
  },
}</code></pre></li></ol><h5 id="动态创建实例">动态创建实例</h5><p>我们可以不需要将配置提前申明在配置文件中，而是在应用运行时动态的初始化一个实例。</p><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  app.beforeStart(async () =&gt; {
    // 从配置中心获取 MySQL 的配置 { host, post, password, ... }
    const mysqlConfig = await app.configCenter.fetch(&#x27;mysql&#x27;);
    // 动态创建 MySQL 实例
    app.database = await app.mysql.createInstanceAsync(mysqlConfig);
  });
};</code></pre><p>通过 <code>app.database</code> 来使用这个实例。</p><pre><code class="language-js">// app/controller/post.js
class PostController extends Controller {
  async list() {
    const posts = await this.app.database.query(sql, values);
  },
}</code></pre><p><strong>注意，在动态创建实例的时候，框架也会读取配置中 <code>default</code> 字段内的配置项作为默认配置。</strong></p><h3 id="插件的寻址规则">插件的寻址规则</h3><p>框架在加载插件的时候，遵循下面的寻址规则：</p><ul><li>如果配置了 path，直接按照 path 加载</li><li><p>没有 path 根据 package 名去查找，查找的顺序依次是</p><ol><li>应用根目录下的 <code>node_modules</code></li><li>应用依赖框架路径下的 <code>node_modules</code></li><li>当前路径下的 <code>node_modules</code> （主要是兼容单元测试场景）</li></ol></li></ul><h3 id="插件规范">插件规范</h3><p>我们非常欢迎您贡献新的插件，同时也希望您遵守下面一些规范：</p><ul><li>命名规范<ul><li><code>npm</code> 包名以 <code>egg-</code> 开头，且为全小写，例如：<code>egg-xx</code>。比较长的词组用中划线：<code>egg-foo-bar</code></li><li>对应的插件名使用小驼峰，小驼峰转换规则以 <code>npm</code> 包名的中划线为准 <code>egg-foo-bar</code> =&gt; <code>fooBar</code></li><li>对于可以中划线也可以不用的情况，不做强制约定，例如：userservice(egg-userservice) 还是 user-service(egg-user-service) 都可以</li></ul></li><li><p><code>package.json</code> 书写规范</p><ul><li>按照上面的文档添加 <code>eggPlugin</code> 节点</li><li><p>在 <code>keywords</code> 里加上 <code>egg</code>、<code>egg-plugin</code>、<code>eggPlugin</code> 等关键字，便于索引</p><pre><code class="language-json">{
  &quot;name&quot;: &quot;egg-view-nunjucks&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;view plugin for egg&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;nunjucks&quot;,
    &quot;dep&quot;: [
      &quot;security&quot;
    ]
  },
  &quot;keywords&quot;: [
    &quot;egg&quot;,
    &quot;egg-plugin&quot;,
    &quot;eggPlugin&quot;,
    &quot;egg-plugin-view&quot;,
    &quot;egg-view&quot;,
    &quot;nunjucks&quot;
  ],
}</code></pre></li></ul></li></ul><h2 id="为何不使用-npm-包名来做插件名">为何不使用 npm 包名来做插件名？</h2><p>Egg 是通过 <code>eggPlugin.name</code> 来定义插件名的，只在应用或框架具备唯一性，也就是说<strong>多个 npm 包可能有相同的插件名</strong>，为什么这么设计呢？</p><p>首先 Egg 插件不仅仅支持 npm 包，还支持通过目录来找插件。在<a href="../tutorials/progressive.md">渐进式开发</a>章节提到如何使用这两个配置来进行代码演进。目录对单元测试也比较友好。所以 Egg 无法通过 npm 的包名来做唯一性。</p><p>更重要的是 Egg 可以使用这种特性来做适配器。比如<a href="./view-plugin.md#插件命名规范">模板开发规范</a>定义的插件名为 view，而存在 <code>egg-view-nunjucks</code>，<code>egg-view-react</code> 等插件，使用者只需要更换插件和修改模板，不需要动 Controller， 因为所有的模板插件都实现了相同的 API。</p><p><strong>将相同功能的插件赋予相同的插件名，具备相同的 API，可以快速切换</strong>。这在模板、数据库等领域非常适用。</p></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91">插件开发</a><ul><li><a href="#%E4%BD%BF%E7%94%A8%E8%84%9A%E6%89%8B%E6%9E%B6%E5%BF%AB%E9%80%9F%E5%BC%80%E5%8F%91">使用脚手架快速开发</a></li></ul></li><li><a href="#%E6%8F%92%E4%BB%B6%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84">插件的目录结构</a></li><li><a href="#%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86">插件的依赖管理</a></li><li><a href="#%E6%8F%92%E4%BB%B6%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88">插件能做什么？</a><ul><li><a href="#%E6%89%A9%E5%B1%95%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%8E%A5%E5%8F%A3">扩展内置对象的接口</a></li><li><a href="#%E6%8F%92%E5%85%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6">插入自定义中间件</a></li><li><a href="#%E5%9C%A8%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%97%B6%E5%81%9A%E4%B8%80%E4%BA%9B%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B7%A5%E4%BD%9C">在应用启动时做一些初始化工作</a></li><li><a href="#%E8%AE%BE%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1">设置定时任务</a></li><li><a href="#%E5%85%A8%E5%B1%80%E5%AE%9E%E4%BE%8B%E6%8F%92%E4%BB%B6%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">全局实例插件的最佳实践</a><ul><li><a href="#%E6%8F%92%E4%BB%B6%E5%86%99%E6%B3%95">插件写法</a></li><li><a href="#%E5%BA%94%E7%94%A8%E5%B1%82%E4%BD%BF%E7%94%A8%E6%96%B9%E6%A1%88">应用层使用方案</a><ul><li><a href="#%E5%8D%95%E5%AE%9E%E4%BE%8B">单实例</a></li><li><a href="#%E5%A4%9A%E5%AE%9E%E4%BE%8B">多实例</a></li><li><a href="#%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B">动态创建实例</a></li></ul></li></ul></li><li><a href="#%E6%8F%92%E4%BB%B6%E7%9A%84%E5%AF%BB%E5%9D%80%E8%A7%84%E5%88%99">插件的寻址规则</a></li><li><a href="#%E6%8F%92%E4%BB%B6%E8%A7%84%E8%8C%83">插件规范</a></li></ul></li><li><a href="#%E4%B8%BA%E4%BD%95%E4%B8%8D%E4%BD%BF%E7%94%A8-npm-%E5%8C%85%E5%90%8D%E6%9D%A5%E5%81%9A%E6%8F%92%E4%BB%B6%E5%90%8D">为何不使用 npm 包名来做插件名？</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E5%25BC%2580%25E5%258F%2591)%0A%20%20*%20%5B%E4%BD%BF%E7%94%A8%E8%84%9A%E6%89%8B%E6%9E%B6%E5%BF%AB%E9%80%9F%E5%BC%80%E5%8F%91%5D(%23%25E4%25BD%25BF%25E7%2594%25A8%25E8%2584%259A%25E6%2589%258B%25E6%259E%25B6%25E5%25BF%25AB%25E9%2580%259F%25E5%25BC%2580%25E5%258F%2591)%0A-%20%5B%E6%8F%92%E4%BB%B6%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E7%259A%2584%25E7%259B%25AE%25E5%25BD%2595%25E7%25BB%2593%25E6%259E%2584)%0A-%20%5B%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E7%259A%2584%25E4%25BE%259D%25E8%25B5%2596%25E7%25AE%25A1%25E7%2590%2586)%0A-%20%5B%E6%8F%92%E4%BB%B6%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88%EF%BC%9F%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E8%2583%25BD%25E5%2581%259A%25E4%25BB%2580%25E4%25B9%2588)%0A%20%20*%20%5B%E6%89%A9%E5%B1%95%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%8E%A5%E5%8F%A3%5D(%23%25E6%2589%25A9%25E5%25B1%2595%25E5%2586%2585%25E7%25BD%25AE%25E5%25AF%25B9%25E8%25B1%25A1%25E7%259A%2584%25E6%258E%25A5%25E5%258F%25A3)%0A%20%20*%20%5B%E6%8F%92%E5%85%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6%5D(%23%25E6%258F%2592%25E5%2585%25A5%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589%25E4%25B8%25AD%25E9%2597%25B4%25E4%25BB%25B6)%0A%20%20*%20%5B%E5%9C%A8%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%97%B6%E5%81%9A%E4%B8%80%E4%BA%9B%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B7%A5%E4%BD%9C%5D(%23%25E5%259C%25A8%25E5%25BA%2594%25E7%2594%25A8%25E5%2590%25AF%25E5%258A%25A8%25E6%2597%25B6%25E5%2581%259A%25E4%25B8%2580%25E4%25BA%259B%25E5%2588%259D%25E5%25A7%258B%25E5%258C%2596%25E5%25B7%25A5%25E4%25BD%259C)%0A%20%20*%20%5B%E8%AE%BE%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%5D(%23%25E8%25AE%25BE%25E7%25BD%25AE%25E5%25AE%259A%25E6%2597%25B6%25E4%25BB%25BB%25E5%258A%25A1)%0A%20%20*%20%5B%E5%85%A8%E5%B1%80%E5%AE%9E%E4%BE%8B%E6%8F%92%E4%BB%B6%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%5D(%23%25E5%2585%25A8%25E5%25B1%2580%25E5%25AE%259E%25E4%25BE%258B%25E6%258F%2592%25E4%25BB%25B6%25E7%259A%2584%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5)%0A%20%20%20%20%2B%20%5B%E6%8F%92%E4%BB%B6%E5%86%99%E6%B3%95%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E5%2586%2599%25E6%25B3%2595)%0A%20%20%20%20%2B%20%5B%E5%BA%94%E7%94%A8%E5%B1%82%E4%BD%BF%E7%94%A8%E6%96%B9%E6%A1%88%5D(%23%25E5%25BA%2594%25E7%2594%25A8%25E5%25B1%2582%25E4%25BD%25BF%25E7%2594%25A8%25E6%2596%25B9%25E6%25A1%2588)%0A%20%20%20%20%20%20-%20%5B%E5%8D%95%E5%AE%9E%E4%BE%8B%5D(%23%25E5%258D%2595%25E5%25AE%259E%25E4%25BE%258B)%0A%20%20%20%20%20%20-%20%5B%E5%A4%9A%E5%AE%9E%E4%BE%8B%5D(%23%25E5%25A4%259A%25E5%25AE%259E%25E4%25BE%258B)%0A%20%20%20%20%20%20-%20%5B%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%5D(%23%25E5%258A%25A8%25E6%2580%2581%25E5%2588%259B%25E5%25BB%25BA%25E5%25AE%259E%25E4%25BE%258B)%0A%20%20*%20%5B%E6%8F%92%E4%BB%B6%E7%9A%84%E5%AF%BB%E5%9D%80%E8%A7%84%E5%88%99%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E7%259A%2584%25E5%25AF%25BB%25E5%259D%2580%25E8%25A7%2584%25E5%2588%2599)%0A%20%20*%20%5B%E6%8F%92%E4%BB%B6%E8%A7%84%E8%8C%83%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E8%25A7%2584%25E8%258C%2583)%0A-%20%5B%E4%B8%BA%E4%BD%95%E4%B8%8D%E4%BD%BF%E7%94%A8%20npm%20%E5%8C%85%E5%90%8D%E6%9D%A5%E5%81%9A%E6%8F%92%E4%BB%B6%E5%90%8D%EF%BC%9F%5D(%23%25E4%25B8%25BA%25E4%25BD%2595%25E4%25B8%258D%25E4%25BD%25BF%25E7%2594%25A8-npm-%25E5%258C%2585%25E5%2590%258D%25E6%259D%25A5%25E5%2581%259A%25E6%258F%2592%25E4%25BB%25B6%25E5%2590%258D)","meta":{"info":{"title":"插件开发"}},"content":"%0A%0A%0A%E6%8F%92%E4%BB%B6%E6%9C%BA%E5%88%B6%E6%98%AF%E6%88%91%E4%BB%AC%E6%A1%86%E6%9E%B6%E7%9A%84%E4%B8%80%E5%A4%A7%E7%89%B9%E8%89%B2%E3%80%82%E5%AE%83%E4%B8%8D%E4%BD%86%E5%8F%AF%E4%BB%A5%E4%BF%9D%E8%AF%81%E6%A1%86%E6%9E%B6%E6%A0%B8%E5%BF%83%E7%9A%84%E8%B6%B3%E5%A4%9F%E7%B2%BE%E7%AE%80%E3%80%81%E7%A8%B3%E5%AE%9A%E3%80%81%E9%AB%98%E6%95%88%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E4%BF%83%E8%BF%9B%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E7%9A%84%E5%A4%8D%E7%94%A8%EF%BC%8C%E7%94%9F%E6%80%81%E5%9C%88%E7%9A%84%E5%BD%A2%E6%88%90%E3%80%82%E6%9C%89%E4%BA%BA%E5%8F%AF%E8%83%BD%E4%BC%9A%E9%97%AE%E4%BA%86%0A%0A-%20Koa%20%E5%B7%B2%E7%BB%8F%E6%9C%89%E4%BA%86%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E6%9C%BA%E5%88%B6%EF%BC%8C%E4%B8%BA%E5%95%A5%E8%BF%98%E8%A6%81%E6%8F%92%E4%BB%B6%E5%91%A2%EF%BC%9F%0A-%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E3%80%81%E6%8F%92%E4%BB%B6%E3%80%81%E5%BA%94%E7%94%A8%E5%AE%83%E4%BB%AC%E4%B9%8B%E9%97%B4%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB%EF%BC%8C%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F%0A-%20%E6%88%91%E8%AF%A5%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6%EF%BC%9F%0A-%20%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6%EF%BC%9F%0A-%20...%0A%0A%E5%9C%A8%5B%E4%BD%BF%E7%94%A8%E6%8F%92%E4%BB%B6%5D(..%2Fbasics%2Fplugin.md)%E7%AB%A0%E8%8A%82%E6%88%91%E4%BB%AC%E5%B7%B2%E7%BB%8F%E8%AE%A8%E8%AE%BA%E8%BF%87%E5%89%8D%E5%87%A0%E7%82%B9%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E6%88%91%E4%BB%AC%E6%9D%A5%E7%9C%8B%E7%9C%8B%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6%E3%80%82%0A%0A%23%23%20%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%0A%0A%23%23%23%20%E4%BD%BF%E7%94%A8%E8%84%9A%E6%89%8B%E6%9E%B6%E5%BF%AB%E9%80%9F%E5%BC%80%E5%8F%91%0A%0A%E4%BD%A0%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E9%80%9A%E8%BF%87%20%5Begg-init%5D%20%E9%80%89%E6%8B%A9%20%5Bplugin%5D%5Begg-boilerplate-plugin%5D%20%E8%84%9A%E6%89%8B%E6%9E%B6%E6%9D%A5%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E3%80%82%0A%0A%60%60%60bash%0A%24%20egg-init%20--type%3Dplugin%20egg-hello%0A%24%20cd%20egg-hello%0A%24%20npm%20i%0A%24%20npm%20test%0A%60%60%60%0A%0A%23%23%20%E6%8F%92%E4%BB%B6%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%0A%0A%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E3%80%8E%E8%BF%B7%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E3%80%8F%EF%BC%8C%E4%B8%8B%E9%9D%A2%E5%B1%95%E7%A4%BA%E7%9A%84%E6%98%AF%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%EF%BC%8C%E5%92%8C%E5%BA%94%E7%94%A8%EF%BC%88app%EF%BC%89%E5%87%A0%E4%B9%8E%E4%B8%80%E6%A0%B7%E3%80%82%0A%0A%60%60%60js%0A.%20egg-hello%0A%E2%94%9C%E2%94%80%E2%94%80%20package.json%0A%E2%94%9C%E2%94%80%E2%94%80%20app.js%20(%E5%8F%AF%E9%80%89)%0A%E2%94%9C%E2%94%80%E2%94%80%20agent.js%20(%E5%8F%AF%E9%80%89)%0A%E2%94%9C%E2%94%80%E2%94%80%20app%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20extend%20(%E5%8F%AF%E9%80%89)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20helper.js%20(%E5%8F%AF%E9%80%89)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20request.js%20(%E5%8F%AF%E9%80%89)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20response.js%20(%E5%8F%AF%E9%80%89)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20context.js%20(%E5%8F%AF%E9%80%89)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20application.js%20(%E5%8F%AF%E9%80%89)%0A%E2%94%82%20%20%20%7C%20%20%20%E2%94%94%E2%94%80%E2%94%80%20agent.js%20(%E5%8F%AF%E9%80%89)%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20service%20(%E5%8F%AF%E9%80%89)%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20middleware%20(%E5%8F%AF%E9%80%89)%0A%E2%94%82%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20mw.js%0A%E2%94%9C%E2%94%80%E2%94%80%20config%0A%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20config.default.js%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20config.prod.js%0A%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20config.test.js%20(%E5%8F%AF%E9%80%89)%0A%7C%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20config.local.js%20(%E5%8F%AF%E9%80%89)%0A%7C%20%20%20%E2%94%94%E2%94%80%E2%94%80%20config.unittest.js%20(%E5%8F%AF%E9%80%89)%0A%E2%94%94%E2%94%80%E2%94%80%20test%0A%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20middleware%0A%20%20%20%20%20%20%20%20%E2%94%94%E2%94%80%E2%94%80%20mw.test.js%0A%60%60%60%0A%0A%E9%82%A3%E5%8C%BA%E5%88%AB%E5%9C%A8%E5%93%AA%E5%84%BF%E5%91%A2%EF%BC%9F%0A%0A1.%20%E6%8F%92%E4%BB%B6%E6%B2%A1%E6%9C%89%E7%8B%AC%E7%AB%8B%E7%9A%84%20router%20%E5%92%8C%20controller%E3%80%82%E8%BF%99%E4%B8%BB%E8%A6%81%E5%87%BA%E4%BA%8E%E5%87%A0%E7%82%B9%E8%80%83%E8%99%91%EF%BC%9A%0A%0A%20%20%20%20-%20%E8%B7%AF%E7%94%B1%E4%B8%80%E8%88%AC%E5%92%8C%E5%BA%94%E7%94%A8%E5%BC%BA%E7%BB%91%E5%AE%9A%E7%9A%84%EF%BC%8C%E4%B8%8D%E5%85%B7%E5%A4%87%E9%80%9A%E7%94%A8%E6%80%A7%E3%80%82%0A%20%20%20%20-%20%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8%E5%8F%AF%E8%83%BD%E4%BE%9D%E8%B5%96%E5%BE%88%E5%A4%9A%E4%B8%AA%E6%8F%92%E4%BB%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%8F%92%E4%BB%B6%E6%94%AF%E6%8C%81%E8%B7%AF%E7%94%B1%E5%8F%AF%E8%83%BD%E5%AF%BC%E8%87%B4%E8%B7%AF%E7%94%B1%E5%86%B2%E7%AA%81%E3%80%82%0A%20%20%20%20-%20%E5%A6%82%E6%9E%9C%E7%A1%AE%E5%AE%9E%E6%9C%89%E7%BB%9F%E4%B8%80%E8%B7%AF%E7%94%B1%E7%9A%84%E9%9C%80%E6%B1%82%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%80%83%E8%99%91%E5%9C%A8%E6%8F%92%E4%BB%B6%E9%87%8C%E9%80%9A%E8%BF%87%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%9D%A5%E5%AE%9E%E7%8E%B0%E3%80%82%0A%0A2.%20%E6%8F%92%E4%BB%B6%E9%9C%80%E8%A6%81%E5%9C%A8%20%60package.json%60%20%E4%B8%AD%E7%9A%84%20%60eggPlugin%60%20%E8%8A%82%E7%82%B9%E6%8C%87%E5%AE%9A%E6%8F%92%E4%BB%B6%E7%89%B9%E6%9C%89%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%9A%0A%0A%20%20%20%20-%20%60%7BString%7D%20name%60%20-%20%E6%8F%92%E4%BB%B6%E5%90%8D%EF%BC%88%E5%BF%85%E9%A1%BB%E9%85%8D%E7%BD%AE%EF%BC%89%EF%BC%8C%E5%85%B7%E6%9C%89%E5%94%AF%E4%B8%80%E6%80%A7%EF%BC%8C%E9%85%8D%E7%BD%AE%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB%E6%97%B6%E4%BC%9A%E6%8C%87%E5%AE%9A%E4%BE%9D%E8%B5%96%E6%8F%92%E4%BB%B6%E7%9A%84%20name%E3%80%82%0A%20%20%20%20-%20%60%7BArray%7D%20dependencies%60%20-%20%E5%BD%93%E5%89%8D%E6%8F%92%E4%BB%B6%E5%BC%BA%E4%BE%9D%E8%B5%96%E7%9A%84%E6%8F%92%E4%BB%B6%E5%88%97%E8%A1%A8%EF%BC%88%E5%A6%82%E6%9E%9C%E4%BE%9D%E8%B5%96%E7%9A%84%E6%8F%92%E4%BB%B6%E6%B2%A1%E6%89%BE%E5%88%B0%EF%BC%8C%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%EF%BC%89%E3%80%82%0A%20%20%20%20-%20%60%7BArray%7D%20optionalDependencies%60%20-%20%E5%BD%93%E5%89%8D%E6%8F%92%E4%BB%B6%E7%9A%84%E5%8F%AF%E9%80%89%E4%BE%9D%E8%B5%96%E6%8F%92%E4%BB%B6%E5%88%97%E8%A1%A8%EF%BC%88%E5%A6%82%E6%9E%9C%E4%BE%9D%E8%B5%96%E7%9A%84%E6%8F%92%E4%BB%B6%E6%9C%AA%E5%BC%80%E5%90%AF%EF%BC%8C%E5%8F%AA%E4%BC%9A%20warning%EF%BC%8C%E4%B8%8D%E4%BC%9A%E5%BD%B1%E5%93%8D%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%EF%BC%89%E3%80%82%0A%20%20%20%20-%20%60%7BArray%7D%20env%60%20-%20%E5%8F%AA%E6%9C%89%E5%9C%A8%E6%8C%87%E5%AE%9A%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%89%8D%E8%83%BD%E5%BC%80%E5%90%AF%EF%BC%8C%E5%85%B7%E4%BD%93%E6%9C%89%E5%93%AA%E4%BA%9B%E7%8E%AF%E5%A2%83%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83%5B%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%5D(..%2Fbasics%2Fenv.md)%E3%80%82%E6%AD%A4%E9%85%8D%E7%BD%AE%E6%98%AF%E5%8F%AF%E9%80%89%E7%9A%84%EF%BC%8C%E4%B8%80%E8%88%AC%E6%83%85%E5%86%B5%E4%B8%8B%E9%83%BD%E4%B8%8D%E9%9C%80%E8%A6%81%E9%85%8D%E7%BD%AE%E3%80%82%0A%0A%20%20%20%20%20%20%60%60%60json%0A%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%22name%22%3A%20%22egg-rpc%22%2C%0A%20%20%20%20%20%20%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%22name%22%3A%20%22rpc%22%2C%0A%20%20%20%20%20%20%20%20%20%20%22dependencies%22%3A%20%5B%20%22registry%22%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%22optionalDependencies%22%3A%20%5B%20%22vip%22%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%22env%22%3A%20%5B%20%22local%22%2C%20%22test%22%2C%20%22unittest%22%2C%20%22prod%22%20%5D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%60%60%60%0A%0A%20%203.%20%E6%8F%92%E4%BB%B6%E6%B2%A1%E6%9C%89%20%60plugin.js%60%EF%BC%9A%0A%0A%20%20%20%20%20-%20%60eggPlugin.dependencies%60%20%E5%8F%AA%E6%98%AF%E7%94%A8%E4%BA%8E%E5%A3%B0%E6%98%8E%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%BC%95%E5%85%A5%E6%8F%92%E4%BB%B6%E6%88%96%E5%BC%80%E5%90%AF%E6%8F%92%E4%BB%B6%E3%80%82%0A%20%20%20%20%20-%20%E5%A6%82%E6%9E%9C%E6%9C%9F%E6%9C%9B%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86%E5%A4%9A%E4%B8%AA%E6%8F%92%E4%BB%B6%E7%9A%84%E5%BC%80%E5%90%AF%E5%92%8C%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8%5B%E4%B8%8A%E5%B1%82%E6%A1%86%E6%9E%B6%5D(.%2Fframework.md)%E5%A4%84%E7%90%86%E3%80%82%0A%0A%23%23%20%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86%0A%0A%E5%92%8C%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B8%8D%E5%90%8C%EF%BC%8C%E6%8F%92%E4%BB%B6%E6%98%AF%E8%87%AA%E5%B7%B1%E7%AE%A1%E7%90%86%E4%BE%9D%E8%B5%96%E7%9A%84%E3%80%82%E5%BA%94%E7%94%A8%E5%9C%A8%E5%8A%A0%E8%BD%BD%E6%89%80%E6%9C%89%E6%8F%92%E4%BB%B6%E5%89%8D%E4%BC%9A%E9%A2%84%E5%85%88%E4%BB%8E%E5%AE%83%E4%BB%AC%E7%9A%84%20%60package.json%60%20%E4%B8%AD%E8%AF%BB%E5%8F%96%20%60eggPlugin%20%3E%20dependencies%60%20%E5%92%8C%20%60eggPlugin%20%3E%20optionalDependencies%60%20%E8%8A%82%E7%82%B9%EF%BC%8C%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB%E8%AE%A1%E7%AE%97%E5%87%BA%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F%EF%BC%8C%E4%B8%BE%E4%B8%AA%E4%BE%8B%E5%AD%90%EF%BC%8C%E4%B8%8B%E9%9D%A2%E4%B8%89%E4%B8%AA%E6%8F%92%E4%BB%B6%E7%9A%84%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F%E5%B0%B1%E5%BA%94%E8%AF%A5%E6%98%AF%20%60c%20%3D%3E%20b%20%3D%3E%20a%60%0A%0A%60%60%60json%0A%2F%2F%20plugin%20a%0A%7B%0A%20%20%22name%22%3A%20%22egg-plugin-a%22%2C%0A%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%22name%22%3A%20%22a%22%2C%0A%20%20%20%20%22dependencies%22%3A%20%5B%20%22b%22%20%5D%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20plugin%20b%0A%7B%0A%20%20%22name%22%3A%20%22egg-plugin-b%22%2C%0A%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%22name%22%3A%20%22b%22%2C%0A%20%20%20%20%22optionalDependencies%22%3A%20%5B%20%22c%22%20%5D%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20plugin%20c%0A%7B%0A%20%20%22name%22%3A%20%22egg-plugin-c%22%2C%0A%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%22name%22%3A%20%22c%22%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A**%E6%B3%A8%E6%84%8F%EF%BC%9A%60dependencies%60%20%E5%92%8C%20%60optionalDependencies%60%20%E7%9A%84%E5%8F%96%E5%80%BC%E6%98%AF%E5%8F%A6%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6%E7%9A%84%20%60eggPlugin.name%60%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%20%60package%20name%60%E3%80%82**%0A%0A%60dependencies%60%20%E5%92%8C%20%60optionalDependencies%60%20%E6%98%AF%E4%BB%8E%20%60npm%60%20%E5%80%9F%E9%89%B4%E6%9D%A5%E7%9A%84%E6%A6%82%E5%BF%B5%EF%BC%8C%E5%A4%A7%E5%A4%9A%E6%95%B0%E6%83%85%E5%86%B5%E4%B8%8B%E6%88%91%E4%BB%AC%E9%83%BD%E4%BD%BF%E7%94%A8%20%60dependencies%60%EF%BC%8C%E8%BF%99%E4%B9%9F%E6%98%AF%E6%88%91%E4%BB%AC%E6%9C%80%E6%8E%A8%E8%8D%90%E7%9A%84%E4%BE%9D%E8%B5%96%E6%96%B9%E5%BC%8F%E3%80%82%E9%82%A3%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%8F%AF%E4%BB%A5%E7%94%A8%20%60optionalDependencies%60%20%E5%91%A2%EF%BC%9F%E5%A4%A7%E8%87%B4%E5%B0%B1%E4%B8%A4%E7%A7%8D%EF%BC%9A%0A%0A-%20%E5%8F%AA%E5%9C%A8%E6%9F%90%E4%BA%9B%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%89%8D%E4%BE%9D%E8%B5%96%EF%BC%8C%E6%AF%94%E5%A6%82%EF%BC%9A%E4%B8%80%E4%B8%AA%E9%89%B4%E6%9D%83%E6%8F%92%E4%BB%B6%EF%BC%8C%E5%8F%AA%E5%9C%A8%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E4%BE%9D%E8%B5%96%E4%B8%80%E4%B8%AA%20mock%20%E6%95%B0%E6%8D%AE%E7%9A%84%E6%8F%92%E4%BB%B6%0A-%20%E5%BC%B1%E4%BE%9D%E8%B5%96%EF%BC%8C%E6%AF%94%E5%A6%82%EF%BC%9AA%20%E4%BE%9D%E8%B5%96%20B%EF%BC%8C%E4%BD%86%E6%98%AF%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%20B%EF%BC%8CA%20%E6%9C%89%E7%9B%B8%E5%BA%94%E7%9A%84%E9%99%8D%E7%BA%A7%E6%96%B9%E6%A1%88%0A%0A%E9%9C%80%E8%A6%81%E7%89%B9%E5%88%AB%E5%BC%BA%E8%B0%83%E7%9A%84%E6%98%AF%EF%BC%9A%E5%A6%82%E6%9E%9C%E9%87%87%E7%94%A8%20%60optionalDependencies%60%20%E9%82%A3%E4%B9%88%E6%A1%86%E6%9E%B6%E4%B8%8D%E4%BC%9A%E6%A0%A1%E9%AA%8C%E4%BE%9D%E8%B5%96%E7%9A%84%E6%8F%92%E4%BB%B6%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AF%EF%BC%8C%E5%AE%83%E7%9A%84%E4%BD%9C%E7%94%A8%E4%BB%85%E4%BB%85%E6%98%AF%E8%AE%A1%E7%AE%97%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F%E3%80%82%E6%89%80%E4%BB%A5%EF%BC%8C%E8%BF%99%E6%97%B6%E5%80%99%E4%BE%9D%E8%B5%96%E6%96%B9%E9%9C%80%E8%A6%81%E9%80%9A%E8%BF%87%E3%80%8E%E6%8E%A5%E5%8F%A3%E6%8E%A2%E6%B5%8B%E3%80%8F%E7%AD%89%E6%96%B9%E5%BC%8F%E6%9D%A5%E5%86%B3%E5%AE%9A%E7%9B%B8%E5%BA%94%E7%9A%84%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91%E3%80%82%0A%0A%23%23%20%E6%8F%92%E4%BB%B6%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88%EF%BC%9F%0A%0A%E4%B8%8A%E9%9D%A2%E7%BB%99%E5%87%BA%E4%BA%86%E6%8F%92%E4%BB%B6%E7%9A%84%E5%AE%9A%E4%B9%89%EF%BC%8C%E9%82%A3%E6%8F%92%E4%BB%B6%E5%88%B0%E5%BA%95%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88%EF%BC%9F%0A%0A%23%23%23%20%E6%89%A9%E5%B1%95%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%8E%A5%E5%8F%A3%0A%0A%E5%9C%A8%E6%8F%92%E4%BB%B6%E7%9B%B8%E5%BA%94%E7%9A%84%E6%96%87%E4%BB%B6%E5%86%85%E5%AF%B9%E6%A1%86%E6%9E%B6%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1%E8%BF%9B%E8%A1%8C%E6%89%A9%E5%B1%95%EF%BC%8C%E5%92%8C%E5%BA%94%E7%94%A8%E4%B8%80%E6%A0%B7%0A%0A-%20%60app%2Fextend%2Frequest.js%60%20-%20%E6%89%A9%E5%B1%95%20Koa%23Request%20%E7%B1%BB%0A-%20%60app%2Fextend%2Fresponse.js%60%20-%20%E6%89%A9%E5%B1%95%20Koa%23Response%20%E7%B1%BB%0A-%20%60app%2Fextend%2Fcontext.js%60%20-%20%E6%89%A9%E5%B1%95%20Koa%23Context%20%E7%B1%BB%0A-%20%60app%2Fextend%2Fhelper.js%20%60%20-%20%E6%89%A9%E5%B1%95%20Helper%20%E7%B1%BB%0A-%20%60app%2Fextend%2Fapplication.js%60%20-%20%E6%89%A9%E5%B1%95%20Application%20%E7%B1%BB%0A-%20%60app%2Fextend%2Fagent.js%60%20-%20%E6%89%A9%E5%B1%95%20Agent%20%E7%B1%BB%0A%0A%23%23%23%20%E6%8F%92%E5%85%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6%0A%0A1.%20%E9%A6%96%E5%85%88%E5%9C%A8%20%60app%2Fmiddleware%60%20%E7%9B%AE%E5%BD%95%E4%B8%8B%E5%AE%9A%E4%B9%89%E5%A5%BD%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%9E%E7%8E%B0%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20'use%20strict'%3B%0A%0A%20%20%20%20const%20staticCache%20%3D%20require('koa-static-cache')%3B%0A%20%20%20%20const%20assert%20%3D%20require('assert')%3B%0A%20%20%20%20const%20mkdirp%20%3D%20require('mkdirp')%3B%0A%0A%20%20%20%20module.exports%20%3D%20(options%2C%20app)%20%3D%3E%20%7B%0A%20%20%20%20%20%20assert.strictEqual(typeof%20options.dir%2C%20'string'%2C%20'Must%20set%20%60app.config.static.dir%60%20when%20static%20plugin%20enable')%3B%0A%0A%20%20%20%20%20%20%2F%2F%20ensure%20directory%20exists%0A%20%20%20%20%20%20mkdirp.sync(options.dir)%3B%0A%0A%20%20%20%20%20%20app.loggers.coreLogger.info('%5Begg-static%5D%20starting%20static%20serve%20%25s%20-%3E%20%25s'%2C%20options.prefix%2C%20options.dir)%3B%0A%0A%20%20%20%20%20%20return%20staticCache(options)%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A2.%20%E5%9C%A8%20%60app.js%60%20%E4%B8%AD%E5%B0%86%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%8F%92%E5%85%A5%E5%88%B0%E5%90%88%E9%80%82%E7%9A%84%E4%BD%8D%E7%BD%AE%EF%BC%88%E4%BE%8B%E5%A6%82%EF%BC%9A%E4%B8%8B%E9%9D%A2%E5%B0%86%20static%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%94%BE%E5%88%B0%20bodyParser%20%E4%B9%8B%E5%89%8D%EF%BC%89%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20const%20assert%20%3D%20require('assert')%3B%0A%0A%20%20%20%20module.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E5%B0%86%20static%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%94%BE%E5%88%B0%20bodyParser%20%E4%B9%8B%E5%89%8D%0A%20%20%20%20%20%20const%20index%20%3D%20app.config.coreMiddleware.indexOf('bodyParser')%3B%0A%20%20%20%20%20%20assert(index%20%3E%3D%200%2C%20'bodyParser%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BF%85%E9%A1%BB%E5%AD%98%E5%9C%A8')%3B%0A%0A%20%20%20%20%20%20app.config.coreMiddleware.splice(index%2C%200%2C%20'static')%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A%23%23%23%20%E5%9C%A8%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%97%B6%E5%81%9A%E4%B8%80%E4%BA%9B%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B7%A5%E4%BD%9C%0A%0A-%20%E6%88%91%E5%9C%A8%E5%90%AF%E5%8A%A8%E5%89%8D%E6%83%B3%E8%AF%BB%E5%8F%96%E4%B8%80%E4%BA%9B%E6%9C%AC%E5%9C%B0%E9%85%8D%E7%BD%AE%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20%24%7Bplugin_root%7D%2Fapp.js%0A%20%20%20%20const%20fs%20%3D%20require('fs')%3B%0A%20%20%20%20const%20path%20%3D%20require('path')%3B%0A%0A%20%20%20%20module.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%20%20%20%20app.customData%20%3D%20fs.readFileSync(path.join(app.config.baseDir%2C%20'data.bin'))%3B%0A%0A%20%20%20%20%20%20app.coreLogger.info('read%20data%20ok')%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A-%20%E5%A6%82%E6%9E%9C%E6%9C%89%E5%BC%82%E6%AD%A5%E5%90%AF%E5%8A%A8%E9%80%BB%E8%BE%91%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%20%60app.beforeStart%60%20API%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20%24%7Bplugin_root%7D%2Fapp.js%0A%20%20%20%20const%20MyClient%20%3D%20require('my-client')%3B%0A%0A%20%20%20%20module.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%20%20%20%20app.myClient%20%3D%20new%20MyClient()%3B%0A%20%20%20%20%20%20app.myClient.on('error'%2C%20err%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20app.coreLogger.error(err)%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20await%20app.myClient.ready()%3B%0A%20%20%20%20%20%20%20%20app.coreLogger.info('my%20client%20is%20ready')%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A-%20%E4%B9%9F%E5%8F%AF%E4%BB%A5%E6%B7%BB%E5%8A%A0%20agent%20%E5%90%AF%E5%8A%A8%E9%80%BB%E8%BE%91%EF%BC%8C%E4%BD%BF%E7%94%A8%20%60agent.beforeStart%60%20API%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20%24%7Bplugin_root%7D%2Fagent.js%0A%20%20%20%20const%20MyClient%20%3D%20require('my-client')%3B%0A%0A%20%20%20%20module.exports%20%3D%20agent%20%3D%3E%20%7B%0A%20%20%20%20%20%20agent.myClient%20%3D%20new%20MyClient()%3B%0A%20%20%20%20%20%20agent.myClient.on('error'%2C%20err%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20agent.coreLogger.error(err)%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20agent.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20await%20agent.myClient.ready()%3B%0A%20%20%20%20%20%20%20%20agent.coreLogger.info('my%20client%20is%20ready')%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A%23%23%23%20%E8%AE%BE%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%0A%0A1.%20%E5%9C%A8%20%60package.json%60%20%E9%87%8C%E8%AE%BE%E7%BD%AE%E4%BE%9D%E8%B5%96%20schedule%20%E6%8F%92%E4%BB%B6%0A%0A%20%20%20%20%60%60%60json%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%22name%22%3A%20%22your-plugin%22%2C%0A%20%20%20%20%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%22name%22%3A%20%22your-plugin%22%2C%0A%20%20%20%20%20%20%20%20%22dependencies%22%3A%20%5B%20%22schedule%22%20%5D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%60%60%60%0A%0A2.%20%E5%9C%A8%20%60%24%7Bplugin_root%7D%2Fapp%2Fschedule%2F%60%20%E7%9B%AE%E5%BD%95%E4%B8%8B%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%EF%BC%8C%E7%BC%96%E5%86%99%E4%BD%A0%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20exports.schedule%20%3D%20%7B%0A%20%20%20%20%20%20type%3A%20'worker'%2C%0A%20%20%20%20%20%20cron%3A%20'0%200%203%20*%20*%20*'%2C%0A%20%20%20%20%20%20%2F%2F%20interval%3A%20'1h'%2C%0A%20%20%20%20%20%20%2F%2F%20immediate%3A%20true%2C%0A%20%20%20%20%7D%3B%0A%0A%20%20%20%20exports.task%20%3D%20async%20ctx%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20your%20logic%20code%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A%23%23%23%20%E5%85%A8%E5%B1%80%E5%AE%9E%E4%BE%8B%E6%8F%92%E4%BB%B6%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%0A%0A%E8%AE%B8%E5%A4%9A%E6%8F%92%E4%BB%B6%E7%9A%84%E7%9B%AE%E7%9A%84%E9%83%BD%E6%98%AF%E5%B0%86%E4%B8%80%E4%BA%9B%E5%B7%B2%E6%9C%89%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%BC%95%E5%85%A5%E5%88%B0%E6%A1%86%E6%9E%B6%E4%B8%AD%EF%BC%8C%E5%A6%82%20%5Begg-mysql%5D%2C%20%5Begg-oss%5D%E3%80%82%E4%BB%96%E4%BB%AC%E9%83%BD%E9%9C%80%E8%A6%81%E5%9C%A8%20app%20%E4%B8%8A%E5%88%9B%E5%BB%BA%E5%AF%B9%E5%BA%94%E7%9A%84%E5%AE%9E%E4%BE%8B%E3%80%82%E8%80%8C%E5%9C%A8%E5%BC%80%E5%8F%91%E8%BF%99%E4%B8%80%E7%B1%BB%E7%9A%84%E6%8F%92%E4%BB%B6%E6%97%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%91%E7%8E%B0%E5%AD%98%E5%9C%A8%E4%B8%80%E4%BA%9B%E6%99%AE%E9%81%8D%E6%80%A7%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%9A%0A%0A-%20%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%90%8C%E6%97%B6%E4%BD%BF%E7%94%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%B8%8D%E5%90%8C%E5%AE%9E%E4%BE%8B%EF%BC%88%E8%BF%9E%E6%8E%A5%E5%88%B0%E4%B8%A4%E4%B8%AA%E4%B8%8D%E5%90%8C%E7%9A%84%20MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%89%E3%80%82%0A-%20%E4%BB%8E%E5%85%B6%E4%BB%96%E6%9C%8D%E5%8A%A1%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E5%90%8E%E5%8A%A8%E6%80%81%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%9E%E6%8E%A5%EF%BC%88%E4%BB%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%8E%B7%E5%8F%96%E5%88%B0%20MySQL%20%E6%9C%8D%E5%8A%A1%E5%9C%B0%E5%9D%80%E5%90%8E%E5%86%8D%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%EF%BC%89%E3%80%82%0A%0A%E5%A6%82%E6%9E%9C%E8%AE%A9%E6%8F%92%E4%BB%B6%E5%90%84%E8%87%AA%E5%AE%9E%E7%8E%B0%EF%BC%8C%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%87%BA%E7%8E%B0%E5%90%84%E7%A7%8D%E5%A5%87%E6%80%AA%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E5%BC%8F%EF%BC%8C%E6%89%80%E4%BB%A5%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E4%BA%86%20%60app.addSingleton(name%2C%20creator)%60%20%E6%96%B9%E6%B3%95%E6%9D%A5%E7%BB%9F%E4%B8%80%E8%BF%99%E4%B8%80%E7%B1%BB%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%88%9B%E5%BB%BA%E3%80%82%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%E5%9C%A8%E4%BD%BF%E7%94%A8%20%60app.addSingleton(name%2C%20creator)%60%20%E6%96%B9%E6%B3%95%E6%97%B6%EF%BC%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E4%B8%80%E5%AE%9A%E8%A6%81%E6%9C%89%20%60client%60%20%E6%88%96%E8%80%85%20%60clients%60%20%E4%B8%BA%20key%20%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BD%9C%E4%B8%BA%E4%BC%A0%E5%85%A5%20%60creator%60%20%E5%87%BD%E6%95%B0%20%E7%9A%84%20%60config%60%E3%80%82%0A%0A%23%23%23%23%20%E6%8F%92%E4%BB%B6%E5%86%99%E6%B3%95%0A%0A%E6%88%91%E4%BB%AC%E5%B0%86%20%5Begg-mysql%5D%20%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8C%96%E4%B9%8B%E5%90%8E%E6%9D%A5%E7%9C%8B%E7%9C%8B%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E6%AD%A4%E7%B1%BB%E6%8F%92%E4%BB%B6%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20egg-mysql%2Fapp.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20%2F%2F%20%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%20mysql%20%E6%8C%87%E5%AE%9A%E4%BA%86%E6%8C%82%E8%BD%BD%E5%88%B0%20app%20%E4%B8%8A%E7%9A%84%E5%AD%97%E6%AE%B5%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60app.mysql%60%20%E8%AE%BF%E9%97%AE%E5%88%B0%20MySQL%20singleton%20%E5%AE%9E%E4%BE%8B%0A%20%20%2F%2F%20%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%20createMysql%20%E6%8E%A5%E5%8F%97%E4%B8%A4%E4%B8%AA%E5%8F%82%E6%95%B0(config%2C%20app)%EF%BC%8C%E5%B9%B6%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%20MySQL%20%E7%9A%84%E5%AE%9E%E4%BE%8B%0A%20%20app.addSingleton('mysql'%2C%20createMysql)%3B%0A%7D%0A%0A%2F**%0A%20*%20%40param%20%20%7BObject%7D%20config%20%20%20%E6%A1%86%E6%9E%B6%E5%A4%84%E7%90%86%E4%B9%8B%E5%90%8E%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE%E4%BA%86%E5%A4%9A%E4%B8%AA%20MySQL%20%E5%AE%9E%E4%BE%8B%EF%BC%8C%E4%BC%9A%E5%B0%86%E6%AF%8F%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E9%A1%B9%E5%88%86%E5%88%AB%E4%BC%A0%E5%85%A5%E5%B9%B6%E8%B0%83%E7%94%A8%E5%A4%9A%E6%AC%A1%20createMysql%0A%20*%20%40param%20%20%7BApplication%7D%20app%20%E5%BD%93%E5%89%8D%E7%9A%84%E5%BA%94%E7%94%A8%0A%20*%20%40return%20%7BObject%7D%20%20%20%20%20%20%20%20%20%20%E8%BF%94%E5%9B%9E%E5%88%9B%E5%BB%BA%E7%9A%84%20MySQL%20%E5%AE%9E%E4%BE%8B%0A%20*%2F%0Afunction%20createMysql(config%2C%20app)%20%7B%0A%20%20assert(config.host%20%26%26%20config.port%20%26%26%20config.user%20%26%26%20config.database)%3B%0A%20%20%2F%2F%20%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%0A%20%20const%20client%20%3D%20new%20Mysql(config)%3B%0A%0A%20%20%2F%2F%20%E5%81%9A%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8%E5%89%8D%E7%9A%84%E6%A3%80%E6%9F%A5%0A%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20rows%20%3D%20await%20client.query('select%20now()%20as%20currentTime%3B')%3B%0A%20%20%20%20app.coreLogger.info(%60%5Begg-mysql%5D%20init%20instance%20success%2C%20rds%20currentTime%3A%20%24%7Brows%5B0%5D.currentTime%7D%60)%3B%0A%20%20%7D)%3B%0A%0A%20%20return%20client%3B%0A%7D%0A%60%60%60%0A%0A%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E6%B3%95%E4%B9%9F%E6%94%AF%E6%8C%81%20%60Async%20function%60%EF%BC%8C%E4%BE%BF%E4%BA%8E%E6%9C%89%E4%BA%9B%E7%89%B9%E6%AE%8A%E7%9A%84%E6%8F%92%E4%BB%B6%E9%9C%80%E8%A6%81%E5%BC%82%E6%AD%A5%E5%8C%96%E8%8E%B7%E5%8F%96%E4%B8%80%E4%BA%9B%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%9A%0A%0A%60%60%60js%0Aasync%20function%20createMysql(config%2C%20app)%20%7B%0A%20%20%2F%2F%20%E5%BC%82%E6%AD%A5%E8%8E%B7%E5%8F%96%20mysql%20%E9%85%8D%E7%BD%AE%0A%20%20const%20mysqlConfig%20%3D%20await%20app.configManager.getMysqlConfig(config.mysql)%3B%0A%20%20assert(mysqlConfig.host%20%26%26%20mysqlConfig.port%20%26%26%20mysqlConfig.user%20%26%26%20mysqlConfig.database)%3B%0A%20%20%2F%2F%20%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%0A%20%20const%20client%20%3D%20new%20Mysql(mysqlConfig)%3B%0A%0A%20%20%2F%2F%20%E5%81%9A%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8%E5%89%8D%E7%9A%84%E6%A3%80%E6%9F%A5%0A%20%20const%20rows%20%3D%20await%20client.query('select%20now()%20as%20currentTime%3B')%3B%0A%20%20app.coreLogger.info(%60%5Begg-mysql%5D%20init%20instance%20success%2C%20rds%20currentTime%3A%20%24%7Brows%5B0%5D.currentTime%7D%60)%3B%0A%0A%20%20return%20client%3B%0A%7D%0A%60%60%60%0A%0A%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E6%8F%92%E4%BB%B6%E4%B8%AD%E6%88%91%E4%BB%AC%E5%8F%AA%E9%9C%80%E8%A6%81%E6%8F%90%E4%BE%9B%E8%A6%81%E6%8C%82%E8%BD%BD%E7%9A%84%E5%AD%97%E6%AE%B5%E4%BB%A5%E5%8F%8A%E5%AF%B9%E5%BA%94%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E6%B3%95%EF%BC%8C%E6%89%80%E6%9C%89%E7%9A%84%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E3%80%81%E5%AE%9E%E4%BE%8B%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F%E9%83%BD%E7%94%B1%E6%A1%86%E6%9E%B6%E5%B0%81%E8%A3%85%E5%B9%B6%E7%BB%9F%E4%B8%80%E6%8F%90%E4%BE%9B%E4%BA%86%E3%80%82%0A%0A%23%23%23%23%20%E5%BA%94%E7%94%A8%E5%B1%82%E4%BD%BF%E7%94%A8%E6%96%B9%E6%A1%88%0A%0A%23%23%23%23%23%20%E5%8D%95%E5%AE%9E%E4%BE%8B%0A%0A1.%20%E5%9C%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E5%A3%B0%E6%98%8E%20MySQL%20%E7%9A%84%E9%85%8D%E7%BD%AE%E3%80%82%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20config%2Fconfig.default.js%0A%20%20%20%20module.exports%20%3D%20%7B%0A%20%20%20%20%20%20mysql%3A%20%7B%0A%20%20%20%20%20%20%20%20client%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20host%3A%20'mysql.com'%2C%0A%20%20%20%20%20%20%20%20%20%20port%3A%20'3306'%2C%0A%20%20%20%20%20%20%20%20%20%20user%3A%20'test_user'%2C%0A%20%20%20%20%20%20%20%20%20%20password%3A%20'test_password'%2C%0A%20%20%20%20%20%20%20%20%20%20database%3A%20'test'%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A2.%20%E7%9B%B4%E6%8E%A5%E9%80%9A%E8%BF%87%20%60app.mysql%60%20%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%82%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20app%2Fcontroller%2Fpost.js%0A%20%20%20%20class%20PostController%20extends%20Controller%20%7B%0A%20%20%20%20%20%20async%20list()%20%7B%0A%20%20%20%20%20%20%20%20const%20posts%20%3D%20await%20this.app.mysql.query(sql%2C%20values)%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D%0A%20%20%20%20%60%60%60%0A%0A%23%23%23%23%23%20%E5%A4%9A%E5%AE%9E%E4%BE%8B%0A%0A1.%20%E5%90%8C%E6%A0%B7%E9%9C%80%E8%A6%81%E5%9C%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E5%A3%B0%E6%98%8E%20MySQL%20%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E4%B8%8D%E8%BF%87%E5%92%8C%E5%8D%95%E5%AE%9E%E4%BE%8B%E6%97%B6%E4%B8%8D%E5%90%8C%EF%BC%8C%E9%85%8D%E7%BD%AE%E9%A1%B9%E4%B8%AD%E9%9C%80%E8%A6%81%E6%9C%89%E4%B8%80%E4%B8%AA%20%60clients%60%20%E5%AD%97%E6%AE%B5%EF%BC%8C%E5%88%86%E5%88%AB%E7%94%B3%E6%98%8E%E4%B8%8D%E5%90%8C%E5%AE%9E%E4%BE%8B%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%90%8C%E6%97%B6%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60default%60%20%E5%AD%97%E6%AE%B5%E6%9D%A5%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E5%AE%9E%E4%BE%8B%E4%B8%AD%E5%85%B1%E4%BA%AB%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%88%E5%A6%82%20host%20%E5%92%8C%20port%EF%BC%89%E3%80%82%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%E5%9C%A8%E8%BF%99%E7%A7%8D%E6%83%85%E5%86%B5%E4%B8%8B%E8%A6%81%E7%94%A8%20%60get%60%20%E6%96%B9%E6%B3%95%E6%8C%87%E5%AE%9A%E7%9B%B8%E5%BA%94%E7%9A%84%E5%AE%9E%E4%BE%8B%E3%80%82%EF%BC%88%E4%BE%8B%E5%A6%82%EF%BC%9A%E4%BD%BF%E7%94%A8%20%60app.mysql.get('db1').query()%60%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%20%60app.mysql.query()%60%20%E5%BE%97%E5%88%B0%E4%B8%80%E4%B8%AA%20%60undefined%60%EF%BC%89%E3%80%82%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20config%2Fconfig.default.js%0A%20%20%20%20exports.mysql%20%3D%20%7B%0A%20%20%20%20%20%20clients%3A%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20clientId%2C%20access%20the%20client%20instance%20by%20app.mysql.get('clientId')%0A%20%20%20%20%20%20%20%20db1%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20user%3A%20'user1'%2C%0A%20%20%20%20%20%20%20%20%20%20password%3A%20'upassword1'%2C%0A%20%20%20%20%20%20%20%20%20%20database%3A%20'db1'%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20db2%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20user%3A%20'user2'%2C%0A%20%20%20%20%20%20%20%20%20%20password%3A%20'upassword2'%2C%0A%20%20%20%20%20%20%20%20%20%20database%3A%20'db2'%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%2F%2F%20default%20configuration%20for%20all%20databases%0A%20%20%20%20%20%20default%3A%20%7B%0A%20%20%20%20%20%20%20%20host%3A%20'mysql.com'%2C%0A%20%20%20%20%20%20%20%20port%3A%20'3306'%2C%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D%3B%0A%20%20%20%20%60%60%60%0A%0A2.%20%E9%80%9A%E8%BF%87%20%60app.mysql.get('db1')%60%20%E6%9D%A5%E8%8E%B7%E5%8F%96%E5%AF%B9%E5%BA%94%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%B9%B6%E4%BD%BF%E7%94%A8%E3%80%82%0A%0A%20%20%20%20%60%60%60js%0A%20%20%20%20%2F%2F%20app%2Fcontroller%2Fpost.js%0A%20%20%20%20class%20PostController%20extends%20Controller%20%7B%0A%20%20%20%20%20%20async%20list()%20%7B%0A%20%20%20%20%20%20%20%20const%20posts%20%3D%20await%20this.app.mysql.get('db1').query(sql%2C%20values)%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D%0A%20%20%20%20%60%60%60%0A%0A%23%23%23%23%23%20%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%0A%0A%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%B8%8D%E9%9C%80%E8%A6%81%E5%B0%86%E9%85%8D%E7%BD%AE%E6%8F%90%E5%89%8D%E7%94%B3%E6%98%8E%E5%9C%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%EF%BC%8C%E8%80%8C%E6%98%AF%E5%9C%A8%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8A%A8%E6%80%81%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%E4%BB%8E%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%8E%B7%E5%8F%96%20MySQL%20%E7%9A%84%E9%85%8D%E7%BD%AE%20%7B%20host%2C%20post%2C%20password%2C%20...%20%7D%0A%20%20%20%20const%20mysqlConfig%20%3D%20await%20app.configCenter.fetch('mysql')%3B%0A%20%20%20%20%2F%2F%20%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%20MySQL%20%E5%AE%9E%E4%BE%8B%0A%20%20%20%20app.database%20%3D%20await%20app.mysql.createInstanceAsync(mysqlConfig)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%E9%80%9A%E8%BF%87%20%60app.database%60%20%E6%9D%A5%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%E5%AE%9E%E4%BE%8B%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20app%2Fcontroller%2Fpost.js%0Aclass%20PostController%20extends%20Controller%20%7B%0A%20%20async%20list()%20%7B%0A%20%20%20%20const%20posts%20%3D%20await%20this.app.database.query(sql%2C%20values)%3B%0A%20%20%7D%2C%0A%7D%0A%60%60%60%0A%0A**%E6%B3%A8%E6%84%8F%EF%BC%8C%E5%9C%A8%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E6%A1%86%E6%9E%B6%E4%B9%9F%E4%BC%9A%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E4%B8%AD%20%60default%60%20%E5%AD%97%E6%AE%B5%E5%86%85%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%E4%BD%9C%E4%B8%BA%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E3%80%82**%0A%0A%23%23%23%20%E6%8F%92%E4%BB%B6%E7%9A%84%E5%AF%BB%E5%9D%80%E8%A7%84%E5%88%99%0A%0A%E6%A1%86%E6%9E%B6%E5%9C%A8%E5%8A%A0%E8%BD%BD%E6%8F%92%E4%BB%B6%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E9%81%B5%E5%BE%AA%E4%B8%8B%E9%9D%A2%E7%9A%84%E5%AF%BB%E5%9D%80%E8%A7%84%E5%88%99%EF%BC%9A%0A%0A-%20%E5%A6%82%E6%9E%9C%E9%85%8D%E7%BD%AE%E4%BA%86%20path%EF%BC%8C%E7%9B%B4%E6%8E%A5%E6%8C%89%E7%85%A7%20path%20%E5%8A%A0%E8%BD%BD%0A-%20%E6%B2%A1%E6%9C%89%20path%20%E6%A0%B9%E6%8D%AE%20package%20%E5%90%8D%E5%8E%BB%E6%9F%A5%E6%89%BE%EF%BC%8C%E6%9F%A5%E6%89%BE%E7%9A%84%E9%A1%BA%E5%BA%8F%E4%BE%9D%E6%AC%A1%E6%98%AF%0A%0A%20%201.%20%E5%BA%94%E7%94%A8%E6%A0%B9%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84%20%60node_modules%60%0A%20%202.%20%E5%BA%94%E7%94%A8%E4%BE%9D%E8%B5%96%E6%A1%86%E6%9E%B6%E8%B7%AF%E5%BE%84%E4%B8%8B%E7%9A%84%20%60node_modules%60%0A%20%203.%20%E5%BD%93%E5%89%8D%E8%B7%AF%E5%BE%84%E4%B8%8B%E7%9A%84%20%60node_modules%60%20%EF%BC%88%E4%B8%BB%E8%A6%81%E6%98%AF%E5%85%BC%E5%AE%B9%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%9C%BA%E6%99%AF%EF%BC%89%0A%0A%23%23%23%20%E6%8F%92%E4%BB%B6%E8%A7%84%E8%8C%83%0A%0A%E6%88%91%E4%BB%AC%E9%9D%9E%E5%B8%B8%E6%AC%A2%E8%BF%8E%E6%82%A8%E8%B4%A1%E7%8C%AE%E6%96%B0%E7%9A%84%E6%8F%92%E4%BB%B6%EF%BC%8C%E5%90%8C%E6%97%B6%E4%B9%9F%E5%B8%8C%E6%9C%9B%E6%82%A8%E9%81%B5%E5%AE%88%E4%B8%8B%E9%9D%A2%E4%B8%80%E4%BA%9B%E8%A7%84%E8%8C%83%EF%BC%9A%0A%0A-%20%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%0A%20%20-%20%60npm%60%20%E5%8C%85%E5%90%8D%E4%BB%A5%20%60egg-%60%20%E5%BC%80%E5%A4%B4%EF%BC%8C%E4%B8%94%E4%B8%BA%E5%85%A8%E5%B0%8F%E5%86%99%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9A%60egg-xx%60%E3%80%82%E6%AF%94%E8%BE%83%E9%95%BF%E7%9A%84%E8%AF%8D%E7%BB%84%E7%94%A8%E4%B8%AD%E5%88%92%E7%BA%BF%EF%BC%9A%60egg-foo-bar%60%0A%20%20-%20%E5%AF%B9%E5%BA%94%E7%9A%84%E6%8F%92%E4%BB%B6%E5%90%8D%E4%BD%BF%E7%94%A8%E5%B0%8F%E9%A9%BC%E5%B3%B0%EF%BC%8C%E5%B0%8F%E9%A9%BC%E5%B3%B0%E8%BD%AC%E6%8D%A2%E8%A7%84%E5%88%99%E4%BB%A5%20%60npm%60%20%E5%8C%85%E5%90%8D%E7%9A%84%E4%B8%AD%E5%88%92%E7%BA%BF%E4%B8%BA%E5%87%86%20%60egg-foo-bar%60%20%3D%3E%20%60fooBar%60%0A%20%20-%20%E5%AF%B9%E4%BA%8E%E5%8F%AF%E4%BB%A5%E4%B8%AD%E5%88%92%E7%BA%BF%E4%B9%9F%E5%8F%AF%E4%BB%A5%E4%B8%8D%E7%94%A8%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%8C%E4%B8%8D%E5%81%9A%E5%BC%BA%E5%88%B6%E7%BA%A6%E5%AE%9A%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9Auserservice(egg-userservice)%20%E8%BF%98%E6%98%AF%20user-service(egg-user-service)%20%E9%83%BD%E5%8F%AF%E4%BB%A5%0A-%20%60package.json%60%20%E4%B9%A6%E5%86%99%E8%A7%84%E8%8C%83%0A%20%20-%20%E6%8C%89%E7%85%A7%E4%B8%8A%E9%9D%A2%E7%9A%84%E6%96%87%E6%A1%A3%E6%B7%BB%E5%8A%A0%20%60eggPlugin%60%20%E8%8A%82%E7%82%B9%0A%20%20-%20%E5%9C%A8%20%60keywords%60%20%E9%87%8C%E5%8A%A0%E4%B8%8A%20%60egg%60%E3%80%81%60egg-plugin%60%E3%80%81%60eggPlugin%60%20%E7%AD%89%E5%85%B3%E9%94%AE%E5%AD%97%EF%BC%8C%E4%BE%BF%E4%BA%8E%E7%B4%A2%E5%BC%95%0A%0A%20%20%20%20%60%60%60json%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%22name%22%3A%20%22egg-view-nunjucks%22%2C%0A%20%20%20%20%20%20%22version%22%3A%20%221.0.0%22%2C%0A%20%20%20%20%20%20%22description%22%3A%20%22view%20plugin%20for%20egg%22%2C%0A%20%20%20%20%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%22name%22%3A%20%22nunjucks%22%2C%0A%20%20%20%20%20%20%20%20%22dep%22%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%22security%22%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%22keywords%22%3A%20%5B%0A%20%20%20%20%20%20%20%20%22egg%22%2C%0A%20%20%20%20%20%20%20%20%22egg-plugin%22%2C%0A%20%20%20%20%20%20%20%20%22eggPlugin%22%2C%0A%20%20%20%20%20%20%20%20%22egg-plugin-view%22%2C%0A%20%20%20%20%20%20%20%20%22egg-view%22%2C%0A%20%20%20%20%20%20%20%20%22nunjucks%22%0A%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%7D%0A%20%20%20%20%60%60%60%0A%0A%23%23%20%E4%B8%BA%E4%BD%95%E4%B8%8D%E4%BD%BF%E7%94%A8%20npm%20%E5%8C%85%E5%90%8D%E6%9D%A5%E5%81%9A%E6%8F%92%E4%BB%B6%E5%90%8D%EF%BC%9F%0A%0AEgg%20%E6%98%AF%E9%80%9A%E8%BF%87%20%60eggPlugin.name%60%20%E6%9D%A5%E5%AE%9A%E4%B9%89%E6%8F%92%E4%BB%B6%E5%90%8D%E7%9A%84%EF%BC%8C%E5%8F%AA%E5%9C%A8%E5%BA%94%E7%94%A8%E6%88%96%E6%A1%86%E6%9E%B6%E5%85%B7%E5%A4%87%E5%94%AF%E4%B8%80%E6%80%A7%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4**%E5%A4%9A%E4%B8%AA%20npm%20%E5%8C%85%E5%8F%AF%E8%83%BD%E6%9C%89%E7%9B%B8%E5%90%8C%E7%9A%84%E6%8F%92%E4%BB%B6%E5%90%8D**%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E4%B9%88%E8%AE%BE%E8%AE%A1%E5%91%A2%EF%BC%9F%0A%0A%E9%A6%96%E5%85%88%20Egg%20%E6%8F%92%E4%BB%B6%E4%B8%8D%E4%BB%85%E4%BB%85%E6%94%AF%E6%8C%81%20npm%20%E5%8C%85%EF%BC%8C%E8%BF%98%E6%94%AF%E6%8C%81%E9%80%9A%E8%BF%87%E7%9B%AE%E5%BD%95%E6%9D%A5%E6%89%BE%E6%8F%92%E4%BB%B6%E3%80%82%E5%9C%A8%5B%E6%B8%90%E8%BF%9B%E5%BC%8F%E5%BC%80%E5%8F%91%5D(..%2Ftutorials%2Fprogressive.md)%E7%AB%A0%E8%8A%82%E6%8F%90%E5%88%B0%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%A4%E4%B8%AA%E9%85%8D%E7%BD%AE%E6%9D%A5%E8%BF%9B%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%BC%94%E8%BF%9B%E3%80%82%E7%9B%AE%E5%BD%95%E5%AF%B9%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%B9%9F%E6%AF%94%E8%BE%83%E5%8F%8B%E5%A5%BD%E3%80%82%E6%89%80%E4%BB%A5%20Egg%20%E6%97%A0%E6%B3%95%E9%80%9A%E8%BF%87%20npm%20%E7%9A%84%E5%8C%85%E5%90%8D%E6%9D%A5%E5%81%9A%E5%94%AF%E4%B8%80%E6%80%A7%E3%80%82%0A%0A%E6%9B%B4%E9%87%8D%E8%A6%81%E7%9A%84%E6%98%AF%20Egg%20%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E8%BF%99%E7%A7%8D%E7%89%B9%E6%80%A7%E6%9D%A5%E5%81%9A%E9%80%82%E9%85%8D%E5%99%A8%E3%80%82%E6%AF%94%E5%A6%82%5B%E6%A8%A1%E6%9D%BF%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83%5D(.%2Fview-plugin.md%23%E6%8F%92%E4%BB%B6%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83)%E5%AE%9A%E4%B9%89%E7%9A%84%E6%8F%92%E4%BB%B6%E5%90%8D%E4%B8%BA%20view%EF%BC%8C%E8%80%8C%E5%AD%98%E5%9C%A8%20%60egg-view-nunjucks%60%EF%BC%8C%60egg-view-react%60%20%E7%AD%89%E6%8F%92%E4%BB%B6%EF%BC%8C%E4%BD%BF%E7%94%A8%E8%80%85%E5%8F%AA%E9%9C%80%E8%A6%81%E6%9B%B4%E6%8D%A2%E6%8F%92%E4%BB%B6%E5%92%8C%E4%BF%AE%E6%94%B9%E6%A8%A1%E6%9D%BF%EF%BC%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E5%8A%A8%20Controller%EF%BC%8C%20%E5%9B%A0%E4%B8%BA%E6%89%80%E6%9C%89%E7%9A%84%E6%A8%A1%E6%9D%BF%E6%8F%92%E4%BB%B6%E9%83%BD%E5%AE%9E%E7%8E%B0%E4%BA%86%E7%9B%B8%E5%90%8C%E7%9A%84%20API%E3%80%82%0A%0A**%E5%B0%86%E7%9B%B8%E5%90%8C%E5%8A%9F%E8%83%BD%E7%9A%84%E6%8F%92%E4%BB%B6%E8%B5%8B%E4%BA%88%E7%9B%B8%E5%90%8C%E7%9A%84%E6%8F%92%E4%BB%B6%E5%90%8D%EF%BC%8C%E5%85%B7%E5%A4%87%E7%9B%B8%E5%90%8C%E7%9A%84%20API%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%BF%AB%E9%80%9F%E5%88%87%E6%8D%A2**%E3%80%82%E8%BF%99%E5%9C%A8%E6%A8%A1%E6%9D%BF%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AD%89%E9%A2%86%E5%9F%9F%E9%9D%9E%E5%B8%B8%E9%80%82%E7%94%A8%E3%80%82%0A%0A%5Begg-init%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-init%0A%5Begg-boilerplate-plugin%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-boilerplate-plugin%0A%5Begg-mysql%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-mysql%0A%5Begg-oss%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-oss%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>