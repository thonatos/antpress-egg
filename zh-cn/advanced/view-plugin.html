<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>View 插件开发</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>绝大多数情况，我们都需要读取数据后渲染模板，然后呈现给用户，而框架并不强制使用某种模板引擎，由开发者来自行选型，具体参见<a href="../core/view.md">模板渲染</a>。</p><p>本文将阐述框架对 View 插件的规范约束, 我们可以依此来封装对应的模板引擎插件。以下以 <a href="https://github.com/eggjs/egg-view-ejs">egg-view-ejs</a> 为例</p><h2 id="插件目录结构">插件目录结构</h2><pre><code class="language-bash">egg-view-ejs
├── config
│   ├── config.default.js
│   └── config.local.js
├── lib
│   └── view.js
├── app.js
├── test
├── History.md
├── README.md
└── package.json</code></pre><h2 id="插件命名规范">插件命名规范</h2><ul><li>遵循<a href="./plugin.md">插件开发规范</a></li><li>插件命名约定以 <code>egg-view-</code> 开头</li><li><p><code>package.json</code> 配置如下，插件名以模板引擎命名，比如 ejs</p><pre><code class="language-json">{
  &quot;name&quot;: &quot;egg-view-ejs&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;ejs&quot;
  },
  &quot;keywords&quot;: [
    &quot;egg&quot;,
    &quot;egg-plugin&quot;,
    &quot;egg-view&quot;,
    &quot;ejs&quot;
  ],
}</code></pre></li><li><p>配置项也以模板引擎命名</p><pre><code class="language-js">// config/config.default.js
module.exports = {
  ejs: {},
};</code></pre></li></ul><h2 id="view-基类">View 基类</h2><p>接下来需提供一个 View 基类，这个类会在每次请求实例化。</p><p>View 基类需提供 <code>render</code> 和 <code>renderString</code> 两个方法，支持 generator function 和 async function（也可以是函数返回一个 Promise）。<code>render</code> 方法用于渲染文件，而 <code>renderString</code> 方法用于渲染模板字符串。</p><p>以下为简化代码，可直接<a href="https://github.com/eggjs/egg-view-ejs/blob/master/lib/view.js">查看源码</a></p><pre><code class="language-js">const ejs = require(&#x27;ejs&#x27;);

module.exports = class EjsView {

  render(filename, locals) {
    return new Promise((resolve, reject) =&gt; {
      // 异步调用 API
      ejs.renderFile(filename, locals, (err, result) =&gt; {
        if (err) {
          reject(err);
        } else {
          resolve(result);
        }
      });
    });
  }

  renderString(tpl, locals) {
    try {
      // 同步调用 API
      return Promise.resolve(ejs.render(tpl, locals));
    } catch (err) {
      return Promise.reject(err);
    }
  }
};</code></pre><h3 id="参数">参数</h3><p><code>render</code> 方法的三个参数</p><ul><li>filename: 是完整的文件的路径，框架查找文件时已确认文件是否存在，这里不需要处理</li><li>locals: 渲染所需的数据，数据来自 <code>app.locals</code>，<code>ctx.locals</code> 和调用 <code>render</code> 方法传入的。框架还内置了 <code>ctx</code>，<code>request</code>, <code>ctx.helper</code> 这几个对象。</li><li>viewOptions: 用户传入的配置，可覆盖模板引擎的默认配置，这个可根据模板引擎的特征考虑是否支持。比如默认开启了缓存，而某个页面不需要缓存。</li></ul><p><code>renderString</code> 方法的三个参数</p><ul><li>tpl: 模板字符串，没有文件路径</li><li>locals: 同 <code>render</code></li><li>viewOptions: 同 <code>render</code></li></ul><h2 id="插件配置">插件配置</h2><p>根据上面的命名约定，配置名一般为模板引擎的名字，比如 ejs</p><p>插件的配置主要来自模板引擎的配置，可根据具体情况定义配置项，如 <a href="https://github.com/mde/ejs#options">ejs 的配置</a></p><pre><code class="language-js">// config/config.default.js
module.exports = {
  ejs: {
    cache: true,
  }
};</code></pre><h3 id="helper">helper</h3><p>框架本身提供了 <code>ctx.helper</code> 供开发者使用，但有些情况下，我们希望对 helper 方法进行覆盖，仅在模板渲染时生效。</p><p>在模板渲染中，我们经常会需要输出用户提供的 html 片段，通常需要使用 <code>egg-security</code> 插件提供的 <code>helper.shtml</code> 清洗下</p><pre><code class="language-html">&lt;div&gt;{{ helper.shtml(data.content) | safe }}&lt;/div&gt;</code></pre><p>但如上代码所示，我们需要加上 <code>| safe</code> 来告知模板引擎，该 html 是安全的，无需再次 <code>escape</code>，直接渲染。</p><p>而这样用起来比较麻烦，而且容易遗忘，所以我们可以封装下：</p><p>先提供一个 helper 子类：</p><pre><code class="language-js">// {plugin_root}/lib/helper.js
module.exports = app =&gt; {
  return class ViewHelper extends app.Helper {
    // safe 由 [egg-view-nunjucks] 注入，在渲染时不会转义，
    // 否则在模板调用 shtml 会被转义
    shtml(str) {
      return this.safe(super.shtml(str));
    }
  }
};</code></pre><p>在渲染时使用自定义的 helper</p><pre><code class="language-js">// {plugin_root}/lib/view.js
const ViewHelper = require(&#x27;./helper&#x27;);

module.exports = class MyCustomView {
  render(filename, locals) {
    locals.helper = new ViewHelper(this.ctx);

    // 调用 Nunjucks render
  }
}</code></pre><p>具体代码可<a href="https://github.com/eggjs/egg-view-nunjucks/blob/2ee5ee992cfd95bc0bb5b822fbd72a6778edb118/lib/view.js#L11">查看</a></p><h3 id="安全相关">安全相关</h3><p>模板和安全息息相关，<a href="https://github.com/eggjs/egg-security">egg-security</a> 也给模板提供了一些方法，模板引擎可以根据需求使用。</p><p>首先声明对 <a href="https://github.com/eggjs/egg-security">egg-security</a> 的依赖：</p><pre><code class="language-json">{
  &quot;name&quot;: &quot;egg-view-nunjucks&quot;,
  &quot;eggPlugin&quot;: {
    &quot;name&quot;: &quot;nunjucks&quot;,
    &quot;dep&quot;: [
      &quot;security&quot;
    ]
  }
}</code></pre><p>框架提供了 <a href="../core/security.md#appinjectcsrfstr">app.injectCsrf</a> 和 <a href="../core/security.md#appinjectnoncestr">app.injectNonce</a>，更多可查看<a href="../core/security.md">安全章节</a>。</p><h3 id="单元测试">单元测试</h3><p>作为一个高质量的插件，完善的单元测试是必不可少的，我们也提供了很多辅助工具使插件开发者可以无痛的编写测试，具体参见<a href="../core/unittest.md">单元测试</a>和<a href="./plugin.md">插件</a>中的相关内容。</p></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E6%8F%92%E4%BB%B6%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84">插件目录结构</a></li><li><a href="#%E6%8F%92%E4%BB%B6%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83">插件命名规范</a></li><li><a href="#view-%E5%9F%BA%E7%B1%BB">View 基类</a><ul><li><a href="#%E5%8F%82%E6%95%B0">参数</a></li></ul></li><li><a href="#%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE">插件配置</a><ul><li><a href="#helper">helper</a></li><li><a href="#%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3">安全相关</a></li><li><a href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">单元测试</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E6%8F%92%E4%BB%B6%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E7%259B%25AE%25E5%25BD%2595%25E7%25BB%2593%25E6%259E%2584)%0A-%20%5B%E6%8F%92%E4%BB%B6%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E5%2591%25BD%25E5%2590%258D%25E8%25A7%2584%25E8%258C%2583)%0A-%20%5BView%20%E5%9F%BA%E7%B1%BB%5D(%23view-%25E5%259F%25BA%25E7%25B1%25BB)%0A%20%20*%20%5B%E5%8F%82%E6%95%B0%5D(%23%25E5%258F%2582%25E6%2595%25B0)%0A-%20%5B%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE%5D(%23%25E6%258F%2592%25E4%25BB%25B6%25E9%2585%258D%25E7%25BD%25AE)%0A%20%20*%20%5Bhelper%5D(%23helper)%0A%20%20*%20%5B%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3%5D(%23%25E5%25AE%2589%25E5%2585%25A8%25E7%259B%25B8%25E5%2585%25B3)%0A%20%20*%20%5B%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%5D(%23%25E5%258D%2595%25E5%2585%2583%25E6%25B5%258B%25E8%25AF%2595)","meta":{"info":{"title":"View 插件开发"}},"content":"%0A%0A%0A%E7%BB%9D%E5%A4%A7%E5%A4%9A%E6%95%B0%E6%83%85%E5%86%B5%EF%BC%8C%E6%88%91%E4%BB%AC%E9%83%BD%E9%9C%80%E8%A6%81%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E5%90%8E%E6%B8%B2%E6%9F%93%E6%A8%A1%E6%9D%BF%EF%BC%8C%E7%84%B6%E5%90%8E%E5%91%88%E7%8E%B0%E7%BB%99%E7%94%A8%E6%88%B7%EF%BC%8C%E8%80%8C%E6%A1%86%E6%9E%B6%E5%B9%B6%E4%B8%8D%E5%BC%BA%E5%88%B6%E4%BD%BF%E7%94%A8%E6%9F%90%E7%A7%8D%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%EF%BC%8C%E7%94%B1%E5%BC%80%E5%8F%91%E8%80%85%E6%9D%A5%E8%87%AA%E8%A1%8C%E9%80%89%E5%9E%8B%EF%BC%8C%E5%85%B7%E4%BD%93%E5%8F%82%E8%A7%81%5B%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93%5D(..%2Fcore%2Fview.md)%E3%80%82%0A%0A%E6%9C%AC%E6%96%87%E5%B0%86%E9%98%90%E8%BF%B0%E6%A1%86%E6%9E%B6%E5%AF%B9%20View%20%E6%8F%92%E4%BB%B6%E7%9A%84%E8%A7%84%E8%8C%83%E7%BA%A6%E6%9D%9F%2C%20%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%BE%9D%E6%AD%A4%E6%9D%A5%E5%B0%81%E8%A3%85%E5%AF%B9%E5%BA%94%E7%9A%84%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E6%8F%92%E4%BB%B6%E3%80%82%E4%BB%A5%E4%B8%8B%E4%BB%A5%20%5Begg-view-ejs%5D%20%E4%B8%BA%E4%BE%8B%0A%0A%23%23%20%E6%8F%92%E4%BB%B6%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%0A%0A%60%60%60bash%0Aegg-view-ejs%0A%E2%94%9C%E2%94%80%E2%94%80%20config%0A%E2%94%82%20%20%20%E2%94%9C%E2%94%80%E2%94%80%20config.default.js%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20config.local.js%0A%E2%94%9C%E2%94%80%E2%94%80%20lib%0A%E2%94%82%20%20%20%E2%94%94%E2%94%80%E2%94%80%20view.js%0A%E2%94%9C%E2%94%80%E2%94%80%20app.js%0A%E2%94%9C%E2%94%80%E2%94%80%20test%0A%E2%94%9C%E2%94%80%E2%94%80%20History.md%0A%E2%94%9C%E2%94%80%E2%94%80%20README.md%0A%E2%94%94%E2%94%80%E2%94%80%20package.json%0A%60%60%60%0A%0A%23%23%20%E6%8F%92%E4%BB%B6%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%0A%0A-%20%E9%81%B5%E5%BE%AA%5B%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83%5D(.%2Fplugin.md)%0A-%20%E6%8F%92%E4%BB%B6%E5%91%BD%E5%90%8D%E7%BA%A6%E5%AE%9A%E4%BB%A5%20%60egg-view-%60%20%E5%BC%80%E5%A4%B4%0A-%20%60package.json%60%20%E9%85%8D%E7%BD%AE%E5%A6%82%E4%B8%8B%EF%BC%8C%E6%8F%92%E4%BB%B6%E5%90%8D%E4%BB%A5%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E5%91%BD%E5%90%8D%EF%BC%8C%E6%AF%94%E5%A6%82%20ejs%0A%0A%20%20%60%60%60json%0A%20%20%7B%0A%20%20%20%20%22name%22%3A%20%22egg-view-ejs%22%2C%0A%20%20%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%20%20%22name%22%3A%20%22ejs%22%0A%20%20%20%20%7D%2C%0A%20%20%20%20%22keywords%22%3A%20%5B%0A%20%20%20%20%20%20%22egg%22%2C%0A%20%20%20%20%20%20%22egg-plugin%22%2C%0A%20%20%20%20%20%20%22egg-view%22%2C%0A%20%20%20%20%20%20%22ejs%22%0A%20%20%20%20%5D%2C%0A%20%20%7D%0A%20%20%60%60%60%0A-%20%E9%85%8D%E7%BD%AE%E9%A1%B9%E4%B9%9F%E4%BB%A5%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E5%91%BD%E5%90%8D%0A%0A%20%20%60%60%60js%0A%20%20%2F%2F%20config%2Fconfig.default.js%0A%20%20module.exports%20%3D%20%7B%0A%20%20%20%20ejs%3A%20%7B%7D%2C%0A%20%20%7D%3B%0A%20%20%60%60%60%0A%0A%23%23%20View%20%E5%9F%BA%E7%B1%BB%0A%0A%E6%8E%A5%E4%B8%8B%E6%9D%A5%E9%9C%80%E6%8F%90%E4%BE%9B%E4%B8%80%E4%B8%AA%20View%20%E5%9F%BA%E7%B1%BB%EF%BC%8C%E8%BF%99%E4%B8%AA%E7%B1%BB%E4%BC%9A%E5%9C%A8%E6%AF%8F%E6%AC%A1%E8%AF%B7%E6%B1%82%E5%AE%9E%E4%BE%8B%E5%8C%96%E3%80%82%0A%0AView%20%E5%9F%BA%E7%B1%BB%E9%9C%80%E6%8F%90%E4%BE%9B%20%60render%60%20%E5%92%8C%20%60renderString%60%20%E4%B8%A4%E4%B8%AA%E6%96%B9%E6%B3%95%EF%BC%8C%E6%94%AF%E6%8C%81%20generator%20function%20%E5%92%8C%20async%20function%EF%BC%88%E4%B9%9F%E5%8F%AF%E4%BB%A5%E6%98%AF%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%20Promise%EF%BC%89%E3%80%82%60render%60%20%E6%96%B9%E6%B3%95%E7%94%A8%E4%BA%8E%E6%B8%B2%E6%9F%93%E6%96%87%E4%BB%B6%EF%BC%8C%E8%80%8C%20%60renderString%60%20%E6%96%B9%E6%B3%95%E7%94%A8%E4%BA%8E%E6%B8%B2%E6%9F%93%E6%A8%A1%E6%9D%BF%E5%AD%97%E7%AC%A6%E4%B8%B2%E3%80%82%0A%0A%E4%BB%A5%E4%B8%8B%E4%B8%BA%E7%AE%80%E5%8C%96%E4%BB%A3%E7%A0%81%EF%BC%8C%E5%8F%AF%E7%9B%B4%E6%8E%A5%5B%E6%9F%A5%E7%9C%8B%E6%BA%90%E7%A0%81%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-view-ejs%2Fblob%2Fmaster%2Flib%2Fview.js)%0A%0A%60%60%60js%0Aconst%20ejs%20%3D%20require('ejs')%3B%0A%0Amodule.exports%20%3D%20class%20EjsView%20%7B%0A%0A%20%20render(filename%2C%20locals)%20%7B%0A%20%20%20%20return%20new%20Promise((resolve%2C%20reject)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%20API%0A%20%20%20%20%20%20ejs.renderFile(filename%2C%20locals%2C%20(err%2C%20result)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20if%20(err)%20%7B%0A%20%20%20%20%20%20%20%20%20%20reject(err)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20resolve(result)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%7D%0A%0A%20%20renderString(tpl%2C%20locals)%20%7B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8%20API%0A%20%20%20%20%20%20return%20Promise.resolve(ejs.render(tpl%2C%20locals))%3B%0A%20%20%20%20%7D%20catch%20(err)%20%7B%0A%20%20%20%20%20%20return%20Promise.reject(err)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20%E5%8F%82%E6%95%B0%0A%0A%60render%60%20%E6%96%B9%E6%B3%95%E7%9A%84%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0%0A%0A-%20filename%3A%20%E6%98%AF%E5%AE%8C%E6%95%B4%E7%9A%84%E6%96%87%E4%BB%B6%E7%9A%84%E8%B7%AF%E5%BE%84%EF%BC%8C%E6%A1%86%E6%9E%B6%E6%9F%A5%E6%89%BE%E6%96%87%E4%BB%B6%E6%97%B6%E5%B7%B2%E7%A1%AE%E8%AE%A4%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%EF%BC%8C%E8%BF%99%E9%87%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86%0A-%20locals%3A%20%E6%B8%B2%E6%9F%93%E6%89%80%E9%9C%80%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%95%B0%E6%8D%AE%E6%9D%A5%E8%87%AA%20%60app.locals%60%EF%BC%8C%60ctx.locals%60%20%E5%92%8C%E8%B0%83%E7%94%A8%20%60render%60%20%E6%96%B9%E6%B3%95%E4%BC%A0%E5%85%A5%E7%9A%84%E3%80%82%E6%A1%86%E6%9E%B6%E8%BF%98%E5%86%85%E7%BD%AE%E4%BA%86%20%60ctx%60%EF%BC%8C%60request%60%2C%20%60ctx.helper%60%20%E8%BF%99%E5%87%A0%E4%B8%AA%E5%AF%B9%E8%B1%A1%E3%80%82%0A-%20viewOptions%3A%20%E7%94%A8%E6%88%B7%E4%BC%A0%E5%85%A5%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%8F%AF%E8%A6%86%E7%9B%96%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%8F%AF%E6%A0%B9%E6%8D%AE%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E7%89%B9%E5%BE%81%E8%80%83%E8%99%91%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81%E3%80%82%E6%AF%94%E5%A6%82%E9%BB%98%E8%AE%A4%E5%BC%80%E5%90%AF%E4%BA%86%E7%BC%93%E5%AD%98%EF%BC%8C%E8%80%8C%E6%9F%90%E4%B8%AA%E9%A1%B5%E9%9D%A2%E4%B8%8D%E9%9C%80%E8%A6%81%E7%BC%93%E5%AD%98%E3%80%82%0A%0A%60renderString%60%20%E6%96%B9%E6%B3%95%E7%9A%84%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0%0A%0A-%20tpl%3A%20%E6%A8%A1%E6%9D%BF%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C%E6%B2%A1%E6%9C%89%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%0A-%20locals%3A%20%E5%90%8C%20%60render%60%0A-%20viewOptions%3A%20%E5%90%8C%20%60render%60%0A%0A%23%23%20%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE%0A%0A%E6%A0%B9%E6%8D%AE%E4%B8%8A%E9%9D%A2%E7%9A%84%E5%91%BD%E5%90%8D%E7%BA%A6%E5%AE%9A%EF%BC%8C%E9%85%8D%E7%BD%AE%E5%90%8D%E4%B8%80%E8%88%AC%E4%B8%BA%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E5%90%8D%E5%AD%97%EF%BC%8C%E6%AF%94%E5%A6%82%20ejs%0A%0A%E6%8F%92%E4%BB%B6%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%BB%E8%A6%81%E6%9D%A5%E8%87%AA%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%8F%AF%E6%A0%B9%E6%8D%AE%E5%85%B7%E4%BD%93%E6%83%85%E5%86%B5%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E9%A1%B9%EF%BC%8C%E5%A6%82%20%5Bejs%20%E7%9A%84%E9%85%8D%E7%BD%AE%5D(https%3A%2F%2Fgithub.com%2Fmde%2Fejs%23options)%0A%0A%60%60%60js%0A%2F%2F%20config%2Fconfig.default.js%0Amodule.exports%20%3D%20%7B%0A%20%20ejs%3A%20%7B%0A%20%20%20%20cache%3A%20true%2C%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%23%23%23%20helper%0A%0A%E6%A1%86%E6%9E%B6%E6%9C%AC%E8%BA%AB%E6%8F%90%E4%BE%9B%E4%BA%86%20%60ctx.helper%60%20%E4%BE%9B%E5%BC%80%E5%8F%91%E8%80%85%E4%BD%BF%E7%94%A8%EF%BC%8C%E4%BD%86%E6%9C%89%E4%BA%9B%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B8%8C%E6%9C%9B%E5%AF%B9%20helper%20%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8C%E8%A6%86%E7%9B%96%EF%BC%8C%E4%BB%85%E5%9C%A8%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93%E6%97%B6%E7%94%9F%E6%95%88%E3%80%82%0A%0A%E5%9C%A8%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E7%BB%8F%E5%B8%B8%E4%BC%9A%E9%9C%80%E8%A6%81%E8%BE%93%E5%87%BA%E7%94%A8%E6%88%B7%E6%8F%90%E4%BE%9B%E7%9A%84%20html%20%E7%89%87%E6%AE%B5%EF%BC%8C%E9%80%9A%E5%B8%B8%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%20%60egg-security%60%20%E6%8F%92%E4%BB%B6%E6%8F%90%E4%BE%9B%E7%9A%84%20%60helper.shtml%60%20%E6%B8%85%E6%B4%97%E4%B8%8B%0A%0A%60%60%60html%0A%3Cdiv%3E%7B%7B%20helper.shtml(data.content)%20%7C%20safe%20%7D%7D%3C%2Fdiv%3E%0A%60%60%60%0A%0A%E4%BD%86%E5%A6%82%E4%B8%8A%E4%BB%A3%E7%A0%81%E6%89%80%E7%A4%BA%EF%BC%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%8A%A0%E4%B8%8A%20%60%20%7C%20safe%60%20%E6%9D%A5%E5%91%8A%E7%9F%A5%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%EF%BC%8C%E8%AF%A5%20html%20%E6%98%AF%E5%AE%89%E5%85%A8%E7%9A%84%EF%BC%8C%E6%97%A0%E9%9C%80%E5%86%8D%E6%AC%A1%20%60escape%60%EF%BC%8C%E7%9B%B4%E6%8E%A5%E6%B8%B2%E6%9F%93%E3%80%82%0A%0A%E8%80%8C%E8%BF%99%E6%A0%B7%E7%94%A8%E8%B5%B7%E6%9D%A5%E6%AF%94%E8%BE%83%E9%BA%BB%E7%83%A6%EF%BC%8C%E8%80%8C%E4%B8%94%E5%AE%B9%E6%98%93%E9%81%97%E5%BF%98%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%B0%81%E8%A3%85%E4%B8%8B%EF%BC%9A%0A%0A%E5%85%88%E6%8F%90%E4%BE%9B%E4%B8%80%E4%B8%AA%20helper%20%E5%AD%90%E7%B1%BB%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20%7Bplugin_root%7D%2Flib%2Fhelper.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20return%20class%20ViewHelper%20extends%20app.Helper%20%7B%0A%20%20%20%20%2F%2F%20safe%20%E7%94%B1%20%5Begg-view-nunjucks%5D%20%E6%B3%A8%E5%85%A5%EF%BC%8C%E5%9C%A8%E6%B8%B2%E6%9F%93%E6%97%B6%E4%B8%8D%E4%BC%9A%E8%BD%AC%E4%B9%89%EF%BC%8C%0A%20%20%20%20%2F%2F%20%E5%90%A6%E5%88%99%E5%9C%A8%E6%A8%A1%E6%9D%BF%E8%B0%83%E7%94%A8%20shtml%20%E4%BC%9A%E8%A2%AB%E8%BD%AC%E4%B9%89%0A%20%20%20%20shtml(str)%20%7B%0A%20%20%20%20%20%20return%20this.safe(super.shtml(str))%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%E5%9C%A8%E6%B8%B2%E6%9F%93%E6%97%B6%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%20helper%0A%0A%60%60%60js%0A%2F%2F%20%7Bplugin_root%7D%2Flib%2Fview.js%0Aconst%20ViewHelper%20%3D%20require('.%2Fhelper')%3B%0A%0Amodule.exports%20%3D%20class%20MyCustomView%20%7B%0A%20%20render(filename%2C%20locals)%20%7B%0A%20%20%20%20locals.helper%20%3D%20new%20ViewHelper(this.ctx)%3B%0A%0A%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8%20Nunjucks%20render%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E5%85%B7%E4%BD%93%E4%BB%A3%E7%A0%81%E5%8F%AF%5B%E6%9F%A5%E7%9C%8B%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-view-nunjucks%2Fblob%2F2ee5ee992cfd95bc0bb5b822fbd72a6778edb118%2Flib%2Fview.js%23L11)%0A%0A%23%23%23%20%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3%0A%0A%E6%A8%A1%E6%9D%BF%E5%92%8C%E5%AE%89%E5%85%A8%E6%81%AF%E6%81%AF%E7%9B%B8%E5%85%B3%EF%BC%8C%5Begg-security%5D%20%E4%B9%9F%E7%BB%99%E6%A8%A1%E6%9D%BF%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E4%BA%9B%E6%96%B9%E6%B3%95%EF%BC%8C%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E5%8F%AF%E4%BB%A5%E6%A0%B9%E6%8D%AE%E9%9C%80%E6%B1%82%E4%BD%BF%E7%94%A8%E3%80%82%0A%0A%E9%A6%96%E5%85%88%E5%A3%B0%E6%98%8E%E5%AF%B9%20%5Begg-security%5D%20%E7%9A%84%E4%BE%9D%E8%B5%96%EF%BC%9A%0A%0A%60%60%60json%0A%7B%0A%20%20%22name%22%3A%20%22egg-view-nunjucks%22%2C%0A%20%20%22eggPlugin%22%3A%20%7B%0A%20%20%20%20%22name%22%3A%20%22nunjucks%22%2C%0A%20%20%20%20%22dep%22%3A%20%5B%0A%20%20%20%20%20%20%22security%22%0A%20%20%20%20%5D%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E4%BA%86%20%5Bapp.injectCsrf%5D(..%2Fcore%2Fsecurity.md%23appinjectcsrfstr)%20%E5%92%8C%20%5Bapp.injectNonce%5D(..%2Fcore%2Fsecurity.md%23appinjectnoncestr)%EF%BC%8C%E6%9B%B4%E5%A4%9A%E5%8F%AF%E6%9F%A5%E7%9C%8B%5B%E5%AE%89%E5%85%A8%E7%AB%A0%E8%8A%82%5D(..%2Fcore%2Fsecurity.md)%E3%80%82%0A%0A%23%23%23%20%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%0A%0A%E4%BD%9C%E4%B8%BA%E4%B8%80%E4%B8%AA%E9%AB%98%E8%B4%A8%E9%87%8F%E7%9A%84%E6%8F%92%E4%BB%B6%EF%BC%8C%E5%AE%8C%E5%96%84%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%98%AF%E5%BF%85%E4%B8%8D%E5%8F%AF%E5%B0%91%E7%9A%84%EF%BC%8C%E6%88%91%E4%BB%AC%E4%B9%9F%E6%8F%90%E4%BE%9B%E4%BA%86%E5%BE%88%E5%A4%9A%E8%BE%85%E5%8A%A9%E5%B7%A5%E5%85%B7%E4%BD%BF%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E8%80%85%E5%8F%AF%E4%BB%A5%E6%97%A0%E7%97%9B%E7%9A%84%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%85%B7%E4%BD%93%E5%8F%82%E8%A7%81%5B%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%5D(..%2Fcore%2Funittest.md)%E5%92%8C%5B%E6%8F%92%E4%BB%B6%5D(.%2Fplugin.md)%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9%E3%80%82%0A%0A%5Begg-security%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-security%0A%5Begg-view-nunjucks%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-view-nunjucks%0A%5Begg-view-ejs%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-view-ejs%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>