<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>框架开发</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>如果你的团队遇到过：</p><ul><li>维护很多个项目，每个项目都需要复制拷贝诸如 <code>gulpfile.js</code> / <code>webpack.config.js</code> 之类的文件。</li><li>每个项目都需要使用一些相同的类库，相同的配置。</li><li>在新项目中对上面的配置做了一个优化后，如何同步到其他项目？</li></ul><p>如果你的团队需要：</p><ul><li>统一的技术选型，比如数据库、模板、前端框架及各种中间件设施都需要选型，而框架封装后保证应用使用一套架构。</li><li>统一的默认配置，开源社区的配置可能不适用于公司，而又不希望应用去配置。</li><li>统一的部署方案，通过框架和平台的双向控制，应用只需要关注自己的代码，具体查看<a href="../core/deployment.md">应用部署</a></li><li>统一的代码风格，框架不仅仅解决代码重用问题，还可以对应用做一定约束，作为企业框架是很必要的。Egg 在 Koa 基础上做了很多约定，框架可以使用 <a href="./loader.md">Loader</a> 自己定义代码规则。</li></ul><p>为此，Egg 为团队架构师和技术负责人提供 <code>框架定制</code> 的能力，框架是一层抽象，可以基于 Egg 去封装上层框架，并且 Egg 支持多层继承。</p><p>这样，整个团队就可以遵循统一的方案，并且在项目中可以根据业务场景自行使用插件做差异化，当后者验证为最佳实践后，就能下沉到框架中，其他项目仅需简单的升级下框架的版本即可享受到。</p><p>具体可以参见<a href="../tutorials/progressive.md">渐进式开发</a>。</p><h2 id="框架与多进程">框架与多进程</h2><p>框架的扩展是和多进程模型有关的，我们已经知道<a href="../core/cluster-and-ipc.md">多进程模型</a>，也知道 Agent Worker 和 App Worker 的区别，所以我们需要扩展的类也有两个 Agent 和 Application，而这两个类的 API 不一定相同。</p><p>在 Agent Worker 启动的时候会实例化 Agent，而在 App Worker 启动时会实例化 Application，这两个类又同时继承 <a href="https://github.com/eggjs/egg-core">EggCore</a>。</p><p>EggCore 可以看做 Koa Application 的升级版，默认内置 <a href="./loader.md">Loader</a>、<a href="../basics/router.md">Router</a> 及应用异步启动等功能，可以看做是支持 Loader 的 Koa。</p><pre><code>       Koa Application
              ^
           EggCore
              ^
       ┌──────┴───────┐
       │              │
   Egg Agent      Egg Application
      ^               ^
 agent worker     app worker</code></pre><h2 id="如何定制一个框架">如何定制一个框架</h2><p>你可以直接通过 <a href="">egg-init</a> 选择 <a href="https://github.com/eggjs/egg-boilerplate-framework">framework</a> 脚手架来快速上手。</p><pre><code class="language-bash">$ egg-init --type=framework yadan
$ cd yadan
$ npm i
$ npm test</code></pre><p>但同样，为了让大家了解细节，接下来我们还是手把手来定制一个框架，具体代码可以查看<a href="https://github.com/eggjs/examples/tree/master/framework">示例</a></p><h3 id="框架-api">框架 API</h3><p>Egg 框架提供了一些 API，所有继承的框架都需要提供，只增不减。这些 API 基本都有 Agent 和 Application 两份。</p><h4 id="eggstartcluster"><code>egg.startCluster</code></h4><p>Egg 的多进程启动器，由这个方法来启动 Master，主要的功能实现在 <a href="https://github.com/eggjs/egg-cluster">egg-cluster</a> 上。所以直接使用 EggCore 还是单进程的方式，而 Egg 实现了多进程。</p><pre><code class="language-js">const startCluster = require(&#x27;egg&#x27;).startCluster;
startCluster({
  // 应用的代码目录
  baseDir: &#x27;/path/to/app&#x27;,
  // 需要通过这个参数来指定框架目录
  framework: &#x27;/path/to/framework&#x27;,
}, () =&gt; {
  console.log(&#x27;app started&#x27;);
});</code></pre><p>所有参数可以查看 <a href="https://github.com/eggjs/egg-cluster#options">egg-cluster</a></p><h4 id="eggapplication-和-eggagent"><code>egg.Application</code> 和 <code>egg.Agent</code></h4><p>进程中的唯一单例，但 Application 和 Agent 存在一定差异。如果框架继承于 Egg，会定制这两个类，那 framework 应该 export 这两个类。</p><h4 id="eggappworkerloader-和-eggagentworkerloader"><code>egg.AppWorkerLoader</code> 和 <code>egg.AgentWorkerLoader</code></h4><p>框架也存在定制 Loader 的场景，覆盖原方法或者新加载目录都需要提供自己的 Loader，而且必须要继承 Egg 的 Loader。</p><h3 id="框架继承">框架继承</h3><p>框架支持继承关系，可以把框架比作一个类，那么基类就是 Egg 框架，如果想对 Egg 做扩展就继承。</p><p>首先定义一个框架需要实现 Egg 所有的 API</p><pre><code class="language-js">// package.json
{
  &quot;name&quot;: &quot;yadan&quot;,
  &quot;dependencies&quot;: {
    &quot;egg&quot;: &quot;^2.0.0&quot;
  }
}

// index.js
module.exports = require(&#x27;./lib/framework.js&#x27;);

// lib/framework.js
const path = require(&#x27;path&#x27;);
const egg = require(&#x27;egg&#x27;);
const EGG_PATH = Symbol.for(&#x27;egg#eggPath&#x27;);

class Application extends egg.Application {
  get [EGG_PATH]() {
    // 返回 framework 路径
    return path.dirname(__dirname);
  }
}

// 覆盖了 Egg 的 Application
module.exports = Object.assign(egg, {
  Application,
});</code></pre><p>应用启动时需要指定框架名（在 <code>package.json</code> 指定 <code>egg.framework</code>，默认为 egg），Loader 将从 <code>node_modules</code> 找指定模块作为框架，并加载其 export 的 Application。</p><pre><code class="language-json">{
  &quot;scripts&quot;: {
    &quot;dev&quot;: &quot;egg-bin dev&quot;
  },
  &quot;egg&quot;: {
    &quot;framework&quot;: &quot;yadan&quot;
  }
}</code></pre><p>现在 yadan 框架目录已经是一个 loadUnit，那么相应目录和文件（如 <code>app</code> 和 <code>config</code>）都会被加载，查看<a href="./loader.md">框架被加载的文件</a>。</p><h3 id="框架继承原理">框架继承原理</h3><p>使用 <code>Symbol.for(&#x27;egg#eggPath&#x27;)</code> 来指定当前框架的路径，目的是让 Loader 能探测到框架的路径。为什么这样实现呢？其实最简单的方式是将框架的路径传递给 Loader，但我们需要实现多级框架继承，每一层框架都要提供自己的当前路径，并且需要继承存在先后顺序。</p><p>现在的实现方案是基于类继承的，每一层框架都必须继承上一层框架并且指定 eggPath，然后遍历原型链就能获取每一层的框架路径了。</p><p>比如有三层框架：部门框架（department）&gt; 企业框架（enterprise）&gt; Egg</p><pre><code class="language-js">// enterprise
const Application = require(&#x27;egg&#x27;).Application;
class Enterprise extends Application {
  get [EGG_PATH]() {
    return &#x27;/path/to/enterprise&#x27;;
  }
}
// 自定义模块 Application
exports.Application = Enterprise;

// department
const Application = require(&#x27;enterprise&#x27;).Application;
// 继承 enterprise 的 Application
class department extends Application {
  get [EGG_PATH]() {
    return &#x27;/path/to/department&#x27;;
  }
}

// 启动需要传入 department 的框架路径才能获取 Application
const Application = require(&#x27;department&#x27;).Application;
const app = new Application();
app.ready();</code></pre><p>以上均是伪代码，为了详细说明框架路径的加载过程，不过 Egg 已经在<a href="../core/development.md">本地开发</a>和<a href="../core/deployment.md">应用部署</a>提供了很好的工具，不需要自己实现。</p><h3 id="自定义-agent">自定义 Agent</h3><p>上面的例子自定义了 Application，因为 Egg 是多进程模型，所以还需要定义 Agent，原理是一样的。</p><pre><code class="language-js">// lib/framework.js
const path = require(&#x27;path&#x27;);
const egg = require(&#x27;egg&#x27;);
const EGG_PATH = Symbol.for(&#x27;egg#eggPath&#x27;);

class Application extends egg.Application {
  get [EGG_PATH]() {
    // 返回 framework 路径
    return path.dirname(__dirname);
  }
}

class Agent extends egg.Agent {
  get [EGG_PATH]() {
    return path.dirname(__dirname);
  }
}

// 覆盖了 Egg 的 Application
module.exports = Object.assign(egg, {
  Application,
  Agent,
});</code></pre><p><strong>但因为 Agent 和 Application 是两个实例，所以 API 有可能不一致。</strong></p><h3 id="自定义-loader">自定义 Loader</h3><p>Loader 应用启动的核心，使用它还能规范应用代码，我们可以基于这个类扩展更多功能，比如加载数据代码。扩展 Loader 还能覆盖默认的实现，或调整现有的加载顺序等。</p><p>自定义 Loader 也是用 <code>Symbol.for(&#x27;egg#loader&#x27;)</code> 的方式，主要的原因还是使用原型链，上层框架可覆盖底层 Loader，在上面例子的基础上</p><pre><code class="language-js">// lib/framework.js
const path = require(&#x27;path&#x27;);
const egg = require(&#x27;egg&#x27;);
const EGG_PATH = Symbol.for(&#x27;egg#eggPath&#x27;);

class YadanAppWorkerLoader extends egg.AppWorkerLoader {
  load() {
    super.load();
    // 自己扩展
  }
}

class Application extends egg.Application {
  get [EGG_PATH]() {
    // 返回 framework 路径
    return path.dirname(__dirname);
  }
  // 覆盖 Egg 的 Loader，启动时使用这个 Loader
  get [EGG_LOADER]() {
    return YadanAppWorkerLoader;
  }
}

// 覆盖了 Egg 的 Application
module.exports = Object.assign(egg, {
  Application,
  // 自定义的 Loader 也需要 export，上层框架需要基于这个扩展
  AppWorkerLoader: YadanAppWorkerLoader,
});</code></pre><p>AgentWorkerLoader 扩展也类似，这里不再举例。AgentWorkerLoader 加载的文件可以于 AppWorkerLoader 不同，比如：默认加载时，Egg 的 AppWorkerLoader 会加载 <code>app.js</code> 而 AgentWorkerLoader 加载的是 <code>agent.js</code>。</p><h2 id="框架启动原理">框架启动原理</h2><p>框架启动在<a href="../core/cluster-and-ipc.md">多进程模型</a>、<a href="./loader.md">Loader</a>、<a href="./plugin.md">插件</a>中或多或少都提过，这里系统的梳理下启动顺序。</p><ul><li>startCluster 启动传入 <code>baseDir</code> 和 <code>framework</code>，Master 进程启动</li><li>Master 先 fork Agent Worker<ul><li>根据 framework 找到框架目录，实例化该框架的 Agent 类</li><li>Agent 找到定义的 AgentWorkerLoader，开始进行加载</li><li>AgentWorkerLoader，开始进行加载 整个加载过程是同步的，按 plugin &gt; config &gt; extend &gt; <code>agent.js</code> &gt; 其他文件顺序加载</li><li><code>agent.js</code> 可自定义初始化，支持异步启动，如果定义了 beforeStart 会等待执行完成之后通知 Master 启动完成。</li></ul></li><li>Master 得到 Agent Worker 启动成功的消息，使用 cluster fork App Worker<ul><li>App Worker 有多个进程，所以这几个进程是并行启动的，但执行逻辑是一致的</li><li>单个 App Worker 和 Agent 类似，通过 framework 找到框架目录，实例化该框架的 Application 类</li><li>Application 找到 AppWorkerLoader，开始进行加载，顺序也是类似的，会异步等待，完成后通知 Master 启动完成</li></ul></li><li>Master 等待多个 App Worker 的成功消息后启动完成，能对外提供服务。</li></ul><h2 id="框架测试">框架测试</h2><p>在看下文之前请先查看<a href="../core/unittest.md">单元测试章节</a>，框架测试的大部分使用场景和应用类似。</p><h3 id="初始化">初始化</h3><p>框架的初始化方式有一定差异</p><pre><code class="language-js">const mock = require(&#x27;egg-mock&#x27;);
describe(&#x27;test/index.test.js&#x27;, () =&gt; {
  let app;
  before(() =&gt; {
    app = mock.app({
      // 转换成 test/fixtures/apps/example
      baseDir: &#x27;apps/example&#x27;,
      // 重要：配置 framework
      framework: true,
    });
    return app.ready();
  });

  after(() =&gt; app.close());
  afterEach(mock.restore);

  it(&#x27;should success&#x27;, () =&gt; {
    return app.httpRequest()
      .get(&#x27;/&#x27;)
      .expect(200);
  });
});</code></pre><ul><li>框架和应用不同，应用测试当前代码，而框架是测试框架代码，所以会频繁更换 baseDir 达到测试各种应用的目的。</li><li>baseDir 有潜规则，我们一般会把测试的应用代码放到 <code>test/fixtures</code> 下，所以自动补全，也可以传入绝对路径。</li><li>必须指定 <code>framework: true</code>，告知当前路径为框架路径，也可以传入绝对路径。</li><li>app 应用需要在 before 等待 ready，不然在 testcase 里无法获取部分 API</li><li>框架在测试完毕后需要使用 <code>app.close()</code> 关闭，不然会有遗留问题，比如日志写文件未关闭导致 fd 不够。</li></ul><h3 id="缓存">缓存</h3><p>在测试多环境场景需要使用到 cache 参数，因为 <code>mm.app</code> 默认有缓存，当第一次加载过后再次加载会直接读取缓存，那么设置的环境也不会生效。</p><pre><code class="language-js">const mock = require(&#x27;egg-mock&#x27;);
describe(&#x27;/test/index.test.js&#x27;, () =&gt; {
  let app;
  afterEach(() =&gt; app.close());

  it(&#x27;should test on local&#x27;, () =&gt; {
    mock.env(&#x27;local&#x27;);
    app = mock.app({
      baseDir: &#x27;apps/example&#x27;,
      framework: true,
      cache: false,
    });
    return app.ready();
  });
  it(&#x27;should test on prod&#x27;, () =&gt; {
    mock.env(&#x27;prod&#x27;);
    app = mock.app({
      baseDir: &#x27;apps/example&#x27;,
      framework: true,
      cache: false,
    });
    return app.ready();
  });
});</code></pre><h3 id="多进程测试">多进程测试</h3><p>很少场景会使用多进程测试，因为多进程无法进行 API 级别的 mock 导致测试成本很高，而进程在有覆盖率的场景启动很慢，测试会超时。但多进程测试是验证多进程模型最好的方式，还可以测试 stdout 和 stderr。</p><p>多进程测试和 <code>mm.app</code> 参数一致，但 app 的 API 完全不同，不过 SuperTest 依然可用。</p><pre><code class="language-js">const mock = require(&#x27;egg-mock&#x27;);
describe(&#x27;/test/index.test.js&#x27;, () =&gt; {
  let app;
  before(() =&gt; {
    app = mock.cluster({
      baseDir: &#x27;apps/example&#x27;,
      framework: true,
    });
    return app.ready();
  });
  after(() =&gt; app.close());
  afterEach(mock.restore);
  it(&#x27;should success&#x27;, () =&gt; {
    return app.httpRequest()
      .get(&#x27;/&#x27;)
      .expect(200);
  });
});</code></pre><p>多进程测试还可以测试 stdout/stderr，因为 <code>mm.cluster</code> 是基于 <a href="https://github.com/popomore/coffee">coffee</a> 扩展的，可进行进程测试。</p><pre><code class="language-js">const mock = require(&#x27;egg-mock&#x27;);
describe(&#x27;/test/index.test.js&#x27;, () =&gt; {
  let app;
  before(() =&gt; {
    app = mock.cluster({
      baseDir: &#x27;apps/example&#x27;,
      framework: true,
    });
    return app.ready();
  });
  after(() =&gt; app.close());
  it(&#x27;should get `started`&#x27;, () =&gt; {
    // 判断终端输出
    app.expect(&#x27;stdout&#x27;, /started/);
  });
});</code></pre></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%A4%9A%E8%BF%9B%E7%A8%8B">框架与多进程</a></li><li><a href="#%E5%A6%82%E4%BD%95%E5%AE%9A%E5%88%B6%E4%B8%80%E4%B8%AA%E6%A1%86%E6%9E%B6">如何定制一个框架</a><ul><li><a href="#%E6%A1%86%E6%9E%B6-api">框架 API</a><ul><li><a href="#eggstartcluster"><code>egg.startCluster</code></a></li><li><a href="#eggapplication-%E5%92%8C-eggagent"><code>egg.Application</code> 和 <code>egg.Agent</code></a></li><li><a href="#eggappworkerloader-%E5%92%8C-eggagentworkerloader"><code>egg.AppWorkerLoader</code> 和 <code>egg.AgentWorkerLoader</code></a></li></ul></li><li><a href="#%E6%A1%86%E6%9E%B6%E7%BB%A7%E6%89%BF">框架继承</a></li><li><a href="#%E6%A1%86%E6%9E%B6%E7%BB%A7%E6%89%BF%E5%8E%9F%E7%90%86">框架继承原理</a></li><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89-agent">自定义 Agent</a></li><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89-loader">自定义 Loader</a></li></ul></li><li><a href="#%E6%A1%86%E6%9E%B6%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86">框架启动原理</a></li><li><a href="#%E6%A1%86%E6%9E%B6%E6%B5%8B%E8%AF%95">框架测试</a><ul><li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96">初始化</a></li><li><a href="#%E7%BC%93%E5%AD%98">缓存</a></li><li><a href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%B5%8B%E8%AF%95">多进程测试</a></li></ul></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%A4%9A%E8%BF%9B%E7%A8%8B%5D(%23%25E6%25A1%2586%25E6%259E%25B6%25E4%25B8%258E%25E5%25A4%259A%25E8%25BF%259B%25E7%25A8%258B)%0A-%20%5B%E5%A6%82%E4%BD%95%E5%AE%9A%E5%88%B6%E4%B8%80%E4%B8%AA%E6%A1%86%E6%9E%B6%5D(%23%25E5%25A6%2582%25E4%25BD%2595%25E5%25AE%259A%25E5%2588%25B6%25E4%25B8%2580%25E4%25B8%25AA%25E6%25A1%2586%25E6%259E%25B6)%0A%20%20*%20%5B%E6%A1%86%E6%9E%B6%20API%5D(%23%25E6%25A1%2586%25E6%259E%25B6-api)%0A%20%20%20%20%2B%20%5B%60egg.startCluster%60%5D(%23eggstartcluster)%0A%20%20%20%20%2B%20%5B%60egg.Application%60%20%E5%92%8C%20%60egg.Agent%60%5D(%23eggapplication-%25E5%2592%258C-eggagent)%0A%20%20%20%20%2B%20%5B%60egg.AppWorkerLoader%60%20%E5%92%8C%20%60egg.AgentWorkerLoader%60%5D(%23eggappworkerloader-%25E5%2592%258C-eggagentworkerloader)%0A%20%20*%20%5B%E6%A1%86%E6%9E%B6%E7%BB%A7%E6%89%BF%5D(%23%25E6%25A1%2586%25E6%259E%25B6%25E7%25BB%25A7%25E6%2589%25BF)%0A%20%20*%20%5B%E6%A1%86%E6%9E%B6%E7%BB%A7%E6%89%BF%E5%8E%9F%E7%90%86%5D(%23%25E6%25A1%2586%25E6%259E%25B6%25E7%25BB%25A7%25E6%2589%25BF%25E5%258E%259F%25E7%2590%2586)%0A%20%20*%20%5B%E8%87%AA%E5%AE%9A%E4%B9%89%20Agent%5D(%23%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589-agent)%0A%20%20*%20%5B%E8%87%AA%E5%AE%9A%E4%B9%89%20Loader%5D(%23%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589-loader)%0A-%20%5B%E6%A1%86%E6%9E%B6%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86%5D(%23%25E6%25A1%2586%25E6%259E%25B6%25E5%2590%25AF%25E5%258A%25A8%25E5%258E%259F%25E7%2590%2586)%0A-%20%5B%E6%A1%86%E6%9E%B6%E6%B5%8B%E8%AF%95%5D(%23%25E6%25A1%2586%25E6%259E%25B6%25E6%25B5%258B%25E8%25AF%2595)%0A%20%20*%20%5B%E5%88%9D%E5%A7%8B%E5%8C%96%5D(%23%25E5%2588%259D%25E5%25A7%258B%25E5%258C%2596)%0A%20%20*%20%5B%E7%BC%93%E5%AD%98%5D(%23%25E7%25BC%2593%25E5%25AD%2598)%0A%20%20*%20%5B%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%B5%8B%E8%AF%95%5D(%23%25E5%25A4%259A%25E8%25BF%259B%25E7%25A8%258B%25E6%25B5%258B%25E8%25AF%2595)","meta":{"info":{"title":"框架开发"}},"content":"%0A%0A%0A%E5%A6%82%E6%9E%9C%E4%BD%A0%E7%9A%84%E5%9B%A2%E9%98%9F%E9%81%87%E5%88%B0%E8%BF%87%EF%BC%9A%0A%0A-%20%E7%BB%B4%E6%8A%A4%E5%BE%88%E5%A4%9A%E4%B8%AA%E9%A1%B9%E7%9B%AE%EF%BC%8C%E6%AF%8F%E4%B8%AA%E9%A1%B9%E7%9B%AE%E9%83%BD%E9%9C%80%E8%A6%81%E5%A4%8D%E5%88%B6%E6%8B%B7%E8%B4%9D%E8%AF%B8%E5%A6%82%20%60gulpfile.js%60%20%2F%20%60webpack.config.js%60%20%E4%B9%8B%E7%B1%BB%E7%9A%84%E6%96%87%E4%BB%B6%E3%80%82%0A-%20%E6%AF%8F%E4%B8%AA%E9%A1%B9%E7%9B%AE%E9%83%BD%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E4%B8%80%E4%BA%9B%E7%9B%B8%E5%90%8C%E7%9A%84%E7%B1%BB%E5%BA%93%EF%BC%8C%E7%9B%B8%E5%90%8C%E7%9A%84%E9%85%8D%E7%BD%AE%E3%80%82%0A-%20%E5%9C%A8%E6%96%B0%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%AF%B9%E4%B8%8A%E9%9D%A2%E7%9A%84%E9%85%8D%E7%BD%AE%E5%81%9A%E4%BA%86%E4%B8%80%E4%B8%AA%E4%BC%98%E5%8C%96%E5%90%8E%EF%BC%8C%E5%A6%82%E4%BD%95%E5%90%8C%E6%AD%A5%E5%88%B0%E5%85%B6%E4%BB%96%E9%A1%B9%E7%9B%AE%EF%BC%9F%0A%0A%E5%A6%82%E6%9E%9C%E4%BD%A0%E7%9A%84%E5%9B%A2%E9%98%9F%E9%9C%80%E8%A6%81%EF%BC%9A%0A%0A-%20%E7%BB%9F%E4%B8%80%E7%9A%84%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B%EF%BC%8C%E6%AF%94%E5%A6%82%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%81%E6%A8%A1%E6%9D%BF%E3%80%81%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6%E5%8F%8A%E5%90%84%E7%A7%8D%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%AE%BE%E6%96%BD%E9%83%BD%E9%9C%80%E8%A6%81%E9%80%89%E5%9E%8B%EF%BC%8C%E8%80%8C%E6%A1%86%E6%9E%B6%E5%B0%81%E8%A3%85%E5%90%8E%E4%BF%9D%E8%AF%81%E5%BA%94%E7%94%A8%E4%BD%BF%E7%94%A8%E4%B8%80%E5%A5%97%E6%9E%B6%E6%9E%84%E3%80%82%0A-%20%E7%BB%9F%E4%B8%80%E7%9A%84%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%BC%80%E6%BA%90%E7%A4%BE%E5%8C%BA%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8F%AF%E8%83%BD%E4%B8%8D%E9%80%82%E7%94%A8%E4%BA%8E%E5%85%AC%E5%8F%B8%EF%BC%8C%E8%80%8C%E5%8F%88%E4%B8%8D%E5%B8%8C%E6%9C%9B%E5%BA%94%E7%94%A8%E5%8E%BB%E9%85%8D%E7%BD%AE%E3%80%82%0A-%20%E7%BB%9F%E4%B8%80%E7%9A%84%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88%EF%BC%8C%E9%80%9A%E8%BF%87%E6%A1%86%E6%9E%B6%E5%92%8C%E5%B9%B3%E5%8F%B0%E7%9A%84%E5%8F%8C%E5%90%91%E6%8E%A7%E5%88%B6%EF%BC%8C%E5%BA%94%E7%94%A8%E5%8F%AA%E9%9C%80%E8%A6%81%E5%85%B3%E6%B3%A8%E8%87%AA%E5%B7%B1%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%8C%E5%85%B7%E4%BD%93%E6%9F%A5%E7%9C%8B%5B%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%5D(..%2Fcore%2Fdeployment.md)%0A-%20%E7%BB%9F%E4%B8%80%E7%9A%84%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%EF%BC%8C%E6%A1%86%E6%9E%B6%E4%B8%8D%E4%BB%85%E4%BB%85%E8%A7%A3%E5%86%B3%E4%BB%A3%E7%A0%81%E9%87%8D%E7%94%A8%E9%97%AE%E9%A2%98%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%AF%B9%E5%BA%94%E7%94%A8%E5%81%9A%E4%B8%80%E5%AE%9A%E7%BA%A6%E6%9D%9F%EF%BC%8C%E4%BD%9C%E4%B8%BA%E4%BC%81%E4%B8%9A%E6%A1%86%E6%9E%B6%E6%98%AF%E5%BE%88%E5%BF%85%E8%A6%81%E7%9A%84%E3%80%82Egg%20%E5%9C%A8%20Koa%20%E5%9F%BA%E7%A1%80%E4%B8%8A%E5%81%9A%E4%BA%86%E5%BE%88%E5%A4%9A%E7%BA%A6%E5%AE%9A%EF%BC%8C%E6%A1%86%E6%9E%B6%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%20%5BLoader%5D(.%2Floader.md)%20%E8%87%AA%E5%B7%B1%E5%AE%9A%E4%B9%89%E4%BB%A3%E7%A0%81%E8%A7%84%E5%88%99%E3%80%82%0A%0A%E4%B8%BA%E6%AD%A4%EF%BC%8CEgg%20%E4%B8%BA%E5%9B%A2%E9%98%9F%E6%9E%B6%E6%9E%84%E5%B8%88%E5%92%8C%E6%8A%80%E6%9C%AF%E8%B4%9F%E8%B4%A3%E4%BA%BA%E6%8F%90%E4%BE%9B%20%60%E6%A1%86%E6%9E%B6%E5%AE%9A%E5%88%B6%60%20%E7%9A%84%E8%83%BD%E5%8A%9B%EF%BC%8C%E6%A1%86%E6%9E%B6%E6%98%AF%E4%B8%80%E5%B1%82%E6%8A%BD%E8%B1%A1%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9F%BA%E4%BA%8E%20Egg%20%E5%8E%BB%E5%B0%81%E8%A3%85%E4%B8%8A%E5%B1%82%E6%A1%86%E6%9E%B6%EF%BC%8C%E5%B9%B6%E4%B8%94%20Egg%20%E6%94%AF%E6%8C%81%E5%A4%9A%E5%B1%82%E7%BB%A7%E6%89%BF%E3%80%82%0A%0A%E8%BF%99%E6%A0%B7%EF%BC%8C%E6%95%B4%E4%B8%AA%E5%9B%A2%E9%98%9F%E5%B0%B1%E5%8F%AF%E4%BB%A5%E9%81%B5%E5%BE%AA%E7%BB%9F%E4%B8%80%E7%9A%84%E6%96%B9%E6%A1%88%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%8F%AF%E4%BB%A5%E6%A0%B9%E6%8D%AE%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E8%87%AA%E8%A1%8C%E4%BD%BF%E7%94%A8%E6%8F%92%E4%BB%B6%E5%81%9A%E5%B7%AE%E5%BC%82%E5%8C%96%EF%BC%8C%E5%BD%93%E5%90%8E%E8%80%85%E9%AA%8C%E8%AF%81%E4%B8%BA%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%90%8E%EF%BC%8C%E5%B0%B1%E8%83%BD%E4%B8%8B%E6%B2%89%E5%88%B0%E6%A1%86%E6%9E%B6%E4%B8%AD%EF%BC%8C%E5%85%B6%E4%BB%96%E9%A1%B9%E7%9B%AE%E4%BB%85%E9%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E5%8D%87%E7%BA%A7%E4%B8%8B%E6%A1%86%E6%9E%B6%E7%9A%84%E7%89%88%E6%9C%AC%E5%8D%B3%E5%8F%AF%E4%BA%AB%E5%8F%97%E5%88%B0%E3%80%82%0A%0A%E5%85%B7%E4%BD%93%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%A7%81%5B%E6%B8%90%E8%BF%9B%E5%BC%8F%E5%BC%80%E5%8F%91%5D(..%2Ftutorials%2Fprogressive.md)%E3%80%82%0A%0A%23%23%20%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%A4%9A%E8%BF%9B%E7%A8%8B%0A%0A%E6%A1%86%E6%9E%B6%E7%9A%84%E6%89%A9%E5%B1%95%E6%98%AF%E5%92%8C%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E6%9C%89%E5%85%B3%E7%9A%84%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B7%B2%E7%BB%8F%E7%9F%A5%E9%81%93%5B%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%5D(..%2Fcore%2Fcluster-and-ipc.md)%EF%BC%8C%E4%B9%9F%E7%9F%A5%E9%81%93%20Agent%20Worker%20%E5%92%8C%20App%20Worker%20%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E6%89%A9%E5%B1%95%E7%9A%84%E7%B1%BB%E4%B9%9F%E6%9C%89%E4%B8%A4%E4%B8%AA%20Agent%20%E5%92%8C%20Application%EF%BC%8C%E8%80%8C%E8%BF%99%E4%B8%A4%E4%B8%AA%E7%B1%BB%E7%9A%84%20API%20%E4%B8%8D%E4%B8%80%E5%AE%9A%E7%9B%B8%E5%90%8C%E3%80%82%0A%0A%E5%9C%A8%20Agent%20Worker%20%E5%90%AF%E5%8A%A8%E7%9A%84%E6%97%B6%E5%80%99%E4%BC%9A%E5%AE%9E%E4%BE%8B%E5%8C%96%20Agent%EF%BC%8C%E8%80%8C%E5%9C%A8%20App%20Worker%20%E5%90%AF%E5%8A%A8%E6%97%B6%E4%BC%9A%E5%AE%9E%E4%BE%8B%E5%8C%96%20Application%EF%BC%8C%E8%BF%99%E4%B8%A4%E4%B8%AA%E7%B1%BB%E5%8F%88%E5%90%8C%E6%97%B6%E7%BB%A7%E6%89%BF%20%5BEggCore%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-core)%E3%80%82%0A%0AEggCore%20%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%81%9A%20Koa%20Application%20%E7%9A%84%E5%8D%87%E7%BA%A7%E7%89%88%EF%BC%8C%E9%BB%98%E8%AE%A4%E5%86%85%E7%BD%AE%20%5BLoader%5D(.%2Floader.md)%E3%80%81%5BRouter%5D(..%2Fbasics%2Frouter.md)%20%E5%8F%8A%E5%BA%94%E7%94%A8%E5%BC%82%E6%AD%A5%E5%90%AF%E5%8A%A8%E7%AD%89%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%81%9A%E6%98%AF%E6%94%AF%E6%8C%81%20Loader%20%E7%9A%84%20Koa%E3%80%82%0A%0A%60%60%60%0A%20%20%20%20%20%20%20Koa%20Application%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5E%0A%20%20%20%20%20%20%20%20%20%20%20EggCore%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5E%0A%20%20%20%20%20%20%20%E2%94%8C%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%B4%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%80%E2%94%90%0A%20%20%20%20%20%20%20%E2%94%82%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E2%94%82%0A%20%20%20Egg%20Agent%20%20%20%20%20%20Egg%20Application%0A%20%20%20%20%20%20%5E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5E%0A%20agent%20worker%20%20%20%20%20app%20worker%0A%60%60%60%0A%0A%23%23%20%E5%A6%82%E4%BD%95%E5%AE%9A%E5%88%B6%E4%B8%80%E4%B8%AA%E6%A1%86%E6%9E%B6%0A%0A%E4%BD%A0%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E9%80%9A%E8%BF%87%20%5Begg-init%5D%20%E9%80%89%E6%8B%A9%20%5Bframework%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-boilerplate-framework)%20%E8%84%9A%E6%89%8B%E6%9E%B6%E6%9D%A5%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E3%80%82%0A%0A%60%60%60bash%0A%24%20egg-init%20--type%3Dframework%20yadan%0A%24%20cd%20yadan%0A%24%20npm%20i%0A%24%20npm%20test%0A%60%60%60%0A%0A%E4%BD%86%E5%90%8C%E6%A0%B7%EF%BC%8C%E4%B8%BA%E4%BA%86%E8%AE%A9%E5%A4%A7%E5%AE%B6%E4%BA%86%E8%A7%A3%E7%BB%86%E8%8A%82%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E6%88%91%E4%BB%AC%E8%BF%98%E6%98%AF%E6%89%8B%E6%8A%8A%E6%89%8B%E6%9D%A5%E5%AE%9A%E5%88%B6%E4%B8%80%E4%B8%AA%E6%A1%86%E6%9E%B6%EF%BC%8C%E5%85%B7%E4%BD%93%E4%BB%A3%E7%A0%81%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8B%5B%E7%A4%BA%E4%BE%8B%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fexamples%2Ftree%2Fmaster%2Fframework)%0A%0A%23%23%23%20%E6%A1%86%E6%9E%B6%20API%0A%0AEgg%20%E6%A1%86%E6%9E%B6%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E4%BA%9B%20API%EF%BC%8C%E6%89%80%E6%9C%89%E7%BB%A7%E6%89%BF%E7%9A%84%E6%A1%86%E6%9E%B6%E9%83%BD%E9%9C%80%E8%A6%81%E6%8F%90%E4%BE%9B%EF%BC%8C%E5%8F%AA%E5%A2%9E%E4%B8%8D%E5%87%8F%E3%80%82%E8%BF%99%E4%BA%9B%20API%20%E5%9F%BA%E6%9C%AC%E9%83%BD%E6%9C%89%20Agent%20%E5%92%8C%20Application%20%E4%B8%A4%E4%BB%BD%E3%80%82%0A%0A%23%23%23%23%20%60egg.startCluster%60%0A%0AEgg%20%E7%9A%84%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E5%99%A8%EF%BC%8C%E7%94%B1%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E6%9D%A5%E5%90%AF%E5%8A%A8%20Master%EF%BC%8C%E4%B8%BB%E8%A6%81%E7%9A%84%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%E5%9C%A8%20%5Begg-cluster%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-cluster)%20%E4%B8%8A%E3%80%82%E6%89%80%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%20EggCore%20%E8%BF%98%E6%98%AF%E5%8D%95%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E8%80%8C%20Egg%20%E5%AE%9E%E7%8E%B0%E4%BA%86%E5%A4%9A%E8%BF%9B%E7%A8%8B%E3%80%82%0A%0A%60%60%60js%0Aconst%20startCluster%20%3D%20require('egg').startCluster%3B%0AstartCluster(%7B%0A%20%20%2F%2F%20%E5%BA%94%E7%94%A8%E7%9A%84%E4%BB%A3%E7%A0%81%E7%9B%AE%E5%BD%95%0A%20%20baseDir%3A%20'%2Fpath%2Fto%2Fapp'%2C%0A%20%20%2F%2F%20%E9%9C%80%E8%A6%81%E9%80%9A%E8%BF%87%E8%BF%99%E4%B8%AA%E5%8F%82%E6%95%B0%E6%9D%A5%E6%8C%87%E5%AE%9A%E6%A1%86%E6%9E%B6%E7%9B%AE%E5%BD%95%0A%20%20framework%3A%20'%2Fpath%2Fto%2Fframework'%2C%0A%7D%2C%20()%20%3D%3E%20%7B%0A%20%20console.log('app%20started')%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E6%89%80%E6%9C%89%E5%8F%82%E6%95%B0%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8B%20%5Begg-cluster%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-cluster%23options)%0A%0A%23%23%23%23%20%60egg.Application%60%20%E5%92%8C%20%60egg.Agent%60%0A%0A%E8%BF%9B%E7%A8%8B%E4%B8%AD%E7%9A%84%E5%94%AF%E4%B8%80%E5%8D%95%E4%BE%8B%EF%BC%8C%E4%BD%86%20Application%20%E5%92%8C%20Agent%20%E5%AD%98%E5%9C%A8%E4%B8%80%E5%AE%9A%E5%B7%AE%E5%BC%82%E3%80%82%E5%A6%82%E6%9E%9C%E6%A1%86%E6%9E%B6%E7%BB%A7%E6%89%BF%E4%BA%8E%20Egg%EF%BC%8C%E4%BC%9A%E5%AE%9A%E5%88%B6%E8%BF%99%E4%B8%A4%E4%B8%AA%E7%B1%BB%EF%BC%8C%E9%82%A3%20framework%20%E5%BA%94%E8%AF%A5%20export%20%E8%BF%99%E4%B8%A4%E4%B8%AA%E7%B1%BB%E3%80%82%0A%0A%23%23%23%23%20%60egg.AppWorkerLoader%60%20%E5%92%8C%20%60egg.AgentWorkerLoader%60%0A%0A%E6%A1%86%E6%9E%B6%E4%B9%9F%E5%AD%98%E5%9C%A8%E5%AE%9A%E5%88%B6%20Loader%20%E7%9A%84%E5%9C%BA%E6%99%AF%EF%BC%8C%E8%A6%86%E7%9B%96%E5%8E%9F%E6%96%B9%E6%B3%95%E6%88%96%E8%80%85%E6%96%B0%E5%8A%A0%E8%BD%BD%E7%9B%AE%E5%BD%95%E9%83%BD%E9%9C%80%E8%A6%81%E6%8F%90%E4%BE%9B%E8%87%AA%E5%B7%B1%E7%9A%84%20Loader%EF%BC%8C%E8%80%8C%E4%B8%94%E5%BF%85%E9%A1%BB%E8%A6%81%E7%BB%A7%E6%89%BF%20Egg%20%E7%9A%84%20Loader%E3%80%82%0A%0A%23%23%23%20%E6%A1%86%E6%9E%B6%E7%BB%A7%E6%89%BF%0A%0A%E6%A1%86%E6%9E%B6%E6%94%AF%E6%8C%81%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%8A%8A%E6%A1%86%E6%9E%B6%E6%AF%94%E4%BD%9C%E4%B8%80%E4%B8%AA%E7%B1%BB%EF%BC%8C%E9%82%A3%E4%B9%88%E5%9F%BA%E7%B1%BB%E5%B0%B1%E6%98%AF%20Egg%20%E6%A1%86%E6%9E%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%83%B3%E5%AF%B9%20Egg%20%E5%81%9A%E6%89%A9%E5%B1%95%E5%B0%B1%E7%BB%A7%E6%89%BF%E3%80%82%0A%0A%E9%A6%96%E5%85%88%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E6%A1%86%E6%9E%B6%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%20Egg%20%E6%89%80%E6%9C%89%E7%9A%84%20API%0A%0A%60%60%60js%0A%2F%2F%20package.json%0A%7B%0A%20%20%22name%22%3A%20%22yadan%22%2C%0A%20%20%22dependencies%22%3A%20%7B%0A%20%20%20%20%22egg%22%3A%20%22%5E2.0.0%22%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20index.js%0Amodule.exports%20%3D%20require('.%2Flib%2Fframework.js')%3B%0A%0A%2F%2F%20lib%2Fframework.js%0Aconst%20path%20%3D%20require('path')%3B%0Aconst%20egg%20%3D%20require('egg')%3B%0Aconst%20EGG_PATH%20%3D%20Symbol.for('egg%23eggPath')%3B%0A%0Aclass%20Application%20extends%20egg.Application%20%7B%0A%20%20get%20%5BEGG_PATH%5D()%20%7B%0A%20%20%20%20%2F%2F%20%E8%BF%94%E5%9B%9E%20framework%20%E8%B7%AF%E5%BE%84%0A%20%20%20%20return%20path.dirname(__dirname)%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20%E8%A6%86%E7%9B%96%E4%BA%86%20Egg%20%E7%9A%84%20Application%0Amodule.exports%20%3D%20Object.assign(egg%2C%20%7B%0A%20%20Application%2C%0A%7D)%3B%0A%60%60%60%0A%0A%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%97%B6%E9%9C%80%E8%A6%81%E6%8C%87%E5%AE%9A%E6%A1%86%E6%9E%B6%E5%90%8D%EF%BC%88%E5%9C%A8%20%60package.json%60%20%E6%8C%87%E5%AE%9A%20%60egg.framework%60%EF%BC%8C%E9%BB%98%E8%AE%A4%E4%B8%BA%20egg%EF%BC%89%EF%BC%8CLoader%20%E5%B0%86%E4%BB%8E%20%60node_modules%60%20%E6%89%BE%E6%8C%87%E5%AE%9A%E6%A8%A1%E5%9D%97%E4%BD%9C%E4%B8%BA%E6%A1%86%E6%9E%B6%EF%BC%8C%E5%B9%B6%E5%8A%A0%E8%BD%BD%E5%85%B6%20export%20%E7%9A%84%20Application%E3%80%82%0A%0A%60%60%60json%0A%7B%0A%20%20%22scripts%22%3A%20%7B%0A%20%20%20%20%22dev%22%3A%20%22egg-bin%20dev%22%0A%20%20%7D%2C%0A%20%20%22egg%22%3A%20%7B%0A%20%20%20%20%22framework%22%3A%20%22yadan%22%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E7%8E%B0%E5%9C%A8%20yadan%20%E6%A1%86%E6%9E%B6%E7%9B%AE%E5%BD%95%E5%B7%B2%E7%BB%8F%E6%98%AF%E4%B8%80%E4%B8%AA%20loadUnit%EF%BC%8C%E9%82%A3%E4%B9%88%E7%9B%B8%E5%BA%94%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6%EF%BC%88%E5%A6%82%20%60app%60%20%E5%92%8C%20%60config%60%EF%BC%89%E9%83%BD%E4%BC%9A%E8%A2%AB%E5%8A%A0%E8%BD%BD%EF%BC%8C%E6%9F%A5%E7%9C%8B%5B%E6%A1%86%E6%9E%B6%E8%A2%AB%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%96%87%E4%BB%B6%5D(.%2Floader.md)%E3%80%82%0A%0A%23%23%23%20%E6%A1%86%E6%9E%B6%E7%BB%A7%E6%89%BF%E5%8E%9F%E7%90%86%0A%0A%E4%BD%BF%E7%94%A8%20%60Symbol.for('egg%23eggPath')%60%20%E6%9D%A5%E6%8C%87%E5%AE%9A%E5%BD%93%E5%89%8D%E6%A1%86%E6%9E%B6%E7%9A%84%E8%B7%AF%E5%BE%84%EF%BC%8C%E7%9B%AE%E7%9A%84%E6%98%AF%E8%AE%A9%20Loader%20%E8%83%BD%E6%8E%A2%E6%B5%8B%E5%88%B0%E6%A1%86%E6%9E%B6%E7%9A%84%E8%B7%AF%E5%BE%84%E3%80%82%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E6%A0%B7%E5%AE%9E%E7%8E%B0%E5%91%A2%EF%BC%9F%E5%85%B6%E5%AE%9E%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%B9%E5%BC%8F%E6%98%AF%E5%B0%86%E6%A1%86%E6%9E%B6%E7%9A%84%E8%B7%AF%E5%BE%84%E4%BC%A0%E9%80%92%E7%BB%99%20Loader%EF%BC%8C%E4%BD%86%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%E5%A4%9A%E7%BA%A7%E6%A1%86%E6%9E%B6%E7%BB%A7%E6%89%BF%EF%BC%8C%E6%AF%8F%E4%B8%80%E5%B1%82%E6%A1%86%E6%9E%B6%E9%83%BD%E8%A6%81%E6%8F%90%E4%BE%9B%E8%87%AA%E5%B7%B1%E7%9A%84%E5%BD%93%E5%89%8D%E8%B7%AF%E5%BE%84%EF%BC%8C%E5%B9%B6%E4%B8%94%E9%9C%80%E8%A6%81%E7%BB%A7%E6%89%BF%E5%AD%98%E5%9C%A8%E5%85%88%E5%90%8E%E9%A1%BA%E5%BA%8F%E3%80%82%0A%0A%E7%8E%B0%E5%9C%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E6%98%AF%E5%9F%BA%E4%BA%8E%E7%B1%BB%E7%BB%A7%E6%89%BF%E7%9A%84%EF%BC%8C%E6%AF%8F%E4%B8%80%E5%B1%82%E6%A1%86%E6%9E%B6%E9%83%BD%E5%BF%85%E9%A1%BB%E7%BB%A7%E6%89%BF%E4%B8%8A%E4%B8%80%E5%B1%82%E6%A1%86%E6%9E%B6%E5%B9%B6%E4%B8%94%E6%8C%87%E5%AE%9A%20eggPath%EF%BC%8C%E7%84%B6%E5%90%8E%E9%81%8D%E5%8E%86%E5%8E%9F%E5%9E%8B%E9%93%BE%E5%B0%B1%E8%83%BD%E8%8E%B7%E5%8F%96%E6%AF%8F%E4%B8%80%E5%B1%82%E7%9A%84%E6%A1%86%E6%9E%B6%E8%B7%AF%E5%BE%84%E4%BA%86%E3%80%82%0A%0A%E6%AF%94%E5%A6%82%E6%9C%89%E4%B8%89%E5%B1%82%E6%A1%86%E6%9E%B6%EF%BC%9A%E9%83%A8%E9%97%A8%E6%A1%86%E6%9E%B6%EF%BC%88department%EF%BC%89%3E%20%E4%BC%81%E4%B8%9A%E6%A1%86%E6%9E%B6%EF%BC%88enterprise%EF%BC%89%3E%20Egg%0A%0A%60%60%60js%0A%2F%2F%20enterprise%0Aconst%20Application%20%3D%20require('egg').Application%3B%0Aclass%20Enterprise%20extends%20Application%20%7B%0A%20%20get%20%5BEGG_PATH%5D()%20%7B%0A%20%20%20%20return%20'%2Fpath%2Fto%2Fenterprise'%3B%0A%20%20%7D%0A%7D%0A%2F%2F%20%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9D%97%20Application%0Aexports.Application%20%3D%20Enterprise%3B%0A%0A%2F%2F%20department%0Aconst%20Application%20%3D%20require('enterprise').Application%3B%0A%2F%2F%20%E7%BB%A7%E6%89%BF%20enterprise%20%E7%9A%84%20Application%0Aclass%20department%20extends%20Application%20%7B%0A%20%20get%20%5BEGG_PATH%5D()%20%7B%0A%20%20%20%20return%20'%2Fpath%2Fto%2Fdepartment'%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20%E5%90%AF%E5%8A%A8%E9%9C%80%E8%A6%81%E4%BC%A0%E5%85%A5%20department%20%E7%9A%84%E6%A1%86%E6%9E%B6%E8%B7%AF%E5%BE%84%E6%89%8D%E8%83%BD%E8%8E%B7%E5%8F%96%20Application%0Aconst%20Application%20%3D%20require('department').Application%3B%0Aconst%20app%20%3D%20new%20Application()%3B%0Aapp.ready()%3B%0A%60%60%60%0A%0A%E4%BB%A5%E4%B8%8A%E5%9D%87%E6%98%AF%E4%BC%AA%E4%BB%A3%E7%A0%81%EF%BC%8C%E4%B8%BA%E4%BA%86%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E%E6%A1%86%E6%9E%B6%E8%B7%AF%E5%BE%84%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%EF%BC%8C%E4%B8%8D%E8%BF%87%20Egg%20%E5%B7%B2%E7%BB%8F%E5%9C%A8%5B%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%5D(..%2Fcore%2Fdevelopment.md)%E5%92%8C%5B%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%5D(..%2Fcore%2Fdeployment.md)%E6%8F%90%E4%BE%9B%E4%BA%86%E5%BE%88%E5%A5%BD%E7%9A%84%E5%B7%A5%E5%85%B7%EF%BC%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0%E3%80%82%0A%0A%23%23%23%20%E8%87%AA%E5%AE%9A%E4%B9%89%20Agent%0A%0A%E4%B8%8A%E9%9D%A2%E7%9A%84%E4%BE%8B%E5%AD%90%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BA%86%20Application%EF%BC%8C%E5%9B%A0%E4%B8%BA%20Egg%20%E6%98%AF%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%EF%BC%8C%E6%89%80%E4%BB%A5%E8%BF%98%E9%9C%80%E8%A6%81%E5%AE%9A%E4%B9%89%20Agent%EF%BC%8C%E5%8E%9F%E7%90%86%E6%98%AF%E4%B8%80%E6%A0%B7%E7%9A%84%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20lib%2Fframework.js%0Aconst%20path%20%3D%20require('path')%3B%0Aconst%20egg%20%3D%20require('egg')%3B%0Aconst%20EGG_PATH%20%3D%20Symbol.for('egg%23eggPath')%3B%0A%0Aclass%20Application%20extends%20egg.Application%20%7B%0A%20%20get%20%5BEGG_PATH%5D()%20%7B%0A%20%20%20%20%2F%2F%20%E8%BF%94%E5%9B%9E%20framework%20%E8%B7%AF%E5%BE%84%0A%20%20%20%20return%20path.dirname(__dirname)%3B%0A%20%20%7D%0A%7D%0A%0Aclass%20Agent%20extends%20egg.Agent%20%7B%0A%20%20get%20%5BEGG_PATH%5D()%20%7B%0A%20%20%20%20return%20path.dirname(__dirname)%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20%E8%A6%86%E7%9B%96%E4%BA%86%20Egg%20%E7%9A%84%20Application%0Amodule.exports%20%3D%20Object.assign(egg%2C%20%7B%0A%20%20Application%2C%0A%20%20Agent%2C%0A%7D)%3B%0A%60%60%60%0A%0A**%E4%BD%86%E5%9B%A0%E4%B8%BA%20Agent%20%E5%92%8C%20Application%20%E6%98%AF%E4%B8%A4%E4%B8%AA%E5%AE%9E%E4%BE%8B%EF%BC%8C%E6%89%80%E4%BB%A5%20API%20%E6%9C%89%E5%8F%AF%E8%83%BD%E4%B8%8D%E4%B8%80%E8%87%B4%E3%80%82**%0A%0A%23%23%23%20%E8%87%AA%E5%AE%9A%E4%B9%89%20Loader%0A%0ALoader%20%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E7%9A%84%E6%A0%B8%E5%BF%83%EF%BC%8C%E4%BD%BF%E7%94%A8%E5%AE%83%E8%BF%98%E8%83%BD%E8%A7%84%E8%8C%83%E5%BA%94%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%9F%BA%E4%BA%8E%E8%BF%99%E4%B8%AA%E7%B1%BB%E6%89%A9%E5%B1%95%E6%9B%B4%E5%A4%9A%E5%8A%9F%E8%83%BD%EF%BC%8C%E6%AF%94%E5%A6%82%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E4%BB%A3%E7%A0%81%E3%80%82%E6%89%A9%E5%B1%95%20Loader%20%E8%BF%98%E8%83%BD%E8%A6%86%E7%9B%96%E9%BB%98%E8%AE%A4%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%8C%E6%88%96%E8%B0%83%E6%95%B4%E7%8E%B0%E6%9C%89%E7%9A%84%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F%E7%AD%89%E3%80%82%0A%0A%E8%87%AA%E5%AE%9A%E4%B9%89%20Loader%20%E4%B9%9F%E6%98%AF%E7%94%A8%20%60Symbol.for('egg%23loader')%60%20%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E4%B8%BB%E8%A6%81%E7%9A%84%E5%8E%9F%E5%9B%A0%E8%BF%98%E6%98%AF%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%9E%8B%E9%93%BE%EF%BC%8C%E4%B8%8A%E5%B1%82%E6%A1%86%E6%9E%B6%E5%8F%AF%E8%A6%86%E7%9B%96%E5%BA%95%E5%B1%82%20Loader%EF%BC%8C%E5%9C%A8%E4%B8%8A%E9%9D%A2%E4%BE%8B%E5%AD%90%E7%9A%84%E5%9F%BA%E7%A1%80%E4%B8%8A%0A%0A%60%60%60js%0A%2F%2F%20lib%2Fframework.js%0Aconst%20path%20%3D%20require('path')%3B%0Aconst%20egg%20%3D%20require('egg')%3B%0Aconst%20EGG_PATH%20%3D%20Symbol.for('egg%23eggPath')%3B%0A%0Aclass%20YadanAppWorkerLoader%20extends%20egg.AppWorkerLoader%20%7B%0A%20%20load()%20%7B%0A%20%20%20%20super.load()%3B%0A%20%20%20%20%2F%2F%20%E8%87%AA%E5%B7%B1%E6%89%A9%E5%B1%95%0A%20%20%7D%0A%7D%0A%0Aclass%20Application%20extends%20egg.Application%20%7B%0A%20%20get%20%5BEGG_PATH%5D()%20%7B%0A%20%20%20%20%2F%2F%20%E8%BF%94%E5%9B%9E%20framework%20%E8%B7%AF%E5%BE%84%0A%20%20%20%20return%20path.dirname(__dirname)%3B%0A%20%20%7D%0A%20%20%2F%2F%20%E8%A6%86%E7%9B%96%20Egg%20%E7%9A%84%20Loader%EF%BC%8C%E5%90%AF%E5%8A%A8%E6%97%B6%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%20Loader%0A%20%20get%20%5BEGG_LOADER%5D()%20%7B%0A%20%20%20%20return%20YadanAppWorkerLoader%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20%E8%A6%86%E7%9B%96%E4%BA%86%20Egg%20%E7%9A%84%20Application%0Amodule.exports%20%3D%20Object.assign(egg%2C%20%7B%0A%20%20Application%2C%0A%20%20%2F%2F%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%20Loader%20%E4%B9%9F%E9%9C%80%E8%A6%81%20export%EF%BC%8C%E4%B8%8A%E5%B1%82%E6%A1%86%E6%9E%B6%E9%9C%80%E8%A6%81%E5%9F%BA%E4%BA%8E%E8%BF%99%E4%B8%AA%E6%89%A9%E5%B1%95%0A%20%20AppWorkerLoader%3A%20YadanAppWorkerLoader%2C%0A%7D)%3B%0A%60%60%60%0A%0AAgentWorkerLoader%20%E6%89%A9%E5%B1%95%E4%B9%9F%E7%B1%BB%E4%BC%BC%EF%BC%8C%E8%BF%99%E9%87%8C%E4%B8%8D%E5%86%8D%E4%B8%BE%E4%BE%8B%E3%80%82AgentWorkerLoader%20%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%96%87%E4%BB%B6%E5%8F%AF%E4%BB%A5%E4%BA%8E%20AppWorkerLoader%20%E4%B8%8D%E5%90%8C%EF%BC%8C%E6%AF%94%E5%A6%82%EF%BC%9A%E9%BB%98%E8%AE%A4%E5%8A%A0%E8%BD%BD%E6%97%B6%EF%BC%8CEgg%20%E7%9A%84%20AppWorkerLoader%20%E4%BC%9A%E5%8A%A0%E8%BD%BD%20%60app.js%60%20%E8%80%8C%20AgentWorkerLoader%20%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%98%AF%20%60agent.js%60%E3%80%82%0A%0A%23%23%20%E6%A1%86%E6%9E%B6%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86%0A%0A%E6%A1%86%E6%9E%B6%E5%90%AF%E5%8A%A8%E5%9C%A8%5B%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%5D(..%2Fcore%2Fcluster-and-ipc.md)%E3%80%81%5BLoader%5D(.%2Floader.md)%E3%80%81%5B%E6%8F%92%E4%BB%B6%5D(.%2Fplugin.md)%E4%B8%AD%E6%88%96%E5%A4%9A%E6%88%96%E5%B0%91%E9%83%BD%E6%8F%90%E8%BF%87%EF%BC%8C%E8%BF%99%E9%87%8C%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A2%B3%E7%90%86%E4%B8%8B%E5%90%AF%E5%8A%A8%E9%A1%BA%E5%BA%8F%E3%80%82%0A%0A-%20startCluster%20%E5%90%AF%E5%8A%A8%E4%BC%A0%E5%85%A5%20%60baseDir%60%20%E5%92%8C%20%60framework%60%EF%BC%8CMaster%20%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%0A-%20Master%20%E5%85%88%20fork%20Agent%20Worker%0A%20%20-%20%E6%A0%B9%E6%8D%AE%20framework%20%E6%89%BE%E5%88%B0%E6%A1%86%E6%9E%B6%E7%9B%AE%E5%BD%95%EF%BC%8C%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%AF%A5%E6%A1%86%E6%9E%B6%E7%9A%84%20Agent%20%E7%B1%BB%0A%20%20-%20Agent%20%E6%89%BE%E5%88%B0%E5%AE%9A%E4%B9%89%E7%9A%84%20AgentWorkerLoader%EF%BC%8C%E5%BC%80%E5%A7%8B%E8%BF%9B%E8%A1%8C%E5%8A%A0%E8%BD%BD%0A%20%20-%20AgentWorkerLoader%EF%BC%8C%E5%BC%80%E5%A7%8B%E8%BF%9B%E8%A1%8C%E5%8A%A0%E8%BD%BD%20%E6%95%B4%E4%B8%AA%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E6%98%AF%E5%90%8C%E6%AD%A5%E7%9A%84%EF%BC%8C%E6%8C%89%20plugin%20%3E%20config%20%3E%20extend%20%3E%20%60agent.js%60%20%3E%20%E5%85%B6%E4%BB%96%E6%96%87%E4%BB%B6%E9%A1%BA%E5%BA%8F%E5%8A%A0%E8%BD%BD%0A%20%20-%20%60agent.js%60%20%E5%8F%AF%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%8C%E6%94%AF%E6%8C%81%E5%BC%82%E6%AD%A5%E5%90%AF%E5%8A%A8%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%AE%9A%E4%B9%89%E4%BA%86%20beforeStart%20%E4%BC%9A%E7%AD%89%E5%BE%85%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%88%90%E4%B9%8B%E5%90%8E%E9%80%9A%E7%9F%A5%20Master%20%E5%90%AF%E5%8A%A8%E5%AE%8C%E6%88%90%E3%80%82%0A-%20Master%20%E5%BE%97%E5%88%B0%20Agent%20Worker%20%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F%E7%9A%84%E6%B6%88%E6%81%AF%EF%BC%8C%E4%BD%BF%E7%94%A8%20cluster%20fork%20App%20Worker%0A%20%20-%20App%20Worker%20%E6%9C%89%E5%A4%9A%E4%B8%AA%E8%BF%9B%E7%A8%8B%EF%BC%8C%E6%89%80%E4%BB%A5%E8%BF%99%E5%87%A0%E4%B8%AA%E8%BF%9B%E7%A8%8B%E6%98%AF%E5%B9%B6%E8%A1%8C%E5%90%AF%E5%8A%A8%E7%9A%84%EF%BC%8C%E4%BD%86%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91%E6%98%AF%E4%B8%80%E8%87%B4%E7%9A%84%0A%20%20-%20%E5%8D%95%E4%B8%AA%20App%20Worker%20%E5%92%8C%20Agent%20%E7%B1%BB%E4%BC%BC%EF%BC%8C%E9%80%9A%E8%BF%87%20framework%20%E6%89%BE%E5%88%B0%E6%A1%86%E6%9E%B6%E7%9B%AE%E5%BD%95%EF%BC%8C%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%AF%A5%E6%A1%86%E6%9E%B6%E7%9A%84%20Application%20%E7%B1%BB%0A%20%20-%20Application%20%E6%89%BE%E5%88%B0%20AppWorkerLoader%EF%BC%8C%E5%BC%80%E5%A7%8B%E8%BF%9B%E8%A1%8C%E5%8A%A0%E8%BD%BD%EF%BC%8C%E9%A1%BA%E5%BA%8F%E4%B9%9F%E6%98%AF%E7%B1%BB%E4%BC%BC%E7%9A%84%EF%BC%8C%E4%BC%9A%E5%BC%82%E6%AD%A5%E7%AD%89%E5%BE%85%EF%BC%8C%E5%AE%8C%E6%88%90%E5%90%8E%E9%80%9A%E7%9F%A5%20Master%20%E5%90%AF%E5%8A%A8%E5%AE%8C%E6%88%90%0A-%20Master%20%E7%AD%89%E5%BE%85%E5%A4%9A%E4%B8%AA%20App%20Worker%20%E7%9A%84%E6%88%90%E5%8A%9F%E6%B6%88%E6%81%AF%E5%90%8E%E5%90%AF%E5%8A%A8%E5%AE%8C%E6%88%90%EF%BC%8C%E8%83%BD%E5%AF%B9%E5%A4%96%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%E3%80%82%0A%0A%23%23%20%E6%A1%86%E6%9E%B6%E6%B5%8B%E8%AF%95%0A%0A%E5%9C%A8%E7%9C%8B%E4%B8%8B%E6%96%87%E4%B9%8B%E5%89%8D%E8%AF%B7%E5%85%88%E6%9F%A5%E7%9C%8B%5B%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E7%AB%A0%E8%8A%82%5D(..%2Fcore%2Funittest.md)%EF%BC%8C%E6%A1%86%E6%9E%B6%E6%B5%8B%E8%AF%95%E7%9A%84%E5%A4%A7%E9%83%A8%E5%88%86%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E5%92%8C%E5%BA%94%E7%94%A8%E7%B1%BB%E4%BC%BC%E3%80%82%0A%0A%23%23%23%20%E5%88%9D%E5%A7%8B%E5%8C%96%0A%0A%E6%A1%86%E6%9E%B6%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E5%BC%8F%E6%9C%89%E4%B8%80%E5%AE%9A%E5%B7%AE%E5%BC%82%0A%0A%60%60%60js%0Aconst%20mock%20%3D%20require('egg-mock')%3B%0Adescribe('test%2Findex.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20app%3B%0A%20%20before(()%20%3D%3E%20%7B%0A%20%20%20%20app%20%3D%20mock.app(%7B%0A%20%20%20%20%20%20%2F%2F%20%E8%BD%AC%E6%8D%A2%E6%88%90%20test%2Ffixtures%2Fapps%2Fexample%0A%20%20%20%20%20%20baseDir%3A%20'apps%2Fexample'%2C%0A%20%20%20%20%20%20%2F%2F%20%E9%87%8D%E8%A6%81%EF%BC%9A%E9%85%8D%E7%BD%AE%20framework%0A%20%20%20%20%20%20framework%3A%20true%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20return%20app.ready()%3B%0A%20%20%7D)%3B%0A%0A%20%20after(()%20%3D%3E%20app.close())%3B%0A%20%20afterEach(mock.restore)%3B%0A%0A%20%20it('should%20success'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20.expect(200)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A-%20%E6%A1%86%E6%9E%B6%E5%92%8C%E5%BA%94%E7%94%A8%E4%B8%8D%E5%90%8C%EF%BC%8C%E5%BA%94%E7%94%A8%E6%B5%8B%E8%AF%95%E5%BD%93%E5%89%8D%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%80%8C%E6%A1%86%E6%9E%B6%E6%98%AF%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E4%BB%A3%E7%A0%81%EF%BC%8C%E6%89%80%E4%BB%A5%E4%BC%9A%E9%A2%91%E7%B9%81%E6%9B%B4%E6%8D%A2%20baseDir%20%E8%BE%BE%E5%88%B0%E6%B5%8B%E8%AF%95%E5%90%84%E7%A7%8D%E5%BA%94%E7%94%A8%E7%9A%84%E7%9B%AE%E7%9A%84%E3%80%82%0A-%20baseDir%20%E6%9C%89%E6%BD%9C%E8%A7%84%E5%88%99%EF%BC%8C%E6%88%91%E4%BB%AC%E4%B8%80%E8%88%AC%E4%BC%9A%E6%8A%8A%E6%B5%8B%E8%AF%95%E7%9A%84%E5%BA%94%E7%94%A8%E4%BB%A3%E7%A0%81%E6%94%BE%E5%88%B0%20%60test%2Ffixtures%60%20%E4%B8%8B%EF%BC%8C%E6%89%80%E4%BB%A5%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E4%BC%A0%E5%85%A5%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84%E3%80%82%0A-%20%E5%BF%85%E9%A1%BB%E6%8C%87%E5%AE%9A%20%60framework%3A%20true%60%EF%BC%8C%E5%91%8A%E7%9F%A5%E5%BD%93%E5%89%8D%E8%B7%AF%E5%BE%84%E4%B8%BA%E6%A1%86%E6%9E%B6%E8%B7%AF%E5%BE%84%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E4%BC%A0%E5%85%A5%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84%E3%80%82%0A-%20app%20%E5%BA%94%E7%94%A8%E9%9C%80%E8%A6%81%E5%9C%A8%20before%20%E7%AD%89%E5%BE%85%20ready%EF%BC%8C%E4%B8%8D%E7%84%B6%E5%9C%A8%20testcase%20%E9%87%8C%E6%97%A0%E6%B3%95%E8%8E%B7%E5%8F%96%E9%83%A8%E5%88%86%20API%0A-%20%E6%A1%86%E6%9E%B6%E5%9C%A8%E6%B5%8B%E8%AF%95%E5%AE%8C%E6%AF%95%E5%90%8E%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%20%60app.close()%60%20%E5%85%B3%E9%97%AD%EF%BC%8C%E4%B8%8D%E7%84%B6%E4%BC%9A%E6%9C%89%E9%81%97%E7%95%99%E9%97%AE%E9%A2%98%EF%BC%8C%E6%AF%94%E5%A6%82%E6%97%A5%E5%BF%97%E5%86%99%E6%96%87%E4%BB%B6%E6%9C%AA%E5%85%B3%E9%97%AD%E5%AF%BC%E8%87%B4%20fd%20%E4%B8%8D%E5%A4%9F%E3%80%82%0A%0A%23%23%23%20%E7%BC%93%E5%AD%98%0A%0A%E5%9C%A8%E6%B5%8B%E8%AF%95%E5%A4%9A%E7%8E%AF%E5%A2%83%E5%9C%BA%E6%99%AF%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E5%88%B0%20cache%20%E5%8F%82%E6%95%B0%EF%BC%8C%E5%9B%A0%E4%B8%BA%20%60mm.app%60%20%E9%BB%98%E8%AE%A4%E6%9C%89%E7%BC%93%E5%AD%98%EF%BC%8C%E5%BD%93%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%8A%A0%E8%BD%BD%E8%BF%87%E5%90%8E%E5%86%8D%E6%AC%A1%E5%8A%A0%E8%BD%BD%E4%BC%9A%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96%E7%BC%93%E5%AD%98%EF%BC%8C%E9%82%A3%E4%B9%88%E8%AE%BE%E7%BD%AE%E7%9A%84%E7%8E%AF%E5%A2%83%E4%B9%9F%E4%B8%8D%E4%BC%9A%E7%94%9F%E6%95%88%E3%80%82%0A%0A%60%60%60js%0Aconst%20mock%20%3D%20require('egg-mock')%3B%0Adescribe('%2Ftest%2Findex.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20app%3B%0A%20%20afterEach(()%20%3D%3E%20app.close())%3B%0A%0A%20%20it('should%20test%20on%20local'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20mock.env('local')%3B%0A%20%20%20%20app%20%3D%20mock.app(%7B%0A%20%20%20%20%20%20baseDir%3A%20'apps%2Fexample'%2C%0A%20%20%20%20%20%20framework%3A%20true%2C%0A%20%20%20%20%20%20cache%3A%20false%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20return%20app.ready()%3B%0A%20%20%7D)%3B%0A%20%20it('should%20test%20on%20prod'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20mock.env('prod')%3B%0A%20%20%20%20app%20%3D%20mock.app(%7B%0A%20%20%20%20%20%20baseDir%3A%20'apps%2Fexample'%2C%0A%20%20%20%20%20%20framework%3A%20true%2C%0A%20%20%20%20%20%20cache%3A%20false%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20return%20app.ready()%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%23%23%23%20%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%B5%8B%E8%AF%95%0A%0A%E5%BE%88%E5%B0%91%E5%9C%BA%E6%99%AF%E4%BC%9A%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%97%A0%E6%B3%95%E8%BF%9B%E8%A1%8C%20API%20%E7%BA%A7%E5%88%AB%E7%9A%84%20mock%20%E5%AF%BC%E8%87%B4%E6%B5%8B%E8%AF%95%E6%88%90%E6%9C%AC%E5%BE%88%E9%AB%98%EF%BC%8C%E8%80%8C%E8%BF%9B%E7%A8%8B%E5%9C%A8%E6%9C%89%E8%A6%86%E7%9B%96%E7%8E%87%E7%9A%84%E5%9C%BA%E6%99%AF%E5%90%AF%E5%8A%A8%E5%BE%88%E6%85%A2%EF%BC%8C%E6%B5%8B%E8%AF%95%E4%BC%9A%E8%B6%85%E6%97%B6%E3%80%82%E4%BD%86%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%B5%8B%E8%AF%95%E6%98%AF%E9%AA%8C%E8%AF%81%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E6%9C%80%E5%A5%BD%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E6%B5%8B%E8%AF%95%20stdout%20%E5%92%8C%20stderr%E3%80%82%0A%0A%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%B5%8B%E8%AF%95%E5%92%8C%20%60mm.app%60%20%E5%8F%82%E6%95%B0%E4%B8%80%E8%87%B4%EF%BC%8C%E4%BD%86%20app%20%E7%9A%84%20API%20%E5%AE%8C%E5%85%A8%E4%B8%8D%E5%90%8C%EF%BC%8C%E4%B8%8D%E8%BF%87%20SuperTest%20%E4%BE%9D%E7%84%B6%E5%8F%AF%E7%94%A8%E3%80%82%0A%0A%60%60%60js%0Aconst%20mock%20%3D%20require('egg-mock')%3B%0Adescribe('%2Ftest%2Findex.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20app%3B%0A%20%20before(()%20%3D%3E%20%7B%0A%20%20%20%20app%20%3D%20mock.cluster(%7B%0A%20%20%20%20%20%20baseDir%3A%20'apps%2Fexample'%2C%0A%20%20%20%20%20%20framework%3A%20true%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20return%20app.ready()%3B%0A%20%20%7D)%3B%0A%20%20after(()%20%3D%3E%20app.close())%3B%0A%20%20afterEach(mock.restore)%3B%0A%20%20it('should%20success'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20return%20app.httpRequest()%0A%20%20%20%20%20%20.get('%2F')%0A%20%20%20%20%20%20.expect(200)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%B5%8B%E8%AF%95%E8%BF%98%E5%8F%AF%E4%BB%A5%E6%B5%8B%E8%AF%95%20stdout%2Fstderr%EF%BC%8C%E5%9B%A0%E4%B8%BA%20%60mm.cluster%60%20%E6%98%AF%E5%9F%BA%E4%BA%8E%20%5Bcoffee%5D(https%3A%2F%2Fgithub.com%2Fpopomore%2Fcoffee)%20%E6%89%A9%E5%B1%95%E7%9A%84%EF%BC%8C%E5%8F%AF%E8%BF%9B%E8%A1%8C%E8%BF%9B%E7%A8%8B%E6%B5%8B%E8%AF%95%E3%80%82%0A%0A%60%60%60js%0Aconst%20mock%20%3D%20require('egg-mock')%3B%0Adescribe('%2Ftest%2Findex.test.js'%2C%20()%20%3D%3E%20%7B%0A%20%20let%20app%3B%0A%20%20before(()%20%3D%3E%20%7B%0A%20%20%20%20app%20%3D%20mock.cluster(%7B%0A%20%20%20%20%20%20baseDir%3A%20'apps%2Fexample'%2C%0A%20%20%20%20%20%20framework%3A%20true%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20return%20app.ready()%3B%0A%20%20%7D)%3B%0A%20%20after(()%20%3D%3E%20app.close())%3B%0A%20%20it('should%20get%20%60started%60'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%E5%88%A4%E6%96%AD%E7%BB%88%E7%AB%AF%E8%BE%93%E5%87%BA%0A%20%20%20%20app.expect('stdout'%2C%20%2Fstarted%2F)%3B%0A%20%20%7D)%3B%0A%7D)%3B%0A%60%60%60%0A%0A%5Begg-bin%5D%3A%20https%3A%2F%2Fgithub.com%2Feggjs%2Fegg-bin%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>