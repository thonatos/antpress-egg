<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.png"><style class="_styletron_hydrate_"></style><title>多进程研发模式增强</title><meta name="description" content="Born to build better enterprise frameworks and apps"><link href="/static/css/post.d62265dc.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="ant-layout" data-reactroot=""><div class="header-module__header___3ADJ9 ant-layout-header"><div class="ant-row-flex"><div class="ant-col-xs-12 ant-col-md-20 ant-col-lg-2"><div class="header-module__logo___3yTXp"><a href="/"><img src="/logo.svg" alt="logo"/></a></div></div><div class="ant-col-xs-0 ant-col-md-0 ant-col-lg-20"><ul class="ant-menu header-module__menu___3yEtW ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/intro/">指南</a></li><li class="ant-menu-item" role="menuitem"><a href="/api/">API</a></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/tutorials/index.html">教程</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/search?q=topic%3Aegg-plugin&amp;type=Repositories">插件</a></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/eggjs/egg/releases">发布日志</a></li></ul></div><div style="text-align:right" class="ant-col-xs-12 ant-col-md-4 ant-col-lg-2"><button type="button" class="ant-btn"><span>Languages</span></button></div></div></div><div class="ant-layout-content"><div class="basic_layout-module__content___3flpY ant-layout"><div class="sider-module__side___1Cadj ant-layout-sider ant-layout-sider-light" style="flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"><ul class="ant-menu sider-module__menu___2GqPr ant-menu-light ant-menu-root ant-menu-inline" role="menu"><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="0$Menu" aria-haspopup="true"><span>新手指南</span><i class="ant-menu-submenu-arrow"></i></div><ul id="0$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/index.html">Egg.js 是什么?</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/egg-and-koa.html">Egg.js 和 Koa</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/intro/quickstart.html">快速入门</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/progressive.html">渐进式开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/migration.html">2.x 升级指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="1$Menu" aria-haspopup="true"><span>基础功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="1$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/structure.html">目录结构</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/objects.html">内置对象</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/env.html">运行环境</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/config.html">配置</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/middleware.html">中间件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/router.html">Router</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/controller.html">Controller</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/service.html">Service</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/plugin.html">插件</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/schedule.html">定时任务</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/extend.html">框架扩展</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/basics/app-start.html">启动自定义</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="2$Menu" aria-haspopup="true"><span>核心功能</span><i class="ant-menu-submenu-arrow"></i></div><ul id="2$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/development.html">本地开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/unittest.html">单元测试</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/deployment.html">应用部署</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/logger.html">日志</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/httpclient.html">HttpClient</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cookie-and-session.html">Cookie and Session</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/cluster-and-ipc.html">多进程模型和进程间通讯</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/view.html">模板渲染</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/error-handling.html">异常处理</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/security.html">安全</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/core/i18n.html">国际化</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="3$Menu" aria-haspopup="true"><span>教程</span><i class="ant-menu-submenu-arrow"></i></div><ul id="3$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/mysql.html">MySQL</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/restful.html">RESTful API</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/passport.html">Passport 鉴权</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/socketio.html">Socket.IO</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/assets.html">静态资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/tutorials/typescript.html">TypeScript</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="4$Menu" aria-haspopup="true"><span>进阶</span><i class="ant-menu-submenu-arrow"></i></div><ul id="4$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/loader.html">Loader</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/plugin.html">插件开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/framework.html">框架开发</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/cluster-client.html">多进程研发模式增强</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/advanced/view-plugin.html">模板插件开发规范</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/style-guide.html">代码风格指南</a></li></ul></li><li class="ant-menu-submenu ant-menu-submenu-inline ant-menu-submenu-open" role="menuitem"><div style="padding-left:24px" class="ant-menu-submenu-title" aria-expanded="true" aria-owns="5$Menu" aria-haspopup="true"><span>社区</span><i class="ant-menu-submenu-arrow"></i></div><ul id="5$Menu" class="ant-menu  ant-menu-sub ant-menu-inline" role="menu"><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/plugins/">内置插件列表</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/contributing.html">如何贡献</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/resource.html">资源</a></li><li class="ant-menu-item" role="menuitem" style="padding-left:48px"><a href="/zh-cn/faq.html">常见问题</a></li></ul></li></ul></div></div><div class="basic_layout-module__post___2Z7KK ant-layout-content"><div class="ant-row" style="margin-left:-8px;margin-right:-8px"><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-24 ant-col-md-18"><div class="markdown-body" style="font-size:14px"><div><p>在前面的<a href="../core/cluster-and-ipc.md">多进程模型章节</a>中，我们详细讲述了框架的多进程模型，其中适合使用 Agent 进程的有一类常见的场景：一些中间件客户端需要和服务器建立长连接，理论上一台服务器最好只建立一个长连接，但多进程模型会导致 n 倍（n = Worker 进程数）连接被创建。</p><pre><code class="language-bash">+--------+   +--------+
| Client |   | Client |   ... n
+--------+   +--------+
    |  \     /   |
    |    \ /     |        n * m 个链接
    |    / \     |
    |  /     \   |
+--------+   +--------+
| Server |   | Server |   ... m
+--------+   +--------+</code></pre><p>为了尽可能的复用长连接（因为它们对于服务端来说是非常宝贵的资源），我们会把它放到 Agent 进程里维护，然后通过 messenger 将数据传递给各个 Worker。这种做法是可行的，但是往往需要写大量代码去封装接口和实现数据的传递，非常麻烦。</p><p>另外，通过 messenger 传递数据效率是比较低的，因为它会通过 Master 来做中转；万一 IPC 通道出现问题还可能将 Master 进程搞挂。</p><p>那么有没有更好的方法呢？答案是肯定的，我们提供一种新的模式来降低这类客户端封装的复杂度。通过建立 Agent 和 Worker 的 socket 直连跳过 Master 的中转。Agent 作为对外的门面维持多个 Worker 进程的共享连接。</p><h2 id="核心思想">核心思想</h2><ul><li>受到 <a href="http://www.cs.wustl.edu/~schmidt/PDF/lf.pdf">Leader/Follower</a> 模式的启发</li><li>客户端会被区分为两种角色：<ul><li>Leader: 负责和远程服务端维持连接，对于同一类的客户端只有一个 Leader</li><li>Follower: 会将具体的操作委托给 Leader，常见的是订阅模型（让 Leader 和远程服务端交互，并等待其返回）。</li></ul></li><li>如何确定谁是 Leader，谁是 Follower 呢？有两种模式：<ul><li>自由竞争模式：客户端启动的时候通过本地端口的争夺来确定 Leader。例如：大家都尝试监听 7777 端口，最后只会有一个实例抢占到，那它就变成 Leader，其余的都是 Follower。</li><li>强制指定模式：框架指定某一个 Leader，其余的就是 Follower</li></ul></li><li>框架里面我们采用的是强制指定模式，Leader 只能在 Agent 里面创建，这也符合我们对 Agent 的定位</li><li>框架启动的时候 Master 会随机选择一个可用的端口作为 Cluster Client 监听的通讯端口，并将它通过参数传递给 Agent 和 App Worker</li><li>Leader 和 Follower 之间通过 socket 直连（通过通讯端口），不再需要 Master 中转</li></ul><p>新的模式下，客户端的通信方式如下：</p><pre><code class="language-js">             +-------+
             | start |
             +---+---+
                 |
        +--------+---------+
      __| port competition |__
win /   +------------------+  \ lose
   /                           \
+---------------+     tcp conn     +-------------------+
| Leader(Agent) |&lt;----------------&gt;| Follower(Worker1) |
+---------------+                  +-------------------+
    |            \ tcp conn
    |             \
+--------+         +-------------------+
| Client |         | Follower(Worker2) |
+--------+         +-------------------+</code></pre><h2 id="客户端接口类型抽象">客户端接口类型抽象</h2><p>我们将客户端接口抽象为下面两大类，这也是对客户端接口的一个规范，对于符合规范的客户端，我们可以自动将其包装为 Leader/Follower 模式</p><ul><li>订阅、发布类（subscribe / publish）<ul><li><code>subscribe(info, listener)</code> 接口包含两个参数，第一个是订阅的信息，第二个是订阅的回调函数</li><li><code>publish(info)</code> 接口包含一个参数，就是订阅的信息</li></ul></li><li>调用类 (invoke)，支持 callback, promise 和 generator function 三种风格的接口，但是推荐使用 generator function。</li></ul><p>客户端示例</p><pre><code class="language-js">const Base = require(&#x27;sdk-base&#x27;);

class Client extends Base {
  constructor(options) {
    super(options);
    // 在初始化成功以后记得 ready
    this.ready(true);
  }

  /**
   * 订阅
   *
   * @param {Object} info - 订阅的信息（一个 JSON 对象，注意尽量不要包含 Function, Buffer, Date 这类属性）
   * @param {Function} listener - 监听的回调函数，接收一个参数就是监听到的结果对象
   */
  subscribe(info, listener) {
    // ...
  }

  /**
   * 发布
   *
   * @param {Object} info - 发布的信息，和上面 subscribe 的 info 类似
   */
  publish(info) {
    // ...
  }

  /**
   * 获取数据 (invoke)
   *
   * @param {String} id - id
   * @return {Object} result
   */
  async getData(id) {
    // ...
  }
}</code></pre><h2 id="异常处理">异常处理</h2><ul><li>Leader 如果“死掉”会触发新一轮的端口争夺，争夺到端口的那个实例被推选为新的 Leader</li><li>为保证 Leader 和 Follower 之间的通道健康，需要引入定时心跳检查机制，如果 Follower 在固定时间内没有发送心跳包，那么 Leader 会将 Follower 主动断开，从而触发 Follower 的重新初始化</li></ul><h2 id="协议和调用时序">协议和调用时序</h2><p>Leader 和 Follower 通过下面的协议进行数据交换：</p><pre><code class="language-js"> 0       1       2               4                                                              12
 +-------+-------+---------------+---------------------------------------------------------------+
 |version|req/res|    reserved   |                          request id                           |
 +-------------------------------+-------------------------------+-------------------------------+
 |           timeout             |   connection object length    |   application object length   |
 +-------------------------------+---------------------------------------------------------------+
 |         conn object (JSON format)  ...                    |            app object             |
 +-----------------------------------------------------------+                                   |
 |                                          ...                                                  |
 +-----------------------------------------------------------------------------------------------+</code></pre><ol><li>在通讯端口上 Leader 启动一个 Local Server，所有的 Leader/Follower 通讯都经过 Local Server</li><li>Follower 连接上 Local Server 后，首先发送一个 register channel 的 packet（引入 channel 的概念是为了区别不同类型的客户端）</li><li>Local Server 会将 Follower 分配给指定的 Leader（根据客户端类型进行配对）</li><li>Follower 向 Leader 发送订阅、发布请求，</li><li>Leader 在订阅数据变更时通过 subscribe result packet 通知 Follower</li><li>Follower 向 Leader 发送调用请求，Leader 收到后执行相应操作后返回结果</li></ol><pre><code class="language-js"> +----------+             +---------------+          +---------+
 | Follower |             |  Local Server |          |  Leader |
 +----------+             +---------------+          +---------+
      |     register channel     |       assign to        |
      + -----------------------&gt; |  --------------------&gt; |
      |                          |                        |
      |                                subscribe          |
      + ------------------------------------------------&gt; |
      |                                 publish           |
      + ------------------------------------------------&gt; |
      |                                                   |
      |       subscribe result                            |
      | &lt;------------------------------------------------ +
      |                                                   |
      |                                 invoke            |
      + ------------------------------------------------&gt; |
      |          invoke result                            |
      | &lt;------------------------------------------------ +
      |                                                   |</code></pre><h2 id="具体的使用方法">具体的使用方法</h2><p>下面我用一个简单的例子，介绍在框架里面如何让一个客户端支持 Leader/Follower 模式</p><ul><li>第一步，我们的客户端最好是符合上面提到过的接口约定，例如：</li></ul><pre><code class="language-js">// registry_client.js
const URL = require(&#x27;url&#x27;);
const Base = require(&#x27;sdk-base&#x27;);

class RegistryClient extends Base {
  constructor(options) {
    super({
      // 指定异步启动的方法
      initMethod: &#x27;init&#x27;,
    });
    this._options = options;
    this._registered = new Map();
  }

  /**
   * 启动逻辑
   */
  async init() {
    this.ready(true);
  }

  /**
   * 获取配置
   * @param {String} dataId - the dataId
   * @return {Object} 配置
   */
  async getConfig(dataId) {
    return this._registered.get(dataId);
  }

  /**
   * 订阅
   * @param {Object} reg
   *   - {String} dataId - the dataId
   * @param {Function}  listener - the listener
   */
  subscribe(reg, listener) {
    const key = reg.dataId;
    this.on(key, listener);

    const data = this._registered.get(key);
    if (data) {
      process.nextTick(() =&gt; listener(data));
    }
  }

  /**
   * 发布
   * @param {Object} reg
   *   - {String} dataId - the dataId
   *   - {String} publishData - the publish data
   */
  publish(reg) {
    const key = reg.dataId;
    let changed = false;

    if (this._registered.has(key)) {
      const arr = this._registered.get(key);
      if (arr.indexOf(reg.publishData) === -1) {
        changed = true;
        arr.push(reg.publishData);
      }
    } else {
      changed = true;
      this._registered.set(key, [reg.publishData]);
    }
    if (changed) {
      this.emit(key, this._registered.get(key).map(url =&gt; URL.parse(url, true)));
    }
  }
}

module.exports = RegistryClient;</code></pre><ul><li>第二步，使用 <code>agent.cluster</code> 接口对 RegistryClient 进行封装</li></ul><pre><code class="language-js">// agent.js
const RegistryClient = require(&#x27;registry_client&#x27;);

module.exports = agent =&gt; {
  // 对 RegistryClient 进行封装和实例化
  agent.registryClient = agent.cluster(RegistryClient)
    // create 方法的参数就是 RegistryClient 构造函数的参数
    .create({});

  agent.beforeStart(async () =&gt; {
    await agent.registryClient.ready();
    agent.coreLogger.info(&#x27;registry client is ready&#x27;);
  });
};</code></pre><ul><li>第三步，使用 <code>app.cluster</code> 接口对 RegistryClient 进行封装</li></ul><pre><code class="language-js">// app.js
const RegistryClient = require(&#x27;registry_client&#x27;);

module.exports = app =&gt; {
  app.registryClient = app.cluster(RegistryClient).create({});
  app.beforeStart(async () =&gt; {
    await app.registryClient.ready();
    app.coreLogger.info(&#x27;registry client is ready&#x27;);

    // 调用 subscribe 进行订阅
    app.registryClient.subscribe({
      dataId: &#x27;demo.DemoService&#x27;,
    }, val =&gt; {
      // ...
    });

    // 调用 publish 发布数据
    app.registryClient.publish({
      dataId: &#x27;demo.DemoService&#x27;,
      publishData: &#x27;xxx&#x27;,
    });

    // 调用 getConfig 接口
    const res = await app.registryClient.getConfig(&#x27;demo.DemoService&#x27;);
    console.log(res);
  });
};</code></pre><p>是不是很简单？</p><p>当然，如果你的客户端不是那么『标准』，那你可能需要用到其他一些 API，比如，你的订阅函数不叫 subscribe，叫 sub</p><pre><code class="language-js">class MockClient extends Base {
  constructor(options) {
    super({
      initMethod: &#x27;init&#x27;,
    });
    this._options = options;
    this._registered = new Map();
  }

  async init() {
    this.ready(true);
  }

  sub(info, listener) {
    const key = reg.dataId;
    this.on(key, listener);

    const data = this._registered.get(key);
    if (data) {
      process.nextTick(() =&gt; listener(data));
    }
  }

  ...
}</code></pre><p>你需要用 delegate API 手动设置</p><pre><code class="language-js">// agent.js
module.exports = agent =&gt; {
  agent.mockClient = agent.cluster(MockClient)
    // 将 sub 代理到 subscribe 逻辑上
    .delegate(&#x27;sub&#x27;, &#x27;subscribe&#x27;)
    .create();

  agent.beforeStart(async () =&gt; {
    await agent.mockClient.ready();
  });
};</code></pre><pre><code class="language-js">// app.js
module.exports = app =&gt; {
  app.mockClient = app.cluster(MockClient)
    // 将 sub 代理到 subscribe 逻辑上
    .delegate(&#x27;sub&#x27;, &#x27;subscribe&#x27;)
    .create();

  app.beforeStart(async () =&gt; {
    await app.mockClient.ready();

    app.sub({ id: &#x27;test-id&#x27; }, val =&gt; {
      // put your code here
    });
  });
};</code></pre><p>我们已经理解，通过 cluster-client 可以让我们在不理解多进程模型的情况下开发『纯粹』的 RegistryClient，只负责和服务端进行交互，然后使用 cluster-client 进行简单的 wrap 就可以得到一个支持多进程模型的 ClusterClient。这里的 RegistryClient 实际上是一个专门负责和远程服务通信进行数据通信的 DataClient。</p><p>大家可能已经发现，ClusterClient 同时带来了一些约束，如果想在各进程暴露同样的方法，那么 RegistryClient 上只能支持 sub/pub 模式以及异步的 API 调用。因为在多进程模型中所有的交互都必须经过 socket 通信，势必带来了这一约束。</p><p>假设我们要实现一个同步的 get 方法，subscribe 过的数据直接放入内存，使用 get 方法时直接返回。要怎么实现呢？而真实情况可能比这更复杂。</p><p>在这里，我们引入一个 APIClient 的最佳实践。对于有读取缓存数据等同步 API 需求的模块，在 RegistryClient 基础上再封装一个 APIClient 来实现这些与远程服务端交互无关的 API，暴露给用户使用到的是这个 APIClient 的实例。</p><p>在 APIClient 内部实现上：</p><ul><li>异步数据获取，通过调用基于 ClusterClient 的 RegistryClient 的 API 实现。</li><li>同步调用等与服务端无关的接口在 APIClient 上实现。由于 ClusterClient 的 API 已经抹平了多进程差异，所以在开发 APIClient 调用到 RegistryClient 时也无需关心多进程模型。</li></ul><p>例如在模块的 APIClient 中增加带缓存的 get 同步方法：</p><pre><code class="language-js">// some-client/index.js
const cluster = require(&#x27;cluster-client&#x27;);
const RegistryClient = require(&#x27;./registry_client&#x27;);

class APIClient extends Base {
  constructor(options) {
    super(options);

    // options.cluster 用于给 Egg 的插件传递 app.cluster 进来
    this._client = (options.cluster || cluster)(RegistryClient).create(options);
    this._client.ready(() =&gt; this.ready(true));

    this._cache = {};

    // subMap:
    // {
    //   foo: reg1,
    //   bar: reg2,
    // }
    const subMap = options.subMap;

    for (const key in subMap) {
      this.subscribe(subMap[key], value =&gt; {
        this._cache[key] = value;
      });
    }
  }

  subscribe(reg, listener) {
    this._client.subscribe(reg, listener);
  }

  publish(reg) {
    this._client.publish(reg);
  }

  get(key) {
    return this._cache[key];
  }
}

// 最终模块向外暴露这个 APIClient
module.exports = APIClient;</code></pre><p>那么我们就可以这么使用该模块：</p><pre><code class="language-js">// app.js || agent.js
const APIClient = require(&#x27;some-client&#x27;); // 上面那个模块
module.exports = app =&gt; {
  const config = app.config.apiClient;
  app.apiClient = new APIClient(Object.assign({}, config, { cluster: app.cluster });
  app.beforeStart(async () =&gt; {
    await app.apiClient.ready();
  });
};

// config.${env}.js
exports.apiClient = {
  subMap: {
    foo: {
      id: &#x27;&#x27;,
    },
    // bar...
  }
};</code></pre><p>为了方便你封装 <code>APIClient</code>，在 <a href="https://www.npmjs.com/package/cluster-client">cluster-client</a> 模块中提供了一个 <code>APIClientBase</code> 基类，那么上面的 <code>APIClient</code> 可以改写为：</p><pre><code class="language-js">const APIClientBase = require(&#x27;cluster-client&#x27;).APIClientBase;
const RegistryClient = require(&#x27;./registry_client&#x27;);

class APIClient extends APIClientBase {
  // 返回原始的客户端类
  get DataClient() {
    return RegistryClient;
  }

  // 用于设置 cluster-client 相关参数，等同于 cluster 方法的第二个参数
  get clusterOptions() {
    return {
      responseTimeout: 120 * 1000,
    };
  }

  subscribe(reg, listener) {
    this._client.subscribe(reg, listener);
  }

  publish(reg) {
    this._client.publish(reg);
  }

  get(key) {
    return this._cache[key];
  }
}</code></pre><p>总结一下：</p><pre><code class="language-bash">+------------------------------------------------+
| APIClient                                      |
|       +----------------------------------------|
|       | ClusterClient                          |
|       |      +---------------------------------|
|       |      | RegistryClient                  |
+------------------------------------------------+</code></pre><ul><li>RegistryClient - 负责和远端服务通讯，实现数据的存取，只支持异步 API，不关心多进程模型。</li><li>ClusterClient - 通过 cluster-client 模块进行简单 wrap 得到的 client 实例，负责自动抹平多进程模型的差异。</li><li>APIClient - 内部调用 ClusterClient 做数据同步，无需关心多进程模型，用户最终使用的模块。API 都通过此处暴露，支持同步和异步。</li></ul><p>有兴趣的同学可以看一下<a href="https://github.com/eggjs/egg/issues/322">增强多进程研发模式</a> 讨论过程。</p><h2 id="在框架里面-cluster-client-相关的配置项">在框架里面 cluster-client 相关的配置项</h2><pre><code class="language-js">/**
 * @property {Number} responseTimeout - response timeout, default is 60000
 * @property {Transcode} [transcode]
 *   - {Function} encode - custom serialize method
 *   - {Function} decode - custom deserialize method
 */
config.clusterClient = {
  responseTimeout: 60000,
};</code></pre><table><thead><tr><th>配置项</th><th>类型</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>responseTimeout</td><td>number</td><td>60000 （一分钟）</td><td>全局的进程间通讯的超时时长，不能设置的太短，因为代理的接口本身也有超时设置</td></tr><tr><td>transcode</td><td>function</td><td>N/A</td><td>进程间通讯的序列化方式，默认采用 <a href="https://www.npmjs.com/package/serialize-json">serialize-json</a>（建议不要自行设置）</td></tr></tbody></table><p>上面是全局的配置方式。如果，你想对一个客户端单独做设置</p><ul><li>可以通过 <code>app/agent.cluster(ClientClass, options)</code> 的第二个参数 <code>options</code> 进行覆盖</li></ul><pre><code class="language-js">app.registryClient = app.cluster(RegistryClient, {
  responseTimeout: 120 * 1000, // 这里传入的是和 cluster-client 相关的参数
}).create({
  // 这里传入的是 RegistryClient 需要的参数
});</code></pre><ul><li>也可以通过覆盖 <code>APIClientBase</code> 的 <code>clusterOptions</code> 这个 <code>getter</code> 属性</li></ul><pre><code class="language-js">const APIClientBase = require(&#x27;cluster-client&#x27;).APIClientBase;
const RegistryClient = require(&#x27;./registry_client&#x27;);

class APIClient extends APIClientBase {
  get DataClient() {
    return RegistryClient;
  }

  get clusterOptions() {
    return {
      responseTimeout: 120 * 1000,
    };
  }

  // ...
}

module.exports = APIClient;</code></pre></div></div></div><div style="padding-left:8px;padding-right:8px" class="ant-col-xs-0 ant-col-md-6"><div class="markdown-body" style="font-size:14px"><div><ul><li><a href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3">核心思想</a></li><li><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%8F%A3%E7%B1%BB%E5%9E%8B%E6%8A%BD%E8%B1%A1">客户端接口类型抽象</a></li><li><a href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">异常处理</a></li><li><a href="#%E5%8D%8F%E8%AE%AE%E5%92%8C%E8%B0%83%E7%94%A8%E6%97%B6%E5%BA%8F">协议和调用时序</a></li><li><a href="#%E5%85%B7%E4%BD%93%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">具体的使用方法</a></li><li><a href="#%E5%9C%A8%E6%A1%86%E6%9E%B6%E9%87%8C%E9%9D%A2-cluster-client-%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9">在框架里面 cluster-client 相关的配置项</a></li></ul></div></div></div></div></div></div></div></div></div><script type="text/javascript">window.__INIT_STATE__={"lang":"zh","props":{"toc":"-%20%5B%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3%5D(%23%25E6%25A0%25B8%25E5%25BF%2583%25E6%2580%259D%25E6%2583%25B3)%0A-%20%5B%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%8F%A3%E7%B1%BB%E5%9E%8B%E6%8A%BD%E8%B1%A1%5D(%23%25E5%25AE%25A2%25E6%2588%25B7%25E7%25AB%25AF%25E6%258E%25A5%25E5%258F%25A3%25E7%25B1%25BB%25E5%259E%258B%25E6%258A%25BD%25E8%25B1%25A1)%0A-%20%5B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%5D(%23%25E5%25BC%2582%25E5%25B8%25B8%25E5%25A4%2584%25E7%2590%2586)%0A-%20%5B%E5%8D%8F%E8%AE%AE%E5%92%8C%E8%B0%83%E7%94%A8%E6%97%B6%E5%BA%8F%5D(%23%25E5%258D%258F%25E8%25AE%25AE%25E5%2592%258C%25E8%25B0%2583%25E7%2594%25A8%25E6%2597%25B6%25E5%25BA%258F)%0A-%20%5B%E5%85%B7%E4%BD%93%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%5D(%23%25E5%2585%25B7%25E4%25BD%2593%25E7%259A%2584%25E4%25BD%25BF%25E7%2594%25A8%25E6%2596%25B9%25E6%25B3%2595)%0A-%20%5B%E5%9C%A8%E6%A1%86%E6%9E%B6%E9%87%8C%E9%9D%A2%20cluster-client%20%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%5D(%23%25E5%259C%25A8%25E6%25A1%2586%25E6%259E%25B6%25E9%2587%258C%25E9%259D%25A2-cluster-client-%25E7%259B%25B8%25E5%2585%25B3%25E7%259A%2584%25E9%2585%258D%25E7%25BD%25AE%25E9%25A1%25B9)","meta":{"info":{"title":"多进程研发模式增强"}},"content":"%0A%0A%0A%E5%9C%A8%E5%89%8D%E9%9D%A2%E7%9A%84%5B%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E7%AB%A0%E8%8A%82%5D(..%2Fcore%2Fcluster-and-ipc.md)%E4%B8%AD%EF%BC%8C%E6%88%91%E4%BB%AC%E8%AF%A6%E7%BB%86%E8%AE%B2%E8%BF%B0%E4%BA%86%E6%A1%86%E6%9E%B6%E7%9A%84%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%EF%BC%8C%E5%85%B6%E4%B8%AD%E9%80%82%E5%90%88%E4%BD%BF%E7%94%A8%20Agent%20%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%9C%89%E4%B8%80%E7%B1%BB%E5%B8%B8%E8%A7%81%E7%9A%84%E5%9C%BA%E6%99%AF%EF%BC%9A%E4%B8%80%E4%BA%9B%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%9C%80%E8%A6%81%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BB%BA%E7%AB%8B%E9%95%BF%E8%BF%9E%E6%8E%A5%EF%BC%8C%E7%90%86%E8%AE%BA%E4%B8%8A%E4%B8%80%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9C%80%E5%A5%BD%E5%8F%AA%E5%BB%BA%E7%AB%8B%E4%B8%80%E4%B8%AA%E9%95%BF%E8%BF%9E%E6%8E%A5%EF%BC%8C%E4%BD%86%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%BC%9A%E5%AF%BC%E8%87%B4%20n%20%E5%80%8D%EF%BC%88n%20%3D%20Worker%20%E8%BF%9B%E7%A8%8B%E6%95%B0%EF%BC%89%E8%BF%9E%E6%8E%A5%E8%A2%AB%E5%88%9B%E5%BB%BA%E3%80%82%0A%0A%60%60%60bash%0A%2B--------%2B%20%20%20%2B--------%2B%0A%7C%20Client%20%7C%20%20%20%7C%20Client%20%7C%20%20%20...%20n%0A%2B--------%2B%20%20%20%2B--------%2B%0A%20%20%20%20%7C%20%20%5C%20%20%20%20%20%2F%20%20%20%7C%0A%20%20%20%20%7C%20%20%20%20%5C%20%2F%20%20%20%20%20%7C%20%20%20%20%20%20%20%20n%20*%20m%20%E4%B8%AA%E9%93%BE%E6%8E%A5%0A%20%20%20%20%7C%20%20%20%20%2F%20%5C%20%20%20%20%20%7C%0A%20%20%20%20%7C%20%20%2F%20%20%20%20%20%5C%20%20%20%7C%0A%2B--------%2B%20%20%20%2B--------%2B%0A%7C%20Server%20%7C%20%20%20%7C%20Server%20%7C%20%20%20...%20m%0A%2B--------%2B%20%20%20%2B--------%2B%0A%60%60%60%0A%0A%E4%B8%BA%E4%BA%86%E5%B0%BD%E5%8F%AF%E8%83%BD%E7%9A%84%E5%A4%8D%E7%94%A8%E9%95%BF%E8%BF%9E%E6%8E%A5%EF%BC%88%E5%9B%A0%E4%B8%BA%E5%AE%83%E4%BB%AC%E5%AF%B9%E4%BA%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%9D%A5%E8%AF%B4%E6%98%AF%E9%9D%9E%E5%B8%B8%E5%AE%9D%E8%B4%B5%E7%9A%84%E8%B5%84%E6%BA%90%EF%BC%89%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BC%9A%E6%8A%8A%E5%AE%83%E6%94%BE%E5%88%B0%20Agent%20%E8%BF%9B%E7%A8%8B%E9%87%8C%E7%BB%B4%E6%8A%A4%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%9A%E8%BF%87%20messenger%20%E5%B0%86%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92%E7%BB%99%E5%90%84%E4%B8%AA%20Worker%E3%80%82%E8%BF%99%E7%A7%8D%E5%81%9A%E6%B3%95%E6%98%AF%E5%8F%AF%E8%A1%8C%E7%9A%84%EF%BC%8C%E4%BD%86%E6%98%AF%E5%BE%80%E5%BE%80%E9%9C%80%E8%A6%81%E5%86%99%E5%A4%A7%E9%87%8F%E4%BB%A3%E7%A0%81%E5%8E%BB%E5%B0%81%E8%A3%85%E6%8E%A5%E5%8F%A3%E5%92%8C%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E7%9A%84%E4%BC%A0%E9%80%92%EF%BC%8C%E9%9D%9E%E5%B8%B8%E9%BA%BB%E7%83%A6%E3%80%82%0A%0A%E5%8F%A6%E5%A4%96%EF%BC%8C%E9%80%9A%E8%BF%87%20messenger%20%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE%E6%95%88%E7%8E%87%E6%98%AF%E6%AF%94%E8%BE%83%E4%BD%8E%E7%9A%84%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AE%83%E4%BC%9A%E9%80%9A%E8%BF%87%20Master%20%E6%9D%A5%E5%81%9A%E4%B8%AD%E8%BD%AC%EF%BC%9B%E4%B8%87%E4%B8%80%20IPC%20%E9%80%9A%E9%81%93%E5%87%BA%E7%8E%B0%E9%97%AE%E9%A2%98%E8%BF%98%E5%8F%AF%E8%83%BD%E5%B0%86%20Master%20%E8%BF%9B%E7%A8%8B%E6%90%9E%E6%8C%82%E3%80%82%0A%0A%E9%82%A3%E4%B9%88%E6%9C%89%E6%B2%A1%E6%9C%89%E6%9B%B4%E5%A5%BD%E7%9A%84%E6%96%B9%E6%B3%95%E5%91%A2%EF%BC%9F%E7%AD%94%E6%A1%88%E6%98%AF%E8%82%AF%E5%AE%9A%E7%9A%84%EF%BC%8C%E6%88%91%E4%BB%AC%E6%8F%90%E4%BE%9B%E4%B8%80%E7%A7%8D%E6%96%B0%E7%9A%84%E6%A8%A1%E5%BC%8F%E6%9D%A5%E9%99%8D%E4%BD%8E%E8%BF%99%E7%B1%BB%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B0%81%E8%A3%85%E7%9A%84%E5%A4%8D%E6%9D%82%E5%BA%A6%E3%80%82%E9%80%9A%E8%BF%87%E5%BB%BA%E7%AB%8B%20Agent%20%E5%92%8C%20Worker%20%E7%9A%84%20socket%20%E7%9B%B4%E8%BF%9E%E8%B7%B3%E8%BF%87%20Master%20%E7%9A%84%E4%B8%AD%E8%BD%AC%E3%80%82Agent%20%E4%BD%9C%E4%B8%BA%E5%AF%B9%E5%A4%96%E7%9A%84%E9%97%A8%E9%9D%A2%E7%BB%B4%E6%8C%81%E5%A4%9A%E4%B8%AA%20Worker%20%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%85%B1%E4%BA%AB%E8%BF%9E%E6%8E%A5%E3%80%82%0A%0A%23%23%20%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3%0A%0A-%20%E5%8F%97%E5%88%B0%20%5BLeader%2FFollower%5D(http%3A%2F%2Fwww.cs.wustl.edu%2F~schmidt%2FPDF%2Flf.pdf)%20%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%90%AF%E5%8F%91%0A-%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BC%9A%E8%A2%AB%E5%8C%BA%E5%88%86%E4%B8%BA%E4%B8%A4%E7%A7%8D%E8%A7%92%E8%89%B2%EF%BC%9A%0A%20%20-%20Leader%3A%20%E8%B4%9F%E8%B4%A3%E5%92%8C%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%BB%B4%E6%8C%81%E8%BF%9E%E6%8E%A5%EF%BC%8C%E5%AF%B9%E4%BA%8E%E5%90%8C%E4%B8%80%E7%B1%BB%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%20Leader%0A%20%20-%20Follower%3A%20%E4%BC%9A%E5%B0%86%E5%85%B7%E4%BD%93%E7%9A%84%E6%93%8D%E4%BD%9C%E5%A7%94%E6%89%98%E7%BB%99%20Leader%EF%BC%8C%E5%B8%B8%E8%A7%81%E7%9A%84%E6%98%AF%E8%AE%A2%E9%98%85%E6%A8%A1%E5%9E%8B%EF%BC%88%E8%AE%A9%20Leader%20%E5%92%8C%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BA%A4%E4%BA%92%EF%BC%8C%E5%B9%B6%E7%AD%89%E5%BE%85%E5%85%B6%E8%BF%94%E5%9B%9E%EF%BC%89%E3%80%82%0A-%20%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E8%B0%81%E6%98%AF%20Leader%EF%BC%8C%E8%B0%81%E6%98%AF%20Follower%20%E5%91%A2%EF%BC%9F%E6%9C%89%E4%B8%A4%E7%A7%8D%E6%A8%A1%E5%BC%8F%EF%BC%9A%0A%20%20-%20%E8%87%AA%E7%94%B1%E7%AB%9E%E4%BA%89%E6%A8%A1%E5%BC%8F%EF%BC%9A%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%AF%E5%8A%A8%E7%9A%84%E6%97%B6%E5%80%99%E9%80%9A%E8%BF%87%E6%9C%AC%E5%9C%B0%E7%AB%AF%E5%8F%A3%E7%9A%84%E4%BA%89%E5%A4%BA%E6%9D%A5%E7%A1%AE%E5%AE%9A%20Leader%E3%80%82%E4%BE%8B%E5%A6%82%EF%BC%9A%E5%A4%A7%E5%AE%B6%E9%83%BD%E5%B0%9D%E8%AF%95%E7%9B%91%E5%90%AC%207777%20%E7%AB%AF%E5%8F%A3%EF%BC%8C%E6%9C%80%E5%90%8E%E5%8F%AA%E4%BC%9A%E6%9C%89%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B%E6%8A%A2%E5%8D%A0%E5%88%B0%EF%BC%8C%E9%82%A3%E5%AE%83%E5%B0%B1%E5%8F%98%E6%88%90%20Leader%EF%BC%8C%E5%85%B6%E4%BD%99%E7%9A%84%E9%83%BD%E6%98%AF%20Follower%E3%80%82%0A%20%20-%20%E5%BC%BA%E5%88%B6%E6%8C%87%E5%AE%9A%E6%A8%A1%E5%BC%8F%EF%BC%9A%E6%A1%86%E6%9E%B6%E6%8C%87%E5%AE%9A%E6%9F%90%E4%B8%80%E4%B8%AA%20Leader%EF%BC%8C%E5%85%B6%E4%BD%99%E7%9A%84%E5%B0%B1%E6%98%AF%20Follower%0A-%20%E6%A1%86%E6%9E%B6%E9%87%8C%E9%9D%A2%E6%88%91%E4%BB%AC%E9%87%87%E7%94%A8%E7%9A%84%E6%98%AF%E5%BC%BA%E5%88%B6%E6%8C%87%E5%AE%9A%E6%A8%A1%E5%BC%8F%EF%BC%8CLeader%20%E5%8F%AA%E8%83%BD%E5%9C%A8%20Agent%20%E9%87%8C%E9%9D%A2%E5%88%9B%E5%BB%BA%EF%BC%8C%E8%BF%99%E4%B9%9F%E7%AC%A6%E5%90%88%E6%88%91%E4%BB%AC%E5%AF%B9%20Agent%20%E7%9A%84%E5%AE%9A%E4%BD%8D%0A-%20%E6%A1%86%E6%9E%B6%E5%90%AF%E5%8A%A8%E7%9A%84%E6%97%B6%E5%80%99%20Master%20%E4%BC%9A%E9%9A%8F%E6%9C%BA%E9%80%89%E6%8B%A9%E4%B8%80%E4%B8%AA%E5%8F%AF%E7%94%A8%E7%9A%84%E7%AB%AF%E5%8F%A3%E4%BD%9C%E4%B8%BA%20Cluster%20Client%20%E7%9B%91%E5%90%AC%E7%9A%84%E9%80%9A%E8%AE%AF%E7%AB%AF%E5%8F%A3%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%AE%83%E9%80%9A%E8%BF%87%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E7%BB%99%20Agent%20%E5%92%8C%20App%20Worker%0A-%20Leader%20%E5%92%8C%20Follower%20%E4%B9%8B%E9%97%B4%E9%80%9A%E8%BF%87%20socket%20%E7%9B%B4%E8%BF%9E%EF%BC%88%E9%80%9A%E8%BF%87%E9%80%9A%E8%AE%AF%E7%AB%AF%E5%8F%A3%EF%BC%89%EF%BC%8C%E4%B8%8D%E5%86%8D%E9%9C%80%E8%A6%81%20Master%20%E4%B8%AD%E8%BD%AC%0A%0A%E6%96%B0%E7%9A%84%E6%A8%A1%E5%BC%8F%E4%B8%8B%EF%BC%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%0A%60%60%60js%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%2B-------%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20start%20%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%2B---%2B---%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%20%20%2B--------%2B---------%2B%0A%20%20%20%20%20%20__%7C%20port%20competition%20%7C__%0Awin%20%2F%20%20%20%2B------------------%2B%20%20%5C%20lose%0A%20%20%20%2F%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%0A%2B---------------%2B%20%20%20%20%20tcp%20conn%20%20%20%20%20%2B-------------------%2B%0A%7C%20Leader(Agent)%20%7C%3C----------------%3E%7C%20Follower(Worker1)%20%7C%0A%2B---------------%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B-------------------%2B%0A%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%5C%20tcp%20conn%0A%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%0A%2B--------%2B%20%20%20%20%20%20%20%20%20%2B-------------------%2B%0A%7C%20Client%20%7C%20%20%20%20%20%20%20%20%20%7C%20Follower(Worker2)%20%7C%0A%2B--------%2B%20%20%20%20%20%20%20%20%20%2B-------------------%2B%0A%60%60%60%0A%0A%23%23%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%8F%A3%E7%B1%BB%E5%9E%8B%E6%8A%BD%E8%B1%A1%0A%0A%E6%88%91%E4%BB%AC%E5%B0%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%8F%A3%E6%8A%BD%E8%B1%A1%E4%B8%BA%E4%B8%8B%E9%9D%A2%E4%B8%A4%E5%A4%A7%E7%B1%BB%EF%BC%8C%E8%BF%99%E4%B9%9F%E6%98%AF%E5%AF%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%8F%A3%E7%9A%84%E4%B8%80%E4%B8%AA%E8%A7%84%E8%8C%83%EF%BC%8C%E5%AF%B9%E4%BA%8E%E7%AC%A6%E5%90%88%E8%A7%84%E8%8C%83%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E8%87%AA%E5%8A%A8%E5%B0%86%E5%85%B6%E5%8C%85%E8%A3%85%E4%B8%BA%20Leader%2FFollower%20%E6%A8%A1%E5%BC%8F%0A%0A-%20%E8%AE%A2%E9%98%85%E3%80%81%E5%8F%91%E5%B8%83%E7%B1%BB%EF%BC%88subscribe%20%2F%20publish%EF%BC%89%0A%20%20-%20%60subscribe(info%2C%20listener)%60%20%E6%8E%A5%E5%8F%A3%E5%8C%85%E5%90%AB%E4%B8%A4%E4%B8%AA%E5%8F%82%E6%95%B0%EF%BC%8C%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%98%AF%E8%AE%A2%E9%98%85%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%8C%E7%AC%AC%E4%BA%8C%E4%B8%AA%E6%98%AF%E8%AE%A2%E9%98%85%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%0A%20%20-%20%60publish(info)%60%20%E6%8E%A5%E5%8F%A3%E5%8C%85%E5%90%AB%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%EF%BC%8C%E5%B0%B1%E6%98%AF%E8%AE%A2%E9%98%85%E7%9A%84%E4%BF%A1%E6%81%AF%0A-%20%E8%B0%83%E7%94%A8%E7%B1%BB%20(invoke)%EF%BC%8C%E6%94%AF%E6%8C%81%20callback%2C%20promise%20%E5%92%8C%20generator%20function%20%E4%B8%89%E7%A7%8D%E9%A3%8E%E6%A0%BC%E7%9A%84%E6%8E%A5%E5%8F%A3%EF%BC%8C%E4%BD%86%E6%98%AF%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8%20generator%20function%E3%80%82%0A%0A%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%A4%BA%E4%BE%8B%0A%0A%60%60%60js%0Aconst%20Base%20%3D%20require('sdk-base')%3B%0A%0Aclass%20Client%20extends%20Base%20%7B%0A%20%20constructor(options)%20%7B%0A%20%20%20%20super(options)%3B%0A%20%20%20%20%2F%2F%20%E5%9C%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E6%88%90%E5%8A%9F%E4%BB%A5%E5%90%8E%E8%AE%B0%E5%BE%97%20ready%0A%20%20%20%20this.ready(true)%3B%0A%20%20%7D%0A%0A%20%20%2F**%0A%20%20%20*%20%E8%AE%A2%E9%98%85%0A%20%20%20*%0A%20%20%20*%20%40param%20%7BObject%7D%20info%20-%20%E8%AE%A2%E9%98%85%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%88%E4%B8%80%E4%B8%AA%20JSON%20%E5%AF%B9%E8%B1%A1%EF%BC%8C%E6%B3%A8%E6%84%8F%E5%B0%BD%E9%87%8F%E4%B8%8D%E8%A6%81%E5%8C%85%E5%90%AB%20Function%2C%20Buffer%2C%20Date%20%E8%BF%99%E7%B1%BB%E5%B1%9E%E6%80%A7%EF%BC%89%0A%20%20%20*%20%40param%20%7BFunction%7D%20listener%20-%20%E7%9B%91%E5%90%AC%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%EF%BC%8C%E6%8E%A5%E6%94%B6%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E5%B0%B1%E6%98%AF%E7%9B%91%E5%90%AC%E5%88%B0%E7%9A%84%E7%BB%93%E6%9E%9C%E5%AF%B9%E8%B1%A1%0A%20%20%20*%2F%0A%20%20subscribe(info%2C%20listener)%20%7B%0A%20%20%20%20%2F%2F%20...%0A%20%20%7D%0A%0A%20%20%2F**%0A%20%20%20*%20%E5%8F%91%E5%B8%83%0A%20%20%20*%0A%20%20%20*%20%40param%20%7BObject%7D%20info%20-%20%E5%8F%91%E5%B8%83%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%92%8C%E4%B8%8A%E9%9D%A2%20subscribe%20%E7%9A%84%20info%20%E7%B1%BB%E4%BC%BC%0A%20%20%20*%2F%0A%20%20publish(info)%20%7B%0A%20%20%20%20%2F%2F%20...%0A%20%20%7D%0A%0A%20%20%2F**%0A%20%20%20*%20%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%20(invoke)%0A%20%20%20*%0A%20%20%20*%20%40param%20%7BString%7D%20id%20-%20id%0A%20%20%20*%20%40return%20%7BObject%7D%20result%0A%20%20%20*%2F%0A%20%20async%20getData(id)%20%7B%0A%20%20%20%20%2F%2F%20...%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%20%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%0A%0A-%20Leader%20%E5%A6%82%E6%9E%9C%E2%80%9C%E6%AD%BB%E6%8E%89%E2%80%9D%E4%BC%9A%E8%A7%A6%E5%8F%91%E6%96%B0%E4%B8%80%E8%BD%AE%E7%9A%84%E7%AB%AF%E5%8F%A3%E4%BA%89%E5%A4%BA%EF%BC%8C%E4%BA%89%E5%A4%BA%E5%88%B0%E7%AB%AF%E5%8F%A3%E7%9A%84%E9%82%A3%E4%B8%AA%E5%AE%9E%E4%BE%8B%E8%A2%AB%E6%8E%A8%E9%80%89%E4%B8%BA%E6%96%B0%E7%9A%84%20Leader%0A-%20%E4%B8%BA%E4%BF%9D%E8%AF%81%20Leader%20%E5%92%8C%20Follower%20%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E9%81%93%E5%81%A5%E5%BA%B7%EF%BC%8C%E9%9C%80%E8%A6%81%E5%BC%95%E5%85%A5%E5%AE%9A%E6%97%B6%E5%BF%83%E8%B7%B3%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%20Follower%20%E5%9C%A8%E5%9B%BA%E5%AE%9A%E6%97%B6%E9%97%B4%E5%86%85%E6%B2%A1%E6%9C%89%E5%8F%91%E9%80%81%E5%BF%83%E8%B7%B3%E5%8C%85%EF%BC%8C%E9%82%A3%E4%B9%88%20Leader%20%E4%BC%9A%E5%B0%86%20Follower%20%E4%B8%BB%E5%8A%A8%E6%96%AD%E5%BC%80%EF%BC%8C%E4%BB%8E%E8%80%8C%E8%A7%A6%E5%8F%91%20Follower%20%E7%9A%84%E9%87%8D%E6%96%B0%E5%88%9D%E5%A7%8B%E5%8C%96%0A%0A%23%23%20%E5%8D%8F%E8%AE%AE%E5%92%8C%E8%B0%83%E7%94%A8%E6%97%B6%E5%BA%8F%0A%0ALeader%20%E5%92%8C%20Follower%20%E9%80%9A%E8%BF%87%E4%B8%8B%E9%9D%A2%E7%9A%84%E5%8D%8F%E8%AE%AE%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E4%BA%A4%E6%8D%A2%EF%BC%9A%0A%0A%60%60%60js%0A%200%20%20%20%20%20%20%201%20%20%20%20%20%20%202%20%20%20%20%20%20%20%20%20%20%20%20%20%20%204%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2012%0A%20%2B-------%2B-------%2B---------------%2B---------------------------------------------------------------%2B%0A%20%7Cversion%7Creq%2Fres%7C%20%20%20%20reserved%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20request%20id%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%2B-------------------------------%2B-------------------------------%2B-------------------------------%2B%0A%20%7C%20%20%20%20%20%20%20%20%20%20%20timeout%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20connection%20object%20length%20%20%20%20%7C%20%20%20application%20object%20length%20%20%20%7C%0A%20%2B-------------------------------%2B---------------------------------------------------------------%2B%0A%20%7C%20%20%20%20%20%20%20%20%20conn%20object%20(JSON%20format)%20%20...%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20app%20object%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%2B-----------------------------------------------------------%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20...%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%2B-----------------------------------------------------------------------------------------------%2B%0A%60%60%60%0A%0A1.%20%E5%9C%A8%E9%80%9A%E8%AE%AF%E7%AB%AF%E5%8F%A3%E4%B8%8A%20Leader%20%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%20Local%20Server%EF%BC%8C%E6%89%80%E6%9C%89%E7%9A%84%20Leader%2FFollower%20%E9%80%9A%E8%AE%AF%E9%83%BD%E7%BB%8F%E8%BF%87%20Local%20Server%0A1.%20Follower%20%E8%BF%9E%E6%8E%A5%E4%B8%8A%20Local%20Server%20%E5%90%8E%EF%BC%8C%E9%A6%96%E5%85%88%E5%8F%91%E9%80%81%E4%B8%80%E4%B8%AA%20register%20channel%20%E7%9A%84%20packet%EF%BC%88%E5%BC%95%E5%85%A5%20channel%20%E7%9A%84%E6%A6%82%E5%BF%B5%E6%98%AF%E4%B8%BA%E4%BA%86%E5%8C%BA%E5%88%AB%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%89%0A2.%20Local%20Server%20%E4%BC%9A%E5%B0%86%20Follower%20%E5%88%86%E9%85%8D%E7%BB%99%E6%8C%87%E5%AE%9A%E7%9A%84%20Leader%EF%BC%88%E6%A0%B9%E6%8D%AE%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%B1%BB%E5%9E%8B%E8%BF%9B%E8%A1%8C%E9%85%8D%E5%AF%B9%EF%BC%89%0A3.%20Follower%20%E5%90%91%20Leader%20%E5%8F%91%E9%80%81%E8%AE%A2%E9%98%85%E3%80%81%E5%8F%91%E5%B8%83%E8%AF%B7%E6%B1%82%EF%BC%8C%0A4.%20Leader%20%E5%9C%A8%E8%AE%A2%E9%98%85%E6%95%B0%E6%8D%AE%E5%8F%98%E6%9B%B4%E6%97%B6%E9%80%9A%E8%BF%87%20subscribe%20result%20packet%20%E9%80%9A%E7%9F%A5%20Follower%0A5.%20Follower%20%E5%90%91%20Leader%20%E5%8F%91%E9%80%81%E8%B0%83%E7%94%A8%E8%AF%B7%E6%B1%82%EF%BC%8CLeader%20%E6%94%B6%E5%88%B0%E5%90%8E%E6%89%A7%E8%A1%8C%E7%9B%B8%E5%BA%94%E6%93%8D%E4%BD%9C%E5%90%8E%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%0A%0A%60%60%60js%0A%20%2B----------%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%2B---------------%2B%20%20%20%20%20%20%20%20%20%20%2B---------%2B%0A%20%7C%20Follower%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20Local%20Server%20%7C%20%20%20%20%20%20%20%20%20%20%7C%20%20Leader%20%7C%0A%20%2B----------%2B%20%20%20%20%20%20%20%20%20%20%20%20%20%2B---------------%2B%20%20%20%20%20%20%20%20%20%20%2B---------%2B%0A%20%20%20%20%20%20%7C%20%20%20%20%20register%20channel%20%20%20%20%20%7C%20%20%20%20%20%20%20assign%20to%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%2B%20-----------------------%3E%20%7C%20%20--------------------%3E%20%7C%0A%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20subscribe%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%2B%20------------------------------------------------%3E%20%7C%0A%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20publish%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%2B%20------------------------------------------------%3E%20%7C%0A%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%7C%20%20%20%20%20%20%20subscribe%20result%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%7C%20%3C------------------------------------------------%20%2B%0A%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20invoke%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%2B%20------------------------------------------------%3E%20%7C%0A%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20invoke%20result%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%7C%20%3C------------------------------------------------%20%2B%0A%20%20%20%20%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%60%60%60%0A%0A%23%23%20%E5%85%B7%E4%BD%93%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%0A%0A%E4%B8%8B%E9%9D%A2%E6%88%91%E7%94%A8%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90%EF%BC%8C%E4%BB%8B%E7%BB%8D%E5%9C%A8%E6%A1%86%E6%9E%B6%E9%87%8C%E9%9D%A2%E5%A6%82%E4%BD%95%E8%AE%A9%E4%B8%80%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%94%AF%E6%8C%81%20Leader%2FFollower%20%E6%A8%A1%E5%BC%8F%0A%0A-%20%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%80%E5%A5%BD%E6%98%AF%E7%AC%A6%E5%90%88%E4%B8%8A%E9%9D%A2%E6%8F%90%E5%88%B0%E8%BF%87%E7%9A%84%E6%8E%A5%E5%8F%A3%E7%BA%A6%E5%AE%9A%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20registry_client.js%0Aconst%20URL%20%3D%20require('url')%3B%0Aconst%20Base%20%3D%20require('sdk-base')%3B%0A%0Aclass%20RegistryClient%20extends%20Base%20%7B%0A%20%20constructor(options)%20%7B%0A%20%20%20%20super(%7B%0A%20%20%20%20%20%20%2F%2F%20%E6%8C%87%E5%AE%9A%E5%BC%82%E6%AD%A5%E5%90%AF%E5%8A%A8%E7%9A%84%E6%96%B9%E6%B3%95%0A%20%20%20%20%20%20initMethod%3A%20'init'%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20this._options%20%3D%20options%3B%0A%20%20%20%20this._registered%20%3D%20new%20Map()%3B%0A%20%20%7D%0A%0A%20%20%2F**%0A%20%20%20*%20%E5%90%AF%E5%8A%A8%E9%80%BB%E8%BE%91%0A%20%20%20*%2F%0A%20%20async%20init()%20%7B%0A%20%20%20%20this.ready(true)%3B%0A%20%20%7D%0A%0A%20%20%2F**%0A%20%20%20*%20%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%0A%20%20%20*%20%40param%20%7BString%7D%20dataId%20-%20the%20dataId%0A%20%20%20*%20%40return%20%7BObject%7D%20%E9%85%8D%E7%BD%AE%0A%20%20%20*%2F%0A%20%20async%20getConfig(dataId)%20%7B%0A%20%20%20%20return%20this._registered.get(dataId)%3B%0A%20%20%7D%0A%0A%20%20%2F**%0A%20%20%20*%20%E8%AE%A2%E9%98%85%0A%20%20%20*%20%40param%20%7BObject%7D%20reg%0A%20%20%20*%20%20%20-%20%7BString%7D%20dataId%20-%20the%20dataId%0A%20%20%20*%20%40param%20%7BFunction%7D%20%20listener%20-%20the%20listener%0A%20%20%20*%2F%0A%20%20subscribe(reg%2C%20listener)%20%7B%0A%20%20%20%20const%20key%20%3D%20reg.dataId%3B%0A%20%20%20%20this.on(key%2C%20listener)%3B%0A%0A%20%20%20%20const%20data%20%3D%20this._registered.get(key)%3B%0A%20%20%20%20if%20(data)%20%7B%0A%20%20%20%20%20%20process.nextTick(()%20%3D%3E%20listener(data))%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20%2F**%0A%20%20%20*%20%E5%8F%91%E5%B8%83%0A%20%20%20*%20%40param%20%7BObject%7D%20reg%0A%20%20%20*%20%20%20-%20%7BString%7D%20dataId%20-%20the%20dataId%0A%20%20%20*%20%20%20-%20%7BString%7D%20publishData%20-%20the%20publish%20data%0A%20%20%20*%2F%0A%20%20publish(reg)%20%7B%0A%20%20%20%20const%20key%20%3D%20reg.dataId%3B%0A%20%20%20%20let%20changed%20%3D%20false%3B%0A%0A%20%20%20%20if%20(this._registered.has(key))%20%7B%0A%20%20%20%20%20%20const%20arr%20%3D%20this._registered.get(key)%3B%0A%20%20%20%20%20%20if%20(arr.indexOf(reg.publishData)%20%3D%3D%3D%20-1)%20%7B%0A%20%20%20%20%20%20%20%20changed%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20arr.push(reg.publishData)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20changed%20%3D%20true%3B%0A%20%20%20%20%20%20this._registered.set(key%2C%20%5Breg.publishData%5D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20if%20(changed)%20%7B%0A%20%20%20%20%20%20this.emit(key%2C%20this._registered.get(key).map(url%20%3D%3E%20URL.parse(url%2C%20true)))%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A%0Amodule.exports%20%3D%20RegistryClient%3B%0A%60%60%60%0A%0A-%20%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%8C%E4%BD%BF%E7%94%A8%20%60agent.cluster%60%20%E6%8E%A5%E5%8F%A3%E5%AF%B9%20RegistryClient%20%E8%BF%9B%E8%A1%8C%E5%B0%81%E8%A3%85%0A%0A%60%60%60js%0A%2F%2F%20agent.js%0Aconst%20RegistryClient%20%3D%20require('registry_client')%3B%0A%0Amodule.exports%20%3D%20agent%20%3D%3E%20%7B%0A%20%20%2F%2F%20%E5%AF%B9%20RegistryClient%20%E8%BF%9B%E8%A1%8C%E5%B0%81%E8%A3%85%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%8C%96%0A%20%20agent.registryClient%20%3D%20agent.cluster(RegistryClient)%0A%20%20%20%20%2F%2F%20create%20%E6%96%B9%E6%B3%95%E7%9A%84%E5%8F%82%E6%95%B0%E5%B0%B1%E6%98%AF%20RegistryClient%20%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E5%8F%82%E6%95%B0%0A%20%20%20%20.create(%7B%7D)%3B%0A%0A%20%20agent.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20await%20agent.registryClient.ready()%3B%0A%20%20%20%20agent.coreLogger.info('registry%20client%20is%20ready')%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A-%20%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%8C%E4%BD%BF%E7%94%A8%20%60app.cluster%60%20%E6%8E%A5%E5%8F%A3%E5%AF%B9%20RegistryClient%20%E8%BF%9B%E8%A1%8C%E5%B0%81%E8%A3%85%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Aconst%20RegistryClient%20%3D%20require('registry_client')%3B%0A%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.registryClient%20%3D%20app.cluster(RegistryClient).create(%7B%7D)%3B%0A%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20await%20app.registryClient.ready()%3B%0A%20%20%20%20app.coreLogger.info('registry%20client%20is%20ready')%3B%0A%0A%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8%20subscribe%20%E8%BF%9B%E8%A1%8C%E8%AE%A2%E9%98%85%0A%20%20%20%20app.registryClient.subscribe(%7B%0A%20%20%20%20%20%20dataId%3A%20'demo.DemoService'%2C%0A%20%20%20%20%7D%2C%20val%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D)%3B%0A%0A%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8%20publish%20%E5%8F%91%E5%B8%83%E6%95%B0%E6%8D%AE%0A%20%20%20%20app.registryClient.publish(%7B%0A%20%20%20%20%20%20dataId%3A%20'demo.DemoService'%2C%0A%20%20%20%20%20%20publishData%3A%20'xxx'%2C%0A%20%20%20%20%7D)%3B%0A%0A%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8%20getConfig%20%E6%8E%A5%E5%8F%A3%0A%20%20%20%20const%20res%20%3D%20await%20app.registryClient.getConfig('demo.DemoService')%3B%0A%20%20%20%20console.log(res)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%E6%98%AF%E4%B8%8D%E6%98%AF%E5%BE%88%E7%AE%80%E5%8D%95%EF%BC%9F%0A%0A%E5%BD%93%E7%84%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%BD%A0%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8D%E6%98%AF%E9%82%A3%E4%B9%88%E3%80%8E%E6%A0%87%E5%87%86%E3%80%8F%EF%BC%8C%E9%82%A3%E4%BD%A0%E5%8F%AF%E8%83%BD%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E5%85%B6%E4%BB%96%E4%B8%80%E4%BA%9B%20API%EF%BC%8C%E6%AF%94%E5%A6%82%EF%BC%8C%E4%BD%A0%E7%9A%84%E8%AE%A2%E9%98%85%E5%87%BD%E6%95%B0%E4%B8%8D%E5%8F%AB%20subscribe%EF%BC%8C%E5%8F%AB%20sub%0A%0A%60%60%60js%0Aclass%20MockClient%20extends%20Base%20%7B%0A%20%20constructor(options)%20%7B%0A%20%20%20%20super(%7B%0A%20%20%20%20%20%20initMethod%3A%20'init'%2C%0A%20%20%20%20%7D)%3B%0A%20%20%20%20this._options%20%3D%20options%3B%0A%20%20%20%20this._registered%20%3D%20new%20Map()%3B%0A%20%20%7D%0A%0A%20%20async%20init()%20%7B%0A%20%20%20%20this.ready(true)%3B%0A%20%20%7D%0A%0A%20%20sub(info%2C%20listener)%20%7B%0A%20%20%20%20const%20key%20%3D%20reg.dataId%3B%0A%20%20%20%20this.on(key%2C%20listener)%3B%0A%0A%20%20%20%20const%20data%20%3D%20this._registered.get(key)%3B%0A%20%20%20%20if%20(data)%20%7B%0A%20%20%20%20%20%20process.nextTick(()%20%3D%3E%20listener(data))%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20...%0A%7D%0A%60%60%60%0A%0A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%94%A8%20delegate%20API%20%E6%89%8B%E5%8A%A8%E8%AE%BE%E7%BD%AE%0A%0A%60%60%60js%0A%2F%2F%20agent.js%0Amodule.exports%20%3D%20agent%20%3D%3E%20%7B%0A%20%20agent.mockClient%20%3D%20agent.cluster(MockClient)%0A%20%20%20%20%2F%2F%20%E5%B0%86%20sub%20%E4%BB%A3%E7%90%86%E5%88%B0%20subscribe%20%E9%80%BB%E8%BE%91%E4%B8%8A%0A%20%20%20%20.delegate('sub'%2C%20'subscribe')%0A%20%20%20%20.create()%3B%0A%0A%20%20agent.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20await%20agent.mockClient.ready()%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%60%60%60js%0A%2F%2F%20app.js%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20app.mockClient%20%3D%20app.cluster(MockClient)%0A%20%20%20%20%2F%2F%20%E5%B0%86%20sub%20%E4%BB%A3%E7%90%86%E5%88%B0%20subscribe%20%E9%80%BB%E8%BE%91%E4%B8%8A%0A%20%20%20%20.delegate('sub'%2C%20'subscribe')%0A%20%20%20%20.create()%3B%0A%0A%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20await%20app.mockClient.ready()%3B%0A%0A%20%20%20%20app.sub(%7B%20id%3A%20'test-id'%20%7D%2C%20val%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20put%20your%20code%20here%0A%20%20%20%20%7D)%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%60%60%60%0A%0A%E6%88%91%E4%BB%AC%E5%B7%B2%E7%BB%8F%E7%90%86%E8%A7%A3%EF%BC%8C%E9%80%9A%E8%BF%87%20cluster-client%20%E5%8F%AF%E4%BB%A5%E8%AE%A9%E6%88%91%E4%BB%AC%E5%9C%A8%E4%B8%8D%E7%90%86%E8%A7%A3%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%BC%80%E5%8F%91%E3%80%8E%E7%BA%AF%E7%B2%B9%E3%80%8F%E7%9A%84%20RegistryClient%EF%BC%8C%E5%8F%AA%E8%B4%9F%E8%B4%A3%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92%EF%BC%8C%E7%84%B6%E5%90%8E%E4%BD%BF%E7%94%A8%20cluster-client%20%E8%BF%9B%E8%A1%8C%E7%AE%80%E5%8D%95%E7%9A%84%20wrap%20%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%BE%97%E5%88%B0%E4%B8%80%E4%B8%AA%E6%94%AF%E6%8C%81%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E7%9A%84%20ClusterClient%E3%80%82%E8%BF%99%E9%87%8C%E7%9A%84%20RegistryClient%20%E5%AE%9E%E9%99%85%E4%B8%8A%E6%98%AF%E4%B8%80%E4%B8%AA%E4%B8%93%E9%97%A8%E8%B4%9F%E8%B4%A3%E5%92%8C%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1%E7%9A%84%20DataClient%E3%80%82%0A%0A%E5%A4%A7%E5%AE%B6%E5%8F%AF%E8%83%BD%E5%B7%B2%E7%BB%8F%E5%8F%91%E7%8E%B0%EF%BC%8CClusterClient%20%E5%90%8C%E6%97%B6%E5%B8%A6%E6%9D%A5%E4%BA%86%E4%B8%80%E4%BA%9B%E7%BA%A6%E6%9D%9F%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%83%B3%E5%9C%A8%E5%90%84%E8%BF%9B%E7%A8%8B%E6%9A%B4%E9%9C%B2%E5%90%8C%E6%A0%B7%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%8C%E9%82%A3%E4%B9%88%20RegistryClient%20%E4%B8%8A%E5%8F%AA%E8%83%BD%E6%94%AF%E6%8C%81%20sub%2Fpub%20%E6%A8%A1%E5%BC%8F%E4%BB%A5%E5%8F%8A%E5%BC%82%E6%AD%A5%E7%9A%84%20API%20%E8%B0%83%E7%94%A8%E3%80%82%E5%9B%A0%E4%B8%BA%E5%9C%A8%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%B8%AD%E6%89%80%E6%9C%89%E7%9A%84%E4%BA%A4%E4%BA%92%E9%83%BD%E5%BF%85%E9%A1%BB%E7%BB%8F%E8%BF%87%20socket%20%E9%80%9A%E4%BF%A1%EF%BC%8C%E5%8A%BF%E5%BF%85%E5%B8%A6%E6%9D%A5%E4%BA%86%E8%BF%99%E4%B8%80%E7%BA%A6%E6%9D%9F%E3%80%82%0A%0A%E5%81%87%E8%AE%BE%E6%88%91%E4%BB%AC%E8%A6%81%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%90%8C%E6%AD%A5%E7%9A%84%20get%20%E6%96%B9%E6%B3%95%EF%BC%8Csubscribe%20%E8%BF%87%E7%9A%84%E6%95%B0%E6%8D%AE%E7%9B%B4%E6%8E%A5%E6%94%BE%E5%85%A5%E5%86%85%E5%AD%98%EF%BC%8C%E4%BD%BF%E7%94%A8%20get%20%E6%96%B9%E6%B3%95%E6%97%B6%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E3%80%82%E8%A6%81%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E5%91%A2%EF%BC%9F%E8%80%8C%E7%9C%9F%E5%AE%9E%E6%83%85%E5%86%B5%E5%8F%AF%E8%83%BD%E6%AF%94%E8%BF%99%E6%9B%B4%E5%A4%8D%E6%9D%82%E3%80%82%0A%0A%E5%9C%A8%E8%BF%99%E9%87%8C%EF%BC%8C%E6%88%91%E4%BB%AC%E5%BC%95%E5%85%A5%E4%B8%80%E4%B8%AA%20APIClient%20%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E3%80%82%E5%AF%B9%E4%BA%8E%E6%9C%89%E8%AF%BB%E5%8F%96%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E7%AD%89%E5%90%8C%E6%AD%A5%20API%20%E9%9C%80%E6%B1%82%E7%9A%84%E6%A8%A1%E5%9D%97%EF%BC%8C%E5%9C%A8%20RegistryClient%20%E5%9F%BA%E7%A1%80%E4%B8%8A%E5%86%8D%E5%B0%81%E8%A3%85%E4%B8%80%E4%B8%AA%20APIClient%20%E6%9D%A5%E5%AE%9E%E7%8E%B0%E8%BF%99%E4%BA%9B%E4%B8%8E%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BA%A4%E4%BA%92%E6%97%A0%E5%85%B3%E7%9A%84%20API%EF%BC%8C%E6%9A%B4%E9%9C%B2%E7%BB%99%E7%94%A8%E6%88%B7%E4%BD%BF%E7%94%A8%E5%88%B0%E7%9A%84%E6%98%AF%E8%BF%99%E4%B8%AA%20APIClient%20%E7%9A%84%E5%AE%9E%E4%BE%8B%E3%80%82%0A%0A%E5%9C%A8%20APIClient%20%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E4%B8%8A%EF%BC%9A%0A%0A-%20%E5%BC%82%E6%AD%A5%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96%EF%BC%8C%E9%80%9A%E8%BF%87%E8%B0%83%E7%94%A8%E5%9F%BA%E4%BA%8E%20ClusterClient%20%E7%9A%84%20RegistryClient%20%E7%9A%84%20API%20%E5%AE%9E%E7%8E%B0%E3%80%82%0A-%20%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8%E7%AD%89%E4%B8%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%97%A0%E5%85%B3%E7%9A%84%E6%8E%A5%E5%8F%A3%E5%9C%A8%20APIClient%20%E4%B8%8A%E5%AE%9E%E7%8E%B0%E3%80%82%E7%94%B1%E4%BA%8E%20ClusterClient%20%E7%9A%84%20API%20%E5%B7%B2%E7%BB%8F%E6%8A%B9%E5%B9%B3%E4%BA%86%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%B7%AE%E5%BC%82%EF%BC%8C%E6%89%80%E4%BB%A5%E5%9C%A8%E5%BC%80%E5%8F%91%20APIClient%20%E8%B0%83%E7%94%A8%E5%88%B0%20RegistryClient%20%E6%97%B6%E4%B9%9F%E6%97%A0%E9%9C%80%E5%85%B3%E5%BF%83%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E3%80%82%0A%0A%E4%BE%8B%E5%A6%82%E5%9C%A8%E6%A8%A1%E5%9D%97%E7%9A%84%20APIClient%20%E4%B8%AD%E5%A2%9E%E5%8A%A0%E5%B8%A6%E7%BC%93%E5%AD%98%E7%9A%84%20get%20%E5%90%8C%E6%AD%A5%E6%96%B9%E6%B3%95%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20some-client%2Findex.js%0Aconst%20cluster%20%3D%20require('cluster-client')%3B%0Aconst%20RegistryClient%20%3D%20require('.%2Fregistry_client')%3B%0A%0Aclass%20APIClient%20extends%20Base%20%7B%0A%20%20constructor(options)%20%7B%0A%20%20%20%20super(options)%3B%0A%0A%20%20%20%20%2F%2F%20options.cluster%20%E7%94%A8%E4%BA%8E%E7%BB%99%20Egg%20%E7%9A%84%E6%8F%92%E4%BB%B6%E4%BC%A0%E9%80%92%20app.cluster%20%E8%BF%9B%E6%9D%A5%0A%20%20%20%20this._client%20%3D%20(options.cluster%20%7C%7C%20cluster)(RegistryClient).create(options)%3B%0A%20%20%20%20this._client.ready(()%20%3D%3E%20this.ready(true))%3B%0A%0A%20%20%20%20this._cache%20%3D%20%7B%7D%3B%0A%0A%20%20%20%20%2F%2F%20subMap%3A%0A%20%20%20%20%2F%2F%20%7B%0A%20%20%20%20%2F%2F%20%20%20foo%3A%20reg1%2C%0A%20%20%20%20%2F%2F%20%20%20bar%3A%20reg2%2C%0A%20%20%20%20%2F%2F%20%7D%0A%20%20%20%20const%20subMap%20%3D%20options.subMap%3B%0A%0A%20%20%20%20for%20(const%20key%20in%20subMap)%20%7B%0A%20%20%20%20%20%20this.subscribe(subMap%5Bkey%5D%2C%20value%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20this._cache%5Bkey%5D%20%3D%20value%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20subscribe(reg%2C%20listener)%20%7B%0A%20%20%20%20this._client.subscribe(reg%2C%20listener)%3B%0A%20%20%7D%0A%0A%20%20publish(reg)%20%7B%0A%20%20%20%20this._client.publish(reg)%3B%0A%20%20%7D%0A%0A%20%20get(key)%20%7B%0A%20%20%20%20return%20this._cache%5Bkey%5D%3B%0A%20%20%7D%0A%7D%0A%0A%2F%2F%20%E6%9C%80%E7%BB%88%E6%A8%A1%E5%9D%97%E5%90%91%E5%A4%96%E6%9A%B4%E9%9C%B2%E8%BF%99%E4%B8%AA%20APIClient%0Amodule.exports%20%3D%20APIClient%3B%0A%60%60%60%0A%0A%E9%82%A3%E4%B9%88%E6%88%91%E4%BB%AC%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%BF%99%E4%B9%88%E4%BD%BF%E7%94%A8%E8%AF%A5%E6%A8%A1%E5%9D%97%EF%BC%9A%0A%0A%60%60%60js%0A%2F%2F%20app.js%20%7C%7C%20agent.js%0Aconst%20APIClient%20%3D%20require('some-client')%3B%20%2F%2F%20%E4%B8%8A%E9%9D%A2%E9%82%A3%E4%B8%AA%E6%A8%A1%E5%9D%97%0Amodule.exports%20%3D%20app%20%3D%3E%20%7B%0A%20%20const%20config%20%3D%20app.config.apiClient%3B%0A%20%20app.apiClient%20%3D%20new%20APIClient(Object.assign(%7B%7D%2C%20config%2C%20%7B%20cluster%3A%20app.cluster%20%7D)%3B%0A%20%20app.beforeStart(async%20()%20%3D%3E%20%7B%0A%20%20%20%20await%20app.apiClient.ready()%3B%0A%20%20%7D)%3B%0A%7D%3B%0A%0A%2F%2F%20config.%24%7Benv%7D.js%0Aexports.apiClient%20%3D%20%7B%0A%20%20subMap%3A%20%7B%0A%20%20%20%20foo%3A%20%7B%0A%20%20%20%20%20%20id%3A%20''%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20%2F%2F%20bar...%0A%20%20%7D%0A%7D%3B%0A%60%60%60%0A%0A%E4%B8%BA%E4%BA%86%E6%96%B9%E4%BE%BF%E4%BD%A0%E5%B0%81%E8%A3%85%20%60APIClient%60%EF%BC%8C%E5%9C%A8%20%5Bcluster-client%5D(https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fcluster-client)%20%E6%A8%A1%E5%9D%97%E4%B8%AD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E4%B8%AA%20%60APIClientBase%60%20%E5%9F%BA%E7%B1%BB%EF%BC%8C%E9%82%A3%E4%B9%88%E4%B8%8A%E9%9D%A2%E7%9A%84%20%60APIClient%60%20%E5%8F%AF%E4%BB%A5%E6%94%B9%E5%86%99%E4%B8%BA%EF%BC%9A%0A%0A%60%60%60js%0Aconst%20APIClientBase%20%3D%20require('cluster-client').APIClientBase%3B%0Aconst%20RegistryClient%20%3D%20require('.%2Fregistry_client')%3B%0A%0Aclass%20APIClient%20extends%20APIClientBase%20%7B%0A%20%20%2F%2F%20%E8%BF%94%E5%9B%9E%E5%8E%9F%E5%A7%8B%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%B1%BB%0A%20%20get%20DataClient()%20%7B%0A%20%20%20%20return%20RegistryClient%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20%E7%94%A8%E4%BA%8E%E8%AE%BE%E7%BD%AE%20cluster-client%20%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0%EF%BC%8C%E7%AD%89%E5%90%8C%E4%BA%8E%20cluster%20%E6%96%B9%E6%B3%95%E7%9A%84%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%0A%20%20get%20clusterOptions()%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20responseTimeout%3A%20120%20*%201000%2C%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20subscribe(reg%2C%20listener)%20%7B%0A%20%20%20%20this._client.subscribe(reg%2C%20listener)%3B%0A%20%20%7D%0A%0A%20%20publish(reg)%20%7B%0A%20%20%20%20this._client.publish(reg)%3B%0A%20%20%7D%0A%0A%20%20get(key)%20%7B%0A%20%20%20%20return%20this._cache%5Bkey%5D%3B%0A%20%20%7D%0A%7D%0A%60%60%60%0A%0A%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B%EF%BC%9A%0A%0A%60%60%60bash%0A%2B------------------------------------------------%2B%0A%7C%20APIClient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%7C%20%20%20%20%20%20%20%2B----------------------------------------%7C%0A%7C%20%20%20%20%20%20%20%7C%20ClusterClient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%7C%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%2B---------------------------------%7C%0A%7C%20%20%20%20%20%20%20%7C%20%20%20%20%20%20%7C%20RegistryClient%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%0A%2B------------------------------------------------%2B%0A%60%60%60%0A%0A-%20RegistryClient%20-%20%E8%B4%9F%E8%B4%A3%E5%92%8C%E8%BF%9C%E7%AB%AF%E6%9C%8D%E5%8A%A1%E9%80%9A%E8%AE%AF%EF%BC%8C%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AD%98%E5%8F%96%EF%BC%8C%E5%8F%AA%E6%94%AF%E6%8C%81%E5%BC%82%E6%AD%A5%20API%EF%BC%8C%E4%B8%8D%E5%85%B3%E5%BF%83%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E3%80%82%0A-%20ClusterClient%20-%20%E9%80%9A%E8%BF%87%20cluster-client%20%E6%A8%A1%E5%9D%97%E8%BF%9B%E8%A1%8C%E7%AE%80%E5%8D%95%20wrap%20%E5%BE%97%E5%88%B0%E7%9A%84%20client%20%E5%AE%9E%E4%BE%8B%EF%BC%8C%E8%B4%9F%E8%B4%A3%E8%87%AA%E5%8A%A8%E6%8A%B9%E5%B9%B3%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%B7%AE%E5%BC%82%E3%80%82%0A-%20APIClient%20-%20%E5%86%85%E9%83%A8%E8%B0%83%E7%94%A8%20ClusterClient%20%E5%81%9A%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%EF%BC%8C%E6%97%A0%E9%9C%80%E5%85%B3%E5%BF%83%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%EF%BC%8C%E7%94%A8%E6%88%B7%E6%9C%80%E7%BB%88%E4%BD%BF%E7%94%A8%E7%9A%84%E6%A8%A1%E5%9D%97%E3%80%82API%20%E9%83%BD%E9%80%9A%E8%BF%87%E6%AD%A4%E5%A4%84%E6%9A%B4%E9%9C%B2%EF%BC%8C%E6%94%AF%E6%8C%81%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5%E3%80%82%0A%0A%E6%9C%89%E5%85%B4%E8%B6%A3%E7%9A%84%E5%90%8C%E5%AD%A6%E5%8F%AF%E4%BB%A5%E7%9C%8B%E4%B8%80%E4%B8%8B%5B%E5%A2%9E%E5%BC%BA%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%A0%94%E5%8F%91%E6%A8%A1%E5%BC%8F%5D(https%3A%2F%2Fgithub.com%2Feggjs%2Fegg%2Fissues%2F322)%20%E8%AE%A8%E8%AE%BA%E8%BF%87%E7%A8%8B%E3%80%82%0A%0A%23%23%20%E5%9C%A8%E6%A1%86%E6%9E%B6%E9%87%8C%E9%9D%A2%20cluster-client%20%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%0A%0A%60%60%60js%0A%2F**%0A%20*%20%40property%20%7BNumber%7D%20responseTimeout%20-%20response%20timeout%2C%20default%20is%2060000%0A%20*%20%40property%20%7BTranscode%7D%20%5Btranscode%5D%0A%20*%20%20%20-%20%7BFunction%7D%20encode%20-%20custom%20serialize%20method%0A%20*%20%20%20-%20%7BFunction%7D%20decode%20-%20custom%20deserialize%20method%0A%20*%2F%0Aconfig.clusterClient%20%3D%20%7B%0A%20%20responseTimeout%3A%2060000%2C%0A%7D%3B%0A%60%60%60%0A%0A%E9%85%8D%E7%BD%AE%E9%A1%B9%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%E7%B1%BB%E5%9E%8B%20%20%20%20%20%20%7C%20%E9%BB%98%E8%AE%A4%E5%80%BC%20%20%20%20%20%20%20%20%20%20%7C%20%E6%8F%8F%E8%BF%B0%0A-----------------------%7C----------%7C-----------------%7C--------------------------------------------------------------------------%0AresponseTimeout%20%20%20%20%20%20%20%20%7C%20number%20%20%20%7C%2060000%20%EF%BC%88%E4%B8%80%E5%88%86%E9%92%9F%EF%BC%89%20%7C%20%E5%85%A8%E5%B1%80%E7%9A%84%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AF%E7%9A%84%E8%B6%85%E6%97%B6%E6%97%B6%E9%95%BF%EF%BC%8C%E4%B8%8D%E8%83%BD%E8%AE%BE%E7%BD%AE%E7%9A%84%E5%A4%AA%E7%9F%AD%EF%BC%8C%E5%9B%A0%E4%B8%BA%E4%BB%A3%E7%90%86%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%9C%AC%E8%BA%AB%E4%B9%9F%E6%9C%89%E8%B6%85%E6%97%B6%E8%AE%BE%E7%BD%AE%0Atranscode%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20function%20%7C%20N%2FA%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AF%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E6%96%B9%E5%BC%8F%EF%BC%8C%E9%BB%98%E8%AE%A4%E9%87%87%E7%94%A8%20%5Bserialize-json%5D(https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fserialize-json)%EF%BC%88%E5%BB%BA%E8%AE%AE%E4%B8%8D%E8%A6%81%E8%87%AA%E8%A1%8C%E8%AE%BE%E7%BD%AE%EF%BC%89%0A%0A%E4%B8%8A%E9%9D%A2%E6%98%AF%E5%85%A8%E5%B1%80%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%E3%80%82%E5%A6%82%E6%9E%9C%EF%BC%8C%E4%BD%A0%E6%83%B3%E5%AF%B9%E4%B8%80%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8D%95%E7%8B%AC%E5%81%9A%E8%AE%BE%E7%BD%AE%0A%0A-%20%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%20%60app%2Fagent.cluster(ClientClass%2C%20options)%60%20%E7%9A%84%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%20%60options%60%20%E8%BF%9B%E8%A1%8C%E8%A6%86%E7%9B%96%0A%0A%60%60%60js%0Aapp.registryClient%20%3D%20app.cluster(RegistryClient%2C%20%7B%0A%20%20responseTimeout%3A%20120%20*%201000%2C%20%2F%2F%20%E8%BF%99%E9%87%8C%E4%BC%A0%E5%85%A5%E7%9A%84%E6%98%AF%E5%92%8C%20cluster-client%20%E7%9B%B8%E5%85%B3%E7%9A%84%E5%8F%82%E6%95%B0%0A%7D).create(%7B%0A%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E4%BC%A0%E5%85%A5%E7%9A%84%E6%98%AF%20RegistryClient%20%E9%9C%80%E8%A6%81%E7%9A%84%E5%8F%82%E6%95%B0%0A%7D)%3B%0A%60%60%60%0A%0A-%20%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E8%A6%86%E7%9B%96%20%60APIClientBase%60%20%E7%9A%84%20%60clusterOptions%60%20%E8%BF%99%E4%B8%AA%20%60getter%60%20%E5%B1%9E%E6%80%A7%0A%0A%60%60%60js%0Aconst%20APIClientBase%20%3D%20require('cluster-client').APIClientBase%3B%0Aconst%20RegistryClient%20%3D%20require('.%2Fregistry_client')%3B%0A%0Aclass%20APIClient%20extends%20APIClientBase%20%7B%0A%20%20get%20DataClient()%20%7B%0A%20%20%20%20return%20RegistryClient%3B%0A%20%20%7D%0A%0A%20%20get%20clusterOptions()%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20responseTimeout%3A%20120%20*%201000%2C%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20...%0A%7D%0A%0Amodule.exports%20%3D%20APIClient%3B%0A%60%60%60%0A"}}</script><script type="text/javascript" src="/static/js/post.b9faab88.js"></script></body></html>